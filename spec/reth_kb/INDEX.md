# Reth Knowledge Base

Purpose: consolidate verified, navigable answers about the `reth/` architecture and implementation.

## How to Use
- Each question has a dedicated page in `spec/reth_kb/questions/` with the Gemini prompt, answer, and verification notes.
- This index tracks status and provides short, actionable pointers.

## Status Legend
- `pending`: prompt drafted, Gemini not run yet
- `needs_verification`: Gemini answered, verification pending
- `verified`: key claims checked against `reth/`

## Question Index

| ID | Question | Context Packs | Status | TL;DR | Key Files |
| --- | --- | --- | --- | --- | --- |
| Q001 | [Major crates/modules and how they fit together](spec/reth_kb/questions/Q001-repo-architecture-map.md) | `reth/stateless-history-context.xml` | `verified` | P2P core via `NetworkManager`/`Swarm`; ECIES→P2PStream→EthStream layering; primitives + era crates provide shared types and history formats | `crates/net/network/src/manager.rs`, `crates/net/network/src/swarm.rs`, `crates/net/network/src/session/conn.rs`, `crates/primitives-traits/src/node.rs`, `crates/era/src/lib.rs` |
| Q002 | [Networking entry points (NetworkManager/Handle, PeerRequest)](spec/reth_kb/questions/Q002-network-entrypoints.md) | `context-network.xml` | `verified` | Config via `NetworkConfigBuilder`, runtime via `NetworkManager`/`Swarm`, and request plumbing through `FetchClient` | `crates/net/network/src/config.rs`, `crates/net/network/src/manager.rs`, `crates/net/network/src/swarm.rs`, `crates/net/network/src/fetch/client.rs` |
| Q003 | [Sync pipeline entry points (stages, pipeline, downloaders)](spec/reth_kb/questions/Q003-sync-entrypoints.md) | `context-sync.xml` | `verified` | Pipeline runs stages serially with checkpoints; downloaders have builders and task wrappers; default stage order is defined in stage sets | `crates/stages/api/src/pipeline/mod.rs`, `crates/stages/api/src/stage.rs`, `crates/stages/stages/src/sets.rs`, `crates/net/downloaders/src/headers/reverse_headers.rs`, `crates/net/downloaders/src/bodies/bodies.rs` |
| Q004 | [Storage entry points (db open/provider/static files)](spec/reth_kb/questions/Q004-storage-entrypoints.md) | `context-storage.xml` | `verified` | MDBX init/versioning + ProviderFactory are core entry points; static files use NippyJar with separate index/offset/config files | `crates/storage/db/src/mdbx.rs`, `crates/storage/db/src/version.rs`, `crates/storage/provider/src/providers/database/mod.rs`, `crates/storage/provider/src/providers/static_file/manager.rs`, `crates/storage/nippy-jar/src/lib.rs` |
| Q005 | [RPC entry points (module builder, server wiring)](spec/reth_kb/questions/Q005-rpc-entrypoints.md) | `context-rpc.xml` | `verified` | RpcModuleBuilder builds TransportRpcModules; RpcServerConfig wires middleware and starts HTTP/WS/IPC | `crates/rpc/rpc-builder/src/lib.rs`, `crates/rpc/rpc-builder/src/auth.rs`, `crates/node/core/src/args/rpc_server.rs`, `crates/rpc/rpc/src/eth/core.rs` |
| Q006 | [MDBX connection lifecycle (env, txns, versioning)](spec/reth_kb/questions/Q006-mdbx-lifecycle.md) | `context-storage.xml` | `verified` | create_db checks version then opens env; init_db creates tables + records client version; DatabaseEnv::open sets MDBX flags + slow reader warnings | `crates/storage/db/src/mdbx.rs`, `crates/storage/db/src/version.rs`, `crates/storage/db/src/implementation/mdbx/mod.rs`, `crates/storage/db-api/src/database.rs`, `crates/storage/db/src/implementation/mdbx/tx.rs` |
| Q007 | [DB abstraction layer (db-api traits + provider layer)](spec/reth_kb/questions/Q007-db-abstraction-layer.md) | `context-storage.xml` | `verified` | db-api defines Database/DbTx/Table; DatabaseEnv+Tx implement MDBX; ProviderFactory wraps db.tx into DatabaseProvider | `crates/storage/db-api/src/database.rs`, `crates/storage/db-api/src/transaction.rs`, `crates/storage/db/src/implementation/mdbx/mod.rs`, `crates/storage/db/src/implementation/mdbx/tx.rs`, `crates/storage/provider/src/providers/database/mod.rs`, `crates/storage/provider/src/providers/database/provider.rs` |
| Q008 | [Table definitions + codecs mapping to stored data](spec/reth_kb/questions/Q008-table-definitions-codecs.md) | `context-storage.xml` | `verified` | tables! defines typed tables; keys encode via Encode; values compress via Compact; MDBX tx encodes/decodes | `crates/storage/db-api/src/tables/mod.rs`, `crates/storage/db-api/src/table.rs`, `crates/storage/db-api/src/models/mod.rs`, `crates/storage/db/src/implementation/mdbx/tx.rs`, `crates/storage/db/src/implementation/mdbx/cursor.rs`, `crates/storage/codecs/README.md` |
| Q009 | [Static files + NippyJar architecture and data split](spec/reth_kb/questions/Q009-static-files-nippyjar.md) | `context-storage.xml` | `verified` | NippyJar uses mmap + offsets/conf sidecars; static file segments split into 500k‑block ranges; save_blocks parallelizes static files with MDBX | `crates/storage/nippy-jar/src/lib.rs`, `crates/storage/nippy-jar/src/writer.rs`, `crates/storage/provider/src/providers/static_file/manager.rs`, `crates/static-file/types/src/segment.rs`, `crates/storage/provider/src/providers/database/provider.rs`, `crates/storage/provider/src/either_writer.rs` |
| Q010 | [Storage migrations/versioning](spec/reth_kb/questions/Q010-storage-migrations-versioning.md) | `context-storage.xml` | `verified` | DB_VERSION gate + version file; VersionHistory logs client versions; StorageSettings persisted in Metadata | `crates/storage/db/src/version.rs`, `crates/storage/db/src/mdbx.rs`, `crates/storage/db/src/implementation/mdbx/mod.rs`, `crates/storage/db-api/src/tables/mod.rs`, `crates/storage/storage-api/src/metadata.rs` |
| Q011 | [Pipeline orchestration + checkpoints](spec/reth_kb/questions/Q011-pipeline-orchestration.md) | `context-sync.xml` | `verified` | run_loop executes stages serially; execute_ready + execute persist checkpoints; unwind runs reverse order | `crates/stages/api/src/pipeline/mod.rs`, `crates/stages/api/src/stage.rs`, `crates/stages/types/src/checkpoints.rs`, `crates/stages/api/src/pipeline/ctrl.rs`, `crates/stages/stages/src/sets.rs` |
| Q012 | [ReverseHeadersDownloader algorithm](spec/reth_kb/questions/Q012-reverse-headers-downloader.md) | `context-sync.xml` | `verified` | Reverse downloader streams validated header batches; buffering + retries; detached head triggers unwind | `crates/net/downloaders/src/headers/reverse_headers.rs`, `crates/stages/stages/src/stages/headers.rs`, `crates/net/network-p2p/src/headers/client.rs` |
| Q013 | [Bodies downloader batching + retries](spec/reth_kb/questions/Q013-bodies-downloader.md) | `context-sync.xml` | `verified` | BodiesRequestFuture retries until pending headers done; BinaryHeap buffering yields ordered batches | `crates/net/downloaders/src/bodies/bodies.rs`, `crates/net/downloaders/src/bodies/request.rs`, `crates/net/p2p/src/bodies/response.rs` |
| Q014 | [Missing ranges/holes representation](spec/reth_kb/questions/Q014-missing-ranges-holes.md) | `context-sync.xml` | `verified` | Gaps are implicit via checkpoint/target and HeaderSyncGap; bodies retries fill partials | `crates/net/p2p/src/headers/downloader.rs`, `crates/stages/api/src/stage.rs`, `crates/net/downloaders/src/bodies/request.rs`, `crates/stages/stages/src/stages/bodies.rs` |
| Q015 | [PeersManager + reputation scoring](spec/reth_kb/questions/Q015-peers-manager-reputation.md) | `context-network.xml` | `verified` | PeersManager applies weighted reputation, bans at threshold, and backs off peers | `crates/net/network/src/peers.rs`, `crates/net/network-types/src/peers/reputation.rs`, `crates/net/network-types/src/peers/mod.rs`, `crates/net/network/src/error.rs` |
| Q016 | [Connection limits + dial/backoff controls](spec/reth_kb/questions/Q016-connection-limits-dial-backoff.md) | `context-network.xml` | `verified` | ConnectionInfo gates pending/active slots; dial selection prioritizes trusted/static; backoff uses capped linear scaling | `crates/net/network/src/peers.rs`, `crates/net/network-types/src/peers/config.rs`, `crates/net/network/src/session/mod.rs`, `crates/net/network/src/swarm.rs` |
| Q017 | [Peer persistence (disk format + lifecycle)](spec/reth_kb/questions/Q017-peer-persistence.md) | `context-network.xml` | `verified` | Peers saved on shutdown to known-peers.json as enode strings; loaded via PeersConfig | `crates/net/network/src/manager.rs`, `crates/net/network-types/src/peers/config.rs`, `crates/net/peers/src/node_record.rs`, `crates/node/builder/src/builder/mod.rs` |
| Q018 | [Canonical chain representation + reorg detection](spec/reth_kb/questions/Q018-canonical-chain-reorgs.md) | `context-engine.xml` | `verified` | TreeState + NewCanonicalChain drive reorg detection; canonical head updated with events | `crates/engine/tree/src/tree/state.rs`, `crates/engine/tree/src/tree/mod.rs`, `crates/chain-state/src/in_memory.rs`, `crates/engine/primitives/src/event.rs` |
| Q019 | [Engine tree vs pipeline handoff + backfill](spec/reth_kb/questions/Q019-engine-tree-backfill-handoff.md) | `context-engine.xml` | `verified` | Backfill uses thresholded forkchoice logic; ChainOrchestrator drives pipeline and applies results | `crates/engine/tree/src/tree/mod.rs`, `crates/engine/tree/src/chain.rs`, `crates/engine/tree/src/backfill.rs`, `crates/engine/tree/src/engine.rs` |
| Q020 | [Rollback semantics on reorgs](spec/reth_kb/questions/Q020-rollback-semantics-reorgs.md) | `context-engine.xml` | `verified` | Tree reorgs update in-memory canonical state; disk reorgs detected via find_disk_reorg and truncated via persistence | `crates/engine/tree/src/tree/mod.rs`, `crates/engine/tree/src/tree/state.rs`, `crates/engine/tree/src/persistence.rs`, `crates/storage/provider/src/providers/database/provider.rs` |
| Q021 | [RPC server build + module wiring](spec/reth_kb/questions/Q021-rpc-server-wiring.md) | `context-rpc.xml` | `verified` | RpcModuleBuilder builds transport-specific modules; RpcServerConfig starts servers and auth is separate | `crates/rpc/rpc-builder/src/lib.rs`, `crates/rpc/rpc-builder/src/auth.rs`, `crates/rpc/rpc-builder/src/config.rs`, `crates/rpc/rpc/src/engine.rs` |
| Q022 | [`eth_getLogs` implementation details](spec/reth_kb/questions/Q022-eth-getlogs.md) | `context-rpc.xml` | `verified` | Header bloom filtering + cached/range receipt fetch; limits enforced on range and results | `crates/rpc/rpc/src/eth/filter.rs`, `crates/rpc/rpc-eth-types/src/logs_utils.rs`, `crates/rpc/rpc-eth-types/src/cache/mod.rs` |
| Q023 | [RPC safety knobs (bind/auth/rate limit)](spec/reth_kb/questions/Q023-rpc-safety-knobs.md) | `context-rpc.xml` | `verified` | Defaults bind to localhost; JWT is optional for RPC and required for auth; size and concurrency limits apply | `crates/node/core/src/args/rpc_server.rs`, `crates/rpc/rpc-builder/src/config.rs`, `crates/rpc/rpc-builder/src/lib.rs`, `crates/rpc/rpc-builder/src/auth.rs` |
| Q024 | [Serving devp2p requests (EthRequestHandler)](spec/reth_kb/questions/Q024-eth-request-handler.md) | `context-network.xml` | `verified` | ActiveSession uses oneshot to EthRequestHandler; responses bounded by 2MB and 1024 items | `crates/net/network/src/eth_requests.rs`, `crates/net/network/src/session/active.rs`, `crates/net/network/src/manager.rs`, `crates/net/network/src/builder.rs` |
| Q025 | [Config plumbing into network/sync](spec/reth_kb/questions/Q025-config-plumbing-network-sync.md) | `context-sync.xml`, `context-network.xml` | `verified` | CLI NetworkArgs merges args + Config into NetworkConfigBuilder; StageConfig builds downloaders and stage sets; defaults via Default/serde and builder `unwrap_or_default` | `crates/node/core/src/args/network.rs`, `crates/net/network/src/config.rs`, `crates/node/builder/src/setup.rs`, `crates/net/downloaders/src/headers/reverse_headers.rs`, `crates/stages/stages/src/sets.rs` |
| Q026 | [Metrics/tracing hooks in network + sync](spec/reth_kb/questions/Q026-metrics-tracing-network-sync.md) | `context-sync.xml`, `context-network.xml` | `verified` | Metrics are scoped via `#[metrics(scope = ...)]`; pipeline emits MetricEvent to MetricsListener; network updates metrics inline during swarm/session events | `crates/net/network/src/metrics.rs`, `crates/net/network/src/manager.rs`, `crates/net/network/src/eth_requests.rs`, `crates/net/downloaders/src/metrics.rs`, `crates/stages/api/src/metrics/listener.rs` |
| Q027 | [Manual receipts request flow (PeerRequestSender → wire)](spec/reth_kb/questions/Q027-receipts-request-flow.md) | `context-network.xml` | `verified` | PeerRequest builds EthMessage, map_versioned upgrades eth/70 only, ActiveSession tracks inflight and routes responses by request_id | `crates/net/network-api/src/events.rs`, `crates/net/network/src/session/active.rs`, `crates/net/eth-wire-types/src/message.rs`, `crates/net/network/src/session/mod.rs` |
| Q028 | [EthVersion + capabilities negotiation/access](spec/reth_kb/questions/Q028-eth-version-capabilities.md) | `context-network.xml` | `verified` | SharedCapabilities picks highest version; SessionManager stores version/caps; SessionInfo exposes them via ActivePeerSession; NetworkHandle can query PeerInfo | `crates/net/eth-wire/src/p2pstream.rs`, `crates/net/eth-wire/src/capability.rs`, `crates/net/network/src/session/mod.rs`, `crates/net/network/src/session/handle.rs`, `crates/net/network/src/manager.rs` |
| Q029 | [Why FetchClient lacks receipts + manual path](spec/reth_kb/questions/Q029-fetchclient-receipts-gap.md) | `context-network.xml` | `verified` | FetchClient only issues DownloadRequest headers/bodies; receipts must be sent via PeerRequestSender or NetworkHandle::send_request; ActiveSession maps requests to wire | `crates/net/network/src/fetch/client.rs`, `crates/net/network/src/fetch/mod.rs`, `crates/net/network-api/src/events.rs`, `crates/net/network/src/network.rs`, `crates/net/network/src/session/active.rs` |
| Q030 | [Session request failure handling](spec/reth_kb/questions/Q030-session-request-failures.md) | `context-network.xml` | `verified` | ActiveSession enforces timeouts, maps wrong response variants to BadResponse, and routes send_request via NetworkHandle→Manager→Session | `crates/net/network/src/session/active.rs`, `crates/net/network/src/network.rs`, `crates/net/network/src/manager.rs`, `crates/net/network-api/src/events.rs`, `crates/net/p2p/src/error.rs` |
| Q031 | [Protocol enforcement after handshake (Status + version mismatch)](spec/reth_kb/questions/Q031-protocol-enforcement-status-version.md) | `context-network.xml` | `verified` | Status after handshake is rejected; wrong-version IDs return InvalidMessage and close the session; penalties differ for fatal vs non-fatal errors | `crates/net/eth-wire/src/ethstream.rs`, `crates/net/eth-wire-types/src/message.rs`, `crates/net/network/src/session/active.rs`, `crates/net/network/src/error.rs`, `crates/net/network/src/peers.rs` |
| Q032 | [Receipts69/70 bloom reconstruction + FetchClient request shapes](spec/reth_kb/questions/Q032-receipts69-conversion-fetchclient-requests.md) | `context-network.xml` | `verified` | Receipts69/70 omit bloom and rebuild via into_with_bloom; GetBlockHeaders includes skip but FetchClient’s HeadersRequest does not (skip forced 0); bodies are hash lists | `crates/net/eth-wire-types/src/receipts.rs`, `crates/net/eth-wire-types/src/blocks.rs`, `crates/net/p2p/src/headers/client.rs`, `crates/net/network/src/fetch/client.rs`, `crates/net/network/src/fetch/mod.rs` |
| Q033 | [TransactionsManager gossip filtering by version/policy](spec/reth_kb/questions/Q033-transactionsmanager-capability-filtering.md) | `context-transactions.xml` | `verified` | Per-peer EthVersion shapes announcements; strict filter rejects unknown tx types; blob txs never broadcast in full; ingress policy gates by PeerKind | `crates/net/network/src/transactions/mod.rs`, `crates/net/network/src/transactions/config.rs`, `crates/net/eth-wire-types/src/broadcast.rs`, `crates/primitives-traits/src/transaction/signed.rs`, `crates/net/network-api/src/events.rs` |
| Q034 | [Live download coordination (engine download.rs)](spec/reth_kb/questions/Q034-live-download-coordination.md) | `context-engine.xml`, `context-network.xml` | `verified` | Engine emits DownloadRequest on missing head/parent or post‑backfill gap; downloader manages inflight full/range requests and ordered buffering; peer choice is in FetchClient/StateFetcher | `crates/engine/tree/src/tree/mod.rs`, `crates/engine/tree/src/download.rs`, `crates/engine/tree/src/engine.rs`, `crates/net/p2p/src/full_block.rs`, `crates/net/network/src/fetch/mod.rs` |
| Q035 | [Engine orchestrator control flow](spec/reth_kb/questions/Q035-engine-orchestrator-control-flow.md) | `context-engine.xml` | `verified` | EngineService wires tree thread, handler, and ChainOrchestrator; backfill is prioritized but handler still polled; backfill clears downloads and PipelineSync runs | `crates/engine/service/src/service.rs`, `crates/engine/tree/src/chain.rs`, `crates/engine/tree/src/engine.rs`, `crates/engine/tree/src/tree/mod.rs` |
| Q036 | [Engine API handling (forkchoiceUpdated + newPayload)](spec/reth_kb/questions/Q036-engine-api-forkchoice-newpayload.md) | `context-engine.xml` | `verified` | FCU does pre-validation, canonical check, chain update, then downloads missing head; newPayload checks invalid ancestors, buffers during backfill, executes/insert otherwise, and returns SYNCING for missing parents | `crates/engine/tree/src/tree/mod.rs`, `crates/engine/tree/src/tree/invalid_headers.rs`, `crates/engine/tree/src/tree/block_buffer.rs`, `crates/engine/primitives/src/forkchoice.rs` |
| Q037 | [Backfill sync lifecycle + cleanup](spec/reth_kb/questions/Q037-backfill-sync-lifecycle-cleanup.md) | `context-engine.xml` | `verified` | Backfill start/finish events flow orchestrator→tree; finish prunes or resets tree, clears buffer + in‑memory state, updates persistence head, and may re-run backfill or resume live downloads | `crates/engine/tree/src/backfill.rs`, `crates/engine/tree/src/chain.rs`, `crates/engine/tree/src/tree/mod.rs`, `crates/engine/tree/src/tree/state.rs`, `crates/engine/tree/src/tree/persistence_state.rs` |
| Q038 | [Canonical in-memory state lifecycle](spec/reth_kb/questions/Q038-canonical-in-memory-state-lifecycle.md) | `context-engine.xml` | `verified` | CanonicalInMemoryState tracks unpersisted canonical blocks + pending, updates on canonical chain changes, clears on backfill finish, and prunes persisted blocks after persistence completion | `crates/chain-state/src/in_memory.rs`, `crates/engine/tree/src/tree/mod.rs`, `crates/engine/tree/src/tree/state.rs` |
| Q039 | [CL ingress via Engine API (authrpc)](spec/reth_kb/questions/Q039-cl-engine-api-ingress.md) | `context-engine.xml`, `context-rpc.xml` | `verified` | Engine API authrpc accepts CL calls, forwards them as BeaconEngineMessage via ConsensusEngineHandle, and EngineService consumes those messages to drive the engine | `crates/rpc/rpc-engine-api/src/engine_api.rs`, `crates/engine/primitives/src/message.rs`, `crates/engine/service/src/service.rs`, `crates/node/builder/src/launch/engine.rs`, `crates/rpc/rpc-builder/src/auth.rs` |

## Follow-up Questions Backlog
