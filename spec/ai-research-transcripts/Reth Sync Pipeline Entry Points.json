{
  "runSettings": {
    "temperature": 1.0,
    "model": "models/gemini-3-flash-preview",
    "topP": 0.95,
    "topK": 64,
    "maxOutputTokens": 65536,
    "safetySettings": [{
      "category": "HARM_CATEGORY_HARASSMENT",
      "threshold": "OFF"
    }, {
      "category": "HARM_CATEGORY_HATE_SPEECH",
      "threshold": "OFF"
    }, {
      "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT",
      "threshold": "OFF"
    }, {
      "category": "HARM_CATEGORY_DANGEROUS_CONTENT",
      "threshold": "OFF"
    }],
    "enableCodeExecution": false,
    "enableSearchAsATool": false,
    "enableBrowseAsATool": false,
    "enableAutoFunctionResponse": false,
    "thinkingBudget": -1,
    "outputResolution": "1K",
    "thinkingLevel": "THINKING_HIGH"
  },
  "systemInstruction": {
  },
  "chunkedPrompt": {
    "chunks": [{
      "role": "user",
      "tokenCount": 329250,
      "inlineFile": {
        "mimeType": "text/xml",
        "data": "VGhpcyBmaWxlIGlzIGEgbWVyZ2VkIHJlcHJlc2VudGF0aW9uIG9mIGEgc3Vic2V0IG9mIHRoZSBjb2RlYmFzZSwgY29udGFpbmluZyBzcGVjaWZpY2FsbHkgaW5jbHVkZWQgZmlsZXMgYW5kIGZpbGVzIG5vdCBtYXRjaGluZyBpZ25vcmUgcGF0dGVybnMsIGNvbWJpbmVkIGludG8gYSBzaW5nbGUgZG9jdW1lbnQgYnkgUmVwb21peC4KCjxmaWxlX3N1bW1hcnk+ClRoaXMgc2VjdGlvbiBjb250YWlucyBhIHN1bW1hcnkgb2YgdGhpcyBmaWxlLgoKPHB1cnBvc2U+ClRoaXMgZmlsZSBjb250YWlucyBhIHBhY2tlZCByZXByZXNlbnRhdGlvbiBvZiBhIHN1YnNldCBvZiB0aGUgcmVwb3NpdG9yeSdzIGNvbnRlbnRzIHRoYXQgaXMgY29uc2lkZXJlZCB0aGUgbW9zdCBpbXBvcnRhbnQgY29udGV4dC4KSXQgaXMgZGVzaWduZWQgdG8gYmUgZWFzaWx5IGNvbnN1bWFibGUgYnkgQUkgc3lzdGVtcyBmb3IgYW5hbHlzaXMsIGNvZGUgcmV2aWV3LApvciBvdGhlciBhdXRvbWF0ZWQgcHJvY2Vzc2VzLgo8L3B1cnBvc2U+Cgo8ZmlsZV9mb3JtYXQ+ClRoZSBjb250ZW50IGlzIG9yZ2FuaXplZCBhcyBmb2xsb3dzOgoxLiBUaGlzIHN1bW1hcnkgc2VjdGlvbgoyLiBSZXBvc2l0b3J5IGluZm9ybWF0aW9uCjMuIERpcmVjdG9yeSBzdHJ1Y3R1cmUKNC4gUmVwb3NpdG9yeSBmaWxlcyAoaWYgZW5hYmxlZCkKNS4gTXVsdGlwbGUgZmlsZSBlbnRyaWVzLCBlYWNoIGNvbnNpc3Rpbmcgb2Y6CiAgLSBGaWxlIHBhdGggYXMgYW4gYXR0cmlidXRlCiAgLSBGdWxsIGNvbnRlbnRzIG9mIHRoZSBmaWxlCjwvZmlsZV9mb3JtYXQ+Cgo8dXNhZ2VfZ3VpZGVsaW5lcz4KLSBUaGlzIGZpbGUgc2hvdWxkIGJlIHRyZWF0ZWQgYXMgcmVhZC1vbmx5LiBBbnkgY2hhbmdlcyBzaG91bGQgYmUgbWFkZSB0byB0aGUKICBvcmlnaW5hbCByZXBvc2l0b3J5IGZpbGVzLCBub3QgdGhpcyBwYWNrZWQgdmVyc2lvbi4KLSBXaGVuIHByb2Nlc3NpbmcgdGhpcyBmaWxlLCB1c2UgdGhlIGZpbGUgcGF0aCB0byBkaXN0aW5ndWlzaAogIGJldHdlZW4gZGlmZmVyZW50IGZpbGVzIGluIHRoZSByZXBvc2l0b3J5LgotIEJlIGF3YXJlIHRoYXQgdGhpcyBmaWxlIG1heSBjb250YWluIHNlbnNpdGl2ZSBpbmZvcm1hdGlvbi4gSGFuZGxlIGl0IHdpdGgKICB0aGUgc2FtZSBsZXZlbCBvZiBzZWN1cml0eSBhcyB5b3Ugd291bGQgdGhlIG9yaWdpbmFsIHJlcG9zaXRvcnkuCjwvdXNhZ2VfZ3VpZGVsaW5lcz4KCjxub3Rlcz4KLSBTb21lIGZpbGVzIG1heSBoYXZlIGJlZW4gZXhjbHVkZWQgYmFzZWQgb24gLmdpdGlnbm9yZSBydWxlcyBhbmQgUmVwb21peCdzIGNvbmZpZ3VyYXRpb24KLSBCaW5hcnkgZmlsZXMgYXJlIG5vdCBpbmNsdWRlZCBpbiB0aGlzIHBhY2tlZCByZXByZXNlbnRhdGlvbi4gUGxlYXNlIHJlZmVyIHRvIHRoZSBSZXBvc2l0b3J5IFN0cnVjdHVyZSBzZWN0aW9uIGZvciBhIGNvbXBsZXRlIGxpc3Qgb2YgZmlsZSBwYXRocywgaW5jbHVkaW5nIGJpbmFyeSBmaWxlcwotIE9ubHkgZmlsZXMgbWF0Y2hpbmcgdGhlc2UgcGF0dGVybnMgYXJlIGluY2x1ZGVkOiBjcmF0ZXMvc3RhZ2VzL3N0YWdlcy9zcmMvKiosIGNyYXRlcy9zdGFnZXMvYXBpL3NyYy8qKiwgY3JhdGVzL3N0YWdlcy90eXBlcy9zcmMvKiosIGNyYXRlcy9uZXQvZG93bmxvYWRlcnMvc3JjLyoqLCBjcmF0ZXMvbmV0L25ldHdvcmsvc3JjL3BlZXJzLnJzLCBjcmF0ZXMvbmV0L25ldHdvcmsvc3JjL2ZldGNoLyoqLCBjcmF0ZXMvbmV0L25ldHdvcmsvc3JjL2V0aF9yZXF1ZXN0cy5ycywgY3JhdGVzL25ldC9uZXR3b3JrLXR5cGVzL3NyYy9wZWVycy8qKiwgY3JhdGVzL2NoYWluLXN0YXRlL3NyYy8qKiwgY3JhdGVzL2NvbmZpZy9zcmMvKiosIGRvY3MvY3JhdGVzL3N0YWdlcy5tZAotIEZpbGVzIG1hdGNoaW5nIHRoZXNlIHBhdHRlcm5zIGFyZSBleGNsdWRlZDogKiovdGVzdHMvKiosICoqL2JlbmNoZXMvKiosICoqL3Rlc3RfdXRpbHMvKioKLSBGaWxlcyBtYXRjaGluZyBwYXR0ZXJucyBpbiAuZ2l0aWdub3JlIGFyZSBleGNsdWRlZAotIEZpbGVzIG1hdGNoaW5nIGRlZmF1bHQgaWdub3JlIHBhdHRlcm5zIGFyZSBleGNsdWRlZAotIEZpbGVzIGFyZSBzb3J0ZWQgYnkgR2l0IGNoYW5nZSBjb3VudCAoZmlsZXMgd2l0aCBtb3JlIGNoYW5nZXMgYXJlIGF0IHRoZSBib3R0b20pCjwvbm90ZXM+Cgo8L2ZpbGVfc3VtbWFyeT4KCjxkaXJlY3Rvcnlfc3RydWN0dXJlPgpjcmF0ZXMvCiAgY2hhaW4tc3RhdGUvCiAgICBzcmMvCiAgICAgIGNoYWluX2luZm8ucnMKICAgICAgZGVmZXJyZWRfdHJpZS5ycwogICAgICBpbl9tZW1vcnkucnMKICAgICAgbGliLnJzCiAgICAgIG1lbW9yeV9vdmVybGF5LnJzCiAgICAgIG5vb3AucnMKICAgICAgbm90aWZpY2F0aW9ucy5ycwogICAgICB0ZXN0X3V0aWxzLnJzCiAgY29uZmlnLwogICAgc3JjLwogICAgICBjb25maWcucnMKICAgICAgbGliLnJzCiAgbmV0LwogICAgZG93bmxvYWRlcnMvCiAgICAgIHNyYy8KICAgICAgICBib2RpZXMvCiAgICAgICAgICBib2RpZXMucnMKICAgICAgICAgIG1vZC5ycwogICAgICAgICAgbm9vcC5ycwogICAgICAgICAgcXVldWUucnMKICAgICAgICAgIHJlcXVlc3QucnMKICAgICAgICAgIHRhc2sucnMKICAgICAgICAgIHRlc3RfdXRpbHMucnMKICAgICAgICBoZWFkZXJzLwogICAgICAgICAgbW9kLnJzCiAgICAgICAgICBub29wLnJzCiAgICAgICAgICByZXZlcnNlX2hlYWRlcnMucnMKICAgICAgICAgIHRhc2sucnMKICAgICAgICAgIHRlc3RfdXRpbHMucnMKICAgICAgICBmaWxlX2NsaWVudC5ycwogICAgICAgIGZpbGVfY29kZWMucnMKICAgICAgICBsaWIucnMKICAgICAgICBtZXRyaWNzLnJzCiAgICAgICAgcmVjZWlwdF9maWxlX2NsaWVudC5ycwogICAgbmV0d29yay8KICAgICAgc3JjLwogICAgICAgIGZldGNoLwogICAgICAgICAgY2xpZW50LnJzCiAgICAgICAgICBtb2QucnMKICAgICAgICBldGhfcmVxdWVzdHMucnMKICAgICAgICBwZWVycy5ycwogICAgbmV0d29yay10eXBlcy8KICAgICAgc3JjLwogICAgICAgIHBlZXJzLwogICAgICAgICAgYWRkci5ycwogICAgICAgICAgY29uZmlnLnJzCiAgICAgICAgICBraW5kLnJzCiAgICAgICAgICBtb2QucnMKICAgICAgICAgIHJlcHV0YXRpb24ucnMKICAgICAgICAgIHN0YXRlLnJzCiAgc3RhZ2VzLwogICAgYXBpLwogICAgICBzcmMvCiAgICAgICAgbWV0cmljcy8KICAgICAgICAgIGxpc3RlbmVyLnJzCiAgICAgICAgICBtb2QucnMKICAgICAgICAgIHN5bmNfbWV0cmljcy5ycwogICAgICAgIHBpcGVsaW5lLwogICAgICAgICAgYnVpbGRlci5ycwogICAgICAgICAgY3RybC5ycwogICAgICAgICAgZXZlbnQucnMKICAgICAgICAgIG1vZC5ycwogICAgICAgICAgcHJvZ3Jlc3MucnMKICAgICAgICAgIHNldC5ycwogICAgICAgIGVycm9yLnJzCiAgICAgICAgbGliLnJzCiAgICAgICAgc3RhZ2UucnMKICAgICAgICB0ZXN0X3V0aWxzLnJzCiAgICAgICAgdXRpbC5ycwogICAgc3RhZ2VzLwogICAgICBzcmMvCiAgICAgICAgc3RhZ2VzLwogICAgICAgICAgYm9kaWVzLnJzCiAgICAgICAgICBlcmEucnMKICAgICAgICAgIGV4ZWN1dGlvbi5ycwogICAgICAgICAgZmluaXNoLnJzCiAgICAgICAgICBoYXNoaW5nX2FjY291bnQucnMKICAgICAgICAgIGhhc2hpbmdfc3RvcmFnZS5ycwogICAgICAgICAgaGVhZGVycy5ycwogICAgICAgICAgaW5kZXhfYWNjb3VudF9oaXN0b3J5LnJzCiAgICAgICAgICBpbmRleF9zdG9yYWdlX2hpc3RvcnkucnMKICAgICAgICAgIG1lcmtsZV9jaGFuZ2VzZXRzLnJzCiAgICAgICAgICBtZXJrbGUucnMKICAgICAgICAgIG1vZC5ycwogICAgICAgICAgcHJ1bmUucnMKICAgICAgICAgIHNlbmRlcl9yZWNvdmVyeS5ycwogICAgICAgICAgdHhfbG9va3VwLnJzCiAgICAgICAgICB1dGlscy5ycwogICAgICAgIGxpYi5ycwogICAgICAgIHByZWx1ZGUucnMKICAgICAgICBzZXRzLnJzCiAgICB0eXBlcy8KICAgICAgc3JjLwogICAgICAgIGNoZWNrcG9pbnRzLnJzCiAgICAgICAgZXhlY3V0aW9uLnJzCiAgICAgICAgaWQucnMKICAgICAgICBsaWIucnMKZG9jcy8KICBjcmF0ZXMvCiAgICBzdGFnZXMubWQKPC9kaXJlY3Rvcnlfc3RydWN0dXJlPgoKPGZpbGVzPgpUaGlzIHNlY3Rpb24gY29udGFpbnMgdGhlIGNvbnRlbnRzIG9mIHRoZSByZXBvc2l0b3J5J3MgZmlsZXMuCgo8ZmlsZSBwYXRoPSJjcmF0ZXMvY2hhaW4tc3RhdGUvc3JjL21lbW9yeV9vdmVybGF5LnJzIj4KdXNlIHN1cGVyOjpFeGVjdXRlZEJsb2NrOwp1c2UgYWxsb3lfY29uc2Vuc3VzOjpCbG9ja0hlYWRlcjsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OntrZWNjYWsyNTYsIEFkZHJlc3MsIEJsb2NrTnVtYmVyLCBCeXRlcywgU3RvcmFnZUtleSwgU3RvcmFnZVZhbHVlLCBCMjU2fTsKdXNlIHJldGhfZXJyb3JzOjpQcm92aWRlclJlc3VsdDsKdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OntBY2NvdW50LCBCeXRlY29kZSwgTm9kZVByaW1pdGl2ZXN9Owp1c2UgcmV0aF9zdG9yYWdlX2FwaTo6ewogICAgQWNjb3VudFJlYWRlciwgQmxvY2tIYXNoUmVhZGVyLCBCeXRlY29kZVJlYWRlciwgSGFzaGVkUG9zdFN0YXRlUHJvdmlkZXIsIFN0YXRlUHJvb2ZQcm92aWRlciwKICAgIFN0YXRlUHJvdmlkZXIsIFN0YXRlUHJvdmlkZXJCb3gsIFN0YXRlUm9vdFByb3ZpZGVyLCBTdG9yYWdlUm9vdFByb3ZpZGVyLAp9Owp1c2UgcmV0aF90cmllOjp7CiAgICB1cGRhdGVzOjpUcmllVXBkYXRlcywgQWNjb3VudFByb29mLCBIYXNoZWRQb3N0U3RhdGUsIEhhc2hlZFN0b3JhZ2UsIE11bHRpUHJvb2YsCiAgICBNdWx0aVByb29mVGFyZ2V0cywgU3RvcmFnZU11bHRpUHJvb2YsIFRyaWVJbnB1dCwKfTsKdXNlIHJldm1fZGF0YWJhc2U6OkJ1bmRsZVN0YXRlOwp1c2Ugc3RkOjp7Ym9ycm93OjpDb3csIHN5bmM6Ok9uY2VMb2NrfTsKCi8vLyBBIHN0YXRlIHByb3ZpZGVyIHRoYXQgc3RvcmVzIHJlZmVyZW5jZXMgdG8gaW4tbWVtb3J5IGJsb2NrcyBhbG9uZyB3aXRoIHRoZWlyIHN0YXRlIGFzIHdlbGwgYXMgYQovLy8gcmVmZXJlbmNlIG9mIHRoZSBoaXN0b3JpY2FsIHN0YXRlIHByb3ZpZGVyIGZvciBmYWxsYmFjayBsb29rdXBzLgojW2V4cGVjdChtaXNzaW5nX2RlYnVnX2ltcGxlbWVudGF0aW9ucyldCnB1YiBzdHJ1Y3QgTWVtb3J5T3ZlcmxheVN0YXRlUHJvdmlkZXJSZWY8CiAgICAnYSwKICAgIE46IE5vZGVQcmltaXRpdmVzID0gcmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpFdGhQcmltaXRpdmVzLAo+IHsKICAgIC8vLyBIaXN0b3JpY2FsIHN0YXRlIHByb3ZpZGVyIGZvciBzdGF0ZSBsb29rdXBzIHRoYXQgYXJlIG5vdCBmb3VuZCBpbiBtZW1vcnkgYmxvY2tzLgogICAgcHViKGNyYXRlKSBoaXN0b3JpY2FsOiBCb3g8ZHluIFN0YXRlUHJvdmlkZXIgKyAnYT4sCiAgICAvLy8gVGhlIGNvbGxlY3Rpb24gb2YgZXhlY3V0ZWQgcGFyZW50IGJsb2Nrcy4gRXhwZWN0ZWQgb3JkZXIgaXMgbmV3ZXN0IHRvIG9sZGVzdC4KICAgIHB1YihjcmF0ZSkgaW5fbWVtb3J5OiBDb3c8J2EsIFtFeGVjdXRlZEJsb2NrPE4+XT4sCiAgICAvLy8gTGF6eS1sb2FkZWQgaW4tbWVtb3J5IHRyaWUgZGF0YS4KICAgIHB1YihjcmF0ZSkgdHJpZV9pbnB1dDogT25jZUxvY2s8VHJpZUlucHV0PiwKfQoKaW1wbDwnYSwgTjogTm9kZVByaW1pdGl2ZXM+IE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyUmVmPCdhLCBOPiB7CiAgICAvLy8gQ3JlYXRlIG5ldyBtZW1vcnkgb3ZlcmxheSBzdGF0ZSBwcm92aWRlci4KICAgIC8vLwogICAgLy8vICMjIEFyZ3VtZW50cwogICAgLy8vCiAgICAvLy8gLSBgaW5fbWVtb3J5YCAtIHRoZSBjb2xsZWN0aW9uIG9mIGV4ZWN1dGVkIGFuY2VzdG9yIGJsb2NrcyBpbiByZXZlcnNlLgogICAgLy8vIC0gYGhpc3RvcmljYWxgIC0gYSBoaXN0b3JpY2FsIHN0YXRlIHByb3ZpZGVyIGZvciB0aGUgbGF0ZXN0IGFuY2VzdG9yIGJsb2NrIHN0b3JlZCBpbiB0aGUKICAgIC8vLyAgIGRhdGFiYXNlLgogICAgcHViIGZuIG5ldyhoaXN0b3JpY2FsOiBCb3g8ZHluIFN0YXRlUHJvdmlkZXIgKyAnYT4sIGluX21lbW9yeTogVmVjPEV4ZWN1dGVkQmxvY2s8Tj4+KSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgaGlzdG9yaWNhbCwgaW5fbWVtb3J5OiBDb3c6Ok93bmVkKGluX21lbW9yeSksIHRyaWVfaW5wdXQ6IE9uY2VMb2NrOjpuZXcoKSB9CiAgICB9CgogICAgLy8vIFR1cm4gdGhpcyBzdGF0ZSBwcm92aWRlciBpbnRvIGEgc3RhdGUgcHJvdmlkZXIKICAgIHB1YiBmbiBib3hlZChzZWxmKSAtPiBCb3g8ZHluIFN0YXRlUHJvdmlkZXIgKyAnYT4gewogICAgICAgIEJveDo6bmV3KHNlbGYpCiAgICB9CgogICAgLy8vIFJldHVybiBsYXp5LWxvYWRlZCB0cmllIHN0YXRlIGFnZ3JlZ2F0ZWQgZnJvbSBpbi1tZW1vcnkgYmxvY2tzLgogICAgZm4gdHJpZV9pbnB1dCgmc2VsZikgLT4gJlRyaWVJbnB1dCB7CiAgICAgICAgc2VsZi50cmllX2lucHV0LmdldF9vcl9pbml0KHx8IHsKICAgICAgICAgICAgbGV0IG11dCBpbnB1dCA9IFRyaWVJbnB1dDo6ZGVmYXVsdCgpOwogICAgICAgICAgICAvLyBJdGVyYXRlIGZyb20gb2xkZXN0IHRvIG5ld2VzdAogICAgICAgICAgICBmb3IgYmxvY2sgaW4gc2VsZi5pbl9tZW1vcnkuaXRlcigpLnJldigpIHsKICAgICAgICAgICAgICAgIGxldCBkYXRhID0gYmxvY2sudHJpZV9kYXRhKCk7CiAgICAgICAgICAgICAgICBpbnB1dC5ub2Rlcy5leHRlbmRfZnJvbV9zb3J0ZWQoJmRhdGEudHJpZV91cGRhdGVzKTsKICAgICAgICAgICAgICAgIGlucHV0LnN0YXRlLmV4dGVuZF9mcm9tX3NvcnRlZCgmZGF0YS5oYXNoZWRfc3RhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlucHV0CiAgICAgICAgfSkKICAgIH0KCiAgICBmbiBtZXJnZWRfaGFzaGVkX3N0b3JhZ2UoJnNlbGYsIGFkZHJlc3M6IEFkZHJlc3MsIHN0b3JhZ2U6IEhhc2hlZFN0b3JhZ2UpIC0+IEhhc2hlZFN0b3JhZ2UgewogICAgICAgIGxldCBzdGF0ZSA9ICZzZWxmLnRyaWVfaW5wdXQoKS5zdGF0ZTsKICAgICAgICBsZXQgbXV0IGhhc2hlZCA9IHN0YXRlLnN0b3JhZ2VzLmdldCgma2VjY2FrMjU2KGFkZHJlc3MpKS5jbG9uZWQoKS51bndyYXBfb3JfZGVmYXVsdCgpOwogICAgICAgIGhhc2hlZC5leHRlbmQoJnN0b3JhZ2UpOwogICAgICAgIGhhc2hlZAogICAgfQp9CgppbXBsPE46IE5vZGVQcmltaXRpdmVzPiBCbG9ja0hhc2hSZWFkZXIgZm9yIE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyUmVmPCdfLCBOPiB7CiAgICBmbiBibG9ja19oYXNoKCZzZWxmLCBudW1iZXI6IEJsb2NrTnVtYmVyKSAtPiBQcm92aWRlclJlc3VsdDxPcHRpb248QjI1Nj4+IHsKICAgICAgICBmb3IgYmxvY2sgaW4gc2VsZi5pbl9tZW1vcnkuaXRlcigpIHsKICAgICAgICAgICAgaWYgYmxvY2sucmVjb3ZlcmVkX2Jsb2NrKCkubnVtYmVyKCkgPT0gbnVtYmVyIHsKICAgICAgICAgICAgICAgIHJldHVybiBPayhTb21lKGJsb2NrLnJlY292ZXJlZF9ibG9jaygpLmhhc2goKSkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZWxmLmhpc3RvcmljYWwuYmxvY2tfaGFzaChudW1iZXIpCiAgICB9CgogICAgZm4gY2Fub25pY2FsX2hhc2hlc19yYW5nZSgKICAgICAgICAmc2VsZiwKICAgICAgICBzdGFydDogQmxvY2tOdW1iZXIsCiAgICAgICAgZW5kOiBCbG9ja051bWJlciwKICAgICkgLT4gUHJvdmlkZXJSZXN1bHQ8VmVjPEIyNTY+PiB7CiAgICAgICAgbGV0IHJhbmdlID0gc3RhcnQuLmVuZDsKICAgICAgICBsZXQgbXV0IGVhcmxpZXN0X2Jsb2NrX251bWJlciA9IE5vbmU7CiAgICAgICAgbGV0IG11dCBpbl9tZW1vcnlfaGFzaGVzID0gVmVjOjp3aXRoX2NhcGFjaXR5KHJhbmdlLnNpemVfaGludCgpLjApOwoKICAgICAgICAvLyBpdGVyYXRlIGluIGFzY2VuZGluZyBvcmRlciAob2xkZXN0IHRvIG5ld2VzdCA9IGxvdyB0byBoaWdoKQogICAgICAgIGZvciBibG9jayBpbiBzZWxmLmluX21lbW9yeS5pdGVyKCkgewogICAgICAgICAgICBsZXQgYmxvY2tfbnVtID0gYmxvY2sucmVjb3ZlcmVkX2Jsb2NrKCkubnVtYmVyKCk7CiAgICAgICAgICAgIGlmIHJhbmdlLmNvbnRhaW5zKCZibG9ja19udW0pIHsKICAgICAgICAgICAgICAgIGluX21lbW9yeV9oYXNoZXMucHVzaChibG9jay5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCkpOwogICAgICAgICAgICAgICAgZWFybGllc3RfYmxvY2tfbnVtYmVyID0gU29tZShibG9ja19udW0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBgc2VsZi5pbl9tZW1vcnlgIHN0b3JlcyBleGVjdXRlZCBibG9ja3MgaW4gYXNjZW5kaW5nIG9yZGVyIChvbGRlc3QgdG8gbmV3ZXN0KS4KICAgICAgICAvLyBIb3dldmVyLCBgaW5fbWVtb3J5X2hhc2hlc2Agc2hvdWxkIGJlIGNvbnN0cnVjdGVkIGluIGRlc2NlbmRpbmcgb3JkZXIgKG5ld2VzdCB0byBvbGRlc3QpLAogICAgICAgIC8vIHNvIHdlIHJldmVyc2UgdGhlIHZlY3RvciBhZnRlciBjb2xsZWN0aW5nIHRoZSBoYXNoZXMuCiAgICAgICAgaW5fbWVtb3J5X2hhc2hlcy5yZXZlcnNlKCk7CgogICAgICAgIGxldCBtdXQgaGFzaGVzID0KICAgICAgICAgICAgc2VsZi5oaXN0b3JpY2FsLmNhbm9uaWNhbF9oYXNoZXNfcmFuZ2Uoc3RhcnQsIGVhcmxpZXN0X2Jsb2NrX251bWJlci51bndyYXBfb3IoZW5kKSk/OwogICAgICAgIGhhc2hlcy5hcHBlbmQoJm11dCBpbl9tZW1vcnlfaGFzaGVzKTsKICAgICAgICBPayhoYXNoZXMpCiAgICB9Cn0KCmltcGw8TjogTm9kZVByaW1pdGl2ZXM+IEFjY291bnRSZWFkZXIgZm9yIE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyUmVmPCdfLCBOPiB7CiAgICBmbiBiYXNpY19hY2NvdW50KCZzZWxmLCBhZGRyZXNzOiAmQWRkcmVzcykgLT4gUHJvdmlkZXJSZXN1bHQ8T3B0aW9uPEFjY291bnQ+PiB7CiAgICAgICAgZm9yIGJsb2NrIGluIHNlbGYuaW5fbWVtb3J5Lml0ZXIoKSB7CiAgICAgICAgICAgIGlmIGxldCBTb21lKGFjY291bnQpID0gYmxvY2suZXhlY3V0aW9uX291dHB1dC5hY2NvdW50KGFkZHJlc3MpIHsKICAgICAgICAgICAgICAgIHJldHVybiBPayhhY2NvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2VsZi5oaXN0b3JpY2FsLmJhc2ljX2FjY291bnQoYWRkcmVzcykKICAgIH0KfQoKaW1wbDxOOiBOb2RlUHJpbWl0aXZlcz4gU3RhdGVSb290UHJvdmlkZXIgZm9yIE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyUmVmPCdfLCBOPiB7CiAgICBmbiBzdGF0ZV9yb290KCZzZWxmLCBzdGF0ZTogSGFzaGVkUG9zdFN0YXRlKSAtPiBQcm92aWRlclJlc3VsdDxCMjU2PiB7CiAgICAgICAgc2VsZi5zdGF0ZV9yb290X2Zyb21fbm9kZXMoVHJpZUlucHV0Ojpmcm9tX3N0YXRlKHN0YXRlKSkKICAgIH0KCiAgICBmbiBzdGF0ZV9yb290X2Zyb21fbm9kZXMoJnNlbGYsIG11dCBpbnB1dDogVHJpZUlucHV0KSAtPiBQcm92aWRlclJlc3VsdDxCMjU2PiB7CiAgICAgICAgaW5wdXQucHJlcGVuZF9zZWxmKHNlbGYudHJpZV9pbnB1dCgpLmNsb25lKCkpOwogICAgICAgIHNlbGYuaGlzdG9yaWNhbC5zdGF0ZV9yb290X2Zyb21fbm9kZXMoaW5wdXQpCiAgICB9CgogICAgZm4gc3RhdGVfcm9vdF93aXRoX3VwZGF0ZXMoCiAgICAgICAgJnNlbGYsCiAgICAgICAgc3RhdGU6IEhhc2hlZFBvc3RTdGF0ZSwKICAgICkgLT4gUHJvdmlkZXJSZXN1bHQ8KEIyNTYsIFRyaWVVcGRhdGVzKT4gewogICAgICAgIHNlbGYuc3RhdGVfcm9vdF9mcm9tX25vZGVzX3dpdGhfdXBkYXRlcyhUcmllSW5wdXQ6OmZyb21fc3RhdGUoc3RhdGUpKQogICAgfQoKICAgIGZuIHN0YXRlX3Jvb3RfZnJvbV9ub2Rlc193aXRoX3VwZGF0ZXMoCiAgICAgICAgJnNlbGYsCiAgICAgICAgbXV0IGlucHV0OiBUcmllSW5wdXQsCiAgICApIC0+IFByb3ZpZGVyUmVzdWx0PChCMjU2LCBUcmllVXBkYXRlcyk+IHsKICAgICAgICBpbnB1dC5wcmVwZW5kX3NlbGYoc2VsZi50cmllX2lucHV0KCkuY2xvbmUoKSk7CiAgICAgICAgc2VsZi5oaXN0b3JpY2FsLnN0YXRlX3Jvb3RfZnJvbV9ub2Rlc193aXRoX3VwZGF0ZXMoaW5wdXQpCiAgICB9Cn0KCmltcGw8TjogTm9kZVByaW1pdGl2ZXM+IFN0b3JhZ2VSb290UHJvdmlkZXIgZm9yIE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyUmVmPCdfLCBOPiB7CiAgICAvLyBUT0RPOiBDdXJyZW50bHkgdGhpcyBkb2VzIG5vdCByZXVzZSBhdmFpbGFibGUgaW4tbWVtb3J5IHRyaWUgbm9kZXMuCiAgICBmbiBzdG9yYWdlX3Jvb3QoJnNlbGYsIGFkZHJlc3M6IEFkZHJlc3MsIHN0b3JhZ2U6IEhhc2hlZFN0b3JhZ2UpIC0+IFByb3ZpZGVyUmVzdWx0PEIyNTY+IHsKICAgICAgICBsZXQgbWVyZ2VkID0gc2VsZi5tZXJnZWRfaGFzaGVkX3N0b3JhZ2UoYWRkcmVzcywgc3RvcmFnZSk7CiAgICAgICAgc2VsZi5oaXN0b3JpY2FsLnN0b3JhZ2Vfcm9vdChhZGRyZXNzLCBtZXJnZWQpCiAgICB9CgogICAgLy8gVE9ETzogQ3VycmVudGx5IHRoaXMgZG9lcyBub3QgcmV1c2UgYXZhaWxhYmxlIGluLW1lbW9yeSB0cmllIG5vZGVzLgogICAgZm4gc3RvcmFnZV9wcm9vZigKICAgICAgICAmc2VsZiwKICAgICAgICBhZGRyZXNzOiBBZGRyZXNzLAogICAgICAgIHNsb3Q6IEIyNTYsCiAgICAgICAgc3RvcmFnZTogSGFzaGVkU3RvcmFnZSwKICAgICkgLT4gUHJvdmlkZXJSZXN1bHQ8cmV0aF90cmllOjpTdG9yYWdlUHJvb2Y+IHsKICAgICAgICBsZXQgbWVyZ2VkID0gc2VsZi5tZXJnZWRfaGFzaGVkX3N0b3JhZ2UoYWRkcmVzcywgc3RvcmFnZSk7CiAgICAgICAgc2VsZi5oaXN0b3JpY2FsLnN0b3JhZ2VfcHJvb2YoYWRkcmVzcywgc2xvdCwgbWVyZ2VkKQogICAgfQoKICAgIC8vIFRPRE86IEN1cnJlbnRseSB0aGlzIGRvZXMgbm90IHJldXNlIGF2YWlsYWJsZSBpbi1tZW1vcnkgdHJpZSBub2Rlcy4KICAgIGZuIHN0b3JhZ2VfbXVsdGlwcm9vZigKICAgICAgICAmc2VsZiwKICAgICAgICBhZGRyZXNzOiBBZGRyZXNzLAogICAgICAgIHNsb3RzOiAmW0IyNTZdLAogICAgICAgIHN0b3JhZ2U6IEhhc2hlZFN0b3JhZ2UsCiAgICApIC0+IFByb3ZpZGVyUmVzdWx0PFN0b3JhZ2VNdWx0aVByb29mPiB7CiAgICAgICAgbGV0IG1lcmdlZCA9IHNlbGYubWVyZ2VkX2hhc2hlZF9zdG9yYWdlKGFkZHJlc3MsIHN0b3JhZ2UpOwogICAgICAgIHNlbGYuaGlzdG9yaWNhbC5zdG9yYWdlX211bHRpcHJvb2YoYWRkcmVzcywgc2xvdHMsIG1lcmdlZCkKICAgIH0KfQoKaW1wbDxOOiBOb2RlUHJpbWl0aXZlcz4gU3RhdGVQcm9vZlByb3ZpZGVyIGZvciBNZW1vcnlPdmVybGF5U3RhdGVQcm92aWRlclJlZjwnXywgTj4gewogICAgZm4gcHJvb2YoCiAgICAgICAgJnNlbGYsCiAgICAgICAgbXV0IGlucHV0OiBUcmllSW5wdXQsCiAgICAgICAgYWRkcmVzczogQWRkcmVzcywKICAgICAgICBzbG90czogJltCMjU2XSwKICAgICkgLT4gUHJvdmlkZXJSZXN1bHQ8QWNjb3VudFByb29mPiB7CiAgICAgICAgaW5wdXQucHJlcGVuZF9zZWxmKHNlbGYudHJpZV9pbnB1dCgpLmNsb25lKCkpOwogICAgICAgIHNlbGYuaGlzdG9yaWNhbC5wcm9vZihpbnB1dCwgYWRkcmVzcywgc2xvdHMpCiAgICB9CgogICAgZm4gbXVsdGlwcm9vZigKICAgICAgICAmc2VsZiwKICAgICAgICBtdXQgaW5wdXQ6IFRyaWVJbnB1dCwKICAgICAgICB0YXJnZXRzOiBNdWx0aVByb29mVGFyZ2V0cywKICAgICkgLT4gUHJvdmlkZXJSZXN1bHQ8TXVsdGlQcm9vZj4gewogICAgICAgIGlucHV0LnByZXBlbmRfc2VsZihzZWxmLnRyaWVfaW5wdXQoKS5jbG9uZSgpKTsKICAgICAgICBzZWxmLmhpc3RvcmljYWwubXVsdGlwcm9vZihpbnB1dCwgdGFyZ2V0cykKICAgIH0KCiAgICBmbiB3aXRuZXNzKCZzZWxmLCBtdXQgaW5wdXQ6IFRyaWVJbnB1dCwgdGFyZ2V0OiBIYXNoZWRQb3N0U3RhdGUpIC0+IFByb3ZpZGVyUmVzdWx0PFZlYzxCeXRlcz4+IHsKICAgICAgICBpbnB1dC5wcmVwZW5kX3NlbGYoc2VsZi50cmllX2lucHV0KCkuY2xvbmUoKSk7CiAgICAgICAgc2VsZi5oaXN0b3JpY2FsLndpdG5lc3MoaW5wdXQsIHRhcmdldCkKICAgIH0KfQoKaW1wbDxOOiBOb2RlUHJpbWl0aXZlcz4gSGFzaGVkUG9zdFN0YXRlUHJvdmlkZXIgZm9yIE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyUmVmPCdfLCBOPiB7CiAgICBmbiBoYXNoZWRfcG9zdF9zdGF0ZSgmc2VsZiwgYnVuZGxlX3N0YXRlOiAmQnVuZGxlU3RhdGUpIC0+IEhhc2hlZFBvc3RTdGF0ZSB7CiAgICAgICAgc2VsZi5oaXN0b3JpY2FsLmhhc2hlZF9wb3N0X3N0YXRlKGJ1bmRsZV9zdGF0ZSkKICAgIH0KfQoKaW1wbDxOOiBOb2RlUHJpbWl0aXZlcz4gU3RhdGVQcm92aWRlciBmb3IgTWVtb3J5T3ZlcmxheVN0YXRlUHJvdmlkZXJSZWY8J18sIE4+IHsKICAgIGZuIHN0b3JhZ2UoCiAgICAgICAgJnNlbGYsCiAgICAgICAgYWRkcmVzczogQWRkcmVzcywKICAgICAgICBzdG9yYWdlX2tleTogU3RvcmFnZUtleSwKICAgICkgLT4gUHJvdmlkZXJSZXN1bHQ8T3B0aW9uPFN0b3JhZ2VWYWx1ZT4+IHsKICAgICAgICBmb3IgYmxvY2sgaW4gc2VsZi5pbl9tZW1vcnkuaXRlcigpIHsKICAgICAgICAgICAgaWYgbGV0IFNvbWUodmFsdWUpID0gYmxvY2suZXhlY3V0aW9uX291dHB1dC5zdG9yYWdlKCZhZGRyZXNzLCBzdG9yYWdlX2tleS5pbnRvKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBPayhTb21lKHZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNlbGYuaGlzdG9yaWNhbC5zdG9yYWdlKGFkZHJlc3MsIHN0b3JhZ2Vfa2V5KQogICAgfQp9CgppbXBsPE46IE5vZGVQcmltaXRpdmVzPiBCeXRlY29kZVJlYWRlciBmb3IgTWVtb3J5T3ZlcmxheVN0YXRlUHJvdmlkZXJSZWY8J18sIE4+IHsKICAgIGZuIGJ5dGVjb2RlX2J5X2hhc2goJnNlbGYsIGNvZGVfaGFzaDogJkIyNTYpIC0+IFByb3ZpZGVyUmVzdWx0PE9wdGlvbjxCeXRlY29kZT4+IHsKICAgICAgICBmb3IgYmxvY2sgaW4gc2VsZi5pbl9tZW1vcnkuaXRlcigpIHsKICAgICAgICAgICAgaWYgbGV0IFNvbWUoY29udHJhY3QpID0gYmxvY2suZXhlY3V0aW9uX291dHB1dC5ieXRlY29kZShjb2RlX2hhc2gpIHsKICAgICAgICAgICAgICAgIHJldHVybiBPayhTb21lKGNvbnRyYWN0KSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNlbGYuaGlzdG9yaWNhbC5ieXRlY29kZV9ieV9oYXNoKGNvZGVfaGFzaCkKICAgIH0KfQoKLy8vIEFuIG93bmVkIHN0YXRlIHByb3ZpZGVyIHRoYXQgc3RvcmVzIHJlZmVyZW5jZXMgdG8gaW4tbWVtb3J5IGJsb2NrcyBhbG9uZyB3aXRoIHRoZWlyIHN0YXRlIGFzCi8vLyB3ZWxsIGFzIGEgcmVmZXJlbmNlIG9mIHRoZSBoaXN0b3JpY2FsIHN0YXRlIHByb3ZpZGVyIGZvciBmYWxsYmFjayBsb29rdXBzLgojW2V4cGVjdChtaXNzaW5nX2RlYnVnX2ltcGxlbWVudGF0aW9ucyldCnB1YiBzdHJ1Y3QgTWVtb3J5T3ZlcmxheVN0YXRlUHJvdmlkZXI8TjogTm9kZVByaW1pdGl2ZXMgPSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkV0aFByaW1pdGl2ZXM+IHsKICAgIC8vLyBIaXN0b3JpY2FsIHN0YXRlIHByb3ZpZGVyIGZvciBzdGF0ZSBsb29rdXBzIHRoYXQgYXJlIG5vdCBmb3VuZCBpbiBtZW1vcnkgYmxvY2tzLgogICAgcHViKGNyYXRlKSBoaXN0b3JpY2FsOiBTdGF0ZVByb3ZpZGVyQm94LAogICAgLy8vIFRoZSBjb2xsZWN0aW9uIG9mIGV4ZWN1dGVkIHBhcmVudCBibG9ja3MuIEV4cGVjdGVkIG9yZGVyIGlzIG5ld2VzdCB0byBvbGRlc3QuCiAgICBwdWIoY3JhdGUpIGluX21lbW9yeTogVmVjPEV4ZWN1dGVkQmxvY2s8Tj4+LAogICAgLy8vIExhenktbG9hZGVkIGluLW1lbW9yeSB0cmllIGRhdGEuCiAgICBwdWIoY3JhdGUpIHRyaWVfaW5wdXQ6IE9uY2VMb2NrPFRyaWVJbnB1dD4sCn0KCmltcGw8TjogTm9kZVByaW1pdGl2ZXM+IE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyPE4+IHsKICAgIC8vLyBDcmVhdGUgbmV3IG1lbW9yeSBvdmVybGF5IHN0YXRlIHByb3ZpZGVyLgogICAgLy8vCiAgICAvLy8gIyMgQXJndW1lbnRzCiAgICAvLy8KICAgIC8vLyAtIGBpbl9tZW1vcnlgIC0gdGhlIGNvbGxlY3Rpb24gb2YgZXhlY3V0ZWQgYW5jZXN0b3IgYmxvY2tzIGluIHJldmVyc2UuCiAgICAvLy8gLSBgaGlzdG9yaWNhbGAgLSBhIGhpc3RvcmljYWwgc3RhdGUgcHJvdmlkZXIgZm9yIHRoZSBsYXRlc3QgYW5jZXN0b3IgYmxvY2sgc3RvcmVkIGluIHRoZQogICAgLy8vICAgZGF0YWJhc2UuCiAgICBwdWIgZm4gbmV3KGhpc3RvcmljYWw6IFN0YXRlUHJvdmlkZXJCb3gsIGluX21lbW9yeTogVmVjPEV4ZWN1dGVkQmxvY2s8Tj4+KSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgaGlzdG9yaWNhbCwgaW5fbWVtb3J5LCB0cmllX2lucHV0OiBPbmNlTG9jazo6bmV3KCkgfQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgbmV3IHByb3ZpZGVyIHRoYXQgdGFrZXMgdGhlIGBUWGAgYXMgcmVmZXJlbmNlCiAgICAjW2lubGluZShhbHdheXMpXQogICAgZm4gYXNfcmVmKCZzZWxmKSAtPiBNZW1vcnlPdmVybGF5U3RhdGVQcm92aWRlclJlZjwnXywgTj4gewogICAgICAgIE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyUmVmIHsKICAgICAgICAgICAgaGlzdG9yaWNhbDogQm94OjpuZXcoc2VsZi5oaXN0b3JpY2FsLmFzX3JlZigpKSwKICAgICAgICAgICAgaW5fbWVtb3J5OiBDb3c6OkJvcnJvd2VkKCZzZWxmLmluX21lbW9yeSksCiAgICAgICAgICAgIHRyaWVfaW5wdXQ6IHNlbGYudHJpZV9pbnB1dC5jbG9uZSgpLAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gV3JhcHMgdGhlIFtgU2VsZmBdIGluIGEgYEJveGAuCiAgICBwdWIgZm4gYm94ZWQoc2VsZikgLT4gU3RhdGVQcm92aWRlckJveCB7CiAgICAgICAgQm94OjpuZXcoc2VsZikKICAgIH0KfQoKLy8gRGVsZWdhdGVzIGFsbCBwcm92aWRlciBpbXBscyB0byBbYE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyUmVmYF0KcmV0aF9zdG9yYWdlX2FwaTo6bWFjcm9zOjpkZWxlZ2F0ZV9wcm92aWRlcl9pbXBscyEoTWVtb3J5T3ZlcmxheVN0YXRlUHJvdmlkZXI8Tj4gd2hlcmUgW046IE5vZGVQcmltaXRpdmVzXSk7CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9jaGFpbi1zdGF0ZS9zcmMvdGVzdF91dGlscy5ycyI+CnVzZSBjcmF0ZTo6ewogICAgaW5fbWVtb3J5OjpFeGVjdXRlZEJsb2NrLCBDYW5vblN0YXRlTm90aWZpY2F0aW9uLCBDYW5vblN0YXRlTm90aWZpY2F0aW9ucywKICAgIENhbm9uU3RhdGVTdWJzY3JpcHRpb25zLCBDb21wdXRlZFRyaWVEYXRhLAp9Owp1c2UgYWxsb3lfY29uc2Vuc3VzOjp7SGVhZGVyLCBTaWduYWJsZVRyYW5zYWN0aW9uLCBUeEVpcDE1NTksIFR4UmVjZWlwdCwgRU1QVFlfUk9PVF9IQVNIfTsKdXNlIGFsbG95X2VpcHM6OnsKICAgIGVpcDE1NTk6OntFVEhFUkVVTV9CTE9DS19HQVNfTElNSVRfMzBNLCBJTklUSUFMX0JBU0VfRkVFfSwKICAgIGVpcDc2ODU6OlJlcXVlc3RzLAp9Owp1c2UgYWxsb3lfcHJpbWl0aXZlczo6e0FkZHJlc3MsIEJsb2NrTnVtYmVyLCBCMjU2LCBVMjU2fTsKdXNlIGFsbG95X3NpZ25lcjo6U2lnbmVyU3luYzsKdXNlIGFsbG95X3NpZ25lcl9sb2NhbDo6UHJpdmF0ZUtleVNpZ25lcjsKdXNlIGNvcmU6Om1hcmtlcjo6UGhhbnRvbURhdGE7CnVzZSByYW5kOjpSbmc7CnVzZSByZXRoX2NoYWluc3BlYzo6e0NoYWluU3BlYywgRXRoZXJldW1IYXJkZm9yaywgTUlOX1RSQU5TQUNUSU9OX0dBU307CnVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OnsKICAgIEJsb2NrLCBCbG9ja0JvZHksIEV0aFByaW1pdGl2ZXMsIFJlY2VpcHQsIFRyYW5zYWN0aW9uLCBUcmFuc2FjdGlvblNpZ25lZCwKfTsKdXNlIHJldGhfZXhlY3V0aW9uX3R5cGVzOjp7Q2hhaW4sIEV4ZWN1dGlvbk91dGNvbWV9Owp1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6ewogICAgcHJvb2ZzOjp7Y2FsY3VsYXRlX3JlY2VpcHRfcm9vdCwgY2FsY3VsYXRlX3RyYW5zYWN0aW9uX3Jvb3QsIGNhbGN1bGF0ZV93aXRoZHJhd2Fsc19yb290fSwKICAgIEFjY291bnQsIE5vZGVQcmltaXRpdmVzLCBSZWNvdmVyZWQsIFJlY292ZXJlZEJsb2NrLCBTZWFsZWRCbG9jaywgU2VhbGVkSGVhZGVyLAogICAgU2lnbmVkVHJhbnNhY3Rpb24sCn07CnVzZSByZXRoX3N0b3JhZ2VfYXBpOjpOb2RlUHJpbWl0aXZlc1Byb3ZpZGVyOwp1c2UgcmV0aF90cmllOjpyb290OjpzdGF0ZV9yb290X3VuaGFzaGVkOwp1c2UgcmV2bV9kYXRhYmFzZTo6QnVuZGxlU3RhdGU7CnVzZSByZXZtX3N0YXRlOjpBY2NvdW50SW5mbzsKdXNlIHN0ZDo6ewogICAgb3BzOjpSYW5nZSwKICAgIHN5bmM6OntBcmMsIE11dGV4fSwKfTsKdXNlIHRva2lvOjpzeW5jOjpicm9hZGNhc3Q6OntzZWxmLCBTZW5kZXJ9OwoKLy8vIEZ1bmN0aW9uYWxpdHkgdG8gYnVpbGQgYmxvY2tzIGZvciB0ZXN0cyBhbmQgaGVscCB3aXRoIGFzc2VydGlvbnMgYWJvdXQKLy8vIHRoZWlyIGV4ZWN1dGlvbi4KI1tkZXJpdmUoRGVidWcpXQpwdWIgc3RydWN0IFRlc3RCbG9ja0J1aWxkZXI8TjogTm9kZVByaW1pdGl2ZXMgPSBFdGhQcmltaXRpdmVzPiB7CiAgICAvLy8gVGhlIGFjY291bnQgdGhhdCBzaWducyBhbGwgdGhlIGJsb2NrJ3MgdHJhbnNhY3Rpb25zLgogICAgcHViIHNpZ25lcjogQWRkcmVzcywKICAgIC8vLyBQcml2YXRlIGtleSBmb3Igc2lnbmluZy4KICAgIHB1YiBzaWduZXJfcGs6IFByaXZhdGVLZXlTaWduZXIsCiAgICAvLy8gS2VlcHMgdHJhY2sgb2Ygc2lnbmVyJ3MgYWNjb3VudCBpbmZvIGFmdGVyIGV4ZWN1dGlvbiwgd2lsbCBiZSB1cGRhdGVkIGluCiAgICAvLy8gbWV0aG9kcyByZWxhdGVkIHRvIGJsb2NrIGV4ZWN1dGlvbi4KICAgIHB1YiBzaWduZXJfZXhlY3V0ZV9hY2NvdW50X2luZm86IEFjY291bnRJbmZvLAogICAgLy8vIEtlZXBzIHRyYWNrIG9mIHNpZ25lcidzIG5vbmNlLCB3aWxsIGJlIHVwZGF0ZWQgaW4gbWV0aG9kcyByZWxhdGVkCiAgICAvLy8gdG8gYmxvY2sgZXhlY3V0aW9uLgogICAgcHViIHNpZ25lcl9idWlsZF9hY2NvdW50X2luZm86IEFjY291bnRJbmZvLAogICAgLy8vIENoYWluIHNwZWMgb2YgdGhlIGJsb2NrcyBnZW5lcmF0ZWQgYnkgdGhpcyBidWlsZGVyCiAgICBwdWIgY2hhaW5fc3BlYzogQ2hhaW5TcGVjLAogICAgX3ByaW1zOiBQaGFudG9tRGF0YTxOPiwKfQoKaW1wbDxOOiBOb2RlUHJpbWl0aXZlcz4gRGVmYXVsdCBmb3IgVGVzdEJsb2NrQnVpbGRlcjxOPiB7CiAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgbGV0IGluaXRpYWxfYWNjb3VudF9pbmZvID0gQWNjb3VudEluZm86OmZyb21fYmFsYW5jZShVMjU2Ojpmcm9tKDEwKS5wb3coVTI1Njo6ZnJvbSgxOCkpKTsKICAgICAgICBsZXQgc2lnbmVyX3BrID0gUHJpdmF0ZUtleVNpZ25lcjo6cmFuZG9tKCk7CiAgICAgICAgbGV0IHNpZ25lciA9IHNpZ25lcl9way5hZGRyZXNzKCk7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIGNoYWluX3NwZWM6IENoYWluU3BlYzo6ZGVmYXVsdCgpLAogICAgICAgICAgICBzaWduZXIsCiAgICAgICAgICAgIHNpZ25lcl9waywKICAgICAgICAgICAgc2lnbmVyX2V4ZWN1dGVfYWNjb3VudF9pbmZvOiBpbml0aWFsX2FjY291bnRfaW5mby5jbG9uZSgpLAogICAgICAgICAgICBzaWduZXJfYnVpbGRfYWNjb3VudF9pbmZvOiBpbml0aWFsX2FjY291bnRfaW5mbywKICAgICAgICAgICAgX3ByaW1zOiBQaGFudG9tRGF0YSwKICAgICAgICB9CiAgICB9Cn0KCmltcGw8TjogTm9kZVByaW1pdGl2ZXM+IFRlc3RCbG9ja0J1aWxkZXI8Tj4gewogICAgLy8vIFNpZ25lciBwayBzZXR0ZXIuCiAgICBwdWIgZm4gd2l0aF9zaWduZXJfcGsobXV0IHNlbGYsIHNpZ25lcl9wazogUHJpdmF0ZUtleVNpZ25lcikgLT4gU2VsZiB7CiAgICAgICAgc2VsZi5zaWduZXIgPSBzaWduZXJfcGsuYWRkcmVzcygpOwogICAgICAgIHNlbGYuc2lnbmVyX3BrID0gc2lnbmVyX3BrOwoKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIENoYWluc3BlYyBzZXR0ZXIuCiAgICBwdWIgZm4gd2l0aF9jaGFpbl9zcGVjKG11dCBzZWxmLCBjaGFpbl9zcGVjOiBDaGFpblNwZWMpIC0+IFNlbGYgewogICAgICAgIHNlbGYuY2hhaW5fc3BlYyA9IGNoYWluX3NwZWM7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBHYXMgY29zdCBvZiBhIHNpbmdsZSB0cmFuc2FjdGlvbiBnZW5lcmF0ZWQgYnkgdGhlIGJsb2NrIGJ1aWxkZXIuCiAgICBwdWIgZm4gc2luZ2xlX3R4X2Nvc3QoKSAtPiBVMjU2IHsKICAgICAgICBVMjU2Ojpmcm9tKElOSVRJQUxfQkFTRV9GRUUgKiBNSU5fVFJBTlNBQ1RJT05fR0FTKQogICAgfQoKICAgIC8vLyBHZW5lcmF0ZXMgYSByYW5kb20gW2BSZWNvdmVyZWRCbG9ja2BdLgogICAgcHViIGZuIGdlbmVyYXRlX3JhbmRvbV9ibG9jaygKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgbnVtYmVyOiBCbG9ja051bWJlciwKICAgICAgICBwYXJlbnRfaGFzaDogQjI1NiwKICAgICkgLT4gU2VhbGVkQmxvY2s8cmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpCbG9jaz4gewogICAgICAgIGxldCBtdXQgcm5nID0gcmFuZDo6cm5nKCk7CgogICAgICAgIGxldCBtb2NrX3R4ID0gfG5vbmNlOiB1NjR8IC0+IFJlY292ZXJlZDxfPiB7CiAgICAgICAgICAgIGxldCB0eCA9IFRyYW5zYWN0aW9uOjpFaXAxNTU5KFR4RWlwMTU1OSB7CiAgICAgICAgICAgICAgICBjaGFpbl9pZDogc2VsZi5jaGFpbl9zcGVjLmNoYWluLmlkKCksCiAgICAgICAgICAgICAgICBub25jZSwKICAgICAgICAgICAgICAgIGdhc19saW1pdDogTUlOX1RSQU5TQUNUSU9OX0dBUywKICAgICAgICAgICAgICAgIHRvOiBBZGRyZXNzOjpyYW5kb20oKS5pbnRvKCksCiAgICAgICAgICAgICAgICBtYXhfZmVlX3Blcl9nYXM6IElOSVRJQUxfQkFTRV9GRUUgYXMgdTEyOCwKICAgICAgICAgICAgICAgIG1heF9wcmlvcml0eV9mZWVfcGVyX2dhczogMSwKICAgICAgICAgICAgICAgIC4uRGVmYXVsdDo6ZGVmYXVsdCgpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsZXQgc2lnbmF0dXJlX2hhc2ggPSB0eC5zaWduYXR1cmVfaGFzaCgpOwogICAgICAgICAgICBsZXQgc2lnbmF0dXJlID0gc2VsZi5zaWduZXJfcGsuc2lnbl9oYXNoX3N5bmMoJnNpZ25hdHVyZV9oYXNoKS51bndyYXAoKTsKCiAgICAgICAgICAgIFRyYW5zYWN0aW9uU2lnbmVkOjpuZXdfdW5oYXNoZWQodHgsIHNpZ25hdHVyZSkud2l0aF9zaWduZXIoc2VsZi5zaWduZXIpCiAgICAgICAgfTsKCiAgICAgICAgbGV0IG51bV90eHMgPSBybmcucmFuZG9tX3JhbmdlKDAuLjUpOwogICAgICAgIGxldCBzaWduZXJfYmFsYW5jZV9kZWNyZWFzZSA9IFNlbGY6OnNpbmdsZV90eF9jb3N0KCkgKiBVMjU2Ojpmcm9tKG51bV90eHMpOwogICAgICAgIGxldCB0cmFuc2FjdGlvbnM6IFZlYzxSZWNvdmVyZWQ8Xz4+ID0gKDAuLm51bV90eHMpCiAgICAgICAgICAgIC5tYXAofF98IHsKICAgICAgICAgICAgICAgIGxldCB0eCA9IG1vY2tfdHgoc2VsZi5zaWduZXJfYnVpbGRfYWNjb3VudF9pbmZvLm5vbmNlKTsKICAgICAgICAgICAgICAgIHNlbGYuc2lnbmVyX2J1aWxkX2FjY291bnRfaW5mby5ub25jZSArPSAxOwogICAgICAgICAgICAgICAgc2VsZi5zaWduZXJfYnVpbGRfYWNjb3VudF9pbmZvLmJhbGFuY2UgLT0gU2VsZjo6c2luZ2xlX3R4X2Nvc3QoKTsKICAgICAgICAgICAgICAgIHR4CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgIGxldCByZWNlaXB0cyA9IHRyYW5zYWN0aW9ucwogICAgICAgICAgICAuaXRlcigpCiAgICAgICAgICAgIC5lbnVtZXJhdGUoKQogICAgICAgICAgICAubWFwKHwoaWR4LCB0eCl8IHsKICAgICAgICAgICAgICAgIFJlY2VpcHQgewogICAgICAgICAgICAgICAgICAgIHR4X3R5cGU6IHR4LnR4X3R5cGUoKSwKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGN1bXVsYXRpdmVfZ2FzX3VzZWQ6IChpZHggYXMgdTY0ICsgMSkgKiBNSU5fVFJBTlNBQ1RJT05fR0FTLAogICAgICAgICAgICAgICAgICAgIC4uRGVmYXVsdDo6ZGVmYXVsdCgpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAuaW50b193aXRoX2Jsb29tKCkKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLmNvbGxlY3Q6OjxWZWM8Xz4+KCk7CgogICAgICAgIGxldCBpbml0aWFsX3NpZ25lcl9iYWxhbmNlID0gVTI1Njo6ZnJvbSgxMCkucG93KFUyNTY6OmZyb20oMTgpKTsKCiAgICAgICAgbGV0IGhlYWRlciA9IEhlYWRlciB7CiAgICAgICAgICAgIG51bWJlciwKICAgICAgICAgICAgcGFyZW50X2hhc2gsCiAgICAgICAgICAgIGdhc191c2VkOiB0cmFuc2FjdGlvbnMubGVuKCkgYXMgdTY0ICogTUlOX1RSQU5TQUNUSU9OX0dBUywKICAgICAgICAgICAgbWl4X2hhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICBnYXNfbGltaXQ6IEVUSEVSRVVNX0JMT0NLX0dBU19MSU1JVF8zME0sCiAgICAgICAgICAgIGJhc2VfZmVlX3Blcl9nYXM6IFNvbWUoSU5JVElBTF9CQVNFX0ZFRSksCiAgICAgICAgICAgIHRyYW5zYWN0aW9uc19yb290OiBjYWxjdWxhdGVfdHJhbnNhY3Rpb25fcm9vdCgmdHJhbnNhY3Rpb25zKSwKICAgICAgICAgICAgcmVjZWlwdHNfcm9vdDogY2FsY3VsYXRlX3JlY2VpcHRfcm9vdCgmcmVjZWlwdHMpLAogICAgICAgICAgICBiZW5lZmljaWFyeTogQWRkcmVzczo6cmFuZG9tKCksCiAgICAgICAgICAgIHN0YXRlX3Jvb3Q6IHN0YXRlX3Jvb3RfdW5oYXNoZWQoWygKICAgICAgICAgICAgICAgIHNlbGYuc2lnbmVyLAogICAgICAgICAgICAgICAgQWNjb3VudCB7CiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogaW5pdGlhbF9zaWduZXJfYmFsYW5jZSAtIHNpZ25lcl9iYWxhbmNlX2RlY3JlYXNlLAogICAgICAgICAgICAgICAgICAgIG5vbmNlOiBudW1fdHhzLAogICAgICAgICAgICAgICAgICAgIC4uRGVmYXVsdDo6ZGVmYXVsdCgpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAuaW50b190cmllX2FjY291bnQoRU1QVFlfUk9PVF9IQVNIKSwKICAgICAgICAgICAgKV0pLAogICAgICAgICAgICAvLyB1c2UgdGhlIG51bWJlciBhcyB0aGUgdGltZXN0YW1wIHNvIGl0IGlzIG1vbm90b25pY2FsbHkgaW5jcmVhc2luZwogICAgICAgICAgICB0aW1lc3RhbXA6IG51bWJlciArCiAgICAgICAgICAgICAgICBFdGhlcmV1bUhhcmRmb3JrOjpDYW5jdW4uYWN0aXZhdGlvbl90aW1lc3RhbXAoc2VsZi5jaGFpbl9zcGVjLmNoYWluKS51bndyYXAoKSwKICAgICAgICAgICAgd2l0aGRyYXdhbHNfcm9vdDogU29tZShjYWxjdWxhdGVfd2l0aGRyYXdhbHNfcm9vdCgmW10pKSwKICAgICAgICAgICAgYmxvYl9nYXNfdXNlZDogU29tZSgwKSwKICAgICAgICAgICAgZXhjZXNzX2Jsb2JfZ2FzOiBTb21lKDApLAogICAgICAgICAgICBwYXJlbnRfYmVhY29uX2Jsb2NrX3Jvb3Q6IFNvbWUoQjI1Njo6cmFuZG9tKCkpLAogICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgIH07CgogICAgICAgIFNlYWxlZEJsb2NrOjpmcm9tX3NlYWxlZF9wYXJ0cygKICAgICAgICAgICAgU2VhbGVkSGVhZGVyOjpzZWFsX3Nsb3coaGVhZGVyKSwKICAgICAgICAgICAgQmxvY2tCb2R5IHsKICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uczogdHJhbnNhY3Rpb25zLmludG9faXRlcigpLm1hcCh8dHh8IHR4LmludG9faW5uZXIoKSkuY29sbGVjdCgpLAogICAgICAgICAgICAgICAgb21tZXJzOiBWZWM6Om5ldygpLAogICAgICAgICAgICAgICAgd2l0aGRyYXdhbHM6IFNvbWUodmVjIVtdLmludG8oKSksCiAgICAgICAgICAgIH0sCiAgICAgICAgKQogICAgfQoKICAgIC8vLyBDcmVhdGVzIGEgZm9yayBjaGFpbiB3aXRoIHRoZSBnaXZlbiBiYXNlIGJsb2NrLgogICAgcHViIGZuIGNyZWF0ZV9mb3JrKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBiYXNlX2Jsb2NrOiAmU2VhbGVkQmxvY2s8QmxvY2s+LAogICAgICAgIGxlbmd0aDogdTY0LAogICAgKSAtPiBWZWM8UmVjb3ZlcmVkQmxvY2s8QmxvY2s+PiB7CiAgICAgICAgbGV0IG11dCBmb3JrID0gVmVjOjp3aXRoX2NhcGFjaXR5KGxlbmd0aCBhcyB1c2l6ZSk7CiAgICAgICAgbGV0IG11dCBwYXJlbnQgPSBiYXNlX2Jsb2NrLmNsb25lKCk7CgogICAgICAgIGZvciBfIGluIDAuLmxlbmd0aCB7CiAgICAgICAgICAgIGxldCBibG9jayA9IHNlbGYuZ2VuZXJhdGVfcmFuZG9tX2Jsb2NrKHBhcmVudC5udW1iZXIgKyAxLCBwYXJlbnQuaGFzaCgpKTsKICAgICAgICAgICAgcGFyZW50ID0gYmxvY2suY2xvbmUoKTsKICAgICAgICAgICAgbGV0IHNlbmRlcnMgPSB2ZWMhW3NlbGYuc2lnbmVyOyBibG9jay5ib2R5KCkudHJhbnNhY3Rpb25zLmxlbigpXTsKICAgICAgICAgICAgbGV0IGJsb2NrID0gYmxvY2sud2l0aF9zZW5kZXJzKHNlbmRlcnMpOwogICAgICAgICAgICBmb3JrLnB1c2goYmxvY2spOwogICAgICAgIH0KCiAgICAgICAgZm9yawogICAgfQoKICAgIC8vLyBHZXRzIGFuIFtgRXhlY3V0ZWRCbG9ja2BdIHdpdGggW2BCbG9ja051bWJlcmBdLCByZWNlaXB0cyBhbmQgcGFyZW50IGhhc2guCiAgICBmbiBnZXRfZXhlY3V0ZWRfYmxvY2soCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIGJsb2NrX251bWJlcjogQmxvY2tOdW1iZXIsCiAgICAgICAgcmVjZWlwdHM6IFZlYzxWZWM8UmVjZWlwdD4+LAogICAgICAgIHBhcmVudF9oYXNoOiBCMjU2LAogICAgKSAtPiBFeGVjdXRlZEJsb2NrIHsKICAgICAgICBsZXQgYmxvY2sgPSBzZWxmLmdlbmVyYXRlX3JhbmRvbV9ibG9jayhibG9ja19udW1iZXIsIHBhcmVudF9oYXNoKTsKICAgICAgICBsZXQgc2VuZGVycyA9IHZlYyFbc2VsZi5zaWduZXI7IGJsb2NrLmJvZHkoKS50cmFuc2FjdGlvbnMubGVuKCldOwogICAgICAgIGxldCB0cmllX2RhdGEgPSBDb21wdXRlZFRyaWVEYXRhOjpkZWZhdWx0KCk7CiAgICAgICAgRXhlY3V0ZWRCbG9jazo6bmV3KAogICAgICAgICAgICBBcmM6Om5ldyhSZWNvdmVyZWRCbG9jazo6bmV3X3NlYWxlZChibG9jaywgc2VuZGVycykpLAogICAgICAgICAgICBBcmM6Om5ldyhFeGVjdXRpb25PdXRjb21lOjpuZXcoCiAgICAgICAgICAgICAgICBCdW5kbGVTdGF0ZTo6ZGVmYXVsdCgpLAogICAgICAgICAgICAgICAgcmVjZWlwdHMsCiAgICAgICAgICAgICAgICBibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICB2ZWMhW1JlcXVlc3RzOjpkZWZhdWx0KCldLAogICAgICAgICAgICApKSwKICAgICAgICAgICAgdHJpZV9kYXRhLAogICAgICAgICkKICAgIH0KCiAgICAvLy8gR2VuZXJhdGVzIGFuIFtgRXhlY3V0ZWRCbG9ja2BdIHRoYXQgaW5jbHVkZXMgdGhlIGdpdmVuIHJlY2VpcHRzLgogICAgcHViIGZuIGdldF9leGVjdXRlZF9ibG9ja193aXRoX3JlY2VpcHRzKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICByZWNlaXB0czogVmVjPFZlYzxSZWNlaXB0Pj4sCiAgICAgICAgcGFyZW50X2hhc2g6IEIyNTYsCiAgICApIC0+IEV4ZWN1dGVkQmxvY2sgewogICAgICAgIGxldCBudW1iZXIgPSByYW5kOjpybmcoKS5yYW5kb206Ojx1NjQ+KCk7CiAgICAgICAgc2VsZi5nZXRfZXhlY3V0ZWRfYmxvY2sobnVtYmVyLCByZWNlaXB0cywgcGFyZW50X2hhc2gpCiAgICB9CgogICAgLy8vIEdlbmVyYXRlcyBhbiBbYEV4ZWN1dGVkQmxvY2tgXSB3aXRoIHRoZSBnaXZlbiBbYEJsb2NrTnVtYmVyYF0uCiAgICBwdWIgZm4gZ2V0X2V4ZWN1dGVkX2Jsb2NrX3dpdGhfbnVtYmVyKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBibG9ja19udW1iZXI6IEJsb2NrTnVtYmVyLAogICAgICAgIHBhcmVudF9oYXNoOiBCMjU2LAogICAgKSAtPiBFeGVjdXRlZEJsb2NrIHsKICAgICAgICBzZWxmLmdldF9leGVjdXRlZF9ibG9jayhibG9ja19udW1iZXIsIHZlYyFbdmVjIVtdXSwgcGFyZW50X2hhc2gpCiAgICB9CgogICAgLy8vIEdlbmVyYXRlcyBhIHJhbmdlIG9mIGV4ZWN1dGVkIGJsb2NrcyB3aXRoIGFzY2VuZGluZyBibG9jayBudW1iZXJzLgogICAgcHViIGZuIGdldF9leGVjdXRlZF9ibG9ja3MoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHJhbmdlOiBSYW5nZTx1NjQ+LAogICAgKSAtPiBpbXBsIEl0ZXJhdG9yPEl0ZW0gPSBFeGVjdXRlZEJsb2NrPiArICdfIHsKICAgICAgICBsZXQgbXV0IHBhcmVudF9oYXNoID0gQjI1Njo6ZGVmYXVsdCgpOwogICAgICAgIHJhbmdlLm1hcChtb3ZlIHxudW1iZXJ8IHsKICAgICAgICAgICAgbGV0IGN1cnJlbnRfcGFyZW50X2hhc2ggPSBwYXJlbnRfaGFzaDsKICAgICAgICAgICAgbGV0IGJsb2NrID0gc2VsZi5nZXRfZXhlY3V0ZWRfYmxvY2tfd2l0aF9udW1iZXIobnVtYmVyLCBjdXJyZW50X3BhcmVudF9oYXNoKTsKICAgICAgICAgICAgcGFyZW50X2hhc2ggPSBibG9jay5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCk7CiAgICAgICAgICAgIGJsb2NrCiAgICAgICAgfSkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgZXhlY3V0aW9uIG91dGNvbWUgZm9yIGEgYmxvY2sgY3JlYXRlZCB3aXRoIHRoaXMgYnVpbGRlci4KICAgIC8vLyBJbiBvcmRlciB0byBwcm9wZXJseSBpbmNsdWRlIHRoZSBidW5kbGUgc3RhdGUsIHRoZSBzaWduZXIgYmFsYW5jZSBpcwogICAgLy8vIHVwZGF0ZWQuCiAgICBwdWIgZm4gZ2V0X2V4ZWN1dGlvbl9vdXRjb21lKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBibG9jazogUmVjb3ZlcmVkQmxvY2s8cmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpCbG9jaz4sCiAgICApIC0+IEV4ZWN1dGlvbk91dGNvbWUgewogICAgICAgIGxldCBudW1fdHhzID0gYmxvY2suYm9keSgpLnRyYW5zYWN0aW9ucy5sZW4oKSBhcyB1NjQ7CiAgICAgICAgbGV0IHNpbmdsZV9jb3N0ID0gU2VsZjo6c2luZ2xlX3R4X2Nvc3QoKTsKCiAgICAgICAgbGV0IG11dCBmaW5hbF9iYWxhbmNlID0gc2VsZi5zaWduZXJfZXhlY3V0ZV9hY2NvdW50X2luZm8uYmFsYW5jZTsKICAgICAgICBmb3IgXyBpbiAwLi5udW1fdHhzIHsKICAgICAgICAgICAgZmluYWxfYmFsYW5jZSAtPSBzaW5nbGVfY29zdDsKICAgICAgICB9CgogICAgICAgIGxldCBmaW5hbF9ub25jZSA9IHNlbGYuc2lnbmVyX2V4ZWN1dGVfYWNjb3VudF9pbmZvLm5vbmNlICsgbnVtX3R4czsKCiAgICAgICAgbGV0IHJlY2VpcHRzID0gYmxvY2sKICAgICAgICAgICAgLmJvZHkoKQogICAgICAgICAgICAudHJhbnNhY3Rpb25zCiAgICAgICAgICAgIC5pdGVyKCkKICAgICAgICAgICAgLmVudW1lcmF0ZSgpCiAgICAgICAgICAgIC5tYXAofChpZHgsIHR4KXwgUmVjZWlwdCB7CiAgICAgICAgICAgICAgICB0eF90eXBlOiB0eC50eF90eXBlKCksCiAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgICAgICAgICAgY3VtdWxhdGl2ZV9nYXNfdXNlZDogKGlkeCBhcyB1NjQgKyAxKSAqIE1JTl9UUkFOU0FDVElPTl9HQVMsCiAgICAgICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgICAgICB9KQogICAgICAgICAgICAuY29sbGVjdDo6PFZlYzxfPj4oKTsKCiAgICAgICAgbGV0IGJ1bmRsZV9zdGF0ZSA9IEJ1bmRsZVN0YXRlOjpidWlsZGVyKGJsb2NrLm51bWJlci4uPWJsb2NrLm51bWJlcikKICAgICAgICAgICAgLnN0YXRlX3ByZXNlbnRfYWNjb3VudF9pbmZvKAogICAgICAgICAgICAgICAgc2VsZi5zaWduZXIsCiAgICAgICAgICAgICAgICBBY2NvdW50SW5mbyB7IG5vbmNlOiBmaW5hbF9ub25jZSwgYmFsYW5jZTogZmluYWxfYmFsYW5jZSwgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfSwKICAgICAgICAgICAgKQogICAgICAgICAgICAuYnVpbGQoKTsKCiAgICAgICAgc2VsZi5zaWduZXJfZXhlY3V0ZV9hY2NvdW50X2luZm8uYmFsYW5jZSA9IGZpbmFsX2JhbGFuY2U7CiAgICAgICAgc2VsZi5zaWduZXJfZXhlY3V0ZV9hY2NvdW50X2luZm8ubm9uY2UgPSBmaW5hbF9ub25jZTsKCiAgICAgICAgbGV0IGV4ZWN1dGlvbl9vdXRjb21lID0KICAgICAgICAgICAgRXhlY3V0aW9uT3V0Y29tZTo6bmV3KGJ1bmRsZV9zdGF0ZSwgdmVjIVt2ZWMhW11dLCBibG9jay5udW1iZXIsIFZlYzo6bmV3KCkpOwoKICAgICAgICBleGVjdXRpb25fb3V0Y29tZS53aXRoX3JlY2VpcHRzKHZlYyFbcmVjZWlwdHNdKQogICAgfQp9CgppbXBsIFRlc3RCbG9ja0J1aWxkZXIgewogICAgLy8vIENyZWF0ZXMgYSBgVGVzdEJsb2NrQnVpbGRlcmAgY29uZmlndXJlZCBmb3IgRXRoZXJldW0gcHJpbWl0aXZlcy4KICAgIHB1YiBmbiBldGgoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmOjpkZWZhdWx0KCkKICAgIH0KfQovLy8gQSB0ZXN0IGBDaGFpbkV2ZW50U3Vic2NyaXB0aW9uc2AKI1tkZXJpdmUoQ2xvbmUsIERlYnVnLCBEZWZhdWx0KV0KcHViIHN0cnVjdCBUZXN0Q2Fub25TdGF0ZVN1YnNjcmlwdGlvbnM8TjogTm9kZVByaW1pdGl2ZXMgPSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkV0aFByaW1pdGl2ZXM+CnsKICAgIGNhbm9uX25vdGlmX3R4OiBBcmM8TXV0ZXg8VmVjPFNlbmRlcjxDYW5vblN0YXRlTm90aWZpY2F0aW9uPE4+Pj4+PiwKfQoKaW1wbCBUZXN0Q2Fub25TdGF0ZVN1YnNjcmlwdGlvbnMgewogICAgLy8vIEFkZHMgbmV3IGJsb2NrIGNvbW1pdCB0byB0aGUgcXVldWUgdGhhdCBjYW4gYmUgY29uc3VtZWQgd2l0aAogICAgLy8vIFtgVGVzdENhbm9uU3RhdGVTdWJzY3JpcHRpb25zOjpzdWJzY3JpYmVfdG9fY2Fub25pY2FsX3N0YXRlYF0KICAgIHB1YiBmbiBhZGRfbmV4dF9jb21taXQoJnNlbGYsIG5ldzogQXJjPENoYWluPikgewogICAgICAgIGxldCBldmVudCA9IENhbm9uU3RhdGVOb3RpZmljYXRpb246OkNvbW1pdCB7IG5ldyB9OwogICAgICAgIHNlbGYuY2Fub25fbm90aWZfdHgubG9jaygpLmFzX211dCgpLnVud3JhcCgpLnJldGFpbih8dHh8IHR4LnNlbmQoZXZlbnQuY2xvbmUoKSkuaXNfb2soKSkKICAgIH0KCiAgICAvLy8gQWRkcyByZW9yZyB0byB0aGUgcXVldWUgdGhhdCBjYW4gYmUgY29uc3VtZWQgd2l0aAogICAgLy8vIFtgVGVzdENhbm9uU3RhdGVTdWJzY3JpcHRpb25zOjpzdWJzY3JpYmVfdG9fY2Fub25pY2FsX3N0YXRlYF0KICAgIHB1YiBmbiBhZGRfbmV4dF9yZW9yZygmc2VsZiwgb2xkOiBBcmM8Q2hhaW4+LCBuZXc6IEFyYzxDaGFpbj4pIHsKICAgICAgICBsZXQgZXZlbnQgPSBDYW5vblN0YXRlTm90aWZpY2F0aW9uOjpSZW9yZyB7IG9sZCwgbmV3IH07CiAgICAgICAgc2VsZi5jYW5vbl9ub3RpZl90eC5sb2NrKCkuYXNfbXV0KCkudW53cmFwKCkucmV0YWluKHx0eHwgdHguc2VuZChldmVudC5jbG9uZSgpKS5pc19vaygpKQogICAgfQp9CgppbXBsIE5vZGVQcmltaXRpdmVzUHJvdmlkZXIgZm9yIFRlc3RDYW5vblN0YXRlU3Vic2NyaXB0aW9ucyB7CiAgICB0eXBlIFByaW1pdGl2ZXMgPSBFdGhQcmltaXRpdmVzOwp9CgppbXBsIENhbm9uU3RhdGVTdWJzY3JpcHRpb25zIGZvciBUZXN0Q2Fub25TdGF0ZVN1YnNjcmlwdGlvbnMgewogICAgLy8vIFNldHMgdXAgYSBicm9hZGNhc3QgY2hhbm5lbCB3aXRoIGEgYnVmZmVyIHNpemUgb2YgMTAwLgogICAgZm4gc3Vic2NyaWJlX3RvX2Nhbm9uaWNhbF9zdGF0ZSgmc2VsZikgLT4gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbnMgewogICAgICAgIGxldCAoY2Fub25fbm90aWZfdHgsIGNhbm9uX25vdGlmX3J4KSA9IGJyb2FkY2FzdDo6Y2hhbm5lbCgxMDApOwogICAgICAgIHNlbGYuY2Fub25fbm90aWZfdHgubG9jaygpLmFzX211dCgpLnVud3JhcCgpLnB1c2goY2Fub25fbm90aWZfdHgpOwoKICAgICAgICBjYW5vbl9ub3RpZl9yeAogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9jb25maWcvc3JjL2xpYi5ycyI+Ci8vISBTdGFuZGFsb25lIGNyYXRlIGZvciBSZXRoIGNvbmZpZ3VyYXRpb24gdHlwZXMuCgojIVtkb2MoCiAgICBodG1sX2xvZ29fdXJsID0gImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9wYXJhZGlnbXh5ei9yZXRoL21haW4vYXNzZXRzL3JldGgtZG9jcy5wbmciLAogICAgaHRtbF9mYXZpY29uX3VybCA9ICJodHRwczovL2F2YXRhcnMwLmdpdGh1YnVzZXJjb250ZW50LmNvbS91Lzk3MzY5NDY2P3M9MjU2IiwKICAgIGlzc3VlX3RyYWNrZXJfYmFzZV91cmwgPSAiaHR0cHM6Ly9naXRodWIuY29tL3BhcmFkaWdteHl6L3JldGgvaXNzdWVzLyIKKV0KIyFbY2ZnX2F0dHIobm90KHRlc3QpLCB3YXJuKHVudXNlZF9jcmF0ZV9kZXBlbmRlbmNpZXMpKV0KIyFbY2ZnX2F0dHIoZG9jc3JzLCBmZWF0dXJlKGRvY19jZmcpKV0KCnB1YiBtb2QgY29uZmlnOwpwdWIgdXNlIGNvbmZpZzo6e0JvZGllc0NvbmZpZywgQ29uZmlnLCBQcnVuZUNvbmZpZ307CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9uZXQvZG93bmxvYWRlcnMvc3JjL2JvZGllcy9tb2QucnMiPgovLy8gQSBuYWl2ZSBjb25jdXJyZW50IGRvd25sb2FkZXIuCiNbZXhwZWN0KGNsaXBweTo6bW9kdWxlX2luY2VwdGlvbildCnB1YiBtb2QgYm9kaWVzOwoKLy8vIEEgYm9keSBkb3dubG9hZGVyIHRoYXQgZG9lcyBub3RoaW5nLiBVc2VmdWwgdG8gYnVpbGQgdW53aW5kLW9ubHkgcGlwZWxpbmVzLgpwdWIgbW9kIG5vb3A7CgovLy8gQSBkb3dubG9hZGVyIGltcGxlbWVudGF0aW9uIHRoYXQgc3Bhd25zIGEgZG93bmxvYWRlciB0byBhIHRhc2sKcHViIG1vZCB0YXNrOwoKbW9kIHF1ZXVlOwptb2QgcmVxdWVzdDsKCiNbY2ZnKGFueSh0ZXN0LCBmZWF0dXJlID0gInRlc3QtdXRpbHMiKSldCnB1YiBtb2QgdGVzdF91dGlsczsKPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL25ldC9kb3dubG9hZGVycy9zcmMvYm9kaWVzL25vb3AucnMiPgp1c2UgYWxsb3lfcHJpbWl0aXZlczo6QmxvY2tOdW1iZXI7CnVzZSBmdXR1cmVzOjpTdHJlYW07CnVzZSByZXRoX25ldHdvcmtfcDJwOjp7CiAgICBib2RpZXM6Ontkb3dubG9hZGVyOjpCb2R5RG93bmxvYWRlciwgcmVzcG9uc2U6OkJsb2NrUmVzcG9uc2V9LAogICAgZXJyb3I6OntEb3dubG9hZEVycm9yLCBEb3dubG9hZFJlc3VsdH0sCn07CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjpCbG9jazsKdXNlIHN0ZDo6e2ZtdDo6RGVidWcsIG9wczo6UmFuZ2VJbmNsdXNpdmV9OwoKLy8vIEEgW2BCb2R5RG93bmxvYWRlcmBdIGltcGxlbWVudGF0aW9uIHRoYXQgZG9lcyBub3RoaW5nLgojW2Rlcml2ZShEZWJ1ZywgRGVmYXVsdCldCiNbbm9uX2V4aGF1c3RpdmVdCnB1YiBzdHJ1Y3QgTm9vcEJvZGllc0Rvd25sb2FkZXI8Qj4gewogICAgX2Jsb2NrOiBzdGQ6Om1hcmtlcjo6UGhhbnRvbURhdGE8Qj4sCn0KCmltcGw8QjogQmxvY2sgKyAnc3RhdGljPiBCb2R5RG93bmxvYWRlciBmb3IgTm9vcEJvZGllc0Rvd25sb2FkZXI8Qj4gewogICAgdHlwZSBCbG9jayA9IEI7CgogICAgZm4gc2V0X2Rvd25sb2FkX3JhbmdlKCZtdXQgc2VsZiwgXzogUmFuZ2VJbmNsdXNpdmU8QmxvY2tOdW1iZXI+KSAtPiBEb3dubG9hZFJlc3VsdDwoKT4gewogICAgICAgIE9rKCgpKQogICAgfQp9CgppbXBsPEI6IEJsb2NrICsgJ3N0YXRpYz4gU3RyZWFtIGZvciBOb29wQm9kaWVzRG93bmxvYWRlcjxCPiB7CiAgICB0eXBlIEl0ZW0gPSBSZXN1bHQ8VmVjPEJsb2NrUmVzcG9uc2U8Qj4+LCBEb3dubG9hZEVycm9yPjsKCiAgICBmbiBwb2xsX25leHQoCiAgICAgICAgc2VsZjogc3RkOjpwaW46OlBpbjwmbXV0IFNlbGY+LAogICAgICAgIF86ICZtdXQgc3RkOjp0YXNrOjpDb250ZXh0PCdfPiwKICAgICkgLT4gc3RkOjp0YXNrOjpQb2xsPE9wdGlvbjxTZWxmOjpJdGVtPj4gewogICAgICAgIHBhbmljISgiTm9vcEJvZGllc0Rvd25sb2FkZXIgc2hvdWxkbid0IGJlIHBvbGxlZC4iKQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9uZXQvZG93bmxvYWRlcnMvc3JjL2JvZGllcy9xdWV1ZS5ycyI+CnVzZSBzdXBlcjo6cmVxdWVzdDo6Qm9kaWVzUmVxdWVzdEZ1dHVyZTsKdXNlIGNyYXRlOjptZXRyaWNzOjpCb2R5RG93bmxvYWRlck1ldHJpY3M7CnVzZSBhbGxveV9jb25zZW5zdXM6OkJsb2NrSGVhZGVyOwp1c2UgYWxsb3lfcHJpbWl0aXZlczo6QmxvY2tOdW1iZXI7CnVzZSBmdXR1cmVzOjp7c3RyZWFtOjpGdXR1cmVzVW5vcmRlcmVkLCBTdHJlYW19Owp1c2UgZnV0dXJlc191dGlsOjpTdHJlYW1FeHQ7CnVzZSByZXRoX2NvbnNlbnN1czo6Q29uc2Vuc3VzOwp1c2UgcmV0aF9uZXR3b3JrX3AycDo6ewogICAgYm9kaWVzOjp7Y2xpZW50OjpCb2RpZXNDbGllbnQsIHJlc3BvbnNlOjpCbG9ja1Jlc3BvbnNlfSwKICAgIGVycm9yOjpEb3dubG9hZFJlc3VsdCwKfTsKdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OntCbG9jaywgU2VhbGVkSGVhZGVyfTsKdXNlIHN0ZDo6ewogICAgcGluOjpQaW4sCiAgICBzeW5jOjpBcmMsCiAgICB0YXNrOjp7Q29udGV4dCwgUG9sbH0sCn07CgovLy8gVGhlIHdyYXBwZXIgYXJvdW5kIFtgRnV0dXJlc1Vub3JkZXJlZGBdIHRoYXQga2VlcHMgaW5mb3JtYXRpb24KLy8vIGFib3V0IHRoZSBibG9ja3MgY3VycmVudGx5IGJlaW5nIHJlcXVlc3RlZC4KI1tkZXJpdmUoRGVidWcpXQpwdWIoY3JhdGUpIHN0cnVjdCBCb2RpZXNSZXF1ZXN0UXVldWU8QjogQmxvY2ssIEM6IEJvZGllc0NsaWVudDxCb2R5ID0gQjo6Qm9keT4+IHsKICAgIC8vLyBJbm5lciBib2R5IHJlcXVlc3QgcXVldWUuCiAgICBpbm5lcjogRnV0dXJlc1Vub3JkZXJlZDxCb2RpZXNSZXF1ZXN0RnV0dXJlPEIsIEM+PiwKICAgIC8vLyBUaGUgZG93bmxvYWRlciBtZXRyaWNzLgogICAgbWV0cmljczogQm9keURvd25sb2FkZXJNZXRyaWNzLAogICAgLy8vIExhc3QgcmVxdWVzdGVkIGJsb2NrIG51bWJlci4KICAgIHB1YihjcmF0ZSkgbGFzdF9yZXF1ZXN0ZWRfYmxvY2tfbnVtYmVyOiBPcHRpb248QmxvY2tOdW1iZXI+LAp9CgppbXBsPEIsIEM+IEJvZGllc1JlcXVlc3RRdWV1ZTxCLCBDPgp3aGVyZQogICAgQjogQmxvY2ssCiAgICBDOiBCb2RpZXNDbGllbnQ8Qm9keSA9IEI6OkJvZHk+ICsgJ3N0YXRpYywKewogICAgLy8vIENyZWF0ZSBuZXcgaW5zdGFuY2Ugb2YgcmVxdWVzdCBxdWV1ZS4KICAgIHB1YihjcmF0ZSkgZm4gbmV3KG1ldHJpY3M6IEJvZHlEb3dubG9hZGVyTWV0cmljcykgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IG1ldHJpY3MsIGlubmVyOiBEZWZhdWx0OjpkZWZhdWx0KCksIGxhc3RfcmVxdWVzdGVkX2Jsb2NrX251bWJlcjogTm9uZSB9CiAgICB9CgogICAgLy8vIFJldHVybnMgYHRydWVgIGlmIHRoZSBxdWV1ZSBpcyBlbXB0eS4KICAgIHB1YihjcmF0ZSkgZm4gaXNfZW1wdHkoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIHNlbGYuaW5uZXIuaXNfZW1wdHkoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBudW1iZXIgb2YgcXVldWVkIHJlcXVlc3RzLgogICAgcHViKGNyYXRlKSBmbiBsZW4oJnNlbGYpIC0+IHVzaXplIHsKICAgICAgICBzZWxmLmlubmVyLmxlbigpCiAgICB9CgogICAgLy8vIENsZWFycyB0aGUgaW5uZXIgcXVldWUgYW5kIHJlbGF0ZWQgZGF0YS4KICAgIHB1YihjcmF0ZSkgZm4gY2xlYXIoJm11dCBzZWxmKSB7CiAgICAgICAgc2VsZi5pbm5lci5jbGVhcigpOwogICAgICAgIHNlbGYubGFzdF9yZXF1ZXN0ZWRfYmxvY2tfbnVtYmVyLnRha2UoKTsKICAgIH0KICAgIC8vLyBBZGQgbmV3IHJlcXVlc3QgdG8gdGhlIHF1ZXVlLgogICAgLy8vIEV4cGVjdHMgYSBzb3J0ZWQgbGlzdCBvZiBoZWFkZXJzLgogICAgcHViKGNyYXRlKSBmbiBwdXNoX25ld19yZXF1ZXN0KAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBjbGllbnQ6IEFyYzxDPiwKICAgICAgICBjb25zZW5zdXM6IEFyYzxkeW4gQ29uc2Vuc3VzPEI+PiwKICAgICAgICByZXF1ZXN0OiBWZWM8U2VhbGVkSGVhZGVyPEI6OkhlYWRlcj4+LAogICAgKSB7CiAgICAgICAgLy8gU2V0IGxhc3QgbWF4IHJlcXVlc3RlZCBibG9jayBudW1iZXIKICAgICAgICBzZWxmLmxhc3RfcmVxdWVzdGVkX2Jsb2NrX251bWJlciA9IHJlcXVlc3QKICAgICAgICAgICAgLmxhc3QoKQogICAgICAgICAgICAubWFwKHxsYXN0fCBtYXRjaCBzZWxmLmxhc3RfcmVxdWVzdGVkX2Jsb2NrX251bWJlciB7CiAgICAgICAgICAgICAgICBTb21lKG51bSkgPT4gbGFzdC5udW1iZXIoKS5tYXgobnVtKSwKICAgICAgICAgICAgICAgIE5vbmUgPT4gbGFzdC5udW1iZXIoKSwKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLm9yKHNlbGYubGFzdF9yZXF1ZXN0ZWRfYmxvY2tfbnVtYmVyKTsKCiAgICAgICAgLy8gQ3JlYXRlIHJlcXVlc3QgYW5kIHB1c2ggaW50byB0aGUgcXVldWUuCiAgICAgICAgc2VsZi5pbm5lci5wdXNoKAogICAgICAgICAgICBCb2RpZXNSZXF1ZXN0RnV0dXJlOjpuZXcoY2xpZW50LCBjb25zZW5zdXMsIHNlbGYubWV0cmljcy5jbG9uZSgpKS53aXRoX2hlYWRlcnMocmVxdWVzdCksCiAgICAgICAgKQogICAgfQp9CgppbXBsPEIsIEM+IFN0cmVhbSBmb3IgQm9kaWVzUmVxdWVzdFF1ZXVlPEIsIEM+CndoZXJlCiAgICBCOiBCbG9jayArICdzdGF0aWMsCiAgICBDOiBCb2RpZXNDbGllbnQ8Qm9keSA9IEI6OkJvZHk+ICsgJ3N0YXRpYywKewogICAgdHlwZSBJdGVtID0gRG93bmxvYWRSZXN1bHQ8VmVjPEJsb2NrUmVzcG9uc2U8Qj4+PjsKCiAgICBmbiBwb2xsX25leHQoc2VsZjogUGluPCZtdXQgU2VsZj4sIGN4OiAmbXV0IENvbnRleHQ8J18+KSAtPiBQb2xsPE9wdGlvbjxTZWxmOjpJdGVtPj4gewogICAgICAgIHNlbGYuZ2V0X211dCgpLmlubmVyLnBvbGxfbmV4dF91bnBpbihjeCkKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L2Rvd25sb2FkZXJzL3NyYy9ib2RpZXMvcmVxdWVzdC5ycyI+CnVzZSBjcmF0ZTo6bWV0cmljczo6e0JvZHlEb3dubG9hZGVyTWV0cmljcywgUmVzcG9uc2VNZXRyaWNzfTsKdXNlIGFsbG95X2NvbnNlbnN1czo6QmxvY2tIZWFkZXI7CnVzZSBhbGxveV9wcmltaXRpdmVzOjpCMjU2Owp1c2UgZnV0dXJlczo6e0Z1dHVyZSwgRnV0dXJlRXh0fTsKdXNlIHJldGhfY29uc2Vuc3VzOjpDb25zZW5zdXM7CnVzZSByZXRoX25ldHdvcmtfcDJwOjp7CiAgICBib2RpZXM6OntjbGllbnQ6OkJvZGllc0NsaWVudCwgcmVzcG9uc2U6OkJsb2NrUmVzcG9uc2V9LAogICAgZXJyb3I6OntEb3dubG9hZEVycm9yLCBEb3dubG9hZFJlc3VsdH0sCiAgICBwcmlvcml0eTo6UHJpb3JpdHksCn07CnVzZSByZXRoX25ldHdvcmtfcGVlcnM6OntQZWVySWQsIFdpdGhQZWVySWR9Owp1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6e0Jsb2NrLCBHb3RFeHBlY3RlZCwgSW5NZW1vcnlTaXplLCBTZWFsZWRCbG9jaywgU2VhbGVkSGVhZGVyfTsKdXNlIHN0ZDo6ewogICAgY29sbGVjdGlvbnM6OlZlY0RlcXVlLAogICAgcGluOjpQaW4sCiAgICBzeW5jOjpBcmMsCiAgICB0YXNrOjp7cmVhZHksIENvbnRleHQsIFBvbGx9LAp9OwoKLy8vIEJvZHkgcmVxdWVzdCBpbXBsZW1lbnRlZCBhcyBhIFtGdXR1cmVdLgovLy8KLy8vIFRoZSBmdXR1cmUgd2lsbCBwb2xsIHRoZSB1bmRlcmx5aW5nIHJlcXVlc3QgdW50aWwgZnVsZmlsbGVkLgovLy8gSWYgdGhlIHJlc3BvbnNlIGFycml2ZWQgd2l0aCBpbnN1ZmZpY2llbnQgbnVtYmVyIG9mIGJvZGllcywgdGhlIGZ1dHVyZQovLy8gd2lsbCBpc3N1ZSBhbm90aGVyIHJlcXVlc3QgdW50aWwgYWxsIGJvZGllcyBhcmUgY29sbGVjdGVkLgovLy8KLy8vIEl0IHRoZW4gcHJvY2VlZHMgdG8gdmVyaWZ5IHRoZSBkb3dubG9hZGVkIGJvZGllcy4gSW4gY2FzZSBvZiBhIHZhbGlkYXRpb24gZXJyb3IsCi8vLyB0aGUgZnV0dXJlIHdpbGwgc3RhcnQgb3Zlci4KLy8vCi8vLyBUaGUgZnV0dXJlIHdpbGwgZmlsdGVyIG91dCBhbnkgZW1wdHkgaGVhZGVycyAoc2VlIFtgYWxsb3lfY29uc2Vuc3VzOjpIZWFkZXI6OmlzX2VtcHR5YF0pIGZyb20KLy8vIHRoZSByZXF1ZXN0LiBJZiBbYEJvZGllc1JlcXVlc3RGdXR1cmVgXSB3YXMgaW5pdGlhbGl6ZWQgd2l0aCBhbGwgZW1wdHkgaGVhZGVycywgbm8gcmVxdWVzdCB3aWxsCi8vLyBiZSBkaXNwYXRjaGVkIGFuZCB0aGV5IHdpbGwgYmUgaW1tZWRpYXRlbHkgcmV0dXJuZWQgdXBvbiBwb2xsaW5nLgovLy8KLy8vIE5COiBUaGlzIGFzc3VtZXMgdGhhdCBwZWVycyByZXNwb25kIHdpdGggYm9kaWVzIGluIHRoZSBvcmRlciB0aGF0IHRoZXkgd2VyZSByZXF1ZXN0ZWQuCi8vLyBUaGlzIGlzIGEgcmVhc29uYWJsZSBhc3N1bXB0aW9uIHRvIG1ha2UgYXMgdGhhdCdzIFt3aGF0IEdldGgKLy8vIGRvZXNdKGh0dHBzOi8vZ2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9ibG9iL2Y1M2ZmMGZmNGE2OGZmYzU2MDA0YWIxZDVjYzI0NGJjYjY0ZDMyNzcvbGVzL3NlcnZlcl9yZXF1ZXN0cy5nbyNMMjQ1KS4KLy8vIEFsbCBlcnJvcnMgcmVnYXJkaW5nIHRoZSByZXNwb25zZSBjYXVzZSB0aGUgcGVlciB0byBnZXQgcGVuYWxpemVkLCBtZWFuaW5nIHRoYXQgYWR2ZXJzYXJpZXMKLy8vIHRoYXQgdHJ5IHRvIGdpdmUgdXMgYm9kaWVzIHRoYXQgZG8gbm90IG1hdGNoIHRoZSByZXF1ZXN0ZWQgb3JkZXIgYXJlIGdvaW5nIHRvIGJlIHBlbmFsaXplZAovLy8gYW5kIGV2ZW50dWFsbHkgZGlzY29ubmVjdGVkLgpwdWIoY3JhdGUpIHN0cnVjdCBCb2RpZXNSZXF1ZXN0RnV0dXJlPEI6IEJsb2NrLCBDOiBCb2RpZXNDbGllbnQ8Qm9keSA9IEI6OkJvZHk+PiB7CiAgICBjbGllbnQ6IEFyYzxDPiwKICAgIGNvbnNlbnN1czogQXJjPGR5biBDb25zZW5zdXM8Qj4+LAogICAgbWV0cmljczogQm9keURvd25sb2FkZXJNZXRyaWNzLAogICAgLy8vIE1ldHJpY3MgZm9yIGluZGl2aWR1YWwgcmVzcG9uc2VzLiBUaGlzIGNhbiBiZSB1c2VkIHRvIG9ic2VydmUgaG93IHRoZSBzaXplIChpbiBieXRlcykgb2YKICAgIC8vLyByZXNwb25zZXMgY2hhbmdlIHdoaWxlIGJvZGllcyBhcmUgYmVpbmcgZG93bmxvYWRlZC4KICAgIHJlc3BvbnNlX21ldHJpY3M6IFJlc3BvbnNlTWV0cmljcywKICAgIC8vIEhlYWRlcnMgdG8gZG93bmxvYWQuIFRoZSBjb2xsZWN0aW9uIGlzIHNocnVuayBhcyByZXNwb25zZXMgYXJlIGJ1ZmZlcmVkLgogICAgcGVuZGluZ19oZWFkZXJzOiBWZWNEZXF1ZTxTZWFsZWRIZWFkZXI8Qjo6SGVhZGVyPj4sCiAgICAvLy8gSW50ZXJuYWwgYnVmZmVyIGZvciBhbGwgYmxvY2tzCiAgICBidWZmZXI6IFZlYzxCbG9ja1Jlc3BvbnNlPEI+PiwKICAgIGZ1dDogT3B0aW9uPEM6Ok91dHB1dD4sCiAgICAvLy8gVHJhY2tzIGhvdyBtYW55IGJvZGllcyB3ZSByZXF1ZXN0ZWQgaW4gdGhlIGxhc3QgcmVxdWVzdC4KICAgIGxhc3RfcmVxdWVzdF9sZW46IE9wdGlvbjx1c2l6ZT4sCn0KCmltcGw8QiwgQz4gQm9kaWVzUmVxdWVzdEZ1dHVyZTxCLCBDPgp3aGVyZQogICAgQjogQmxvY2ssCiAgICBDOiBCb2RpZXNDbGllbnQ8Qm9keSA9IEI6OkJvZHk+ICsgJ3N0YXRpYywKewogICAgLy8vIFJldHVybnMgYW4gZW1wdHkgZnV0dXJlLiBVc2UgW2BCb2RpZXNSZXF1ZXN0RnV0dXJlOjp3aXRoX2hlYWRlcnNgXSB0byBzZXQgdGhlIHJlcXVlc3QuCiAgICBwdWIoY3JhdGUpIGZuIG5ldygKICAgICAgICBjbGllbnQ6IEFyYzxDPiwKICAgICAgICBjb25zZW5zdXM6IEFyYzxkeW4gQ29uc2Vuc3VzPEI+PiwKICAgICAgICBtZXRyaWNzOiBCb2R5RG93bmxvYWRlck1ldHJpY3MsCiAgICApIC0+IFNlbGYgewogICAgICAgIFNlbGYgewogICAgICAgICAgICBjbGllbnQsCiAgICAgICAgICAgIGNvbnNlbnN1cywKICAgICAgICAgICAgbWV0cmljcywKICAgICAgICAgICAgcmVzcG9uc2VfbWV0cmljczogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICBwZW5kaW5nX2hlYWRlcnM6IERlZmF1bHQ6OmRlZmF1bHQoKSwKICAgICAgICAgICAgYnVmZmVyOiBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIGxhc3RfcmVxdWVzdF9sZW46IE5vbmUsCiAgICAgICAgICAgIGZ1dDogTm9uZSwKICAgICAgICB9CiAgICB9CgogICAgcHViKGNyYXRlKSBmbiB3aXRoX2hlYWRlcnMobXV0IHNlbGYsIGhlYWRlcnM6IFZlYzxTZWFsZWRIZWFkZXI8Qjo6SGVhZGVyPj4pIC0+IFNlbGYgewogICAgICAgIHNlbGYuYnVmZmVyLnJlc2VydmVfZXhhY3QoaGVhZGVycy5sZW4oKSk7CiAgICAgICAgc2VsZi5wZW5kaW5nX2hlYWRlcnMgPSBWZWNEZXF1ZTo6ZnJvbShoZWFkZXJzKTsKICAgICAgICAvLyBTdWJtaXQgdGhlIHJlcXVlc3Qgb25seSBpZiB0aGVyZSBhcmUgYW55IGhlYWRlcnMgdG8gZG93bmxvYWQuCiAgICAgICAgLy8gT3RoZXJ3aXNlLCB0aGUgZnV0dXJlIHdpbGwgaW1tZWRpYXRlbHkgYmUgcmVzb2x2ZWQuCiAgICAgICAgaWYgbGV0IFNvbWUocmVxKSA9IHNlbGYubmV4dF9yZXF1ZXN0KCkgewogICAgICAgICAgICBzZWxmLnN1Ym1pdF9yZXF1ZXN0KHJlcSwgUHJpb3JpdHk6Ok5vcm1hbCk7CiAgICAgICAgfQogICAgICAgIHNlbGYKICAgIH0KCiAgICBmbiBvbl9lcnJvcigmbXV0IHNlbGYsIGVycm9yOiBEb3dubG9hZEVycm9yLCBwZWVyX2lkOiBPcHRpb248UGVlcklkPikgewogICAgICAgIHNlbGYubWV0cmljcy5pbmNyZW1lbnRfZXJyb3JzKCZlcnJvcik7CiAgICAgICAgdHJhY2luZzo6ZGVidWchKHRhcmdldDogImRvd25sb2FkZXJzOjpib2RpZXMiLCA/cGVlcl9pZCwgJWVycm9yLCAiRXJyb3IgcmVxdWVzdGluZyBib2RpZXMiKTsKICAgICAgICBpZiBsZXQgU29tZShwZWVyX2lkKSA9IHBlZXJfaWQgewogICAgICAgICAgICBzZWxmLmNsaWVudC5yZXBvcnRfYmFkX21lc3NhZ2UocGVlcl9pZCk7CiAgICAgICAgfQogICAgICAgIHNlbGYuc3VibWl0X3JlcXVlc3QoCiAgICAgICAgICAgIHNlbGYubmV4dF9yZXF1ZXN0KCkuZXhwZWN0KCJleGlzdGluZyBoYXNoZXMgdG8gcmVzdWJtaXQiKSwKICAgICAgICAgICAgUHJpb3JpdHk6OkhpZ2gsCiAgICAgICAgKTsKICAgIH0KCiAgICAvLy8gUmV0cmlldmUgaGVhZGVyIGhhc2hlcyBmb3IgdGhlIG5leHQgcmVxdWVzdC4KICAgIGZuIG5leHRfcmVxdWVzdCgmc2VsZikgLT4gT3B0aW9uPFZlYzxCMjU2Pj4gewogICAgICAgIGxldCBtdXQgaGFzaGVzID0KICAgICAgICAgICAgc2VsZi5wZW5kaW5nX2hlYWRlcnMuaXRlcigpLmZpbHRlcih8aHwgIWguaXNfZW1wdHkoKSkubWFwKHxofCBoLmhhc2goKSkucGVla2FibGUoKTsKICAgICAgICBoYXNoZXMucGVlaygpLmlzX3NvbWUoKS50aGVuKHx8IGhhc2hlcy5jb2xsZWN0KCkpCiAgICB9CgogICAgLy8vIFN1Ym1pdCB0aGUgcmVxdWVzdCB3aXRoIHRoZSBnaXZlbiBwcmlvcml0eS4KICAgIGZuIHN1Ym1pdF9yZXF1ZXN0KCZtdXQgc2VsZiwgcmVxOiBWZWM8QjI1Nj4sIHByaW9yaXR5OiBQcmlvcml0eSkgewogICAgICAgIHRyYWNpbmc6OnRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6Ym9kaWVzIiwgcmVxdWVzdF9sZW4gPSByZXEubGVuKCksICJSZXF1ZXN0aW5nIGJvZGllcyIpOwogICAgICAgIGxldCBjbGllbnQgPSBBcmM6OmNsb25lKCZzZWxmLmNsaWVudCk7CiAgICAgICAgc2VsZi5sYXN0X3JlcXVlc3RfbGVuID0gU29tZShyZXEubGVuKCkpOwogICAgICAgIHNlbGYuZnV0ID0gU29tZShjbGllbnQuZ2V0X2Jsb2NrX2JvZGllc193aXRoX3ByaW9yaXR5KHJlcSwgcHJpb3JpdHkpKTsKICAgIH0KCiAgICAvLy8gUHJvY2VzcyBibG9jayByZXNwb25zZS4KICAgIC8vLyBSZXR1cm5zIGFuIGVycm9yIGlmIHRoZSByZXNwb25zZSBpcyBpbnZhbGlkLgogICAgZm4gb25fYmxvY2tfcmVzcG9uc2UoJm11dCBzZWxmLCByZXNwb25zZTogV2l0aFBlZXJJZDxWZWM8Qjo6Qm9keT4+KSAtPiBEb3dubG9hZFJlc3VsdDwoKT4KICAgIHdoZXJlCiAgICAgICAgQjo6Qm9keTogSW5NZW1vcnlTaXplLAogICAgewogICAgICAgIGxldCAocGVlcl9pZCwgYm9kaWVzKSA9IHJlc3BvbnNlLnNwbGl0KCk7CiAgICAgICAgbGV0IHJlcXVlc3RfbGVuID0gc2VsZi5sYXN0X3JlcXVlc3RfbGVuLnVud3JhcF9vcl9kZWZhdWx0KCk7CiAgICAgICAgbGV0IHJlc3BvbnNlX2xlbiA9IGJvZGllcy5sZW4oKTsKCiAgICAgICAgdHJhY2luZzo6dHJhY2UhKHRhcmdldDogImRvd25sb2FkZXJzOjpib2RpZXMiLCByZXF1ZXN0X2xlbiwgcmVzcG9uc2VfbGVuLCA/cGVlcl9pZCwgIlJlY2VpdmVkIGJvZGllcyIpOwoKICAgICAgICAvLyBJbmNyZW1lbnQgdG90YWwgZG93bmxvYWRlZCBtZXRyaWMKICAgICAgICBzZWxmLm1ldHJpY3MudG90YWxfZG93bmxvYWRlZC5pbmNyZW1lbnQocmVzcG9uc2VfbGVuIGFzIHU2NCk7CgogICAgICAgIC8vIFRPRE86IE1hbGljaW91cyBwZWVycyBvZnRlbiByZXR1cm4gYSBzaW5nbGUgYmxvY2sgZXZlbiBpZiBpdCBkb2VzIG5vdCBleGNlZWQgdGhlIHNvZnQKICAgICAgICAvLyByZXNwb25zZSBsaW1pdCAoMk1CKS4gVGhpcyBjb3VsZCBiZSBwZW5hbGl6ZWQgYnkgY2hlY2tpbmcgaWYgdGhpcyBibG9jayBhbmQgdGhlCiAgICAgICAgLy8gbmV4dCBvbmUgZXhjZWVkIHRoZSBzb2Z0IHJlc3BvbnNlIGxpbWl0LCBpZiBub3QgdGhlbiBwZWVyIGVpdGhlciBkb2VzIG5vdCBoYXZlIHRoZSBuZXh0CiAgICAgICAgLy8gYmxvY2sgb3IgZGVsaWJlcmF0ZWx5IHNlbnQgYSBzaW5nbGUgYmxvY2suCiAgICAgICAgaWYgYm9kaWVzLmlzX2VtcHR5KCkgewogICAgICAgICAgICByZXR1cm4gRXJyKERvd25sb2FkRXJyb3I6OkVtcHR5UmVzcG9uc2UpCiAgICAgICAgfQoKICAgICAgICBpZiByZXNwb25zZV9sZW4gPiByZXF1ZXN0X2xlbiB7CiAgICAgICAgICAgIHJldHVybiBFcnIoRG93bmxvYWRFcnJvcjo6VG9vTWFueUJvZGllcyhHb3RFeHBlY3RlZCB7CiAgICAgICAgICAgICAgICBnb3Q6IHJlc3BvbnNlX2xlbiwKICAgICAgICAgICAgICAgIGV4cGVjdGVkOiByZXF1ZXN0X2xlbiwKICAgICAgICAgICAgfSkpCiAgICAgICAgfQoKICAgICAgICAvLyBCdWZmZXIgYmxvY2sgcmVzcG9uc2VzCiAgICAgICAgc2VsZi50cnlfYnVmZmVyX2Jsb2Nrcyhib2RpZXMpPzsKCiAgICAgICAgLy8gU3VibWl0IG5leHQgcmVxdWVzdCBpZiBhbnkKICAgICAgICBpZiBsZXQgU29tZShyZXEpID0gc2VsZi5uZXh0X3JlcXVlc3QoKSB7CiAgICAgICAgICAgIHNlbGYuc3VibWl0X3JlcXVlc3QocmVxLCBQcmlvcml0eTo6SGlnaCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5mdXQgPSBOb25lOwogICAgICAgIH0KCiAgICAgICAgT2soKCkpCiAgICB9CgogICAgLy8vIEF0dGVtcHQgdG8gYnVmZmVyIGJvZHkgcmVzcG9uc2VzLiBSZXR1cm5zIGFuIGVycm9yIGlmIGJvZHkgcmVzcG9uc2UgZmFpbHMgdmFsaWRhdGlvbi4KICAgIC8vLyBFdmVyeSBib2R5IHByZWNlZGluZyB0aGUgZmFpbGVkIG9uZSB3aWxsIGJlIGJ1ZmZlcmVkLgogICAgLy8vCiAgICAvLy8gVGhpcyBtZXRob2QgcmVtb3ZlcyBoZWFkZXJzIGZyb20gdGhlIGludGVybmFsIGNvbGxlY3Rpb24uCiAgICAvLy8gSWYgdGhlIHJlc3BvbnNlIGZhaWxzIHZhbGlkYXRpb24sIHRoZW4gdGhlIGhlYWRlciB3aWxsIGJlIHB1dCBiYWNrLgogICAgZm4gdHJ5X2J1ZmZlcl9ibG9ja3MoJm11dCBzZWxmLCBib2RpZXM6IFZlYzxDOjpCb2R5PikgLT4gRG93bmxvYWRSZXN1bHQ8KCk+CiAgICB3aGVyZQogICAgICAgIEM6OkJvZHk6IEluTWVtb3J5U2l6ZSwKICAgIHsKICAgICAgICBsZXQgYm9kaWVzX2xlbiA9IGJvZGllcy5sZW4oKTsKICAgICAgICBsZXQgbXV0IGJvZGllcyA9IGJvZGllcy5pbnRvX2l0ZXIoKS5wZWVrYWJsZSgpOwoKICAgICAgICBsZXQgbXV0IHRvdGFsX3NpemUgPSAwOwogICAgICAgIHdoaWxlIGJvZGllcy5wZWVrKCkuaXNfc29tZSgpIHsKICAgICAgICAgICAgbGV0IG5leHRfaGVhZGVyID0gbWF0Y2ggc2VsZi5wZW5kaW5nX2hlYWRlcnMucG9wX2Zyb250KCkgewogICAgICAgICAgICAgICAgU29tZShoZWFkZXIpID0+IGhlYWRlciwKICAgICAgICAgICAgICAgIE5vbmUgPT4gcmV0dXJuIE9rKCgpKSwgLy8gbm8gbW9yZSBoZWFkZXJzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiBuZXh0X2hlYWRlci5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgIHNlbGYuYnVmZmVyLnB1c2goQmxvY2tSZXNwb25zZTo6RW1wdHkobmV4dF9oZWFkZXIpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxldCBuZXh0X2JvZHkgPSBib2RpZXMubmV4dCgpLnVud3JhcCgpOwoKICAgICAgICAgICAgICAgIC8vIGluY3JlbWVudCBmdWxsIGJsb2NrIGJvZHkgbWV0cmljCiAgICAgICAgICAgICAgICB0b3RhbF9zaXplICs9IG5leHRfYm9keS5zaXplKCk7CgogICAgICAgICAgICAgICAgbGV0IGJsb2NrID0gU2VhbGVkQmxvY2s6OmZyb21fc2VhbGVkX3BhcnRzKG5leHRfaGVhZGVyLCBuZXh0X2JvZHkpOwoKICAgICAgICAgICAgICAgIGlmIGxldCBFcnIoZXJyb3IpID0gc2VsZi5jb25zZW5zdXMudmFsaWRhdGVfYmxvY2tfcHJlX2V4ZWN1dGlvbigmYmxvY2spIHsKICAgICAgICAgICAgICAgICAgICAvLyBCb2R5IGlzIGludmFsaWQsIHB1dCB0aGUgaGVhZGVyIGJhY2sgYW5kIHJldHVybiBhbiBlcnJvcgogICAgICAgICAgICAgICAgICAgIGxldCBoYXNoID0gYmxvY2suaGFzaCgpOwogICAgICAgICAgICAgICAgICAgIGxldCBudW1iZXIgPSBibG9jay5udW1iZXIoKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnBlbmRpbmdfaGVhZGVycy5wdXNoX2Zyb250KGJsb2NrLmludG9fc2VhbGVkX2hlYWRlcigpKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRXJyKERvd25sb2FkRXJyb3I6OkJvZHlWYWxpZGF0aW9uIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGFzaCwKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogQm94OjpuZXcoZXJyb3IpLAogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2VsZi5idWZmZXIucHVzaChCbG9ja1Jlc3BvbnNlOjpGdWxsKGJsb2NrKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEluY3JlbWVudCBwZXItcmVzcG9uc2UgbWV0cmljCiAgICAgICAgc2VsZi5yZXNwb25zZV9tZXRyaWNzLnJlc3BvbnNlX3NpemVfYnl0ZXMuc2V0KHRvdGFsX3NpemUgYXMgZjY0KTsKICAgICAgICBzZWxmLnJlc3BvbnNlX21ldHJpY3MucmVzcG9uc2VfbGVuZ3RoLnNldChib2RpZXNfbGVuIGFzIGY2NCk7CgogICAgICAgIE9rKCgpKQogICAgfQp9CgppbXBsPEIsIEM+IEZ1dHVyZSBmb3IgQm9kaWVzUmVxdWVzdEZ1dHVyZTxCLCBDPgp3aGVyZQogICAgQjogQmxvY2sgKyAnc3RhdGljLAogICAgQzogQm9kaWVzQ2xpZW50PEJvZHkgPSBCOjpCb2R5PiArICdzdGF0aWMsCnsKICAgIHR5cGUgT3V0cHV0ID0gRG93bmxvYWRSZXN1bHQ8VmVjPEJsb2NrUmVzcG9uc2U8Qj4+PjsKCiAgICBmbiBwb2xsKHNlbGY6IFBpbjwmbXV0IFNlbGY+LCBjeDogJm11dCBDb250ZXh0PCdfPikgLT4gUG9sbDxTZWxmOjpPdXRwdXQ+IHsKICAgICAgICBsZXQgdGhpcyA9IHNlbGYuZ2V0X211dCgpOwoKICAgICAgICBsb29wIHsKICAgICAgICAgICAgaWYgdGhpcy5wZW5kaW5nX2hlYWRlcnMuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoT2soc3RkOjptZW06OnRha2UoJm11dCB0aGlzLmJ1ZmZlcikpKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGVyZSBpcyBhIHBlbmRpbmcgcmVxdWVzdHMuIEl0IG1pZ2h0IG5vdCBleGlzdCBpZiBhbGwKICAgICAgICAgICAgLy8gaGVhZGVycyBhcmUgZW1wdHkgYW5kIHRoZXJlIGlzIG5vdGhpbmcgdG8gZG93bmxvYWQuCiAgICAgICAgICAgIGlmIGxldCBTb21lKGZ1dCkgPSB0aGlzLmZ1dC5hc19tdXQoKSB7CiAgICAgICAgICAgICAgICBtYXRjaCByZWFkeSEoZnV0LnBvbGxfdW5waW4oY3gpKSB7CiAgICAgICAgICAgICAgICAgICAgT2socmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBlZXJfaWQgPSByZXNwb25zZS5wZWVyX2lkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxldCBFcnIoZXJyb3IpID0gdGhpcy5vbl9ibG9ja19yZXNwb25zZShyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbl9lcnJvcihlcnJvciwgU29tZShwZWVyX2lkKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGVycm9yLmlzX2NoYW5uZWxfY2xvc2VkKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KEVycihlcnJvci5pbnRvKCkpKQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uX2Vycm9yKGVycm9yLmludG8oKSwgTm9uZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCdWZmZXIgYW55IGVtcHR5IGhlYWRlcnMKICAgICAgICAgICAgd2hpbGUgdGhpcy5wZW5kaW5nX2hlYWRlcnMuZnJvbnQoKS5pc19zb21lX2FuZCh8aHwgaC5pc19lbXB0eSgpKSB7CiAgICAgICAgICAgICAgICBsZXQgaGVhZGVyID0gdGhpcy5wZW5kaW5nX2hlYWRlcnMucG9wX2Zyb250KCkudW53cmFwKCk7CiAgICAgICAgICAgICAgICB0aGlzLmJ1ZmZlci5wdXNoKEJsb2NrUmVzcG9uc2U6OkVtcHR5KGhlYWRlcikpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgojW2NmZyh0ZXN0KV0KbW9kIHRlc3RzIHsKICAgIHVzZSBzdXBlcjo6KjsKICAgIHVzZSBjcmF0ZTo6ewogICAgICAgIGJvZGllczo6dGVzdF91dGlsczo6emlwX2Jsb2NrcywKICAgICAgICB0ZXN0X3V0aWxzOjp7Z2VuZXJhdGVfYm9kaWVzLCBUZXN0Qm9kaWVzQ2xpZW50fSwKICAgIH07CiAgICB1c2UgcmV0aF9jb25zZW5zdXM6OnRlc3RfdXRpbHM6OlRlc3RDb25zZW5zdXM7CiAgICB1c2UgcmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpCbG9jazsKICAgIHVzZSByZXRoX3Rlc3RpbmdfdXRpbHM6OntnZW5lcmF0b3JzLCBnZW5lcmF0b3JzOjpyYW5kb21faGVhZGVyX3JhbmdlfTsKCiAgICAvLy8gQ2hlY2sgaWYgZnV0dXJlIHJldHVybnMgZW1wdHkgYm9kaWVzIHdpdGhvdXQgZGlzcGF0Y2hpbmcgYW55IHJlcXVlc3RzLgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHJlcXVlc3RfcmV0dXJuc19lbXB0eV9ib2RpZXMoKSB7CiAgICAgICAgbGV0IG11dCBybmcgPSBnZW5lcmF0b3JzOjpybmcoKTsKICAgICAgICBsZXQgaGVhZGVycyA9IHJhbmRvbV9oZWFkZXJfcmFuZ2UoJm11dCBybmcsIDAuLjIwLCBCMjU2OjpaRVJPKTsKCiAgICAgICAgbGV0IGNsaWVudCA9IEFyYzo6bmV3KFRlc3RCb2RpZXNDbGllbnQ6OmRlZmF1bHQoKSk7CiAgICAgICAgbGV0IGZ1dCA9IEJvZGllc1JlcXVlc3RGdXR1cmU6OjxCbG9jaywgXz46Om5ldygKICAgICAgICAgICAgY2xpZW50LmNsb25lKCksCiAgICAgICAgICAgIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIEJvZHlEb3dubG9hZGVyTWV0cmljczo6ZGVmYXVsdCgpLAogICAgICAgICkKICAgICAgICAud2l0aF9oZWFkZXJzKGhlYWRlcnMuY2xvbmUoKSk7CgogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGZ1dC5hd2FpdC51bndyYXAoKSwKICAgICAgICAgICAgaGVhZGVycy5pbnRvX2l0ZXIoKS5tYXAoQmxvY2tSZXNwb25zZTo6RW1wdHkpLmNvbGxlY3Q6OjxWZWM8Xz4+KCkKICAgICAgICApOwogICAgICAgIGFzc2VydF9lcSEoY2xpZW50LnRpbWVzX3JlcXVlc3RlZCgpLCAwKTsKICAgIH0KCiAgICAvLy8gQ2hlY2sgdGhhdCB0aGUgcmVxdWVzdCBmdXR1cmUKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiByZXF1ZXN0X3N1Ym1pdHNfdW50aWxfZnVsZmlsbGVkKCkgewogICAgICAgIC8vIEdlbmVyYXRlIHNvbWUgcmFuZG9tIGJsb2NrcwogICAgICAgIGxldCAoaGVhZGVycywgbXV0IGJvZGllcykgPSBnZW5lcmF0ZV9ib2RpZXMoMC4uPTE5KTsKCiAgICAgICAgbGV0IGJhdGNoX3NpemUgPSAyOwogICAgICAgIGxldCBjbGllbnQgPSBBcmM6Om5ldygKICAgICAgICAgICAgVGVzdEJvZGllc0NsaWVudDo6ZGVmYXVsdCgpLndpdGhfYm9kaWVzKGJvZGllcy5jbG9uZSgpKS53aXRoX21heF9iYXRjaF9zaXplKGJhdGNoX3NpemUpLAogICAgICAgICk7CiAgICAgICAgbGV0IGZ1dCA9IEJvZGllc1JlcXVlc3RGdXR1cmU6OjxCbG9jaywgXz46Om5ldygKICAgICAgICAgICAgY2xpZW50LmNsb25lKCksCiAgICAgICAgICAgIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIEJvZHlEb3dubG9hZGVyTWV0cmljczo6ZGVmYXVsdCgpLAogICAgICAgICkKICAgICAgICAud2l0aF9oZWFkZXJzKGhlYWRlcnMuY2xvbmUoKSk7CgogICAgICAgIGFzc2VydF9lcSEoZnV0LmF3YWl0LnVud3JhcCgpLCB6aXBfYmxvY2tzKGhlYWRlcnMuaXRlcigpLCAmbXV0IGJvZGllcykpOwogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGNsaWVudC50aW1lc19yZXF1ZXN0ZWQoKSwKICAgICAgICAgICAgLy8gZGl2X2NlaWxkCiAgICAgICAgICAgIChoZWFkZXJzLmludG9faXRlcigpLmZpbHRlcih8aHwgIWguaXNfZW1wdHkoKSkuY291bnQoKSBhcyB1NjQpLmRpdl9jZWlsKDIpCiAgICAgICAgKTsKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L2Rvd25sb2FkZXJzL3NyYy9ib2RpZXMvdGFzay5ycyI+CnVzZSBhbGxveV9wcmltaXRpdmVzOjpCbG9ja051bWJlcjsKdXNlIGZ1dHVyZXM6OlN0cmVhbTsKdXNlIGZ1dHVyZXNfdXRpbDo6e0Z1dHVyZUV4dCwgU3RyZWFtRXh0fTsKdXNlIHBpbl9wcm9qZWN0OjpwaW5fcHJvamVjdDsKdXNlIHJldGhfbmV0d29ya19wMnA6OnsKICAgIGJvZGllczo6ZG93bmxvYWRlcjo6e0JvZHlEb3dubG9hZGVyLCBCb2R5RG93bmxvYWRlclJlc3VsdH0sCiAgICBlcnJvcjo6RG93bmxvYWRSZXN1bHQsCn07CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjpCbG9jazsKdXNlIHJldGhfdGFza3M6OntUYXNrU3Bhd25lciwgVG9raW9UYXNrRXhlY3V0b3J9Owp1c2Ugc3RkOjp7CiAgICBmbXQ6OkRlYnVnLAogICAgZnV0dXJlOjpGdXR1cmUsCiAgICBvcHM6OlJhbmdlSW5jbHVzaXZlLAogICAgcGluOjpQaW4sCiAgICB0YXNrOjp7cmVhZHksIENvbnRleHQsIFBvbGx9LAp9Owp1c2UgdG9raW86OnN5bmM6OnttcHNjLCBtcHNjOjpVbmJvdW5kZWRTZW5kZXJ9Owp1c2UgdG9raW9fc3RyZWFtOjp3cmFwcGVyczo6e1JlY2VpdmVyU3RyZWFtLCBVbmJvdW5kZWRSZWNlaXZlclN0cmVhbX07CnVzZSB0b2tpb191dGlsOjpzeW5jOjpQb2xsU2VuZGVyOwoKLy8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiBbYEJvZHlEb3dubG9hZGVyUmVzdWx0YF1zIHRvIGhvbGQgaW4gdGhlIGJ1ZmZlci4KcHViIGNvbnN0IEJPRElFU19UQVNLX0JVRkZFUl9TSVpFOiB1c2l6ZSA9IDQ7CgovLy8gQSBbQm9keURvd25sb2FkZXJdIHRoYXQgZHJpdmVzIGEgc3Bhd25lZCBbQm9keURvd25sb2FkZXJdIG9uIGEgc3Bhd25lZCB0YXNrLgojW2Rlcml2ZShEZWJ1ZyldCiNbcGluX3Byb2plY3RdCnB1YiBzdHJ1Y3QgVGFza0Rvd25sb2FkZXI8QjogQmxvY2s+IHsKICAgICNbcGluXQogICAgZnJvbV9kb3dubG9hZGVyOiBSZWNlaXZlclN0cmVhbTxCb2R5RG93bmxvYWRlclJlc3VsdDxCPj4sCiAgICB0b19kb3dubG9hZGVyOiBVbmJvdW5kZWRTZW5kZXI8UmFuZ2VJbmNsdXNpdmU8QmxvY2tOdW1iZXI+PiwKfQoKaW1wbDxCOiBCbG9jayArICdzdGF0aWM+IFRhc2tEb3dubG9hZGVyPEI+IHsKICAgIC8vLyBTcGF3bnMgdGhlIGdpdmVuIGBkb3dubG9hZGVyYCB2aWEgW2B0b2tpbzo6dGFzazo6c3Bhd25gXSByZXR1cm5zIGEgW2BUYXNrRG93bmxvYWRlcmBdIHRoYXQncwogICAgLy8vIGNvbm5lY3RlZCB0byB0aGF0IHRhc2suCiAgICAvLy8KICAgIC8vLyAjIFBhbmljcwogICAgLy8vCiAgICAvLy8gVGhpcyBtZXRob2QgcGFuaWNzIGlmIGNhbGxlZCBvdXRzaWRlIG9mIGEgVG9raW8gcnVudGltZQogICAgLy8vCiAgICAvLy8gIyBFeGFtcGxlCiAgICAvLy8KICAgIC8vLyBgYGAKICAgIC8vLyB1c2UgcmV0aF9jb25zZW5zdXM6OkNvbnNlbnN1czsKICAgIC8vLyB1c2UgcmV0aF9kb3dubG9hZGVyczo6Ym9kaWVzOjp7Ym9kaWVzOjpCb2RpZXNEb3dubG9hZGVyQnVpbGRlciwgdGFzazo6VGFza0Rvd25sb2FkZXJ9OwogICAgLy8vIHVzZSByZXRoX25ldHdvcmtfcDJwOjpib2RpZXM6OmNsaWVudDo6Qm9kaWVzQ2xpZW50OwogICAgLy8vIHVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjp7QmxvY2ssIEluTWVtb3J5U2l6ZX07CiAgICAvLy8gdXNlIHJldGhfc3RvcmFnZV9hcGk6OkhlYWRlclByb3ZpZGVyOwogICAgLy8vIHVzZSBzdGQ6OntmbXQ6OkRlYnVnLCBzeW5jOjpBcmN9OwogICAgLy8vCiAgICAvLy8gZm4gdDwKICAgIC8vLyAgICAgQjogQmxvY2sgKyAnc3RhdGljLAogICAgLy8vICAgICBDOiBCb2RpZXNDbGllbnQ8Qm9keSA9IEI6OkJvZHk+ICsgJ3N0YXRpYywKICAgIC8vLyAgICAgUHJvdmlkZXI6IEhlYWRlclByb3ZpZGVyPEhlYWRlciA9IEI6OkhlYWRlcj4gKyBVbnBpbiArICdzdGF0aWMsCiAgICAvLy8gPigKICAgIC8vLyAgICAgY2xpZW50OiBBcmM8Qz4sCiAgICAvLy8gICAgIGNvbnNlbnN1czogQXJjPGR5biBDb25zZW5zdXM8Qj4+LAogICAgLy8vICAgICBwcm92aWRlcjogUHJvdmlkZXIsCiAgICAvLy8gKSB7CiAgICAvLy8gICAgIGxldCBkb3dubG9hZGVyID0KICAgIC8vLyAgICAgICAgIEJvZGllc0Rvd25sb2FkZXJCdWlsZGVyOjpkZWZhdWx0KCkuYnVpbGQ6OjxCLCBfLCBfPihjbGllbnQsIGNvbnNlbnN1cywgcHJvdmlkZXIpOwogICAgLy8vICAgICBsZXQgZG93bmxvYWRlciA9IFRhc2tEb3dubG9hZGVyOjpzcGF3bihkb3dubG9hZGVyKTsKICAgIC8vLyB9CiAgICAvLy8gYGBgCiAgICBwdWIgZm4gc3Bhd248VD4oZG93bmxvYWRlcjogVCkgLT4gU2VsZgogICAgd2hlcmUKICAgICAgICBUOiBCb2R5RG93bmxvYWRlcjxCbG9jayA9IEI+ICsgJ3N0YXRpYywKICAgIHsKICAgICAgICBTZWxmOjpzcGF3bl93aXRoKGRvd25sb2FkZXIsICZUb2tpb1Rhc2tFeGVjdXRvcjo6ZGVmYXVsdCgpKQogICAgfQoKICAgIC8vLyBTcGF3bnMgdGhlIGdpdmVuIGBkb3dubG9hZGVyYCB2aWEgdGhlIGdpdmVuIFtgVGFza1NwYXduZXJgXSByZXR1cm5zIGEgW2BUYXNrRG93bmxvYWRlcmBdCiAgICAvLy8gdGhhdCdzIGNvbm5lY3RlZCB0byB0aGF0IHRhc2suCiAgICBwdWIgZm4gc3Bhd25fd2l0aDxULCBTPihkb3dubG9hZGVyOiBULCBzcGF3bmVyOiAmUykgLT4gU2VsZgogICAgd2hlcmUKICAgICAgICBUOiBCb2R5RG93bmxvYWRlcjxCbG9jayA9IEI+ICsgJ3N0YXRpYywKICAgICAgICBTOiBUYXNrU3Bhd25lciwKICAgIHsKICAgICAgICBsZXQgKGJvZGllc190eCwgYm9kaWVzX3J4KSA9IG1wc2M6OmNoYW5uZWwoQk9ESUVTX1RBU0tfQlVGRkVSX1NJWkUpOwogICAgICAgIGxldCAodG9fZG93bmxvYWRlciwgdXBkYXRlc19yeCkgPSBtcHNjOjp1bmJvdW5kZWRfY2hhbm5lbCgpOwoKICAgICAgICBsZXQgZG93bmxvYWRlciA9IFNwYXduZWREb3dubG9hZGVyIHsKICAgICAgICAgICAgYm9kaWVzX3R4OiBQb2xsU2VuZGVyOjpuZXcoYm9kaWVzX3R4KSwKICAgICAgICAgICAgdXBkYXRlczogVW5ib3VuZGVkUmVjZWl2ZXJTdHJlYW06Om5ldyh1cGRhdGVzX3J4KSwKICAgICAgICAgICAgZG93bmxvYWRlciwKICAgICAgICB9OwoKICAgICAgICBzcGF3bmVyLnNwYXduKGRvd25sb2FkZXIuYm94ZWQoKSk7CgogICAgICAgIFNlbGYgeyBmcm9tX2Rvd25sb2FkZXI6IFJlY2VpdmVyU3RyZWFtOjpuZXcoYm9kaWVzX3J4KSwgdG9fZG93bmxvYWRlciB9CiAgICB9Cn0KCmltcGw8QjogQmxvY2sgKyAnc3RhdGljPiBCb2R5RG93bmxvYWRlciBmb3IgVGFza0Rvd25sb2FkZXI8Qj4gewogICAgdHlwZSBCbG9jayA9IEI7CgogICAgZm4gc2V0X2Rvd25sb2FkX3JhbmdlKCZtdXQgc2VsZiwgcmFuZ2U6IFJhbmdlSW5jbHVzaXZlPEJsb2NrTnVtYmVyPikgLT4gRG93bmxvYWRSZXN1bHQ8KCk+IHsKICAgICAgICBsZXQgXyA9IHNlbGYudG9fZG93bmxvYWRlci5zZW5kKHJhbmdlKTsKICAgICAgICBPaygoKSkKICAgIH0KfQoKaW1wbDxCOiBCbG9jayArICdzdGF0aWM+IFN0cmVhbSBmb3IgVGFza0Rvd25sb2FkZXI8Qj4gewogICAgdHlwZSBJdGVtID0gQm9keURvd25sb2FkZXJSZXN1bHQ8Qj47CgogICAgZm4gcG9sbF9uZXh0KHNlbGY6IFBpbjwmbXV0IFNlbGY+LCBjeDogJm11dCBDb250ZXh0PCdfPikgLT4gUG9sbDxPcHRpb248U2VsZjo6SXRlbT4+IHsKICAgICAgICBzZWxmLnByb2plY3QoKS5mcm9tX2Rvd25sb2FkZXIucG9sbF9uZXh0KGN4KQogICAgfQp9CgovLy8gQSBbYEJvZHlEb3dubG9hZGVyYF0gdGhhdCBydW5zIG9uIGl0cyBvd24gdGFzawpzdHJ1Y3QgU3Bhd25lZERvd25sb2FkZXI8VDogQm9keURvd25sb2FkZXI+IHsKICAgIHVwZGF0ZXM6IFVuYm91bmRlZFJlY2VpdmVyU3RyZWFtPFJhbmdlSW5jbHVzaXZlPEJsb2NrTnVtYmVyPj4sCiAgICBib2RpZXNfdHg6IFBvbGxTZW5kZXI8Qm9keURvd25sb2FkZXJSZXN1bHQ8VDo6QmxvY2s+PiwKICAgIGRvd25sb2FkZXI6IFQsCn0KCmltcGw8VDogQm9keURvd25sb2FkZXI+IEZ1dHVyZSBmb3IgU3Bhd25lZERvd25sb2FkZXI8VD4gewogICAgdHlwZSBPdXRwdXQgPSAoKTsKCiAgICBmbiBwb2xsKHNlbGY6IFBpbjwmbXV0IFNlbGY+LCBjeDogJm11dCBDb250ZXh0PCdfPikgLT4gUG9sbDxTZWxmOjpPdXRwdXQ+IHsKICAgICAgICBsZXQgdGhpcyA9IHNlbGYuZ2V0X211dCgpOwoKICAgICAgICBsb29wIHsKICAgICAgICAgICAgd2hpbGUgbGV0IFBvbGw6OlJlYWR5KHVwZGF0ZSkgPSB0aGlzLnVwZGF0ZXMucG9sbF9uZXh0X3VucGluKGN4KSB7CiAgICAgICAgICAgICAgICBpZiBsZXQgU29tZShyYW5nZSkgPSB1cGRhdGUgewogICAgICAgICAgICAgICAgICAgIGlmIGxldCBFcnIoZXJyKSA9IHRoaXMuZG93bmxvYWRlci5zZXRfZG93bmxvYWRfcmFuZ2UocmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2luZzo6ZXJyb3IhKHRhcmdldDogImRvd25sb2FkZXJzOjpib2RpZXMiLCAlZXJyLCAiRmFpbGVkIHRvIHNldCBib2RpZXMgZG93bmxvYWQgcmFuZ2UiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENsb25lIHRoZSBzZW5kZXIgZW5zdXJlIGl0cyBhdmFpbGFiaWxpdHkuIFNlZSBbUG9sbFNlbmRlcjo6Y2xvbmVdLgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IGJvZGllc190eCA9IHRoaXMuYm9kaWVzX3R4LmNsb25lKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZm9yd2FyZF9lcnJvcl9yZXN1bHQgPSByZWFkeSEoYm9kaWVzX3R4LnBvbGxfcmVzZXJ2ZShjeCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYW5kX3RoZW4ofF98IGJvZGllc190eC5zZW5kX2l0ZW0oRXJyKGVycikpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZm9yd2FyZF9lcnJvcl9yZXN1bHQuaXNfZXJyKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hhbm5lbCBjbG9zZWQsIHRoaXMgbWVhbnMgW1Rhc2tEb3dubG9hZGVyXSB3YXMgZHJvcHBlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNvIHdlIGNhbiBhbHNvIGV4aXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBQb2xsOjpSZWFkeSgoKSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gY2hhbm5lbCBjbG9zZWQsIHRoaXMgbWVhbnMgW1Rhc2tEb3dubG9hZGVyXSB3YXMgZHJvcHBlZCwgc28gd2UgY2FuIGFsc28KICAgICAgICAgICAgICAgICAgICAvLyBleGl0CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KCgpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXRjaCByZWFkeSEodGhpcy5ib2RpZXNfdHgucG9sbF9yZXNlcnZlKGN4KSkgewogICAgICAgICAgICAgICAgT2soKCkpID0+IG1hdGNoIHJlYWR5ISh0aGlzLmRvd25sb2FkZXIucG9sbF9uZXh0X3VucGluKGN4KSkgewogICAgICAgICAgICAgICAgICAgIFNvbWUoYm9kaWVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRoaXMuYm9kaWVzX3R4LnNlbmRfaXRlbShib2RpZXMpLmlzX2VycigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNoYW5uZWwgY2xvc2VkLCB0aGlzIG1lYW5zIFtUYXNrRG93bmxvYWRlcl0gd2FzIGRyb3BwZWQsIHNvIHdlIGNhbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWxzbyBleGl0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgTm9uZSA9PiByZXR1cm4gUG9sbDo6UGVuZGluZywKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoXykgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIGNoYW5uZWwgY2xvc2VkLCB0aGlzIG1lYW5zIFtUYXNrRG93bmxvYWRlcl0gd2FzIGRyb3BwZWQsIHNvIHdlIGNhbiBhbHNvCiAgICAgICAgICAgICAgICAgICAgLy8gZXhpdAogICAgICAgICAgICAgICAgICAgIHJldHVybiBQb2xsOjpSZWFkeSgoKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6Oio7CiAgICB1c2UgY3JhdGU6OnsKICAgICAgICBib2RpZXM6OnsKICAgICAgICAgICAgYm9kaWVzOjpCb2RpZXNEb3dubG9hZGVyQnVpbGRlciwKICAgICAgICAgICAgdGVzdF91dGlsczo6e2luc2VydF9oZWFkZXJzLCB6aXBfYmxvY2tzfSwKICAgICAgICB9LAogICAgICAgIHRlc3RfdXRpbHM6OntnZW5lcmF0ZV9ib2RpZXMsIFRlc3RCb2RpZXNDbGllbnR9LAogICAgfTsKICAgIHVzZSBhc3NlcnRfbWF0Y2hlczo6YXNzZXJ0X21hdGNoZXM7CiAgICB1c2UgcmV0aF9jb25zZW5zdXM6OnRlc3RfdXRpbHM6OlRlc3RDb25zZW5zdXM7CiAgICB1c2UgcmV0aF9uZXR3b3JrX3AycDo6ZXJyb3I6OkRvd25sb2FkRXJyb3I7CiAgICB1c2UgcmV0aF9wcm92aWRlcjo6dGVzdF91dGlsczo6Y3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeTsKICAgIHVzZSBzdGQ6OnN5bmM6OkFyYzsKCiAgICAjW3Rva2lvOjp0ZXN0KGZsYXZvciA9ICJtdWx0aV90aHJlYWQiKV0KICAgIGFzeW5jIGZuIGRvd25sb2FkX29uZV9ieV9vbmVfb25fdGFzaygpIHsKICAgICAgICByZXRoX3RyYWNpbmc6OmluaXRfdGVzdF90cmFjaW5nKCk7CgogICAgICAgIGxldCBmYWN0b3J5ID0gY3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeSgpOwogICAgICAgIGxldCAoaGVhZGVycywgbXV0IGJvZGllcykgPSBnZW5lcmF0ZV9ib2RpZXMoMC4uPTE5KTsKCiAgICAgICAgaW5zZXJ0X2hlYWRlcnMoJmZhY3RvcnksICZoZWFkZXJzKTsKCiAgICAgICAgbGV0IGNsaWVudCA9IEFyYzo6bmV3KAogICAgICAgICAgICBUZXN0Qm9kaWVzQ2xpZW50OjpkZWZhdWx0KCkud2l0aF9ib2RpZXMoYm9kaWVzLmNsb25lKCkpLndpdGhfc2hvdWxkX2RlbGF5KHRydWUpLAogICAgICAgICk7CiAgICAgICAgbGV0IGRvd25sb2FkZXIgPSBCb2RpZXNEb3dubG9hZGVyQnVpbGRlcjo6ZGVmYXVsdCgpCiAgICAgICAgICAgIC5idWlsZDo6PHJldGhfZXRoZXJldW1fcHJpbWl0aXZlczo6QmxvY2ssIF8sIF8+KAogICAgICAgICAgICAgICAgY2xpZW50LmNsb25lKCksCiAgICAgICAgICAgICAgICBBcmM6Om5ldyhUZXN0Q29uc2Vuc3VzOjpkZWZhdWx0KCkpLAogICAgICAgICAgICAgICAgZmFjdG9yeSwKICAgICAgICAgICAgKTsKICAgICAgICBsZXQgbXV0IGRvd25sb2FkZXIgPSBUYXNrRG93bmxvYWRlcjo6c3Bhd24oZG93bmxvYWRlcik7CgogICAgICAgIGRvd25sb2FkZXIuc2V0X2Rvd25sb2FkX3JhbmdlKDAuLj0xOSkuZXhwZWN0KCJmYWlsZWQgdG8gc2V0IGRvd25sb2FkIHJhbmdlIik7CgogICAgICAgIGFzc2VydF9tYXRjaGVzISgKICAgICAgICAgICAgZG93bmxvYWRlci5uZXh0KCkuYXdhaXQsCiAgICAgICAgICAgIFNvbWUoT2socmVzKSkgPT4gYXNzZXJ0X2VxIShyZXMsIHppcF9ibG9ja3MoaGVhZGVycy5pdGVyKCksICZtdXQgYm9kaWVzKSkKICAgICAgICApOwogICAgICAgIGFzc2VydF9lcSEoY2xpZW50LnRpbWVzX3JlcXVlc3RlZCgpLCAxKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0KGZsYXZvciA9ICJtdWx0aV90aHJlYWQiKV0KICAgICNbZXhwZWN0KGNsaXBweTo6cmV2ZXJzZWRfZW1wdHlfcmFuZ2VzKV0KICAgIGFzeW5jIGZuIHNldF9kb3dubG9hZF9yYW5nZV9lcnJvcl9yZXR1cm5lZCgpIHsKICAgICAgICByZXRoX3RyYWNpbmc6OmluaXRfdGVzdF90cmFjaW5nKCk7CiAgICAgICAgbGV0IGZhY3RvcnkgPSBjcmVhdGVfdGVzdF9wcm92aWRlcl9mYWN0b3J5KCk7CgogICAgICAgIGxldCBkb3dubG9hZGVyID0gQm9kaWVzRG93bmxvYWRlckJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAuYnVpbGQ6OjxyZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrLCBfLCBfPigKICAgICAgICAgICAgICAgIEFyYzo6bmV3KFRlc3RCb2RpZXNDbGllbnQ6OmRlZmF1bHQoKSksCiAgICAgICAgICAgICAgICBBcmM6Om5ldyhUZXN0Q29uc2Vuc3VzOjpkZWZhdWx0KCkpLAogICAgICAgICAgICAgICAgZmFjdG9yeSwKICAgICAgICAgICAgKTsKICAgICAgICBsZXQgbXV0IGRvd25sb2FkZXIgPSBUYXNrRG93bmxvYWRlcjo6c3Bhd24oZG93bmxvYWRlcik7CgogICAgICAgIGRvd25sb2FkZXIuc2V0X2Rvd25sb2FkX3JhbmdlKDEuLj0wKS5leHBlY3QoImZhaWxlZCB0byBzZXQgZG93bmxvYWQgcmFuZ2UiKTsKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoZG93bmxvYWRlci5uZXh0KCkuYXdhaXQsIFNvbWUoRXJyKERvd25sb2FkRXJyb3I6OkludmFsaWRCb2R5UmFuZ2UgeyAuLiB9KSkpOwogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9uZXQvZG93bmxvYWRlcnMvc3JjL2JvZGllcy90ZXN0X3V0aWxzLnJzIj4KLy8hIFRlc3QgaGVscGVyIGltcGxzIGZvciBnZW5lcmF0aW5nIGJvZGllcwoKIyFbYWxsb3coZGVhZF9jb2RlKV0KCnVzZSBhbGxveV9jb25zZW5zdXM6OkJsb2NrSGVhZGVyOwp1c2UgYWxsb3lfcHJpbWl0aXZlczo6QjI1NjsKdXNlIHJldGhfZXRoZXJldW1fcHJpbWl0aXZlczo6QmxvY2tCb2R5Owp1c2UgcmV0aF9uZXR3b3JrX3AycDo6Ym9kaWVzOjpyZXNwb25zZTo6QmxvY2tSZXNwb25zZTsKdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OntCbG9jaywgU2VhbGVkQmxvY2ssIFNlYWxlZEhlYWRlcn07CnVzZSByZXRoX3Byb3ZpZGVyOjp7CiAgICB0ZXN0X3V0aWxzOjpNb2NrTm9kZVR5cGVzV2l0aERCLCBQcm92aWRlckZhY3RvcnksIFN0YXRpY0ZpbGVQcm92aWRlckZhY3RvcnksIFN0YXRpY0ZpbGVTZWdtZW50LAogICAgU3RhdGljRmlsZVdyaXRlciwKfTsKdXNlIHN0ZDo6Y29sbGVjdGlvbnM6Okhhc2hNYXA7CgpwdWIoY3JhdGUpIGZuIHppcF9ibG9ja3M8J2EsIEI6IEJsb2NrPigKICAgIGhlYWRlcnM6IGltcGwgSXRlcmF0b3I8SXRlbSA9ICYnYSBTZWFsZWRIZWFkZXI8Qjo6SGVhZGVyPj4sCiAgICBib2RpZXM6ICZtdXQgSGFzaE1hcDxCMjU2LCBCOjpCb2R5PiwKKSAtPiBWZWM8QmxvY2tSZXNwb25zZTxCPj4gewogICAgaGVhZGVycwogICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgIC5tYXAofGhlYWRlcnwgewogICAgICAgICAgICBsZXQgYm9keSA9IGJvZGllcy5yZW1vdmUoJmhlYWRlci5oYXNoKCkpLmV4cGVjdCgiYm9keSBleGlzdHMiKTsKICAgICAgICAgICAgaWYgaGVhZGVyLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgQmxvY2tSZXNwb25zZTo6RW1wdHkoaGVhZGVyLmNsb25lKCkpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBCbG9ja1Jlc3BvbnNlOjpGdWxsKFNlYWxlZEJsb2NrOjpmcm9tX3NlYWxlZF9wYXJ0cyhoZWFkZXIuY2xvbmUoKSwgYm9keSkpCiAgICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jb2xsZWN0KCkKfQoKcHViKGNyYXRlKSBmbiBjcmVhdGVfcmF3X2JvZGllcygKICAgIGhlYWRlcnM6IGltcGwgSW50b0l0ZXJhdG9yPEl0ZW0gPSBTZWFsZWRIZWFkZXI+LAogICAgYm9kaWVzOiAmbXV0IEhhc2hNYXA8QjI1NiwgQmxvY2tCb2R5PiwKKSAtPiBWZWM8cmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpCbG9jaz4gewogICAgaGVhZGVycwogICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgIC5tYXAofGhlYWRlcnwgewogICAgICAgICAgICBsZXQgYm9keSA9IGJvZGllcy5yZW1vdmUoJmhlYWRlci5oYXNoKCkpLmV4cGVjdCgiYm9keSBleGlzdHMiKTsKICAgICAgICAgICAgYm9keS5pbnRvX2Jsb2NrKGhlYWRlci51bnNlYWwoKSkKICAgICAgICB9KQogICAgICAgIC5jb2xsZWN0KCkKfQoKI1tpbmxpbmVdCnB1YihjcmF0ZSkgZm4gaW5zZXJ0X2hlYWRlcnMoCiAgICBmYWN0b3J5OiAmUHJvdmlkZXJGYWN0b3J5PE1vY2tOb2RlVHlwZXNXaXRoREI+LAogICAgaGVhZGVyczogJltTZWFsZWRIZWFkZXJdLAopIHsKICAgIGxldCBwcm92aWRlcl9ydyA9IGZhY3RvcnkucHJvdmlkZXJfcncoKS5leHBlY3QoImZhaWxlZCB0byBjcmVhdGUgcHJvdmlkZXIiKTsKICAgIGxldCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IHByb3ZpZGVyX3J3LnN0YXRpY19maWxlX3Byb3ZpZGVyKCk7CiAgICBsZXQgbXV0IHdyaXRlciA9IHN0YXRpY19maWxlX3Byb3ZpZGVyCiAgICAgICAgLmxhdGVzdF93cml0ZXIoU3RhdGljRmlsZVNlZ21lbnQ6OkhlYWRlcnMpCiAgICAgICAgLmV4cGVjdCgiZmFpbGVkIHRvIGNyZWF0ZSB3cml0ZXIiKTsKCiAgICBmb3IgaGVhZGVyIGluIGhlYWRlcnMgewogICAgICAgIHdyaXRlci5hcHBlbmRfaGVhZGVyKGhlYWRlci5oZWFkZXIoKSwgJmhlYWRlci5oYXNoKCkpLmV4cGVjdCgiZmFpbGVkIHRvIGFwcGVuZCBoZWFkZXIiKTsKICAgIH0KICAgIGRyb3Aod3JpdGVyKTsKICAgIHByb3ZpZGVyX3J3LmNvbW1pdCgpLmV4cGVjdCgiZmFpbGVkIHRvIGNvbW1pdCIpOwp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9uZXQvZG93bmxvYWRlcnMvc3JjL2hlYWRlcnMvbW9kLnJzIj4KLy8vIEEgTGluZWFyIGRvd25sb2FkZXIgaW1wbGVtZW50YXRpb24uCnB1YiBtb2QgcmV2ZXJzZV9oZWFkZXJzOwoKLy8vIEEgaGVhZGVyIGRvd25sb2FkZXIgdGhhdCBkb2VzIG5vdGhpbmcuIFVzZWZ1bCB0byBidWlsZCB1bndpbmQtb25seSBwaXBlbGluZXMuCnB1YiBtb2Qgbm9vcDsKCi8vLyBBIGRvd25sb2FkZXIgaW1wbGVtZW50YXRpb24gdGhhdCBzcGF3bnMgYSBkb3dubG9hZGVyIHRvIGEgdGFzawpwdWIgbW9kIHRhc2s7CgojW2NmZyhhbnkodGVzdCwgZmVhdHVyZSA9ICJ0ZXN0LXV0aWxzIikpXQpwdWIgbW9kIHRlc3RfdXRpbHM7CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9uZXQvZG93bmxvYWRlcnMvc3JjL2hlYWRlcnMvbm9vcC5ycyI+CnVzZSBhbGxveV9wcmltaXRpdmVzOjpTZWFsYWJsZTsKdXNlIGZ1dHVyZXM6OlN0cmVhbTsKdXNlIHJldGhfbmV0d29ya19wMnA6OmhlYWRlcnM6OnsKICAgIGRvd25sb2FkZXI6OntIZWFkZXJEb3dubG9hZGVyLCBTeW5jVGFyZ2V0fSwKICAgIGVycm9yOjpIZWFkZXJzRG93bmxvYWRlckVycm9yLAp9Owp1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6U2VhbGVkSGVhZGVyOwp1c2Ugc3RkOjpmbXQ6OkRlYnVnOwoKLy8vIEEgW2BIZWFkZXJEb3dubG9hZGVyYF0gaW1wbGVtZW50YXRpb24gdGhhdCBkb2VzIG5vdGhpbmcuCiNbZGVyaXZlKERlYnVnLCBEZWZhdWx0KV0KI1tub25fZXhoYXVzdGl2ZV0KcHViIHN0cnVjdCBOb29wSGVhZGVyRG93bmxvYWRlcjxIPihzdGQ6Om1hcmtlcjo6UGhhbnRvbURhdGE8SD4pOwoKaW1wbDxIOiBTZWFsYWJsZSArIERlYnVnICsgU2VuZCArIFN5bmMgKyBVbnBpbiArICdzdGF0aWM+IEhlYWRlckRvd25sb2FkZXIKICAgIGZvciBOb29wSGVhZGVyRG93bmxvYWRlcjxIPgp7CiAgICB0eXBlIEhlYWRlciA9IEg7CgogICAgZm4gdXBkYXRlX2xvY2FsX2hlYWQoJm11dCBzZWxmLCBfOiBTZWFsZWRIZWFkZXI8SD4pIHt9CgogICAgZm4gdXBkYXRlX3N5bmNfdGFyZ2V0KCZtdXQgc2VsZiwgXzogU3luY1RhcmdldCkge30KCiAgICBmbiBzZXRfYmF0Y2hfc2l6ZSgmbXV0IHNlbGYsIF86IHVzaXplKSB7fQp9CgppbXBsPEg6IFNlYWxhYmxlPiBTdHJlYW0gZm9yIE5vb3BIZWFkZXJEb3dubG9hZGVyPEg+IHsKICAgIHR5cGUgSXRlbSA9IFJlc3VsdDxWZWM8U2VhbGVkSGVhZGVyPEg+PiwgSGVhZGVyc0Rvd25sb2FkZXJFcnJvcjxIPj47CgogICAgZm4gcG9sbF9uZXh0KAogICAgICAgIHNlbGY6IHN0ZDo6cGluOjpQaW48Jm11dCBTZWxmPiwKICAgICAgICBfOiAmbXV0IHN0ZDo6dGFzazo6Q29udGV4dDwnXz4sCiAgICApIC0+IHN0ZDo6dGFzazo6UG9sbDxPcHRpb248U2VsZjo6SXRlbT4+IHsKICAgICAgICBwYW5pYyEoIk5vb3BIZWFkZXJEb3dubG9hZGVyIHNob3VsZG4ndCBiZSBwb2xsZWQuIikKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L2Rvd25sb2FkZXJzL3NyYy9oZWFkZXJzL3Rlc3RfdXRpbHMucnMiPgovLyEgVGVzdCBoZWxwZXIgaW1wbHMgZm9yIGdlbmVyYXRpbmcgYm9kaWVzCgojIVthbGxvdyhkZWFkX2NvZGUpXQoKdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OlNlYWxlZEhlYWRlcjsKCi8vLyBSZXR1cm5zIGEgbmV3IFtgU2VhbGVkSGVhZGVyYF0gdGhhdCdzIHRoZSBjaGlsZCBoZWFkZXIgb2YgdGhlIGdpdmVuIGBwYXJlbnRgLgpwdWIoY3JhdGUpIGZuIGNoaWxkX2hlYWRlcihwYXJlbnQ6ICZTZWFsZWRIZWFkZXIpIC0+IFNlYWxlZEhlYWRlciB7CiAgICBsZXQgbXV0IGNoaWxkID0gcGFyZW50LmFzX3JlZigpLmNsb25lKCk7CiAgICBjaGlsZC5udW1iZXIgKz0gMTsKICAgIGNoaWxkLnBhcmVudF9oYXNoID0gcGFyZW50Lmhhc2hfc2xvdygpOwogICAgU2VhbGVkSGVhZGVyOjpzZWFsX3Nsb3coY2hpbGQpCn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL25ldC9kb3dubG9hZGVycy9zcmMvZmlsZV9jb2RlYy5ycyI+Ci8vISBDb2RlYyBmb3IgcmVhZGluZyByYXcgYmxvY2sgYm9kaWVzIGZyb20gYSBmaWxlLgoKdXNlIGNyYXRlOjpmaWxlX2NsaWVudDo6RmlsZUNsaWVudEVycm9yOwp1c2UgYWxsb3lfcHJpbWl0aXZlczo6Ynl0ZXM6OntCdWYsIEJ5dGVzTXV0fTsKdXNlIGFsbG95X3JscDo6e0RlY29kYWJsZSwgRW5jb2RhYmxlfTsKdXNlIHRva2lvX3V0aWw6OmNvZGVjOjp7RGVjb2RlciwgRW5jb2Rlcn07CgovLy8gQ29kZWMgZm9yIHJlYWRpbmcgcmF3IGJsb2NrIGJvZGllcyBmcm9tIGEgZmlsZS4KLy8vCi8vLyBJZiB1c2luZyB3aXRoIFtgRnJhbWVkUmVhZGBdKHRva2lvX3V0aWw6OmNvZGVjOjpGcmFtZWRSZWFkKSwgdGhlIHVzZXIgc2hvdWxkIG1ha2Ugc3VyZSB0aGUKLy8vIGZyYW1lZCByZWFkZXIgaGFzIGNhcGFjaXR5IGZvciB0aGUgZW50aXJlIGJsb2NrIGZpbGUuIE90aGVyd2lzZSwgdGhlIGRlY29kZXIgd2lsbCByZXR1cm4KLy8vIFtgSW5wdXRUb29TaG9ydGBdKGFsbG95X3JscDo6RXJyb3I6OklucHV0VG9vU2hvcnQpLCBiZWNhdXNlIFJMUCBoZWFkZXJzIGNhbiBvbmx5IGJlCi8vLyBkZWNvZGVkIGlmIHRoZSBpbnRlcm5hbCBidWZmZXIgaXMgbGFyZ2UgZW5vdWdoIHRvIGNvbnRhaW4gdGhlIGVudGlyZSBibG9jayBib2R5LgovLy8KLy8vIFdpdGhvdXQgZW5zdXJpbmcgdGhlIGZyYW1lZCByZWFkZXIgaGFzIGNhcGFjaXR5IGZvciB0aGUgZW50aXJlIGZpbGUsIGEgYmxvY2sgYm9keSBpcyBsaWtlbHkgdG8KLy8vIGZhbGwgYWNyb3NzIHR3byByZWFkIGJ1ZmZlcnMsIHRoZSBkZWNvZGVyIHdpbGwgbm90IGJlIGFibGUgdG8gZGVjb2RlIHRoZSBoZWFkZXIsIHdoaWNoIHdpbGwKLy8vIGNhdXNlIGl0IHRvIGZhaWwuCi8vLwovLy8gSXQncyByZWNvbW1lbmRlZCB0byB1c2UgW2B3aXRoX2NhcGFjaXR5YF0odG9raW9fdXRpbDo6Y29kZWM6OkZyYW1lZFJlYWQ6OndpdGhfY2FwYWNpdHkpIHRvIHNldAovLy8gdGhlIGNhcGFjaXR5IG9mIHRoZSBmcmFtZWQgcmVhZGVyIHRvIHRoZSBzaXplIG9mIHRoZSBmaWxlLgpwdWIoY3JhdGUpIHN0cnVjdCBCbG9ja0ZpbGVDb2RlYzxCPihzdGQ6Om1hcmtlcjo6UGhhbnRvbURhdGE8Qj4pOwoKaW1wbDxCPiBEZWZhdWx0IGZvciBCbG9ja0ZpbGVDb2RlYzxCPiB7CiAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZihzdGQ6Om1hcmtlcjo6UGhhbnRvbURhdGEpCiAgICB9Cn0KCmltcGw8QjogRGVjb2RhYmxlPiBEZWNvZGVyIGZvciBCbG9ja0ZpbGVDb2RlYzxCPiB7CiAgICB0eXBlIEl0ZW0gPSBCOwogICAgdHlwZSBFcnJvciA9IEZpbGVDbGllbnRFcnJvcjsKCiAgICBmbiBkZWNvZGUoJm11dCBzZWxmLCBzcmM6ICZtdXQgQnl0ZXNNdXQpIC0+IFJlc3VsdDxPcHRpb248U2VsZjo6SXRlbT4sIFNlbGY6OkVycm9yPiB7CiAgICAgICAgaWYgc3JjLmlzX2VtcHR5KCkgewogICAgICAgICAgICByZXR1cm4gT2soTm9uZSkKICAgICAgICB9CgogICAgICAgIGxldCBidWZfc2xpY2UgPSAmbXV0IHNyYy5hc19yZWYoKTsKICAgICAgICBsZXQgYm9keSA9IEI6OmRlY29kZShidWZfc2xpY2UpLm1hcF9lcnIofGVycnwgRmlsZUNsaWVudEVycm9yOjpSbHAoZXJyLCBzcmMudG9fdmVjKCkpKT87CiAgICAgICAgc3JjLmFkdmFuY2Uoc3JjLmxlbigpIC0gYnVmX3NsaWNlLmxlbigpKTsKCiAgICAgICAgT2soU29tZShib2R5KSkKICAgIH0KfQoKaW1wbDxCOiBFbmNvZGFibGU+IEVuY29kZXI8Qj4gZm9yIEJsb2NrRmlsZUNvZGVjPEI+IHsKICAgIHR5cGUgRXJyb3IgPSBGaWxlQ2xpZW50RXJyb3I7CgogICAgZm4gZW5jb2RlKCZtdXQgc2VsZiwgaXRlbTogQiwgZHN0OiAmbXV0IEJ5dGVzTXV0KSAtPiBSZXN1bHQ8KCksIFNlbGY6OkVycm9yPiB7CiAgICAgICAgaXRlbS5lbmNvZGUoZHN0KTsKICAgICAgICBPaygoKSkKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L2Rvd25sb2FkZXJzL3NyYy9saWIucnMiPgovLyEgSW1wbGVtZW50cyB0aGUgZG93bmxvYWRlciBhbGdvcml0aG1zLgovLyEKLy8hICMjIEZlYXR1cmUgRmxhZ3MKLy8hCi8vISAtIGB0ZXN0LXV0aWxzYDogRXhwb3J0IHV0aWxpdGllcyBmb3IgdGVzdGluZwovLyEgLSBgZmlsZS1jbGllbnRgOiBFbmFibGVzIHRoZSBmaWxlLWJhc2VkIGNsaWVudHMgZm9yIHJlYWRpbmcgYmxvY2tzIGFuZCByZWNlaXB0cyBmcm9tIGZpbGVzLgoKIyFbZG9jKAogICAgaHRtbF9sb2dvX3VybCA9ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vcGFyYWRpZ214eXovcmV0aC9tYWluL2Fzc2V0cy9yZXRoLWRvY3MucG5nIiwKICAgIGh0bWxfZmF2aWNvbl91cmwgPSAiaHR0cHM6Ly9hdmF0YXJzMC5naXRodWJ1c2VyY29udGVudC5jb20vdS85NzM2OTQ2Nj9zPTI1NiIsCiAgICBpc3N1ZV90cmFja2VyX2Jhc2VfdXJsID0gImh0dHBzOi8vZ2l0aHViLmNvbS9wYXJhZGlnbXh5ei9yZXRoL2lzc3Vlcy8iCildCiMhW2NmZ19hdHRyKG5vdCh0ZXN0KSwgd2Fybih1bnVzZWRfY3JhdGVfZGVwZW5kZW5jaWVzKSldCiMhW2NmZ19hdHRyKGRvY3NycywgZmVhdHVyZShkb2NfY2ZnKSldCgojW2NmZyhhbnkodGVzdCwgZmVhdHVyZSA9ICJ0ZXN0LXV0aWxzIikpXQp1c2UgdGVtcGZpbGUgYXMgXzsKCi8vLyBUaGUgY29sbGVjdGlvbiBvZiBhbGdvcml0aG1zIGZvciBkb3dubG9hZGluZyBibG9jayBib2RpZXMuCnB1YiBtb2QgYm9kaWVzOwoKLy8vIFRoZSBjb2xsZWN0aW9uIG9mIGFsZ29yaXRobXMgZm9yIGRvd25sb2FkaW5nIGJsb2NrIGhlYWRlcnMuCnB1YiBtb2QgaGVhZGVyczsKCi8vLyBDb21tb24gZG93bmxvYWRlciBtZXRyaWNzLgpwdWIgbW9kIG1ldHJpY3M7CgovLy8gTW9kdWxlIG1hbmFnaW5nIGZpbGUtYmFzZWQgZGF0YSByZXRyaWV2YWwgYW5kIGJ1ZmZlcmluZy4KLy8vCi8vLyBDb250YWlucyBbYEZpbGVDbGllbnRgXShmaWxlX2NsaWVudDo6RmlsZUNsaWVudCkgdG8gcmVhZCBibG9jayBkYXRhIGZyb20gZmlsZXMsCi8vLyBlZmZpY2llbnRseSBidWZmZXJpbmcgaGVhZGVycyBhbmQgYm9kaWVzIGZvciByZXRyaWV2YWwuCiNbY2ZnKGFueSh0ZXN0LCBmZWF0dXJlID0gImZpbGUtY2xpZW50IikpXQpwdWIgbW9kIGZpbGVfY2xpZW50OwoKLy8vIE1vZHVsZSBtYW5hZ2luZyBmaWxlLWJhc2VkIGRhdGEgcmV0cmlldmFsIGFuZCBidWZmZXJpbmcgb2YgcmVjZWlwdHMuCi8vLwovLy8gQ29udGFpbnMgW2BSZWNlaXB0RmlsZUNsaWVudGBdKHJlY2VpcHRfZmlsZV9jbGllbnQ6OlJlY2VpcHRGaWxlQ2xpZW50KSB0byByZWFkIHJlY2VpcHQgZGF0YSBmcm9tCi8vLyBmaWxlcywgZWZmaWNpZW50bHkgYnVmZmVyaW5nIHJlY2VpcHRzIGZvciByZXRyaWV2YWwuCiNbY2ZnKGFueSh0ZXN0LCBmZWF0dXJlID0gImZpbGUtY2xpZW50IikpXQpwdWIgbW9kIHJlY2VpcHRfZmlsZV9jbGllbnQ7CgovLy8gTW9kdWxlIHdpdGggYSBjb2RlYyBmb3IgcmVhZGluZyBhbmQgZW5jb2RpbmcgYmxvY2sgYm9kaWVzIGluIGZpbGVzLgovLy8KLy8vIEVuYWJsZXMgZGVjb2RpbmcgYW5kIGVuY29kaW5nIGBCbG9ja2AgdHlwZXMgd2l0aGluIGZpbGUgY29udGV4dHMuCiNbY2ZnKGFueSh0ZXN0LCBmZWF0dXJlID0gImZpbGUtY2xpZW50IikpXQpwdWIgbW9kIGZpbGVfY29kZWM7CgojW2NmZyhhbnkodGVzdCwgZmVhdHVyZSA9ICJ0ZXN0LXV0aWxzIikpXQpwdWIgbW9kIHRlc3RfdXRpbHM7CgojW2NmZyhhbnkodGVzdCwgZmVhdHVyZSA9ICJmaWxlLWNsaWVudCIpKV0KcHViIHVzZSBmaWxlX2NsaWVudDo6e0RlY29kZWRGaWxlQ2h1bmssIEZpbGVDbGllbnRFcnJvcn07CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9uZXQvZG93bmxvYWRlcnMvc3JjL21ldHJpY3MucnMiPgp1c2UgcmV0aF9tZXRyaWNzOjp7CiAgICBtZXRyaWNzOjp7Q291bnRlciwgR2F1Z2V9LAogICAgTWV0cmljcywKfTsKdXNlIHJldGhfbmV0d29ya19wMnA6OmVycm9yOjpEb3dubG9hZEVycm9yOwoKLy8vIENvbW1vbiBib2R5IGRvd25sb2FkZXIgbWV0cmljcy4KLy8vCi8vLyBUaGVzZSBtZXRyaWNzIHdpbGwgYmUgaW5pdGlhbGl6ZWQgd2l0aCB0aGUgYGRvd25sb2FkZXJzLmJvZGllc2Agc2NvcGUuCi8vLyBgYGAKLy8vIHVzZSByZXRoX2Rvd25sb2FkZXJzOjptZXRyaWNzOjpCb2R5RG93bmxvYWRlck1ldHJpY3M7Ci8vLyB1c2UgcmV0aF9uZXR3b3JrX3AycDo6ZXJyb3I6OkRvd25sb2FkRXJyb3I7Ci8vLwovLy8gLy8gSW5pdGlhbGl6ZSBtZXRyaWNzLgovLy8gbGV0IG1ldHJpY3MgPSBCb2R5RG93bmxvYWRlck1ldHJpY3M6OmRlZmF1bHQoKTsKLy8vIC8vIEluY3JlbWVudCBgZG93bmxvYWRlcnMuYm9kaWVzLnRpbWVvdXRfZXJyb3JzYCBjb3VudGVyIGJ5IDEuCi8vLyBtZXRyaWNzLmluY3JlbWVudF9lcnJvcnMoJkRvd25sb2FkRXJyb3I6OlRpbWVvdXQpOwovLy8gYGBgCiNbZGVyaXZlKENsb25lLCBNZXRyaWNzKV0KI1ttZXRyaWNzKHNjb3BlID0gImRvd25sb2FkZXJzLmJvZGllcyIpXQpwdWIgc3RydWN0IEJvZHlEb3dubG9hZGVyTWV0cmljcyB7CiAgICAvLy8gVGhlIG51bWJlciBvZiBpdGVtcyB0aGF0IHdlcmUgc3VjY2Vzc2Z1bGx5IHNlbnQgdG8gdGhlIHBvbGxlciAoc3RhZ2UpCiAgICBwdWIgdG90YWxfZmx1c2hlZDogQ291bnRlciwKICAgIC8vLyBOdW1iZXIgb2YgaXRlbXMgdGhhdCB3ZXJlIHN1Y2Nlc3NmdWxseSBkb3dubG9hZGVkCiAgICBwdWIgdG90YWxfZG93bmxvYWRlZDogQ291bnRlciwKICAgIC8vLyBUaGUgbnVtYmVyIG9mIHJlcXVlc3RzIChjYW4gY29udGFpbiBtb3JlIHRoYW4gMSBpdGVtKSBjdXJyZW50bHkgaW4tZmxpZ2h0LgogICAgcHViIGluX2ZsaWdodF9yZXF1ZXN0czogR2F1Z2UsCiAgICAvLy8gVGhlIG51bWJlciBvZiByZXNwb25zZXMgKGNhbiBjb250YWluIG1vcmUgdGhhbiAxIGl0ZW0pIGluIHRoZSBpbnRlcm5hbCBidWZmZXIgb2YgdGhlCiAgICAvLy8gZG93bmxvYWRlci4KICAgIHB1YiBidWZmZXJlZF9yZXNwb25zZXM6IEdhdWdlLAogICAgLy8vIFRoZSBudW1iZXIgb2YgYmxvY2tzIHRoZSBpbnRlcm5hbCBidWZmZXIgb2YgdGhlCiAgICAvLy8gZG93bmxvYWRlci4KICAgIC8vLyBUaGVzZSBhcmUgYm9kaWVzIHRoYXQgaGF2ZSBiZWVuIHJlY2VpdmVkLCBidXQgY2Fubm90IGJlIGNvbW1pdHRlZCB5ZXQgYmVjYXVzZSB0aGV5J3JlCiAgICAvLy8gbm90IGNvbnRpZ3VvdXMKICAgIHB1YiBidWZmZXJlZF9ibG9ja3M6IEdhdWdlLAogICAgLy8vIFRvdGFsIGFtb3VudCBvZiBtZW1vcnkgdXNlZCBieSB0aGUgYnVmZmVyZWQgYmxvY2tzIGluIGJ5dGVzCiAgICBwdWIgYnVmZmVyZWRfYmxvY2tzX3NpemVfYnl0ZXM6IEdhdWdlLAogICAgLy8vIFRoZSBudW1iZXIgYmxvY2tzIHRoYXQgYXJlIGNvbnRpZ3VvdXMgYW5kIGFyZSBxdWV1ZWQgZm9yIGluc2VydGlvbiBpbnRvIHRoZSBkYi4KICAgIHB1YiBxdWV1ZWRfYmxvY2tzOiBHYXVnZSwKICAgIC8vLyBUaGUgbnVtYmVyIG9mIG91dC1vZi1vcmRlciByZXF1ZXN0cyBzZW50IGJ5IHRoZSBkb3dubG9hZGVyLgogICAgLy8vIFRoZSBjb25zdW1lciBvZiB0aGUgZG93bmxvYWQgc3RyZWFtIGlzIGFibGUgdG8gcmUtcmVxdWVzdCBkYXRhIChib2RpZXMpIGluIGNhc2UKICAgIC8vLyBpdCBlbmNvdW50ZXJlZCBhIHJlY292ZXJhYmxlIGVycm9yIChlLmcuIGR1cmluZyBpbnNlcnRpb24pLgogICAgLy8vIE91dC1vZi1vcmRlciByZXF1ZXN0IGhhcHBlbiB3aGVuIHRoZSBuZXcgZG93bmxvYWQgcmFuZ2Ugc3RhcnQgZm9yIGJvZGllcyBkb3dubG9hZGVyCiAgICAvLy8gaXMgbGVzcyB0aGFuIHRoZSBsYXN0IGJsb2NrIG51bWJlciByZXR1cm5lZCBmcm9tIHRoZSBzdHJlYW0uCiAgICBwdWIgb3V0X29mX29yZGVyX3JlcXVlc3RzOiBDb3VudGVyLAogICAgLy8vIE51bWJlciBvZiB0aW1lb3V0IGVycm9ycyB3aGlsZSByZXF1ZXN0aW5nIGl0ZW1zCiAgICBwdWIgdGltZW91dF9lcnJvcnM6IENvdW50ZXIsCiAgICAvLy8gTnVtYmVyIG9mIHZhbGlkYXRpb24gZXJyb3JzIHdoaWxlIHJlcXVlc3RpbmcgaXRlbXMKICAgIHB1YiB2YWxpZGF0aW9uX2Vycm9yczogQ291bnRlciwKICAgIC8vLyBOdW1iZXIgb2YgdW5leHBlY3RlZCBlcnJvcnMgd2hpbGUgcmVxdWVzdGluZyBpdGVtcwogICAgcHViIHVuZXhwZWN0ZWRfZXJyb3JzOiBDb3VudGVyLAp9CgppbXBsIEJvZHlEb3dubG9hZGVyTWV0cmljcyB7CiAgICAvLy8gSW5jcmVtZW50IGVycm9ycyBjb3VudGVyLgogICAgcHViIGZuIGluY3JlbWVudF9lcnJvcnMoJnNlbGYsIGVycm9yOiAmRG93bmxvYWRFcnJvcikgewogICAgICAgIG1hdGNoIGVycm9yIHsKICAgICAgICAgICAgRG93bmxvYWRFcnJvcjo6VGltZW91dCA9PiBzZWxmLnRpbWVvdXRfZXJyb3JzLmluY3JlbWVudCgxKSwKICAgICAgICAgICAgRG93bmxvYWRFcnJvcjo6Qm9keVZhbGlkYXRpb24geyAuLiB9ID0+IHNlbGYudmFsaWRhdGlvbl9lcnJvcnMuaW5jcmVtZW50KDEpLAogICAgICAgICAgICBfZXJyb3IgPT4gc2VsZi51bmV4cGVjdGVkX2Vycm9ycy5pbmNyZW1lbnQoMSksCiAgICAgICAgfQogICAgfQp9CgovLy8gTWV0cmljcyBmb3IgYW4gaW5kaXZpZHVhbCByZXNwb25zZSwgaS5lLiB0aGUgc2l6ZSBpbiBieXRlcywgYW5kIGxlbmd0aCAobnVtYmVyIG9mIGJvZGllcykgaW4gdGhlCi8vLyByZXNwb25zZS4KLy8vCi8vLyBUaGVzZSBtZXRyaWNzIHdpbGwgYmUgaW5pdGlhbGl6ZWQgd2l0aCB0aGUgYGRvd25sb2FkZXJzLmJvZGllcy5yZXNwb25zZWAgc2NvcGUuCiNbZGVyaXZlKENsb25lLCBNZXRyaWNzKV0KI1ttZXRyaWNzKHNjb3BlID0gImRvd25sb2FkZXJzLmJvZGllcy5yZXNwb25zZSIpXQpwdWIgc3RydWN0IFJlc3BvbnNlTWV0cmljcyB7CiAgICAvLy8gVGhlIHNpemUgKGluIGJ5dGVzKSBvZiBhbiBpbmRpdmlkdWFsIGJvZGllcyByZXNwb25zZSByZWNlaXZlZCBieSB0aGUgZG93bmxvYWRlci4KICAgIHB1YiByZXNwb25zZV9zaXplX2J5dGVzOiBHYXVnZSwKICAgIC8vLyBUaGUgbnVtYmVyIG9mIGJvZGllcyBpbiBhbiBpbmRpdmlkdWFsIGJvZGllcyByZXNwb25zZSByZWNlaXZlZCBieSB0aGUgZG93bmxvYWRlci4KICAgIHB1YiByZXNwb25zZV9sZW5ndGg6IEdhdWdlLAp9CgovLy8gQ29tbW9uIGhlYWRlciBkb3dubG9hZGVyIG1ldHJpY3MuCi8vLwovLy8gVGhlc2UgbWV0cmljcyB3aWxsIGJlIGluaXRpYWxpemVkIHdpdGggdGhlIGBkb3dubG9hZGVycy5oZWFkZXJzYCBzY29wZS4KLy8vIGBgYAovLy8gdXNlIHJldGhfZG93bmxvYWRlcnM6Om1ldHJpY3M6OkhlYWRlckRvd25sb2FkZXJNZXRyaWNzOwovLy8gdXNlIHJldGhfbmV0d29ya19wMnA6OmVycm9yOjpEb3dubG9hZEVycm9yOwovLy8KLy8vIC8vIEluaXRpYWxpemUgbWV0cmljcy4KLy8vIGxldCBtZXRyaWNzID0gSGVhZGVyRG93bmxvYWRlck1ldHJpY3M6OmRlZmF1bHQoKTsKLy8vIC8vIEluY3JlbWVudCBgZG93bmxvYWRlcnMuaGVhZGVycy50aW1lb3V0X2Vycm9yc2AgY291bnRlciBieSAxLgovLy8gbWV0cmljcy5pbmNyZW1lbnRfZXJyb3JzKCZEb3dubG9hZEVycm9yOjpUaW1lb3V0KTsKLy8vIGBgYAojW2Rlcml2ZShDbG9uZSwgTWV0cmljcyldCiNbbWV0cmljcyhzY29wZSA9ICJkb3dubG9hZGVycy5oZWFkZXJzIildCnB1YiBzdHJ1Y3QgSGVhZGVyRG93bmxvYWRlck1ldHJpY3MgewogICAgLy8vIFRoZSBudW1iZXIgb2YgaXRlbXMgdGhhdCB3ZXJlIHN1Y2Nlc3NmdWxseSBzZW50IHRvIHRoZSBwb2xsZXIgKHN0YWdlKQogICAgcHViIHRvdGFsX2ZsdXNoZWQ6IENvdW50ZXIsCiAgICAvLy8gTnVtYmVyIG9mIGl0ZW1zIHRoYXQgd2VyZSBzdWNjZXNzZnVsbHkgZG93bmxvYWRlZAogICAgcHViIHRvdGFsX2Rvd25sb2FkZWQ6IENvdW50ZXIsCiAgICAvLy8gVGhlIG51bWJlciBvZiByZXF1ZXN0cyAoY2FuIGNvbnRhaW4gbW9yZSB0aGFuIDEgaXRlbSkgY3VycmVudGx5IGluLWZsaWdodC4KICAgIHB1YiBpbl9mbGlnaHRfcmVxdWVzdHM6IEdhdWdlLAogICAgLy8vIFRoZSBudW1iZXIgb2YgcmVzcG9uc2VzIChjYW4gY29udGFpbiBtb3JlIHRoYW4gMSBpdGVtKSBpbiB0aGUgaW50ZXJuYWwgYnVmZmVyIG9mIHRoZQogICAgLy8vIGRvd25sb2FkZXIuCiAgICBwdWIgYnVmZmVyZWRfcmVzcG9uc2VzOiBHYXVnZSwKICAgIC8vLyBUaGUgbnVtYmVyIG9mIGJsb2NrcyB0aGUgaW50ZXJuYWwgYnVmZmVyIG9mIHRoZQogICAgLy8vIGRvd25sb2FkZXIuCiAgICAvLy8gVGhlc2UgYXJlIGJvZGllcyB0aGF0IGhhdmUgYmVlbiByZWNlaXZlZCwgYnV0IGNhbm5vdCBiZSBjb21taXR0ZWQgeWV0IGJlY2F1c2UgdGhleSdyZQogICAgLy8vIG5vdCBjb250aWd1b3VzCiAgICBwdWIgYnVmZmVyZWRfYmxvY2tzOiBHYXVnZSwKICAgIC8vLyBUb3RhbCBhbW91bnQgb2YgbWVtb3J5IHVzZWQgYnkgdGhlIGJ1ZmZlcmVkIGJsb2NrcyBpbiBieXRlcwogICAgcHViIGJ1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzOiBHYXVnZSwKICAgIC8vLyBUaGUgbnVtYmVyIGJsb2NrcyB0aGF0IGFyZSBjb250aWd1b3VzIGFuZCBhcmUgcXVldWVkIGZvciBpbnNlcnRpb24gaW50byB0aGUgZGIuCiAgICBwdWIgcXVldWVkX2Jsb2NrczogR2F1Z2UsCiAgICAvLy8gVGhlIG51bWJlciBvZiBvdXQtb2Ytb3JkZXIgcmVxdWVzdHMgc2VudCBieSB0aGUgZG93bmxvYWRlci4KICAgIC8vLyBUaGUgY29uc3VtZXIgb2YgdGhlIGRvd25sb2FkIHN0cmVhbSBpcyBhYmxlIHRvIHJlLXJlcXVlc3QgZGF0YSAoaGVhZGVycykgaW4gY2FzZQogICAgLy8vIGl0IGVuY291bnRlcmVkIGEgcmVjb3ZlcmFibGUgZXJyb3IgKGUuZy4gZHVyaW5nIGluc2VydGlvbikuCiAgICAvLy8gT3V0LW9mLW9yZGVyIHJlcXVlc3QgaGFwcGVuIHdoZW4gdGhlIGhlYWRlcnMgZG93bmxvYWRlciBgU3luY1RhcmdldDo6VGlwYAogICAgLy8vIGhhc2ggaXMgZGlmZmVyZW50IGZyb20gdGhlIHByZXZpb3VzIHN5bmMgdGFyZ2V0IGhhc2guCiAgICBwdWIgb3V0X29mX29yZGVyX3JlcXVlc3RzOiBDb3VudGVyLAogICAgLy8vIE51bWJlciBvZiB0aW1lb3V0IGVycm9ycyB3aGlsZSByZXF1ZXN0aW5nIGl0ZW1zCiAgICBwdWIgdGltZW91dF9lcnJvcnM6IENvdW50ZXIsCiAgICAvLy8gTnVtYmVyIG9mIHZhbGlkYXRpb24gZXJyb3JzIHdoaWxlIHJlcXVlc3RpbmcgaXRlbXMKICAgIHB1YiB2YWxpZGF0aW9uX2Vycm9yczogQ291bnRlciwKICAgIC8vLyBOdW1iZXIgb2YgdW5leHBlY3RlZCBlcnJvcnMgd2hpbGUgcmVxdWVzdGluZyBpdGVtcwogICAgcHViIHVuZXhwZWN0ZWRfZXJyb3JzOiBDb3VudGVyLAp9CgppbXBsIEhlYWRlckRvd25sb2FkZXJNZXRyaWNzIHsKICAgIC8vLyBJbmNyZW1lbnQgZXJyb3JzIGNvdW50ZXIuCiAgICBwdWIgZm4gaW5jcmVtZW50X2Vycm9ycygmc2VsZiwgZXJyb3I6ICZEb3dubG9hZEVycm9yKSB7CiAgICAgICAgbWF0Y2ggZXJyb3IgewogICAgICAgICAgICBEb3dubG9hZEVycm9yOjpUaW1lb3V0ID0+IHNlbGYudGltZW91dF9lcnJvcnMuaW5jcmVtZW50KDEpLAogICAgICAgICAgICBEb3dubG9hZEVycm9yOjpIZWFkZXJWYWxpZGF0aW9uIHsgLi4gfSA9PiBzZWxmLnZhbGlkYXRpb25fZXJyb3JzLmluY3JlbWVudCgxKSwKICAgICAgICAgICAgX2Vycm9yID0+IHNlbGYudW5leHBlY3RlZF9lcnJvcnMuaW5jcmVtZW50KDEpLAogICAgICAgIH0KICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L2Rvd25sb2FkZXJzL3NyYy9yZWNlaXB0X2ZpbGVfY2xpZW50LnJzIj4KdXNlIHN0ZDo6e2ZtdCwgaW99OwoKdXNlIGZ1dHVyZXM6OkZ1dHVyZTsKdXNlIHRva2lvOjppbzo6QXN5bmNSZWFkRXh0Owp1c2UgdG9raW9fc3RyZWFtOjpTdHJlYW1FeHQ7CnVzZSB0b2tpb191dGlsOjpjb2RlYzo6e0RlY29kZXIsIEZyYW1lZFJlYWR9Owp1c2UgdHJhY2luZzo6e3RyYWNlLCB3YXJufTsKCnVzZSBjcmF0ZTo6e0RlY29kZWRGaWxlQ2h1bmssIEZpbGVDbGllbnRFcnJvcn07CgovLy8gSGVscGVyIHRyYWl0IGltcGxlbWVudGVkIGZvciBbYERlY29kZXJgXSB0aGF0IGRlY29kZXMgdGhlIHJlY2VpcHQgdHlwZS4KcHViIHRyYWl0IFJlY2VpcHREZWNvZGVyOiBEZWNvZGVyPEl0ZW0gPSBPcHRpb248UmVjZWlwdFdpdGhCbG9ja051bWJlcjxTZWxmOjpSZWNlaXB0Pj4+IHsKICAgIC8vLyBUaGUgcmVjZWlwdCB0eXBlIGJlaW5nIGRlY29kZWQuCiAgICB0eXBlIFJlY2VpcHQ7Cn0KCmltcGw8VCwgUj4gUmVjZWlwdERlY29kZXIgZm9yIFQKd2hlcmUKICAgIFQ6IERlY29kZXI8SXRlbSA9IE9wdGlvbjxSZWNlaXB0V2l0aEJsb2NrTnVtYmVyPFI+Pj4sCnsKICAgIHR5cGUgUmVjZWlwdCA9IFI7Cn0KCi8vLyBGaWxlIGNsaWVudCBmb3IgcmVhZGluZyBSTFAgZW5jb2RlZCByZWNlaXB0cyBmcm9tIGZpbGUuIFJlY2VpcHRzIGluIGZpbGUgbXVzdCBiZSBpbiBzZXF1ZW50aWFsCi8vLyBvcmRlciB3LnIudC4gYmxvY2sgbnVtYmVyLgojW2Rlcml2ZShEZWJ1ZyldCnB1YiBzdHJ1Y3QgUmVjZWlwdEZpbGVDbGllbnQ8RDogUmVjZWlwdERlY29kZXI+IHsKICAgIC8vLyBUaGUgYnVmZmVyZWQgcmVjZWlwdHMsIHJlYWQgZnJvbSBmaWxlLCBhcyBuZXN0ZWQgbGlzdHMuIE9uZSBsaXN0IHBlciBibG9jayBudW1iZXIuCiAgICBwdWIgcmVjZWlwdHM6IFZlYzxWZWM8RDo6UmVjZWlwdD4+LAogICAgLy8vIEZpcnN0IChsb3dlc3QpIGJsb2NrIG51bWJlciByZWFkIGZyb20gZmlsZS4KICAgIHB1YiBmaXJzdF9ibG9jazogdTY0LAogICAgLy8vIFRvdGFsIG51bWJlciBvZiByZWNlaXB0cy4gQ291bnQgb2YgZWxlbWVudHMgaW4gcmVjZWlwdHMgZmxhdHRlbmVkLgogICAgcHViIHRvdGFsX3JlY2VpcHRzOiB1c2l6ZSwKfQoKLy8vIENvbnN0cnVjdHMgYSBmaWxlIGNsaWVudCBmcm9tIGEgcmVhZGVyIGFuZCBkZWNvZGVyLgpwdWIgdHJhaXQgRnJvbVJlY2VpcHRSZWFkZXIgewogICAgLy8vIEVycm9yIHJldHVybmVkIGJ5IGZpbGUgY2xpZW50IHR5cGUuCiAgICB0eXBlIEVycm9yOiBGcm9tPGlvOjpFcnJvcj47CgogICAgLy8vIFJldHVybnMgYSBmaWxlIGNsaWVudAogICAgZm4gZnJvbV9yZWNlaXB0X3JlYWRlcjxCPigKICAgICAgICByZWFkZXI6IEIsCiAgICAgICAgbnVtX2J5dGVzOiB1NjQsCiAgICAgICAgcHJldl9jaHVua19oaWdoZXN0X2Jsb2NrOiBPcHRpb248dTY0PiwKICAgICkgLT4gaW1wbCBGdXR1cmU8T3V0cHV0ID0gUmVzdWx0PERlY29kZWRGaWxlQ2h1bms8U2VsZj4sIFNlbGY6OkVycm9yPj4KICAgIHdoZXJlCiAgICAgICAgU2VsZjogU2l6ZWQsCiAgICAgICAgQjogQXN5bmNSZWFkRXh0ICsgVW5waW47Cn0KCmltcGw8RD4gRnJvbVJlY2VpcHRSZWFkZXIgZm9yIFJlY2VpcHRGaWxlQ2xpZW50PEQ+CndoZXJlCiAgICBEOiBSZWNlaXB0RGVjb2RlcjxFcnJvciA9IEZpbGVDbGllbnRFcnJvcj4gKyBmbXQ6OkRlYnVnICsgRGVmYXVsdCwKewogICAgdHlwZSBFcnJvciA9IEQ6OkVycm9yOwoKICAgIC8vLyBJbml0aWFsaXplIHRoZSBbYFJlY2VpcHRGaWxlQ2xpZW50YF0gZnJvbSBieXRlcyB0aGF0IGhhdmUgYmVlbiByZWFkIGZyb20gZmlsZS4gQ2F1dGlvbiEgSWYKICAgIC8vLyBmaXJzdCBibG9jayBoYXMgbm8gdHJhbnNhY3Rpb25zLCBpdCdzIGFzc3VtZWQgdG8gYmUgdGhlIGdlbmVzaXMgYmxvY2suCiAgICBmbiBmcm9tX3JlY2VpcHRfcmVhZGVyPEI+KAogICAgICAgIHJlYWRlcjogQiwKICAgICAgICBudW1fYnl0ZXM6IHU2NCwKICAgICAgICBwcmV2X2NodW5rX2hpZ2hlc3RfYmxvY2s6IE9wdGlvbjx1NjQ+LAogICAgKSAtPiBpbXBsIEZ1dHVyZTxPdXRwdXQgPSBSZXN1bHQ8RGVjb2RlZEZpbGVDaHVuazxTZWxmPiwgU2VsZjo6RXJyb3I+PgogICAgd2hlcmUKICAgICAgICBCOiBBc3luY1JlYWRFeHQgKyBVbnBpbiwKICAgIHsKICAgICAgICBsZXQgbXV0IHJlY2VpcHRzID0gVmVjOjpkZWZhdWx0KCk7CgogICAgICAgIC8vIHVzZSB3aXRoX2NhcGFjaXR5IHRvIG1ha2Ugc3VyZSB0aGUgaW50ZXJuYWwgYnVmZmVyIGNvbnRhaW5zIHRoZSBlbnRpcmUgY2h1bmsKICAgICAgICBsZXQgbXV0IHN0cmVhbSA9IEZyYW1lZFJlYWQ6OndpdGhfY2FwYWNpdHkocmVhZGVyLCBEOjpkZWZhdWx0KCksIG51bV9ieXRlcyBhcyB1c2l6ZSk7CgogICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6ZmlsZSIsCiAgICAgICAgICAgIHRhcmdldF9udW1fYnl0ZXM9bnVtX2J5dGVzLAogICAgICAgICAgICBjYXBhY2l0eT1zdHJlYW0ucmVhZF9idWZmZXIoKS5jYXBhY2l0eSgpLAogICAgICAgICAgICBjb2RlYz0/RDo6ZGVmYXVsdCgpLAogICAgICAgICAgICAiaW5pdCBkZWNvZGUgc3RyZWFtIgogICAgICAgICk7CgogICAgICAgIGxldCBtdXQgcmVtYWluaW5nX2J5dGVzID0gdmVjIVtdOwoKICAgICAgICBsZXQgbXV0IGxvZ19pbnRlcnZhbCA9IDA7CiAgICAgICAgbGV0IG11dCBsb2dfaW50ZXJ2YWxfc3RhcnRfYmxvY2sgPSAwOwoKICAgICAgICBsZXQgbXV0IGJsb2NrX251bWJlciA9IDA7CiAgICAgICAgbGV0IG11dCB0b3RhbF9yZWNlaXB0cyA9IDA7CiAgICAgICAgbGV0IG11dCByZWNlaXB0c19mb3JfYmxvY2sgPSB2ZWMhW107CiAgICAgICAgbGV0IG11dCBmaXJzdF9ibG9jayA9IE5vbmU7CgogICAgICAgIGFzeW5jIG1vdmUgewogICAgICAgICAgICB3aGlsZSBsZXQgU29tZShyZWNlaXB0X3JlcykgPSBzdHJlYW0ubmV4dCgpLmF3YWl0IHsKICAgICAgICAgICAgICAgIGxldCByZWNlaXB0ID0gbWF0Y2ggcmVjZWlwdF9yZXMgewogICAgICAgICAgICAgICAgICAgIE9rKHJlY2VpcHQpID0+IHJlY2VpcHQsCiAgICAgICAgICAgICAgICAgICAgRXJyKEZpbGVDbGllbnRFcnJvcjo6UmxwKGVyciwgYnl0ZXMpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6ZmlsZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAlZXJyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnl0ZXNfbGVuPWJ5dGVzLmxlbigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInBhcnRpYWwgcmVjZWlwdCByZXR1cm5lZCBmcm9tIGRlY29kaW5nIGNodW5rIgogICAgICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nX2J5dGVzID0gYnl0ZXM7CgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiByZXR1cm4gRXJyKGVyciksCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIG1hdGNoIHJlY2VpcHQgewogICAgICAgICAgICAgICAgICAgIFNvbWUoUmVjZWlwdFdpdGhCbG9ja051bWJlciB7IHJlY2VpcHQsIG51bWJlciB9KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGJsb2NrX251bWJlciA+IG51bWJlciB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6ZmlsZSIsIHByZXZpb3VzX2Jsb2NrX251bWJlciA9IGJsb2NrX251bWJlciwgInNraXBwaW5nIHJlY2VpcHQgZnJvbSBhIGxvd2VyIGJsb2NrOiB7bnVtYmVyfSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxfcmVjZWlwdHMgKz0gMTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGZpcnN0X2Jsb2NrLmlzX25vbmUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdF9ibG9jayA9IFNvbWUobnVtYmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrX251bWJlciA9IG51bWJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYmxvY2tfbnVtYmVyID09IG51bWJlciB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlaXB0c19mb3JfYmxvY2sucHVzaChyZWNlaXB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VpcHRzLnB1c2gocmVjZWlwdHNfZm9yX2Jsb2NrKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuZXh0IGJsb2NrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9ja19udW1iZXIgPSBudW1iZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlaXB0c19mb3JfYmxvY2sgPSB2ZWMhW3JlY2VpcHRdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIE5vbmUgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCBmaXJzdF9ibG9jayB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTb21lKG51bSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZXJlIHdhcyBhIGJsb2NrIG51bWJlciBiZWZvcmUgdGhpcywgcHVzaCByZWNlaXB0cyBmb3IgdGhhdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJsb2NrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjZWlwdHMucHVzaChyZWNlaXB0c19mb3JfYmxvY2spOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJsb2NrIHdpdGggbm8gdHhucwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrX251bWJlciA9IG51bSArIHJlY2VpcHRzLmxlbigpIGFzIHU2NDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5vbmUgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgdGhlIGZpcnN0IGJsb2NrIGFuZCBpdCdzIGVtcHR5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUoaGlnaGVzdF9ibG9jaykgPSBwcmV2X2NodW5rX2hpZ2hlc3RfYmxvY2sgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIGEgY2h1bmtlZCByZWFkIGFuZCB0aGlzIGlzIG5vdCB0aGUgZmlyc3QgY2h1bmsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyID0gaGlnaGVzdF9ibG9jayArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBub3QgYSBjaHVua2VkIHJlYWQgb3IgdGhpcyBpcyB0aGUgZmlyc3QgY2h1bmsuIGFzc3VtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdCdzIHRoZSBnZW5lc2lzIGJsb2NrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrX251bWJlciA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2Jsb2NrID0gU29tZShibG9ja19udW1iZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZWNlaXB0c19mb3JfYmxvY2sgPSB2ZWMhW107CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIGxvZ19pbnRlcnZhbCA9PSAwIHsKICAgICAgICAgICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmZpbGUiLAogICAgICAgICAgICAgICAgICAgICAgICBibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsX3JlY2VpcHRzLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZCBmaXJzdCByZWNlaXB0IgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgbG9nX2ludGVydmFsX3N0YXJ0X2Jsb2NrID0gYmxvY2tfbnVtYmVyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIGxvZ19pbnRlcnZhbCAlIDEwMF8wMDAgPT0gMCB7CiAgICAgICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogImRvd25sb2FkZXJzOjpmaWxlIiwKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tzPT9sb2dfaW50ZXJ2YWxfc3RhcnRfYmxvY2suLj1ibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsX3JlY2VpcHRzLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZCByZWNlaXB0cyBmcm9tIGZpbGUiCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBsb2dfaW50ZXJ2YWxfc3RhcnRfYmxvY2sgPSBibG9ja19udW1iZXIgKyAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbG9nX2ludGVydmFsICs9IDE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6ZmlsZSIsCiAgICAgICAgICAgICAgICBibG9ja3M9P2xvZ19pbnRlcnZhbF9zdGFydF9ibG9jay4uPWJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgIHRvdGFsX3JlY2VpcHRzLAogICAgICAgICAgICAgICAgInJlYWQgcmVjZWlwdHMgZnJvbSBmaWxlIgogICAgICAgICAgICApOwoKICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBwdXNoIHRoZSBsYXN0IHJlY2VpcHRzCiAgICAgICAgICAgIHJlY2VpcHRzLnB1c2gocmVjZWlwdHNfZm9yX2Jsb2NrKTsKCiAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6ZmlsZSIsCiAgICAgICAgICAgICAgICBibG9ja3MgPSByZWNlaXB0cy5sZW4oKSwKICAgICAgICAgICAgICAgIHRvdGFsX3JlY2VpcHRzLAogICAgICAgICAgICAgICAgIkluaXRpYWxpemVkIHJlY2VpcHQgZmlsZSBjbGllbnQiCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBPayhEZWNvZGVkRmlsZUNodW5rIHsKICAgICAgICAgICAgICAgIGZpbGVfY2xpZW50OiBTZWxmIHsKICAgICAgICAgICAgICAgICAgICByZWNlaXB0cywKICAgICAgICAgICAgICAgICAgICBmaXJzdF9ibG9jazogZmlyc3RfYmxvY2sudW53cmFwX29yX2RlZmF1bHQoKSwKICAgICAgICAgICAgICAgICAgICB0b3RhbF9yZWNlaXB0cywKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICByZW1haW5pbmdfYnl0ZXMsCiAgICAgICAgICAgICAgICBoaWdoZXN0X2Jsb2NrOiBTb21lKGJsb2NrX251bWJlciksCiAgICAgICAgICAgIH0pCiAgICAgICAgfQogICAgfQp9CgovLy8gUmVjZWlwdCB3aXRoIGJsb2NrIG51bWJlci4KI1tkZXJpdmUoRGVidWcsIFBhcnRpYWxFcSwgRXEpXQpwdWIgc3RydWN0IFJlY2VpcHRXaXRoQmxvY2tOdW1iZXI8Uj4gewogICAgLy8vIFJlY2VpcHQuCiAgICBwdWIgcmVjZWlwdDogUiwKICAgIC8vLyBCbG9jayBudW1iZXIuCiAgICBwdWIgbnVtYmVyOiB1NjQsCn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdCB7CiAgICB1c2UgYWxsb3lfcHJpbWl0aXZlczo6ewogICAgICAgIGFkZHJlc3MsIGIyNTYsCiAgICAgICAgYnl0ZXM6OntCdWYsIEJ5dGVzTXV0fSwKICAgICAgICBoZXgsIEJ5dGVzLCBMb2csIExvZ0RhdGEsCiAgICB9OwogICAgdXNlIGFsbG95X3JscDo6e0RlY29kYWJsZSwgUmxwRGVjb2RhYmxlfTsKICAgIHVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OntSZWNlaXB0LCBUeFR5cGV9OwogICAgdXNlIHJldGhfdHJhY2luZzo6aW5pdF90ZXN0X3RyYWNpbmc7CiAgICB1c2UgdG9raW9fdXRpbDo6Y29kZWM6OkRlY29kZXI7CgogICAgdXNlIHN1cGVyOjp7RnJvbVJlY2VpcHRSZWFkZXIsIFJlY2VpcHRGaWxlQ2xpZW50LCBSZWNlaXB0V2l0aEJsb2NrTnVtYmVyfTsKICAgIHVzZSBjcmF0ZTo6e0RlY29kZWRGaWxlQ2h1bmssIEZpbGVDbGllbnRFcnJvcn07CgogICAgI1tkZXJpdmUoRGVidWcsIFBhcnRpYWxFcSwgRXEsIFJscERlY29kYWJsZSldCiAgICBzdHJ1Y3QgTW9ja1JlY2VpcHQgewogICAgICAgIHR4X3R5cGU6IHU4LAogICAgICAgIHN0YXR1czogdTY0LAogICAgICAgIGN1bXVsYXRpdmVfZ2FzX3VzZWQ6IHU2NCwKICAgICAgICBsb2dzOiBWZWM8TG9nPiwKICAgICAgICBibG9ja19udW1iZXI6IHU2NCwKICAgIH0KCiAgICAjW2Rlcml2ZShEZWJ1ZywgUGFydGlhbEVxLCBFcSwgUmxwRGVjb2RhYmxlKV0KICAgICNbcmxwKHRyYWlsaW5nKV0KICAgIHN0cnVjdCBNb2NrUmVjZWlwdENvbnRhaW5lcihPcHRpb248TW9ja1JlY2VpcHQ+KTsKCiAgICBpbXBsIFRyeUZyb208TW9ja1JlY2VpcHQ+IGZvciBSZWNlaXB0V2l0aEJsb2NrTnVtYmVyPFJlY2VpcHQ+IHsKICAgICAgICB0eXBlIEVycm9yID0gRmlsZUNsaWVudEVycm9yOwogICAgICAgIGZuIHRyeV9mcm9tKGV4cG9ydGVkX3JlY2VpcHQ6IE1vY2tSZWNlaXB0KSAtPiBSZXN1bHQ8U2VsZiwgU2VsZjo6RXJyb3I+IHsKICAgICAgICAgICAgbGV0IE1vY2tSZWNlaXB0IHsgdHhfdHlwZSwgc3RhdHVzLCBjdW11bGF0aXZlX2dhc191c2VkLCBsb2dzLCBibG9ja19udW1iZXI6IG51bWJlciB9ID0KICAgICAgICAgICAgICAgIGV4cG9ydGVkX3JlY2VpcHQ7CgogICAgICAgICAgICBsZXQgcmVjZWlwdCA9IFJlY2VpcHQgewogICAgICAgICAgICAgICAgdHhfdHlwZTogVHhUeXBlOjp0cnlfZnJvbSh0eF90eXBlLnRvX2JlX2J5dGVzKClbMF0pCiAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIofGVycnwgRmlsZUNsaWVudEVycm9yOjpSbHAoZXJyLmludG8oKSwgdmVjIVt0eF90eXBlXSkpPywKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHN0YXR1cyAhPSAwLAogICAgICAgICAgICAgICAgY3VtdWxhdGl2ZV9nYXNfdXNlZCwKICAgICAgICAgICAgICAgIGxvZ3MsCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBPayhTZWxmIHsgcmVjZWlwdCwgbnVtYmVyIH0pCiAgICAgICAgfQogICAgfQoKICAgICNbZGVyaXZlKERlYnVnLCBEZWZhdWx0KV0KICAgIHN0cnVjdCBNb2NrUmVjZWlwdEZpbGVDb2RlYzsKCiAgICBpbXBsIERlY29kZXIgZm9yIE1vY2tSZWNlaXB0RmlsZUNvZGVjIHsKICAgICAgICB0eXBlIEl0ZW0gPSBPcHRpb248UmVjZWlwdFdpdGhCbG9ja051bWJlcjxSZWNlaXB0Pj47CiAgICAgICAgdHlwZSBFcnJvciA9IEZpbGVDbGllbnRFcnJvcjsKCiAgICAgICAgZm4gZGVjb2RlKCZtdXQgc2VsZiwgc3JjOiAmbXV0IEJ5dGVzTXV0KSAtPiBSZXN1bHQ8T3B0aW9uPFNlbGY6Okl0ZW0+LCBTZWxmOjpFcnJvcj4gewogICAgICAgICAgICBpZiBzcmMuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gT2soTm9uZSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGJ1Zl9zbGljZSA9ICZtdXQgc3JjLmFzX3JlZigpOwogICAgICAgICAgICBsZXQgcmVjZWlwdCA9IE1vY2tSZWNlaXB0Q29udGFpbmVyOjpkZWNvZGUoYnVmX3NsaWNlKQogICAgICAgICAgICAgICAgLm1hcF9lcnIofGVycnwgU2VsZjo6RXJyb3I6OlJscChlcnIsIHNyYy50b192ZWMoKSkpPwogICAgICAgICAgICAgICAgLjA7CiAgICAgICAgICAgIHNyYy5hZHZhbmNlKHNyYy5sZW4oKSAtIGJ1Zl9zbGljZS5sZW4oKSk7CgogICAgICAgICAgICBPayhTb21lKHJlY2VpcHQubWFwKHxyZWNlaXB0fCByZWNlaXB0LnRyeV9pbnRvKCkpLnRyYW5zcG9zZSgpPykpCiAgICAgICAgfQogICAgfQoKICAgIC8vLyBObyByZWNlaXB0cyBmb3IgZ2VuZXNpcyBibG9jawogICAgY29uc3QgTU9DS19SRUNFSVBUX0JMT0NLX05PX1RSQU5TQUNUSU9OUzogJlt1OF0gPSAmaGV4ISgiYzAiKTsKCiAgICBjb25zdCBNT0NLX1JFQ0VJUFRfRU5DT0RFRF9CTE9DS18xOiAmW3U4XSA9ICZoZXghKAogICAgICAgICJmOTAxYTRmOTAxYTE4MDAxODMwMzE4NDNmOTAxOTdmODliOTQ4Y2U4YzEzZDgxNmZlNmRhZjEyZDZmZDllNDk1MmUxZmM4ODg1MGFlZjg2M2EwMDEwOWZjNmY1NWNmNDA2ODlmMDJmYmFhZDdhZjdmZTdiYmFjOGEzZDIxODY2MDBhZmM3ZDNlMTBjYWM2MDI3YmEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAxNDIxOGEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwNzBiMTdjMGZlOTgyYWI0YTdhYzE3YTRjMjU0ODU2NDMxNTFhMWYyZGEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA2MThkODgzN2Y4OWM5NDhjZThjMTNkODE2ZmU2ZGFmMTJkNmZkOWU0OTUyZTFmYzg4ODUwYWVmODg0YTA5MmU5ODQyM2Y4YWRhYzZlNjRkMDYwOGU1MTlmZDFjZWZiODYxNDk4Mzg1YzZkZWU3MGQ1OGZjOTI2ZGRjNjhiYTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMGQwZTNlYmYwYTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDE0MjE4YTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA3MGIxN2MwZmU5ODJhYjRhN2FjMTdhNGMyNTQ4NTY0MzE1MWExZjJkODBmODVhOTQ4Y2U4YzEzZDgxNmZlNmRhZjEyZDZmZDllNDk1MmUxZmM4ODg1MGFlZjg0MmEwZmUyNWM3M2UzYjkwODlmYWMzN2Q1NWM0YzdlZmNiYTZmMDRhZjA0Y2ViZDJmYzRkNmQ3ZGJiMDdlMWU1MjM0ZmEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDdlZGM2Y2EwYmI2ODM0ODAwMDgwMDEiCiAgICApOwoKICAgIGNvbnN0IE1PQ0tfUkVDRUlQVF9FTkNPREVEX0JMT0NLXzI6ICZbdThdID0gJmhleCEoCiAgICAgICAgImY5MDEwNmY5MDEwMzgwMDE4MzAxYzYwZGY4ZmFmODljOTQ4Y2U4YzEzZDgxNmZlNmRhZjEyZDZmZDllNDk1MmUxZmM4ODg1MGFlZjg4NGEwOTJlOTg0MjNmOGFkYWM2ZTY0ZDA2MDhlNTE5ZmQxY2VmYjg2MTQ5ODM4NWM2ZGVlNzBkNThmYzkyNmRkYzY4ZGEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDBkMGVhMGU0MGEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAxNDIxOGEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwZTVlNzQ5MjI4MmZkMWUzYmZhYzMzN2EwYmVjY2QyOWIxNWI3YjI0MDgwZjg1YTk0OGNlOGMxM2Q4MTZmZTZkYWYxMmQ2ZmQ5ZTQ5NTJlMWZjODg4NTBhZWY4NDJhMGZlMjVjNzNlM2I5MDg5ZmFjMzdkNTVjNGM3ZWZjYmE2ZjA0YWYwNGNlYmQyZmM0ZDZkN2RiYjA3ZTFlNTIzNGVhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA3ZWRhNzg2N2UwYzdkNDgwMDA4MDAyIgogICAgKTsKCiAgICBjb25zdCBNT0NLX1JFQ0VJUFRfRU5DT0RFRF9CTE9DS18zOiAmW3U4XSA9ICZoZXghKAogICAgICAgICJmOTAxMDZmOTAxMDM4MDAxODMwMWM2MGRmOGZhZjg5Yzk0OGNlOGMxM2Q4MTZmZTZkYWYxMmQ2ZmQ5ZTQ5NTJlMWZjODg4NTBhZWY4ODRhMDkyZTk4NDIzZjhhZGFjNmU2NGQwNjA4ZTUxOWZkMWNlZmI4NjE0OTgzODVjNmRlZTcwZDU4ZmM5MjZkZGM2OGRhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwZDEwMWU1NGJhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMTQyMThhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMGZhMDExZDhkNmMyNmYxM2FiZTJjZWZlZDM4MjI2ZTQwMWIyYjhhOTk4MGY4NWE5NDhjZThjMTNkODE2ZmU2ZGFmMTJkNmZkOWU0OTUyZTFmYzg4ODUwYWVmODQyYTBmZTI1YzczZTNiOTA4OWZhYzM3ZDU1YzRjN2VmY2JhNmYwNGFmMDRjZWJkMmZjNGQ2ZDdkYmIwN2UxZTUyMzRlYTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwN2VkODg0MmYwNjI3NzQ4MDAwODAwMyIKICAgICk7CgogICAgZm4gbW9ja19yZWNlaXB0XzEoKSAtPiBNb2NrUmVjZWlwdCB7CiAgICAgICAgbGV0IHJlY2VpcHQgPSByZWNlaXB0X2Jsb2NrXzEoKTsKICAgICAgICBNb2NrUmVjZWlwdCB7CiAgICAgICAgICAgIHR4X3R5cGU6IHJlY2VpcHQucmVjZWlwdC50eF90eXBlIGFzIHU4LAogICAgICAgICAgICBzdGF0dXM6IHJlY2VpcHQucmVjZWlwdC5zdWNjZXNzIGFzIHU2NCwKCiAgICAgICAgICAgIGN1bXVsYXRpdmVfZ2FzX3VzZWQ6IHJlY2VpcHQucmVjZWlwdC5jdW11bGF0aXZlX2dhc191c2VkLAogICAgICAgICAgICBsb2dzOiByZWNlaXB0LnJlY2VpcHQubG9ncywKICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiAxLAogICAgICAgIH0KICAgIH0KCiAgICBmbiBtb2NrX3JlY2VpcHRfMigpIC0+IE1vY2tSZWNlaXB0IHsKICAgICAgICBsZXQgcmVjZWlwdCA9IHJlY2VpcHRfYmxvY2tfMigpOwogICAgICAgIE1vY2tSZWNlaXB0IHsKICAgICAgICAgICAgdHhfdHlwZTogcmVjZWlwdC5yZWNlaXB0LnR4X3R5cGUgYXMgdTgsCiAgICAgICAgICAgIHN0YXR1czogcmVjZWlwdC5yZWNlaXB0LnN1Y2Nlc3MgYXMgdTY0LAoKICAgICAgICAgICAgY3VtdWxhdGl2ZV9nYXNfdXNlZDogcmVjZWlwdC5yZWNlaXB0LmN1bXVsYXRpdmVfZ2FzX3VzZWQsCiAgICAgICAgICAgIGxvZ3M6IHJlY2VpcHQucmVjZWlwdC5sb2dzLAogICAgICAgICAgICBibG9ja19udW1iZXI6IDIsCiAgICAgICAgfQogICAgfQoKICAgIGZuIG1vY2tfcmVjZWlwdF8zKCkgLT4gTW9ja1JlY2VpcHQgewogICAgICAgIGxldCByZWNlaXB0ID0gcmVjZWlwdF9ibG9ja18zKCk7CiAgICAgICAgTW9ja1JlY2VpcHQgewogICAgICAgICAgICB0eF90eXBlOiByZWNlaXB0LnJlY2VpcHQudHhfdHlwZSBhcyB1OCwKICAgICAgICAgICAgc3RhdHVzOiByZWNlaXB0LnJlY2VpcHQuc3VjY2VzcyBhcyB1NjQsCgogICAgICAgICAgICBjdW11bGF0aXZlX2dhc191c2VkOiByZWNlaXB0LnJlY2VpcHQuY3VtdWxhdGl2ZV9nYXNfdXNlZCwKICAgICAgICAgICAgbG9nczogcmVjZWlwdC5yZWNlaXB0LmxvZ3MsCiAgICAgICAgICAgIGJsb2NrX251bWJlcjogMywKICAgICAgICB9CiAgICB9CgogICAgZm4gcmVjZWlwdF9ibG9ja18xKCkgLT4gUmVjZWlwdFdpdGhCbG9ja051bWJlcjxSZWNlaXB0PiB7CiAgICAgICAgbGV0IGxvZ18xID0gTG9nIHsKICAgICAgICAgICAgYWRkcmVzczogYWRkcmVzcyEoIjB4OGNlOGMxM2Q4MTZmZTZkYWYxMmQ2ZmQ5ZTQ5NTJlMWZjODg4NTBhZSIpLAogICAgICAgICAgICBkYXRhOiBMb2dEYXRhOjpuZXcoCiAgICAgICAgICAgICAgICB2ZWMhWwogICAgICAgICAgICAgICAgICAgIGIyNTYhKCIweDAxMDlmYzZmNTVjZjQwNjg5ZjAyZmJhYWQ3YWY3ZmU3YmJhYzhhM2QyMTg2NjAwYWZjN2QzZTEwY2FjNjAyN2IiKSwKICAgICAgICAgICAgICAgICAgICBiMjU2ISgiMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDE0MjE4IiksCiAgICAgICAgICAgICAgICAgICAgYjI1NiEoIjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwNzBiMTdjMGZlOTgyYWI0YTdhYzE3YTRjMjU0ODU2NDMxNTFhMWYyZCIpLAogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgIEJ5dGVzOjpmcm9tKGhleCEoCiAgICAgICAgICAgICAgICAgICAgIjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwNjE4ZDg4MzciCiAgICAgICAgICAgICAgICApKSwKICAgICAgICAgICAgKQogICAgICAgICAgICAudW53cmFwKCksCiAgICAgICAgfTsKCiAgICAgICAgbGV0IGxvZ18yID0gTG9nIHsKICAgICAgICAgICAgYWRkcmVzczogYWRkcmVzcyEoIjB4OGNlOGMxM2Q4MTZmZTZkYWYxMmQ2ZmQ5ZTQ5NTJlMWZjODg4NTBhZSIpLAogICAgICAgICAgICBkYXRhOiBMb2dEYXRhOjpuZXcoCiAgICAgICAgICAgICAgICB2ZWMhWwogICAgICAgICAgICAgICAgICAgIGIyNTYhKCIweDkyZTk4NDIzZjhhZGFjNmU2NGQwNjA4ZTUxOWZkMWNlZmI4NjE0OTgzODVjNmRlZTcwZDU4ZmM5MjZkZGM2OGIiKSwKICAgICAgICAgICAgICAgICAgICBiMjU2ISgiMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMGQwZTNlYmYwIiksCiAgICAgICAgICAgICAgICAgICAgYjI1NiEoIjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAxNDIxOCIpLAogICAgICAgICAgICAgICAgICAgIGIyNTYhKCIweDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDcwYjE3YzBmZTk4MmFiNGE3YWMxN2E0YzI1NDg1NjQzMTUxYTFmMmQiKSwKICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICBCeXRlczo6ZGVmYXVsdCgpLAogICAgICAgICAgICApCiAgICAgICAgICAgIC51bndyYXAoKSwKICAgICAgICB9OwoKICAgICAgICBsZXQgbG9nXzMgPSBMb2cgewogICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzISgiMHg4Y2U4YzEzZDgxNmZlNmRhZjEyZDZmZDllNDk1MmUxZmM4ODg1MGFlIiksCiAgICAgICAgICAgIGRhdGE6IExvZ0RhdGE6Om5ldygKICAgICAgICAgICAgICAgIHZlYyFbCiAgICAgICAgICAgICAgICAgICAgYjI1NiEoIjB4ZmUyNWM3M2UzYjkwODlmYWMzN2Q1NWM0YzdlZmNiYTZmMDRhZjA0Y2ViZDJmYzRkNmQ3ZGJiMDdlMWU1MjM0ZiIpLAogICAgICAgICAgICAgICAgICAgIGIyNTYhKCIweDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA3ZWRjNmNhMGJiNjgzNDgwMDAiKSwKICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICBCeXRlczo6ZGVmYXVsdCgpLAogICAgICAgICAgICApCiAgICAgICAgICAgIC51bndyYXAoKSwKICAgICAgICB9OwoKICAgICAgICAvLyBmZWF0dXJlIG11c3Qgbm90IGJlIGJyb3VnaHQgaW50byBzY29wZQogICAgICAgIGxldCBtdXQgcmVjZWlwdCA9IFJlY2VpcHQgewogICAgICAgICAgICB0eF90eXBlOiBUeFR5cGU6OkxlZ2FjeSwKICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICAgICAgY3VtdWxhdGl2ZV9nYXNfdXNlZDogMjAyODE5LAogICAgICAgICAgICBsb2dzOiB2ZWMhW10sCiAgICAgICAgfTsKICAgICAgICByZWNlaXB0LmxvZ3MgPSB2ZWMhW2xvZ18xLCBsb2dfMiwgbG9nXzNdOwoKICAgICAgICBSZWNlaXB0V2l0aEJsb2NrTnVtYmVyIHsgcmVjZWlwdCwgbnVtYmVyOiAxIH0KICAgIH0KCiAgICBmbiByZWNlaXB0X2Jsb2NrXzIoKSAtPiBSZWNlaXB0V2l0aEJsb2NrTnVtYmVyPFJlY2VpcHQ+IHsKICAgICAgICBsZXQgbG9nXzEgPSBMb2cgewogICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzISgiMHg4Y2U4YzEzZDgxNmZlNmRhZjEyZDZmZDllNDk1MmUxZmM4ODg1MGFlIiksCiAgICAgICAgICAgIGRhdGE6IExvZ0RhdGE6Om5ldygKICAgICAgICAgICAgICAgIHZlYyFbCiAgICAgICAgICAgICAgICAgICAgYjI1NiEoIjB4OTJlOTg0MjNmOGFkYWM2ZTY0ZDA2MDhlNTE5ZmQxY2VmYjg2MTQ5ODM4NWM2ZGVlNzBkNThmYzkyNmRkYzY4ZCIpLAogICAgICAgICAgICAgICAgICAgIGIyNTYhKCIweDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwZDBlYTBlNDAiKSwKICAgICAgICAgICAgICAgICAgICBiMjU2ISgiMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDE0MjE4IiksCiAgICAgICAgICAgICAgICAgICAgYjI1NiEoIjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwZTVlNzQ5MjI4MmZkMWUzYmZhYzMzN2EwYmVjY2QyOWIxNWI3YjI0MCIpLAogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgIEJ5dGVzOjpkZWZhdWx0KCksCiAgICAgICAgICAgICkKICAgICAgICAgICAgLnVud3JhcCgpLAogICAgICAgIH07CgogICAgICAgIGxldCBsb2dfMiA9IExvZyB7CiAgICAgICAgICAgIGFkZHJlc3M6IGFkZHJlc3MhKCIweDhjZThjMTNkODE2ZmU2ZGFmMTJkNmZkOWU0OTUyZTFmYzg4ODUwYWUiKSwKICAgICAgICAgICAgZGF0YTogTG9nRGF0YTo6bmV3KAogICAgICAgICAgICAgICAgdmVjIVsKICAgICAgICAgICAgICAgICAgICBiMjU2ISgiMHhmZTI1YzczZTNiOTA4OWZhYzM3ZDU1YzRjN2VmY2JhNmYwNGFmMDRjZWJkMmZjNGQ2ZDdkYmIwN2UxZTUyMzRlIiksCiAgICAgICAgICAgICAgICAgICAgYjI1NiEoIjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDdlZGE3ODY3ZTBjN2Q0ODAwMCIpLAogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgIEJ5dGVzOjpkZWZhdWx0KCksCiAgICAgICAgICAgICkKICAgICAgICAgICAgLnVud3JhcCgpLAogICAgICAgIH07CgogICAgICAgIGxldCBtdXQgcmVjZWlwdCA9IFJlY2VpcHQgewogICAgICAgICAgICB0eF90eXBlOiBUeFR5cGU6OkxlZ2FjeSwKICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICAgICAgY3VtdWxhdGl2ZV9nYXNfdXNlZDogMTE2MjM3LAogICAgICAgICAgICBsb2dzOiB2ZWMhW10sCiAgICAgICAgfTsKICAgICAgICByZWNlaXB0LmxvZ3MgPSB2ZWMhW2xvZ18xLCBsb2dfMl07CgogICAgICAgIFJlY2VpcHRXaXRoQmxvY2tOdW1iZXIgeyByZWNlaXB0LCBudW1iZXI6IDIgfQogICAgfQoKICAgIGZuIHJlY2VpcHRfYmxvY2tfMygpIC0+IFJlY2VpcHRXaXRoQmxvY2tOdW1iZXI8UmVjZWlwdD4gewogICAgICAgIGxldCBsb2dfMSA9IExvZyB7CiAgICAgICAgICAgIGFkZHJlc3M6IGFkZHJlc3MhKCIweDhjZThjMTNkODE2ZmU2ZGFmMTJkNmZkOWU0OTUyZTFmYzg4ODUwYWUiKSwKICAgICAgICAgICAgZGF0YTogTG9nRGF0YTo6bmV3KAogICAgICAgICAgICAgICAgdmVjIVsKICAgICAgICAgICAgICAgICAgICBiMjU2ISgiMHg5MmU5ODQyM2Y4YWRhYzZlNjRkMDYwOGU1MTlmZDFjZWZiODYxNDk4Mzg1YzZkZWU3MGQ1OGZjOTI2ZGRjNjhkIiksCiAgICAgICAgICAgICAgICAgICAgYjI1NiEoIjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDBkMTAxZTU0YiIpLAogICAgICAgICAgICAgICAgICAgIGIyNTYhKCIweDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMTQyMTgiKSwKICAgICAgICAgICAgICAgICAgICBiMjU2ISgiMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDBmYTAxMWQ4ZDZjMjZmMTNhYmUyY2VmZWQzODIyNmU0MDFiMmI4YTk5IiksCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgQnl0ZXM6OmRlZmF1bHQoKSwKICAgICAgICAgICAgKQogICAgICAgICAgICAudW53cmFwKCksCiAgICAgICAgfTsKCiAgICAgICAgbGV0IGxvZ18yID0gTG9nIHsKICAgICAgICAgICAgYWRkcmVzczogYWRkcmVzcyEoIjB4OGNlOGMxM2Q4MTZmZTZkYWYxMmQ2ZmQ5ZTQ5NTJlMWZjODg4NTBhZSIpLAogICAgICAgICAgICBkYXRhOiBMb2dEYXRhOjpuZXcoCiAgICAgICAgICAgICAgICB2ZWMhWwogICAgICAgICAgICAgICAgICAgIGIyNTYhKCIweGZlMjVjNzNlM2I5MDg5ZmFjMzdkNTVjNGM3ZWZjYmE2ZjA0YWYwNGNlYmQyZmM0ZDZkN2RiYjA3ZTFlNTIzNGUiKSwKICAgICAgICAgICAgICAgICAgICBiMjU2ISgiMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwN2VkODg0MmYwNjI3NzQ4MDAwIiksCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgQnl0ZXM6OmRlZmF1bHQoKSwKICAgICAgICAgICAgKQogICAgICAgICAgICAudW53cmFwKCksCiAgICAgICAgfTsKCiAgICAgICAgbGV0IG11dCByZWNlaXB0ID0gUmVjZWlwdCB7CiAgICAgICAgICAgIHR4X3R5cGU6IFR4VHlwZTo6TGVnYWN5LAogICAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgICAgICBjdW11bGF0aXZlX2dhc191c2VkOiAxMTYyMzcsCiAgICAgICAgICAgIC4uRGVmYXVsdDo6ZGVmYXVsdCgpCiAgICAgICAgfTsKICAgICAgICByZWNlaXB0LmxvZ3MgPSB2ZWMhW2xvZ18xLCBsb2dfMl07CgogICAgICAgIFJlY2VpcHRXaXRoQmxvY2tOdW1iZXIgeyByZWNlaXB0LCBudW1iZXI6IDMgfQogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIGRlY29kZV9tb2NrX3JlY2VpcHQoKSB7CiAgICAgICAgbGV0IHJlY2VpcHQxID0gbW9ja19yZWNlaXB0XzEoKTsKICAgICAgICBsZXQgZGVjb2RlZDEgPSBNb2NrUmVjZWlwdENvbnRhaW5lcjo6ZGVjb2RlKCZtdXQgJk1PQ0tfUkVDRUlQVF9FTkNPREVEX0JMT0NLXzFbLi5dKQogICAgICAgICAgICAudW53cmFwKCkKICAgICAgICAgICAgLjAKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEocmVjZWlwdDEsIGRlY29kZWQxKTsKCiAgICAgICAgbGV0IHJlY2VpcHQyID0gbW9ja19yZWNlaXB0XzIoKTsKICAgICAgICBsZXQgZGVjb2RlZDIgPSBNb2NrUmVjZWlwdENvbnRhaW5lcjo6ZGVjb2RlKCZtdXQgJk1PQ0tfUkVDRUlQVF9FTkNPREVEX0JMT0NLXzJbLi5dKQogICAgICAgICAgICAudW53cmFwKCkKICAgICAgICAgICAgLjAKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEocmVjZWlwdDIsIGRlY29kZWQyKTsKCiAgICAgICAgbGV0IHJlY2VpcHQzID0gbW9ja19yZWNlaXB0XzMoKTsKICAgICAgICBsZXQgZGVjb2RlZDMgPSBNb2NrUmVjZWlwdENvbnRhaW5lcjo6ZGVjb2RlKCZtdXQgJk1PQ0tfUkVDRUlQVF9FTkNPREVEX0JMT0NLXzNbLi5dKQogICAgICAgICAgICAudW53cmFwKCkKICAgICAgICAgICAgLjAKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEocmVjZWlwdDMsIGRlY29kZWQzKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiByZWNlaXB0c19jb2RlYygpIHsKICAgICAgICAvLyByaWcKCiAgICAgICAgbGV0IG11dCByZWNlaXB0XzFfdG9fMyA9IE1PQ0tfUkVDRUlQVF9FTkNPREVEX0JMT0NLXzEudG9fdmVjKCk7CiAgICAgICAgcmVjZWlwdF8xX3RvXzMuZXh0ZW5kX2Zyb21fc2xpY2UoTU9DS19SRUNFSVBUX0VOQ09ERURfQkxPQ0tfMik7CiAgICAgICAgcmVjZWlwdF8xX3RvXzMuZXh0ZW5kX2Zyb21fc2xpY2UoTU9DS19SRUNFSVBUX0VOQ09ERURfQkxPQ0tfMyk7CgogICAgICAgIGxldCBlbmNvZGVkID0gJm11dCBCeXRlc011dDo6ZnJvbSgmcmVjZWlwdF8xX3RvXzNbLi5dKTsKCiAgICAgICAgbGV0IG11dCBjb2RlYyA9IE1vY2tSZWNlaXB0RmlsZUNvZGVjOwoKICAgICAgICAvLyB0ZXN0CgogICAgICAgIGxldCBmaXJzdF9kZWNvZGVkX3JlY2VpcHQgPSBjb2RlYy5kZWNvZGUoZW5jb2RlZCkudW53cmFwKCkudW53cmFwKCkudW53cmFwKCk7CgogICAgICAgIGFzc2VydF9lcSEocmVjZWlwdF9ibG9ja18xKCksIGZpcnN0X2RlY29kZWRfcmVjZWlwdCk7CgogICAgICAgIGxldCBzZWNvbmRfZGVjb2RlZF9yZWNlaXB0ID0gY29kZWMuZGVjb2RlKGVuY29kZWQpLnVud3JhcCgpLnVud3JhcCgpLnVud3JhcCgpOwoKICAgICAgICBhc3NlcnRfZXEhKHJlY2VpcHRfYmxvY2tfMigpLCBzZWNvbmRfZGVjb2RlZF9yZWNlaXB0KTsKCiAgICAgICAgbGV0IHRoaXJkX2RlY29kZWRfcmVjZWlwdCA9IGNvZGVjLmRlY29kZShlbmNvZGVkKS51bndyYXAoKS51bndyYXAoKS51bndyYXAoKTsKCiAgICAgICAgYXNzZXJ0X2VxIShyZWNlaXB0X2Jsb2NrXzMoKSwgdGhpcmRfZGVjb2RlZF9yZWNlaXB0KTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gcmVjZWlwdF9maWxlX2NsaWVudF9vdm1fY29kZWMoKSB7CiAgICAgICAgaW5pdF90ZXN0X3RyYWNpbmcoKTsKCiAgICAgICAgLy8gZ2VuZXNpcyBibG9jayBoYXMgbm8gaGFjayByZWNlaXB0cwogICAgICAgIGxldCBtdXQgZW5jb2RlZF9yZWNlaXB0cyA9IE1PQ0tfUkVDRUlQVF9CTE9DS19OT19UUkFOU0FDVElPTlMudG9fdmVjKCk7CiAgICAgICAgLy8gb25lIHJlY2VpcHQgZWFjaCBmb3IgYmxvY2sgMSBhbmQgMgogICAgICAgIGVuY29kZWRfcmVjZWlwdHMuZXh0ZW5kX2Zyb21fc2xpY2UoTU9DS19SRUNFSVBUX0VOQ09ERURfQkxPQ0tfMSk7CiAgICAgICAgZW5jb2RlZF9yZWNlaXB0cy5leHRlbmRfZnJvbV9zbGljZShNT0NLX1JFQ0VJUFRfRU5DT0RFRF9CTE9DS18yKTsKICAgICAgICAvLyBubyByZWNlaXB0IGZvciBibG9jayA0CiAgICAgICAgZW5jb2RlZF9yZWNlaXB0cy5leHRlbmRfZnJvbV9zbGljZShNT0NLX1JFQ0VJUFRfQkxPQ0tfTk9fVFJBTlNBQ1RJT05TKTsKCiAgICAgICAgbGV0IGVuY29kZWRfYnl0ZV9sZW4gPSBlbmNvZGVkX3JlY2VpcHRzLmxlbigpIGFzIHU2NDsKICAgICAgICBsZXQgcmVhZGVyID0gJm11dCAmZW5jb2RlZF9yZWNlaXB0c1suLl07CgogICAgICAgIGxldCBEZWNvZGVkRmlsZUNodW5rIHsKICAgICAgICAgICAgZmlsZV9jbGllbnQ6IFJlY2VpcHRGaWxlQ2xpZW50IHsgcmVjZWlwdHMsIGZpcnN0X2Jsb2NrLCB0b3RhbF9yZWNlaXB0cywgLi4gfSwKICAgICAgICAgICAgLi4KICAgICAgICB9ID0gUmVjZWlwdEZpbGVDbGllbnQ6OjxNb2NrUmVjZWlwdEZpbGVDb2RlYz46OmZyb21fcmVjZWlwdF9yZWFkZXIoCiAgICAgICAgICAgIHJlYWRlciwKICAgICAgICAgICAgZW5jb2RlZF9ieXRlX2xlbiwKICAgICAgICAgICAgTm9uZSwKICAgICAgICApCiAgICAgICAgLmF3YWl0CiAgICAgICAgLnVud3JhcCgpOwoKICAgICAgICAvLyAyIG5vbi1lbXB0eSByZWNlaXB0IG9iamVjdHMKICAgICAgICBhc3NlcnRfZXEhKDIsIHRvdGFsX3JlY2VpcHRzKTsKICAgICAgICBhc3NlcnRfZXEhKDAsIGZpcnN0X2Jsb2NrKTsKICAgICAgICBhc3NlcnQhKHJlY2VpcHRzWzBdLmlzX2VtcHR5KCkpOwogICAgICAgIGFzc2VydF9lcSEocmVjZWlwdF9ibG9ja18xKCkucmVjZWlwdCwgcmVjZWlwdHNbMV1bMF0uY2xvbmUoKSk7CiAgICAgICAgYXNzZXJ0X2VxIShyZWNlaXB0X2Jsb2NrXzIoKS5yZWNlaXB0LCByZWNlaXB0c1syXVswXS5jbG9uZSgpKTsKICAgICAgICBhc3NlcnQhKHJlY2VpcHRzWzNdLmlzX2VtcHR5KCkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBub19yZWNlaXB0c19taWRkbGVfYmxvY2soKSB7CiAgICAgICAgaW5pdF90ZXN0X3RyYWNpbmcoKTsKCiAgICAgICAgLy8gZ2VuZXNpcyBibG9jayBoYXMgbm8gaGFjayByZWNlaXB0cwogICAgICAgIGxldCBtdXQgZW5jb2RlZF9yZWNlaXB0cyA9IE1PQ0tfUkVDRUlQVF9CTE9DS19OT19UUkFOU0FDVElPTlMudG9fdmVjKCk7CiAgICAgICAgLy8gb25lIHJlY2VpcHQgZWFjaCBmb3IgYmxvY2sgMQogICAgICAgIGVuY29kZWRfcmVjZWlwdHMuZXh0ZW5kX2Zyb21fc2xpY2UoTU9DS19SRUNFSVBUX0VOQ09ERURfQkxPQ0tfMSk7CiAgICAgICAgLy8gbm8gcmVjZWlwdCBmb3IgYmxvY2sgMgogICAgICAgIGVuY29kZWRfcmVjZWlwdHMuZXh0ZW5kX2Zyb21fc2xpY2UoTU9DS19SRUNFSVBUX0JMT0NLX05PX1RSQU5TQUNUSU9OUyk7CiAgICAgICAgLy8gb25lIHJlY2VpcHQgZm9yIGJsb2NrIDMKICAgICAgICBlbmNvZGVkX3JlY2VpcHRzLmV4dGVuZF9mcm9tX3NsaWNlKE1PQ0tfUkVDRUlQVF9FTkNPREVEX0JMT0NLXzMpOwoKICAgICAgICBsZXQgZW5jb2RlZF9ieXRlX2xlbiA9IGVuY29kZWRfcmVjZWlwdHMubGVuKCkgYXMgdTY0OwogICAgICAgIGxldCByZWFkZXIgPSAmbXV0ICZlbmNvZGVkX3JlY2VpcHRzWy4uXTsKCiAgICAgICAgbGV0IERlY29kZWRGaWxlQ2h1bmsgewogICAgICAgICAgICBmaWxlX2NsaWVudDogUmVjZWlwdEZpbGVDbGllbnQgeyByZWNlaXB0cywgZmlyc3RfYmxvY2ssIHRvdGFsX3JlY2VpcHRzLCAuLiB9LAogICAgICAgICAgICAuLgogICAgICAgIH0gPSBSZWNlaXB0RmlsZUNsaWVudDo6PE1vY2tSZWNlaXB0RmlsZUNvZGVjPjo6ZnJvbV9yZWNlaXB0X3JlYWRlcigKICAgICAgICAgICAgcmVhZGVyLAogICAgICAgICAgICBlbmNvZGVkX2J5dGVfbGVuLAogICAgICAgICAgICBOb25lLAogICAgICAgICkKICAgICAgICAuYXdhaXQKICAgICAgICAudW53cmFwKCk7CgogICAgICAgIC8vIDIgbm9uLWVtcHR5IHJlY2VpcHQgb2JqZWN0cwogICAgICAgIGFzc2VydF9lcSEoMiwgdG90YWxfcmVjZWlwdHMpOwogICAgICAgIGFzc2VydF9lcSEoMCwgZmlyc3RfYmxvY2spOwogICAgICAgIGFzc2VydCEocmVjZWlwdHNbMF0uaXNfZW1wdHkoKSk7CiAgICAgICAgYXNzZXJ0X2VxIShyZWNlaXB0X2Jsb2NrXzEoKS5yZWNlaXB0LCByZWNlaXB0c1sxXVswXS5jbG9uZSgpKTsKICAgICAgICBhc3NlcnQhKHJlY2VpcHRzWzJdLmlzX2VtcHR5KCkpOwogICAgICAgIGFzc2VydF9lcSEocmVjZWlwdF9ibG9ja18zKCkucmVjZWlwdCwgcmVjZWlwdHNbM11bMF0uY2xvbmUoKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHR3b19yZWNlaXB0c19zYW1lX2Jsb2NrKCkgewogICAgICAgIGluaXRfdGVzdF90cmFjaW5nKCk7CgogICAgICAgIC8vIGdlbmVzaXMgYmxvY2sgaGFzIG5vIGhhY2sgcmVjZWlwdHMKICAgICAgICBsZXQgbXV0IGVuY29kZWRfcmVjZWlwdHMgPSBNT0NLX1JFQ0VJUFRfQkxPQ0tfTk9fVFJBTlNBQ1RJT05TLnRvX3ZlYygpOwogICAgICAgIC8vIG9uZSByZWNlaXB0IGVhY2ggZm9yIGJsb2NrIDEKICAgICAgICBlbmNvZGVkX3JlY2VpcHRzLmV4dGVuZF9mcm9tX3NsaWNlKE1PQ0tfUkVDRUlQVF9FTkNPREVEX0JMT0NLXzEpOwogICAgICAgIC8vIHR3byByZWNlaXB0cyBmb3IgYmxvY2sgMgogICAgICAgIGVuY29kZWRfcmVjZWlwdHMuZXh0ZW5kX2Zyb21fc2xpY2UoTU9DS19SRUNFSVBUX0VOQ09ERURfQkxPQ0tfMik7CiAgICAgICAgZW5jb2RlZF9yZWNlaXB0cy5leHRlbmRfZnJvbV9zbGljZShNT0NLX1JFQ0VJUFRfRU5DT0RFRF9CTE9DS18yKTsKICAgICAgICAvLyBvbmUgcmVjZWlwdCBmb3IgYmxvY2sgMwogICAgICAgIGVuY29kZWRfcmVjZWlwdHMuZXh0ZW5kX2Zyb21fc2xpY2UoTU9DS19SRUNFSVBUX0VOQ09ERURfQkxPQ0tfMyk7CgogICAgICAgIGxldCBlbmNvZGVkX2J5dGVfbGVuID0gZW5jb2RlZF9yZWNlaXB0cy5sZW4oKSBhcyB1NjQ7CiAgICAgICAgbGV0IHJlYWRlciA9ICZtdXQgJmVuY29kZWRfcmVjZWlwdHNbLi5dOwoKICAgICAgICBsZXQgRGVjb2RlZEZpbGVDaHVuayB7CiAgICAgICAgICAgIGZpbGVfY2xpZW50OiBSZWNlaXB0RmlsZUNsaWVudCB7IHJlY2VpcHRzLCBmaXJzdF9ibG9jaywgdG90YWxfcmVjZWlwdHMsIC4uIH0sCiAgICAgICAgICAgIC4uCiAgICAgICAgfSA9IFJlY2VpcHRGaWxlQ2xpZW50Ojo8TW9ja1JlY2VpcHRGaWxlQ29kZWM+Ojpmcm9tX3JlY2VpcHRfcmVhZGVyKAogICAgICAgICAgICByZWFkZXIsCiAgICAgICAgICAgIGVuY29kZWRfYnl0ZV9sZW4sCiAgICAgICAgICAgIE5vbmUsCiAgICAgICAgKQogICAgICAgIC5hd2FpdAogICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgLy8gNCBub24tZW1wdHkgcmVjZWlwdCBvYmplY3RzCiAgICAgICAgYXNzZXJ0X2VxISg0LCB0b3RhbF9yZWNlaXB0cyk7CiAgICAgICAgYXNzZXJ0X2VxISgwLCBmaXJzdF9ibG9jayk7CiAgICAgICAgYXNzZXJ0IShyZWNlaXB0c1swXS5pc19lbXB0eSgpKTsKICAgICAgICBhc3NlcnRfZXEhKHJlY2VpcHRfYmxvY2tfMSgpLnJlY2VpcHQsIHJlY2VpcHRzWzFdWzBdLmNsb25lKCkpOwogICAgICAgIGFzc2VydF9lcSEocmVjZWlwdF9ibG9ja18yKCkucmVjZWlwdCwgcmVjZWlwdHNbMl1bMF0uY2xvbmUoKSk7CiAgICAgICAgYXNzZXJ0X2VxIShyZWNlaXB0X2Jsb2NrXzIoKS5yZWNlaXB0LCByZWNlaXB0c1syXVsxXS5jbG9uZSgpKTsKICAgICAgICBhc3NlcnRfZXEhKHJlY2VpcHRfYmxvY2tfMygpLnJlY2VpcHQsIHJlY2VpcHRzWzNdWzBdLmNsb25lKCkpOwogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9uZXQvbmV0d29yay9zcmMvZmV0Y2gvY2xpZW50LnJzIj4KLy8hIEEgY2xpZW50IGltcGxlbWVudGF0aW9uIHRoYXQgY2FuIGludGVyYWN0IHdpdGggdGhlIG5ldHdvcmsgYW5kIGRvd25sb2FkIGRhdGEuCgp1c2UgY3JhdGU6OntmZXRjaDo6RG93bmxvYWRSZXF1ZXN0LCBmbGF0dGVuZWRfcmVzcG9uc2U6OkZsYXR0ZW5lZFJlc3BvbnNlfTsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkIyNTY7CnVzZSBmdXR1cmVzOjp7ZnV0dXJlLCBmdXR1cmU6OkVpdGhlcn07CnVzZSByZXRoX2V0aF93aXJlOjp7RXRoTmV0d29ya1ByaW1pdGl2ZXMsIE5ldHdvcmtQcmltaXRpdmVzfTsKdXNlIHJldGhfbmV0d29ya19hcGk6OnRlc3RfdXRpbHM6OlBlZXJzSGFuZGxlOwp1c2UgcmV0aF9uZXR3b3JrX3AycDo6ewogICAgYm9kaWVzOjpjbGllbnQ6OntCb2RpZXNDbGllbnQsIEJvZGllc0Z1dH0sCiAgICBkb3dubG9hZDo6RG93bmxvYWRDbGllbnQsCiAgICBlcnJvcjo6e1BlZXJSZXF1ZXN0UmVzdWx0LCBSZXF1ZXN0RXJyb3J9LAogICAgaGVhZGVyczo6Y2xpZW50Ojp7SGVhZGVyc0NsaWVudCwgSGVhZGVyc1JlcXVlc3R9LAogICAgcHJpb3JpdHk6OlByaW9yaXR5LAogICAgQmxvY2tDbGllbnQsCn07CnVzZSByZXRoX25ldHdvcmtfcGVlcnM6OlBlZXJJZDsKdXNlIHJldGhfbmV0d29ya190eXBlczo6UmVwdXRhdGlvbkNoYW5nZUtpbmQ7CnVzZSBzdGQ6OnsKICAgIG9wczo6UmFuZ2VJbmNsdXNpdmUsCiAgICBzeW5jOjp7CiAgICAgICAgYXRvbWljOjp7QXRvbWljVXNpemUsIE9yZGVyaW5nfSwKICAgICAgICBBcmMsCiAgICB9LAp9Owp1c2UgdG9raW86OnN5bmM6OnttcHNjOjpVbmJvdW5kZWRTZW5kZXIsIG9uZXNob3R9OwoKI1tjZmdfYXR0cihkb2MsIGFxdWFtYXJpbmU6OmFxdWFtYXJpbmUpXQovLy8gRnJvbnQtZW5kIEFQSSBmb3IgZmV0Y2hpbmcgZGF0YSBmcm9tIHRoZSBuZXR3b3JrLgovLy8KLy8vIEZvbGxvd2luZyBkaWFncmFtIGlsbHVzdHJhdGVzIGhvdyBhIHJlcXVlc3QsIFNlZSBbYEhlYWRlcnNDbGllbnQ6OmdldF9oZWFkZXJzYF0gYW5kCi8vLyBbYEJvZGllc0NsaWVudDo6Z2V0X2Jsb2NrX2JvZGllc2BdIGlzIGhhbmRsZWQgaW50ZXJuYWxseS4KLy8vCi8vLyBpbmNsdWRlX21tZCEoImRvY3MvbWVybWFpZC9mZXRjaC1jbGllbnQubW1kIikKI1tkZXJpdmUoRGVidWcsIENsb25lKV0KcHViIHN0cnVjdCBGZXRjaENsaWVudDxOOiBOZXR3b3JrUHJpbWl0aXZlcyA9IEV0aE5ldHdvcmtQcmltaXRpdmVzPiB7CiAgICAvLy8gU2VuZGVyIGhhbGYgb2YgdGhlIHJlcXVlc3QgY2hhbm5lbC4KICAgIHB1YihjcmF0ZSkgcmVxdWVzdF90eDogVW5ib3VuZGVkU2VuZGVyPERvd25sb2FkUmVxdWVzdDxOPj4sCiAgICAvLy8gVGhlIGhhbmRsZSB0byB0aGUgcGVlcnMKICAgIHB1YihjcmF0ZSkgcGVlcnNfaGFuZGxlOiBQZWVyc0hhbmRsZSwKICAgIC8vLyBOdW1iZXIgb2YgYWN0aXZlIHBlZXIgc2Vzc2lvbnMgdGhlIG5vZGUncyBjdXJyZW50bHkgaGFuZGxpbmcuCiAgICBwdWIoY3JhdGUpIG51bV9hY3RpdmVfcGVlcnM6IEFyYzxBdG9taWNVc2l6ZT4sCn0KCmltcGw8TjogTmV0d29ya1ByaW1pdGl2ZXM+IERvd25sb2FkQ2xpZW50IGZvciBGZXRjaENsaWVudDxOPiB7CiAgICBmbiByZXBvcnRfYmFkX21lc3NhZ2UoJnNlbGYsIHBlZXJfaWQ6IFBlZXJJZCkgewogICAgICAgIHNlbGYucGVlcnNfaGFuZGxlLnJlcHV0YXRpb25fY2hhbmdlKHBlZXJfaWQsIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpCYWRNZXNzYWdlKTsKICAgIH0KCiAgICBmbiBudW1fY29ubmVjdGVkX3BlZXJzKCZzZWxmKSAtPiB1c2l6ZSB7CiAgICAgICAgc2VsZi5udW1fYWN0aXZlX3BlZXJzLmxvYWQoT3JkZXJpbmc6OlJlbGF4ZWQpCiAgICB9Cn0KCi8vIFRoZSBgT3V0cHV0YCBmdXR1cmUgb2YgdGhlIFtIZWFkZXJzQ2xpZW50XSBpbXBsIG9mIFtGZXRjaENsaWVudF0gdGhhdCBlaXRoZXIgcmV0dXJucyBhIHJlc3BvbnNlCi8vIG9yIGFuIGVycm9yLgp0eXBlIEhlYWRlcnNDbGllbnRGdXR1cmU8VD4gPSBFaXRoZXI8RmxhdHRlbmVkUmVzcG9uc2U8VD4sIGZ1dHVyZTo6UmVhZHk8VD4+OwoKaW1wbDxOOiBOZXR3b3JrUHJpbWl0aXZlcz4gSGVhZGVyc0NsaWVudCBmb3IgRmV0Y2hDbGllbnQ8Tj4gewogICAgdHlwZSBIZWFkZXIgPSBOOjpCbG9ja0hlYWRlcjsKICAgIHR5cGUgT3V0cHV0ID0gSGVhZGVyc0NsaWVudEZ1dHVyZTxQZWVyUmVxdWVzdFJlc3VsdDxWZWM8Tjo6QmxvY2tIZWFkZXI+Pj47CgogICAgLy8vIFNlbmRzIGEgYEdldEJsb2NrSGVhZGVyc2AgcmVxdWVzdCB0byBhbiBhdmFpbGFibGUgcGVlci4KICAgIGZuIGdldF9oZWFkZXJzX3dpdGhfcHJpb3JpdHkoCiAgICAgICAgJnNlbGYsCiAgICAgICAgcmVxdWVzdDogSGVhZGVyc1JlcXVlc3QsCiAgICAgICAgcHJpb3JpdHk6IFByaW9yaXR5LAogICAgKSAtPiBTZWxmOjpPdXRwdXQgewogICAgICAgIGxldCAocmVzcG9uc2UsIHJ4KSA9IG9uZXNob3Q6OmNoYW5uZWwoKTsKICAgICAgICBpZiBzZWxmCiAgICAgICAgICAgIC5yZXF1ZXN0X3R4CiAgICAgICAgICAgIC5zZW5kKERvd25sb2FkUmVxdWVzdDo6R2V0QmxvY2tIZWFkZXJzIHsgcmVxdWVzdCwgcmVzcG9uc2UsIHByaW9yaXR5IH0pCiAgICAgICAgICAgIC5pc19vaygpCiAgICAgICAgewogICAgICAgICAgICBFaXRoZXI6OkxlZnQoRmxhdHRlbmVkUmVzcG9uc2U6OmZyb20ocngpKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIEVpdGhlcjo6UmlnaHQoZnV0dXJlOjplcnIoUmVxdWVzdEVycm9yOjpDaGFubmVsQ2xvc2VkKSkKICAgICAgICB9CiAgICB9Cn0KCmltcGw8TjogTmV0d29ya1ByaW1pdGl2ZXM+IEJvZGllc0NsaWVudCBmb3IgRmV0Y2hDbGllbnQ8Tj4gewogICAgdHlwZSBCb2R5ID0gTjo6QmxvY2tCb2R5OwogICAgdHlwZSBPdXRwdXQgPSBCb2RpZXNGdXQ8Tjo6QmxvY2tCb2R5PjsKCiAgICAvLy8gU2VuZHMgYSBgR2V0QmxvY2tCb2RpZXNgIHJlcXVlc3QgdG8gYW4gYXZhaWxhYmxlIHBlZXIuCiAgICBmbiBnZXRfYmxvY2tfYm9kaWVzX3dpdGhfcHJpb3JpdHlfYW5kX3JhbmdlX2hpbnQoCiAgICAgICAgJnNlbGYsCiAgICAgICAgcmVxdWVzdDogVmVjPEIyNTY+LAogICAgICAgIHByaW9yaXR5OiBQcmlvcml0eSwKICAgICAgICByYW5nZV9oaW50OiBPcHRpb248UmFuZ2VJbmNsdXNpdmU8dTY0Pj4sCiAgICApIC0+IFNlbGY6Ok91dHB1dCB7CiAgICAgICAgbGV0IChyZXNwb25zZSwgcngpID0gb25lc2hvdDo6Y2hhbm5lbCgpOwogICAgICAgIGlmIHNlbGYKICAgICAgICAgICAgLnJlcXVlc3RfdHgKICAgICAgICAgICAgLnNlbmQoRG93bmxvYWRSZXF1ZXN0OjpHZXRCbG9ja0JvZGllcyB7IHJlcXVlc3QsIHJlc3BvbnNlLCBwcmlvcml0eSwgcmFuZ2VfaGludCB9KQogICAgICAgICAgICAuaXNfb2soKQogICAgICAgIHsKICAgICAgICAgICAgQm94OjpwaW4oRmxhdHRlbmVkUmVzcG9uc2U6OmZyb20ocngpKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIEJveDo6cGluKGZ1dHVyZTo6ZXJyKFJlcXVlc3RFcnJvcjo6Q2hhbm5lbENsb3NlZCkpCiAgICAgICAgfQogICAgfQp9CgppbXBsPE46IE5ldHdvcmtQcmltaXRpdmVzPiBCbG9ja0NsaWVudCBmb3IgRmV0Y2hDbGllbnQ8Tj4gewogICAgdHlwZSBCbG9jayA9IE46OkJsb2NrOwp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9uZXQvbmV0d29yay9zcmMvZmV0Y2gvbW9kLnJzIj4KLy8hIEZldGNoIGRhdGEgZnJvbSB0aGUgbmV0d29yay4KCm1vZCBjbGllbnQ7CgpwdWIgdXNlIGNsaWVudDo6RmV0Y2hDbGllbnQ7Cgp1c2UgY3JhdGU6OnttZXNzYWdlOjpCbG9ja1JlcXVlc3QsIHNlc3Npb246OkJsb2NrUmFuZ2VJbmZvfTsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkIyNTY7CnVzZSBmdXR1cmVzOjpTdHJlYW1FeHQ7CnVzZSByZXRoX2V0aF93aXJlOjp7CiAgICBDYXBhYmlsaXRpZXMsIEV0aE5ldHdvcmtQcmltaXRpdmVzLCBHZXRCbG9ja0JvZGllcywgR2V0QmxvY2tIZWFkZXJzLCBOZXR3b3JrUHJpbWl0aXZlcywKfTsKdXNlIHJldGhfbmV0d29ya19hcGk6OnRlc3RfdXRpbHM6OlBlZXJzSGFuZGxlOwp1c2UgcmV0aF9uZXR3b3JrX3AycDo6ewogICAgZXJyb3I6OntFdGhSZXNwb25zZVZhbGlkYXRvciwgUGVlclJlcXVlc3RSZXN1bHQsIFJlcXVlc3RFcnJvciwgUmVxdWVzdFJlc3VsdH0sCiAgICBoZWFkZXJzOjpjbGllbnQ6OkhlYWRlcnNSZXF1ZXN0LAogICAgcHJpb3JpdHk6OlByaW9yaXR5LAp9Owp1c2UgcmV0aF9uZXR3b3JrX3BlZXJzOjpQZWVySWQ7CnVzZSByZXRoX25ldHdvcmtfdHlwZXM6OlJlcHV0YXRpb25DaGFuZ2VLaW5kOwp1c2Ugc3RkOjp7CiAgICBjb2xsZWN0aW9uczo6e0hhc2hNYXAsIFZlY0RlcXVlfSwKICAgIG9wczo6UmFuZ2VJbmNsdXNpdmUsCiAgICBzeW5jOjp7CiAgICAgICAgYXRvbWljOjp7QXRvbWljVTY0LCBBdG9taWNVc2l6ZSwgT3JkZXJpbmd9LAogICAgICAgIEFyYywKICAgIH0sCiAgICB0YXNrOjp7Q29udGV4dCwgUG9sbH0sCn07CnVzZSB0b2tpbzo6c3luYzo6e21wc2MsIG1wc2M6OlVuYm91bmRlZFNlbmRlciwgb25lc2hvdH07CnVzZSB0b2tpb19zdHJlYW06OndyYXBwZXJzOjpVbmJvdW5kZWRSZWNlaXZlclN0cmVhbTsKCnR5cGUgSW5mbGlnaHRIZWFkZXJzUmVxdWVzdDxIPiA9IFJlcXVlc3Q8SGVhZGVyc1JlcXVlc3QsIFBlZXJSZXF1ZXN0UmVzdWx0PFZlYzxIPj4+Owp0eXBlIEluZmxpZ2h0Qm9kaWVzUmVxdWVzdDxCPiA9IFJlcXVlc3Q8KCksIFBlZXJSZXF1ZXN0UmVzdWx0PFZlYzxCPj4+OwoKLy8vIE1hbmFnZXMgZGF0YSBmZXRjaGluZyBvcGVyYXRpb25zLgovLy8KLy8vIFRoaXMgdHlwZSBpcyBob29rZWQgaW50byB0aGUgc3RhZ2VkIHN5bmMgcGlwZWxpbmUgYW5kIGRlbGVnYXRlcyBkb3dubG9hZCByZXF1ZXN0IHRvIGF2YWlsYWJsZQovLy8gcGVlcnMgYW5kIHNlbmRzIHRoZSByZXNwb25zZSBvbmNlIHJlYWR5LgovLy8KLy8vIFRoaXMgdHlwZSBtYWludGFpbnMgYSBsaXN0IG9mIGNvbm5lY3RlZCBwZWVycyB0aGF0IGFyZSBhdmFpbGFibGUgZm9yIHJlcXVlc3RzLgojW2Rlcml2ZShEZWJ1ZyldCnB1YiBzdHJ1Y3QgU3RhdGVGZXRjaGVyPE46IE5ldHdvcmtQcmltaXRpdmVzID0gRXRoTmV0d29ya1ByaW1pdGl2ZXM+IHsKICAgIC8vLyBDdXJyZW50bHkgYWN0aXZlIFtgR2V0QmxvY2tIZWFkZXJzYF0gcmVxdWVzdHMKICAgIGluZmxpZ2h0X2hlYWRlcnNfcmVxdWVzdHM6IEhhc2hNYXA8UGVlcklkLCBJbmZsaWdodEhlYWRlcnNSZXF1ZXN0PE46OkJsb2NrSGVhZGVyPj4sCiAgICAvLy8gQ3VycmVudGx5IGFjdGl2ZSBbYEdldEJsb2NrQm9kaWVzYF0gcmVxdWVzdHMKICAgIGluZmxpZ2h0X2JvZGllc19yZXF1ZXN0czogSGFzaE1hcDxQZWVySWQsIEluZmxpZ2h0Qm9kaWVzUmVxdWVzdDxOOjpCbG9ja0JvZHk+PiwKICAgIC8vLyBUaGUgbGlzdCBvZiBfYXZhaWxhYmxlXyBwZWVycyBmb3IgcmVxdWVzdHMuCiAgICBwZWVyczogSGFzaE1hcDxQZWVySWQsIFBlZXI+LAogICAgLy8vIFRoZSBoYW5kbGUgdG8gdGhlIHBlZXJzIG1hbmFnZXIKICAgIHBlZXJzX2hhbmRsZTogUGVlcnNIYW5kbGUsCiAgICAvLy8gTnVtYmVyIG9mIGFjdGl2ZSBwZWVyIHNlc3Npb25zIHRoZSBub2RlJ3MgY3VycmVudGx5IGhhbmRsaW5nLgogICAgbnVtX2FjdGl2ZV9wZWVyczogQXJjPEF0b21pY1VzaXplPiwKICAgIC8vLyBSZXF1ZXN0cyBxdWV1ZWQgZm9yIHByb2Nlc3NpbmcKICAgIHF1ZXVlZF9yZXF1ZXN0czogVmVjRGVxdWU8RG93bmxvYWRSZXF1ZXN0PE4+PiwKICAgIC8vLyBSZWNlaXZlciBmb3IgbmV3IGluY29taW5nIGRvd25sb2FkIHJlcXVlc3RzCiAgICBkb3dubG9hZF9yZXF1ZXN0c19yeDogVW5ib3VuZGVkUmVjZWl2ZXJTdHJlYW08RG93bmxvYWRSZXF1ZXN0PE4+PiwKICAgIC8vLyBTZW5kZXIgZm9yIGRvd25sb2FkIHJlcXVlc3RzLCB1c2VkIHRvIGRldGFjaCBhIFtgRmV0Y2hDbGllbnRgXQogICAgZG93bmxvYWRfcmVxdWVzdHNfdHg6IFVuYm91bmRlZFNlbmRlcjxEb3dubG9hZFJlcXVlc3Q8Tj4+LAp9CgovLyA9PT0gaW1wbCBTdGF0ZVN5bmNlciA9PT0KCmltcGw8TjogTmV0d29ya1ByaW1pdGl2ZXM+IFN0YXRlRmV0Y2hlcjxOPiB7CiAgICBwdWIoY3JhdGUpIGZuIG5ldyhwZWVyc19oYW5kbGU6IFBlZXJzSGFuZGxlLCBudW1fYWN0aXZlX3BlZXJzOiBBcmM8QXRvbWljVXNpemU+KSAtPiBTZWxmIHsKICAgICAgICBsZXQgKGRvd25sb2FkX3JlcXVlc3RzX3R4LCBkb3dubG9hZF9yZXF1ZXN0c19yeCkgPSBtcHNjOjp1bmJvdW5kZWRfY2hhbm5lbCgpOwogICAgICAgIFNlbGYgewogICAgICAgICAgICBpbmZsaWdodF9oZWFkZXJzX3JlcXVlc3RzOiBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIGluZmxpZ2h0X2JvZGllc19yZXF1ZXN0czogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICBwZWVyczogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICBwZWVyc19oYW5kbGUsCiAgICAgICAgICAgIG51bV9hY3RpdmVfcGVlcnMsCiAgICAgICAgICAgIHF1ZXVlZF9yZXF1ZXN0czogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICBkb3dubG9hZF9yZXF1ZXN0c19yeDogVW5ib3VuZGVkUmVjZWl2ZXJTdHJlYW06Om5ldyhkb3dubG9hZF9yZXF1ZXN0c19yeCksCiAgICAgICAgICAgIGRvd25sb2FkX3JlcXVlc3RzX3R4LAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gSW52b2tlZCB3aGVuIGNvbm5lY3RlZCB0byBhIG5ldyBwZWVyLgogICAgcHViKGNyYXRlKSBmbiBuZXdfYWN0aXZlX3BlZXIoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHBlZXJfaWQ6IFBlZXJJZCwKICAgICAgICBiZXN0X2hhc2g6IEIyNTYsCiAgICAgICAgYmVzdF9udW1iZXI6IHU2NCwKICAgICAgICBjYXBhYmlsaXRpZXM6IEFyYzxDYXBhYmlsaXRpZXM+LAogICAgICAgIHRpbWVvdXQ6IEFyYzxBdG9taWNVNjQ+LAogICAgICAgIHJhbmdlX2luZm86IE9wdGlvbjxCbG9ja1JhbmdlSW5mbz4sCiAgICApIHsKICAgICAgICBzZWxmLnBlZXJzLmluc2VydCgKICAgICAgICAgICAgcGVlcl9pZCwKICAgICAgICAgICAgUGVlciB7CiAgICAgICAgICAgICAgICBzdGF0ZTogUGVlclN0YXRlOjpJZGxlLAogICAgICAgICAgICAgICAgYmVzdF9oYXNoLAogICAgICAgICAgICAgICAgYmVzdF9udW1iZXIsCiAgICAgICAgICAgICAgICBjYXBhYmlsaXRpZXMsCiAgICAgICAgICAgICAgICB0aW1lb3V0LAogICAgICAgICAgICAgICAgbGFzdF9yZXNwb25zZV9saWtlbHlfYmFkOiBmYWxzZSwKICAgICAgICAgICAgICAgIHJhbmdlX2luZm8sCiAgICAgICAgICAgIH0sCiAgICAgICAgKTsKICAgIH0KCiAgICAvLy8gUmVtb3ZlcyB0aGUgcGVlciBmcm9tIHRoZSBwZWVyIGxpc3QsIGFmdGVyIHdoaWNoIGl0IGlzIG5vIGxvbmdlciBhdmFpbGFibGUgZm9yIGZ1dHVyZQogICAgLy8vIHJlcXVlc3RzLgogICAgLy8vCiAgICAvLy8gSW52b2tlZCB3aGVuIGFuIGFjdGl2ZSBzZXNzaW9uIHdhcyBjbG9zZWQuCiAgICAvLy8KICAgIC8vLyBUaGlzIGNhbmNlbHMgYWxzbyBpbmZsaWdodCByZXF1ZXN0IGFuZCBzZW5kcyBhbiBlcnJvciB0byB0aGUgcmVjZWl2ZXIuCiAgICBwdWIoY3JhdGUpIGZuIG9uX3Nlc3Npb25fY2xvc2VkKCZtdXQgc2VsZiwgcGVlcjogJlBlZXJJZCkgewogICAgICAgIHNlbGYucGVlcnMucmVtb3ZlKHBlZXIpOwogICAgICAgIGlmIGxldCBTb21lKHJlcSkgPSBzZWxmLmluZmxpZ2h0X2hlYWRlcnNfcmVxdWVzdHMucmVtb3ZlKHBlZXIpIHsKICAgICAgICAgICAgbGV0IF8gPSByZXEucmVzcG9uc2Uuc2VuZChFcnIoUmVxdWVzdEVycm9yOjpDb25uZWN0aW9uRHJvcHBlZCkpOwogICAgICAgIH0KICAgICAgICBpZiBsZXQgU29tZShyZXEpID0gc2VsZi5pbmZsaWdodF9ib2RpZXNfcmVxdWVzdHMucmVtb3ZlKHBlZXIpIHsKICAgICAgICAgICAgbGV0IF8gPSByZXEucmVzcG9uc2Uuc2VuZChFcnIoUmVxdWVzdEVycm9yOjpDb25uZWN0aW9uRHJvcHBlZCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gVXBkYXRlcyB0aGUgYmxvY2sgaW5mb3JtYXRpb24gZm9yIHRoZSBwZWVyLgogICAgLy8vCiAgICAvLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhpcyBhIG5ld2VyIGJsb2NrCiAgICBwdWIoY3JhdGUpIGZuIHVwZGF0ZV9wZWVyX2Jsb2NrKCZtdXQgc2VsZiwgcGVlcl9pZDogJlBlZXJJZCwgaGFzaDogQjI1NiwgbnVtYmVyOiB1NjQpIC0+IGJvb2wgewogICAgICAgIGlmIGxldCBTb21lKHBlZXIpID0gc2VsZi5wZWVycy5nZXRfbXV0KHBlZXJfaWQpICYmCiAgICAgICAgICAgIG51bWJlciA+IHBlZXIuYmVzdF9udW1iZXIKICAgICAgICB7CiAgICAgICAgICAgIHBlZXIuYmVzdF9oYXNoID0gaGFzaDsKICAgICAgICAgICAgcGVlci5iZXN0X251bWJlciA9IG51bWJlcjsKICAgICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9CiAgICAgICAgZmFsc2UKICAgIH0KCiAgICAvLy8gSW52b2tlZCB3aGVuIGFuIGFjdGl2ZSBzZXNzaW9uIGlzIGFib3V0IHRvIGJlIGRpc2Nvbm5lY3RlZC4KICAgIHB1YihjcmF0ZSkgZm4gb25fcGVuZGluZ19kaXNjb25uZWN0KCZtdXQgc2VsZiwgcGVlcl9pZDogJlBlZXJJZCkgewogICAgICAgIGlmIGxldCBTb21lKHBlZXIpID0gc2VsZi5wZWVycy5nZXRfbXV0KHBlZXJfaWQpIHsKICAgICAgICAgICAgcGVlci5zdGF0ZSA9IFBlZXJTdGF0ZTo6Q2xvc2luZzsKICAgICAgICB9CiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIF9uZXh0XyBpZGxlIHBlZXIgdGhhdCdzIHJlYWR5IHRvIGFjY2VwdCBhIHJlcXVlc3QsCiAgICAvLy8gcHJpb3JpdGl6aW5nIHRob3NlIHdpdGggdGhlIGxvd2VzdCB0aW1lb3V0L2xhdGVuY3kgYW5kIHRob3NlIHRoYXQgcmVjZW50bHkgcmVzcG9uZGVkIHdpdGgKICAgIC8vLyBhZGVxdWF0ZSBkYXRhLiBBZGRpdGlvbmFsbHksIGlmIGZ1bGwgYmxvY2tzIGFyZSByZXF1aXJlZCB0aGlzIHByaW9yaXRpemVzIHBlZXJzIHRoYXQgaGF2ZQogICAgLy8vIGZ1bGwgaGlzdG9yeSBhdmFpbGFibGUKICAgIGZuIG5leHRfYmVzdF9wZWVyKCZzZWxmLCByZXF1aXJlbWVudDogQmVzdFBlZXJSZXF1aXJlbWVudHMpIC0+IE9wdGlvbjxQZWVySWQ+IHsKICAgICAgICBsZXQgbXV0IGlkbGUgPSBzZWxmLnBlZXJzLml0ZXIoKS5maWx0ZXIofChfLCBwZWVyKXwgcGVlci5zdGF0ZS5pc19pZGxlKCkpOwoKICAgICAgICBsZXQgbXV0IGJlc3RfcGVlciA9IGlkbGUubmV4dCgpPzsKCiAgICAgICAgZm9yIG1heWJlX2JldHRlciBpbiBpZGxlIHsKICAgICAgICAgICAgLy8gcmVwbGFjZSBiZXN0IHBlZXIgaWYgb3VyIGN1cnJlbnQgYmVzdCBwZWVyIHNlbnQgdXMgYSBiYWQgcmVzcG9uc2UgbGFzdCB0aW1lCiAgICAgICAgICAgIGlmIGJlc3RfcGVlci4xLmxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZCAmJiAhbWF5YmVfYmV0dGVyLjEubGFzdF9yZXNwb25zZV9saWtlbHlfYmFkIHsKICAgICAgICAgICAgICAgIGJlc3RfcGVlciA9IG1heWJlX2JldHRlcjsKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHJlcGxhY2UgYmVzdCBwZWVyIGlmIHRoaXMgcGVlciBtZWV0cyB0aGUgcmVxdWlyZW1lbnRzIGJldHRlcgogICAgICAgICAgICBpZiBtYXliZV9iZXR0ZXIuMS5pc19iZXR0ZXIoYmVzdF9wZWVyLjEsICZyZXF1aXJlbWVudCkgewogICAgICAgICAgICAgICAgYmVzdF9wZWVyID0gbWF5YmVfYmV0dGVyOwogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcmVwbGFjZSBiZXN0IHBlZXIgaWYgdGhpcyBwZWVyIGhhcyBiZXR0ZXIgcnR0IGFuZCBib3RoIGhhdmUgc2FtZSByYW5nZSBxdWFsaXR5CiAgICAgICAgICAgIGlmIG1heWJlX2JldHRlci4xLnRpbWVvdXQoKSA8IGJlc3RfcGVlci4xLnRpbWVvdXQoKSAmJgogICAgICAgICAgICAgICAgIW1heWJlX2JldHRlci4xLmxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBiZXN0X3BlZXIgPSBtYXliZV9iZXR0ZXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIFNvbWUoKmJlc3RfcGVlci4wKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBuZXh0IGFjdGlvbiB0byByZXR1cm4KICAgIGZuIHBvbGxfYWN0aW9uKCZtdXQgc2VsZikgLT4gUG9sbEFjdGlvbiB7CiAgICAgICAgLy8gd2Ugb25seSBjaGVjayBhbmQgbm90IHBvcCBoZXJlIHNpbmNlIHdlIGRvbid0IGtub3cgeWV0IHdoZXRoZXIgYSBwZWVyIGlzIGF2YWlsYWJsZS4KICAgICAgICBpZiBzZWxmLnF1ZXVlZF9yZXF1ZXN0cy5pc19lbXB0eSgpIHsKICAgICAgICAgICAgcmV0dXJuIFBvbGxBY3Rpb246Ok5vUmVxdWVzdHMKICAgICAgICB9CgogICAgICAgIGxldCByZXF1ZXN0ID0gc2VsZi5xdWV1ZWRfcmVxdWVzdHMucG9wX2Zyb250KCkuZXhwZWN0KCJub3QgZW1wdHkiKTsKICAgICAgICBsZXQgU29tZShwZWVyX2lkKSA9IHNlbGYubmV4dF9iZXN0X3BlZXIocmVxdWVzdC5iZXN0X3BlZXJfcmVxdWlyZW1lbnRzKCkpIGVsc2UgewogICAgICAgICAgICAvLyBuZWVkIHRvIHB1dCBiYWNrIHRoZSByZXF1ZXN0CiAgICAgICAgICAgIHNlbGYucXVldWVkX3JlcXVlc3RzLnB1c2hfZnJvbnQocmVxdWVzdCk7CiAgICAgICAgICAgIHJldHVybiBQb2xsQWN0aW9uOjpOb1BlZXJzQXZhaWxhYmxlCiAgICAgICAgfTsKCiAgICAgICAgbGV0IHJlcXVlc3QgPSBzZWxmLnByZXBhcmVfYmxvY2tfcmVxdWVzdChwZWVyX2lkLCByZXF1ZXN0KTsKCiAgICAgICAgUG9sbEFjdGlvbjo6UmVhZHkoRmV0Y2hBY3Rpb246OkJsb2NrUmVxdWVzdCB7IHBlZXJfaWQsIHJlcXVlc3QgfSkKICAgIH0KCiAgICAvLy8gQWR2YW5jZSB0aGUgc3RhdGUgdGhlIHN5bmNlcgogICAgcHViKGNyYXRlKSBmbiBwb2xsKCZtdXQgc2VsZiwgY3g6ICZtdXQgQ29udGV4dDwnXz4pIC0+IFBvbGw8RmV0Y2hBY3Rpb24+IHsKICAgICAgICAvLyBkcmFpbiBidWZmZXJlZCBhY3Rpb25zIGZpcnN0CiAgICAgICAgbG9vcCB7CiAgICAgICAgICAgIGxldCBub19wZWVyc19hdmFpbGFibGUgPSBtYXRjaCBzZWxmLnBvbGxfYWN0aW9uKCkgewogICAgICAgICAgICAgICAgUG9sbEFjdGlvbjo6UmVhZHkoYWN0aW9uKSA9PiByZXR1cm4gUG9sbDo6UmVhZHkoYWN0aW9uKSwKICAgICAgICAgICAgICAgIFBvbGxBY3Rpb246Ok5vUmVxdWVzdHMgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICBQb2xsQWN0aW9uOjpOb1BlZXJzQXZhaWxhYmxlID0+IHRydWUsCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBsb29wIHsKICAgICAgICAgICAgICAgIC8vIHBvbGwgaW5jb21pbmcgcmVxdWVzdHMKICAgICAgICAgICAgICAgIG1hdGNoIHNlbGYuZG93bmxvYWRfcmVxdWVzdHNfcngucG9sbF9uZXh0X3VucGluKGN4KSB7CiAgICAgICAgICAgICAgICAgICAgUG9sbDo6UmVhZHkoU29tZShyZXF1ZXN0KSkgPT4gbWF0Y2ggcmVxdWVzdC5nZXRfcHJpb3JpdHkoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIFByaW9yaXR5OjpIaWdoID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpbmQgdGhlIGZpcnN0IG5vcm1hbCByZXF1ZXN0IGFuZCBxdWV1ZSBiZWZvcmUsIGFkZCB0aGlzIHJlcXVlc3QgdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBiYWNrIG9mIHRoZSBoaWdoLXByaW9yaXR5IHF1ZXVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcG9zID0gc2VsZgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5xdWV1ZWRfcmVxdWVzdHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuaXRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnBvc2l0aW9uKHxyZXF8IHJlcS5pc19ub3JtYWxfcHJpb3JpdHkoKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudW53cmFwX29yKDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5xdWV1ZWRfcmVxdWVzdHMuaW5zZXJ0KHBvcywgcmVxdWVzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgUHJpb3JpdHk6Ok5vcm1hbCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnF1ZXVlZF9yZXF1ZXN0cy5wdXNoX2JhY2socmVxdWVzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIFBvbGw6OlJlYWR5KE5vbmUpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdW5yZWFjaGFibGUhKCJjaGFubmVsIGNhbid0IGNsb3NlIikKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgUG9sbDo6UGVuZGluZyA9PiBicmVhaywKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgc2VsZi5xdWV1ZWRfcmVxdWVzdHMuaXNfZW1wdHkoKSB8fCBub19wZWVyc19hdmFpbGFibGUgewogICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlBlbmRpbmcKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLy8gSGFuZGxlcyBhIG5ldyByZXF1ZXN0IHRvIGEgcGVlci4KICAgIC8vLwogICAgLy8vIENhdXRpb246IHRoaXMgYXNzdW1lcyB0aGUgcGVlciBleGlzdHMgYW5kIGlzIGlkbGUKICAgIGZuIHByZXBhcmVfYmxvY2tfcmVxdWVzdCgmbXV0IHNlbGYsIHBlZXJfaWQ6IFBlZXJJZCwgcmVxOiBEb3dubG9hZFJlcXVlc3Q8Tj4pIC0+IEJsb2NrUmVxdWVzdCB7CiAgICAgICAgLy8gdXBkYXRlIHRoZSBwZWVyJ3Mgc3RhdGUKICAgICAgICBpZiBsZXQgU29tZShwZWVyKSA9IHNlbGYucGVlcnMuZ2V0X211dCgmcGVlcl9pZCkgewogICAgICAgICAgICBwZWVyLnN0YXRlID0gcmVxLnBlZXJfc3RhdGUoKTsKICAgICAgICB9CgogICAgICAgIG1hdGNoIHJlcSB7CiAgICAgICAgICAgIERvd25sb2FkUmVxdWVzdDo6R2V0QmxvY2tIZWFkZXJzIHsgcmVxdWVzdCwgcmVzcG9uc2UsIC4uIH0gPT4gewogICAgICAgICAgICAgICAgbGV0IGluZmxpZ2h0ID0gUmVxdWVzdCB7IHJlcXVlc3Q6IHJlcXVlc3QuY2xvbmUoKSwgcmVzcG9uc2UgfTsKICAgICAgICAgICAgICAgIHNlbGYuaW5mbGlnaHRfaGVhZGVyc19yZXF1ZXN0cy5pbnNlcnQocGVlcl9pZCwgaW5mbGlnaHQpOwogICAgICAgICAgICAgICAgbGV0IEhlYWRlcnNSZXF1ZXN0IHsgc3RhcnQsIGxpbWl0LCBkaXJlY3Rpb24gfSA9IHJlcXVlc3Q7CiAgICAgICAgICAgICAgICBCbG9ja1JlcXVlc3Q6OkdldEJsb2NrSGVhZGVycyhHZXRCbG9ja0hlYWRlcnMgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0X2Jsb2NrOiBzdGFydCwKICAgICAgICAgICAgICAgICAgICBsaW1pdCwKICAgICAgICAgICAgICAgICAgICBza2lwOiAwLAogICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbiwKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgRG93bmxvYWRSZXF1ZXN0OjpHZXRCbG9ja0JvZGllcyB7IHJlcXVlc3QsIHJlc3BvbnNlLCAuLiB9ID0+IHsKICAgICAgICAgICAgICAgIGxldCBpbmZsaWdodCA9IFJlcXVlc3QgeyByZXF1ZXN0OiAoKSwgcmVzcG9uc2UgfTsKICAgICAgICAgICAgICAgIHNlbGYuaW5mbGlnaHRfYm9kaWVzX3JlcXVlc3RzLmluc2VydChwZWVyX2lkLCBpbmZsaWdodCk7CiAgICAgICAgICAgICAgICBCbG9ja1JlcXVlc3Q6OkdldEJsb2NrQm9kaWVzKEdldEJsb2NrQm9kaWVzKHJlcXVlc3QpKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgbmV3IGZvbGxvd3VwIHJlcXVlc3QgZm9yIHRoZSBwZWVyLgogICAgLy8vCiAgICAvLy8gQ2F1dGlvbjogdGhpcyBleHBlY3RzIHRoYXQgdGhlIHBlZXIgaXMgX25vdF8gY2xvc2VkLgogICAgZm4gZm9sbG93dXBfcmVxdWVzdCgmbXV0IHNlbGYsIHBlZXJfaWQ6IFBlZXJJZCkgLT4gT3B0aW9uPEJsb2NrUmVzcG9uc2VPdXRjb21lPiB7CiAgICAgICAgbGV0IHJlcSA9IHNlbGYucXVldWVkX3JlcXVlc3RzLnBvcF9mcm9udCgpPzsKICAgICAgICBsZXQgcmVxID0gc2VsZi5wcmVwYXJlX2Jsb2NrX3JlcXVlc3QocGVlcl9pZCwgcmVxKTsKICAgICAgICBTb21lKEJsb2NrUmVzcG9uc2VPdXRjb21lOjpSZXF1ZXN0KHBlZXJfaWQsIHJlcSkpCiAgICB9CgogICAgLy8vIENhbGxlZCBvbiBhIGBHZXRCbG9ja0hlYWRlcnNgIHJlc3BvbnNlIGZyb20gYSBwZWVyLgogICAgLy8vCiAgICAvLy8gVGhpcyBkZWxlZ2F0ZXMgdGhlIHJlc3BvbnNlIGFuZCByZXR1cm5zIGEgW2BCbG9ja1Jlc3BvbnNlT3V0Y29tZWBdIHRvIGVpdGhlciBxdWV1ZSBpbiBhCiAgICAvLy8gZGlyZWN0IGZvbGxvd3VwIHJlcXVlc3Qgb3IgZ2V0IHRoZSBwZWVyIHJlcG9ydGVkIGlmIHRoZSByZXNwb25zZSB3YXMgYQogICAgLy8vIFtgRXRoUmVzcG9uc2VWYWxpZGF0b3I6OnJlcHV0YXRpb25fY2hhbmdlX2VycmBdCiAgICBwdWIoY3JhdGUpIGZuIG9uX2Jsb2NrX2hlYWRlcnNfcmVzcG9uc2UoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHBlZXJfaWQ6IFBlZXJJZCwKICAgICAgICByZXM6IFJlcXVlc3RSZXN1bHQ8VmVjPE46OkJsb2NrSGVhZGVyPj4sCiAgICApIC0+IE9wdGlvbjxCbG9ja1Jlc3BvbnNlT3V0Y29tZT4gewogICAgICAgIGxldCBpc19lcnJvciA9IHJlcy5pc19lcnIoKTsKICAgICAgICBsZXQgbWF5YmVfcmVwdXRhdGlvbl9jaGFuZ2UgPSByZXMucmVwdXRhdGlvbl9jaGFuZ2VfZXJyKCk7CgogICAgICAgIGxldCByZXNwID0gc2VsZi5pbmZsaWdodF9oZWFkZXJzX3JlcXVlc3RzLnJlbW92ZSgmcGVlcl9pZCk7CgogICAgICAgIGxldCBpc19saWtlbHlfYmFkX3Jlc3BvbnNlID0KICAgICAgICAgICAgcmVzcC5hc19yZWYoKS5pc19zb21lX2FuZCh8cnwgcmVzLmlzX2xpa2VseV9iYWRfaGVhZGVyc19yZXNwb25zZSgmci5yZXF1ZXN0KSk7CgogICAgICAgIGlmIGxldCBTb21lKHJlc3ApID0gcmVzcCB7CiAgICAgICAgICAgIC8vIGRlbGVnYXRlIHRoZSByZXNwb25zZQogICAgICAgICAgICBsZXQgXyA9IHJlc3AucmVzcG9uc2Uuc2VuZChyZXMubWFwKHxofCAocGVlcl9pZCwgaCkuaW50bygpKSk7CiAgICAgICAgfQoKICAgICAgICBpZiBsZXQgU29tZShwZWVyKSA9IHNlbGYucGVlcnMuZ2V0X211dCgmcGVlcl9pZCkgewogICAgICAgICAgICAvLyB1cGRhdGUgdGhlIHBlZXIncyByZXNwb25zZSBzdGF0ZQogICAgICAgICAgICBwZWVyLmxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZCA9IGlzX2xpa2VseV9iYWRfcmVzcG9uc2U7CgogICAgICAgICAgICAvLyBJZiB0aGUgcGVlciBpcyBzdGlsbCByZWFkeSB0byBhY2NlcHQgbmV3IHJlcXVlc3RzLCB3ZSB0cnkgdG8gc2VuZCBhIGZvbGxvd3VwCiAgICAgICAgICAgIC8vIHJlcXVlc3QgaW1tZWRpYXRlbHkuCiAgICAgICAgICAgIGlmIHBlZXIuc3RhdGUub25fcmVxdWVzdF9maW5pc2hlZCgpICYmICFpc19lcnJvciAmJiAhaXNfbGlrZWx5X2JhZF9yZXNwb25zZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5mb2xsb3d1cF9yZXF1ZXN0KHBlZXJfaWQpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGlmIHRoZSByZXNwb25zZSB3YXMgYW4gYEVycmAgd29ydGggcmVwb3J0aW5nIHRoZSBwZWVyIGZvciB0aGVuIHdlIHJldHVybiBhIGBCYWRSZXNwb25zZWAKICAgICAgICAvLyBvdXRjb21lCiAgICAgICAgbWF5YmVfcmVwdXRhdGlvbl9jaGFuZ2UKICAgICAgICAgICAgLm1hcCh8cmVwdXRhdGlvbl9jaGFuZ2V8IEJsb2NrUmVzcG9uc2VPdXRjb21lOjpCYWRSZXNwb25zZShwZWVyX2lkLCByZXB1dGF0aW9uX2NoYW5nZSkpCiAgICB9CgogICAgLy8vIENhbGxlZCBvbiBhIGBHZXRCbG9ja0JvZGllc2AgcmVzcG9uc2UgZnJvbSBhIHBlZXIKICAgIHB1YihjcmF0ZSkgZm4gb25fYmxvY2tfYm9kaWVzX3Jlc3BvbnNlKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBwZWVyX2lkOiBQZWVySWQsCiAgICAgICAgcmVzOiBSZXF1ZXN0UmVzdWx0PFZlYzxOOjpCbG9ja0JvZHk+PiwKICAgICkgLT4gT3B0aW9uPEJsb2NrUmVzcG9uc2VPdXRjb21lPiB7CiAgICAgICAgbGV0IGlzX2xpa2VseV9iYWRfcmVzcG9uc2UgPSByZXMuYXNfcmVmKCkubWFwX29yKHRydWUsIHxib2RpZXN8IGJvZGllcy5pc19lbXB0eSgpKTsKCiAgICAgICAgaWYgbGV0IFNvbWUocmVzcCkgPSBzZWxmLmluZmxpZ2h0X2JvZGllc19yZXF1ZXN0cy5yZW1vdmUoJnBlZXJfaWQpIHsKICAgICAgICAgICAgbGV0IF8gPSByZXNwLnJlc3BvbnNlLnNlbmQocmVzLm1hcCh8YnwgKHBlZXJfaWQsIGIpLmludG8oKSkpOwogICAgICAgIH0KICAgICAgICBpZiBsZXQgU29tZShwZWVyKSA9IHNlbGYucGVlcnMuZ2V0X211dCgmcGVlcl9pZCkgewogICAgICAgICAgICAvLyB1cGRhdGUgdGhlIHBlZXIncyByZXNwb25zZSBzdGF0ZQogICAgICAgICAgICBwZWVyLmxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZCA9IGlzX2xpa2VseV9iYWRfcmVzcG9uc2U7CgogICAgICAgICAgICBpZiBwZWVyLnN0YXRlLm9uX3JlcXVlc3RfZmluaXNoZWQoKSAmJiAhaXNfbGlrZWx5X2JhZF9yZXNwb25zZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5mb2xsb3d1cF9yZXF1ZXN0KHBlZXJfaWQpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgTm9uZQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgbmV3IFtgRmV0Y2hDbGllbnRgXSB0aGF0IGNhbiBzZW5kIHJlcXVlc3RzIHRvIHRoaXMgdHlwZS4KICAgIHB1YihjcmF0ZSkgZm4gY2xpZW50KCZzZWxmKSAtPiBGZXRjaENsaWVudDxOPiB7CiAgICAgICAgRmV0Y2hDbGllbnQgewogICAgICAgICAgICByZXF1ZXN0X3R4OiBzZWxmLmRvd25sb2FkX3JlcXVlc3RzX3R4LmNsb25lKCksCiAgICAgICAgICAgIHBlZXJzX2hhbmRsZTogc2VsZi5wZWVyc19oYW5kbGUuY2xvbmUoKSwKICAgICAgICAgICAgbnVtX2FjdGl2ZV9wZWVyczogQXJjOjpjbG9uZSgmc2VsZi5udW1fYWN0aXZlX3BlZXJzKSwKICAgICAgICB9CiAgICB9Cn0KCi8vLyBUaGUgb3V0Y29tZSBvZiBbYFN0YXRlRmV0Y2hlcjo6cG9sbF9hY3Rpb25gXQplbnVtIFBvbGxBY3Rpb24gewogICAgUmVhZHkoRmV0Y2hBY3Rpb24pLAogICAgTm9SZXF1ZXN0cywKICAgIE5vUGVlcnNBdmFpbGFibGUsCn0KCi8vLyBSZXByZXNlbnRzIGEgY29ubmVjdGVkIHBlZXIKI1tkZXJpdmUoRGVidWcpXQpzdHJ1Y3QgUGVlciB7CiAgICAvLy8gVGhlIHN0YXRlIHRoaXMgcGVlciBjdXJyZW50bHkgcmVzaWRlcyBpbi4KICAgIHN0YXRlOiBQZWVyU3RhdGUsCiAgICAvLy8gQmVzdCBrbm93biBoYXNoIHRoYXQgdGhlIHBlZXIgaGFzCiAgICBiZXN0X2hhc2g6IEIyNTYsCiAgICAvLy8gVHJhY2tzIHRoZSBiZXN0IG51bWJlciBvZiB0aGUgcGVlci4KICAgIGJlc3RfbnVtYmVyOiB1NjQsCiAgICAvLy8gQ2FwYWJpbGl0aWVzIGFubm91bmNlZCBieSB0aGUgcGVlci4KICAgICNbYWxsb3coZGVhZF9jb2RlKV0KICAgIGNhcGFiaWxpdGllczogQXJjPENhcGFiaWxpdGllcz4sCiAgICAvLy8gVHJhY2tzIHRoZSBjdXJyZW50IHRpbWVvdXQgdmFsdWUgd2UgdXNlIGZvciB0aGUgcGVlci4KICAgIHRpbWVvdXQ6IEFyYzxBdG9taWNVNjQ+LAogICAgLy8vIFRyYWNrcyB3aGV0aGVyIHRoZSBwZWVyIGhhcyByZWNlbnRseSByZXNwb25kZWQgd2l0aCBhIGxpa2VseSBiYWQgcmVzcG9uc2UuCiAgICAvLy8KICAgIC8vLyBUaGlzIGlzIHVzZWQgdG8gZGUtcmFuayB0aGUgcGVlciBpZiB0aGVyZSBhcmUgb3RoZXIgcGVlcnMgYXZhaWxhYmxlLgogICAgLy8vIFRoaXMgZXhpc3RzIGJlY2F1c2UgZW1wdHkgcmVzcG9uc2VzIG1heSBub3QgYmUgcGVuYWxpemVkIChlLmcuIHdoZW4gYmxvY2tzIG5lYXIgdGhlIHRpcCBhcmUKICAgIC8vLyBkb3dubG9hZGVkKSwgYnV0IHdlIHN0aWxsIHdhbnQgdG8gYXZvaWQgcmVxdWVzdGluZyBmcm9tIHRoZSBzYW1lIHBlZXIgYWdhaW4gaWYgaXQgaGFzIHRoZQogICAgLy8vIGxvd2VzdCB0aW1lb3V0LgogICAgbGFzdF9yZXNwb25zZV9saWtlbHlfYmFkOiBib29sLAogICAgLy8vIFRyYWNrcyB0aGUgcmFuZ2UgaW5mbyBmb3IgdGhlIHBlZXIuCiAgICByYW5nZV9pbmZvOiBPcHRpb248QmxvY2tSYW5nZUluZm8+LAp9CgppbXBsIFBlZXIgewogICAgZm4gdGltZW91dCgmc2VsZikgLT4gdTY0IHsKICAgICAgICBzZWxmLnRpbWVvdXQubG9hZChPcmRlcmluZzo6UmVsYXhlZCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgZWFybGllc3QgYmxvY2sgbnVtYmVyIGF2YWlsYWJsZSBmcm9tIHRoZSBwZWVyLgogICAgZm4gZWFybGllc3QoJnNlbGYpIC0+IHU2NCB7CiAgICAgICAgc2VsZi5yYW5nZV9pbmZvLmFzX3JlZigpLm1hcF9vcigwLCB8aW5mb3wgaW5mby5lYXJsaWVzdCgpKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRydWUgaWYgdGhlIHBlZXIgaGFzIHRoZSBmdWxsIGhpc3RvcnkgYXZhaWxhYmxlLgogICAgZm4gaGFzX2Z1bGxfaGlzdG9yeSgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgc2VsZi5lYXJsaWVzdCgpID09IDAKICAgIH0KCiAgICBmbiByYW5nZSgmc2VsZikgLT4gT3B0aW9uPFJhbmdlSW5jbHVzaXZlPHU2ND4+IHsKICAgICAgICBzZWxmLnJhbmdlX2luZm8uYXNfcmVmKCkubWFwKHxpbmZvfCBpbmZvLnJhbmdlKCkpCiAgICB9CgogICAgLy8vIFJldHVybnMgdHJ1ZSBpZiB0aGlzIHBlZXIgaGFzIGEgYmV0dGVyIHJhbmdlIHRoYW4gdGhlIG90aGVyIHBlZXIgZm9yIHNlcnZpbmcgdGhlIHJlcXVlc3RlZAogICAgLy8vIHJhbmdlLgogICAgLy8vCiAgICAvLy8gQSBwZWVyIGhhcyBhICJiZXR0ZXIgcmFuZ2UiIGlmOgogICAgLy8vIDEuIEl0IGNhbiBmdWxseSBjb3ZlciB0aGUgcmVxdWVzdGVkIHJhbmdlIHdoaWxlIHRoZSBvdGhlciBjYW5ub3QKICAgIC8vLyAyLiBOb25lIGNhbiBmdWxseSBjb3ZlciB0aGUgcmFuZ2UsIGJ1dCB0aGlzIHBlZXIgaGFzIGxvd2VyIHN0YXJ0IHZhbHVlCiAgICAvLy8gMy4gSWYgYSBwZWVyIGRvZXNuJ3QgYW5ub3VuY2UgYSByYW5nZSB3ZSBhc3N1bWUgaXQgaGFzIGZ1bGwgaGlzdG9yeSwgYnV0IGNoZWNrIHRoZSBvdGhlcidzCiAgICAvLy8gICAgcmFuZ2UgYW5kIHRyZWF0IHRoYXQgYXMgYmV0dGVyIGlmIGl0IGNhbiBjb3ZlciB0aGUgcmFuZ2UKICAgIGZuIGhhc19iZXR0ZXJfcmFuZ2UoJnNlbGYsIG90aGVyOiAmU2VsZiwgcmFuZ2U6ICZSYW5nZUluY2x1c2l2ZTx1NjQ+KSAtPiBib29sIHsKICAgICAgICBsZXQgc2VsZl9yYW5nZSA9IHNlbGYucmFuZ2UoKTsKICAgICAgICBsZXQgb3RoZXJfcmFuZ2UgPSBvdGhlci5yYW5nZSgpOwoKICAgICAgICBtYXRjaCAoc2VsZl9yYW5nZSwgb3RoZXJfcmFuZ2UpIHsKICAgICAgICAgICAgKFNvbWUoc2VsZl9yKSwgU29tZShvdGhlcl9yKSkgPT4gewogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgZWFjaCBwZWVyIGNhbiBmdWxseSBjb3ZlciB0aGUgcmVxdWVzdGVkIHJhbmdlCiAgICAgICAgICAgICAgICBsZXQgc2VsZl9jb3ZlcnMgPSBzZWxmX3IuY29udGFpbnMocmFuZ2Uuc3RhcnQoKSkgJiYgc2VsZl9yLmNvbnRhaW5zKHJhbmdlLmVuZCgpKTsKICAgICAgICAgICAgICAgIGxldCBvdGhlcl9jb3ZlcnMgPSBvdGhlcl9yLmNvbnRhaW5zKHJhbmdlLnN0YXJ0KCkpICYmIG90aGVyX3IuY29udGFpbnMocmFuZ2UuZW5kKCkpOwoKICAgICAgICAgICAgICAgICNbYWxsb3coY2xpcHB5OjptYXRjaF9zYW1lX2FybXMpXQogICAgICAgICAgICAgICAgbWF0Y2ggKHNlbGZfY292ZXJzLCBvdGhlcl9jb3ZlcnMpIHsKICAgICAgICAgICAgICAgICAgICAodHJ1ZSwgZmFsc2UpID0+IHRydWUsICAvLyBPbmx5IHNlbGYgY292ZXJzIHRoZSByYW5nZQogICAgICAgICAgICAgICAgICAgIChmYWxzZSwgdHJ1ZSkgPT4gZmFsc2UsIC8vIE9ubHkgb3RoZXIgY292ZXJzIHRoZSByYW5nZQogICAgICAgICAgICAgICAgICAgICh0cnVlLCB0cnVlKSA9PiBmYWxzZSwgIC8vIEJvdGggY292ZXIKICAgICAgICAgICAgICAgICAgICAoZmFsc2UsIGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5laXRoZXIgY292ZXJzIC0gcHJlZmVyIGlmIHBlZXIgaGFzIGxvd2VyIChiZXR0ZXIpIHN0YXJ0IHJhbmdlCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGZfci5zdGFydCgpIDwgb3RoZXJfci5zdGFydCgpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIChTb21lKHNlbGZfciksIE5vbmUpID0+IHsKICAgICAgICAgICAgICAgIC8vIFNlbGYgaGFzIHJhbmdlIGluZm8sIG90aGVyIGRvZXNuJ3QgKHRyZWF0ZWQgYXMgZnVsbCBoaXN0b3J5IHdpdGggdW5rbm93biBsYXRlc3QpCiAgICAgICAgICAgICAgICAvLyBTZWxmIGlzIGJldHRlciBvbmx5IGlmIGl0IGNvdmVycyB0aGUgcmFuZ2UKICAgICAgICAgICAgICAgIHNlbGZfci5jb250YWlucyhyYW5nZS5zdGFydCgpKSAmJiBzZWxmX3IuY29udGFpbnMocmFuZ2UuZW5kKCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgKE5vbmUsIFNvbWUob3RoZXJfcikpID0+IHsKICAgICAgICAgICAgICAgIC8vIFNlbGYgaGFzIG5vIHJhbmdlIGluZm8gKGZ1bGwgaGlzdG9yeSksIG90aGVyIGhhcyByYW5nZSBpbmZvCiAgICAgICAgICAgICAgICAvLyBTZWxmIGlzIGJldHRlciBvbmx5IGlmIG90aGVyIGRvZXNuJ3QgY292ZXIgdGhlIHJhbmdlCiAgICAgICAgICAgICAgICAhKG90aGVyX3IuY29udGFpbnMocmFuZ2Uuc3RhcnQoKSkgJiYgb3RoZXJfci5jb250YWlucyhyYW5nZS5lbmQoKSkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgKE5vbmUsIE5vbmUpID0+IGZhbHNlLCAvLyBOZWl0aGVyIGhhcyByYW5nZSBpbmZvIC0gbm8gb25lIGlzIGJldHRlcgogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0cnVlIGlmIHRoaXMgcGVlciBpcyBiZXR0ZXIgdGhhbiB0aGUgb3RoZXIgcGVlciBiYXNlZCBvbiB0aGUgZ2l2ZW4gcmVxdWlyZW1lbnRzLgogICAgZm4gaXNfYmV0dGVyKCZzZWxmLCBvdGhlcjogJlNlbGYsIHJlcXVpcmVtZW50OiAmQmVzdFBlZXJSZXF1aXJlbWVudHMpIC0+IGJvb2wgewogICAgICAgIG1hdGNoIHJlcXVpcmVtZW50IHsKICAgICAgICAgICAgQmVzdFBlZXJSZXF1aXJlbWVudHM6Ok5vbmUgPT4gZmFsc2UsCiAgICAgICAgICAgIEJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2tSYW5nZShyYW5nZSkgPT4gc2VsZi5oYXNfYmV0dGVyX3JhbmdlKG90aGVyLCByYW5nZSksCiAgICAgICAgICAgIEJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2sgPT4gc2VsZi5oYXNfZnVsbF9oaXN0b3J5KCkgJiYgIW90aGVyLmhhc19mdWxsX2hpc3RvcnkoKSwKICAgICAgICB9CiAgICB9Cn0KCi8vLyBUcmFja3MgdGhlIHN0YXRlIG9mIGFuIGluZGl2aWR1YWwgcGVlcgojW2Rlcml2ZShEZWJ1ZyldCmVudW0gUGVlclN0YXRlIHsKICAgIC8vLyBQZWVyIGlzIGN1cnJlbnRseSBub3QgaGFuZGxpbmcgcmVxdWVzdHMgYW5kIGlzIGF2YWlsYWJsZS4KICAgIElkbGUsCiAgICAvLy8gUGVlciBpcyBoYW5kbGluZyBhIGBHZXRCbG9ja0hlYWRlcnNgIHJlcXVlc3QuCiAgICBHZXRCbG9ja0hlYWRlcnMsCiAgICAvLy8gUGVlciBpcyBoYW5kbGluZyBhIGBHZXRCbG9ja0JvZGllc2AgcmVxdWVzdC4KICAgIEdldEJsb2NrQm9kaWVzLAogICAgLy8vIFBlZXIgc2Vzc2lvbiBpcyBhYm91dCB0byBjbG9zZQogICAgQ2xvc2luZywKfQoKLy8gPT09IGltcGwgUGVlclN0YXRlID09PQoKaW1wbCBQZWVyU3RhdGUgewogICAgLy8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgcGVlciBpcyBjdXJyZW50bHkgaWRsZS4KICAgIGNvbnN0IGZuIGlzX2lkbGUoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIG1hdGNoZXMhKHNlbGYsIFNlbGY6OklkbGUpCiAgICB9CgogICAgLy8vIFJlc2V0cyB0aGUgc3RhdGUgb24gYSByZWNlaXZlZCByZXNwb25zZS4KICAgIC8vLwogICAgLy8vIElmIHRoZSBzdGF0ZSB3YXMgYWxyZWFkeSBtYXJrZWQgYXMgYENsb3NpbmdgIGRvIG5vdGhpbmcuCiAgICAvLy8KICAgIC8vLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgcGVlciBpcyByZWFkeSBmb3IgYW5vdGhlciByZXF1ZXN0LgogICAgY29uc3QgZm4gb25fcmVxdWVzdF9maW5pc2hlZCgmbXV0IHNlbGYpIC0+IGJvb2wgewogICAgICAgIGlmICFtYXRjaGVzIShzZWxmLCBTZWxmOjpDbG9zaW5nKSB7CiAgICAgICAgICAgICpzZWxmID0gU2VsZjo6SWRsZTsKICAgICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9CiAgICAgICAgZmFsc2UKICAgIH0KfQoKLy8vIEEgcmVxdWVzdCB0aGF0IHdhaXRzIGZvciBhIHJlc3BvbnNlIGZyb20gdGhlIG5ldHdvcmssIHNvIGl0IGNhbiBzZW5kIGl0IGJhY2sgdGhyb3VnaCB0aGUKLy8vIHJlc3BvbnNlIGNoYW5uZWwuCiNbZGVyaXZlKERlYnVnKV0Kc3RydWN0IFJlcXVlc3Q8UmVxLCBSZXNwPiB7CiAgICAvLy8gVGhlIGlzc3VlZCByZXF1ZXN0IG9iamVjdAogICAgLy8gVE9ETzogdGhpcyBjYW4gYmUgYXR0YWNoZWQgdG8gdGhlIHJlc3BvbnNlIGluIGVycm9yIGNhc2UKICAgIHJlcXVlc3Q6IFJlcSwKICAgIHJlc3BvbnNlOiBvbmVzaG90OjpTZW5kZXI8UmVzcD4sCn0KCi8vLyBSZXF1ZXN0cyB0aGF0IGNhbiBiZSBzZW50IHRvIHRoZSBTeW5jZXIgZnJvbSBhIFtgRmV0Y2hDbGllbnRgXQojW2Rlcml2ZShEZWJ1ZyldCnB1YihjcmF0ZSkgZW51bSBEb3dubG9hZFJlcXVlc3Q8TjogTmV0d29ya1ByaW1pdGl2ZXM+IHsKICAgIC8vLyBEb3dubG9hZCB0aGUgcmVxdWVzdGVkIGhlYWRlcnMgYW5kIHNlbmQgcmVzcG9uc2UgdGhyb3VnaCBjaGFubmVsCiAgICBHZXRCbG9ja0hlYWRlcnMgewogICAgICAgIHJlcXVlc3Q6IEhlYWRlcnNSZXF1ZXN0LAogICAgICAgIHJlc3BvbnNlOiBvbmVzaG90OjpTZW5kZXI8UGVlclJlcXVlc3RSZXN1bHQ8VmVjPE46OkJsb2NrSGVhZGVyPj4+LAogICAgICAgIHByaW9yaXR5OiBQcmlvcml0eSwKICAgIH0sCiAgICAvLy8gRG93bmxvYWQgdGhlIHJlcXVlc3RlZCBoZWFkZXJzIGFuZCBzZW5kIHJlc3BvbnNlIHRocm91Z2ggY2hhbm5lbAogICAgR2V0QmxvY2tCb2RpZXMgewogICAgICAgIHJlcXVlc3Q6IFZlYzxCMjU2PiwKICAgICAgICByZXNwb25zZTogb25lc2hvdDo6U2VuZGVyPFBlZXJSZXF1ZXN0UmVzdWx0PFZlYzxOOjpCbG9ja0JvZHk+Pj4sCiAgICAgICAgcHJpb3JpdHk6IFByaW9yaXR5LAogICAgICAgIHJhbmdlX2hpbnQ6IE9wdGlvbjxSYW5nZUluY2x1c2l2ZTx1NjQ+PiwKICAgIH0sCn0KCi8vID09PSBpbXBsIERvd25sb2FkUmVxdWVzdCA9PT0KCmltcGw8TjogTmV0d29ya1ByaW1pdGl2ZXM+IERvd25sb2FkUmVxdWVzdDxOPiB7CiAgICAvLy8gUmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyBzdGF0ZSBmb3IgYSBwZWVyIHRoYXQgaGFuZGxlcyB0aGUgcmVxdWVzdC4KICAgIGNvbnN0IGZuIHBlZXJfc3RhdGUoJnNlbGYpIC0+IFBlZXJTdGF0ZSB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkdldEJsb2NrSGVhZGVycyB7IC4uIH0gPT4gUGVlclN0YXRlOjpHZXRCbG9ja0hlYWRlcnMsCiAgICAgICAgICAgIFNlbGY6OkdldEJsb2NrQm9kaWVzIHsgLi4gfSA9PiBQZWVyU3RhdGU6OkdldEJsb2NrQm9kaWVzLAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgcmVxdWVzdGVkIHByaW9yaXR5IG9mIHRoaXMgcmVxdWVzdAogICAgY29uc3QgZm4gZ2V0X3ByaW9yaXR5KCZzZWxmKSAtPiAmUHJpb3JpdHkgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpHZXRCbG9ja0hlYWRlcnMgeyBwcmlvcml0eSwgLi4gfSB8IFNlbGY6OkdldEJsb2NrQm9kaWVzIHsgcHJpb3JpdHksIC4uIH0gPT4gewogICAgICAgICAgICAgICAgcHJpb3JpdHkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhpcyByZXF1ZXN0IGlzIG5vcm1hbCBwcmlvcml0eS4KICAgIGNvbnN0IGZuIGlzX25vcm1hbF9wcmlvcml0eSgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgc2VsZi5nZXRfcHJpb3JpdHkoKS5pc19ub3JtYWwoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBiZXN0IHBlZXIgcmVxdWlyZW1lbnRzIGZvciB0aGlzIHJlcXVlc3QuCiAgICBmbiBiZXN0X3BlZXJfcmVxdWlyZW1lbnRzKCZzZWxmKSAtPiBCZXN0UGVlclJlcXVpcmVtZW50cyB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkdldEJsb2NrSGVhZGVycyB7IC4uIH0gPT4gQmVzdFBlZXJSZXF1aXJlbWVudHM6Ok5vbmUsCiAgICAgICAgICAgIFNlbGY6OkdldEJsb2NrQm9kaWVzIHsgcmFuZ2VfaGludCwgLi4gfSA9PiB7CiAgICAgICAgICAgICAgICBpZiBsZXQgU29tZShyYW5nZSkgPSByYW5nZV9oaW50IHsKICAgICAgICAgICAgICAgICAgICBCZXN0UGVlclJlcXVpcmVtZW50czo6RnVsbEJsb2NrUmFuZ2UocmFuZ2UuY2xvbmUoKSkKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgQmVzdFBlZXJSZXF1aXJlbWVudHM6OkZ1bGxCbG9jawogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLy8gQW4gYWN0aW9uIHRoZSBzeW5jZXIgY2FuIGVtaXQuCnB1YihjcmF0ZSkgZW51bSBGZXRjaEFjdGlvbiB7CiAgICAvLy8gRGlzcGF0Y2ggYW4gZXRoIHJlcXVlc3QgdG8gdGhlIGdpdmVuIHBlZXIuCiAgICBCbG9ja1JlcXVlc3QgewogICAgICAgIC8vLyBUaGUgdGFyZ2V0ZWQgcmVjaXBpZW50IGZvciB0aGUgcmVxdWVzdAogICAgICAgIHBlZXJfaWQ6IFBlZXJJZCwKICAgICAgICAvLy8gVGhlIHJlcXVlc3QgdG8gc2VuZAogICAgICAgIHJlcXVlc3Q6IEJsb2NrUmVxdWVzdCwKICAgIH0sCn0KCi8vLyBPdXRjb21lIG9mIGEgcHJvY2Vzc2VkIHJlc3BvbnNlLgovLy8KLy8vIFJldHVybmVkIGFmdGVyIHByb2Nlc3NpbmcgYSByZXNwb25zZS4KI1tkZXJpdmUoRGVidWcsIFBhcnRpYWxFcSwgRXEpXQpwdWIoY3JhdGUpIGVudW0gQmxvY2tSZXNwb25zZU91dGNvbWUgewogICAgLy8vIENvbnRpbnVlIHdpdGggYW5vdGhlciByZXF1ZXN0IHRvIHRoZSBwZWVyLgogICAgUmVxdWVzdChQZWVySWQsIEJsb2NrUmVxdWVzdCksCiAgICAvLy8gSG93IHRvIGhhbmRsZSBhIGJhZCByZXNwb25zZSBhbmQgdGhlIHJlcHV0YXRpb24gY2hhbmdlIHRvIGFwcGx5LCBpZiBhbnkuCiAgICBCYWRSZXNwb25zZShQZWVySWQsIFJlcHV0YXRpb25DaGFuZ2VLaW5kKSwKfQoKLy8vIEFkZGl0aW9uYWwgcmVxdWlyZW1lbnRzIGZvciBob3cgdG8gcmFuayBwZWVycyBkdXJpbmcgc2VsZWN0aW9uLgplbnVtIEJlc3RQZWVyUmVxdWlyZW1lbnRzIHsKICAgIC8vLyBObyBhZGRpdGlvbmFsIHJlcXVpcmVtZW50cwogICAgTm9uZSwKICAgIC8vLyBQZWVyIG11c3QgaGF2ZSB0aGlzIGJsb2NrIHJhbmdlIGF2YWlsYWJsZS4KICAgIEZ1bGxCbG9ja1JhbmdlKFJhbmdlSW5jbHVzaXZlPHU2ND4pLAogICAgLy8vIFBlZXIgbXVzdCBoYXZlIGZ1bGwgcmFuZ2UuCiAgICBGdWxsQmxvY2ssCn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdHMgewogICAgdXNlIHN1cGVyOjoqOwogICAgdXNlIGNyYXRlOjp7cGVlcnM6OlBlZXJzTWFuYWdlciwgUGVlcnNDb25maWd9OwogICAgdXNlIGFsbG95X2NvbnNlbnN1czo6SGVhZGVyOwogICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkI1MTI7CiAgICB1c2Ugc3RkOjpmdXR1cmU6OnBvbGxfZm47CgogICAgI1t0b2tpbzo6dGVzdChmbGF2b3IgPSAibXVsdGlfdGhyZWFkIildCiAgICBhc3luYyBmbiB0ZXN0X3BvbGxfZmV0Y2hlcigpIHsKICAgICAgICBsZXQgbWFuYWdlciA9IFBlZXJzTWFuYWdlcjo6bmV3KFBlZXJzQ29uZmlnOjpkZWZhdWx0KCkpOwogICAgICAgIGxldCBtdXQgZmV0Y2hlciA9CiAgICAgICAgICAgIFN0YXRlRmV0Y2hlcjo6PEV0aE5ldHdvcmtQcmltaXRpdmVzPjo6bmV3KG1hbmFnZXIuaGFuZGxlKCksIERlZmF1bHQ6OmRlZmF1bHQoKSk7CgogICAgICAgIHBvbGxfZm4obW92ZSB8Y3h8IHsKICAgICAgICAgICAgYXNzZXJ0IShmZXRjaGVyLnBvbGwoY3gpLmlzX3BlbmRpbmcoKSk7CiAgICAgICAgICAgIGxldCAodHgsIF9yeCkgPSBvbmVzaG90OjpjaGFubmVsKCk7CiAgICAgICAgICAgIGZldGNoZXIucXVldWVkX3JlcXVlc3RzLnB1c2hfYmFjayhEb3dubG9hZFJlcXVlc3Q6OkdldEJsb2NrQm9kaWVzIHsKICAgICAgICAgICAgICAgIHJlcXVlc3Q6IHZlYyFbXSwKICAgICAgICAgICAgICAgIHJlc3BvbnNlOiB0eCwKICAgICAgICAgICAgICAgIHByaW9yaXR5OiBQcmlvcml0eTo6ZGVmYXVsdCgpLAogICAgICAgICAgICAgICAgcmFuZ2VfaGludDogTm9uZSwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFzc2VydCEoZmV0Y2hlci5wb2xsKGN4KS5pc19wZW5kaW5nKCkpOwoKICAgICAgICAgICAgUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgfSkKICAgICAgICAuYXdhaXQ7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfcGVlcl9yb3RhdGlvbigpIHsKICAgICAgICBsZXQgbWFuYWdlciA9IFBlZXJzTWFuYWdlcjo6bmV3KFBlZXJzQ29uZmlnOjpkZWZhdWx0KCkpOwogICAgICAgIGxldCBtdXQgZmV0Y2hlciA9CiAgICAgICAgICAgIFN0YXRlRmV0Y2hlcjo6PEV0aE5ldHdvcmtQcmltaXRpdmVzPjo6bmV3KG1hbmFnZXIuaGFuZGxlKCksIERlZmF1bHQ6OmRlZmF1bHQoKSk7CiAgICAgICAgLy8gQWRkIGEgZmV3IHJhbmRvbSBwZWVycwogICAgICAgIGxldCBwZWVyMSA9IEI1MTI6OnJhbmRvbSgpOwogICAgICAgIGxldCBwZWVyMiA9IEI1MTI6OnJhbmRvbSgpOwogICAgICAgIGxldCBjYXBhYmlsaXRpZXMgPSBBcmM6Om5ldyhDYXBhYmlsaXRpZXM6OmZyb20odmVjIVtdKSk7CiAgICAgICAgZmV0Y2hlci5uZXdfYWN0aXZlX3BlZXIoCiAgICAgICAgICAgIHBlZXIxLAogICAgICAgICAgICBCMjU2OjpyYW5kb20oKSwKICAgICAgICAgICAgMSwKICAgICAgICAgICAgQXJjOjpjbG9uZSgmY2FwYWJpbGl0aWVzKSwKICAgICAgICAgICAgQXJjOjpuZXcoQXRvbWljVTY0OjpuZXcoMSkpLAogICAgICAgICAgICBOb25lLAogICAgICAgICk7CiAgICAgICAgZmV0Y2hlci5uZXdfYWN0aXZlX3BlZXIoCiAgICAgICAgICAgIHBlZXIyLAogICAgICAgICAgICBCMjU2OjpyYW5kb20oKSwKICAgICAgICAgICAgMiwKICAgICAgICAgICAgQXJjOjpjbG9uZSgmY2FwYWJpbGl0aWVzKSwKICAgICAgICAgICAgQXJjOjpuZXcoQXRvbWljVTY0OjpuZXcoMSkpLAogICAgICAgICAgICBOb25lLAogICAgICAgICk7CgogICAgICAgIGxldCBmaXJzdF9wZWVyID0gZmV0Y2hlci5uZXh0X2Jlc3RfcGVlcihCZXN0UGVlclJlcXVpcmVtZW50czo6Tm9uZSkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0IShmaXJzdF9wZWVyID09IHBlZXIxIHx8IGZpcnN0X3BlZXIgPT0gcGVlcjIpOwogICAgICAgIC8vIFBlbmRpbmcgZGlzY29ubmVjdCBmb3IgZmlyc3RfcGVlcgogICAgICAgIGZldGNoZXIub25fcGVuZGluZ19kaXNjb25uZWN0KCZmaXJzdF9wZWVyKTsKICAgICAgICAvLyBmaXJzdF9wZWVyIG5vdyBpc24ndCBpZGxlLCBzbyB3ZSBzaG91bGQgZ2V0IG90aGVyIHBlZXIKICAgICAgICBsZXQgc2Vjb25kX3BlZXIgPSBmZXRjaGVyLm5leHRfYmVzdF9wZWVyKEJlc3RQZWVyUmVxdWlyZW1lbnRzOjpOb25lKS51bndyYXAoKTsKICAgICAgICBhc3NlcnQhKGZpcnN0X3BlZXIgPT0gcGVlcjEgfHwgZmlyc3RfcGVlciA9PSBwZWVyMik7CiAgICAgICAgYXNzZXJ0X25lIShmaXJzdF9wZWVyLCBzZWNvbmRfcGVlcik7CiAgICAgICAgLy8gd2l0aG91dCBpZGxlIHBlZXJzLCByZXR1cm5zIE5vbmUKICAgICAgICBmZXRjaGVyLm9uX3BlbmRpbmdfZGlzY29ubmVjdCgmc2Vjb25kX3BlZXIpOwogICAgICAgIGFzc2VydF9lcSEoZmV0Y2hlci5uZXh0X2Jlc3RfcGVlcihCZXN0UGVlclJlcXVpcmVtZW50czo6Tm9uZSksIE5vbmUpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X3BlZXJfcHJpb3JpdGl6YXRpb24oKSB7CiAgICAgICAgbGV0IG1hbmFnZXIgPSBQZWVyc01hbmFnZXI6Om5ldyhQZWVyc0NvbmZpZzo6ZGVmYXVsdCgpKTsKICAgICAgICBsZXQgbXV0IGZldGNoZXIgPQogICAgICAgICAgICBTdGF0ZUZldGNoZXI6OjxFdGhOZXR3b3JrUHJpbWl0aXZlcz46Om5ldyhtYW5hZ2VyLmhhbmRsZSgpLCBEZWZhdWx0OjpkZWZhdWx0KCkpOwogICAgICAgIC8vIEFkZCBhIGZldyByYW5kb20gcGVlcnMKICAgICAgICBsZXQgcGVlcjEgPSBCNTEyOjpyYW5kb20oKTsKICAgICAgICBsZXQgcGVlcjIgPSBCNTEyOjpyYW5kb20oKTsKICAgICAgICBsZXQgcGVlcjMgPSBCNTEyOjpyYW5kb20oKTsKCiAgICAgICAgbGV0IHBlZXIyX3RpbWVvdXQgPSBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldygzMDApKTsKCiAgICAgICAgbGV0IGNhcGFiaWxpdGllcyA9IEFyYzo6bmV3KENhcGFiaWxpdGllczo6ZnJvbSh2ZWMhW10pKTsKICAgICAgICBmZXRjaGVyLm5ld19hY3RpdmVfcGVlcigKICAgICAgICAgICAgcGVlcjEsCiAgICAgICAgICAgIEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICAxLAogICAgICAgICAgICBBcmM6OmNsb25lKCZjYXBhYmlsaXRpZXMpLAogICAgICAgICAgICBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldygzMCkpLAogICAgICAgICAgICBOb25lLAogICAgICAgICk7CiAgICAgICAgZmV0Y2hlci5uZXdfYWN0aXZlX3BlZXIoCiAgICAgICAgICAgIHBlZXIyLAogICAgICAgICAgICBCMjU2OjpyYW5kb20oKSwKICAgICAgICAgICAgMiwKICAgICAgICAgICAgQXJjOjpjbG9uZSgmY2FwYWJpbGl0aWVzKSwKICAgICAgICAgICAgQXJjOjpjbG9uZSgmcGVlcjJfdGltZW91dCksCiAgICAgICAgICAgIE5vbmUsCiAgICAgICAgKTsKICAgICAgICBmZXRjaGVyLm5ld19hY3RpdmVfcGVlcigKICAgICAgICAgICAgcGVlcjMsCiAgICAgICAgICAgIEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICAzLAogICAgICAgICAgICBBcmM6OmNsb25lKCZjYXBhYmlsaXRpZXMpLAogICAgICAgICAgICBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldyg1MCkpLAogICAgICAgICAgICBOb25lLAogICAgICAgICk7CgogICAgICAgIC8vIE11c3QgYWx3YXlzIGdldCBwZWVyMSAobG93ZXN0IHRpbWVvdXQpCiAgICAgICAgYXNzZXJ0X2VxIShmZXRjaGVyLm5leHRfYmVzdF9wZWVyKEJlc3RQZWVyUmVxdWlyZW1lbnRzOjpOb25lKSwgU29tZShwZWVyMSkpOwogICAgICAgIGFzc2VydF9lcSEoZmV0Y2hlci5uZXh0X2Jlc3RfcGVlcihCZXN0UGVlclJlcXVpcmVtZW50czo6Tm9uZSksIFNvbWUocGVlcjEpKTsKICAgICAgICAvLyBwZWVyMidzIHRpbWVvdXQgY2hhbmdlcyBiZWxvdyBwZWVyMSdzCiAgICAgICAgcGVlcjJfdGltZW91dC5zdG9yZSgxMCwgT3JkZXJpbmc6OlJlbGF4ZWQpOwogICAgICAgIC8vIFRoZW4gd2UgZ2V0IHBlZXIgMiBhbHdheXMgKG5vdyBsb3dlc3QpCiAgICAgICAgYXNzZXJ0X2VxIShmZXRjaGVyLm5leHRfYmVzdF9wZWVyKEJlc3RQZWVyUmVxdWlyZW1lbnRzOjpOb25lKSwgU29tZShwZWVyMikpOwogICAgICAgIGFzc2VydF9lcSEoZmV0Y2hlci5uZXh0X2Jlc3RfcGVlcihCZXN0UGVlclJlcXVpcmVtZW50czo6Tm9uZSksIFNvbWUocGVlcjIpKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9vbl9ibG9ja19oZWFkZXJzX3Jlc3BvbnNlKCkgewogICAgICAgIGxldCBtYW5hZ2VyID0gUGVlcnNNYW5hZ2VyOjpuZXcoUGVlcnNDb25maWc6OmRlZmF1bHQoKSk7CiAgICAgICAgbGV0IG11dCBmZXRjaGVyID0KICAgICAgICAgICAgU3RhdGVGZXRjaGVyOjo8RXRoTmV0d29ya1ByaW1pdGl2ZXM+OjpuZXcobWFuYWdlci5oYW5kbGUoKSwgRGVmYXVsdDo6ZGVmYXVsdCgpKTsKICAgICAgICBsZXQgcGVlcl9pZCA9IEI1MTI6OnJhbmRvbSgpOwoKICAgICAgICBhc3NlcnRfZXEhKGZldGNoZXIub25fYmxvY2tfaGVhZGVyc19yZXNwb25zZShwZWVyX2lkLCBPayh2ZWMhW0hlYWRlcjo6ZGVmYXVsdCgpXSkpLCBOb25lKTsKCiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgZmV0Y2hlci5vbl9ibG9ja19oZWFkZXJzX3Jlc3BvbnNlKHBlZXJfaWQsIEVycihSZXF1ZXN0RXJyb3I6OlRpbWVvdXQpKSwKICAgICAgICAgICAgU29tZShCbG9ja1Jlc3BvbnNlT3V0Y29tZTo6QmFkUmVzcG9uc2UocGVlcl9pZCwgUmVwdXRhdGlvbkNoYW5nZUtpbmQ6OlRpbWVvdXQpKQogICAgICAgICk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgZmV0Y2hlci5vbl9ibG9ja19oZWFkZXJzX3Jlc3BvbnNlKHBlZXJfaWQsIEVycihSZXF1ZXN0RXJyb3I6OkJhZFJlc3BvbnNlKSksCiAgICAgICAgICAgIE5vbmUKICAgICAgICApOwogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGZldGNoZXIub25fYmxvY2tfaGVhZGVyc19yZXNwb25zZShwZWVyX2lkLCBFcnIoUmVxdWVzdEVycm9yOjpDaGFubmVsQ2xvc2VkKSksCiAgICAgICAgICAgIE5vbmUKICAgICAgICApOwogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGZldGNoZXIub25fYmxvY2tfaGVhZGVyc19yZXNwb25zZShwZWVyX2lkLCBFcnIoUmVxdWVzdEVycm9yOjpDb25uZWN0aW9uRHJvcHBlZCkpLAogICAgICAgICAgICBOb25lCiAgICAgICAgKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBmZXRjaGVyLm9uX2Jsb2NrX2hlYWRlcnNfcmVzcG9uc2UocGVlcl9pZCwgRXJyKFJlcXVlc3RFcnJvcjo6VW5zdXBwb3J0ZWRDYXBhYmlsaXR5KSksCiAgICAgICAgICAgIE5vbmUKICAgICAgICApOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2hlYWRlcl9yZXNwb25zZV9vdXRjb21lKCkgewogICAgICAgIGxldCBtYW5hZ2VyID0gUGVlcnNNYW5hZ2VyOjpuZXcoUGVlcnNDb25maWc6OmRlZmF1bHQoKSk7CiAgICAgICAgbGV0IG11dCBmZXRjaGVyID0KICAgICAgICAgICAgU3RhdGVGZXRjaGVyOjo8RXRoTmV0d29ya1ByaW1pdGl2ZXM+OjpuZXcobWFuYWdlci5oYW5kbGUoKSwgRGVmYXVsdDo6ZGVmYXVsdCgpKTsKICAgICAgICBsZXQgcGVlcl9pZCA9IEI1MTI6OnJhbmRvbSgpOwoKICAgICAgICBsZXQgcmVxdWVzdF9wYWlyID0gfHwgewogICAgICAgICAgICBsZXQgKHR4LCBfcngpID0gb25lc2hvdDo6Y2hhbm5lbCgpOwogICAgICAgICAgICBsZXQgcmVxID0gUmVxdWVzdCB7CiAgICAgICAgICAgICAgICByZXF1ZXN0OiBIZWFkZXJzUmVxdWVzdCB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IDB1NjQuaW50bygpLAogICAgICAgICAgICAgICAgICAgIGxpbWl0OiAxLAogICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc3BvbnNlOiB0eCwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgbGV0IGhlYWRlciA9IEhlYWRlciB7IG51bWJlcjogMCwgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfTsKICAgICAgICAgICAgKHJlcSwgaGVhZGVyKQogICAgICAgIH07CgogICAgICAgIGZldGNoZXIubmV3X2FjdGl2ZV9wZWVyKAogICAgICAgICAgICBwZWVyX2lkLAogICAgICAgICAgICBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIERlZmF1bHQ6OmRlZmF1bHQoKSwKICAgICAgICAgICAgQXJjOjpuZXcoQ2FwYWJpbGl0aWVzOjpmcm9tKHZlYyFbXSkpLAogICAgICAgICAgICBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIE5vbmUsCiAgICAgICAgKTsKCiAgICAgICAgbGV0IChyZXEsIGhlYWRlcikgPSByZXF1ZXN0X3BhaXIoKTsKICAgICAgICBmZXRjaGVyLmluZmxpZ2h0X2hlYWRlcnNfcmVxdWVzdHMuaW5zZXJ0KHBlZXJfaWQsIHJlcSk7CgogICAgICAgIGxldCBvdXRjb21lID0gZmV0Y2hlci5vbl9ibG9ja19oZWFkZXJzX3Jlc3BvbnNlKHBlZXJfaWQsIE9rKHZlYyFbaGVhZGVyXSkpOwogICAgICAgIGFzc2VydCEob3V0Y29tZS5pc19ub25lKCkpOwogICAgICAgIGFzc2VydCEoZmV0Y2hlci5wZWVyc1smcGVlcl9pZF0uc3RhdGUuaXNfaWRsZSgpKTsKCiAgICAgICAgbGV0IG91dGNvbWUgPQogICAgICAgICAgICBmZXRjaGVyLm9uX2Jsb2NrX2hlYWRlcnNfcmVzcG9uc2UocGVlcl9pZCwgRXJyKFJlcXVlc3RFcnJvcjo6VGltZW91dCkpLnVud3JhcCgpOwoKICAgICAgICBhc3NlcnQhKEV0aFJlc3BvbnNlVmFsaWRhdG9yOjpyZXB1dGF0aW9uX2NoYW5nZV9lcnIoJkVycjo6PFZlYzxIZWFkZXI+LCBfPigKICAgICAgICAgICAgUmVxdWVzdEVycm9yOjpUaW1lb3V0CiAgICAgICAgKSkKICAgICAgICAuaXNfc29tZSgpKTsKCiAgICAgICAgbWF0Y2ggb3V0Y29tZSB7CiAgICAgICAgICAgIEJsb2NrUmVzcG9uc2VPdXRjb21lOjpCYWRSZXNwb25zZShwZWVyLCBfKSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXIsIHBlZXJfaWQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgQmxvY2tSZXNwb25zZU91dGNvbWU6OlJlcXVlc3QoXywgXykgPT4gewogICAgICAgICAgICAgICAgdW5yZWFjaGFibGUhKCkKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGFzc2VydCEoZmV0Y2hlci5wZWVyc1smcGVlcl9pZF0uc3RhdGUuaXNfaWRsZSgpKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3BlZXJfaXNfYmV0dGVyX25vbmVfcmVxdWlyZW1lbnQoKSB7CiAgICAgICAgbGV0IHBlZXIxID0gUGVlciB7CiAgICAgICAgICAgIHN0YXRlOiBQZWVyU3RhdGU6OklkbGUsCiAgICAgICAgICAgIGJlc3RfaGFzaDogQjI1Njo6cmFuZG9tKCksCiAgICAgICAgICAgIGJlc3RfbnVtYmVyOiAxMDAsCiAgICAgICAgICAgIGNhcGFiaWxpdGllczogQXJjOjpuZXcoQ2FwYWJpbGl0aWVzOjpuZXcodmVjIVtdKSksCiAgICAgICAgICAgIHRpbWVvdXQ6IEFyYzo6bmV3KEF0b21pY1U2NDo6bmV3KDEwKSksCiAgICAgICAgICAgIGxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZDogZmFsc2UsCiAgICAgICAgICAgIHJhbmdlX2luZm86IFNvbWUoQmxvY2tSYW5nZUluZm86Om5ldygwLCAxMDAsIEIyNTY6OnJhbmRvbSgpKSksCiAgICAgICAgfTsKCiAgICAgICAgbGV0IHBlZXIyID0gUGVlciB7CiAgICAgICAgICAgIHN0YXRlOiBQZWVyU3RhdGU6OklkbGUsCiAgICAgICAgICAgIGJlc3RfaGFzaDogQjI1Njo6cmFuZG9tKCksCiAgICAgICAgICAgIGJlc3RfbnVtYmVyOiA1MCwKICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBBcmM6Om5ldyhDYXBhYmlsaXRpZXM6Om5ldyh2ZWMhW10pKSwKICAgICAgICAgICAgdGltZW91dDogQXJjOjpuZXcoQXRvbWljVTY0OjpuZXcoMjApKSwKICAgICAgICAgICAgbGFzdF9yZXNwb25zZV9saWtlbHlfYmFkOiBmYWxzZSwKICAgICAgICAgICAgcmFuZ2VfaW5mbzogTm9uZSwKICAgICAgICB9OwoKICAgICAgICAvLyBXaXRoIE5vbmUgcmVxdWlyZW1lbnQsIGlzX2JldHRlciBzaG91bGQgYWx3YXlzIHJldHVybiBmYWxzZQogICAgICAgIGFzc2VydCEoIXBlZXIxLmlzX2JldHRlcigmcGVlcjIsICZCZXN0UGVlclJlcXVpcmVtZW50czo6Tm9uZSkpOwogICAgICAgIGFzc2VydCEoIXBlZXIyLmlzX2JldHRlcigmcGVlcjEsICZCZXN0UGVlclJlcXVpcmVtZW50czo6Tm9uZSkpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfcGVlcl9pc19iZXR0ZXJfZnVsbF9ibG9ja19yZXF1aXJlbWVudCgpIHsKICAgICAgICAvLyBQZWVyIHdpdGggZnVsbCBoaXN0b3J5IChlYXJsaWVzdCA9IDApCiAgICAgICAgbGV0IHBlZXJfZnVsbCA9IFBlZXIgewogICAgICAgICAgICBzdGF0ZTogUGVlclN0YXRlOjpJZGxlLAogICAgICAgICAgICBiZXN0X2hhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICBiZXN0X251bWJlcjogMTAwLAogICAgICAgICAgICBjYXBhYmlsaXRpZXM6IEFyYzo6bmV3KENhcGFiaWxpdGllczo6bmV3KHZlYyFbXSkpLAogICAgICAgICAgICB0aW1lb3V0OiBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldygxMCkpLAogICAgICAgICAgICBsYXN0X3Jlc3BvbnNlX2xpa2VseV9iYWQ6IGZhbHNlLAogICAgICAgICAgICByYW5nZV9pbmZvOiBTb21lKEJsb2NrUmFuZ2VJbmZvOjpuZXcoMCwgMTAwLCBCMjU2OjpyYW5kb20oKSkpLAogICAgICAgIH07CgogICAgICAgIC8vIFBlZXIgd2l0aG91dCBmdWxsIGhpc3RvcnkgKGVhcmxpZXN0ID0gNTApCiAgICAgICAgbGV0IHBlZXJfcGFydGlhbCA9IFBlZXIgewogICAgICAgICAgICBzdGF0ZTogUGVlclN0YXRlOjpJZGxlLAogICAgICAgICAgICBiZXN0X2hhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICBiZXN0X251bWJlcjogMTAwLAogICAgICAgICAgICBjYXBhYmlsaXRpZXM6IEFyYzo6bmV3KENhcGFiaWxpdGllczo6bmV3KHZlYyFbXSkpLAogICAgICAgICAgICB0aW1lb3V0OiBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldygxMCkpLAogICAgICAgICAgICBsYXN0X3Jlc3BvbnNlX2xpa2VseV9iYWQ6IGZhbHNlLAogICAgICAgICAgICByYW5nZV9pbmZvOiBTb21lKEJsb2NrUmFuZ2VJbmZvOjpuZXcoNTAsIDEwMCwgQjI1Njo6cmFuZG9tKCkpKSwKICAgICAgICB9OwoKICAgICAgICAvLyBQZWVyIHdpdGhvdXQgcmFuZ2UgaW5mbyAodHJlYXRlZCBhcyBmdWxsIGhpc3RvcnkpCiAgICAgICAgbGV0IHBlZXJfbm9fcmFuZ2UgPSBQZWVyIHsKICAgICAgICAgICAgc3RhdGU6IFBlZXJTdGF0ZTo6SWRsZSwKICAgICAgICAgICAgYmVzdF9oYXNoOiBCMjU2OjpyYW5kb20oKSwKICAgICAgICAgICAgYmVzdF9udW1iZXI6IDEwMCwKICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBBcmM6Om5ldyhDYXBhYmlsaXRpZXM6Om5ldyh2ZWMhW10pKSwKICAgICAgICAgICAgdGltZW91dDogQXJjOjpuZXcoQXRvbWljVTY0OjpuZXcoMTApKSwKICAgICAgICAgICAgbGFzdF9yZXNwb25zZV9saWtlbHlfYmFkOiBmYWxzZSwKICAgICAgICAgICAgcmFuZ2VfaW5mbzogTm9uZSwKICAgICAgICB9OwoKICAgICAgICAvLyBQZWVyIHdpdGggZnVsbCBoaXN0b3J5IGlzIGJldHRlciB0aGFuIHBlZXIgd2l0aG91dAogICAgICAgIGFzc2VydCEocGVlcl9mdWxsLmlzX2JldHRlcigmcGVlcl9wYXJ0aWFsLCAmQmVzdFBlZXJSZXF1aXJlbWVudHM6OkZ1bGxCbG9jaykpOwogICAgICAgIGFzc2VydCEoIXBlZXJfcGFydGlhbC5pc19iZXR0ZXIoJnBlZXJfZnVsbCwgJkJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2spKTsKCiAgICAgICAgLy8gUGVlciB3aXRob3V0IHJhbmdlIGluZm8gKGZ1bGwgaGlzdG9yeSkgaXMgYmV0dGVyIHRoYW4gcGFydGlhbAogICAgICAgIGFzc2VydCEocGVlcl9ub19yYW5nZS5pc19iZXR0ZXIoJnBlZXJfcGFydGlhbCwgJkJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2spKTsKICAgICAgICBhc3NlcnQhKCFwZWVyX3BhcnRpYWwuaXNfYmV0dGVyKCZwZWVyX25vX3JhbmdlLCAmQmVzdFBlZXJSZXF1aXJlbWVudHM6OkZ1bGxCbG9jaykpOwoKICAgICAgICAvLyBCb3RoIGhhdmUgZnVsbCBoaXN0b3J5IC0gbm8gaW1wcm92ZW1lbnQKICAgICAgICBhc3NlcnQhKCFwZWVyX2Z1bGwuaXNfYmV0dGVyKCZwZWVyX25vX3JhbmdlLCAmQmVzdFBlZXJSZXF1aXJlbWVudHM6OkZ1bGxCbG9jaykpOwogICAgICAgIGFzc2VydCEoIXBlZXJfbm9fcmFuZ2UuaXNfYmV0dGVyKCZwZWVyX2Z1bGwsICZCZXN0UGVlclJlcXVpcmVtZW50czo6RnVsbEJsb2NrKSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9wZWVyX2lzX2JldHRlcl9mdWxsX2Jsb2NrX3JhbmdlX3JlcXVpcmVtZW50KCkgewogICAgICAgIGxldCByYW5nZSA9IFJhbmdlSW5jbHVzaXZlOjpuZXcoNDAsIDYwKTsKCiAgICAgICAgLy8gUGVlciB0aGF0IGNvdmVycyB0aGUgcmVxdWVzdGVkIHJhbmdlCiAgICAgICAgbGV0IHBlZXJfY292ZXJzID0gUGVlciB7CiAgICAgICAgICAgIHN0YXRlOiBQZWVyU3RhdGU6OklkbGUsCiAgICAgICAgICAgIGJlc3RfaGFzaDogQjI1Njo6cmFuZG9tKCksCiAgICAgICAgICAgIGJlc3RfbnVtYmVyOiAxMDAsCiAgICAgICAgICAgIGNhcGFiaWxpdGllczogQXJjOjpuZXcoQ2FwYWJpbGl0aWVzOjpuZXcodmVjIVtdKSksCiAgICAgICAgICAgIHRpbWVvdXQ6IEFyYzo6bmV3KEF0b21pY1U2NDo6bmV3KDEwKSksCiAgICAgICAgICAgIGxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZDogZmFsc2UsCiAgICAgICAgICAgIHJhbmdlX2luZm86IFNvbWUoQmxvY2tSYW5nZUluZm86Om5ldygwLCAxMDAsIEIyNTY6OnJhbmRvbSgpKSksCiAgICAgICAgfTsKCiAgICAgICAgLy8gUGVlciB0aGF0IGRvZXNuJ3QgY292ZXIgdGhlIHJhbmdlIChlYXJsaWVzdCB0b28gaGlnaCkKICAgICAgICBsZXQgcGVlcl9ub19jb3ZlciA9IFBlZXIgewogICAgICAgICAgICBzdGF0ZTogUGVlclN0YXRlOjpJZGxlLAogICAgICAgICAgICBiZXN0X2hhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICBiZXN0X251bWJlcjogMTAwLAogICAgICAgICAgICBjYXBhYmlsaXRpZXM6IEFyYzo6bmV3KENhcGFiaWxpdGllczo6bmV3KHZlYyFbXSkpLAogICAgICAgICAgICB0aW1lb3V0OiBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldygxMCkpLAogICAgICAgICAgICBsYXN0X3Jlc3BvbnNlX2xpa2VseV9iYWQ6IGZhbHNlLAogICAgICAgICAgICByYW5nZV9pbmZvOiBTb21lKEJsb2NrUmFuZ2VJbmZvOjpuZXcoNzAsIDEwMCwgQjI1Njo6cmFuZG9tKCkpKSwKICAgICAgICB9OwoKICAgICAgICAvLyBQZWVyIHRoYXQgY292ZXJzIHRoZSByZXF1ZXN0ZWQgcmFuZ2UgaXMgYmV0dGVyIHRoYW4gb25lIHRoYXQgZG9lc24ndAogICAgICAgIGFzc2VydCEocGVlcl9jb3ZlcnMKICAgICAgICAgICAgLmlzX2JldHRlcigmcGVlcl9ub19jb3ZlciwgJkJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2tSYW5nZShyYW5nZS5jbG9uZSgpKSkpOwogICAgICAgIGFzc2VydCEoCiAgICAgICAgICAgICFwZWVyX25vX2NvdmVyLmlzX2JldHRlcigmcGVlcl9jb3ZlcnMsICZCZXN0UGVlclJlcXVpcmVtZW50czo6RnVsbEJsb2NrUmFuZ2UocmFuZ2UpKQogICAgICAgICk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9wZWVyX2lzX2JldHRlcl9ib3RoX2NvdmVyX3JhbmdlKCkgewogICAgICAgIGxldCByYW5nZSA9IFJhbmdlSW5jbHVzaXZlOjpuZXcoMzAsIDUwKTsKCiAgICAgICAgLy8gUGVlciB3aXRoIGZ1bGwgaGlzdG9yeSB0aGF0IGNvdmVycyB0aGUgcmFuZ2UKICAgICAgICBsZXQgcGVlcl9mdWxsID0gUGVlciB7CiAgICAgICAgICAgIHN0YXRlOiBQZWVyU3RhdGU6OklkbGUsCiAgICAgICAgICAgIGJlc3RfaGFzaDogQjI1Njo6cmFuZG9tKCksCiAgICAgICAgICAgIGJlc3RfbnVtYmVyOiAxMDAsCiAgICAgICAgICAgIGNhcGFiaWxpdGllczogQXJjOjpuZXcoQ2FwYWJpbGl0aWVzOjpuZXcodmVjIVtdKSksCiAgICAgICAgICAgIHRpbWVvdXQ6IEFyYzo6bmV3KEF0b21pY1U2NDo6bmV3KDEwKSksCiAgICAgICAgICAgIGxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZDogZmFsc2UsCiAgICAgICAgICAgIHJhbmdlX2luZm86IFNvbWUoQmxvY2tSYW5nZUluZm86Om5ldygwLCA1MCwgQjI1Njo6cmFuZG9tKCkpKSwKICAgICAgICB9OwoKICAgICAgICAvLyBQZWVyIHdpdGhvdXQgZnVsbCBoaXN0b3J5IHRoYXQgYWxzbyBjb3ZlcnMgdGhlIHJhbmdlCiAgICAgICAgbGV0IHBlZXJfcGFydGlhbCA9IFBlZXIgewogICAgICAgICAgICBzdGF0ZTogUGVlclN0YXRlOjpJZGxlLAogICAgICAgICAgICBiZXN0X2hhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICBiZXN0X251bWJlcjogMTAwLAogICAgICAgICAgICBjYXBhYmlsaXRpZXM6IEFyYzo6bmV3KENhcGFiaWxpdGllczo6bmV3KHZlYyFbXSkpLAogICAgICAgICAgICB0aW1lb3V0OiBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldygxMCkpLAogICAgICAgICAgICBsYXN0X3Jlc3BvbnNlX2xpa2VseV9iYWQ6IGZhbHNlLAogICAgICAgICAgICByYW5nZV9pbmZvOiBTb21lKEJsb2NrUmFuZ2VJbmZvOjpuZXcoMzAsIDUwLCBCMjU2OjpyYW5kb20oKSkpLAogICAgICAgIH07CgogICAgICAgIC8vIFdoZW4gYm90aCBjb3ZlciB0aGUgcmFuZ2UsIHByZWZlciBub25lCiAgICAgICAgYXNzZXJ0ISghcGVlcl9mdWxsCiAgICAgICAgICAgIC5pc19iZXR0ZXIoJnBlZXJfcGFydGlhbCwgJkJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2tSYW5nZShyYW5nZS5jbG9uZSgpKSkpOwogICAgICAgIGFzc2VydCEoIXBlZXJfcGFydGlhbC5pc19iZXR0ZXIoJnBlZXJfZnVsbCwgJkJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2tSYW5nZShyYW5nZSkpKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3BlZXJfaXNfYmV0dGVyX2xvd2VyX3N0YXJ0KCkgewogICAgICAgIGxldCByYW5nZSA9IFJhbmdlSW5jbHVzaXZlOjpuZXcoMzAsIDYwKTsKCiAgICAgICAgLy8gUGVlciB3aXRoIGZ1bGwgaGlzdG9yeSB0aGF0IGNvdmVycyB0aGUgcmFuZ2UKICAgICAgICBsZXQgcGVlcl9mdWxsID0gUGVlciB7CiAgICAgICAgICAgIHN0YXRlOiBQZWVyU3RhdGU6OklkbGUsCiAgICAgICAgICAgIGJlc3RfaGFzaDogQjI1Njo6cmFuZG9tKCksCiAgICAgICAgICAgIGJlc3RfbnVtYmVyOiAxMDAsCiAgICAgICAgICAgIGNhcGFiaWxpdGllczogQXJjOjpuZXcoQ2FwYWJpbGl0aWVzOjpuZXcodmVjIVtdKSksCiAgICAgICAgICAgIHRpbWVvdXQ6IEFyYzo6bmV3KEF0b21pY1U2NDo6bmV3KDEwKSksCiAgICAgICAgICAgIGxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZDogZmFsc2UsCiAgICAgICAgICAgIHJhbmdlX2luZm86IFNvbWUoQmxvY2tSYW5nZUluZm86Om5ldygwLCA1MCwgQjI1Njo6cmFuZG9tKCkpKSwKICAgICAgICB9OwoKICAgICAgICAvLyBQZWVyIHdpdGhvdXQgZnVsbCBoaXN0b3J5IHRoYXQgYWxzbyBjb3ZlcnMgdGhlIHJhbmdlCiAgICAgICAgbGV0IHBlZXJfcGFydGlhbCA9IFBlZXIgewogICAgICAgICAgICBzdGF0ZTogUGVlclN0YXRlOjpJZGxlLAogICAgICAgICAgICBiZXN0X2hhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICBiZXN0X251bWJlcjogMTAwLAogICAgICAgICAgICBjYXBhYmlsaXRpZXM6IEFyYzo6bmV3KENhcGFiaWxpdGllczo6bmV3KHZlYyFbXSkpLAogICAgICAgICAgICB0aW1lb3V0OiBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldygxMCkpLAogICAgICAgICAgICBsYXN0X3Jlc3BvbnNlX2xpa2VseV9iYWQ6IGZhbHNlLAogICAgICAgICAgICByYW5nZV9pbmZvOiBTb21lKEJsb2NrUmFuZ2VJbmZvOjpuZXcoMzAsIDUwLCBCMjU2OjpyYW5kb20oKSkpLAogICAgICAgIH07CgogICAgICAgIC8vIFdoZW4gYm90aCBjb3ZlciB0aGUgcmFuZ2UsIHByZWZlciBsb3dlciBzdGFydCB2YWx1ZQogICAgICAgIGFzc2VydCEocGVlcl9mdWxsCiAgICAgICAgICAgIC5pc19iZXR0ZXIoJnBlZXJfcGFydGlhbCwgJkJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2tSYW5nZShyYW5nZS5jbG9uZSgpKSkpOwogICAgICAgIGFzc2VydCEoIXBlZXJfcGFydGlhbC5pc19iZXR0ZXIoJnBlZXJfZnVsbCwgJkJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2tSYW5nZShyYW5nZSkpKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3BlZXJfaXNfYmV0dGVyX25laXRoZXJfY292ZXJzX3JhbmdlKCkgewogICAgICAgIGxldCByYW5nZSA9IFJhbmdlSW5jbHVzaXZlOjpuZXcoNDAsIDYwKTsKCiAgICAgICAgLy8gUGVlciB3aXRoIGZ1bGwgaGlzdG9yeSB0aGF0IGRvZXNuJ3QgY292ZXIgdGhlIHJhbmdlIChsYXRlc3QgdG9vIGxvdykKICAgICAgICBsZXQgcGVlcl9mdWxsID0gUGVlciB7CiAgICAgICAgICAgIHN0YXRlOiBQZWVyU3RhdGU6OklkbGUsCiAgICAgICAgICAgIGJlc3RfaGFzaDogQjI1Njo6cmFuZG9tKCksCiAgICAgICAgICAgIGJlc3RfbnVtYmVyOiAzMCwKICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBBcmM6Om5ldyhDYXBhYmlsaXRpZXM6Om5ldyh2ZWMhW10pKSwKICAgICAgICAgICAgdGltZW91dDogQXJjOjpuZXcoQXRvbWljVTY0OjpuZXcoMTApKSwKICAgICAgICAgICAgbGFzdF9yZXNwb25zZV9saWtlbHlfYmFkOiBmYWxzZSwKICAgICAgICAgICAgcmFuZ2VfaW5mbzogU29tZShCbG9ja1JhbmdlSW5mbzo6bmV3KDAsIDMwLCBCMjU2OjpyYW5kb20oKSkpLAogICAgICAgIH07CgogICAgICAgIC8vIFBlZXIgd2l0aG91dCBmdWxsIGhpc3RvcnkgdGhhdCBhbHNvIGRvZXNuJ3QgY292ZXIgdGhlIHJhbmdlCiAgICAgICAgbGV0IHBlZXJfcGFydGlhbCA9IFBlZXIgewogICAgICAgICAgICBzdGF0ZTogUGVlclN0YXRlOjpJZGxlLAogICAgICAgICAgICBiZXN0X2hhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICBiZXN0X251bWJlcjogMzAsCiAgICAgICAgICAgIGNhcGFiaWxpdGllczogQXJjOjpuZXcoQ2FwYWJpbGl0aWVzOjpuZXcodmVjIVtdKSksCiAgICAgICAgICAgIHRpbWVvdXQ6IEFyYzo6bmV3KEF0b21pY1U2NDo6bmV3KDEwKSksCiAgICAgICAgICAgIGxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZDogZmFsc2UsCiAgICAgICAgICAgIHJhbmdlX2luZm86IFNvbWUoQmxvY2tSYW5nZUluZm86Om5ldygxMCwgMzAsIEIyNTY6OnJhbmRvbSgpKSksCiAgICAgICAgfTsKCiAgICAgICAgLy8gV2hlbiBuZWl0aGVyIGNvdmVycyB0aGUgcmFuZ2UsIHByZWZlciBmdWxsIGhpc3RvcnkKICAgICAgICBhc3NlcnQhKHBlZXJfZnVsbAogICAgICAgICAgICAuaXNfYmV0dGVyKCZwZWVyX3BhcnRpYWwsICZCZXN0UGVlclJlcXVpcmVtZW50czo6RnVsbEJsb2NrUmFuZ2UocmFuZ2UuY2xvbmUoKSkpKTsKICAgICAgICBhc3NlcnQhKCFwZWVyX3BhcnRpYWwuaXNfYmV0dGVyKCZwZWVyX2Z1bGwsICZCZXN0UGVlclJlcXVpcmVtZW50czo6RnVsbEJsb2NrUmFuZ2UocmFuZ2UpKSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9wZWVyX2lzX2JldHRlcl9ub19yYW5nZV9pbmZvKCkgewogICAgICAgIGxldCByYW5nZSA9IFJhbmdlSW5jbHVzaXZlOjpuZXcoNDAsIDYwKTsKCiAgICAgICAgLy8gUGVlciB3aXRoIHJhbmdlIGluZm8KICAgICAgICBsZXQgcGVlcl93aXRoX3JhbmdlID0gUGVlciB7CiAgICAgICAgICAgIHN0YXRlOiBQZWVyU3RhdGU6OklkbGUsCiAgICAgICAgICAgIGJlc3RfaGFzaDogQjI1Njo6cmFuZG9tKCksCiAgICAgICAgICAgIGJlc3RfbnVtYmVyOiAxMDAsCiAgICAgICAgICAgIGNhcGFiaWxpdGllczogQXJjOjpuZXcoQ2FwYWJpbGl0aWVzOjpuZXcodmVjIVtdKSksCiAgICAgICAgICAgIHRpbWVvdXQ6IEFyYzo6bmV3KEF0b21pY1U2NDo6bmV3KDEwKSksCiAgICAgICAgICAgIGxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZDogZmFsc2UsCiAgICAgICAgICAgIHJhbmdlX2luZm86IFNvbWUoQmxvY2tSYW5nZUluZm86Om5ldygzMCwgMTAwLCBCMjU2OjpyYW5kb20oKSkpLAogICAgICAgIH07CgogICAgICAgIC8vIFBlZXIgd2l0aG91dCByYW5nZSBpbmZvCiAgICAgICAgbGV0IHBlZXJfbm9fcmFuZ2UgPSBQZWVyIHsKICAgICAgICAgICAgc3RhdGU6IFBlZXJTdGF0ZTo6SWRsZSwKICAgICAgICAgICAgYmVzdF9oYXNoOiBCMjU2OjpyYW5kb20oKSwKICAgICAgICAgICAgYmVzdF9udW1iZXI6IDEwMCwKICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBBcmM6Om5ldyhDYXBhYmlsaXRpZXM6Om5ldyh2ZWMhW10pKSwKICAgICAgICAgICAgdGltZW91dDogQXJjOjpuZXcoQXRvbWljVTY0OjpuZXcoMTApKSwKICAgICAgICAgICAgbGFzdF9yZXNwb25zZV9saWtlbHlfYmFkOiBmYWxzZSwKICAgICAgICAgICAgcmFuZ2VfaW5mbzogTm9uZSwKICAgICAgICB9OwoKICAgICAgICAvLyBQZWVyIHdpdGhvdXQgcmFuZ2UgaW5mbyBpcyBub3QgYmV0dGVyICh3ZSBwcmVmZXIgcGVlcnMgd2l0aCBrbm93biByYW5nZXMpCiAgICAgICAgYXNzZXJ0ISghcGVlcl9ub19yYW5nZQogICAgICAgICAgICAuaXNfYmV0dGVyKCZwZWVyX3dpdGhfcmFuZ2UsICZCZXN0UGVlclJlcXVpcmVtZW50czo6RnVsbEJsb2NrUmFuZ2UocmFuZ2UuY2xvbmUoKSkpKTsKCiAgICAgICAgLy8gUGVlciB3aXRoIHJhbmdlIGluZm8gaXMgYmV0dGVyIHRoYW4gcGVlciB3aXRob3V0CiAgICAgICAgYXNzZXJ0ISgKICAgICAgICAgICAgcGVlcl93aXRoX3JhbmdlLmlzX2JldHRlcigmcGVlcl9ub19yYW5nZSwgJkJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2tSYW5nZShyYW5nZSkpCiAgICAgICAgKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3BlZXJfaXNfYmV0dGVyX29uZV9wZWVyX25vX3JhbmdlX2NvdmVycygpIHsKICAgICAgICBsZXQgcmFuZ2UgPSBSYW5nZUluY2x1c2l2ZTo6bmV3KDQwLCA2MCk7CgogICAgICAgIC8vIFBlZXIgd2l0aCByYW5nZSBpbmZvIHRoYXQgY292ZXJzIHRoZSByZXF1ZXN0ZWQgcmFuZ2UKICAgICAgICBsZXQgcGVlcl93aXRoX3JhbmdlX2NvdmVycyA9IFBlZXIgewogICAgICAgICAgICBzdGF0ZTogUGVlclN0YXRlOjpJZGxlLAogICAgICAgICAgICBiZXN0X2hhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICBiZXN0X251bWJlcjogMTAwLAogICAgICAgICAgICBjYXBhYmlsaXRpZXM6IEFyYzo6bmV3KENhcGFiaWxpdGllczo6bmV3KHZlYyFbXSkpLAogICAgICAgICAgICB0aW1lb3V0OiBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldygxMCkpLAogICAgICAgICAgICBsYXN0X3Jlc3BvbnNlX2xpa2VseV9iYWQ6IGZhbHNlLAogICAgICAgICAgICByYW5nZV9pbmZvOiBTb21lKEJsb2NrUmFuZ2VJbmZvOjpuZXcoMzAsIDEwMCwgQjI1Njo6cmFuZG9tKCkpKSwKICAgICAgICB9OwoKICAgICAgICAvLyBQZWVyIHdpdGhvdXQgcmFuZ2UgaW5mbyAodHJlYXRlZCBhcyBmdWxsIGhpc3Rvcnkgd2l0aCB1bmtub3duIGxhdGVzdCkKICAgICAgICBsZXQgcGVlcl9ub19yYW5nZSA9IFBlZXIgewogICAgICAgICAgICBzdGF0ZTogUGVlclN0YXRlOjpJZGxlLAogICAgICAgICAgICBiZXN0X2hhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICBiZXN0X251bWJlcjogMTAwLAogICAgICAgICAgICBjYXBhYmlsaXRpZXM6IEFyYzo6bmV3KENhcGFiaWxpdGllczo6bmV3KHZlYyFbXSkpLAogICAgICAgICAgICB0aW1lb3V0OiBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldygxMCkpLAogICAgICAgICAgICBsYXN0X3Jlc3BvbnNlX2xpa2VseV9iYWQ6IGZhbHNlLAogICAgICAgICAgICByYW5nZV9pbmZvOiBOb25lLAogICAgICAgIH07CgogICAgICAgIC8vIFBlZXIgd2l0aCByYW5nZSB0aGF0IGNvdmVycyBpcyBiZXR0ZXIgdGhhbiBwZWVyIHdpdGhvdXQgcmFuZ2UgaW5mbwogICAgICAgIGFzc2VydCEocGVlcl93aXRoX3JhbmdlX2NvdmVycwogICAgICAgICAgICAuaXNfYmV0dGVyKCZwZWVyX25vX3JhbmdlLCAmQmVzdFBlZXJSZXF1aXJlbWVudHM6OkZ1bGxCbG9ja1JhbmdlKHJhbmdlLmNsb25lKCkpKSk7CgogICAgICAgIC8vIFBlZXIgd2l0aG91dCByYW5nZSBpbmZvIGlzIG5vdCBiZXR0ZXIgd2hlbiBvdGhlciBjb3ZlcnMKICAgICAgICBhc3NlcnQhKCFwZWVyX25vX3JhbmdlCiAgICAgICAgICAgIC5pc19iZXR0ZXIoJnBlZXJfd2l0aF9yYW5nZV9jb3ZlcnMsICZCZXN0UGVlclJlcXVpcmVtZW50czo6RnVsbEJsb2NrUmFuZ2UocmFuZ2UpKSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9wZWVyX2lzX2JldHRlcl9vbmVfcGVlcl9ub19yYW5nZV9kb2VzbnRfY292ZXIoKSB7CiAgICAgICAgbGV0IHJhbmdlID0gUmFuZ2VJbmNsdXNpdmU6Om5ldyg0MCwgNjApOwoKICAgICAgICAvLyBQZWVyIHdpdGggcmFuZ2UgaW5mbyB0aGF0IGRvZXMgTk9UIGNvdmVyIHRoZSByZXF1ZXN0ZWQgcmFuZ2UgKHRvbyBoaWdoKQogICAgICAgIGxldCBwZWVyX3dpdGhfcmFuZ2Vfbm9fY292ZXIgPSBQZWVyIHsKICAgICAgICAgICAgc3RhdGU6IFBlZXJTdGF0ZTo6SWRsZSwKICAgICAgICAgICAgYmVzdF9oYXNoOiBCMjU2OjpyYW5kb20oKSwKICAgICAgICAgICAgYmVzdF9udW1iZXI6IDEwMCwKICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBBcmM6Om5ldyhDYXBhYmlsaXRpZXM6Om5ldyh2ZWMhW10pKSwKICAgICAgICAgICAgdGltZW91dDogQXJjOjpuZXcoQXRvbWljVTY0OjpuZXcoMTApKSwKICAgICAgICAgICAgbGFzdF9yZXNwb25zZV9saWtlbHlfYmFkOiBmYWxzZSwKICAgICAgICAgICAgcmFuZ2VfaW5mbzogU29tZShCbG9ja1JhbmdlSW5mbzo6bmV3KDcwLCAxMDAsIEIyNTY6OnJhbmRvbSgpKSksCiAgICAgICAgfTsKCiAgICAgICAgLy8gUGVlciB3aXRob3V0IHJhbmdlIGluZm8gKHRyZWF0ZWQgYXMgZnVsbCBoaXN0b3J5KQogICAgICAgIGxldCBwZWVyX25vX3JhbmdlID0gUGVlciB7CiAgICAgICAgICAgIHN0YXRlOiBQZWVyU3RhdGU6OklkbGUsCiAgICAgICAgICAgIGJlc3RfaGFzaDogQjI1Njo6cmFuZG9tKCksCiAgICAgICAgICAgIGJlc3RfbnVtYmVyOiAxMDAsCiAgICAgICAgICAgIGNhcGFiaWxpdGllczogQXJjOjpuZXcoQ2FwYWJpbGl0aWVzOjpuZXcodmVjIVtdKSksCiAgICAgICAgICAgIHRpbWVvdXQ6IEFyYzo6bmV3KEF0b21pY1U2NDo6bmV3KDEwKSksCiAgICAgICAgICAgIGxhc3RfcmVzcG9uc2VfbGlrZWx5X2JhZDogZmFsc2UsCiAgICAgICAgICAgIHJhbmdlX2luZm86IE5vbmUsCiAgICAgICAgfTsKCiAgICAgICAgLy8gUGVlciB3aXRoIHJhbmdlIHRoYXQgZG9lc24ndCBjb3ZlciBpcyBub3QgYmV0dGVyCiAgICAgICAgYXNzZXJ0ISghcGVlcl93aXRoX3JhbmdlX25vX2NvdmVyCiAgICAgICAgICAgIC5pc19iZXR0ZXIoJnBlZXJfbm9fcmFuZ2UsICZCZXN0UGVlclJlcXVpcmVtZW50czo6RnVsbEJsb2NrUmFuZ2UocmFuZ2UuY2xvbmUoKSkpKTsKCiAgICAgICAgLy8gUGVlciB3aXRob3V0IHJhbmdlIGluZm8gKGZ1bGwgaGlzdG9yeSkgaXMgYmV0dGVyIHdoZW4gb3RoZXIgZG9lc24ndCBjb3ZlcgogICAgICAgIGFzc2VydCEocGVlcl9ub19yYW5nZQogICAgICAgICAgICAuaXNfYmV0dGVyKCZwZWVyX3dpdGhfcmFuZ2Vfbm9fY292ZXIsICZCZXN0UGVlclJlcXVpcmVtZW50czo6RnVsbEJsb2NrUmFuZ2UocmFuZ2UpKSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9wZWVyX2lzX2JldHRlcl9lZGdlX2Nhc2VzKCkgewogICAgICAgIC8vIFRlc3QgZXhhY3QgcmFuZ2UgYm91bmRhcmllcwogICAgICAgIGxldCByYW5nZSA9IFJhbmdlSW5jbHVzaXZlOjpuZXcoNTAsIDEwMCk7CgogICAgICAgIC8vIFBlZXIgdGhhdCBleGFjdGx5IGNvdmVycyB0aGUgcmFuZ2UKICAgICAgICBsZXQgcGVlcl9leGFjdCA9IFBlZXIgewogICAgICAgICAgICBzdGF0ZTogUGVlclN0YXRlOjpJZGxlLAogICAgICAgICAgICBiZXN0X2hhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICBiZXN0X251bWJlcjogMTAwLAogICAgICAgICAgICBjYXBhYmlsaXRpZXM6IEFyYzo6bmV3KENhcGFiaWxpdGllczo6bmV3KHZlYyFbXSkpLAogICAgICAgICAgICB0aW1lb3V0OiBBcmM6Om5ldyhBdG9taWNVNjQ6Om5ldygxMCkpLAogICAgICAgICAgICBsYXN0X3Jlc3BvbnNlX2xpa2VseV9iYWQ6IGZhbHNlLAogICAgICAgICAgICByYW5nZV9pbmZvOiBTb21lKEJsb2NrUmFuZ2VJbmZvOjpuZXcoNTAsIDEwMCwgQjI1Njo6cmFuZG9tKCkpKSwKICAgICAgICB9OwoKICAgICAgICAvLyBQZWVyIHRoYXQncyBvbmUgYmxvY2sgc2hvcnQgYXQgdGhlIHN0YXJ0CiAgICAgICAgbGV0IHBlZXJfc2hvcnRfc3RhcnQgPSBQZWVyIHsKICAgICAgICAgICAgc3RhdGU6IFBlZXJTdGF0ZTo6SWRsZSwKICAgICAgICAgICAgYmVzdF9oYXNoOiBCMjU2OjpyYW5kb20oKSwKICAgICAgICAgICAgYmVzdF9udW1iZXI6IDEwMCwKICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBBcmM6Om5ldyhDYXBhYmlsaXRpZXM6Om5ldyh2ZWMhW10pKSwKICAgICAgICAgICAgdGltZW91dDogQXJjOjpuZXcoQXRvbWljVTY0OjpuZXcoMTApKSwKICAgICAgICAgICAgbGFzdF9yZXNwb25zZV9saWtlbHlfYmFkOiBmYWxzZSwKICAgICAgICAgICAgcmFuZ2VfaW5mbzogU29tZShCbG9ja1JhbmdlSW5mbzo6bmV3KDUxLCAxMDAsIEIyNTY6OnJhbmRvbSgpKSksCiAgICAgICAgfTsKCiAgICAgICAgLy8gUGVlciB0aGF0J3Mgb25lIGJsb2NrIHNob3J0IGF0IHRoZSBlbmQKICAgICAgICBsZXQgcGVlcl9zaG9ydF9lbmQgPSBQZWVyIHsKICAgICAgICAgICAgc3RhdGU6IFBlZXJTdGF0ZTo6SWRsZSwKICAgICAgICAgICAgYmVzdF9oYXNoOiBCMjU2OjpyYW5kb20oKSwKICAgICAgICAgICAgYmVzdF9udW1iZXI6IDEwMCwKICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBBcmM6Om5ldyhDYXBhYmlsaXRpZXM6Om5ldyh2ZWMhW10pKSwKICAgICAgICAgICAgdGltZW91dDogQXJjOjpuZXcoQXRvbWljVTY0OjpuZXcoMTApKSwKICAgICAgICAgICAgbGFzdF9yZXNwb25zZV9saWtlbHlfYmFkOiBmYWxzZSwKICAgICAgICAgICAgcmFuZ2VfaW5mbzogU29tZShCbG9ja1JhbmdlSW5mbzo6bmV3KDUwLCA5OSwgQjI1Njo6cmFuZG9tKCkpKSwKICAgICAgICB9OwoKICAgICAgICAvLyBFeGFjdCBjb3ZlcmFnZSBpcyBiZXR0ZXIgdGhhbiBzaG9ydCBjb3ZlcmFnZQogICAgICAgIGFzc2VydCEocGVlcl9leGFjdAogICAgICAgICAgICAuaXNfYmV0dGVyKCZwZWVyX3Nob3J0X3N0YXJ0LCAmQmVzdFBlZXJSZXF1aXJlbWVudHM6OkZ1bGxCbG9ja1JhbmdlKHJhbmdlLmNsb25lKCkpKSk7CiAgICAgICAgYXNzZXJ0IShwZWVyX2V4YWN0CiAgICAgICAgICAgIC5pc19iZXR0ZXIoJnBlZXJfc2hvcnRfZW5kLCAmQmVzdFBlZXJSZXF1aXJlbWVudHM6OkZ1bGxCbG9ja1JhbmdlKHJhbmdlLmNsb25lKCkpKSk7CgogICAgICAgIC8vIFNob3J0IGNvdmVyYWdlIGlzIG5vdCBiZXR0ZXIgdGhhbiBleGFjdCBjb3ZlcmFnZQogICAgICAgIGFzc2VydCEoIXBlZXJfc2hvcnRfc3RhcnQKICAgICAgICAgICAgLmlzX2JldHRlcigmcGVlcl9leGFjdCwgJkJlc3RQZWVyUmVxdWlyZW1lbnRzOjpGdWxsQmxvY2tSYW5nZShyYW5nZS5jbG9uZSgpKSkpOwogICAgICAgIGFzc2VydCEoCiAgICAgICAgICAgICFwZWVyX3Nob3J0X2VuZC5pc19iZXR0ZXIoJnBlZXJfZXhhY3QsICZCZXN0UGVlclJlcXVpcmVtZW50czo6RnVsbEJsb2NrUmFuZ2UocmFuZ2UpKQogICAgICAgICk7CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL25ldC9uZXR3b3JrL3NyYy9ldGhfcmVxdWVzdHMucnMiPgovLyEgQmxvY2tzL0hlYWRlcnMgbWFuYWdlbWVudCBmb3IgdGhlIHAycCBuZXR3b3JrLgoKdXNlIGNyYXRlOjp7CiAgICBidWRnZXQ6OkRFRkFVTFRfQlVER0VUX1RSWV9EUkFJTl9ET1dOTE9BREVSUywgbWV0ZXJlZF9wb2xsX25lc3RlZF9zdHJlYW1fd2l0aF9idWRnZXQsCiAgICBtZXRyaWNzOjpFdGhSZXF1ZXN0SGFuZGxlck1ldHJpY3MsCn07CnVzZSBhbGxveV9jb25zZW5zdXM6OntCbG9ja0hlYWRlciwgUmVjZWlwdFdpdGhCbG9vbX07CnVzZSBhbGxveV9laXBzOjpCbG9ja0hhc2hPck51bWJlcjsKdXNlIGFsbG95X3JscDo6RW5jb2RhYmxlOwp1c2UgZnV0dXJlczo6U3RyZWFtRXh0Owp1c2UgcmV0aF9ldGhfd2lyZTo6ewogICAgQmxvY2tCb2RpZXMsIEJsb2NrSGVhZGVycywgRXRoTmV0d29ya1ByaW1pdGl2ZXMsIEdldEJsb2NrQm9kaWVzLCBHZXRCbG9ja0hlYWRlcnMsIEdldE5vZGVEYXRhLAogICAgR2V0UmVjZWlwdHMsIEdldFJlY2VpcHRzNzAsIEhlYWRlcnNEaXJlY3Rpb24sIE5ldHdvcmtQcmltaXRpdmVzLCBOb2RlRGF0YSwgUmVjZWlwdHMsCiAgICBSZWNlaXB0czY5LCBSZWNlaXB0czcwLAp9Owp1c2UgcmV0aF9uZXR3b3JrX2FwaTo6dGVzdF91dGlsczo6UGVlcnNIYW5kbGU7CnVzZSByZXRoX25ldHdvcmtfcDJwOjplcnJvcjo6UmVxdWVzdFJlc3VsdDsKdXNlIHJldGhfbmV0d29ya19wZWVyczo6UGVlcklkOwp1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6QmxvY2s7CnVzZSByZXRoX3N0b3JhZ2VfYXBpOjp7QmxvY2tSZWFkZXIsIEhlYWRlclByb3ZpZGVyfTsKdXNlIHN0ZDo6ewogICAgZnV0dXJlOjpGdXR1cmUsCiAgICBwaW46OlBpbiwKICAgIHRhc2s6OntDb250ZXh0LCBQb2xsfSwKICAgIHRpbWU6OkR1cmF0aW9uLAp9Owp1c2UgdG9raW86OnN5bmM6OnttcHNjOjpSZWNlaXZlciwgb25lc2hvdH07CnVzZSB0b2tpb19zdHJlYW06OndyYXBwZXJzOjpSZWNlaXZlclN0cmVhbTsKCi8vIExpbWl0czogPGh0dHBzOi8vZ2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9ibG9iL2IwZDQ0MzM4YmJjZWZlZTA0NGYxZjYzNWE4NDQ4N2NiYmQ4ZjA1MzgvZXRoL3Byb3RvY29scy9ldGgvaGFuZGxlci5nbyNMMzQtTDU2PgoKLy8vIE1heGltdW0gbnVtYmVyIG9mIHJlY2VpcHRzIHRvIHNlcnZlLgovLy8KLy8vIFVzZWQgdG8gbGltaXQgbG9va3Vwcy4KcHViIGNvbnN0IE1BWF9SRUNFSVBUU19TRVJWRTogdXNpemUgPSAxMDI0OwoKLy8vIE1heGltdW0gbnVtYmVyIG9mIGJsb2NrIGhlYWRlcnMgdG8gc2VydmUuCi8vLwovLy8gVXNlZCB0byBsaW1pdCBsb29rdXBzLgpwdWIgY29uc3QgTUFYX0hFQURFUlNfU0VSVkU6IHVzaXplID0gMTAyNDsKCi8vLyBNYXhpbXVtIG51bWJlciBvZiBibG9jayBoZWFkZXJzIHRvIHNlcnZlLgovLy8KLy8vIFVzZWQgdG8gbGltaXQgbG9va3Vwcy4gV2l0aCAyNEtCIGJsb2NrIHNpemVzIG5vd2FkYXlzLCB0aGUgcHJhY3RpY2FsIGxpbWl0IHdpbGwgYWx3YXlzIGJlCi8vLyBgU09GVF9SRVNQT05TRV9MSU1JVGAuCnB1YiBjb25zdCBNQVhfQk9ESUVTX1NFUlZFOiB1c2l6ZSA9IDEwMjQ7CgovLy8gTWF4aW11bSBzaXplIG9mIHJlcGxpZXMgdG8gZGF0YSByZXRyaWV2YWxzOiAyTUIKcHViIGNvbnN0IFNPRlRfUkVTUE9OU0VfTElNSVQ6IHVzaXplID0gMiAqIDEwMjQgKiAxMDI0OwoKLy8vIE1hbmFnZXMgZXRoIHJlbGF0ZWQgcmVxdWVzdHMgb24gdG9wIG9mIHRoZSBwMnAgbmV0d29yay4KLy8vCi8vLyBUaGlzIGNhbiBiZSBzcGF3bmVkIHRvIGFub3RoZXIgdGFzayBhbmQgaXMgc3VwcG9zZWQgdG8gYmUgcnVuIGFzIGJhY2tncm91bmQgc2VydmljZS4KI1tkZXJpdmUoRGVidWcpXQojW211c3RfdXNlID0gIk1hbmFnZXIgZG9lcyBub3RoaW5nIHVubGVzcyBwb2xsZWQuIl0KcHViIHN0cnVjdCBFdGhSZXF1ZXN0SGFuZGxlcjxDLCBOOiBOZXR3b3JrUHJpbWl0aXZlcyA9IEV0aE5ldHdvcmtQcmltaXRpdmVzPiB7CiAgICAvLy8gVGhlIGNsaWVudCB0eXBlIHRoYXQgY2FuIGludGVyYWN0IHdpdGggdGhlIGNoYWluLgogICAgY2xpZW50OiBDLAogICAgLy8vIFVzZWQgZm9yIHJlcG9ydGluZyBwZWVycy4KICAgIC8vIFRPRE8gdXNlIHRvIHJlcG9ydCBzcGFtbWVycwogICAgI1tleHBlY3QoZGVhZF9jb2RlKV0KICAgIHBlZXJzOiBQZWVyc0hhbmRsZSwKICAgIC8vLyBJbmNvbWluZyByZXF1ZXN0IGZyb20gdGhlIFtgTmV0d29ya01hbmFnZXJgXShjcmF0ZTo6TmV0d29ya01hbmFnZXIpLgogICAgaW5jb21pbmdfcmVxdWVzdHM6IFJlY2VpdmVyU3RyZWFtPEluY29taW5nRXRoUmVxdWVzdDxOPj4sCiAgICAvLy8gTWV0cmljcyBmb3IgdGhlIGV0aCByZXF1ZXN0IGhhbmRsZXIuCiAgICBtZXRyaWNzOiBFdGhSZXF1ZXN0SGFuZGxlck1ldHJpY3MsCn0KCi8vID09PSBpbXBsIEV0aFJlcXVlc3RIYW5kbGVyID09PQppbXBsPEMsIE46IE5ldHdvcmtQcmltaXRpdmVzPiBFdGhSZXF1ZXN0SGFuZGxlcjxDLCBOPiB7CiAgICAvLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlCiAgICBwdWIgZm4gbmV3KGNsaWVudDogQywgcGVlcnM6IFBlZXJzSGFuZGxlLCBpbmNvbWluZzogUmVjZWl2ZXI8SW5jb21pbmdFdGhSZXF1ZXN0PE4+PikgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIGNsaWVudCwKICAgICAgICAgICAgcGVlcnMsCiAgICAgICAgICAgIGluY29taW5nX3JlcXVlc3RzOiBSZWNlaXZlclN0cmVhbTo6bmV3KGluY29taW5nKSwKICAgICAgICAgICAgbWV0cmljczogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgIH0KICAgIH0KfQoKaW1wbDxDLCBOPiBFdGhSZXF1ZXN0SGFuZGxlcjxDLCBOPgp3aGVyZQogICAgTjogTmV0d29ya1ByaW1pdGl2ZXMsCiAgICBDOiBCbG9ja1JlYWRlciwKewogICAgLy8vIFJldHVybnMgdGhlIGxpc3Qgb2YgcmVxdWVzdGVkIGhlYWRlcnMKICAgIGZuIGdldF9oZWFkZXJzX3Jlc3BvbnNlKCZzZWxmLCByZXF1ZXN0OiBHZXRCbG9ja0hlYWRlcnMpIC0+IFZlYzxDOjpIZWFkZXI+IHsKICAgICAgICBsZXQgR2V0QmxvY2tIZWFkZXJzIHsgc3RhcnRfYmxvY2ssIGxpbWl0LCBza2lwLCBkaXJlY3Rpb24gfSA9IHJlcXVlc3Q7CgogICAgICAgIGxldCBtdXQgaGVhZGVycyA9IFZlYzo6bmV3KCk7CgogICAgICAgIGxldCBtdXQgYmxvY2s6IEJsb2NrSGFzaE9yTnVtYmVyID0gbWF0Y2ggc3RhcnRfYmxvY2sgewogICAgICAgICAgICBCbG9ja0hhc2hPck51bWJlcjo6SGFzaChzdGFydCkgPT4gc3RhcnQuaW50bygpLAogICAgICAgICAgICBCbG9ja0hhc2hPck51bWJlcjo6TnVtYmVyKG51bSkgPT4gewogICAgICAgICAgICAgICAgbGV0IFNvbWUoaGFzaCkgPSBzZWxmLmNsaWVudC5ibG9ja19oYXNoKG51bSkudW53cmFwX29yX2RlZmF1bHQoKSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGVhZGVycwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGhhc2guaW50bygpCiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBsZXQgc2tpcCA9IHNraXAgYXMgdTY0OwogICAgICAgIGxldCBtdXQgdG90YWxfYnl0ZXMgPSAwOwoKICAgICAgICBmb3IgXyBpbiAwLi5saW1pdCB7CiAgICAgICAgICAgIGlmIGxldCBTb21lKGhlYWRlcikgPSBzZWxmLmNsaWVudC5oZWFkZXJfYnlfaGFzaF9vcl9udW1iZXIoYmxvY2spLnVud3JhcF9vcl9kZWZhdWx0KCkgewogICAgICAgICAgICAgICAgbGV0IG51bWJlciA9IGhlYWRlci5udW1iZXIoKTsKICAgICAgICAgICAgICAgIGxldCBwYXJlbnRfaGFzaCA9IGhlYWRlci5wYXJlbnRfaGFzaCgpOwoKICAgICAgICAgICAgICAgIHRvdGFsX2J5dGVzICs9IGhlYWRlci5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGhlYWRlcnMucHVzaChoZWFkZXIpOwoKICAgICAgICAgICAgICAgIGlmIGhlYWRlcnMubGVuKCkgPj0gTUFYX0hFQURFUlNfU0VSVkUgfHwgdG90YWxfYnl0ZXMgPiBTT0ZUX1JFU1BPTlNFX0xJTUlUIHsKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG1hdGNoIGRpcmVjdGlvbiB7CiAgICAgICAgICAgICAgICAgICAgSGVhZGVyc0RpcmVjdGlvbjo6UmlzaW5nID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUobmV4dCkgPSBudW1iZXIuY2hlY2tlZF9hZGQoMSkuYW5kX3RoZW4ofG58IG4uY2hlY2tlZF9hZGQoc2tpcCkpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrID0gbmV4dC5pbnRvKCkKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgSGVhZGVyc0RpcmVjdGlvbjo6RmFsbGluZyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNraXAgPiAwIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByZXZlbnQgdW5kZXIgZmxvd3MgZm9yIGJsb2NrLm51bWJlciA9PSAwIGFuZCBgYmxvY2subnVtYmVyIC0gc2tpcCA8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAwYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUobmV4dCkgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlci5jaGVja2VkX3N1YigxKS5hbmRfdGhlbih8bnVtfCBudW0uY2hlY2tlZF9zdWIoc2tpcCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2sgPSBuZXh0LmludG8oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2sgPSBwYXJlbnRfaGFzaC5pbnRvKCkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGhlYWRlcnMKICAgIH0KCiAgICBmbiBvbl9oZWFkZXJzX3JlcXVlc3QoCiAgICAgICAgJnNlbGYsCiAgICAgICAgX3BlZXJfaWQ6IFBlZXJJZCwKICAgICAgICByZXF1ZXN0OiBHZXRCbG9ja0hlYWRlcnMsCiAgICAgICAgcmVzcG9uc2U6IG9uZXNob3Q6OlNlbmRlcjxSZXF1ZXN0UmVzdWx0PEJsb2NrSGVhZGVyczxDOjpIZWFkZXI+Pj4sCiAgICApIHsKICAgICAgICBzZWxmLm1ldHJpY3MuZXRoX2hlYWRlcnNfcmVxdWVzdHNfcmVjZWl2ZWRfdG90YWwuaW5jcmVtZW50KDEpOwogICAgICAgIGxldCBoZWFkZXJzID0gc2VsZi5nZXRfaGVhZGVyc19yZXNwb25zZShyZXF1ZXN0KTsKICAgICAgICBsZXQgXyA9IHJlc3BvbnNlLnNlbmQoT2soQmxvY2tIZWFkZXJzKGhlYWRlcnMpKSk7CiAgICB9CgogICAgZm4gb25fYm9kaWVzX3JlcXVlc3QoCiAgICAgICAgJnNlbGYsCiAgICAgICAgX3BlZXJfaWQ6IFBlZXJJZCwKICAgICAgICByZXF1ZXN0OiBHZXRCbG9ja0JvZGllcywKICAgICAgICByZXNwb25zZTogb25lc2hvdDo6U2VuZGVyPFJlcXVlc3RSZXN1bHQ8QmxvY2tCb2RpZXM8PEM6OkJsb2NrIGFzIEJsb2NrPjo6Qm9keT4+PiwKICAgICkgewogICAgICAgIHNlbGYubWV0cmljcy5ldGhfYm9kaWVzX3JlcXVlc3RzX3JlY2VpdmVkX3RvdGFsLmluY3JlbWVudCgxKTsKICAgICAgICBsZXQgbXV0IGJvZGllcyA9IFZlYzo6bmV3KCk7CgogICAgICAgIGxldCBtdXQgdG90YWxfYnl0ZXMgPSAwOwoKICAgICAgICBmb3IgaGFzaCBpbiByZXF1ZXN0LjAgewogICAgICAgICAgICBpZiBsZXQgU29tZShibG9jaykgPSBzZWxmLmNsaWVudC5ibG9ja19ieV9oYXNoKGhhc2gpLnVud3JhcF9vcl9kZWZhdWx0KCkgewogICAgICAgICAgICAgICAgbGV0IGJvZHkgPSBibG9jay5pbnRvX2JvZHkoKTsKICAgICAgICAgICAgICAgIHRvdGFsX2J5dGVzICs9IGJvZHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBib2RpZXMucHVzaChib2R5KTsKCiAgICAgICAgICAgICAgICBpZiBib2RpZXMubGVuKCkgPj0gTUFYX0JPRElFU19TRVJWRSB8fCB0b3RhbF9ieXRlcyA+IFNPRlRfUkVTUE9OU0VfTElNSVQgewogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXQgXyA9IHJlc3BvbnNlLnNlbmQoT2soQmxvY2tCb2RpZXMoYm9kaWVzKSkpOwogICAgfQoKICAgIGZuIG9uX3JlY2VpcHRzX3JlcXVlc3QoCiAgICAgICAgJnNlbGYsCiAgICAgICAgX3BlZXJfaWQ6IFBlZXJJZCwKICAgICAgICByZXF1ZXN0OiBHZXRSZWNlaXB0cywKICAgICAgICByZXNwb25zZTogb25lc2hvdDo6U2VuZGVyPFJlcXVlc3RSZXN1bHQ8UmVjZWlwdHM8Qzo6UmVjZWlwdD4+PiwKICAgICkgewogICAgICAgIHNlbGYubWV0cmljcy5ldGhfcmVjZWlwdHNfcmVxdWVzdHNfcmVjZWl2ZWRfdG90YWwuaW5jcmVtZW50KDEpOwoKICAgICAgICBsZXQgcmVjZWlwdHMgPSBzZWxmLmdldF9yZWNlaXB0c19yZXNwb25zZShyZXF1ZXN0LCB8cmVjZWlwdHNfYnlfYmxvY2t8IHsKICAgICAgICAgICAgcmVjZWlwdHNfYnlfYmxvY2suaW50b19pdGVyKCkubWFwKFJlY2VpcHRXaXRoQmxvb206OmZyb20pLmNvbGxlY3Q6OjxWZWM8Xz4+KCkKICAgICAgICB9KTsKCiAgICAgICAgbGV0IF8gPSByZXNwb25zZS5zZW5kKE9rKFJlY2VpcHRzKHJlY2VpcHRzKSkpOwogICAgfQoKICAgIGZuIG9uX3JlY2VpcHRzNjlfcmVxdWVzdCgKICAgICAgICAmc2VsZiwKICAgICAgICBfcGVlcl9pZDogUGVlcklkLAogICAgICAgIHJlcXVlc3Q6IEdldFJlY2VpcHRzLAogICAgICAgIHJlc3BvbnNlOiBvbmVzaG90OjpTZW5kZXI8UmVxdWVzdFJlc3VsdDxSZWNlaXB0czY5PEM6OlJlY2VpcHQ+Pj4sCiAgICApIHsKICAgICAgICBzZWxmLm1ldHJpY3MuZXRoX3JlY2VpcHRzX3JlcXVlc3RzX3JlY2VpdmVkX3RvdGFsLmluY3JlbWVudCgxKTsKCiAgICAgICAgbGV0IHJlY2VpcHRzID0gc2VsZi5nZXRfcmVjZWlwdHNfcmVzcG9uc2UocmVxdWVzdCwgfHJlY2VpcHRzX2J5X2Jsb2NrfCB7CiAgICAgICAgICAgIC8vIHNraXAgYmxvb20gZmlsdGVyIGZvciBldGg2OQogICAgICAgICAgICByZWNlaXB0c19ieV9ibG9jawogICAgICAgIH0pOwoKICAgICAgICBsZXQgXyA9IHJlc3BvbnNlLnNlbmQoT2soUmVjZWlwdHM2OShyZWNlaXB0cykpKTsKICAgIH0KCiAgICAvLy8gSGFuZGxlcyBwYXJ0aWFsIHJlc3BvbnNlcyBmb3IgW2BHZXRSZWNlaXB0czcwYF0gcXVlcmllcy4KICAgIC8vLwogICAgLy8vIFRoaXMgd2lsbCBhZGhlcmUgdG8gdGhlIHNvZnQgbGltaXQgYnV0IGFsbG93IGZpbGxpbmcgdGhlIGxhc3QgdmVjIHBhcnRpYWxseS4KICAgIGZuIG9uX3JlY2VpcHRzNzBfcmVxdWVzdCgKICAgICAgICAmc2VsZiwKICAgICAgICBfcGVlcl9pZDogUGVlcklkLAogICAgICAgIHJlcXVlc3Q6IEdldFJlY2VpcHRzNzAsCiAgICAgICAgcmVzcG9uc2U6IG9uZXNob3Q6OlNlbmRlcjxSZXF1ZXN0UmVzdWx0PFJlY2VpcHRzNzA8Qzo6UmVjZWlwdD4+PiwKICAgICkgewogICAgICAgIHNlbGYubWV0cmljcy5ldGhfcmVjZWlwdHNfcmVxdWVzdHNfcmVjZWl2ZWRfdG90YWwuaW5jcmVtZW50KDEpOwoKICAgICAgICBsZXQgR2V0UmVjZWlwdHM3MCB7IGZpcnN0X2Jsb2NrX3JlY2VpcHRfaW5kZXgsIGJsb2NrX2hhc2hlcyB9ID0gcmVxdWVzdDsKCiAgICAgICAgbGV0IG11dCByZWNlaXB0cyA9IFZlYzo6bmV3KCk7CiAgICAgICAgbGV0IG11dCB0b3RhbF9ieXRlcyA9IDB1c2l6ZTsKICAgICAgICBsZXQgbXV0IGxhc3RfYmxvY2tfaW5jb21wbGV0ZSA9IGZhbHNlOwoKICAgICAgICBmb3IgKGlkeCwgaGFzaCkgaW4gYmxvY2tfaGFzaGVzLmludG9faXRlcigpLmVudW1lcmF0ZSgpIHsKICAgICAgICAgICAgaWYgaWR4ID49IE1BWF9SRUNFSVBUU19TRVJWRSB7CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgU29tZShtdXQgYmxvY2tfcmVjZWlwdHMpID0KICAgICAgICAgICAgICAgIHNlbGYuY2xpZW50LnJlY2VpcHRzX2J5X2Jsb2NrKEJsb2NrSGFzaE9yTnVtYmVyOjpIYXNoKGhhc2gpKS51bndyYXBfb3JfZGVmYXVsdCgpCiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIGlkeCA9PSAwICYmIGZpcnN0X2Jsb2NrX3JlY2VpcHRfaW5kZXggPiAwIHsKICAgICAgICAgICAgICAgIGxldCBza2lwID0gZmlyc3RfYmxvY2tfcmVjZWlwdF9pbmRleCBhcyB1c2l6ZTsKICAgICAgICAgICAgICAgIGlmIHNraXAgPj0gYmxvY2tfcmVjZWlwdHMubGVuKCkgewogICAgICAgICAgICAgICAgICAgIGJsb2NrX3JlY2VpcHRzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJsb2NrX3JlY2VpcHRzLmRyYWluKDAuLnNraXApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgYmxvY2tfc2l6ZSA9IGJsb2NrX3JlY2VpcHRzLmxlbmd0aCgpOwoKICAgICAgICAgICAgaWYgdG90YWxfYnl0ZXMgKyBibG9ja19zaXplIDw9IFNPRlRfUkVTUE9OU0VfTElNSVQgewogICAgICAgICAgICAgICAgdG90YWxfYnl0ZXMgKz0gYmxvY2tfc2l6ZTsKICAgICAgICAgICAgICAgIHJlY2VpcHRzLnB1c2goYmxvY2tfcmVjZWlwdHMpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBtdXQgcGFydGlhbF9ibG9jayA9IFZlYzo6bmV3KCk7CiAgICAgICAgICAgIGZvciByZWNlaXB0IGluIGJsb2NrX3JlY2VpcHRzIHsKICAgICAgICAgICAgICAgIGxldCByZWNlaXB0X3NpemUgPSByZWNlaXB0Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgaWYgdG90YWxfYnl0ZXMgKyByZWNlaXB0X3NpemUgPiBTT0ZUX1JFU1BPTlNFX0xJTUlUIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRvdGFsX2J5dGVzICs9IHJlY2VpcHRfc2l6ZTsKICAgICAgICAgICAgICAgIHBhcnRpYWxfYmxvY2sucHVzaChyZWNlaXB0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmVjZWlwdHMucHVzaChwYXJ0aWFsX2Jsb2NrKTsKICAgICAgICAgICAgbGFzdF9ibG9ja19pbmNvbXBsZXRlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBsZXQgXyA9IHJlc3BvbnNlLnNlbmQoT2soUmVjZWlwdHM3MCB7IGxhc3RfYmxvY2tfaW5jb21wbGV0ZSwgcmVjZWlwdHMgfSkpOwogICAgfQoKICAgICNbaW5saW5lXQogICAgZm4gZ2V0X3JlY2VpcHRzX3Jlc3BvbnNlPFQsIEY+KCZzZWxmLCByZXF1ZXN0OiBHZXRSZWNlaXB0cywgdHJhbnNmb3JtX2ZuOiBGKSAtPiBWZWM8VmVjPFQ+PgogICAgd2hlcmUKICAgICAgICBGOiBGbihWZWM8Qzo6UmVjZWlwdD4pIC0+IFZlYzxUPiwKICAgICAgICBUOiBFbmNvZGFibGUsCiAgICB7CiAgICAgICAgbGV0IG11dCByZWNlaXB0cyA9IFZlYzo6bmV3KCk7CiAgICAgICAgbGV0IG11dCB0b3RhbF9ieXRlcyA9IDA7CgogICAgICAgIGZvciBoYXNoIGluIHJlcXVlc3QuMCB7CiAgICAgICAgICAgIGlmIGxldCBTb21lKHJlY2VpcHRzX2J5X2Jsb2NrKSA9CiAgICAgICAgICAgICAgICBzZWxmLmNsaWVudC5yZWNlaXB0c19ieV9ibG9jayhCbG9ja0hhc2hPck51bWJlcjo6SGFzaChoYXNoKSkudW53cmFwX29yX2RlZmF1bHQoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXQgdHJhbnNmb3JtZWRfcmVjZWlwdHMgPSB0cmFuc2Zvcm1fZm4ocmVjZWlwdHNfYnlfYmxvY2spOwogICAgICAgICAgICAgICAgdG90YWxfYnl0ZXMgKz0gdHJhbnNmb3JtZWRfcmVjZWlwdHMubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICByZWNlaXB0cy5wdXNoKHRyYW5zZm9ybWVkX3JlY2VpcHRzKTsKCiAgICAgICAgICAgICAgICBpZiByZWNlaXB0cy5sZW4oKSA+PSBNQVhfUkVDRUlQVFNfU0VSVkUgfHwgdG90YWxfYnl0ZXMgPiBTT0ZUX1JFU1BPTlNFX0xJTUlUIHsKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmVjZWlwdHMKICAgIH0KfQoKLy8vIEFuIGVuZGxlc3MgZnV0dXJlLgovLy8KLy8vIFRoaXMgc2hvdWxkIGJlIHNwYXduZWQgb3IgdXNlZCBhcyBwYXJ0IG9mIGB0b2tpbzo6c2VsZWN0IWAuCmltcGw8QywgTj4gRnV0dXJlIGZvciBFdGhSZXF1ZXN0SGFuZGxlcjxDLCBOPgp3aGVyZQogICAgTjogTmV0d29ya1ByaW1pdGl2ZXMsCiAgICBDOiBCbG9ja1JlYWRlcjxCbG9jayA9IE46OkJsb2NrLCBSZWNlaXB0ID0gTjo6UmVjZWlwdD4KICAgICAgICArIEhlYWRlclByb3ZpZGVyPEhlYWRlciA9IE46OkJsb2NrSGVhZGVyPgogICAgICAgICsgVW5waW4sCnsKICAgIHR5cGUgT3V0cHV0ID0gKCk7CgogICAgZm4gcG9sbChzZWxmOiBQaW48Jm11dCBTZWxmPiwgY3g6ICZtdXQgQ29udGV4dDwnXz4pIC0+IFBvbGw8U2VsZjo6T3V0cHV0PiB7CiAgICAgICAgbGV0IHRoaXMgPSBzZWxmLmdldF9tdXQoKTsKCiAgICAgICAgbGV0IG11dCBhY2MgPSBEdXJhdGlvbjo6WkVSTzsKICAgICAgICBsZXQgbWF5YmVfbW9yZV9pbmNvbWluZ19yZXF1ZXN0cyA9IG1ldGVyZWRfcG9sbF9uZXN0ZWRfc3RyZWFtX3dpdGhfYnVkZ2V0ISgKICAgICAgICAgICAgYWNjLAogICAgICAgICAgICAibmV0OjpldGgiLAogICAgICAgICAgICAiSW5jb21pbmcgZXRoIHJlcXVlc3RzIHN0cmVhbSIsCiAgICAgICAgICAgIERFRkFVTFRfQlVER0VUX1RSWV9EUkFJTl9ET1dOTE9BREVSUywKICAgICAgICAgICAgdGhpcy5pbmNvbWluZ19yZXF1ZXN0cy5wb2xsX25leHRfdW5waW4oY3gpLAogICAgICAgICAgICB8aW5jb21pbmd8IHsKICAgICAgICAgICAgICAgIG1hdGNoIGluY29taW5nIHsKICAgICAgICAgICAgICAgICAgICBJbmNvbWluZ0V0aFJlcXVlc3Q6OkdldEJsb2NrSGVhZGVycyB7IHBlZXJfaWQsIHJlcXVlc3QsIHJlc3BvbnNlIH0gPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uX2hlYWRlcnNfcmVxdWVzdChwZWVyX2lkLCByZXF1ZXN0LCByZXNwb25zZSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgSW5jb21pbmdFdGhSZXF1ZXN0OjpHZXRCbG9ja0JvZGllcyB7IHBlZXJfaWQsIHJlcXVlc3QsIHJlc3BvbnNlIH0gPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uX2JvZGllc19yZXF1ZXN0KHBlZXJfaWQsIHJlcXVlc3QsIHJlc3BvbnNlKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBJbmNvbWluZ0V0aFJlcXVlc3Q6OkdldE5vZGVEYXRhIHsgLi4gfSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWV0cmljcy5ldGhfbm9kZV9kYXRhX3JlcXVlc3RzX3JlY2VpdmVkX3RvdGFsLmluY3JlbWVudCgxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgSW5jb21pbmdFdGhSZXF1ZXN0OjpHZXRSZWNlaXB0cyB7IHBlZXJfaWQsIHJlcXVlc3QsIHJlc3BvbnNlIH0gPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uX3JlY2VpcHRzX3JlcXVlc3QocGVlcl9pZCwgcmVxdWVzdCwgcmVzcG9uc2UpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIEluY29taW5nRXRoUmVxdWVzdDo6R2V0UmVjZWlwdHM2OSB7IHBlZXJfaWQsIHJlcXVlc3QsIHJlc3BvbnNlIH0gPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uX3JlY2VpcHRzNjlfcmVxdWVzdChwZWVyX2lkLCByZXF1ZXN0LCByZXNwb25zZSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgSW5jb21pbmdFdGhSZXF1ZXN0OjpHZXRSZWNlaXB0czcwIHsgcGVlcl9pZCwgcmVxdWVzdCwgcmVzcG9uc2UgfSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25fcmVjZWlwdHM3MF9yZXF1ZXN0KHBlZXJfaWQsIHJlcXVlc3QsIHJlc3BvbnNlKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICApOwoKICAgICAgICB0aGlzLm1ldHJpY3MuYWNjX2R1cmF0aW9uX3BvbGxfZXRoX3JlcV9oYW5kbGVyLnNldChhY2MuYXNfc2Vjc19mNjQoKSk7CgogICAgICAgIC8vIHN0cmVhbSBpcyBmdWxseSBkcmFpbmVkIGFuZCBpbXBvcnQgZnV0dXJlcyBwZW5kaW5nCiAgICAgICAgaWYgbWF5YmVfbW9yZV9pbmNvbWluZ19yZXF1ZXN0cyB7CiAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB3ZSdyZSB3b2tlbiB1cCBhZ2FpbgogICAgICAgICAgICBjeC53YWtlcigpLndha2VfYnlfcmVmKCk7CiAgICAgICAgfQoKICAgICAgICBQb2xsOjpQZW5kaW5nCiAgICB9Cn0KCi8vLyBBbGwgYGV0aGAgcmVxdWVzdCByZWxhdGVkIHRvIGJsb2NrcyBkZWxlZ2F0ZWQgYnkgdGhlIG5ldHdvcmsuCiNbZGVyaXZlKERlYnVnKV0KcHViIGVudW0gSW5jb21pbmdFdGhSZXF1ZXN0PE46IE5ldHdvcmtQcmltaXRpdmVzID0gRXRoTmV0d29ya1ByaW1pdGl2ZXM+IHsKICAgIC8vLyBSZXF1ZXN0IEJsb2NrIGhlYWRlcnMgZnJvbSB0aGUgcGVlci4KICAgIC8vLwogICAgLy8vIFRoZSByZXNwb25zZSBzaG91bGQgYmUgc2VudCB0aHJvdWdoIHRoZSBjaGFubmVsLgogICAgR2V0QmxvY2tIZWFkZXJzIHsKICAgICAgICAvLy8gVGhlIElEIG9mIHRoZSBwZWVyIHRvIHJlcXVlc3QgYmxvY2sgaGVhZGVycyBmcm9tLgogICAgICAgIHBlZXJfaWQ6IFBlZXJJZCwKICAgICAgICAvLy8gVGhlIHNwZWNpZmljIGJsb2NrIGhlYWRlcnMgcmVxdWVzdGVkLgogICAgICAgIHJlcXVlc3Q6IEdldEJsb2NrSGVhZGVycywKICAgICAgICAvLy8gVGhlIGNoYW5uZWwgc2VuZGVyIGZvciB0aGUgcmVzcG9uc2UgY29udGFpbmluZyBibG9jayBoZWFkZXJzLgogICAgICAgIHJlc3BvbnNlOiBvbmVzaG90OjpTZW5kZXI8UmVxdWVzdFJlc3VsdDxCbG9ja0hlYWRlcnM8Tjo6QmxvY2tIZWFkZXI+Pj4sCiAgICB9LAogICAgLy8vIFJlcXVlc3QgQmxvY2sgYm9kaWVzIGZyb20gdGhlIHBlZXIuCiAgICAvLy8KICAgIC8vLyBUaGUgcmVzcG9uc2Ugc2hvdWxkIGJlIHNlbnQgdGhyb3VnaCB0aGUgY2hhbm5lbC4KICAgIEdldEJsb2NrQm9kaWVzIHsKICAgICAgICAvLy8gVGhlIElEIG9mIHRoZSBwZWVyIHRvIHJlcXVlc3QgYmxvY2sgYm9kaWVzIGZyb20uCiAgICAgICAgcGVlcl9pZDogUGVlcklkLAogICAgICAgIC8vLyBUaGUgc3BlY2lmaWMgYmxvY2sgYm9kaWVzIHJlcXVlc3RlZC4KICAgICAgICByZXF1ZXN0OiBHZXRCbG9ja0JvZGllcywKICAgICAgICAvLy8gVGhlIGNoYW5uZWwgc2VuZGVyIGZvciB0aGUgcmVzcG9uc2UgY29udGFpbmluZyBibG9jayBib2RpZXMuCiAgICAgICAgcmVzcG9uc2U6IG9uZXNob3Q6OlNlbmRlcjxSZXF1ZXN0UmVzdWx0PEJsb2NrQm9kaWVzPE46OkJsb2NrQm9keT4+PiwKICAgIH0sCiAgICAvLy8gUmVxdWVzdCBOb2RlIERhdGEgZnJvbSB0aGUgcGVlci4KICAgIC8vLwogICAgLy8vIFRoZSByZXNwb25zZSBzaG91bGQgYmUgc2VudCB0aHJvdWdoIHRoZSBjaGFubmVsLgogICAgR2V0Tm9kZURhdGEgewogICAgICAgIC8vLyBUaGUgSUQgb2YgdGhlIHBlZXIgdG8gcmVxdWVzdCBub2RlIGRhdGEgZnJvbS4KICAgICAgICBwZWVyX2lkOiBQZWVySWQsCiAgICAgICAgLy8vIFRoZSBzcGVjaWZpYyBub2RlIGRhdGEgcmVxdWVzdGVkLgogICAgICAgIHJlcXVlc3Q6IEdldE5vZGVEYXRhLAogICAgICAgIC8vLyBUaGUgY2hhbm5lbCBzZW5kZXIgZm9yIHRoZSByZXNwb25zZSBjb250YWluaW5nIG5vZGUgZGF0YS4KICAgICAgICByZXNwb25zZTogb25lc2hvdDo6U2VuZGVyPFJlcXVlc3RSZXN1bHQ8Tm9kZURhdGE+PiwKICAgIH0sCiAgICAvLy8gUmVxdWVzdCBSZWNlaXB0cyBmcm9tIHRoZSBwZWVyLgogICAgLy8vCiAgICAvLy8gVGhlIHJlc3BvbnNlIHNob3VsZCBiZSBzZW50IHRocm91Z2ggdGhlIGNoYW5uZWwuCiAgICBHZXRSZWNlaXB0cyB7CiAgICAgICAgLy8vIFRoZSBJRCBvZiB0aGUgcGVlciB0byByZXF1ZXN0IHJlY2VpcHRzIGZyb20uCiAgICAgICAgcGVlcl9pZDogUGVlcklkLAogICAgICAgIC8vLyBUaGUgc3BlY2lmaWMgcmVjZWlwdHMgcmVxdWVzdGVkLgogICAgICAgIHJlcXVlc3Q6IEdldFJlY2VpcHRzLAogICAgICAgIC8vLyBUaGUgY2hhbm5lbCBzZW5kZXIgZm9yIHRoZSByZXNwb25zZSBjb250YWluaW5nIHJlY2VpcHRzLgogICAgICAgIHJlc3BvbnNlOiBvbmVzaG90OjpTZW5kZXI8UmVxdWVzdFJlc3VsdDxSZWNlaXB0czxOOjpSZWNlaXB0Pj4+LAogICAgfSwKICAgIC8vLyBSZXF1ZXN0IFJlY2VpcHRzIGZyb20gdGhlIHBlZXIgd2l0aG91dCBibG9vbSBmaWx0ZXIuCiAgICAvLy8KICAgIC8vLyBUaGUgcmVzcG9uc2Ugc2hvdWxkIGJlIHNlbnQgdGhyb3VnaCB0aGUgY2hhbm5lbC4KICAgIEdldFJlY2VpcHRzNjkgewogICAgICAgIC8vLyBUaGUgSUQgb2YgdGhlIHBlZXIgdG8gcmVxdWVzdCByZWNlaXB0cyBmcm9tLgogICAgICAgIHBlZXJfaWQ6IFBlZXJJZCwKICAgICAgICAvLy8gVGhlIHNwZWNpZmljIHJlY2VpcHRzIHJlcXVlc3RlZC4KICAgICAgICByZXF1ZXN0OiBHZXRSZWNlaXB0cywKICAgICAgICAvLy8gVGhlIGNoYW5uZWwgc2VuZGVyIGZvciB0aGUgcmVzcG9uc2UgY29udGFpbmluZyBSZWNlaXB0czY5LgogICAgICAgIHJlc3BvbnNlOiBvbmVzaG90OjpTZW5kZXI8UmVxdWVzdFJlc3VsdDxSZWNlaXB0czY5PE46OlJlY2VpcHQ+Pj4sCiAgICB9LAogICAgLy8vIFJlcXVlc3QgUmVjZWlwdHMgZnJvbSB0aGUgcGVlciB1c2luZyBldGgvNzAuCiAgICAvLy8KICAgIC8vLyBUaGUgcmVzcG9uc2Ugc2hvdWxkIGJlIHNlbnQgdGhyb3VnaCB0aGUgY2hhbm5lbC4KICAgIEdldFJlY2VpcHRzNzAgewogICAgICAgIC8vLyBUaGUgSUQgb2YgdGhlIHBlZXIgdG8gcmVxdWVzdCByZWNlaXB0cyBmcm9tLgogICAgICAgIHBlZXJfaWQ6IFBlZXJJZCwKICAgICAgICAvLy8gVGhlIHNwZWNpZmljIHJlY2VpcHRzIHJlcXVlc3RlZCBpbmNsdWRpbmcgdGhlIGBmaXJzdEJsb2NrUmVjZWlwdEluZGV4YC4KICAgICAgICByZXF1ZXN0OiBHZXRSZWNlaXB0czcwLAogICAgICAgIC8vLyBUaGUgY2hhbm5lbCBzZW5kZXIgZm9yIHRoZSByZXNwb25zZSBjb250YWluaW5nIFJlY2VpcHRzNzAuCiAgICAgICAgcmVzcG9uc2U6IG9uZXNob3Q6OlNlbmRlcjxSZXF1ZXN0UmVzdWx0PFJlY2VpcHRzNzA8Tjo6UmVjZWlwdD4+PiwKICAgIH0sCn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL25ldC9uZXR3b3JrL3NyYy9wZWVycy5ycyI+Ci8vISBQZWVyIHJlbGF0ZWQgaW1wbGVtZW50YXRpb25zCgp1c2UgY3JhdGU6OnsKICAgIGVycm9yOjpTZXNzaW9uRXJyb3IsCiAgICBzZXNzaW9uOjp7RGlyZWN0aW9uLCBQZW5kaW5nU2Vzc2lvbkhhbmRzaGFrZUVycm9yfSwKICAgIHN3YXJtOjpOZXR3b3JrQ29ubmVjdGlvblN0YXRlLAogICAgdHJ1c3RlZF9wZWVyc19yZXNvbHZlcjo6VHJ1c3RlZFBlZXJzUmVzb2x2ZXIsCn07CnVzZSBmdXR1cmVzOjpTdHJlYW1FeHQ7Cgp1c2UgcmV0aF9ldGhfd2lyZTo6e2Vycm9yczo6RXRoU3RyZWFtRXJyb3IsIERpc2Nvbm5lY3RSZWFzb259Owp1c2UgcmV0aF9ldGhlcmV1bV9mb3Jrczo6Rm9ya0lkOwp1c2UgcmV0aF9uZXRfYmFubGlzdDo6QmFuTGlzdDsKdXNlIHJldGhfbmV0d29ya19hcGk6OnRlc3RfdXRpbHM6OntQZWVyQ29tbWFuZCwgUGVlcnNIYW5kbGV9Owp1c2UgcmV0aF9uZXR3b3JrX3BlZXJzOjp7Tm9kZVJlY29yZCwgUGVlcklkfTsKdXNlIHJldGhfbmV0d29ya190eXBlczo6ewogICAgaXNfY29ubmVjdGlvbl9mYWlsZWRfcmVwdXRhdGlvbiwKICAgIHBlZXJzOjp7CiAgICAgICAgY29uZmlnOjpQZWVyQmFja29mZkR1cmF0aW9ucywKICAgICAgICByZXB1dGF0aW9uOjp7REVGQVVMVF9SRVBVVEFUSU9OLCBNQVhfVFJVU1RFRF9QRUVSX1JFUFVUQVRJT05fQ0hBTkdFfSwKICAgIH0sCiAgICBDb25uZWN0aW9uc0NvbmZpZywgUGVlciwgUGVlckFkZHIsIFBlZXJDb25uZWN0aW9uU3RhdGUsIFBlZXJLaW5kLCBQZWVyc0NvbmZpZywKICAgIFJlcHV0YXRpb25DaGFuZ2VLaW5kLCBSZXB1dGF0aW9uQ2hhbmdlT3V0Y29tZSwgUmVwdXRhdGlvbkNoYW5nZVdlaWdodHMsCn07CnVzZSBzdGQ6OnsKICAgIGNvbGxlY3Rpb25zOjp7aGFzaF9tYXA6OkVudHJ5LCBIYXNoTWFwLCBIYXNoU2V0LCBWZWNEZXF1ZX0sCiAgICBmbXQ6OkRpc3BsYXksCiAgICBpbzo6e3NlbGZ9LAogICAgbmV0Ojp7SXBBZGRyLCBTb2NrZXRBZGRyfSwKICAgIHRhc2s6OntDb250ZXh0LCBQb2xsfSwKICAgIHRpbWU6OkR1cmF0aW9uLAp9Owp1c2UgdGhpc2Vycm9yOjpFcnJvcjsKdXNlIHRva2lvOjp7CiAgICBzeW5jOjptcHNjLAogICAgdGltZTo6e0luc3RhbnQsIEludGVydmFsfSwKfTsKdXNlIHRva2lvX3N0cmVhbTo6d3JhcHBlcnM6OlVuYm91bmRlZFJlY2VpdmVyU3RyZWFtOwp1c2UgdHJhY2luZzo6e3RyYWNlLCB3YXJufTsKCi8vLyBNYWludGFpbnMgdGhlIHN0YXRlIG9mIF9hbGxfIHRoZSBwZWVycyBrbm93biB0byB0aGUgbmV0d29yay4KLy8vCi8vLyBUaGlzIGlzIHN1cHBvc2VkIHRvIGJlIG93bmVkIGJ5IHRoZSBuZXR3b3JrIGl0c2VsZiwgYnV0IGNhbiBiZSByZWFjaGVkIHZpYSB0aGUgW2BQZWVyc0hhbmRsZWBdLgovLy8gRnJvbSB0aGlzIHR5cGUsIGNvbm5lY3Rpb25zIHRvIHBlZXJzIGFyZSBlc3RhYmxpc2hlZCBvciBkaXNjb25uZWN0ZWQsIHNlZSBbYFBlZXJBY3Rpb25gXS4KLy8vCi8vLyBUaGUgW2BQZWVyc01hbmFnZXJgXSB3aWxsIGJlIG5vdGlmaWVkIG9uIHBlZXIgcmVsYXRlZCBjaGFuZ2VzCiNbZGVyaXZlKERlYnVnKV0KcHViIHN0cnVjdCBQZWVyc01hbmFnZXIgewogICAgLy8vIEFsbCBwZWVycyBrbm93biB0byB0aGUgbmV0d29yawogICAgcGVlcnM6IEhhc2hNYXA8UGVlcklkLCBQZWVyPiwKICAgIC8vLyBUaGUgc2V0IG9mIHRydXN0ZWQgcGVlciBpZHMuCiAgICAvLy8KICAgIC8vLyBUaGlzIHRyYWNrcyBwZWVyIGlkcyB0aGF0IGFyZSBjb25zaWRlcmVkIHRydXN0ZWQsIGJ1dCBmb3Igd2hpY2ggd2UgZG9uJ3QgbmVjZXNzYXJpbHkgaGF2ZQogICAgLy8vIGFuIGFkZHJlc3M6IFtgU2VsZjo6YWRkX3RydXN0ZWRfcGVlcl9pZGBdCiAgICB0cnVzdGVkX3BlZXJfaWRzOiBIYXNoU2V0PFBlZXJJZD4sCiAgICAvLy8gQSByZXNvbHZlciB1c2VkIHRvIHBlcmlvZGljYWxseSByZXNvbHZlIEROUyBuYW1lcyBmb3IgdHJ1c3RlZCBwZWVycy4gVGhpcyB1cGRhdGVzIHRoZQogICAgLy8vIHBlZXIncyBhZGRyZXNzIHdoZW4gdGhlIEROUyByZWNvcmRzIGNoYW5nZS4KICAgIHRydXN0ZWRfcGVlcnNfcmVzb2x2ZXI6IFRydXN0ZWRQZWVyc1Jlc29sdmVyLAogICAgLy8vIENvcHkgb2YgdGhlIHNlbmRlciBoYWxmLCBzbyBuZXcgW2BQZWVyc0hhbmRsZWBdIGNhbiBiZSBjcmVhdGVkIG9uIGRlbWFuZC4KICAgIG1hbmFnZXJfdHg6IG1wc2M6OlVuYm91bmRlZFNlbmRlcjxQZWVyQ29tbWFuZD4sCiAgICAvLy8gUmVjZWl2ZXIgaGFsZiBvZiB0aGUgY29tbWFuZCBjaGFubmVsLgogICAgaGFuZGxlX3J4OiBVbmJvdW5kZWRSZWNlaXZlclN0cmVhbTxQZWVyQ29tbWFuZD4sCiAgICAvLy8gQnVmZmVyZWQgYWN0aW9ucyB1bnRpbCB0aGUgbWFuYWdlciBpcyBwb2xsZWQuCiAgICBxdWV1ZWRfYWN0aW9uczogVmVjRGVxdWU8UGVlckFjdGlvbj4sCiAgICAvLy8gSW50ZXJ2YWwgZm9yIHRyaWdnZXJpbmcgY29ubmVjdGlvbnMgaWYgdGhlcmUgYXJlIGZyZWUgc2xvdHMuCiAgICByZWZpbGxfc2xvdHNfaW50ZXJ2YWw6IEludGVydmFsLAogICAgLy8vIEhvdyB0byB3ZWlnaCByZXB1dGF0aW9uIGNoYW5nZXMKICAgIHJlcHV0YXRpb25fd2VpZ2h0czogUmVwdXRhdGlvbkNoYW5nZVdlaWdodHMsCiAgICAvLy8gVHJhY2tzIGN1cnJlbnQgc2xvdCBzdGF0cy4KICAgIGNvbm5lY3Rpb25faW5mbzogQ29ubmVjdGlvbkluZm8sCiAgICAvLy8gVHJhY2tzIHVud2FudGVkIGlwcy9wZWVyIGlkcy4KICAgIGJhbl9saXN0OiBCYW5MaXN0LAogICAgLy8vIFRyYWNrcyBjdXJyZW50bHkgYmFja2VkIG9mZiBwZWVycy4KICAgIGJhY2tlZF9vZmZfcGVlcnM6IEhhc2hNYXA8UGVlcklkLCBzdGQ6OnRpbWU6Okluc3RhbnQ+LAogICAgLy8vIEludGVydmFsIGF0IHdoaWNoIHRvIGNoZWNrIGZvciBwZWVycyB0byB1bmJhbiBhbmQgcmVsZWFzZSBmcm9tIHRoZSBiYWNrb2ZmIG1hcC4KICAgIHJlbGVhc2VfaW50ZXJ2YWw6IEludGVydmFsLAogICAgLy8vIEhvdyBsb25nIHRvIGJhbiBiYWQgcGVlcnMuCiAgICBiYW5fZHVyYXRpb246IER1cmF0aW9uLAogICAgLy8vIEhvdyBsb25nIHBlZXJzIHRvIHdoaWNoIHdlIGNvdWxkIG5vdCBjb25uZWN0IGZvciBub24tZmF0YWwgcmVhc29ucywgZS5nLgogICAgLy8vIFtgRGlzY29ubmVjdFJlYXNvbjo6VG9vTWFueVBlZXJzYF0sIGFyZSBwdXQgaW4gdGltZSBvdXQuCiAgICBiYWNrb2ZmX2R1cmF0aW9uczogUGVlckJhY2tvZmZEdXJhdGlvbnMsCiAgICAvLy8gSWYgbm9uLXRydXN0ZWQgcGVlcnMgc2hvdWxkIGJlIGNvbm5lY3RlZCB0bywgb3IgdGhlIGNvbm5lY3Rpb24gZnJvbSBub24tdHJ1c3RlZAogICAgLy8vIGluY29taW5nIHBlZXJzIHNob3VsZCBiZSBhY2NlcHRlZC4KICAgIHRydXN0ZWRfbm9kZXNfb25seTogYm9vbCwKICAgIC8vLyBUaW1lc3RhbXAgb2YgdGhlIGxhc3QgdGltZSBbYFNlbGY6OnRpY2tgXSB3YXMgY2FsbGVkLgogICAgbGFzdF90aWNrOiBJbnN0YW50LAogICAgLy8vIE1heGltdW0gbnVtYmVyIG9mIGJhY2tvZmYgYXR0ZW1wdHMgYmVmb3JlIHdlIGdpdmUgdXAgb24gYSBwZWVyIGFuZCBkcm9wcGluZy4KICAgIG1heF9iYWNrb2ZmX2NvdW50OiB1OCwKICAgIC8vLyBUcmFja3MgdGhlIGNvbm5lY3Rpb24gc3RhdGUgb2YgdGhlIG5vZGUKICAgIG5ldF9jb25uZWN0aW9uX3N0YXRlOiBOZXR3b3JrQ29ubmVjdGlvblN0YXRlLAogICAgLy8vIEhvdyBsb25nIHRvIHRlbXBvcmFyaWx5IGJhbiBpcCBvbiBhbiBpbmNvbWluZyBjb25uZWN0aW9uIGF0dGVtcHQuCiAgICBpbmNvbWluZ19pcF90aHJvdHRsZV9kdXJhdGlvbjogRHVyYXRpb24sCiAgICAvLy8gSVAgYWRkcmVzcyBmaWx0ZXIgZm9yIHJlc3RyaWN0aW5nIG5ldHdvcmsgY29ubmVjdGlvbnMgdG8gc3BlY2lmaWMgSVAgcmFuZ2VzLgogICAgaXBfZmlsdGVyOiByZXRoX25ldF9iYW5saXN0OjpJcEZpbHRlciwKfQoKaW1wbCBQZWVyc01hbmFnZXIgewogICAgLy8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSB3aXRoIHRoZSBnaXZlbiBjb25maWcKICAgIHB1YiBmbiBuZXcoY29uZmlnOiBQZWVyc0NvbmZpZykgLT4gU2VsZiB7CiAgICAgICAgbGV0IFBlZXJzQ29uZmlnIHsKICAgICAgICAgICAgcmVmaWxsX3Nsb3RzX2ludGVydmFsLAogICAgICAgICAgICBjb25uZWN0aW9uX2luZm8sCiAgICAgICAgICAgIHJlcHV0YXRpb25fd2VpZ2h0cywKICAgICAgICAgICAgYmFuX2xpc3QsCiAgICAgICAgICAgIGJhbl9kdXJhdGlvbiwKICAgICAgICAgICAgYmFja29mZl9kdXJhdGlvbnMsCiAgICAgICAgICAgIHRydXN0ZWRfbm9kZXMsCiAgICAgICAgICAgIHRydXN0ZWRfbm9kZXNfb25seSwKICAgICAgICAgICAgdHJ1c3RlZF9ub2Rlc19yZXNvbHV0aW9uX2ludGVydmFsLAogICAgICAgICAgICBiYXNpY19ub2RlcywKICAgICAgICAgICAgbWF4X2JhY2tvZmZfY291bnQsCiAgICAgICAgICAgIGluY29taW5nX2lwX3Rocm90dGxlX2R1cmF0aW9uLAogICAgICAgICAgICBpcF9maWx0ZXIsCiAgICAgICAgfSA9IGNvbmZpZzsKICAgICAgICBsZXQgKG1hbmFnZXJfdHgsIGhhbmRsZV9yeCkgPSBtcHNjOjp1bmJvdW5kZWRfY2hhbm5lbCgpOwogICAgICAgIGxldCBub3cgPSBJbnN0YW50Ojpub3coKTsKCiAgICAgICAgLy8gV2UgdXNlIGhhbGYgb2YgdGhlIGludGVydmFsIHRvIGRlY3JlYXNlIHRoZSBtYXggZHVyYXRpb24gdG8gYDE1MCVgIGluIHdvcnN0IGNhc2UKICAgICAgICBsZXQgdW5iYW5faW50ZXJ2YWwgPSBiYW5fZHVyYXRpb24ubWluKGJhY2tvZmZfZHVyYXRpb25zLmxvdykgLyAyOwoKICAgICAgICBsZXQgbXV0IHBlZXJzID0gSGFzaE1hcDo6d2l0aF9jYXBhY2l0eSh0cnVzdGVkX25vZGVzLmxlbigpICsgYmFzaWNfbm9kZXMubGVuKCkpOwogICAgICAgIGxldCBtdXQgdHJ1c3RlZF9wZWVyX2lkcyA9IEhhc2hTZXQ6OndpdGhfY2FwYWNpdHkodHJ1c3RlZF9ub2Rlcy5sZW4oKSk7CgogICAgICAgIGZvciB0cnVzdGVkX3BlZXIgaW4gJnRydXN0ZWRfbm9kZXMgewogICAgICAgICAgICBtYXRjaCB0cnVzdGVkX3BlZXIucmVzb2x2ZV9ibG9ja2luZygpIHsKICAgICAgICAgICAgICAgIE9rKE5vZGVSZWNvcmQgeyBhZGRyZXNzLCB0Y3BfcG9ydCwgdWRwX3BvcnQsIGlkIH0pID0+IHsKICAgICAgICAgICAgICAgICAgICB0cnVzdGVkX3BlZXJfaWRzLmluc2VydChpZCk7CiAgICAgICAgICAgICAgICAgICAgcGVlcnMuZW50cnkoaWQpLm9yX2luc2VydF93aXRoKHx8IHsKICAgICAgICAgICAgICAgICAgICAgICAgUGVlcjo6dHJ1c3RlZChQZWVyQWRkcjo6bmV3X3dpdGhfcG9ydHMoYWRkcmVzcywgdGNwX3BvcnQsIFNvbWUodWRwX3BvcnQpKSkKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEVycihlcnIpID0+IHsKICAgICAgICAgICAgICAgICAgICB3YXJuISh0YXJnZXQ6ICJuZXQ6OnBlZXJzIiwgP2VyciwgIkZhaWxlZCB0byByZXNvbHZlIHRydXN0ZWQgcGVlciIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgTm9kZVJlY29yZCB7IGFkZHJlc3MsIHRjcF9wb3J0LCB1ZHBfcG9ydCwgaWQgfSBpbiBiYXNpY19ub2RlcyB7CiAgICAgICAgICAgIHBlZXJzLmVudHJ5KGlkKS5vcl9pbnNlcnRfd2l0aCh8fCB7CiAgICAgICAgICAgICAgICBQZWVyOjpuZXcoUGVlckFkZHI6Om5ld193aXRoX3BvcnRzKGFkZHJlc3MsIHRjcF9wb3J0LCBTb21lKHVkcF9wb3J0KSkpCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdHJhY2UhKHRhcmdldDogIm5ldDo6cGVlcnMiLCB0cnVzdGVkX3BlZXJzPT90cnVzdGVkX3BlZXJfaWRzLCAiSW5pdGlhbGl6ZWQgcGVlcnMgbWFuYWdlciIpOwoKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgcGVlcnMsCiAgICAgICAgICAgIHRydXN0ZWRfcGVlcl9pZHMsCiAgICAgICAgICAgIHRydXN0ZWRfcGVlcnNfcmVzb2x2ZXI6IFRydXN0ZWRQZWVyc1Jlc29sdmVyOjpuZXcoCiAgICAgICAgICAgICAgICB0cnVzdGVkX25vZGVzLAogICAgICAgICAgICAgICAgdG9raW86OnRpbWU6OmludGVydmFsKHRydXN0ZWRfbm9kZXNfcmVzb2x1dGlvbl9pbnRlcnZhbCksIC8vIDEgaG91cgogICAgICAgICAgICApLAogICAgICAgICAgICBtYW5hZ2VyX3R4LAogICAgICAgICAgICBoYW5kbGVfcng6IFVuYm91bmRlZFJlY2VpdmVyU3RyZWFtOjpuZXcoaGFuZGxlX3J4KSwKICAgICAgICAgICAgcXVldWVkX2FjdGlvbnM6IERlZmF1bHQ6OmRlZmF1bHQoKSwKICAgICAgICAgICAgcmVwdXRhdGlvbl93ZWlnaHRzLAogICAgICAgICAgICByZWZpbGxfc2xvdHNfaW50ZXJ2YWw6IHRva2lvOjp0aW1lOjppbnRlcnZhbChyZWZpbGxfc2xvdHNfaW50ZXJ2YWwpLAogICAgICAgICAgICByZWxlYXNlX2ludGVydmFsOiB0b2tpbzo6dGltZTo6aW50ZXJ2YWxfYXQobm93ICsgdW5iYW5faW50ZXJ2YWwsIHVuYmFuX2ludGVydmFsKSwKICAgICAgICAgICAgY29ubmVjdGlvbl9pbmZvOiBDb25uZWN0aW9uSW5mbzo6bmV3KGNvbm5lY3Rpb25faW5mbyksCiAgICAgICAgICAgIGJhbl9saXN0LAogICAgICAgICAgICBiYWNrZWRfb2ZmX3BlZXJzOiBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIGJhbl9kdXJhdGlvbiwKICAgICAgICAgICAgYmFja29mZl9kdXJhdGlvbnMsCiAgICAgICAgICAgIHRydXN0ZWRfbm9kZXNfb25seSwKICAgICAgICAgICAgbGFzdF90aWNrOiBJbnN0YW50Ojpub3coKSwKICAgICAgICAgICAgbWF4X2JhY2tvZmZfY291bnQsCiAgICAgICAgICAgIG5ldF9jb25uZWN0aW9uX3N0YXRlOiBOZXR3b3JrQ29ubmVjdGlvblN0YXRlOjpkZWZhdWx0KCksCiAgICAgICAgICAgIGluY29taW5nX2lwX3Rocm90dGxlX2R1cmF0aW9uLAogICAgICAgICAgICBpcF9maWx0ZXIsCiAgICAgICAgfQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgbmV3IFtgUGVlcnNIYW5kbGVgXSB0aGF0IGNhbiBzZW5kIGNvbW1hbmRzIHRvIHRoaXMgdHlwZS4KICAgIHB1YihjcmF0ZSkgZm4gaGFuZGxlKCZzZWxmKSAtPiBQZWVyc0hhbmRsZSB7CiAgICAgICAgUGVlcnNIYW5kbGU6Om5ldyhzZWxmLm1hbmFnZXJfdHguY2xvbmUoKSkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgbnVtYmVyIG9mIHBlZXJzIGluIHRoZSBwZWVyIHNldAogICAgI1tpbmxpbmVdCiAgICBwdWIoY3JhdGUpIGZuIG51bV9rbm93bl9wZWVycygmc2VsZikgLT4gdXNpemUgewogICAgICAgIHNlbGYucGVlcnMubGVuKCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyBhbiBpdGVyYXRvciBvdmVyIGFsbCBwZWVycwogICAgcHViKGNyYXRlKSBmbiBpdGVyX3BlZXJzKCZzZWxmKSAtPiBpbXBsIEl0ZXJhdG9yPEl0ZW0gPSBOb2RlUmVjb3JkPiArICdfIHsKICAgICAgICBzZWxmLnBlZXJzLml0ZXIoKS5tYXAofChwZWVyX2lkLCB2KXwgewogICAgICAgICAgICBOb2RlUmVjb3JkOjpuZXdfd2l0aF9wb3J0cygKICAgICAgICAgICAgICAgIHYuYWRkci50Y3AoKS5pcCgpLAogICAgICAgICAgICAgICAgdi5hZGRyLnRjcCgpLnBvcnQoKSwKICAgICAgICAgICAgICAgIHYuYWRkci51ZHAoKS5tYXAofGFkZHJ8IGFkZHIucG9ydCgpKSwKICAgICAgICAgICAgICAgICpwZWVyX2lkLAogICAgICAgICAgICApCiAgICAgICAgfSkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgYE5vZGVSZWNvcmRgIGFuZCBgUGVlcktpbmRgIGZvciB0aGUgZ2l2ZW4gcGVlciBpZAogICAgcHViKGNyYXRlKSBmbiBwZWVyX2J5X2lkKCZzZWxmLCBwZWVyX2lkOiBQZWVySWQpIC0+IE9wdGlvbjwoTm9kZVJlY29yZCwgUGVlcktpbmQpPiB7CiAgICAgICAgc2VsZi5wZWVycy5nZXQoJnBlZXJfaWQpLm1hcCh8dnwgewogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICBOb2RlUmVjb3JkOjpuZXdfd2l0aF9wb3J0cygKICAgICAgICAgICAgICAgICAgICB2LmFkZHIudGNwKCkuaXAoKSwKICAgICAgICAgICAgICAgICAgICB2LmFkZHIudGNwKCkucG9ydCgpLAogICAgICAgICAgICAgICAgICAgIHYuYWRkci51ZHAoKS5tYXAofGFkZHJ8IGFkZHIucG9ydCgpKSwKICAgICAgICAgICAgICAgICAgICBwZWVyX2lkLAogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHYua2luZCwKICAgICAgICAgICAgKQogICAgICAgIH0pCiAgICB9CgogICAgLy8vIFJldHVybnMgYW4gaXRlcmF0b3Igb3ZlciBhbGwgcGVlciBpZHMgZm9yIHBlZXJzIHdpdGggdGhlIGdpdmVuIGtpbmQKICAgIHB1YihjcmF0ZSkgZm4gcGVlcnNfYnlfa2luZCgmc2VsZiwga2luZDogUGVlcktpbmQpIC0+IGltcGwgSXRlcmF0b3I8SXRlbSA9IFBlZXJJZD4gKyAnXyB7CiAgICAgICAgc2VsZi5wZWVycy5pdGVyKCkuZmlsdGVyX21hcChtb3ZlIHwocGVlcl9pZCwgcGVlcil8IChwZWVyLmtpbmQgPT0ga2luZCkudGhlbl9zb21lKCpwZWVyX2lkKSkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgbnVtYmVyIG9mIGN1cnJlbnRseSBhY3RpdmUgaW5ib3VuZCBjb25uZWN0aW9ucy4KICAgICNbaW5saW5lXQogICAgcHViKGNyYXRlKSBjb25zdCBmbiBudW1faW5ib3VuZF9jb25uZWN0aW9ucygmc2VsZikgLT4gdXNpemUgewogICAgICAgIHNlbGYuY29ubmVjdGlvbl9pbmZvLm51bV9pbmJvdW5kCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIG51bWJlciBvZiBjdXJyZW50bHkgX19hY3RpdmVfXyBvdXRib3VuZCBjb25uZWN0aW9ucy4KICAgICNbaW5saW5lXQogICAgcHViKGNyYXRlKSBjb25zdCBmbiBudW1fb3V0Ym91bmRfY29ubmVjdGlvbnMoJnNlbGYpIC0+IHVzaXplIHsKICAgICAgICBzZWxmLmNvbm5lY3Rpb25faW5mby5udW1fb3V0Ym91bmQKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgbnVtYmVyIG9mIGN1cnJlbnRseSBwZW5kaW5nIG91dGJvdW5kIGNvbm5lY3Rpb25zLgogICAgI1tpbmxpbmVdCiAgICBwdWIoY3JhdGUpIGNvbnN0IGZuIG51bV9wZW5kaW5nX291dGJvdW5kX2Nvbm5lY3Rpb25zKCZzZWxmKSAtPiB1c2l6ZSB7CiAgICAgICAgc2VsZi5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfb3V0CiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIG51bWJlciBvZiBjdXJyZW50bHkgYmFja2VkIG9mZiBwZWVycy4KICAgICNbaW5saW5lXQogICAgcHViKGNyYXRlKSBmbiBudW1fYmFja2VkX29mZl9wZWVycygmc2VsZikgLT4gdXNpemUgewogICAgICAgIHNlbGYuYmFja2VkX29mZl9wZWVycy5sZW4oKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBudW1iZXIgb2YgaWRsZSB0cnVzdGVkIHBlZXJzLgogICAgZm4gbnVtX2lkbGVfdHJ1c3RlZF9wZWVycygmc2VsZikgLT4gdXNpemUgewogICAgICAgIHNlbGYucGVlcnMuaXRlcigpLmZpbHRlcih8KF8sIHBlZXIpfCBwZWVyLmtpbmQuaXNfdHJ1c3RlZCgpICYmIHBlZXIuc3RhdGUuaXNfaWRsZSgpKS5jb3VudCgpCiAgICB9CgogICAgLy8vIEludm9rZWQgd2hlbiBhIG5ldyBfaW5jb21pbmdfIHRjcCBjb25uZWN0aW9uIGlzIGFjY2VwdGVkLgogICAgLy8vCiAgICAvLy8gcmV0dXJucyBhbiBlcnJvciBpZiB0aGUgaW5ib3VuZCBpcCBhZGRyZXNzIGlzIG9uIHRoZSBiYW4gbGlzdAogICAgcHViKGNyYXRlKSBmbiBvbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIGFkZHI6IElwQWRkciwKICAgICkgLT4gUmVzdWx0PCgpLCBJbmJvdW5kQ29ubmVjdGlvbkVycm9yPiB7CiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIElQIGlzIGluIHRoZSBhbGxvd2VkIHJhbmdlcyAobmV0cmVzdHJpY3QpCiAgICAgICAgaWYgIXNlbGYuaXBfZmlsdGVyLmlzX2FsbG93ZWQoJmFkZHIpIHsKICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogIm5ldCIsID9hZGRyLCAiUmVqZWN0aW5nIGNvbm5lY3Rpb24gZnJvbSBJUCBub3QgaW4gYWxsb3dlZCByYW5nZXMiKTsKICAgICAgICAgICAgcmV0dXJuIEVycihJbmJvdW5kQ29ubmVjdGlvbkVycm9yOjpJcEJhbm5lZCkKICAgICAgICB9CgogICAgICAgIGlmIHNlbGYuYmFuX2xpc3QuaXNfYmFubmVkX2lwKCZhZGRyKSB7CiAgICAgICAgICAgIHJldHVybiBFcnIoSW5ib3VuZENvbm5lY3Rpb25FcnJvcjo6SXBCYW5uZWQpCiAgICAgICAgfQoKICAgICAgICAvLyBjaGVjayBpZiB3ZSBldmVuIGhhdmUgc2xvdHMgZm9yIGEgbmV3IGluY29taW5nIGNvbm5lY3Rpb24KICAgICAgICBpZiAhc2VsZi5jb25uZWN0aW9uX2luZm8uaGFzX2luX2NhcGFjaXR5KCkgewogICAgICAgICAgICBpZiBzZWxmLnRydXN0ZWRfcGVlcl9pZHMuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBkb24ndCBoYXZlIGFueSBpbmNvbWluZyBzbG90cyBhbmQgbm8gdHJ1c3RlZCBwZWVycywgd2UgZG9uJ3QgYWNjZXB0IGFueSBuZXcKICAgICAgICAgICAgICAgIC8vIGNvbm5lY3Rpb25zCiAgICAgICAgICAgICAgICByZXR1cm4gRXJyKEluYm91bmRDb25uZWN0aW9uRXJyb3I6OkV4Y2VlZHNDYXBhY2l0eSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gdGhlcmUncyBhbiBlZGdlIGNhc2UgaGVyZSB3aGVyZSBubyBpbmNvbWluZyBjb25uZWN0aW9ucyBiZXNpZGVzIGZyb20gdHJ1c3RlZCBwZWVycwogICAgICAgICAgICAvLyBhcmUgYWxsb3dlZCAobWF4X2luYm91bmQgPT0gMCksIGluIHdoaWNoIGNhc2Ugd2Ugc3RpbGwgbmVlZCB0byBhbGxvdyBuZXcgcGVuZGluZwogICAgICAgICAgICAvLyBpbmNvbWluZyBjb25uZWN0aW9ucyB1bnRpbCBhbGwgdHJ1c3RlZCBwZWVycyBhcmUgY29ubmVjdGVkLgogICAgICAgICAgICBsZXQgbnVtX2lkbGVfdHJ1c3RlZF9wZWVycyA9IHNlbGYubnVtX2lkbGVfdHJ1c3RlZF9wZWVycygpOwogICAgICAgICAgICBpZiBudW1faWRsZV90cnVzdGVkX3BlZXJzIDw9IHNlbGYudHJ1c3RlZF9wZWVyX2lkcy5sZW4oKSB7CiAgICAgICAgICAgICAgICAvLyB3ZSBzdGlsbCB3YW50IHRvIGxpbWl0IGNvbmN1cnJlbnQgcGVuZGluZyBjb25uZWN0aW9ucwogICAgICAgICAgICAgICAgbGV0IG1heF9pbmJvdW5kID0KICAgICAgICAgICAgICAgICAgICBzZWxmLnRydXN0ZWRfcGVlcl9pZHMubGVuKCkubWF4KHNlbGYuY29ubmVjdGlvbl9pbmZvLmNvbmZpZy5tYXhfaW5ib3VuZCk7CiAgICAgICAgICAgICAgICBpZiBzZWxmLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiA8IG1heF9pbmJvdW5kIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmNvbm5lY3Rpb25faW5mby5pbmNfcGVuZGluZ19pbigpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBPaygoKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gYWxsIHRydXN0ZWQgcGVlcnMgYXJlIGVpdGhlciBjb25uZWN0ZWQgb3IgY29ubmVjdGluZwogICAgICAgICAgICByZXR1cm4gRXJyKEluYm91bmRDb25uZWN0aW9uRXJyb3I6OkV4Y2VlZHNDYXBhY2l0eSkKICAgICAgICB9CgogICAgICAgIC8vIGFsc28gY2FwIHRoZSBpbmNvbWluZyBjb25uZWN0aW9ucyB3ZSBjYW4gcHJvY2VzcyBhdCBvbmNlCiAgICAgICAgaWYgIXNlbGYuY29ubmVjdGlvbl9pbmZvLmhhc19pbl9wZW5kaW5nX2NhcGFjaXR5KCkgewogICAgICAgICAgICByZXR1cm4gRXJyKEluYm91bmRDb25uZWN0aW9uRXJyb3I6OkV4Y2VlZHNDYXBhY2l0eSkKICAgICAgICB9CgogICAgICAgIC8vIGFwcGx5IHRoZSByYXRlIGxpbWl0CiAgICAgICAgc2VsZi50aHJvdHRsZV9pbmNvbWluZ19pcChhZGRyKTsKCiAgICAgICAgc2VsZi5jb25uZWN0aW9uX2luZm8uaW5jX3BlbmRpbmdfaW4oKTsKICAgICAgICBPaygoKSkKICAgIH0KCiAgICAvLy8gSW52b2tlZCB3aGVuIGEgcHJldmlvdXMgY2FsbCB0byBbYFNlbGY6Om9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbmBdIHN1Y2NlZWRlZCBidXQgaXQgd2FzCiAgICAvLy8gcmVqZWN0ZWQuCiAgICBwdWIoY3JhdGUpIGNvbnN0IGZuIG9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbl9yZWplY3RlZF9pbnRlcm5hbGx5KCZtdXQgc2VsZikgewogICAgICAgIHNlbGYuY29ubmVjdGlvbl9pbmZvLmRlY3JfcGVuZGluZ19pbigpOwogICAgfQoKICAgIC8vLyBJbnZva2VkIHdoZW4gYSBwZW5kaW5nIHNlc3Npb24gd2FzIGNsb3NlZC4KICAgIHB1YihjcmF0ZSkgY29uc3QgZm4gb25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uX2dyYWNlZnVsbHlfY2xvc2VkKCZtdXQgc2VsZikgewogICAgICAgIHNlbGYuY29ubmVjdGlvbl9pbmZvLmRlY3JfcGVuZGluZ19pbigpCiAgICB9CgogICAgLy8vIEludm9rZWQgd2hlbiBhIHBlbmRpbmcgc2Vzc2lvbiB3YXMgY2xvc2VkLgogICAgcHViKGNyYXRlKSBmbiBvbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb25fZHJvcHBlZCgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgcmVtb3RlX2FkZHI6IFNvY2tldEFkZHIsCiAgICAgICAgZXJyOiAmUGVuZGluZ1Nlc3Npb25IYW5kc2hha2VFcnJvciwKICAgICkgewogICAgICAgIGlmIGVyci5pc19mYXRhbF9wcm90b2NvbF9lcnJvcigpIHsKICAgICAgICAgICAgc2VsZi5iYW5faXAocmVtb3RlX2FkZHIuaXAoKSk7CgogICAgICAgICAgICBpZiBlcnIubWVyaXRzX2Rpc2NvdmVyeV9iYW4oKSB7CiAgICAgICAgICAgICAgICBzZWxmLnF1ZXVlZF9hY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgLnB1c2hfYmFjayhQZWVyQWN0aW9uOjpEaXNjb3ZlcnlCYW5JcCB7IGlwX2FkZHI6IHJlbW90ZV9hZGRyLmlwKCkgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2VsZi5jb25uZWN0aW9uX2luZm8uZGVjcl9wZW5kaW5nX2luKCk7CiAgICB9CgogICAgLy8vIENhbGxlZCB3aGVuIGEgbmV3IF9pbmNvbWluZ18gYWN0aXZlIHNlc3Npb24gd2FzIGVzdGFibGlzaGVkIHRvIHRoZSBnaXZlbiBwZWVyLgogICAgLy8vCiAgICAvLy8gVGhpcyB3aWxsIHVwZGF0ZSB0aGUgc3RhdGUgb2YgdGhlIHBlZXIgaWYgbm90IHlldCB0cmFja2VkLgogICAgLy8vCiAgICAvLy8gSWYgdGhlIHJlcHV0YXRpb24gb2YgdGhlIHBlZXIgaXMgYmVsb3cgdGhlIGBCQU5ORURfUkVQVVRBVElPTmAgdGhyZXNob2xkLCBhIGRpc2Nvbm5lY3Qgd2lsbAogICAgLy8vIGJlIHNjaGVkdWxlZC4KICAgIHB1YihjcmF0ZSkgZm4gb25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZCgmbXV0IHNlbGYsIHBlZXJfaWQ6IFBlZXJJZCwgYWRkcjogU29ja2V0QWRkcikgewogICAgICAgIHNlbGYuY29ubmVjdGlvbl9pbmZvLmRlY3JfcGVuZGluZ19pbigpOwoKICAgICAgICAvLyB3ZSBvbmx5IG5lZWQgdG8gY2hlY2sgdGhlIHBlZXIgaWQgaGVyZSBhcyB0aGUgaXAgYWRkcmVzcyB3aWxsIGhhdmUgYmVlbiBjaGVja2VkIGF0CiAgICAgICAgLy8gb25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uLiBXZSBhbHNvIGNoZWNrIGlmIHRoZSBwZWVyIGlzIGluIHRoZSBiYWNrb2ZmIGxpc3QgaGVyZS4KICAgICAgICBpZiBzZWxmLmJhbl9saXN0LmlzX2Jhbm5lZF9wZWVyKCZwZWVyX2lkKSB7CiAgICAgICAgICAgIHNlbGYucXVldWVkX2FjdGlvbnMucHVzaF9iYWNrKFBlZXJBY3Rpb246OkRpc2Nvbm5lY3RCYW5uZWRJbmNvbWluZyB7IHBlZXJfaWQgfSk7CiAgICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgLy8gY2hlY2sgaWYgdGhlIHBlZXIgaXMgdHJ1c3RhYmxlIG9yIG5vdAogICAgICAgIGxldCBtdXQgaXNfdHJ1c3RlZCA9IHNlbGYudHJ1c3RlZF9wZWVyX2lkcy5jb250YWlucygmcGVlcl9pZCk7CiAgICAgICAgaWYgc2VsZi50cnVzdGVkX25vZGVzX29ubHkgJiYgIWlzX3RydXN0ZWQgewogICAgICAgICAgICBzZWxmLnF1ZXVlZF9hY3Rpb25zLnB1c2hfYmFjayhQZWVyQWN0aW9uOjpEaXNjb25uZWN0VW50cnVzdGVkSW5jb21pbmcgeyBwZWVyX2lkIH0pOwogICAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIC8vIHN0YXJ0IGEgbmV3IHRpY2ssIHNvIHRoZSBwZWVyIGlzIG5vdCBpbW1lZGlhdGVseSByZXdhcmRlZCBmb3IgdGhlIHRpbWUgc2luY2UgbGFzdCB0aWNrCiAgICAgICAgc2VsZi50aWNrKCk7CgogICAgICAgIG1hdGNoIHNlbGYucGVlcnMuZW50cnkocGVlcl9pZCkgewogICAgICAgICAgICBFbnRyeTo6T2NjdXBpZWQobXV0IGVudHJ5KSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcGVlciA9IGVudHJ5LmdldF9tdXQoKTsKICAgICAgICAgICAgICAgIGlmIHBlZXIuaXNfYmFubmVkKCkgewogICAgICAgICAgICAgICAgICAgIHNlbGYucXVldWVkX2FjdGlvbnMucHVzaF9iYWNrKFBlZXJBY3Rpb246OkRpc2Nvbm5lY3RCYW5uZWRJbmNvbWluZyB7IHBlZXJfaWQgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBpdCBtaWdodCBiZSB0aGUgY2FzZSB0aGF0IHdlJ3JlIGFsc28gdHJ5aW5nIHRvIGNvbm5lY3QgdG8gdGhpcyBwZWVyIGF0IHRoZSBzYW1lCiAgICAgICAgICAgICAgICAvLyB0aW1lLCBzbyB3ZSBuZWVkIHRvIGFkanVzdCB0aGUgc3RhdGUgaGVyZQogICAgICAgICAgICAgICAgaWYgcGVlci5zdGF0ZS5pc19wZW5kaW5nX291dCgpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmNvbm5lY3Rpb25faW5mby5kZWNyX3N0YXRlKHBlZXIuc3RhdGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHBlZXIuc3RhdGUgPSBQZWVyQ29ubmVjdGlvblN0YXRlOjpJbjsKCiAgICAgICAgICAgICAgICBpc190cnVzdGVkID0gaXNfdHJ1c3RlZCB8fCBwZWVyLmlzX3RydXN0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFbnRyeTo6VmFjYW50KGVudHJ5KSA9PiB7CiAgICAgICAgICAgICAgICAvLyBwZWVyIGlzIG1pc3NpbmcgaW4gdGhlIHRhYmxlLCB3ZSBhZGQgaXQgYnV0IG1hcmsgaXQgYXMgdG8gYmUgcmVtb3ZlZCBhZnRlcgogICAgICAgICAgICAgICAgLy8gZGlzY29ubmVjdCwgYmVjYXVzZSB3ZSBvbmx5IGtub3cgdGhlIG91dGdvaW5nIHBvcnQKICAgICAgICAgICAgICAgIGxldCBtdXQgcGVlciA9IFBlZXI6OndpdGhfc3RhdGUoUGVlckFkZHI6OmZyb21fdGNwKGFkZHIpLCBQZWVyQ29ubmVjdGlvblN0YXRlOjpJbik7CiAgICAgICAgICAgICAgICBwZWVyLnJlbW92ZV9hZnRlcl9kaXNjb25uZWN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVudHJ5Lmluc2VydChwZWVyKTsKICAgICAgICAgICAgICAgIHNlbGYucXVldWVkX2FjdGlvbnMucHVzaF9iYWNrKFBlZXJBY3Rpb246OlBlZXJBZGRlZChwZWVyX2lkKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxldCBoYXNfaW5fY2FwYWNpdHkgPSBzZWxmLmNvbm5lY3Rpb25faW5mby5oYXNfaW5fY2FwYWNpdHkoKTsKICAgICAgICAvLyBpbmNyZW1lbnQgbmV3IGluY29taW5nIGNvbm5lY3Rpb24KICAgICAgICBzZWxmLmNvbm5lY3Rpb25faW5mby5pbmNfaW4oKTsKCiAgICAgICAgLy8gZGlzY29ubmVjdCB0aGUgcGVlciBpZiB3ZSBkb24ndCBoYXZlIGNhcGFjaXR5IGZvciBtb3JlIGluYm91bmQgY29ubmVjdGlvbnMKICAgICAgICBpZiAhaXNfdHJ1c3RlZCAmJiAhaGFzX2luX2NhcGFjaXR5IHsKICAgICAgICAgICAgc2VsZi5xdWV1ZWRfYWN0aW9ucy5wdXNoX2JhY2soUGVlckFjdGlvbjo6RGlzY29ubmVjdCB7CiAgICAgICAgICAgICAgICBwZWVyX2lkLAogICAgICAgICAgICAgICAgcmVhc29uOiBTb21lKERpc2Nvbm5lY3RSZWFzb246OlRvb01hbnlQZWVycyksCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQmFucyB0aGUgcGVlciB0ZW1wb3JhcmlseSB3aXRoIHRoZSBjb25maWd1cmVkIGJhbiB0aW1lb3V0CiAgICBmbiBiYW5fcGVlcigmbXV0IHNlbGYsIHBlZXJfaWQ6IFBlZXJJZCkgewogICAgICAgIGxldCBiYW5fZHVyYXRpb24gPSBpZiBsZXQgU29tZShwZWVyKSA9IHNlbGYucGVlcnMuZ2V0KCZwZWVyX2lkKSAmJgogICAgICAgICAgICAocGVlci5pc190cnVzdGVkKCkgfHwgcGVlci5pc19zdGF0aWMoKSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIEZvciBtaXNiZWhhdmluZyB0cnVzdGVkIG9yIHN0YXRpYyBwZWVycywgd2UgcHJvdmlkZSBhIGJpdCBtb3JlIGxlZXdheSB3aGVuCiAgICAgICAgICAgIC8vIHBlbmFsaXppbmcgdGhlbS4KICAgICAgICAgICAgc2VsZi5iYWNrb2ZmX2R1cmF0aW9ucy5sb3cgLyAyCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5iYW5fZHVyYXRpb24KICAgICAgICB9OwoKICAgICAgICBzZWxmLmJhbl9saXN0LmJhbl9wZWVyX3VudGlsKHBlZXJfaWQsIHN0ZDo6dGltZTo6SW5zdGFudDo6bm93KCkgKyBiYW5fZHVyYXRpb24pOwogICAgICAgIHNlbGYucXVldWVkX2FjdGlvbnMucHVzaF9iYWNrKFBlZXJBY3Rpb246OkJhblBlZXIgeyBwZWVyX2lkIH0pOwogICAgfQoKICAgIC8vLyBCYW5zIHRoZSBJUCB0ZW1wb3JhcmlseSB3aXRoIHRoZSBjb25maWd1cmVkIGJhbiB0aW1lb3V0CiAgICBmbiBiYW5faXAoJm11dCBzZWxmLCBpcDogSXBBZGRyKSB7CiAgICAgICAgc2VsZi5iYW5fbGlzdC5iYW5faXBfdW50aWwoaXAsIHN0ZDo6dGltZTo6SW5zdGFudDo6bm93KCkgKyBzZWxmLmJhbl9kdXJhdGlvbik7CiAgICB9CgogICAgLy8vIEJhbnMgdGhlIElQIHRlbXBvcmFyaWx5IHRvIHJhdGUgbGltaXQgaW5ib3VuZCBjb25uZWN0aW9uIGF0dGVtcHRzIHBlciBJUC4KICAgIGZuIHRocm90dGxlX2luY29taW5nX2lwKCZtdXQgc2VsZiwgaXA6IElwQWRkcikgewogICAgICAgIHNlbGYuYmFuX2xpc3QKICAgICAgICAgICAgLmJhbl9pcF91bnRpbChpcCwgc3RkOjp0aW1lOjpJbnN0YW50Ojpub3coKSArIHNlbGYuaW5jb21pbmdfaXBfdGhyb3R0bGVfZHVyYXRpb24pOwogICAgfQoKICAgIC8vLyBUZW1wb3JhcmlseSBwdXRzIHRoZSBwZWVyIGluIHRpbWVvdXQgYnkgaW5zZXJ0aW5nIGl0IGludG8gdGhlIGJhY2tlZG9mZiBwZWVycyBzZXQKICAgIGZuIGJhY2tvZmZfcGVlcl91bnRpbCgmbXV0IHNlbGYsIHBlZXJfaWQ6IFBlZXJJZCwgdW50aWw6IHN0ZDo6dGltZTo6SW5zdGFudCkgewogICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQ6OnBlZXJzIiwgP3BlZXJfaWQsICJiYWNraW5nIG9mZiIpOwoKICAgICAgICBpZiBsZXQgU29tZShwZWVyKSA9IHNlbGYucGVlcnMuZ2V0X211dCgmcGVlcl9pZCkgewogICAgICAgICAgICBwZWVyLmJhY2tlZF9vZmYgPSB0cnVlOwogICAgICAgICAgICBzZWxmLmJhY2tlZF9vZmZfcGVlcnMuaW5zZXJ0KHBlZXJfaWQsIHVudGlsKTsKICAgICAgICB9CiAgICB9CgogICAgLy8vIFVuYmFucyB0aGUgcGVlcgogICAgZm4gdW5iYW5fcGVlcigmbXV0IHNlbGYsIHBlZXJfaWQ6IFBlZXJJZCkgewogICAgICAgIHNlbGYuYmFuX2xpc3QudW5iYW5fcGVlcigmcGVlcl9pZCk7CiAgICAgICAgc2VsZi5xdWV1ZWRfYWN0aW9ucy5wdXNoX2JhY2soUGVlckFjdGlvbjo6VW5CYW5QZWVyIHsgcGVlcl9pZCB9KTsKICAgIH0KCiAgICAvLy8gVGljayBmdW5jdGlvbiB0byB1cGRhdGUgcmVwdXRhdGlvbiBvZiBhbGwgY29ubmVjdGVkIHBlZXJzLgogICAgLy8vIFBlZXJzIGFyZSByZXdhcmRlZCB3aXRoIHJlcHV0YXRpb24gaW5jcmVhc2VzIGZvciB0aGUgdGltZSB0aGV5IGFyZSBjb25uZWN0ZWQgc2luY2UgdGhlIGxhc3QKICAgIC8vLyB0aWNrLiBUaGlzIGlzIHRvIHByZXZlbnQgcGVlcnMgZnJvbSBiZWluZyBkaXNjb25uZWN0ZWQgZXZlbnR1YWxseSBkdWUgdG8gc2xhc2hlZAogICAgLy8vIHJlcHV0YXRpb24gYmVjYXVzZSBvZiBzb21lIGJhZCBtZXNzYWdlcyAobW9zdCBsaWtlbHkgdHJhbnNhY3Rpb24gcmVsYXRlZCkKICAgIGZuIHRpY2soJm11dCBzZWxmKSB7CiAgICAgICAgbGV0IG5vdyA9IEluc3RhbnQ6Om5vdygpOwogICAgICAgIC8vIERldGVybWluZSB0aGUgbnVtYmVyIG9mIHNlY29uZHMgc2luY2UgdGhlIGxhc3QgdGljay4KICAgICAgICAvLyBFbnN1cmluZyB0aGF0IG5vdyBpcyBhbHdheXMgZ3JlYXRlciB0aGFuIGxhc3RfdGljayB0byBhY2NvdW50IGZvciBpc3N1ZXMgd2l0aCBzeXN0ZW0KICAgICAgICAvLyB0aW1lLgogICAgICAgIGxldCBzZWNzX3NpbmNlX2xhc3RfdGljayA9CiAgICAgICAgICAgIGlmIHNlbGYubGFzdF90aWNrID4gbm93IHsgMCB9IGVsc2UgeyAobm93IC0gc2VsZi5sYXN0X3RpY2spLmFzX3NlY3MoKSBhcyBpMzIgfTsKICAgICAgICBzZWxmLmxhc3RfdGljayA9IG5vdzsKCiAgICAgICAgLy8gdXBkYXRlIHJlcHV0YXRpb24gdmlhIHNlY29uZHMgY29ubmVjdGVkCiAgICAgICAgZm9yIHBlZXIgaW4gc2VsZi5wZWVycy5pdGVyX211dCgpLmZpbHRlcih8KF8sIHBlZXIpfCBwZWVyLnN0YXRlLmlzX2Nvbm5lY3RlZCgpKSB7CiAgICAgICAgICAgIC8vIHVwZGF0ZSByZXB1dGF0aW9uIHZpYSBzZWNvbmRzIGNvbm5lY3RlZCwgYnV0IGtlZXAgdGhlIHRhcmdldCBfYXJvdW5kXyB0aGUgZGVmYXVsdAogICAgICAgICAgICAvLyByZXB1dGF0aW9uLgogICAgICAgICAgICBpZiBwZWVyLjEucmVwdXRhdGlvbiA8IERFRkFVTFRfUkVQVVRBVElPTiB7CiAgICAgICAgICAgICAgICBwZWVyLjEucmVwdXRhdGlvbiArPSBzZWNzX3NpbmNlX2xhc3RfdGljazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgdHJhY2tlZCByZXB1dGF0aW9uIGZvciBhIHBlZXIuCiAgICBwdWIoY3JhdGUpIGZuIGdldF9yZXB1dGF0aW9uKCZzZWxmLCBwZWVyX2lkOiAmUGVlcklkKSAtPiBPcHRpb248aTMyPiB7CiAgICAgICAgc2VsZi5wZWVycy5nZXQocGVlcl9pZCkubWFwKHxwZWVyfCBwZWVyLnJlcHV0YXRpb24pCiAgICB9CgogICAgLy8vIEFwcGx5IHRoZSBjb3JyZXNwb25kaW5nIHJlcHV0YXRpb24gY2hhbmdlIHRvIHRoZSBnaXZlbiBwZWVyLgogICAgLy8vCiAgICAvLy8gSWYgdGhlIHBlZXIgaXMgYSB0cnVzdGVkIHBlZXIsIGl0IHdpbGwgYmUgZXhlbXB0IGZyb20gcmVwdXRhdGlvbiBzbGFzaGluZyBmb3IgY2VydGFpbgogICAgLy8vIHJlcHV0YXRpb24gY2hhbmdlcyB0aGF0IGNhbiBiZSBhdHRyaWJ1dGVkIHRvIG5ldHdvcmsgY29uZGl0aW9ucy4gSWYgdGhlIHBlZXIgaXMgYQogICAgLy8vIHRydXN0ZWQgcGVlciwgaXQgd2lsbCBhbHNvIGJlIGxlc3Mgc3RyaWN0IHdpdGggdGhlIHJlcHV0YXRpb24gc2xhc2hpbmcuCiAgICBwdWIoY3JhdGUpIGZuIGFwcGx5X3JlcHV0YXRpb25fY2hhbmdlKCZtdXQgc2VsZiwgcGVlcl9pZDogJlBlZXJJZCwgcmVwOiBSZXB1dGF0aW9uQ2hhbmdlS2luZCkgewogICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQ6OnBlZXJzIiwgP3BlZXJfaWQsIHJlcHV0YXRpb249P3JlcCwgImFwcGx5aW5nIHJlcHV0YXRpb24gY2hhbmdlIik7CgogICAgICAgIGxldCBvdXRjb21lID0gaWYgbGV0IFNvbWUocGVlcikgPSBzZWxmLnBlZXJzLmdldF9tdXQocGVlcl9pZCkgewogICAgICAgICAgICAvLyBGaXJzdCBjaGVjayBpZiB3ZSBzaG91bGQgcmVzZXQgdGhlIHJlcHV0YXRpb24KICAgICAgICAgICAgaWYgcmVwLmlzX3Jlc2V0KCkgewogICAgICAgICAgICAgICAgcGVlci5yZXNldF9yZXB1dGF0aW9uKCkKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxldCBtdXQgcmVwdXRhdGlvbl9jaGFuZ2UgPSBzZWxmLnJlcHV0YXRpb25fd2VpZ2h0cy5jaGFuZ2UocmVwKS5hc19pMzIoKTsKICAgICAgICAgICAgICAgIGlmIHBlZXIuaXNfdHJ1c3RlZCgpIHx8IHBlZXIuaXNfc3RhdGljKCkgewogICAgICAgICAgICAgICAgICAgIC8vIGV4ZW1wdCB0cnVzdGVkIGFuZCBzdGF0aWMgcGVlcnMgZnJvbSByZXB1dGF0aW9uIHNsYXNoaW5nIGZvcgogICAgICAgICAgICAgICAgICAgIGlmIG1hdGNoZXMhKAogICAgICAgICAgICAgICAgICAgICAgICByZXAsCiAgICAgICAgICAgICAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpEcm9wcGVkIHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpCYWRBbm5vdW5jZW1lbnQgfAogICAgICAgICAgICAgICAgICAgICAgICAgICAgUmVwdXRhdGlvbkNoYW5nZUtpbmQ6OlRpbWVvdXQgfAogICAgICAgICAgICAgICAgICAgICAgICAgICAgUmVwdXRhdGlvbkNoYW5nZUtpbmQ6OkFscmVhZHlTZWVuVHJhbnNhY3Rpb24KICAgICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBhbHNvIGJlIGxlc3Mgc3RyaWN0IHdpdGggdGhlIHJlcHV0YXRpb24gc2xhc2hpbmcgZm9yIHRydXN0ZWQgcGVlcnMKICAgICAgICAgICAgICAgICAgICBpZiByZXB1dGF0aW9uX2NoYW5nZSA8IE1BWF9UUlVTVEVEX1BFRVJfUkVQVVRBVElPTl9DSEFOR0UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGNhcHMgdGhlIHJlcHV0YXRpb24gY2hhbmdlIHRvIHRoZSBtYXhpbXVtIGFsbG93ZWQgZm9yIHRydXN0ZWQgcGVlcnMKICAgICAgICAgICAgICAgICAgICAgICAgcmVwdXRhdGlvbl9jaGFuZ2UgPSBNQVhfVFJVU1RFRF9QRUVSX1JFUFVUQVRJT05fQ0hBTkdFOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBlZXIuYXBwbHlfcmVwdXRhdGlvbihyZXB1dGF0aW9uX2NoYW5nZSwgcmVwKQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgfTsKCiAgICAgICAgbWF0Y2ggb3V0Y29tZSB7CiAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VPdXRjb21lOjpOb25lID0+IHt9CiAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VPdXRjb21lOjpCYW4gPT4gewogICAgICAgICAgICAgICAgc2VsZi5iYW5fcGVlcigqcGVlcl9pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgUmVwdXRhdGlvbkNoYW5nZU91dGNvbWU6OlVuYmFuID0+IHNlbGYudW5iYW5fcGVlcigqcGVlcl9pZCksCiAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VPdXRjb21lOjpEaXNjb25uZWN0QW5kQmFuID0+IHsKICAgICAgICAgICAgICAgIHNlbGYucXVldWVkX2FjdGlvbnMucHVzaF9iYWNrKFBlZXJBY3Rpb246OkRpc2Nvbm5lY3QgewogICAgICAgICAgICAgICAgICAgIHBlZXJfaWQ6ICpwZWVyX2lkLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbjogU29tZShEaXNjb25uZWN0UmVhc29uOjpEaXNjb25uZWN0UmVxdWVzdGVkKSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2VsZi5iYW5fcGVlcigqcGVlcl9pZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8vIEdyYWNlZnVsbHkgZGlzY29ubmVjdGVkIGEgcGVuZGluZyBfb3V0Z29pbmdfIHNlc3Npb24KICAgIHB1YihjcmF0ZSkgZm4gb25fb3V0Z29pbmdfcGVuZGluZ19zZXNzaW9uX2dyYWNlZnVsbHlfY2xvc2VkKCZtdXQgc2VsZiwgcGVlcl9pZDogJlBlZXJJZCkgewogICAgICAgIGlmIGxldCBTb21lKHBlZXIpID0gc2VsZi5wZWVycy5nZXRfbXV0KHBlZXJfaWQpIHsKICAgICAgICAgICAgc2VsZi5jb25uZWN0aW9uX2luZm8uZGVjcl9zdGF0ZShwZWVyLnN0YXRlKTsKICAgICAgICAgICAgcGVlci5zdGF0ZSA9IFBlZXJDb25uZWN0aW9uU3RhdGU6OklkbGU7CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBJbnZva2VkIHdoZW4gYW4gX291dGdvaW5nXyBwZW5kaW5nIHNlc3Npb24gd2FzIGNsb3NlZCBkdXJpbmcgYXV0aGVudGljYXRpb24gb3IgdGhlCiAgICAvLy8gaGFuZHNoYWtlLgogICAgcHViKGNyYXRlKSBmbiBvbl9vdXRnb2luZ19wZW5kaW5nX3Nlc3Npb25fZHJvcHBlZCgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgcmVtb3RlX2FkZHI6ICZTb2NrZXRBZGRyLAogICAgICAgIHBlZXJfaWQ6ICZQZWVySWQsCiAgICAgICAgZXJyOiAmUGVuZGluZ1Nlc3Npb25IYW5kc2hha2VFcnJvciwKICAgICkgewogICAgICAgIHNlbGYub25fY29ubmVjdGlvbl9mYWlsdXJlKHJlbW90ZV9hZGRyLCBwZWVyX2lkLCBlcnIsIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpGYWlsZWRUb0Nvbm5lY3QpCiAgICB9CgogICAgLy8vIEdyYWNlZnVsbHkgZGlzY29ubmVjdGVkIGFuIGFjdGl2ZSBzZXNzaW9uCiAgICBwdWIoY3JhdGUpIGZuIG9uX2FjdGl2ZV9zZXNzaW9uX2dyYWNlZnVsbHlfY2xvc2VkKCZtdXQgc2VsZiwgcGVlcl9pZDogUGVlcklkKSB7CiAgICAgICAgbWF0Y2ggc2VsZi5wZWVycy5lbnRyeShwZWVyX2lkKSB7CiAgICAgICAgICAgIEVudHJ5OjpPY2N1cGllZChtdXQgZW50cnkpID0+IHsKICAgICAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQ6OnBlZXJzIiwgP3BlZXJfaWQsIGRpcmVjdGlvbj0/ZW50cnkuZ2V0KCkuc3RhdGUsICJhY3RpdmUgc2Vzc2lvbiBncmFjZWZ1bGx5IGNsb3NlZCIpOwogICAgICAgICAgICAgICAgc2VsZi5jb25uZWN0aW9uX2luZm8uZGVjcl9zdGF0ZShlbnRyeS5nZXQoKS5zdGF0ZSk7CgogICAgICAgICAgICAgICAgaWYgZW50cnkuZ2V0KCkucmVtb3ZlX2FmdGVyX2Rpc2Nvbm5lY3QgJiYgIWVudHJ5LmdldCgpLmlzX3RydXN0ZWQoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBwZWVyIHNob3VsZCBiZSByZW1vdmVkIGZyb20gdGhlIHNldAogICAgICAgICAgICAgICAgICAgIGVudHJ5LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIHNlbGYucXVldWVkX2FjdGlvbnMucHVzaF9iYWNrKFBlZXJBY3Rpb246OlBlZXJSZW1vdmVkKHBlZXJfaWQpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHBlZXIgPSBlbnRyeS5nZXRfbXV0KCk7CiAgICAgICAgICAgICAgICAgICAgLy8gcmVzZXQgdGhlIHBlZXIncyBzdGF0ZQogICAgICAgICAgICAgICAgICAgIC8vIHdlIHJlc2V0IHRoZSBiYWNrb2ZmIGNvdW50ZXIgc2luY2Ugd2UncmUgYWJsZSB0byBlc3RhYmxpc2ggYSBzdWNjZXNzZnVsCiAgICAgICAgICAgICAgICAgICAgLy8gc2Vzc2lvbiB0byB0aGF0IHBlZXIKICAgICAgICAgICAgICAgICAgICBwZWVyLnNldmVyZV9iYWNrb2ZmX2NvdW50ZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIHBlZXIuc3RhdGUgPSBQZWVyQ29ubmVjdGlvblN0YXRlOjpJZGxlOwoKICAgICAgICAgICAgICAgICAgICAvLyBidXQgd2UncmUgYmFja2luZyBvZmYgc2xpZ2h0bHkgdG8gYXZvaWQgZGlhbGluZyB0aGUgcGVlciBhZ2FpbiByaWdodCBhd2F5LCB0bwogICAgICAgICAgICAgICAgICAgIC8vIGdpdmUgdGhlIHJlbW90ZSB0aW1lIHRvIGFsc28gcHJvcGVybHkgcmVnaXN0ZXIgdGhlIGNsb3NlZCBzZXNzaW9uIGFuZCBjbGVhbgogICAgICAgICAgICAgICAgICAgIC8vIHVwIGFuZCB0byBhdm9pZCBhbnkgaXNzdWVzIHdpdGggaXAgdGhyb3R0bGluZyBvbiB0aGUgcmVtb3RlIGluIGNhc2UgdGhpcwogICAgICAgICAgICAgICAgICAgIC8vIHNlc3Npb24gd2FzIHRlcm1pbmF0ZWQgcmlnaHQgYXdheS4KICAgICAgICAgICAgICAgICAgICBwZWVyLmJhY2tlZF9vZmYgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHNlbGYuYmFja2VkX29mZl9wZWVycy5pbnNlcnQoCiAgICAgICAgICAgICAgICAgICAgICAgIHBlZXJfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZDo6dGltZTo6SW5zdGFudDo6bm93KCkgKyBzZWxmLmluY29taW5nX2lwX3Rocm90dGxlX2R1cmF0aW9uLAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogIm5ldDo6cGVlcnMiLCA/cGVlcl9pZCwga2luZD0/cGVlci5raW5kLCBkdXJhdGlvbj0/c2VsZi5pbmNvbWluZ19pcF90aHJvdHRsZV9kdXJhdGlvbiwgImJhY2tpbmcgb2ZmIG9uIGdyYWNlZnVsbHkgY2xvc2VkIHNlc3Npb24iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBFbnRyeTo6VmFjYW50KF8pID0+IHJldHVybiwKICAgICAgICB9CgogICAgICAgIHNlbGYuZmlsbF9vdXRib3VuZF9zbG90cygpOwogICAgfQoKICAgIC8vLyBDYWxsZWQgd2hlbiBhIF9wZW5kaW5nXyBvdXRib3VuZCBjb25uZWN0aW9uIGlzIHN1Y2Nlc3NmdWwuCiAgICBwdWIoY3JhdGUpIGZuIG9uX2FjdGl2ZV9vdXRnb2luZ19lc3RhYmxpc2hlZCgmbXV0IHNlbGYsIHBlZXJfaWQ6IFBlZXJJZCkgewogICAgICAgIGlmIGxldCBTb21lKHBlZXIpID0gc2VsZi5wZWVycy5nZXRfbXV0KCZwZWVyX2lkKSB7CiAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQ6OnBlZXJzIiwgP3BlZXJfaWQsICJlc3RhYmxpc2hlZCBhY3RpdmUgb3V0Z29pbmcgY29ubmVjdGlvbiIpOwogICAgICAgICAgICBzZWxmLmNvbm5lY3Rpb25faW5mby5kZWNyX3N0YXRlKHBlZXIuc3RhdGUpOwogICAgICAgICAgICBzZWxmLmNvbm5lY3Rpb25faW5mby5pbmNfb3V0KCk7CiAgICAgICAgICAgIHBlZXIuc3RhdGUgPSBQZWVyQ29ubmVjdGlvblN0YXRlOjpPdXQ7CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBDYWxsZWQgd2hlbiBhbiBfYWN0aXZlXyBzZXNzaW9uIHRvIGEgcGVlciB3YXMgZm9yY2VmdWxseSBkcm9wcGVkIGR1ZSB0byBhbiBlcnJvci4KICAgIC8vLwogICAgLy8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHRoZSBlcnJvciBpcyBmYXRhbCwgdGhlIHBlZXIgd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIHBlZXIgc2V0CiAgICAvLy8gb3RoZXJ3aXNlIGl0cyByZXB1dGF0aW9uIGlzIHNsYXNoZWQuCiAgICBwdWIoY3JhdGUpIGZuIG9uX2FjdGl2ZV9zZXNzaW9uX2Ryb3BwZWQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHJlbW90ZV9hZGRyOiAmU29ja2V0QWRkciwKICAgICAgICBwZWVyX2lkOiAmUGVlcklkLAogICAgICAgIGVycjogJkV0aFN0cmVhbUVycm9yLAogICAgKSB7CiAgICAgICAgc2VsZi5vbl9jb25uZWN0aW9uX2ZhaWx1cmUocmVtb3RlX2FkZHIsIHBlZXJfaWQsIGVyciwgUmVwdXRhdGlvbkNoYW5nZUtpbmQ6OkRyb3BwZWQpCiAgICB9CgogICAgLy8vIENhbGxlZCB3aGVuIGFuIGF0dGVtcHQgdG8gY3JlYXRlIGFuIF9vdXRnb2luZ18gcGVuZGluZyBzZXNzaW9uIGZhaWxlZCB3aGlsZSBzZXR0aW5nIHVwIGEgdGNwCiAgICAvLy8gY29ubmVjdGlvbi4KICAgIHB1YihjcmF0ZSkgZm4gb25fb3V0Z29pbmdfY29ubmVjdGlvbl9mYWlsdXJlKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICByZW1vdGVfYWRkcjogJlNvY2tldEFkZHIsCiAgICAgICAgcGVlcl9pZDogJlBlZXJJZCwKICAgICAgICBlcnI6ICZpbzo6RXJyb3IsCiAgICApIHsKICAgICAgICAvLyB0aGVyZSdzIGEgcmFjZSBjb25kaXRpb24gd2hlcmUgd2UgYWNjZXB0ZWQgYW4gaW5jb21pbmcgY29ubmVjdGlvbiB3aGlsZSB3ZSB3ZXJlIHRyeWluZyB0bwogICAgICAgIC8vIGNvbm5lY3QgdG8gdGhlIHNhbWUgcGVlciBhdCB0aGUgc2FtZSB0aW1lLiBpZiB0aGUgb3V0Z29pbmcgY29ubmVjdGlvbiBmYWlsZWQKICAgICAgICAvLyBhZnRlciB0aGUgaW5jb21pbmcgY29ubmVjdGlvbiB3YXMgYWNjZXB0ZWQsIHdlIGNhbiBpZ25vcmUgdGhpcyBlcnJvcgogICAgICAgIGlmIGxldCBTb21lKHBlZXIpID0gc2VsZi5wZWVycy5nZXQocGVlcl9pZCkgewogICAgICAgICAgICBpZiBwZWVyLnN0YXRlLmlzX2luY29taW5nKCkgewogICAgICAgICAgICAgICAgLy8gd2UgYWxyZWFkeSBoYXZlIGFuIGFjdGl2ZSBjb25uZWN0aW9uIHRvIHRoZSBwZWVyLCBzbyB3ZSBjYW4gaWdub3JlIHRoaXMgZXJyb3IKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiBwZWVyLmlzX3RydXN0ZWQoKSAmJiBpc19jb25uZWN0aW9uX2ZhaWxlZF9yZXB1dGF0aW9uKHBlZXIucmVwdXRhdGlvbikgewogICAgICAgICAgICAgICAgLy8gdHJpZ2dlciByZXNvbHV0aW9uIHRhc2sgZm9yIHRydXN0ZWQgcGVlciBzaW5jZSBtdWx0aXBsZSBjb25uZWN0aW9uIGZhaWx1cmVzCiAgICAgICAgICAgICAgICAvLyBvY2N1cnJlZAogICAgICAgICAgICAgICAgc2VsZi50cnVzdGVkX3BlZXJzX3Jlc29sdmVyLmludGVydmFsLnJlc2V0X2ltbWVkaWF0ZWx5KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNlbGYub25fY29ubmVjdGlvbl9mYWlsdXJlKHJlbW90ZV9hZGRyLCBwZWVyX2lkLCBlcnIsIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpGYWlsZWRUb0Nvbm5lY3QpCiAgICB9CgogICAgZm4gb25fY29ubmVjdGlvbl9mYWlsdXJlKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICByZW1vdGVfYWRkcjogJlNvY2tldEFkZHIsCiAgICAgICAgcGVlcl9pZDogJlBlZXJJZCwKICAgICAgICBlcnI6IGltcGwgU2Vzc2lvbkVycm9yLAogICAgICAgIHJlcHV0YXRpb25fY2hhbmdlOiBSZXB1dGF0aW9uQ2hhbmdlS2luZCwKICAgICkgewogICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQ6OnBlZXJzIiwgP3JlbW90ZV9hZGRyLCA/cGVlcl9pZCwgJWVyciwgImhhbmRsaW5nIGZhaWxlZCBjb25uZWN0aW9uIik7CgogICAgICAgIGlmIGVyci5pc19mYXRhbF9wcm90b2NvbF9lcnJvcigpIHsKICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogIm5ldDo6cGVlcnMiLCA/cmVtb3RlX2FkZHIsID9wZWVyX2lkLCAlZXJyLCAiZmF0YWwgY29ubmVjdGlvbiBlcnJvciIpOwogICAgICAgICAgICAvLyByZW1vdmUgdGhlIHBlZXIgdG8gd2hpY2ggd2UgY2FuJ3QgZXN0YWJsaXNoIGEgY29ubmVjdGlvbiBkdWUgdG8gcHJvdG9jb2wgcmVsYXRlZAogICAgICAgICAgICAvLyBpc3N1ZXMuCiAgICAgICAgICAgIGlmIGxldCBFbnRyeTo6T2NjdXBpZWQobXV0IGVudHJ5KSA9IHNlbGYucGVlcnMuZW50cnkoKnBlZXJfaWQpIHsKICAgICAgICAgICAgICAgIHNlbGYuY29ubmVjdGlvbl9pbmZvLmRlY3Jfc3RhdGUoZW50cnkuZ2V0KCkuc3RhdGUpOwogICAgICAgICAgICAgICAgLy8gb25seSByZW1vdmUgaWYgdGhlIHBlZXIgaXMgbm90IHRydXN0ZWQKICAgICAgICAgICAgICAgIGlmIGVudHJ5LmdldCgpLmlzX3RydXN0ZWQoKSB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkuZ2V0X211dCgpLnN0YXRlID0gUGVlckNvbm5lY3Rpb25TdGF0ZTo6SWRsZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5xdWV1ZWRfYWN0aW9ucy5wdXNoX2JhY2soUGVlckFjdGlvbjo6UGVlclJlbW92ZWQoKnBlZXJfaWQpKTsKICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZXJyb3IgaXMgY2F1c2VkIGJ5IGEgcGVlciB0aGF0IHNob3VsZCBiZSBiYW5uZWQgZnJvbSBkaXNjb3ZlcnkKICAgICAgICAgICAgICAgICAgICBpZiBlcnIubWVyaXRzX2Rpc2NvdmVyeV9iYW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucXVldWVkX2FjdGlvbnMucHVzaF9iYWNrKFBlZXJBY3Rpb246OkRpc2NvdmVyeUJhblBlZXJJZCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZWVyX2lkOiAqcGVlcl9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlwX2FkZHI6IHJlbW90ZV9hZGRyLmlwKCksCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBiYW4gdGhlIHBlZXIKICAgICAgICAgICAgc2VsZi5iYW5fcGVlcigqcGVlcl9pZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGV0IG11dCBiYWNrb2ZmX3VudGlsID0gTm9uZTsKICAgICAgICAgICAgbGV0IG11dCByZW1vdmVfcGVlciA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgbGV0IFNvbWUocGVlcikgPSBzZWxmLnBlZXJzLmdldF9tdXQocGVlcl9pZCkgewogICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUoa2luZCkgPSBlcnIuc2hvdWxkX2JhY2tvZmYoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgcGVlci5pc190cnVzdGVkKCkgfHwgcGVlci5pc19zdGF0aWMoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByb3ZpZGUgYSBiaXQgbW9yZSBsZWV3YXkgZm9yIHRydXN0ZWQgcGVlcnMgYW5kIHVzZSBhIGxvd2VyIGJhY2tvZmYgc28KICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhhdCB3ZSBrZWVwIHJlLXRyeWluZyB0aGVtIGFmdGVyIGJhY2tpbmcgb2ZmIHNob3J0bHksIGJ1dCB3ZSBzaG91bGQgYXQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGVhc3QgYmFja29mZiBmb3IgdGhlIGxvdyBkdXJhdGlvbiB0byBub3QgdmlvbGF0ZSB0aGUgaXAgYmFzZWQgaW5ib3VuZAogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25uZWN0aW9uIHRocm90dGxlIHRoYXQgcGVlciBoYXMgaW4gcGxhY2UsIGJlY2F1c2UgdGhpcyBwZWVyIG1pZ2h0IG5vdAogICAgICAgICAgICAgICAgICAgICAgICAvLyBoYXZlIHVzIHJlZ2lzdGVyZWQgYXMgYSB0cnVzdGVkIHBlZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBiYWNrb2ZmID0gc2VsZi5iYWNrb2ZmX2R1cmF0aW9ucy5sb3c7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tvZmZfdW50aWwgPSBTb21lKHN0ZDo6dGltZTo6SW5zdGFudDo6bm93KCkgKyBiYWNrb2ZmKTsKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogIm5ldDo6cGVlcnMiLCA/cGVlcl9pZCwgP2JhY2tvZmYsICJiYWNraW5nIG9mZiB0cnVzdGVkIHBlZXIiKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJbmNyZW1lbnQgcGVlci5iYWNrb2ZmX2NvdW50ZXIKICAgICAgICAgICAgICAgICAgICAgICAgaWYga2luZC5pc19zZXZlcmUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZWVyLnNldmVyZV9iYWNrb2ZmX2NvdW50ZXIgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlZXIuc2V2ZXJlX2JhY2tvZmZfY291bnRlci5zYXR1cmF0aW5nX2FkZCgxKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAibmV0OjpwZWVycyIsID9wZWVyX2lkLCA/a2luZCwgc2V2ZXJlX2JhY2tvZmZfY291bnRlcj1wZWVyLnNldmVyZV9iYWNrb2ZmX2NvdW50ZXIsICJiYWNraW5nIG9mZiBiYXNpYyBwZWVyIik7CgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYmFja29mZl90aW1lID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYmFja29mZl9kdXJhdGlvbnMuYmFja29mZl91bnRpbChraW5kLCBwZWVyLnNldmVyZV9iYWNrb2ZmX2NvdW50ZXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHBlZXIgaGFzIHNpZ25hbGVkIHRoYXQgaXQgaXMgY3VycmVudGx5IHVuYWJsZSB0byBwcm9jZXNzIGFueSBtb3JlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbm5lY3Rpb25zLCBzbyB3ZSB3aWxsIGhvbGQgb2ZmIG9uIGF0dGVtcHRpbmcgYW55IG5ldyBjb25uZWN0aW9ucyBmb3IgYQogICAgICAgICAgICAgICAgICAgICAgICAvLyB3aGlsZQogICAgICAgICAgICAgICAgICAgICAgICBiYWNrb2ZmX3VudGlsID0gU29tZShiYWNrb2ZmX3RpbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIGVycm9yIHdhcyBub3QgYSBiYWNrb2ZmIGVycm9yLCB3ZSByZWR1Y2UgdGhlIHBlZXIncyByZXB1dGF0aW9uCiAgICAgICAgICAgICAgICAgICAgbGV0IHJlcHV0YXRpb25fY2hhbmdlID0gc2VsZi5yZXB1dGF0aW9uX3dlaWdodHMuY2hhbmdlKHJlcHV0YXRpb25fY2hhbmdlKTsKICAgICAgICAgICAgICAgICAgICBwZWVyLnJlcHV0YXRpb24gPSBwZWVyLnJlcHV0YXRpb24uc2F0dXJhdGluZ19hZGQocmVwdXRhdGlvbl9jaGFuZ2UuYXNfaTMyKCkpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBzZWxmLmNvbm5lY3Rpb25faW5mby5kZWNyX3N0YXRlKHBlZXIuc3RhdGUpOwogICAgICAgICAgICAgICAgcGVlci5zdGF0ZSA9IFBlZXJDb25uZWN0aW9uU3RhdGU6OklkbGU7CgogICAgICAgICAgICAgICAgaWYgcGVlci5zZXZlcmVfYmFja29mZl9jb3VudGVyID4gc2VsZi5tYXhfYmFja29mZl9jb3VudCAmJgogICAgICAgICAgICAgICAgICAgICFwZWVyLmlzX3RydXN0ZWQoKSAmJgogICAgICAgICAgICAgICAgICAgICFwZWVyLmlzX3N0YXRpYygpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gbWFyayBwZWVyIGZvciByZW1vdmFsIGlmIGl0IGhhcyBiZWVuIGJhY2tvZmYgdG9vIG1hbnkgdGltZXMgYW5kIGlzIF9ub3RfCiAgICAgICAgICAgICAgICAgICAgLy8gdHJ1c3RlZCBvciBzdGF0aWMKICAgICAgICAgICAgICAgICAgICByZW1vdmVfcGVlciA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHJlbW92ZSBwZWVyIGlmIGl0IGhhcyBiZWVuIG1hcmtlZCBmb3IgcmVtb3ZhbAogICAgICAgICAgICBpZiByZW1vdmVfcGVlciB7CiAgICAgICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAibmV0IiwgP3BlZXJfaWQsICJyZW1vdmVkIHBlZXIgYWZ0ZXIgZXhjZWVkaW5nIGJhY2tvZmYgY291bnRlciIpOwogICAgICAgICAgICAgICAgbGV0IChwZWVyX2lkLCBfKSA9IHNlbGYucGVlcnMucmVtb3ZlX2VudHJ5KHBlZXJfaWQpLmV4cGVjdCgicGVlciBtdXN0IGV4aXN0Iik7CiAgICAgICAgICAgICAgICBzZWxmLnF1ZXVlZF9hY3Rpb25zLnB1c2hfYmFjayhQZWVyQWN0aW9uOjpQZWVyUmVtb3ZlZChwZWVyX2lkKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiBsZXQgU29tZShiYWNrb2ZmX3VudGlsKSA9IGJhY2tvZmZfdW50aWwgewogICAgICAgICAgICAgICAgLy8gb3RoZXJ3aXNlLCBiYWNrb2ZmIHRoZSBwZWVyIGlmIG1hcmtlZCBhcyBzdWNoCiAgICAgICAgICAgICAgICBzZWxmLmJhY2tvZmZfcGVlcl91bnRpbCgqcGVlcl9pZCwgYmFja29mZl91bnRpbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNlbGYuZmlsbF9vdXRib3VuZF9zbG90cygpOwogICAgfQoKICAgIC8vLyBJbnZva2VkIGlmIGEgcGVuZGluZyBzZXNzaW9uIHdhcyBkaXNjb25uZWN0ZWQgYmVjYXVzZSB0aGVyZSdzIGFscmVhZHkgYSBjb25uZWN0aW9uIHRvIHRoZQogICAgLy8vIHBlZXIuCiAgICAvLy8KICAgIC8vLyBJZiB0aGUgc2Vzc2lvbiB3YXMgYW4gb3V0Z29pbmcgY29ubmVjdGlvbiwgdGhpcyBtZWFucyB0aGF0IHRoZSBwZWVyIGluaXRpYXRlZCBhIGNvbm5lY3Rpb24KICAgIC8vLyB0byB1cyBhdCB0aGUgc2FtZSB0aW1lIGFuZCB0aGlzIGNvbm5lY3Rpb24gaXMgYWxyZWFkeSBlc3RhYmxpc2hlZC4KICAgIHB1YihjcmF0ZSkgY29uc3QgZm4gb25fYWxyZWFkeV9jb25uZWN0ZWQoJm11dCBzZWxmLCBkaXJlY3Rpb246IERpcmVjdGlvbikgewogICAgICAgIG1hdGNoIGRpcmVjdGlvbiB7CiAgICAgICAgICAgIERpcmVjdGlvbjo6SW5jb21pbmcgPT4gewogICAgICAgICAgICAgICAgLy8gbmVlZCB0byBkZWNyZW1lbnQgdGhlIGluZ29pbmcgY291bnRlcgogICAgICAgICAgICAgICAgc2VsZi5jb25uZWN0aW9uX2luZm8uZGVjcl9wZW5kaW5nX2luKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRGlyZWN0aW9uOjpPdXRnb2luZyhfKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBjbGVhbnVwIGlzIGhhbmRsZWQgd2hlbiB0aGUgaW5jb21pbmcgYWN0aXZlIHNlc3Npb24gaXMgYWN0aXZhdGVkIGluCiAgICAgICAgICAgICAgICAvLyBgb25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZGAKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQ2FsbGVkIGFzIGZvbGxvdy11cCBmb3IgYSBkaXNjb3ZlcmVkIHBlZXIuCiAgICAvLy8KICAgIC8vLyBUaGUgW2BGb3JrSWRgXSBpcyByZXRyaWV2ZWQgZnJvbSBhbiBFTlIgcmVjb3JkIHRoYXQgdGhlIHBlZXIgYW5ub3VuY2VzIG92ZXIgdGhlIGRpc2NvdmVyeQogICAgLy8vIHByb3RvY29sCiAgICBwdWIoY3JhdGUpIGZuIHNldF9kaXNjb3ZlcmVkX2ZvcmtfaWQoJm11dCBzZWxmLCBwZWVyX2lkOiBQZWVySWQsIGZvcmtfaWQ6IEZvcmtJZCkgewogICAgICAgIGlmIGxldCBTb21lKHBlZXIpID0gc2VsZi5wZWVycy5nZXRfbXV0KCZwZWVyX2lkKSB7CiAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQ6OnBlZXJzIiwgP3BlZXJfaWQsID9mb3JrX2lkLCAic2V0IGRpc2NvdmVyZWQgZm9yayBpZCIpOwogICAgICAgICAgICBwZWVyLmZvcmtfaWQgPSBTb21lKEJveDo6bmV3KGZvcmtfaWQpKTsKICAgICAgICB9CiAgICB9CgogICAgLy8vIENhbGxlZCBmb3IgYSBuZXdseSBkaXNjb3ZlcmVkIHBlZXIuCiAgICAvLy8KICAgIC8vLyBJZiB0aGUgcGVlciBhbHJlYWR5IGV4aXN0cywgdGhlbiB0aGUgYWRkcmVzcywga2luZCBhbmQgYGZvcmtfaWRgIHdpbGwgYmUgdXBkYXRlZC4KICAgIHB1YihjcmF0ZSkgZm4gYWRkX3BlZXIoJm11dCBzZWxmLCBwZWVyX2lkOiBQZWVySWQsIGFkZHI6IFBlZXJBZGRyLCBmb3JrX2lkOiBPcHRpb248Rm9ya0lkPikgewogICAgICAgIHNlbGYuYWRkX3BlZXJfa2luZChwZWVyX2lkLCBOb25lLCBhZGRyLCBmb3JrX2lkKQogICAgfQoKICAgIC8vLyBNYXJrcyB0aGUgZ2l2ZW4gcGVlciBhcyB0cnVzdGVkLgogICAgcHViKGNyYXRlKSBmbiBhZGRfdHJ1c3RlZF9wZWVyX2lkKCZtdXQgc2VsZiwgcGVlcl9pZDogUGVlcklkKSB7CiAgICAgICAgc2VsZi50cnVzdGVkX3BlZXJfaWRzLmluc2VydChwZWVyX2lkKTsKICAgICAgICBpZiBsZXQgU29tZShwZWVyKSA9IHNlbGYucGVlcnMuZ2V0X211dCgmcGVlcl9pZCkgewogICAgICAgICAgICBwZWVyLmtpbmQgPSBQZWVyS2luZDo6VHJ1c3RlZDsKICAgICAgICB9CiAgICB9CgogICAgLy8vIENhbGxlZCBmb3IgYSBuZXdseSBkaXNjb3ZlcmVkIHRydXN0ZWQgcGVlci4KICAgIC8vLwogICAgLy8vIElmIHRoZSBwZWVyIGFscmVhZHkgZXhpc3RzLCB0aGVuIHRoZSBhZGRyZXNzIGFuZCBraW5kIHdpbGwgYmUgdXBkYXRlZC4KICAgICNbY2ZnX2F0dHIobm90KHRlc3QpLCBleHBlY3QoZGVhZF9jb2RlKSldCiAgICBwdWIoY3JhdGUpIGZuIGFkZF90cnVzdGVkX3BlZXIoJm11dCBzZWxmLCBwZWVyX2lkOiBQZWVySWQsIGFkZHI6IFBlZXJBZGRyKSB7CiAgICAgICAgc2VsZi5hZGRfcGVlcl9raW5kKHBlZXJfaWQsIFNvbWUoUGVlcktpbmQ6OlRydXN0ZWQpLCBhZGRyLCBOb25lKQogICAgfQoKICAgIC8vLyBDYWxsZWQgZm9yIGEgbmV3bHkgZGlzY292ZXJlZCBwZWVyLgogICAgLy8vCiAgICAvLy8gSWYgdGhlIHBlZXIgYWxyZWFkeSBleGlzdHMsIHRoZW4gdGhlIGFkZHJlc3MsIGtpbmQgYW5kIGBmb3JrX2lkYCB3aWxsIGJlIHVwZGF0ZWQuCiAgICAvLy8gSWYgdGhlIHBlZXIgZXhpc3RzIGFuZCBhIFtgUGVlcktpbmRgXSBpcyBwcm92aWRlZCB0aGVuIHRoZSBwZWVyJ3Mga2luZCBpcyB1cGRhdGVkCiAgICBwdWIoY3JhdGUpIGZuIGFkZF9wZWVyX2tpbmQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHBlZXJfaWQ6IFBlZXJJZCwKICAgICAgICBraW5kOiBPcHRpb248UGVlcktpbmQ+LAogICAgICAgIGFkZHI6IFBlZXJBZGRyLAogICAgICAgIGZvcmtfaWQ6IE9wdGlvbjxGb3JrSWQ+LAogICAgKSB7CiAgICAgICAgbGV0IGlwX2FkZHIgPSBhZGRyLnRjcCgpLmlwKCk7CgogICAgICAgIC8vIENoZWNrIGlmIHRoZSBJUCBpcyBpbiB0aGUgYWxsb3dlZCByYW5nZXMgKG5ldHJlc3RyaWN0KQogICAgICAgIGlmICFzZWxmLmlwX2ZpbHRlci5pc19hbGxvd2VkKCZpcF9hZGRyKSB7CiAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQiLCA/cGVlcl9pZCwgP2lwX2FkZHIsICJTa2lwcGluZyBwZWVyIGZyb20gSVAgbm90IGluIGFsbG93ZWQgcmFuZ2VzIik7CiAgICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgaWYgc2VsZi5iYW5fbGlzdC5pc19iYW5uZWQoJnBlZXJfaWQsICZpcF9hZGRyKSB7CiAgICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgbWF0Y2ggc2VsZi5wZWVycy5lbnRyeShwZWVyX2lkKSB7CiAgICAgICAgICAgIEVudHJ5OjpPY2N1cGllZChtdXQgZW50cnkpID0+IHsKICAgICAgICAgICAgICAgIGxldCBwZWVyID0gZW50cnkuZ2V0X211dCgpOwogICAgICAgICAgICAgICAgcGVlci5mb3JrX2lkID0gZm9ya19pZC5tYXAoQm94OjpuZXcpOwogICAgICAgICAgICAgICAgcGVlci5hZGRyID0gYWRkcjsKCiAgICAgICAgICAgICAgICBpZiBsZXQgU29tZShraW5kKSA9IGtpbmQgewogICAgICAgICAgICAgICAgICAgIHBlZXIua2luZCA9IGtpbmQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgcGVlci5zdGF0ZS5pc19pbmNvbWluZygpIHsKICAgICAgICAgICAgICAgICAgICAvLyBub3cgdGhhdCB3ZSBoYXZlIGFuIGFjdHVhbCBkaXNjb3ZlcmVkIGFkZHJlc3MsIGZvciB0aGF0IHBlZXIgYW5kIG5vdCBqdXN0IHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGlwIG9mIHRoZSBpbmNvbWluZyBjb25uZWN0aW9uLCB3ZSBkb24ndCBuZWVkIHRvIHJlbW92ZSB0aGUgcGVlciBhZnRlcgogICAgICAgICAgICAgICAgICAgIC8vIGRpc2Nvbm5lY3RpbmcsIFNlZSBgb25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZGAKICAgICAgICAgICAgICAgICAgICBwZWVyLnJlbW92ZV9hZnRlcl9kaXNjb25uZWN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRW50cnk6OlZhY2FudChlbnRyeSkgPT4gewogICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogIm5ldDo6cGVlcnMiLCA/cGVlcl9pZCwgYWRkcj0/YWRkci50Y3AoKSwgImRpc2NvdmVyZWQgbmV3IG5vZGUiKTsKICAgICAgICAgICAgICAgIGxldCBtdXQgcGVlciA9IFBlZXI6OndpdGhfa2luZChhZGRyLCBraW5kLnVud3JhcF9vcihQZWVyS2luZDo6QmFzaWMpKTsKICAgICAgICAgICAgICAgIHBlZXIuZm9ya19pZCA9IGZvcmtfaWQubWFwKEJveDo6bmV3KTsKICAgICAgICAgICAgICAgIGVudHJ5Lmluc2VydChwZWVyKTsKICAgICAgICAgICAgICAgIHNlbGYucXVldWVkX2FjdGlvbnMucHVzaF9iYWNrKFBlZXJBY3Rpb246OlBlZXJBZGRlZChwZWVyX2lkKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIGtpbmQuZmlsdGVyKHxraW5kfCBraW5kLmlzX3RydXN0ZWQoKSkuaXNfc29tZSgpIHsKICAgICAgICAgICAgLy8gYWxzbyB0cmFjayB0aGUgcGVlciBpbiB0aGUgcGVlciBpZCBzZXQKICAgICAgICAgICAgc2VsZi50cnVzdGVkX3BlZXJfaWRzLmluc2VydChwZWVyX2lkKTsKICAgICAgICB9CiAgICB9CgogICAgLy8vIFJlbW92ZXMgdGhlIHRyYWNrZWQgbm9kZSBmcm9tIHRoZSBzZXQuCiAgICBwdWIoY3JhdGUpIGZuIHJlbW92ZV9wZWVyKCZtdXQgc2VsZiwgcGVlcl9pZDogUGVlcklkKSB7CiAgICAgICAgbGV0IEVudHJ5OjpPY2N1cGllZChlbnRyeSkgPSBzZWxmLnBlZXJzLmVudHJ5KHBlZXJfaWQpIGVsc2UgeyByZXR1cm4gfTsKICAgICAgICBpZiBlbnRyeS5nZXQoKS5pc190cnVzdGVkKCkgewogICAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgbGV0IG11dCBwZWVyID0gZW50cnkucmVtb3ZlKCk7CgogICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQ6OnBlZXJzIiwgP3BlZXJfaWQsICJyZW1vdmUgZGlzY292ZXJlZCBub2RlIik7CiAgICAgICAgc2VsZi5xdWV1ZWRfYWN0aW9ucy5wdXNoX2JhY2soUGVlckFjdGlvbjo6UGVlclJlbW92ZWQocGVlcl9pZCkpOwoKICAgICAgICBpZiBwZWVyLnN0YXRlLmlzX2Nvbm5lY3RlZCgpIHsKICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogIm5ldDo6cGVlcnMiLCA/cGVlcl9pZCwgImRpc2Nvbm5lY3Rpbmcgb24gcmVtb3ZlIGZyb20gZGlzY292ZXJ5Iik7CiAgICAgICAgICAgIC8vIHdlIHRlcm1pbmF0ZSB0aGUgYWN0aXZlIHNlc3Npb24gaGVyZSwgYnV0IG9ubHkgcmVtb3ZlIHRoZSBwZWVyIGFmdGVyIHRoZSBzZXNzaW9uCiAgICAgICAgICAgIC8vIHdhcyBkaXNjb25uZWN0ZWQsIHRoaXMgcHJldmVudHMgdGhlIGNhc2Ugd2hlcmUgdGhlIHNlc3Npb24gaXMgc2NoZWR1bGVkIGZvcgogICAgICAgICAgICAvLyBkaXNjb25uZWN0IGJ1dCB0aGUgbm9kZSBpcyBpbW1lZGlhdGVseSByZWRpc2NvdmVyZWQsIFNlZSBhbHNvCiAgICAgICAgICAgIC8vIFtgU2VsZjo6b25fZGlzY29ubmVjdGVkKClgXQogICAgICAgICAgICBwZWVyLnJlbW92ZV9hZnRlcl9kaXNjb25uZWN0ID0gdHJ1ZTsKICAgICAgICAgICAgcGVlci5zdGF0ZS5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgIHNlbGYucGVlcnMuaW5zZXJ0KHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICBzZWxmLnF1ZXVlZF9hY3Rpb25zLnB1c2hfYmFjayhQZWVyQWN0aW9uOjpEaXNjb25uZWN0IHsKICAgICAgICAgICAgICAgIHBlZXJfaWQsCiAgICAgICAgICAgICAgICByZWFzb246IFNvbWUoRGlzY29ubmVjdFJlYXNvbjo6RGlzY29ubmVjdFJlcXVlc3RlZCksCiAgICAgICAgICAgIH0pCiAgICAgICAgfQogICAgfQoKICAgIC8vLyBDb25uZWN0IHRvIHRoZSBnaXZlbiBwZWVyLiBOT1RFOiBpZiB0aGUgbWF4aW11bSBudW1iZXIgb2Ygb3V0Ym91bmQgc2Vzc2lvbnMgaXMgcmVhY2hlZCwKICAgIC8vLyB0aGlzIHdvbid0IGRvIGFueXRoaW5nLiBTZWUgYHJldGhfbmV0d29yazo6U2Vzc2lvbk1hbmFnZXI6OmRpYWxfb3V0Ym91bmRgLgogICAgI1tjZmdfYXR0cihub3QodGVzdCksIGV4cGVjdChkZWFkX2NvZGUpKV0KICAgIHB1YihjcmF0ZSkgZm4gYWRkX2FuZF9jb25uZWN0KAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBwZWVyX2lkOiBQZWVySWQsCiAgICAgICAgYWRkcjogUGVlckFkZHIsCiAgICAgICAgZm9ya19pZDogT3B0aW9uPEZvcmtJZD4sCiAgICApIHsKICAgICAgICBzZWxmLmFkZF9hbmRfY29ubmVjdF9raW5kKHBlZXJfaWQsIFBlZXJLaW5kOjpCYXNpYywgYWRkciwgZm9ya19pZCkKICAgIH0KCiAgICAvLy8gQ29ubmVjdHMgYSBwZWVyIGFuZCBpdHMgYWRkcmVzcyB3aXRoIHRoZSBnaXZlbiBraW5kLgogICAgLy8vCiAgICAvLy8gTm90ZTogVGhpcyBpcyBpbnZva2VkIG9uIGRlbWFuZCB2aWEgYW4gZXh0ZXJuYWwgY29tbWFuZCByZWNlaXZlZCBieSB0aGUgbWFuYWdlcgogICAgcHViKGNyYXRlKSBmbiBhZGRfYW5kX2Nvbm5lY3Rfa2luZCgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgcGVlcl9pZDogUGVlcklkLAogICAgICAgIGtpbmQ6IFBlZXJLaW5kLAogICAgICAgIGFkZHI6IFBlZXJBZGRyLAogICAgICAgIGZvcmtfaWQ6IE9wdGlvbjxGb3JrSWQ+LAogICAgKSB7CiAgICAgICAgbGV0IGlwX2FkZHIgPSBhZGRyLnRjcCgpLmlwKCk7CgogICAgICAgIC8vIENoZWNrIGlmIHRoZSBJUCBpcyBpbiB0aGUgYWxsb3dlZCByYW5nZXMgKG5ldHJlc3RyaWN0KQogICAgICAgIGlmICFzZWxmLmlwX2ZpbHRlci5pc19hbGxvd2VkKCZpcF9hZGRyKSB7CiAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQiLCA/cGVlcl9pZCwgP2lwX2FkZHIsICJTa2lwcGluZyBvdXRib3VuZCBjb25uZWN0aW9uIHRvIElQIG5vdCBpbiBhbGxvd2VkIHJhbmdlcyIpOwogICAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGlmIHNlbGYuYmFuX2xpc3QuaXNfYmFubmVkKCZwZWVyX2lkLCAmaXBfYWRkcikgewogICAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIG1hdGNoIHNlbGYucGVlcnMuZW50cnkocGVlcl9pZCkgewogICAgICAgICAgICBFbnRyeTo6T2NjdXBpZWQobXV0IGVudHJ5KSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcGVlciA9IGVudHJ5LmdldF9tdXQoKTsKICAgICAgICAgICAgICAgIHBlZXIua2luZCA9IGtpbmQ7CiAgICAgICAgICAgICAgICBwZWVyLmZvcmtfaWQgPSBmb3JrX2lkLm1hcChCb3g6Om5ldyk7CiAgICAgICAgICAgICAgICBwZWVyLmFkZHIgPSBhZGRyOwoKICAgICAgICAgICAgICAgIGlmIHBlZXIuc3RhdGUgPT0gUGVlckNvbm5lY3Rpb25TdGF0ZTo6SWRsZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVHJ5IGNvbm5lY3RpbmcgYWdhaW4uCiAgICAgICAgICAgICAgICAgICAgcGVlci5zdGF0ZSA9IFBlZXJDb25uZWN0aW9uU3RhdGU6OlBlbmRpbmdPdXQ7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jb25uZWN0aW9uX2luZm8uaW5jX3BlbmRpbmdfb3V0KCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5xdWV1ZWRfYWN0aW9ucwogICAgICAgICAgICAgICAgICAgICAgICAucHVzaF9iYWNrKFBlZXJBY3Rpb246OkNvbm5lY3QgeyBwZWVyX2lkLCByZW1vdGVfYWRkcjogYWRkci50Y3AoKSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBFbnRyeTo6VmFjYW50KGVudHJ5KSA9PiB7CiAgICAgICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAibmV0OjpwZWVycyIsID9wZWVyX2lkLCBhZGRyPT9hZGRyLnRjcCgpLCAiY29ubmVjdHMgbmV3IG5vZGUiKTsKICAgICAgICAgICAgICAgIGxldCBtdXQgcGVlciA9IFBlZXI6OndpdGhfa2luZChhZGRyLCBraW5kKTsKICAgICAgICAgICAgICAgIHBlZXIuc3RhdGUgPSBQZWVyQ29ubmVjdGlvblN0YXRlOjpQZW5kaW5nT3V0OwogICAgICAgICAgICAgICAgcGVlci5mb3JrX2lkID0gZm9ya19pZC5tYXAoQm94OjpuZXcpOwogICAgICAgICAgICAgICAgZW50cnkuaW5zZXJ0KHBlZXIpOwogICAgICAgICAgICAgICAgc2VsZi5jb25uZWN0aW9uX2luZm8uaW5jX3BlbmRpbmdfb3V0KCk7CiAgICAgICAgICAgICAgICBzZWxmLnF1ZXVlZF9hY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgLnB1c2hfYmFjayhQZWVyQWN0aW9uOjpDb25uZWN0IHsgcGVlcl9pZCwgcmVtb3RlX2FkZHI6IGFkZHIudGNwKCkgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIGtpbmQuaXNfdHJ1c3RlZCgpIHsKICAgICAgICAgICAgc2VsZi50cnVzdGVkX3BlZXJfaWRzLmluc2VydChwZWVyX2lkKTsKICAgICAgICB9CiAgICB9CgogICAgLy8vIFJlbW92ZXMgdGhlIHRyYWNrZWQgbm9kZSBmcm9tIHRoZSB0cnVzdGVkIHNldC4KICAgIHB1YihjcmF0ZSkgZm4gcmVtb3ZlX3BlZXJfZnJvbV90cnVzdGVkX3NldCgmbXV0IHNlbGYsIHBlZXJfaWQ6IFBlZXJJZCkgewogICAgICAgIGxldCBFbnRyeTo6T2NjdXBpZWQobXV0IGVudHJ5KSA9IHNlbGYucGVlcnMuZW50cnkocGVlcl9pZCkgZWxzZSB7IHJldHVybiB9OwogICAgICAgIGlmICFlbnRyeS5nZXQoKS5pc190cnVzdGVkKCkgewogICAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGxldCBwZWVyID0gZW50cnkuZ2V0X211dCgpOwogICAgICAgIHBlZXIua2luZCA9IFBlZXJLaW5kOjpCYXNpYzsKCiAgICAgICAgc2VsZi50cnVzdGVkX3BlZXJfaWRzLnJlbW92ZSgmcGVlcl9pZCk7CiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGlkbGUgcGVlciB3aXRoIHRoZSBoaWdoZXN0IHJlcHV0YXRpb24uCiAgICAvLy8KICAgIC8vLyBQZWVycyB0aGF0IGFyZSBgdHJ1c3RlZGAgb3IgYHN0YXRpY2AsIHNlZSBbYFBlZXJLaW5kYF0sIGFyZSBwcmlvcml0aXplZCBhcyBsb25nIGFzIHRoZXkncmUKICAgIC8vLyBub3QgY3VycmVudGx5IG1hcmtlZCBhcyBiYW5uZWQgb3IgYmFja2VkIG9mZi4KICAgIC8vLwogICAgLy8vIElmIGB0cnVzdGVkX25vZGVzX29ubHlgIGlzIGVuYWJsZWQsIHNlZSBbYFBlZXJzQ29uZmlnYF0sIHRoZW4gdGhpcyB3aWxsIG9ubHkgY29uc2lkZXIKICAgIC8vLyBgdHJ1c3RlZGAgcGVlcnMuCiAgICAvLy8KICAgIC8vLyBSZXR1cm5zIGBOb25lYCBpZiBubyBwZWVyIGlzIGF2YWlsYWJsZS4KICAgIGZuIGJlc3RfdW5jb25uZWN0ZWQoJm11dCBzZWxmKSAtPiBPcHRpb248KFBlZXJJZCwgJm11dCBQZWVyKT4gewogICAgICAgIGxldCBtdXQgdW5jb25uZWN0ZWQgPSBzZWxmLnBlZXJzLml0ZXJfbXV0KCkuZmlsdGVyKHwoXywgcGVlcil8IHsKICAgICAgICAgICAgIXBlZXIuaXNfYmFja2VkX29mZigpICYmCiAgICAgICAgICAgICAgICAhcGVlci5pc19iYW5uZWQoKSAmJgogICAgICAgICAgICAgICAgcGVlci5zdGF0ZS5pc191bmNvbm5lY3RlZCgpICYmCiAgICAgICAgICAgICAgICAoIXNlbGYudHJ1c3RlZF9ub2Rlc19vbmx5IHx8IHBlZXIuaXNfdHJ1c3RlZCgpKQogICAgICAgIH0pOwoKICAgICAgICAvLyBrZWVwIHRyYWNrIG9mIHRoZSBiZXN0IHBlZXIsIGlmIHRoZXJlJ3Mgb25lCiAgICAgICAgbGV0IG11dCBiZXN0X3BlZXIgPSB1bmNvbm5lY3RlZC5uZXh0KCk/OwoKICAgICAgICBpZiBiZXN0X3BlZXIuMS5pc190cnVzdGVkKCkgfHwgYmVzdF9wZWVyLjEuaXNfc3RhdGljKCkgewogICAgICAgICAgICByZXR1cm4gU29tZSgoKmJlc3RfcGVlci4wLCBiZXN0X3BlZXIuMSkpCiAgICAgICAgfQoKICAgICAgICBmb3IgbWF5YmVfYmV0dGVyIGluIHVuY29ubmVjdGVkIHsKICAgICAgICAgICAgLy8gaWYgdGhlIHBlZXIgaXMgdHJ1c3RlZCBvciBzdGF0aWMsIHJldHVybiBpdCBpbW1lZGlhdGVseQogICAgICAgICAgICBpZiBtYXliZV9iZXR0ZXIuMS5pc190cnVzdGVkKCkgfHwgbWF5YmVfYmV0dGVyLjEuaXNfc3RhdGljKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFNvbWUoKCptYXliZV9iZXR0ZXIuMCwgbWF5YmVfYmV0dGVyLjEpKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBvdGhlcndpc2Ugd2Uga2VlcCB0cmFjayBvZiB0aGUgYmVzdCBwZWVyIHVzaW5nIHRoZSByZXB1dGF0aW9uCiAgICAgICAgICAgIGlmIG1heWJlX2JldHRlci4xLnJlcHV0YXRpb24gPiBiZXN0X3BlZXIuMS5yZXB1dGF0aW9uIHsKICAgICAgICAgICAgICAgIGJlc3RfcGVlciA9IG1heWJlX2JldHRlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBTb21lKCgqYmVzdF9wZWVyLjAsIGJlc3RfcGVlci4xKSkKICAgIH0KCiAgICAvLy8gSWYgdGhlcmUncyBjYXBhY2l0eSBmb3IgbmV3IG91dGJvdW5kIGNvbm5lY3Rpb25zLCB0aGlzIHdpbGwgcXVldWUgbmV3CiAgICAvLy8gW2BQZWVyQWN0aW9uOjpDb25uZWN0YF0gYWN0aW9ucy4KICAgIC8vLwogICAgLy8vIE5ldyBjb25uZWN0aW9ucyBhcmUgb25seSBpbml0aWF0ZWQsIGlmIHNsb3RzIGFyZSBhdmFpbGFibGUgYW5kIGFwcHJvcHJpYXRlIHBlZXJzIGFyZQogICAgLy8vIGF2YWlsYWJsZS4KICAgIGZuIGZpbGxfb3V0Ym91bmRfc2xvdHMoJm11dCBzZWxmKSB7CiAgICAgICAgc2VsZi50aWNrKCk7CgogICAgICAgIGlmICFzZWxmLm5ldF9jb25uZWN0aW9uX3N0YXRlLmlzX2FjdGl2ZSgpIHsKICAgICAgICAgICAgLy8gbm90aGluZyB0byBmaWxsCiAgICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgLy8gYXMgbG9uZyBhcyB0aGVyZSBhcmUgc2xvdHMgYXZhaWxhYmxlIGZpbGwgdGhlbSB3aXRoIHRoZSBiZXN0IHBlZXJzCiAgICAgICAgd2hpbGUgc2VsZi5jb25uZWN0aW9uX2luZm8uaGFzX291dF9jYXBhY2l0eSgpIHsKICAgICAgICAgICAgbGV0IGFjdGlvbiA9IHsKICAgICAgICAgICAgICAgIGxldCAocGVlcl9pZCwgcGVlcikgPSBtYXRjaCBzZWxmLmJlc3RfdW5jb25uZWN0ZWQoKSB7CiAgICAgICAgICAgICAgICAgICAgU29tZShwZWVyKSA9PiBwZWVyLAogICAgICAgICAgICAgICAgICAgIF8gPT4gYnJlYWssCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQ6OnBlZXJzIiwgP3BlZXJfaWQsIGFkZHI9P3BlZXIuYWRkciwgInNjaGVkdWxlIG91dGJvdW5kIGNvbm5lY3Rpb24iKTsKCiAgICAgICAgICAgICAgICBwZWVyLnN0YXRlID0gUGVlckNvbm5lY3Rpb25TdGF0ZTo6UGVuZGluZ091dDsKICAgICAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyBwZWVyX2lkLCByZW1vdGVfYWRkcjogcGVlci5hZGRyLnRjcCgpIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHNlbGYuY29ubmVjdGlvbl9pbmZvLmluY19wZW5kaW5nX291dCgpOwoKICAgICAgICAgICAgc2VsZi5xdWV1ZWRfYWN0aW9ucy5wdXNoX2JhY2soYWN0aW9uKTsKICAgICAgICB9CiAgICB9CgogICAgZm4gb25fcmVzb2x2ZWRfcGVlcigmbXV0IHNlbGYsIHBlZXJfaWQ6IFBlZXJJZCwgbmV3X3JlY29yZDogTm9kZVJlY29yZCkgewogICAgICAgIGlmIGxldCBTb21lKHBlZXIpID0gc2VsZi5wZWVycy5nZXRfbXV0KCZwZWVyX2lkKSB7CiAgICAgICAgICAgIGxldCBuZXdfYWRkciA9IFBlZXJBZGRyOjpuZXdfd2l0aF9wb3J0cygKICAgICAgICAgICAgICAgIG5ld19yZWNvcmQuYWRkcmVzcywKICAgICAgICAgICAgICAgIG5ld19yZWNvcmQudGNwX3BvcnQsCiAgICAgICAgICAgICAgICBTb21lKG5ld19yZWNvcmQudWRwX3BvcnQpLAogICAgICAgICAgICApOwoKICAgICAgICAgICAgaWYgcGVlci5hZGRyICE9IG5ld19hZGRyIHsKICAgICAgICAgICAgICAgIHBlZXIuYWRkciA9IG5ld19hZGRyOwogICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogIm5ldDo6cGVlcnMiLCA/cGVlcl9pZCwgYWRkcj0/cGVlci5hZGRyLCAiVXBkYXRlZCByZXNvbHZlZCB0cnVzdGVkIHBlZXIgYWRkcmVzcyIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBLZWVwcyB0cmFjayBvZiBuZXR3b3JrIHN0YXRlIGNoYW5nZXMuCiAgICBwdWIgY29uc3QgZm4gb25fbmV0d29ya19zdGF0ZV9jaGFuZ2UoJm11dCBzZWxmLCBzdGF0ZTogTmV0d29ya0Nvbm5lY3Rpb25TdGF0ZSkgewogICAgICAgIHNlbGYubmV0X2Nvbm5lY3Rpb25fc3RhdGUgPSBzdGF0ZTsKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgY3VycmVudCBuZXR3b3JrIGNvbm5lY3Rpb24gc3RhdGUuCiAgICBwdWIgY29uc3QgZm4gY29ubmVjdGlvbl9zdGF0ZSgmc2VsZikgLT4gJk5ldHdvcmtDb25uZWN0aW9uU3RhdGUgewogICAgICAgICZzZWxmLm5ldF9jb25uZWN0aW9uX3N0YXRlCiAgICB9CgogICAgLy8vIFNldHMgYG5ldF9jb25uZWN0aW9uX3N0YXRlYCB0byBgU2h1dHRpbmdEb3duYC4KICAgIHB1YiBjb25zdCBmbiBvbl9zaHV0ZG93bigmbXV0IHNlbGYpIHsKICAgICAgICBzZWxmLm5ldF9jb25uZWN0aW9uX3N0YXRlID0gTmV0d29ya0Nvbm5lY3Rpb25TdGF0ZTo6U2h1dHRpbmdEb3duOwogICAgfQoKICAgIC8vLyBBZHZhbmNlcyB0aGUgc3RhdGUuCiAgICAvLy8KICAgIC8vLyBFdmVudCBob29rcyBpbnZva2VkIGV4dGVybmFsbHkgbWF5IHRyaWdnZXIgYSBuZXcgW2BQZWVyQWN0aW9uYF0gdGhhdCBhcmUgYnVmZmVyZWQgdW50aWwKICAgIC8vLyBbYFBlZXJzTWFuYWdlcmBdIGlzIHBvbGxlZC4KICAgIHB1YiBmbiBwb2xsKCZtdXQgc2VsZiwgY3g6ICZtdXQgQ29udGV4dDwnXz4pIC0+IFBvbGw8UGVlckFjdGlvbj4gewogICAgICAgIGxvb3AgewogICAgICAgICAgICAvLyBkcmFpbiBidWZmZXJlZCBhY3Rpb25zCiAgICAgICAgICAgIGlmIGxldCBTb21lKGFjdGlvbikgPSBzZWxmLnF1ZXVlZF9hY3Rpb25zLnBvcF9mcm9udCgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQb2xsOjpSZWFkeShhY3Rpb24pCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIGxldCBQb2xsOjpSZWFkeShTb21lKGNtZCkpID0gc2VsZi5oYW5kbGVfcngucG9sbF9uZXh0X3VucGluKGN4KSB7CiAgICAgICAgICAgICAgICBtYXRjaCBjbWQgewogICAgICAgICAgICAgICAgICAgIFBlZXJDb21tYW5kOjpBZGQocGVlcl9pZCwgYWRkcikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZF9wZWVyKHBlZXJfaWQsIFBlZXJBZGRyOjpmcm9tX3RjcChhZGRyKSwgTm9uZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIFBlZXJDb21tYW5kOjpSZW1vdmUocGVlcikgPT4gc2VsZi5yZW1vdmVfcGVlcihwZWVyKSwKICAgICAgICAgICAgICAgICAgICBQZWVyQ29tbWFuZDo6UmVwdXRhdGlvbkNoYW5nZShwZWVyX2lkLCByZXApID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hcHBseV9yZXB1dGF0aW9uX2NoYW5nZSgmcGVlcl9pZCwgcmVwKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBQZWVyQ29tbWFuZDo6R2V0UGVlcihwZWVyLCB0eCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgXyA9IHR4LnNlbmQoc2VsZi5wZWVycy5nZXQoJnBlZXIpLmNsb25lZCgpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgUGVlckNvbW1hbmQ6OkdldFBlZXJzKHR4KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBfID0gdHguc2VuZChzZWxmLml0ZXJfcGVlcnMoKS5jb2xsZWN0KCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgc2VsZi5yZWxlYXNlX2ludGVydmFsLnBvbGxfdGljayhjeCkuaXNfcmVhZHkoKSB7CiAgICAgICAgICAgICAgICBsZXQgbm93ID0gc3RkOjp0aW1lOjpJbnN0YW50Ojpub3coKTsKICAgICAgICAgICAgICAgIGxldCAoXywgdW5iYW5uZWRfcGVlcnMpID0gc2VsZi5iYW5fbGlzdC5ldmljdChub3cpOwoKICAgICAgICAgICAgICAgIGZvciBwZWVyX2lkIGluIHVuYmFubmVkX3BlZXJzIHsKICAgICAgICAgICAgICAgICAgICBpZiBsZXQgU29tZShwZWVyKSA9IHNlbGYucGVlcnMuZ2V0X211dCgmcGVlcl9pZCkgewogICAgICAgICAgICAgICAgICAgICAgICBwZWVyLnVuYmFuKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucXVldWVkX2FjdGlvbnMucHVzaF9iYWNrKFBlZXJBY3Rpb246OlVuQmFuUGVlciB7IHBlZXJfaWQgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGNsZWFyIHRoZSBiYWNrb2ZmIGxpc3Qgb2YgZXhwaXJlZCBiYWNrb2ZmcywgYW5kIG1hcmsgdGhlIHJlbGV2YW50IHBlZXJzIGFzCiAgICAgICAgICAgICAgICAvLyByZWFkeSB0byBiZSBkaWFsZWQKICAgICAgICAgICAgICAgIHNlbGYuYmFja2VkX29mZl9wZWVycy5yZXRhaW4ofHBlZXJfaWQsIHVudGlsfCB7CiAgICAgICAgICAgICAgICAgICAgaWYgbm93ID4gKnVudGlsIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUocGVlcikgPSBzZWxmLnBlZXJzLmdldF9tdXQocGVlcl9pZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVlci5iYWNrZWRfb2ZmID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIHNlbGYucmVmaWxsX3Nsb3RzX2ludGVydmFsLnBvbGxfdGljayhjeCkuaXNfcmVhZHkoKSB7CiAgICAgICAgICAgICAgICBzZWxmLmZpbGxfb3V0Ym91bmRfc2xvdHMoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgbGV0IFBvbGw6OlJlYWR5KChwZWVyX2lkLCBuZXdfcmVjb3JkKSkgPSBzZWxmLnRydXN0ZWRfcGVlcnNfcmVzb2x2ZXIucG9sbChjeCkgewogICAgICAgICAgICAgICAgc2VsZi5vbl9yZXNvbHZlZF9wZWVyKHBlZXJfaWQsIG5ld19yZWNvcmQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiBzZWxmLnF1ZXVlZF9hY3Rpb25zLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlBlbmRpbmcKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKaW1wbCBEZWZhdWx0IGZvciBQZWVyc01hbmFnZXIgewogICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgIFNlbGY6Om5ldyhEZWZhdWx0OjpkZWZhdWx0KCkpCiAgICB9Cn0KCi8vLyBUcmFja3Mgc3RhdHMgYWJvdXQgY29ubmVjdGVkIG5vZGVzCiNbZGVyaXZlKERlYnVnLCBDbG9uZSwgUGFydGlhbEVxLCBFcSwgRGVmYXVsdCldCnB1YiBzdHJ1Y3QgQ29ubmVjdGlvbkluZm8gewogICAgLy8vIENvdW50ZXIgZm9yIGN1cnJlbnRseSBvY2N1cGllZCBzbG90cyBmb3IgYWN0aXZlIG91dGJvdW5kIGNvbm5lY3Rpb25zLgogICAgbnVtX291dGJvdW5kOiB1c2l6ZSwKICAgIC8vLyBDb3VudGVyIGZvciBwZW5kaW5nIG91dGJvdW5kIGNvbm5lY3Rpb25zLgogICAgbnVtX3BlbmRpbmdfb3V0OiB1c2l6ZSwKICAgIC8vLyBDb3VudGVyIGZvciBjdXJyZW50bHkgb2NjdXBpZWQgc2xvdHMgZm9yIGFjdGl2ZSBpbmJvdW5kIGNvbm5lY3Rpb25zLgogICAgbnVtX2luYm91bmQ6IHVzaXplLAogICAgLy8vIENvdW50ZXIgZm9yIHBlbmRpbmcgaW5ib3VuZCBjb25uZWN0aW9ucy4KICAgIG51bV9wZW5kaW5nX2luOiB1c2l6ZSwKICAgIC8vLyBSZXN0cmljdGlvbnMgb24gbnVtYmVyIG9mIGNvbm5lY3Rpb25zLgogICAgY29uZmlnOiBDb25uZWN0aW9uc0NvbmZpZywKfQoKLy8gPT09IGltcGwgQ29ubmVjdGlvbkluZm8gPT09CgppbXBsIENvbm5lY3Rpb25JbmZvIHsKICAgIC8vLyBSZXR1cm5zIGEgbmV3IFtgQ29ubmVjdGlvbkluZm9gXSB3aXRoIHRoZSBnaXZlbiBjb25maWcuCiAgICBjb25zdCBmbiBuZXcoY29uZmlnOiBDb25uZWN0aW9uc0NvbmZpZykgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGNvbmZpZywgbnVtX291dGJvdW5kOiAwLCBudW1fcGVuZGluZ19vdXQ6IDAsIG51bV9pbmJvdW5kOiAwLCBudW1fcGVuZGluZ19pbjogMCB9CiAgICB9CgogICAgLy8vICBSZXR1cm5zIGB0cnVlYCBpZiB0aGVyZSdzIHN0aWxsIGNhcGFjaXR5IHRvIHBlcmZvcm0gYW4gb3V0Z29pbmcgY29ubmVjdGlvbi4KICAgIGNvbnN0IGZuIGhhc19vdXRfY2FwYWNpdHkoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIHNlbGYubnVtX3BlbmRpbmdfb3V0IDwgc2VsZi5jb25maWcubWF4X2NvbmN1cnJlbnRfb3V0Ym91bmRfZGlhbHMgJiYKICAgICAgICAgICAgc2VsZi5udW1fb3V0Ym91bmQgPCBzZWxmLmNvbmZpZy5tYXhfb3V0Ym91bmQKICAgIH0KCiAgICAvLy8gIFJldHVybnMgYHRydWVgIGlmIHRoZXJlJ3Mgc3RpbGwgY2FwYWNpdHkgdG8gYWNjZXB0IGEgbmV3IGluY29taW5nIGNvbm5lY3Rpb24uCiAgICBjb25zdCBmbiBoYXNfaW5fY2FwYWNpdHkoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIHNlbGYubnVtX2luYm91bmQgPCBzZWxmLmNvbmZpZy5tYXhfaW5ib3VuZAogICAgfQoKICAgIC8vLyBSZXR1cm5zIGB0cnVlYCBpZiB3ZSBjYW4gaGFuZGxlIGFuIGFkZGl0aW9uYWwgaW5jb21pbmcgcGVuZGluZyBjb25uZWN0aW9uLgogICAgY29uc3QgZm4gaGFzX2luX3BlbmRpbmdfY2FwYWNpdHkoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIHNlbGYubnVtX3BlbmRpbmdfaW4gPCBzZWxmLmNvbmZpZy5tYXhfaW5ib3VuZAogICAgfQoKICAgIGNvbnN0IGZuIGRlY3Jfc3RhdGUoJm11dCBzZWxmLCBzdGF0ZTogUGVlckNvbm5lY3Rpb25TdGF0ZSkgewogICAgICAgIG1hdGNoIHN0YXRlIHsKICAgICAgICAgICAgUGVlckNvbm5lY3Rpb25TdGF0ZTo6SWRsZSA9PiB7fQogICAgICAgICAgICBQZWVyQ29ubmVjdGlvblN0YXRlOjpEaXNjb25uZWN0aW5nSW4gfCBQZWVyQ29ubmVjdGlvblN0YXRlOjpJbiA9PiBzZWxmLmRlY3JfaW4oKSwKICAgICAgICAgICAgUGVlckNvbm5lY3Rpb25TdGF0ZTo6RGlzY29ubmVjdGluZ091dCB8IFBlZXJDb25uZWN0aW9uU3RhdGU6Ok91dCA9PiBzZWxmLmRlY3Jfb3V0KCksCiAgICAgICAgICAgIFBlZXJDb25uZWN0aW9uU3RhdGU6OlBlbmRpbmdPdXQgPT4gc2VsZi5kZWNyX3BlbmRpbmdfb3V0KCksCiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IGZuIGRlY3Jfb3V0KCZtdXQgc2VsZikgewogICAgICAgIHNlbGYubnVtX291dGJvdW5kIC09IDE7CiAgICB9CgogICAgY29uc3QgZm4gaW5jX291dCgmbXV0IHNlbGYpIHsKICAgICAgICBzZWxmLm51bV9vdXRib3VuZCArPSAxOwogICAgfQoKICAgIGNvbnN0IGZuIGluY19wZW5kaW5nX291dCgmbXV0IHNlbGYpIHsKICAgICAgICBzZWxmLm51bV9wZW5kaW5nX291dCArPSAxOwogICAgfQoKICAgIGNvbnN0IGZuIGluY19pbigmbXV0IHNlbGYpIHsKICAgICAgICBzZWxmLm51bV9pbmJvdW5kICs9IDE7CiAgICB9CgogICAgY29uc3QgZm4gaW5jX3BlbmRpbmdfaW4oJm11dCBzZWxmKSB7CiAgICAgICAgc2VsZi5udW1fcGVuZGluZ19pbiArPSAxOwogICAgfQoKICAgIGNvbnN0IGZuIGRlY3JfaW4oJm11dCBzZWxmKSB7CiAgICAgICAgc2VsZi5udW1faW5ib3VuZCAtPSAxOwogICAgfQoKICAgIGNvbnN0IGZuIGRlY3JfcGVuZGluZ19vdXQoJm11dCBzZWxmKSB7CiAgICAgICAgc2VsZi5udW1fcGVuZGluZ19vdXQgLT0gMTsKICAgIH0KCiAgICBjb25zdCBmbiBkZWNyX3BlbmRpbmdfaW4oJm11dCBzZWxmKSB7CiAgICAgICAgc2VsZi5udW1fcGVuZGluZ19pbiAtPSAxOwogICAgfQp9CgovLy8gQWN0aW9ucyB0aGUgcGVlciBtYW5hZ2VyIGNhbiB0cmlnZ2VyLgojW2Rlcml2ZShEZWJ1ZyldCnB1YiBlbnVtIFBlZXJBY3Rpb24gewogICAgLy8vIFN0YXJ0IGEgbmV3IGNvbm5lY3Rpb24gdG8gYSBwZWVyLgogICAgQ29ubmVjdCB7CiAgICAgICAgLy8vIFRoZSBwZWVyIHRvIGNvbm5lY3QgdG8uCiAgICAgICAgcGVlcl9pZDogUGVlcklkLAogICAgICAgIC8vLyBXaGVyZSB0byByZWFjaCB0aGUgbm9kZQogICAgICAgIHJlbW90ZV9hZGRyOiBTb2NrZXRBZGRyLAogICAgfSwKICAgIC8vLyBEaXNjb25uZWN0IGFuIGV4aXN0aW5nIGNvbm5lY3Rpb24uCiAgICBEaXNjb25uZWN0IHsKICAgICAgICAvLy8gVGhlIHBlZXIgSUQgb2YgdGhlIGVzdGFibGlzaGVkIGNvbm5lY3Rpb24uCiAgICAgICAgcGVlcl9pZDogUGVlcklkLAogICAgICAgIC8vLyBBbiBvcHRpb25hbCByZWFzb24gZm9yIHRoZSBkaXNjb25uZWN0LgogICAgICAgIHJlYXNvbjogT3B0aW9uPERpc2Nvbm5lY3RSZWFzb24+LAogICAgfSwKICAgIC8vLyBEaXNjb25uZWN0IGFuIGV4aXN0aW5nIGluY29taW5nIGNvbm5lY3Rpb24sIGJlY2F1c2UgdGhlIHBlZXJzIHJlcHV0YXRpb24gaXMgYmVsb3cgdGhlCiAgICAvLy8gYmFubmVkIHRocmVzaG9sZCBvciBpcyBvbiB0aGUgW2BCYW5MaXN0YF0KICAgIERpc2Nvbm5lY3RCYW5uZWRJbmNvbWluZyB7CiAgICAgICAgLy8vIFRoZSBwZWVyIElEIG9mIHRoZSBlc3RhYmxpc2hlZCBjb25uZWN0aW9uLgogICAgICAgIHBlZXJfaWQ6IFBlZXJJZCwKICAgIH0sCiAgICAvLy8gRGlzY29ubmVjdCBhbiB1bnRydXN0ZWQgaW5jb21pbmcgY29ubmVjdGlvbiB3aGVuIHRydXN0LW5vZGUtb25seSBpcyBlbmFibGVkLgogICAgRGlzY29ubmVjdFVudHJ1c3RlZEluY29taW5nIHsKICAgICAgICAvLy8gVGhlIHBlZXIgSUQuCiAgICAgICAgcGVlcl9pZDogUGVlcklkLAogICAgfSwKICAgIC8vLyBCYW4gdGhlIHBlZXIgaW4gZGlzY292ZXJ5LgogICAgRGlzY292ZXJ5QmFuUGVlcklkIHsKICAgICAgICAvLy8gVGhlIHBlZXIgSUQuCiAgICAgICAgcGVlcl9pZDogUGVlcklkLAogICAgICAgIC8vLyBUaGUgSVAgYWRkcmVzcy4KICAgICAgICBpcF9hZGRyOiBJcEFkZHIsCiAgICB9LAogICAgLy8vIEJhbiB0aGUgSVAgaW4gZGlzY292ZXJ5LgogICAgRGlzY292ZXJ5QmFuSXAgewogICAgICAgIC8vLyBUaGUgSVAgYWRkcmVzcy4KICAgICAgICBpcF9hZGRyOiBJcEFkZHIsCiAgICB9LAogICAgLy8vIEJhbiB0aGUgcGVlciB0ZW1wb3JhcmlseQogICAgQmFuUGVlciB7CiAgICAgICAgLy8vIFRoZSBwZWVyIElELgogICAgICAgIHBlZXJfaWQ6IFBlZXJJZCwKICAgIH0sCiAgICAvLy8gVW5iYW4gdGhlIHBlZXIgdGVtcG9yYXJpbHkKICAgIFVuQmFuUGVlciB7CiAgICAgICAgLy8vIFRoZSBwZWVyIElELgogICAgICAgIHBlZXJfaWQ6IFBlZXJJZCwKICAgIH0sCiAgICAvLy8gRW1pdCBwZWVyQWRkZWQgZXZlbnQKICAgIFBlZXJBZGRlZChQZWVySWQpLAogICAgLy8vIEVtaXQgcGVlclJlbW92ZWQgZXZlbnQKICAgIFBlZXJSZW1vdmVkKFBlZXJJZCksCn0KCi8vLyBFcnJvciB0aHJvd24gd2hlbiBhbiBpbmNvbWluZyBjb25uZWN0aW9uIGlzIHJlamVjdGVkIHJpZ2h0IGF3YXkKI1tkZXJpdmUoRGVidWcsIEVycm9yLCBQYXJ0aWFsRXEsIEVxKV0KcHViIGVudW0gSW5ib3VuZENvbm5lY3Rpb25FcnJvciB7CiAgICAvLy8gVGhlIHJlbW90ZSdzIGlwIGFkZHJlc3MgaXMgYmFubmVkCiAgICBJcEJhbm5lZCwKICAgIC8vLyBObyBjYXBhY2l0eSBmb3IgbmV3IGluYm91bmQgY29ubmVjdGlvbnMKICAgIEV4Y2VlZHNDYXBhY2l0eSwKfQoKaW1wbCBEaXNwbGF5IGZvciBJbmJvdW5kQ29ubmVjdGlvbkVycm9yIHsKICAgIGZuIGZtdCgmc2VsZiwgZjogJm11dCBzdGQ6OmZtdDo6Rm9ybWF0dGVyPCdfPikgLT4gc3RkOjpmbXQ6OlJlc3VsdCB7CiAgICAgICAgd3JpdGUhKGYsICJ7c2VsZjo/fSIpCiAgICB9Cn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdHMgewogICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkI1MTI7CiAgICB1c2UgcmV0aF9ldGhfd2lyZTo6ewogICAgICAgIGVycm9yczo6e0V0aEhhbmRzaGFrZUVycm9yLCBFdGhTdHJlYW1FcnJvciwgUDJQSGFuZHNoYWtlRXJyb3IsIFAyUFN0cmVhbUVycm9yfSwKICAgICAgICBEaXNjb25uZWN0UmVhc29uLAogICAgfTsKICAgIHVzZSByZXRoX25ldF9iYW5saXN0OjpCYW5MaXN0OwogICAgdXNlIHJldGhfbmV0d29ya19hcGk6OkRpcmVjdGlvbjsKICAgIHVzZSByZXRoX25ldHdvcmtfcGVlcnM6OntQZWVySWQsIFRydXN0ZWRQZWVyfTsKICAgIHVzZSByZXRoX25ldHdvcmtfdHlwZXM6OnsKICAgICAgICBwZWVyczo6cmVwdXRhdGlvbjo6REVGQVVMVF9SRVBVVEFUSU9OLCBCYWNrb2ZmS2luZCwgUGVlciwgUmVwdXRhdGlvbkNoYW5nZUtpbmQsCiAgICB9OwogICAgdXNlIHN0ZDo6ewogICAgICAgIGZ1dHVyZTo6e3BvbGxfZm4sIEZ1dHVyZX0sCiAgICAgICAgaW8sCiAgICAgICAgbmV0Ojp7SXBBZGRyLCBJcHY0QWRkciwgU29ja2V0QWRkcn0sCiAgICAgICAgcGluOjpQaW4sCiAgICAgICAgdGFzazo6e0NvbnRleHQsIFBvbGx9LAogICAgICAgIHRpbWU6OkR1cmF0aW9uLAogICAgfTsKICAgIHVzZSB1cmw6Okhvc3Q7CgogICAgdXNlIHN1cGVyOjpQZWVyc01hbmFnZXI7CiAgICB1c2UgY3JhdGU6OnsKICAgICAgICBlcnJvcjo6U2Vzc2lvbkVycm9yLAogICAgICAgIHBlZXJzOjp7CiAgICAgICAgICAgIENvbm5lY3Rpb25JbmZvLCBJbmJvdW5kQ29ubmVjdGlvbkVycm9yLCBQZWVyQWN0aW9uLCBQZWVyQWRkciwgUGVlckJhY2tvZmZEdXJhdGlvbnMsCiAgICAgICAgICAgIFBlZXJDb25uZWN0aW9uU3RhdGUsCiAgICAgICAgfSwKICAgICAgICBzZXNzaW9uOjpQZW5kaW5nU2Vzc2lvbkhhbmRzaGFrZUVycm9yLAogICAgICAgIFBlZXJzQ29uZmlnLAogICAgfTsKCiAgICBzdHJ1Y3QgUGVlckFjdGlvbkZ1dHVyZTwnYT4gewogICAgICAgIHBlZXJzOiAmJ2EgbXV0IFBlZXJzTWFuYWdlciwKICAgIH0KCiAgICBpbXBsIEZ1dHVyZSBmb3IgUGVlckFjdGlvbkZ1dHVyZTwnXz4gewogICAgICAgIHR5cGUgT3V0cHV0ID0gUGVlckFjdGlvbjsKCiAgICAgICAgZm4gcG9sbChzZWxmOiBQaW48Jm11dCBTZWxmPiwgY3g6ICZtdXQgQ29udGV4dDwnXz4pIC0+IFBvbGw8U2VsZjo6T3V0cHV0PiB7CiAgICAgICAgICAgIHNlbGYuZ2V0X211dCgpLnBlZXJzLnBvbGwoY3gpCiAgICAgICAgfQogICAgfQoKICAgIG1hY3JvX3J1bGVzISBldmVudCB7CiAgICAgICAgKCRwZWVyczpleHByKSA9PiB7CiAgICAgICAgICAgIFBlZXJBY3Rpb25GdXR1cmUgeyBwZWVyczogJm11dCAkcGVlcnMgfS5hd2FpdAogICAgICAgIH07CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfaW5zZXJ0KCkgewogICAgICAgIGxldCBwZWVyID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgc29ja2V0X2FkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLCA4MDA4KTsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpkZWZhdWx0KCk7CiAgICAgICAgcGVlcnMuYWRkX3BlZXIocGVlciwgUGVlckFkZHI6OmZyb21fdGNwKHNvY2tldF9hZGRyKSwgTm9uZSk7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpQZWVyQWRkZWQocGVlcl9pZCkgPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6Q29ubmVjdCB7IHBlZXJfaWQsIHJlbW90ZV9hZGRyIH0gPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocmVtb3RlX2FkZHIsIHNvY2tldF9hZGRyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgbGV0IChyZWNvcmQsIF8pID0gcGVlcnMucGVlcl9ieV9pZChwZWVyKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHJlY29yZC50Y3BfYWRkcigpLCBzb2NrZXRfYWRkcik7CiAgICAgICAgYXNzZXJ0X2VxIShyZWNvcmQudWRwX2FkZHIoKSwgc29ja2V0X2FkZHIpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2luc2VydF91ZHAoKSB7CiAgICAgICAgbGV0IHBlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCB0Y3BfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDgpOwogICAgICAgIGxldCB1ZHBfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDkpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6OmRlZmF1bHQoKTsKICAgICAgICBwZWVycy5hZGRfcGVlcihwZWVyLCBQZWVyQWRkcjo6bmV3KHRjcF9hZGRyLCBTb21lKHVkcF9hZGRyKSksIE5vbmUpOwoKICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6UGVlckFkZGVkKHBlZXJfaWQpID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyBwZWVyX2lkLCByZW1vdGVfYWRkciB9ID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHJlbW90ZV9hZGRyLCB0Y3BfYWRkcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIGxldCAocmVjb3JkLCBfKSA9IHBlZXJzLnBlZXJfYnlfaWQocGVlcikudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShyZWNvcmQudGNwX2FkZHIoKSwgdGNwX2FkZHIpOwogICAgICAgIGFzc2VydF9lcSEocmVjb3JkLnVkcF9hZGRyKCksIHVkcF9hZGRyKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9iYW4oKSB7CiAgICAgICAgbGV0IHBlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCBzb2NrZXRfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDgpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6OmRlZmF1bHQoKTsKICAgICAgICBwZWVycy5iYW5fcGVlcihwZWVyKTsKICAgICAgICBwZWVycy5hZGRfcGVlcihwZWVyLCBQZWVyQWRkcjo6ZnJvbV90Y3Aoc29ja2V0X2FkZHIpLCBOb25lKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkJhblBlZXIgeyBwZWVyX2lkIH0gPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgcG9sbF9mbih8Y3h8IHsKICAgICAgICAgICAgYXNzZXJ0IShwZWVycy5wb2xsKGN4KS5pc19wZW5kaW5nKCkpOwogICAgICAgICAgICBQb2xsOjpSZWFkeSgoKSkKICAgICAgICB9KQogICAgICAgIC5hd2FpdDsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF91bmJhbigpIHsKICAgICAgICBsZXQgcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6ZGVmYXVsdCgpOwogICAgICAgIHBlZXJzLmJhbl9wZWVyKHBlZXIpOwogICAgICAgIHBlZXJzLmFkZF9wZWVyKHBlZXIsIFBlZXJBZGRyOjpmcm9tX3RjcChzb2NrZXRfYWRkciksIE5vbmUpOwoKICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6QmFuUGVlciB7IHBlZXJfaWQgfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICBwb2xsX2ZuKHxjeHwgewogICAgICAgICAgICBhc3NlcnQhKHBlZXJzLnBvbGwoY3gpLmlzX3BlbmRpbmcoKSk7CiAgICAgICAgICAgIFBvbGw6OlJlYWR5KCgpKQogICAgICAgIH0pCiAgICAgICAgLmF3YWl0OwoKICAgICAgICBwZWVycy51bmJhbl9wZWVyKHBlZXIpOwoKICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6VW5CYW5QZWVyIHsgcGVlcl9pZCB9ID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIHBvbGxfZm4ofGN4fCB7CiAgICAgICAgICAgIGFzc2VydCEocGVlcnMucG9sbChjeCkuaXNfcGVuZGluZygpKTsKICAgICAgICAgICAgUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgfSkKICAgICAgICAuYXdhaXQ7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfYmFja29mZl9vbl9idXN5KCkgewogICAgICAgIGxldCBwZWVyID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgc29ja2V0X2FkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLCA4MDA4KTsKCiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6bmV3KFBlZXJzQ29uZmlnOjp0ZXN0KCkpOwogICAgICAgIHBlZXJzLmFkZF9wZWVyKHBlZXIsIFBlZXJBZGRyOjpmcm9tX3RjcChzb2NrZXRfYWRkciksIE5vbmUpOwoKICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6UGVlckFkZGVkKHBlZXJfaWQpID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyBwZWVyX2lkLCAuLiB9ID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIHBvbGxfZm4ofGN4fCB7CiAgICAgICAgICAgIGFzc2VydCEocGVlcnMucG9sbChjeCkuaXNfcGVuZGluZygpKTsKICAgICAgICAgICAgUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgfSkKICAgICAgICAuYXdhaXQ7CgogICAgICAgIHBlZXJzLm9uX2FjdGl2ZV9zZXNzaW9uX2Ryb3BwZWQoCiAgICAgICAgICAgICZzb2NrZXRfYWRkciwKICAgICAgICAgICAgJnBlZXIsCiAgICAgICAgICAgICZFdGhTdHJlYW1FcnJvcjo6UDJQU3RyZWFtRXJyb3IoUDJQU3RyZWFtRXJyb3I6OkRpc2Nvbm5lY3RlZCgKICAgICAgICAgICAgICAgIERpc2Nvbm5lY3RSZWFzb246OlRvb01hbnlQZWVycywKICAgICAgICAgICAgKSksCiAgICAgICAgKTsKCiAgICAgICAgcG9sbF9mbih8Y3h8IHsKICAgICAgICAgICAgYXNzZXJ0IShwZWVycy5wb2xsKGN4KS5pc19wZW5kaW5nKCkpOwogICAgICAgICAgICBQb2xsOjpSZWFkeSgoKSkKICAgICAgICB9KQogICAgICAgIC5hd2FpdDsKCiAgICAgICAgYXNzZXJ0IShwZWVycy5iYWNrZWRfb2ZmX3BlZXJzLmNvbnRhaW5zX2tleSgmcGVlcikpOwogICAgICAgIGFzc2VydCEocGVlcnMucGVlcnMuZ2V0KCZwZWVyKS51bndyYXAoKS5pc19iYWNrZWRfb2ZmKCkpOwoKICAgICAgICB0b2tpbzo6dGltZTo6c2xlZXAocGVlcnMuYmFja29mZl9kdXJhdGlvbnMubG93KS5hd2FpdDsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyBwZWVyX2lkLCAuLiB9ID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIGFzc2VydCEoIXBlZXJzLmJhY2tlZF9vZmZfcGVlcnMuY29udGFpbnNfa2V5KCZwZWVyKSk7CiAgICAgICAgYXNzZXJ0ISghcGVlcnMucGVlcnMuZ2V0KCZwZWVyKS51bndyYXAoKS5pc19iYWNrZWRfb2ZmKCkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2JhY2tvZmZfb25fbm9fcmVzcG9uc2UoKSB7CiAgICAgICAgbGV0IHBlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCBzb2NrZXRfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDgpOwoKICAgICAgICBsZXQgYmFja29mZl9kdXJhdGlvbnMgPSBQZWVyQmFja29mZkR1cmF0aW9uczo6dGVzdCgpOwogICAgICAgIGxldCBjb25maWcgPSBQZWVyc0NvbmZpZyB7IGJhY2tvZmZfZHVyYXRpb25zLCAuLlBlZXJzQ29uZmlnOjp0ZXN0KCkgfTsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpuZXcoY29uZmlnKTsKICAgICAgICBwZWVycy5hZGRfcGVlcihwZWVyLCBQZWVyQWRkcjo6ZnJvbV90Y3Aoc29ja2V0X2FkZHIpLCBOb25lKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJBZGRlZChwZWVyX2lkKSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpDb25uZWN0IHsgcGVlcl9pZCwgLi4gfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICBwb2xsX2ZuKHxjeHwgewogICAgICAgICAgICBhc3NlcnQhKHBlZXJzLnBvbGwoY3gpLmlzX3BlbmRpbmcoKSk7CiAgICAgICAgICAgIFBvbGw6OlJlYWR5KCgpKQogICAgICAgIH0pCiAgICAgICAgLmF3YWl0OwoKICAgICAgICBwZWVycy5vbl9vdXRnb2luZ19wZW5kaW5nX3Nlc3Npb25fZHJvcHBlZCgKICAgICAgICAgICAgJnNvY2tldF9hZGRyLAogICAgICAgICAgICAmcGVlciwKICAgICAgICAgICAgJlBlbmRpbmdTZXNzaW9uSGFuZHNoYWtlRXJyb3I6OkV0aChFdGhTdHJlYW1FcnJvcjo6RXRoSGFuZHNoYWtlRXJyb3IoCiAgICAgICAgICAgICAgICBFdGhIYW5kc2hha2VFcnJvcjo6Tm9SZXNwb25zZSwKICAgICAgICAgICAgKSksCiAgICAgICAgKTsKCiAgICAgICAgcG9sbF9mbih8Y3h8IHsKICAgICAgICAgICAgYXNzZXJ0IShwZWVycy5wb2xsKGN4KS5pc19wZW5kaW5nKCkpOwogICAgICAgICAgICBQb2xsOjpSZWFkeSgoKSkKICAgICAgICB9KQogICAgICAgIC5hd2FpdDsKCiAgICAgICAgYXNzZXJ0IShwZWVycy5iYWNrZWRfb2ZmX3BlZXJzLmNvbnRhaW5zX2tleSgmcGVlcikpOwogICAgICAgIGFzc2VydCEocGVlcnMucGVlcnMuZ2V0KCZwZWVyKS51bndyYXAoKS5pc19iYWNrZWRfb2ZmKCkpOwoKICAgICAgICB0b2tpbzo6dGltZTo6c2xlZXAoYmFja29mZl9kdXJhdGlvbnMuaGlnaCkuYXdhaXQ7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpDb25uZWN0IHsgcGVlcl9pZCwgLi4gfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICBhc3NlcnQhKCFwZWVycy5iYWNrZWRfb2ZmX3BlZXJzLmNvbnRhaW5zX2tleSgmcGVlcikpOwogICAgICAgIGFzc2VydCEoIXBlZXJzLnBlZXJzLmdldCgmcGVlcikudW53cmFwKCkuaXNfYmFja2VkX29mZigpKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9sb3dfYmFja29mZigpIHsKICAgICAgICBsZXQgcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOCk7CiAgICAgICAgbGV0IGNvbmZpZyA9IFBlZXJzQ29uZmlnOjp0ZXN0KCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6bmV3KGNvbmZpZyk7CiAgICAgICAgcGVlcnMuYWRkX3BlZXIocGVlciwgUGVlckFkZHI6OmZyb21fdGNwKHNvY2tldF9hZGRyKSwgTm9uZSk7CiAgICAgICAgbGV0IHBlZXJfc3RydWN0ID0gcGVlcnMucGVlcnMuZ2V0X211dCgmcGVlcikudW53cmFwKCk7CgogICAgICAgIGxldCBiYWNrb2ZmX3RpbWVzdGFtcCA9IHBlZXJzCiAgICAgICAgICAgIC5iYWNrb2ZmX2R1cmF0aW9ucwogICAgICAgICAgICAuYmFja29mZl91bnRpbChCYWNrb2ZmS2luZDo6TG93LCBwZWVyX3N0cnVjdC5zZXZlcmVfYmFja29mZl9jb3VudGVyKTsKCiAgICAgICAgbGV0IGV4cGVjdGVkID0gc3RkOjp0aW1lOjpJbnN0YW50Ojpub3coKSArIHBlZXJzLmJhY2tvZmZfZHVyYXRpb25zLmxvdzsKICAgICAgICBhc3NlcnQhKGJhY2tvZmZfdGltZXN0YW1wIDw9IGV4cGVjdGVkKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9tdWx0aXBsZV9iYWNrb2ZmX2NhbGN1bGF0aW9ucygpIHsKICAgICAgICBsZXQgcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOCk7CiAgICAgICAgbGV0IGNvbmZpZyA9IFBlZXJzQ29uZmlnOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6bmV3KGNvbmZpZyk7CiAgICAgICAgcGVlcnMuYWRkX3BlZXIocGVlciwgUGVlckFkZHI6OmZyb21fdGNwKHNvY2tldF9hZGRyKSwgTm9uZSk7CiAgICAgICAgbGV0IHBlZXJfc3RydWN0ID0gcGVlcnMucGVlcnMuZ2V0X211dCgmcGVlcikudW53cmFwKCk7CgogICAgICAgIC8vIFNpbXVsYXRlIGEgcGVlciB0aGF0IHdhcyBhbHJlYWR5IGJhY2tlZCBvZmYgb25jZQogICAgICAgIHBlZXJfc3RydWN0LnNldmVyZV9iYWNrb2ZmX2NvdW50ZXIgPSAxOwoKICAgICAgICBsZXQgbm93ID0gc3RkOjp0aW1lOjpJbnN0YW50Ojpub3coKTsKCiAgICAgICAgLy8gU2ltdWxhdGUgdGhlIGluY3JlbWVudCB0aGF0IGhhcHBlbnMgaW4gb25fY29ubmVjdGlvbl9mYWlsdXJlCiAgICAgICAgcGVlcl9zdHJ1Y3Quc2V2ZXJlX2JhY2tvZmZfY291bnRlciArPSAxOwogICAgICAgIC8vIEdldCBvZmZpY2lhbCBiYWNrb2ZmIHRpbWUKICAgICAgICBsZXQgYmFja29mZl90aW1lID0gcGVlcnMKICAgICAgICAgICAgLmJhY2tvZmZfZHVyYXRpb25zCiAgICAgICAgICAgIC5iYWNrb2ZmX3VudGlsKEJhY2tvZmZLaW5kOjpIaWdoLCBwZWVyX3N0cnVjdC5zZXZlcmVfYmFja29mZl9jb3VudGVyKTsKCiAgICAgICAgLy8gRHVyYXRpb24gb2YgdGhlIGJhY2tvZmYgc2hvdWxkIGJlIDIgKiAxNSBtaW51dGVzID0gMzAgbWludXRlcwogICAgICAgIGxldCBiYWNrb2ZmX2R1cmF0aW9uID0gc3RkOjp0aW1lOjpEdXJhdGlvbjo6bmV3KDMwICogNjAsIDApOwoKICAgICAgICAvLyBXZSBjYW4ndCB1c2UgYXNzZXJ0X2VxISBzaW5jZSB0aGVyZSBpcyBhIHZlcnkgc21hbGwgZGlmZiBpbiB0aGUgbmFubyBzZWNzCiAgICAgICAgLy8gVXN1YWxseSBpdCBpcyAxODAwcyAhPSAxNzk5Ljk5OTk5OTZzCiAgICAgICAgYXNzZXJ0IShiYWNrb2ZmX3RpbWUuZHVyYXRpb25fc2luY2Uobm93KSA+IGJhY2tvZmZfZHVyYXRpb24pOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2Jhbl9vbl9hY3RpdmVfZHJvcCgpIHsKICAgICAgICBsZXQgcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6ZGVmYXVsdCgpOwogICAgICAgIHBlZXJzLmFkZF9wZWVyKHBlZXIsIFBlZXJBZGRyOjpmcm9tX3RjcChzb2NrZXRfYWRkciksIE5vbmUpOwoKICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6UGVlckFkZGVkKHBlZXJfaWQpID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyBwZWVyX2lkLCAuLiB9ID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIHBvbGxfZm4ofGN4fCB7CiAgICAgICAgICAgIGFzc2VydCEocGVlcnMucG9sbChjeCkuaXNfcGVuZGluZygpKTsKICAgICAgICAgICAgUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgfSkKICAgICAgICAuYXdhaXQ7CgogICAgICAgIHBlZXJzLm9uX2FjdGl2ZV9zZXNzaW9uX2Ryb3BwZWQoCiAgICAgICAgICAgICZzb2NrZXRfYWRkciwKICAgICAgICAgICAgJnBlZXIsCiAgICAgICAgICAgICZFdGhTdHJlYW1FcnJvcjo6UDJQU3RyZWFtRXJyb3IoUDJQU3RyZWFtRXJyb3I6OkRpc2Nvbm5lY3RlZCgKICAgICAgICAgICAgICAgIERpc2Nvbm5lY3RSZWFzb246OlVzZWxlc3NQZWVyLAogICAgICAgICAgICApKSwKICAgICAgICApOwoKICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6UGVlclJlbW92ZWQocGVlcl9pZCkgPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6QmFuUGVlciB7IHBlZXJfaWQgfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICBwb2xsX2ZuKHxjeHwgewogICAgICAgICAgICBhc3NlcnQhKHBlZXJzLnBvbGwoY3gpLmlzX3BlbmRpbmcoKSk7CiAgICAgICAgICAgIFBvbGw6OlJlYWR5KCgpKQogICAgICAgIH0pCiAgICAgICAgLmF3YWl0OwoKICAgICAgICBhc3NlcnQhKCFwZWVycy5wZWVycy5jb250YWluc19rZXkoJnBlZXIpKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9yZW1vdmVfb25fbWF4X2JhY2tvZmZfY291bnQoKSB7CiAgICAgICAgbGV0IHBlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCBzb2NrZXRfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDgpOwogICAgICAgIGxldCBjb25maWcgPSBQZWVyc0NvbmZpZzo6dGVzdCgpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6Om5ldyhjb25maWcuY2xvbmUoKSk7CiAgICAgICAgcGVlcnMuYWRkX3BlZXIocGVlciwgUGVlckFkZHI6OmZyb21fdGNwKHNvY2tldF9hZGRyKSwgTm9uZSk7CiAgICAgICAgbGV0IHBlZXJfc3RydWN0ID0gcGVlcnMucGVlcnMuZ2V0X211dCgmcGVlcikudW53cmFwKCk7CgogICAgICAgIC8vIFNpbXVsYXRlIGEgcGVlciB0aGF0IHdhcyBhbHJlYWR5IGJhY2tlZCBvZmYgb25jZQogICAgICAgIHBlZXJfc3RydWN0LnNldmVyZV9iYWNrb2ZmX2NvdW50ZXIgPSBjb25maWcubWF4X2JhY2tvZmZfY291bnQ7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpQZWVyQWRkZWQocGVlcl9pZCkgPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6Q29ubmVjdCB7IHBlZXJfaWQsIC4uIH0gPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgcG9sbF9mbih8Y3h8IHsKICAgICAgICAgICAgYXNzZXJ0IShwZWVycy5wb2xsKGN4KS5pc19wZW5kaW5nKCkpOwogICAgICAgICAgICBQb2xsOjpSZWFkeSgoKSkKICAgICAgICB9KQogICAgICAgIC5hd2FpdDsKCiAgICAgICAgcGVlcnMub25fb3V0Z29pbmdfcGVuZGluZ19zZXNzaW9uX2Ryb3BwZWQoCiAgICAgICAgICAgICZzb2NrZXRfYWRkciwKICAgICAgICAgICAgJnBlZXIsCiAgICAgICAgICAgICZQZW5kaW5nU2Vzc2lvbkhhbmRzaGFrZUVycm9yOjpFdGgoCiAgICAgICAgICAgICAgICBpbzo6RXJyb3I6Om5ldyhpbzo6RXJyb3JLaW5kOjpDb25uZWN0aW9uUmVmdXNlZCwgInBlZXIgdW5yZWFjaGFibGUiKS5pbnRvKCksCiAgICAgICAgICAgICksCiAgICAgICAgKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJSZW1vdmVkKHBlZXJfaWQpID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIHBvbGxfZm4ofGN4fCB7CiAgICAgICAgICAgIGFzc2VydCEocGVlcnMucG9sbChjeCkuaXNfcGVuZGluZygpKTsKICAgICAgICAgICAgUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgfSkKICAgICAgICAuYXdhaXQ7CgogICAgICAgIGFzc2VydCEoIXBlZXJzLnBlZXJzLmNvbnRhaW5zX2tleSgmcGVlcikpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2Jhbl9vbl9wZW5kaW5nX2Ryb3AoKSB7CiAgICAgICAgbGV0IHBlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCBzb2NrZXRfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDgpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6OmRlZmF1bHQoKTsKICAgICAgICBwZWVycy5hZGRfcGVlcihwZWVyLCBQZWVyQWRkcjo6ZnJvbV90Y3Aoc29ja2V0X2FkZHIpLCBOb25lKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJBZGRlZChwZWVyX2lkKSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpDb25uZWN0IHsgcGVlcl9pZCwgLi4gfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICBwb2xsX2ZuKHxjeHwgewogICAgICAgICAgICBhc3NlcnQhKHBlZXJzLnBvbGwoY3gpLmlzX3BlbmRpbmcoKSk7CiAgICAgICAgICAgIFBvbGw6OlJlYWR5KCgpKQogICAgICAgIH0pCiAgICAgICAgLmF3YWl0OwoKICAgICAgICBwZWVycy5vbl9vdXRnb2luZ19wZW5kaW5nX3Nlc3Npb25fZHJvcHBlZCgKICAgICAgICAgICAgJnNvY2tldF9hZGRyLAogICAgICAgICAgICAmcGVlciwKICAgICAgICAgICAgJlBlbmRpbmdTZXNzaW9uSGFuZHNoYWtlRXJyb3I6OkV0aChFdGhTdHJlYW1FcnJvcjo6UDJQU3RyZWFtRXJyb3IoCiAgICAgICAgICAgICAgICBQMlBTdHJlYW1FcnJvcjo6RGlzY29ubmVjdGVkKERpc2Nvbm5lY3RSZWFzb246OlVzZWxlc3NQZWVyKSwKICAgICAgICAgICAgKSksCiAgICAgICAgKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJSZW1vdmVkKHBlZXJfaWQpID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkJhblBlZXIgeyBwZWVyX2lkIH0gPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgcG9sbF9mbih8Y3h8IHsKICAgICAgICAgICAgYXNzZXJ0IShwZWVycy5wb2xsKGN4KS5pc19wZW5kaW5nKCkpOwogICAgICAgICAgICBQb2xsOjpSZWFkeSgoKSkKICAgICAgICB9KQogICAgICAgIC5hd2FpdDsKCiAgICAgICAgYXNzZXJ0ISghcGVlcnMucGVlcnMuY29udGFpbnNfa2V5KCZwZWVyKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfaW50ZXJuYWxseV9jbG9zZWRfaW5jb21pbmcoKSB7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6ZGVmYXVsdCgpOwoKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihzb2NrZXRfYWRkci5pcCgpKS5pc19vaygpKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMSk7CiAgICAgICAgcGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uX3JlamVjdGVkX2ludGVybmFsbHkoKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMCk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfcmVqZWN0X2luY29taW5nX2F0X3BlbmRpbmdfY2FwYWNpdHkoKSB7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6ZGVmYXVsdCgpOwoKICAgICAgICBmb3IgY291bnQgaW4gMS4uPXBlZXJzLmNvbm5lY3Rpb25faW5mby5jb25maWcubWF4X2luYm91bmQgewogICAgICAgICAgICBsZXQgc29ja2V0X2FkZHIgPQogICAgICAgICAgICAgICAgU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIGNvdW50IGFzIHU4KSksIDgwMDgpOwogICAgICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihzb2NrZXRfYWRkci5pcCgpKS5pc19vaygpKTsKICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfaW4sIGNvdW50KTsKICAgICAgICB9CiAgICAgICAgYXNzZXJ0IShwZWVycy5jb25uZWN0aW9uX2luZm8uaGFzX2luX2NhcGFjaXR5KCkpOwogICAgICAgIGFzc2VydCEoIXBlZXJzLmNvbm5lY3Rpb25faW5mby5oYXNfaW5fcGVuZGluZ19jYXBhY2l0eSgpKTsKCiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDEwMCkpLCA4MDA4KTsKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihzb2NrZXRfYWRkci5pcCgpKS5pc19lcnIoKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfcmVqZWN0X2luY29taW5nX2F0X3BlbmRpbmdfY2FwYWNpdHlfdHJ1c3RlZF9wZWVycygpIHsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpuZXcoUGVlcnNDb25maWc6OnRlc3QoKS53aXRoX21heF9pbmJvdW5kKDIpKTsKICAgICAgICBsZXQgdHJ1c3RlZCA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgcGVlcnMuYWRkX3RydXN0ZWRfcGVlcl9pZCh0cnVzdGVkKTsKCiAgICAgICAgLy8gY29ubmVjdCB0aGUgdHJ1c3RlZCBwZWVyCiAgICAgICAgbGV0IGFkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMCkpLCA4MDA4KTsKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihhZGRyLmlwKCkpLmlzX29rKCkpOwogICAgICAgIHBlZXJzLm9uX2luY29taW5nX3Nlc3Npb25fZXN0YWJsaXNoZWQodHJ1c3RlZCwgYWRkcik7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpQZWVyQWRkZWQoaWQpID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEoaWQsIHRydXN0ZWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICAvLyBzYXR1cmF0ZSB0aGUgcmVtYWluaW5nIGluYm91bmQgc2xvdHMgd2l0aCB1bnRydXN0ZWQgcGVlcnMKICAgICAgICBsZXQgbXV0IGNvbm5lY3RlZF91bnRydXN0ZWRfcGVlcl9pZHMgPSBWZWM6Om5ldygpOwogICAgICAgIGZvciBpIGluIDAuLihwZWVycy5jb25uZWN0aW9uX2luZm8uY29uZmlnLm1heF9pbmJvdW5kIC0gMSkgewogICAgICAgICAgICBsZXQgYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAoaSArIDEpIGFzIHU4KSksIDgwMDgpOwogICAgICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihhZGRyLmlwKCkpLmlzX29rKCkpOwogICAgICAgICAgICBsZXQgcGVlcl9pZCA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgICAgIHBlZXJzLm9uX2luY29taW5nX3Nlc3Npb25fZXN0YWJsaXNoZWQocGVlcl9pZCwgYWRkcik7CiAgICAgICAgICAgIGNvbm5lY3RlZF91bnRydXN0ZWRfcGVlcl9pZHMucHVzaChwZWVyX2lkKTsKCiAgICAgICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICAgICAgUGVlckFjdGlvbjo6UGVlckFkZGVkKGlkKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShpZCwgcGVlcl9pZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXQgbXV0IHBlbmRpbmdfYWRkcnMgPSBWZWM6Om5ldygpOwoKICAgICAgICAvLyBzYXR1cmF0ZSBhdmFpbGFibGUgc2xvdHMKICAgICAgICBmb3IgaSBpbiAwLi4yIHsKICAgICAgICAgICAgbGV0IHNvY2tldF9hZGRyID0KICAgICAgICAgICAgICAgIFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAoaSArIDEwKSBhcyB1OCkpLCA4MDA4KTsKICAgICAgICAgICAgYXNzZXJ0IShwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oc29ja2V0X2FkZHIuaXAoKSkuaXNfb2soKSk7CgogICAgICAgICAgICBwZW5kaW5nX2FkZHJzLnB1c2goc29ja2V0X2FkZHIpOwogICAgICAgIH0KCiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfaW4sIDIpOwoKICAgICAgICAvLyB0cnkgdG8gaGFuZGxlIGFkZGl0aW9uYWwgaW5jb21pbmcgY29ubmVjdGlvbnMgYXQgY2FwYWNpdHkKICAgICAgICBmb3IgaSBpbiAwLi4yIHsKICAgICAgICAgICAgbGV0IHNvY2tldF9hZGRyID0KICAgICAgICAgICAgICAgIFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAoaSArIDIwKSBhcyB1OCkpLCA4MDA4KTsKICAgICAgICAgICAgYXNzZXJ0IShwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oc29ja2V0X2FkZHIuaXAoKSkuaXNfZXJyKCkpOwogICAgICAgIH0KCiAgICAgICAgbGV0IGVyciA9IFBlbmRpbmdTZXNzaW9uSGFuZHNoYWtlRXJyb3I6OkV0aChFdGhTdHJlYW1FcnJvcjo6UDJQU3RyZWFtRXJyb3IoCiAgICAgICAgICAgIFAyUFN0cmVhbUVycm9yOjpIYW5kc2hha2VFcnJvcihQMlBIYW5kc2hha2VFcnJvcjo6RGlzY29ubmVjdGVkKAogICAgICAgICAgICAgICAgRGlzY29ubmVjdFJlYXNvbjo6VXNlbGVzc1BlZXIsCiAgICAgICAgICAgICkpLAogICAgICAgICkpOwoKICAgICAgICAvLyBSZW1vdmUgYWxsIHBlbmRpbmcgcGVlcnMKICAgICAgICBmb3IgcGVuZGluZ19hZGRyIGluIHBlbmRpbmdfYWRkcnMgewogICAgICAgICAgICBwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb25fZHJvcHBlZChwZW5kaW5nX2FkZHIsICZlcnIpOwogICAgICAgIH0KCiAgICAgICAgcHJpbnRsbiEoIm51bV9wZW5kaW5nX2luOiB7fSIsIHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbik7CgogICAgICAgIHByaW50bG4hKAogICAgICAgICAgICAibnVtX2luYm91bmQ6IHt9LCBoYXNfaW5fY2FwYWNpdHk6IHt9IiwKICAgICAgICAgICAgcGVlcnMuY29ubmVjdGlvbl9pbmZvLm51bV9pbmJvdW5kLAogICAgICAgICAgICBwZWVycy5jb25uZWN0aW9uX2luZm8uaGFzX2luX2NhcGFjaXR5KCkKICAgICAgICApOwoKICAgICAgICAvLyBkaXNjb25uZWN0IGEgY29ubmVjdGVkIHBlZXIKICAgICAgICBwZWVycy5vbl9hY3RpdmVfc2Vzc2lvbl9ncmFjZWZ1bGx5X2Nsb3NlZChjb25uZWN0ZWRfdW50cnVzdGVkX3BlZXJfaWRzWzBdKTsKCiAgICAgICAgcHJpbnRsbiEoCiAgICAgICAgICAgICJudW1faW5ib3VuZDoge30sIGhhc19pbl9jYXBhY2l0eToge30iLAogICAgICAgICAgICBwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX2luYm91bmQsCiAgICAgICAgICAgIHBlZXJzLmNvbm5lY3Rpb25faW5mby5oYXNfaW5fY2FwYWNpdHkoKQogICAgICAgICk7CgogICAgICAgIGxldCBzb2NrZXRfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCA5OSkpLCA4MDA4KTsKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihzb2NrZXRfYWRkci5pcCgpKS5pc19vaygpKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9jbG9zZWRfaW5jb21pbmcoKSB7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6ZGVmYXVsdCgpOwoKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihzb2NrZXRfYWRkci5pcCgpKS5pc19vaygpKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMSk7CiAgICAgICAgcGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uX2dyYWNlZnVsbHlfY2xvc2VkKCk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfaW4sIDApOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2Ryb3BwZWRfaW5jb21pbmcoKSB7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxLCAwLCAxLCAyKSksIDgwMDgpOwogICAgICAgIGxldCBiYW5fZHVyYXRpb24gPSBEdXJhdGlvbjo6ZnJvbV9taWxsaXMoNTAwKTsKICAgICAgICBsZXQgY29uZmlnID0gUGVlcnNDb25maWcgeyBiYW5fZHVyYXRpb24sIC4uUGVlcnNDb25maWc6OnRlc3QoKSB9OwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6Om5ldyhjb25maWcpOwoKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihzb2NrZXRfYWRkci5pcCgpKS5pc19vaygpKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMSk7CiAgICAgICAgbGV0IGVyciA9IFBlbmRpbmdTZXNzaW9uSGFuZHNoYWtlRXJyb3I6OkV0aChFdGhTdHJlYW1FcnJvcjo6UDJQU3RyZWFtRXJyb3IoCiAgICAgICAgICAgIFAyUFN0cmVhbUVycm9yOjpIYW5kc2hha2VFcnJvcihQMlBIYW5kc2hha2VFcnJvcjo6RGlzY29ubmVjdGVkKAogICAgICAgICAgICAgICAgRGlzY29ubmVjdFJlYXNvbjo6VXNlbGVzc1BlZXIsCiAgICAgICAgICAgICkpLAogICAgICAgICkpOwoKICAgICAgICBwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb25fZHJvcHBlZChzb2NrZXRfYWRkciwgJmVycik7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfaW4sIDApOwogICAgICAgIGFzc2VydCEocGVlcnMuYmFuX2xpc3QuaXNfYmFubmVkX2lwKCZzb2NrZXRfYWRkci5pcCgpKSk7CgogICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKHNvY2tldF9hZGRyLmlwKCkpLmlzX2VycigpKTsKCiAgICAgICAgLy8gdW5iYW5uZWQgYWZ0ZXIgdGltZW91dAogICAgICAgIHRva2lvOjp0aW1lOjpzbGVlcChiYW5fZHVyYXRpb24pLmF3YWl0OwoKICAgICAgICBwb2xsX2ZuKHxjeHwgewogICAgICAgICAgICBsZXQgXyA9IHBlZXJzLnBvbGwoY3gpOwogICAgICAgICAgICBQb2xsOjpSZWFkeSgoKSkKICAgICAgICB9KQogICAgICAgIC5hd2FpdDsKCiAgICAgICAgYXNzZXJ0ISghcGVlcnMuYmFuX2xpc3QuaXNfYmFubmVkX2lwKCZzb2NrZXRfYWRkci5pcCgpKSk7CiAgICAgICAgYXNzZXJ0IShwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oc29ja2V0X2FkZHIuaXAoKSkuaXNfb2soKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfcmVwdXRhdGlvbl9jaGFuZ2VfY29ubmVjdGVkKCkgewogICAgICAgIGxldCBwZWVyID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgc29ja2V0X2FkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLCA4MDA4KTsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpkZWZhdWx0KCk7CiAgICAgICAgcGVlcnMuYWRkX3BlZXIocGVlciwgUGVlckFkZHI6OmZyb21fdGNwKHNvY2tldF9hZGRyKSwgTm9uZSk7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpQZWVyQWRkZWQocGVlcl9pZCkgPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6Q29ubmVjdCB7IHBlZXJfaWQsIHJlbW90ZV9hZGRyIH0gPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocmVtb3RlX2FkZHIsIHNvY2tldF9hZGRyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgbGV0IHAgPSBwZWVycy5wZWVycy5nZXRfbXV0KCZwZWVyKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHAuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OlBlbmRpbmdPdXQpOwoKICAgICAgICBwZWVycy5hcHBseV9yZXB1dGF0aW9uX2NoYW5nZSgmcGVlciwgUmVwdXRhdGlvbkNoYW5nZUtpbmQ6OkJhZFByb3RvY29sKTsKCiAgICAgICAgbGV0IHAgPSBwZWVycy5wZWVycy5nZXQoJnBlZXIpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEocC5zdGF0ZSwgUGVlckNvbm5lY3Rpb25TdGF0ZTo6UGVuZGluZ091dCk7CiAgICAgICAgYXNzZXJ0IShwLmlzX2Jhbm5lZCgpKTsKCiAgICAgICAgcGVlcnMub25fYWN0aXZlX3Nlc3Npb25fZ3JhY2VmdWxseV9jbG9zZWQocGVlcik7CgogICAgICAgIGxldCBwID0gcGVlcnMucGVlcnMuZ2V0KCZwZWVyKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHAuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OklkbGUpOwogICAgICAgIGFzc2VydCEocC5pc19iYW5uZWQoKSk7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpEaXNjb25uZWN0IHsgcGVlcl9pZCwgLi4gfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiByZXRhaW5fdHJ1c3RlZF9zdGF0dXMoKSB7CiAgICAgICAgbGV0IF9zb2NrZXRfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCA5OSkpLCA4MDA4KTsKICAgICAgICBsZXQgdHJ1c3RlZCA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9CiAgICAgICAgICAgIFBlZXJzTWFuYWdlcjo6bmV3KFBlZXJzQ29uZmlnOjp0ZXN0KCkud2l0aF90cnVzdGVkX25vZGVzKHZlYyFbVHJ1c3RlZFBlZXIgewogICAgICAgICAgICAgICAgaG9zdDogSG9zdDo6SXB2NChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLAogICAgICAgICAgICAgICAgdGNwX3BvcnQ6IDgwMDgsCiAgICAgICAgICAgICAgICB1ZHBfcG9ydDogODAwOCwKICAgICAgICAgICAgICAgIGlkOiB0cnVzdGVkLAogICAgICAgICAgICB9XSkpOwogICAgICAgIGxldCBzb2NrZXRfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDgpOwogICAgICAgIHBlZXJzLmFkZF9wZWVyKHRydXN0ZWQsIFBlZXJBZGRyOjpmcm9tX3RjcChzb2NrZXRfYWRkciksIE5vbmUpOwogICAgICAgIGFzc2VydCEocGVlcnMucGVlcnMuZ2V0KCZ0cnVzdGVkKS51bndyYXAoKS5pc190cnVzdGVkKCkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBhY2NlcHRfaW5jb21pbmdfdHJ1c3RlZF91bmtub3duX3BlZXJfYWRkcmVzcygpIHsKICAgICAgICBsZXQgc29ja2V0X2FkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgOTkpKSwgODAwOCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6bmV3KFBlZXJzQ29uZmlnOjp0ZXN0KCkud2l0aF9tYXhfaW5ib3VuZCgyKSk7CiAgICAgICAgLy8gdHJ5IHRvIGNvbm5lY3QgdHJ1c3RlZCBwZWVyCiAgICAgICAgbGV0IHRydXN0ZWQgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIHBlZXJzLmFkZF90cnVzdGVkX3BlZXJfaWQodHJ1c3RlZCk7CgogICAgICAgIC8vIHNhdHVyYXRlIHRoZSBpbmJvdW5kIHNsb3RzCiAgICAgICAgZm9yIGkgaW4gMC4ucGVlcnMuY29ubmVjdGlvbl9pbmZvLmNvbmZpZy5tYXhfaW5ib3VuZCB7CiAgICAgICAgICAgIGxldCBhZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIGkgYXMgdTgpKSwgODAwOCk7CiAgICAgICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKHNvY2tldF9hZGRyLmlwKCkpLmlzX29rKCkpOwogICAgICAgICAgICBsZXQgcGVlcl9pZCA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgICAgIHBlZXJzLm9uX2luY29taW5nX3Nlc3Npb25fZXN0YWJsaXNoZWQocGVlcl9pZCwgYWRkcik7CgogICAgICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJBZGRlZChpZCkgPT4gewogICAgICAgICAgICAgICAgICAgIGFzc2VydF9lcSEoaWQsIHBlZXJfaWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gdHJ5IHRvIGNvbm5lY3QgdW50cnVzdGVkIHBlZXIKICAgICAgICBsZXQgdW50cnVzdGVkID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgc29ja2V0X2FkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgOTkpKSwgODAwOCk7CiAgICAgICAgYXNzZXJ0IShwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oc29ja2V0X2FkZHIuaXAoKSkuaXNfb2soKSk7CiAgICAgICAgcGVlcnMub25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZCh1bnRydXN0ZWQsIHNvY2tldF9hZGRyKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJBZGRlZChpZCkgPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShpZCwgdW50cnVzdGVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkRpc2Nvbm5lY3QgeyBwZWVyX2lkLCByZWFzb24gfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHVudHJ1c3RlZCk7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHJlYXNvbiwgU29tZShEaXNjb25uZWN0UmVhc29uOjpUb29NYW55UGVlcnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDEwMCkpLCA4MDA4KTsKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihzb2NrZXRfYWRkci5pcCgpKS5pc19vaygpKTsKICAgICAgICBwZWVycy5vbl9pbmNvbWluZ19zZXNzaW9uX2VzdGFibGlzaGVkKHRydXN0ZWQsIHNvY2tldF9hZGRyKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJBZGRlZChpZCkgPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShpZCwgdHJ1c3RlZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIHBvbGxfZm4ofGN4fCB7CiAgICAgICAgICAgIGFzc2VydCEocGVlcnMucG9sbChjeCkuaXNfcGVuZGluZygpKTsKICAgICAgICAgICAgUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgfSkKICAgICAgICAuYXdhaXQ7CgogICAgICAgIGxldCBwZWVyID0gcGVlcnMucGVlcnMuZ2V0KCZ0cnVzdGVkKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXIuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OkluKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9hbHJlYWR5X2Nvbm5lY3RlZCgpIHsKICAgICAgICBsZXQgcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6ZGVmYXVsdCgpOwoKICAgICAgICAvLyBBdHRlbXB0IHRvIGVzdGFibGlzaCBhbiBpbmNvbWluZyBzZXNzaW9uLCBleHBlY3RpbmcgYG51bV9wZW5kaW5nX2luYCB0byBpbmNyZWFzZSBieSAxCiAgICAgICAgYXNzZXJ0IShwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oc29ja2V0X2FkZHIuaXAoKSkuaXNfb2soKSk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfaW4sIDEpOwoKICAgICAgICAvLyBFc3RhYmxpc2ggYSBzZXNzaW9uIHdpdGggdGhlIHBlZXIsIGV4cGVjdGluZyB0aGUgcGVlciB0byBiZSBhZGRlZCBhbmQgdGhlIGBudW1faW5ib3VuZGAKICAgICAgICAvLyB0byBpbmNyZWFzZSBieSAxCiAgICAgICAgcGVlcnMub25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZChwZWVyLCBzb2NrZXRfYWRkcik7CiAgICAgICAgbGV0IHAgPSBwZWVycy5wZWVycy5nZXRfbXV0KCZwZWVyKS5leHBlY3QoInBlZXIgbm90IGZvdW5kIik7CiAgICAgICAgYXNzZXJ0X2VxIShwLmFkZHIudGNwKCksIHNvY2tldF9hZGRyKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMCk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX2luYm91bmQsIDEpOwoKICAgICAgICAvLyBBdHRlbXB0IHRvIGVzdGFibGlzaCBhbm90aGVyIGluY29taW5nIHNlc3Npb24sIGV4cGVjdGluZyB0aGUgYG51bV9wZW5kaW5nX2luYCB0byBpbmNyZWFzZQogICAgICAgIC8vIGJ5IDEKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihzb2NrZXRfYWRkci5pcCgpKS5pc19vaygpKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMSk7CgogICAgICAgIC8vIFNpbXVsYXRlIGEgcmVqZWN0aW9uIGR1ZSB0byBhbiBhbHJlYWR5IGVzdGFibGlzaGVkIGNvbm5lY3Rpb24sIGV4cGVjdGluZyB0aGUKICAgICAgICAvLyBgbnVtX3BlbmRpbmdfaW5gIHRvIGRlY3JlYXNlIGJ5IDEuIFRoZSBwZWVyIHNob3VsZCByZW1haW4gY29ubmVjdGVkIGFuZCB0aGUgYG51bV9pbmJvdW5kYAogICAgICAgIC8vIHNob3VsZCBub3QgYmUgY2hhbmdlZC4KICAgICAgICBwZWVycy5vbl9hbHJlYWR5X2Nvbm5lY3RlZChEaXJlY3Rpb246OkluY29taW5nKTsKCiAgICAgICAgbGV0IHAgPSBwZWVycy5wZWVycy5nZXRfbXV0KCZwZWVyKS5leHBlY3QoInBlZXIgbm90IGZvdW5kIik7CiAgICAgICAgYXNzZXJ0X2VxIShwLmFkZHIudGNwKCksIHNvY2tldF9hZGRyKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMCk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX2luYm91bmQsIDEpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X3JlcHV0YXRpb25fY2hhbmdlX3RydXN0ZWRfcGVlcigpIHsKICAgICAgICBsZXQgcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6ZGVmYXVsdCgpOwogICAgICAgIHBlZXJzLmFkZF90cnVzdGVkX3BlZXIocGVlciwgUGVlckFkZHI6OmZyb21fdGNwKHNvY2tldF9hZGRyKSk7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpQZWVyQWRkZWQocGVlcl9pZCkgPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6Q29ubmVjdCB7IHBlZXJfaWQsIHJlbW90ZV9hZGRyIH0gPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocmVtb3RlX2FkZHIsIHNvY2tldF9hZGRyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5wZWVycy5nZXRfbXV0KCZwZWVyKS51bndyYXAoKS5zdGF0ZSwgUGVlckNvbm5lY3Rpb25TdGF0ZTo6UGVuZGluZ091dCk7CiAgICAgICAgcGVlcnMub25fYWN0aXZlX291dGdvaW5nX2VzdGFibGlzaGVkKHBlZXIpOwogICAgICAgIGFzc2VydF9lcSEocGVlcnMucGVlcnMuZ2V0X211dCgmcGVlcikudW53cmFwKCkuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6Ok91dCk7CgogICAgICAgIHBlZXJzLmFwcGx5X3JlcHV0YXRpb25fY2hhbmdlKCZwZWVyLCBSZXB1dGF0aW9uQ2hhbmdlS2luZDo6QmFkTWVzc2FnZSk7CgogICAgICAgIHsKICAgICAgICAgICAgbGV0IHAgPSBwZWVycy5wZWVycy5nZXQoJnBlZXIpLnVud3JhcCgpOwogICAgICAgICAgICBhc3NlcnRfZXEhKHAuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6Ok91dCk7CiAgICAgICAgICAgIC8vIG5vdCBiYW5uZWQgeWV0CiAgICAgICAgICAgIGFzc2VydCEoIXAuaXNfYmFubmVkKCkpOwogICAgICAgIH0KCiAgICAgICAgLy8gZW5zdXJlIHBlZXIgaXMgYmFubmVkIGV2ZW50dWFsbHkKICAgICAgICBsb29wIHsKICAgICAgICAgICAgcGVlcnMuYXBwbHlfcmVwdXRhdGlvbl9jaGFuZ2UoJnBlZXIsIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpCYWRNZXNzYWdlKTsKCiAgICAgICAgICAgIGxldCBwID0gcGVlcnMucGVlcnMuZ2V0KCZwZWVyKS51bndyYXAoKTsKICAgICAgICAgICAgaWYgcC5pc19iYW5uZWQoKSB7CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6RGlzY29ubmVjdCB7IHBlZXJfaWQsIC4uIH0gPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9yZXB1dGF0aW9uX21hbmFnZW1lbnQoKSB7CiAgICAgICAgbGV0IHBlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCBzb2NrZXRfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDgpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6OmRlZmF1bHQoKTsKICAgICAgICBwZWVycy5hZGRfcGVlcihwZWVyLCBQZWVyQWRkcjo6ZnJvbV90Y3Aoc29ja2V0X2FkZHIpLCBOb25lKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmdldF9yZXB1dGF0aW9uKCZwZWVyKSwgU29tZSgwKSk7CgogICAgICAgIHBlZXJzLmFwcGx5X3JlcHV0YXRpb25fY2hhbmdlKCZwZWVyLCBSZXB1dGF0aW9uQ2hhbmdlS2luZDo6T3RoZXIoMTAyNCkpOwogICAgICAgIGFzc2VydF9lcSEocGVlcnMuZ2V0X3JlcHV0YXRpb24oJnBlZXIpLCBTb21lKDEwMjQpKTsKCiAgICAgICAgcGVlcnMuYXBwbHlfcmVwdXRhdGlvbl9jaGFuZ2UoJnBlZXIsIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpSZXNldCk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5nZXRfcmVwdXRhdGlvbigmcGVlciksIFNvbWUoMCkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X3JlbW92ZV9kaXNjb3ZlcmVkX2FjdGl2ZSgpIHsKICAgICAgICBsZXQgcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6ZGVmYXVsdCgpOwogICAgICAgIHBlZXJzLmFkZF9wZWVyKHBlZXIsIFBlZXJBZGRyOjpmcm9tX3RjcChzb2NrZXRfYWRkciksIE5vbmUpOwoKICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6UGVlckFkZGVkKHBlZXJfaWQpID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyBwZWVyX2lkLCByZW1vdGVfYWRkciB9ID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHJlbW90ZV9hZGRyLCBzb2NrZXRfYWRkcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIGxldCBwID0gcGVlcnMucGVlcnMuZ2V0KCZwZWVyKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHAuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OlBlbmRpbmdPdXQpOwoKICAgICAgICBwZWVycy5yZW1vdmVfcGVlcihwZWVyKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJSZW1vdmVkKHBlZXJfaWQpID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkRpc2Nvbm5lY3QgeyBwZWVyX2lkLCAuLiB9ID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIGxldCBwID0gcGVlcnMucGVlcnMuZ2V0KCZwZWVyKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHAuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OlBlbmRpbmdPdXQpOwoKICAgICAgICBwZWVycy5hZGRfcGVlcihwZWVyLCBQZWVyQWRkcjo6ZnJvbV90Y3Aoc29ja2V0X2FkZHIpLCBOb25lKTsKICAgICAgICBsZXQgcCA9IHBlZXJzLnBlZXJzLmdldCgmcGVlcikudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShwLnN0YXRlLCBQZWVyQ29ubmVjdGlvblN0YXRlOjpQZW5kaW5nT3V0KTsKCiAgICAgICAgcGVlcnMub25fYWN0aXZlX3Nlc3Npb25fZ3JhY2VmdWxseV9jbG9zZWQocGVlcik7CiAgICAgICAgYXNzZXJ0ISghcGVlcnMucGVlcnMuY29udGFpbnNfa2V5KCZwZWVyKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfZmF0YWxfb3V0Z29pbmdfY29ubmVjdGlvbl9lcnJvcl90cnVzdGVkKCkgewogICAgICAgIGxldCBwZWVyID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgY29uZmlnID0gUGVlcnNDb25maWc6OnRlc3QoKQogICAgICAgICAgICAud2l0aF90cnVzdGVkX25vZGVzKHZlYyFbVHJ1c3RlZFBlZXIgewogICAgICAgICAgICAgICAgaG9zdDogSG9zdDo6SXB2NChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLAogICAgICAgICAgICAgICAgdGNwX3BvcnQ6IDgwMDgsCiAgICAgICAgICAgICAgICB1ZHBfcG9ydDogODAwOCwKICAgICAgICAgICAgICAgIGlkOiBwZWVyLAogICAgICAgICAgICB9XSkKICAgICAgICAgICAgLndpdGhfdHJ1c3RlZF9ub2Rlc19vbmx5KHRydWUpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6Om5ldyhjb25maWcpOwogICAgICAgIGxldCBzb2NrZXRfYWRkciA9IHBlZXJzLnBlZXJzLmdldCgmcGVlcikudW53cmFwKCkuYWRkci50Y3AoKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyBwZWVyX2lkLCByZW1vdGVfYWRkciB9ID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHJlbW90ZV9hZGRyLCBzb2NrZXRfYWRkcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIGxldCBwID0gcGVlcnMucGVlcnMuZ2V0KCZwZWVyKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHAuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OlBlbmRpbmdPdXQpOwoKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLm51bV9vdXRib3VuZF9jb25uZWN0aW9ucygpLCAwKTsKCiAgICAgICAgbGV0IGVyciA9IFBlbmRpbmdTZXNzaW9uSGFuZHNoYWtlRXJyb3I6OkV0aChFdGhTdHJlYW1FcnJvcjo6RXRoSGFuZHNoYWtlRXJyb3IoCiAgICAgICAgICAgIEV0aEhhbmRzaGFrZUVycm9yOjpOb25TdGF0dXNNZXNzYWdlSW5IYW5kc2hha2UsCiAgICAgICAgKSk7CiAgICAgICAgYXNzZXJ0IShlcnIuaXNfZmF0YWxfcHJvdG9jb2xfZXJyb3IoKSk7CgogICAgICAgIHBlZXJzLm9uX291dGdvaW5nX3BlbmRpbmdfc2Vzc2lvbl9kcm9wcGVkKCZzb2NrZXRfYWRkciwgJnBlZXIsICZlcnIpOwogICAgICAgIGFzc2VydF9lcSEocGVlcnMubnVtX291dGJvdW5kX2Nvbm5lY3Rpb25zKCksIDApOwoKICAgICAgICAvLyB0cnkgdG1wIGJhbiBwZWVyCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkJhblBlZXIgeyBwZWVyX2lkIH0gPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlcnIgPT4gdW5yZWFjaGFibGUhKCJ7ZXJyOj99IiksCiAgICAgICAgfQoKICAgICAgICAvLyBlbnN1cmUgd2Ugc3RpbGwgaGF2ZSB0cnVzdGVkIHBlZXIKICAgICAgICBhc3NlcnQhKHBlZXJzLnBlZXJzLmNvbnRhaW5zX2tleSgmcGVlcikpOwoKICAgICAgICAvLyBhd2FpdCBmb3IgdGhlIGJhbiB0byBleHBpcmUKICAgICAgICB0b2tpbzo6dGltZTo6c2xlZXAocGVlcnMuYmFja29mZl9kdXJhdGlvbnMubWVkaXVtKS5hd2FpdDsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyBwZWVyX2lkLCByZW1vdGVfYWRkciB9ID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHJlbW90ZV9hZGRyLCBzb2NrZXRfYWRkcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXJyID0+IHVucmVhY2hhYmxlISgie2Vycjo/fSIpLAogICAgICAgIH0KICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9vdXRnb2luZ19jb25uZWN0aW9uX2Vycm9yKCkgewogICAgICAgIGxldCBwZWVyID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgc29ja2V0X2FkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLCA4MDA4KTsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpkZWZhdWx0KCk7CiAgICAgICAgcGVlcnMuYWRkX3BlZXIocGVlciwgUGVlckFkZHI6OmZyb21fdGNwKHNvY2tldF9hZGRyKSwgTm9uZSk7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpQZWVyQWRkZWQocGVlcl9pZCkgPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6Q29ubmVjdCB7IHBlZXJfaWQsIHJlbW90ZV9hZGRyIH0gPT4gewogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocmVtb3RlX2FkZHIsIHNvY2tldF9hZGRyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgbGV0IHAgPSBwZWVycy5wZWVycy5nZXQoJnBlZXIpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEocC5zdGF0ZSwgUGVlckNvbm5lY3Rpb25TdGF0ZTo6UGVuZGluZ091dCk7CgogICAgICAgIGFzc2VydF9lcSEocGVlcnMubnVtX291dGJvdW5kX2Nvbm5lY3Rpb25zKCksIDApOwoKICAgICAgICBwZWVycy5vbl9vdXRnb2luZ19jb25uZWN0aW9uX2ZhaWx1cmUoCiAgICAgICAgICAgICZzb2NrZXRfYWRkciwKICAgICAgICAgICAgJnBlZXIsCiAgICAgICAgICAgICZpbzo6RXJyb3I6Om5ldyhpbzo6RXJyb3JLaW5kOjpDb25uZWN0aW9uUmVmdXNlZCwgIiIpLAogICAgICAgICk7CgogICAgICAgIGFzc2VydF9lcSEocGVlcnMubnVtX291dGJvdW5kX2Nvbm5lY3Rpb25zKCksIDApOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X291dGdvaW5nX2Nvbm5lY3Rpb25fZ3JhY2VmdWxseV9jbG9zZWQoKSB7CiAgICAgICAgbGV0IHBlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCBzb2NrZXRfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDgpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6OmRlZmF1bHQoKTsKICAgICAgICBwZWVycy5hZGRfcGVlcihwZWVyLCBQZWVyQWRkcjo6ZnJvbV90Y3Aoc29ja2V0X2FkZHIpLCBOb25lKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJBZGRlZChwZWVyX2lkKSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpDb25uZWN0IHsgcGVlcl9pZCwgcmVtb3RlX2FkZHIgfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShyZW1vdGVfYWRkciwgc29ja2V0X2FkZHIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICBsZXQgcCA9IHBlZXJzLnBlZXJzLmdldCgmcGVlcikudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShwLnN0YXRlLCBQZWVyQ29ubmVjdGlvblN0YXRlOjpQZW5kaW5nT3V0KTsKCiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5udW1fb3V0Ym91bmRfY29ubmVjdGlvbnMoKSwgMCk7CgogICAgICAgIHBlZXJzLm9uX291dGdvaW5nX3BlbmRpbmdfc2Vzc2lvbl9ncmFjZWZ1bGx5X2Nsb3NlZCgmcGVlcik7CgogICAgICAgIGFzc2VydF9lcSEocGVlcnMubnVtX291dGJvdW5kX2Nvbm5lY3Rpb25zKCksIDApOwogICAgICAgIGFzc2VydF9lcSEocGVlcnMuY29ubmVjdGlvbl9pbmZvLm51bV9wZW5kaW5nX291dCwgMCk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfZGlzY292ZXJ5X2Jhbl9saXN0KCkgewogICAgICAgIGxldCBpcCA9IElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKTsKICAgICAgICBsZXQgc29ja2V0X2FkZHIgPSBTb2NrZXRBZGRyOjpuZXcoaXAsIDgwMDgpOwogICAgICAgIGxldCBiYW5fbGlzdCA9IEJhbkxpc3Q6Om5ldyh2ZWMhW10sIHZlYyFbaXBdKTsKICAgICAgICBsZXQgY29uZmlnID0gUGVlcnNDb25maWc6OmRlZmF1bHQoKS53aXRoX2Jhbl9saXN0KGJhbl9saXN0KTsKICAgICAgICBsZXQgbXV0IHBlZXJfbWFuYWdlciA9IFBlZXJzTWFuYWdlcjo6bmV3KGNvbmZpZyk7CiAgICAgICAgcGVlcl9tYW5hZ2VyLmFkZF9wZWVyKEI1MTI6OmRlZmF1bHQoKSwgUGVlckFkZHI6OmZyb21fdGNwKHNvY2tldF9hZGRyKSwgTm9uZSk7CgogICAgICAgIGFzc2VydCEocGVlcl9tYW5hZ2VyLnBlZXJzLmlzX2VtcHR5KCkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X29uX3BlbmRpbmdfYmFuX2xpc3QoKSB7CiAgICAgICAgbGV0IGlwID0gSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpOwogICAgICAgIGxldCBzb2NrZXRfYWRkciA9IFNvY2tldEFkZHI6Om5ldyhpcCwgODAwOCk7CiAgICAgICAgbGV0IGJhbl9saXN0ID0gQmFuTGlzdDo6bmV3KHZlYyFbXSwgdmVjIVtpcF0pOwogICAgICAgIGxldCBjb25maWcgPSBQZWVyc0NvbmZpZzo6dGVzdCgpLndpdGhfYmFuX2xpc3QoYmFuX2xpc3QpOwogICAgICAgIGxldCBtdXQgcGVlcl9tYW5hZ2VyID0gUGVlcnNNYW5hZ2VyOjpuZXcoY29uZmlnKTsKICAgICAgICBsZXQgYSA9IHBlZXJfbWFuYWdlci5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oc29ja2V0X2FkZHIuaXAoKSk7CiAgICAgICAgLy8gYmVjYXVzZSB3ZSBoYXZlIG5vIGFjdGl2ZSBwZWVycyB0aGlzIHNob3VsZCBiZSBmaW5lIGZvciB0ZXN0aW5ncwogICAgICAgIG1hdGNoIGEgewogICAgICAgICAgICBPayhfKSA9PiBwYW5pYyEoKSwKICAgICAgICAgICAgRXJyKGVycikgPT4gbWF0Y2ggZXJyIHsKICAgICAgICAgICAgICAgIEluYm91bmRDb25uZWN0aW9uRXJyb3I6OklwQmFubmVkID0+IHsKICAgICAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfbWFuYWdlci5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfaW4sIDApCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgICAgICB9LAogICAgICAgIH0KICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9vbl9hY3RpdmVfaW5ib3VuZF9iYW5fbGlzdCgpIHsKICAgICAgICBsZXQgaXAgPSBJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSk7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KGlwLCA4MDA4KTsKICAgICAgICBsZXQgZ2l2ZW5fcGVlcl9pZCA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IGJhbl9saXN0ID0gQmFuTGlzdDo6bmV3KHZlYyFbZ2l2ZW5fcGVlcl9pZF0sIHZlYyFbXSk7CiAgICAgICAgbGV0IGNvbmZpZyA9IFBlZXJzQ29uZmlnOjp0ZXN0KCkud2l0aF9iYW5fbGlzdChiYW5fbGlzdCk7CiAgICAgICAgbGV0IG11dCBwZWVyX21hbmFnZXIgPSBQZWVyc01hbmFnZXI6Om5ldyhjb25maWcpOwogICAgICAgIGFzc2VydCEocGVlcl9tYW5hZ2VyLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihzb2NrZXRfYWRkci5pcCgpKS5pc19vaygpKTsKICAgICAgICAvLyBub24tdHJ1c3RlZCBub2RlcyBzaG91bGQgYWxzbyBpbmNyZWFzZSBwZW5kaW5nX2luCiAgICAgICAgYXNzZXJ0X2VxIShwZWVyX21hbmFnZXIuY29ubmVjdGlvbl9pbmZvLm51bV9wZW5kaW5nX2luLCAxKTsKICAgICAgICBwZWVyX21hbmFnZXIub25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZChnaXZlbl9wZWVyX2lkLCBzb2NrZXRfYWRkcik7CiAgICAgICAgLy8gYWZ0ZXIgdGhlIGNvbm5lY3Rpb24gaXMgZXN0YWJsaXNoZWQsIHRoZSBwZWVyIHNob3VsZCBiZSByZW1vdmVkLCB0aGUgbnVtX3BlbmRpbmdfaW4KICAgICAgICAvLyBzaG91bGQgYmUgZGVjcmVhc2VkLCBhbmQgdGhlIG51bV9pbmJvdW5kIHNob3VsZCBub3QgYmUgaW5jcmVhc2VkCiAgICAgICAgYXNzZXJ0X2VxIShwZWVyX21hbmFnZXIuY29ubmVjdGlvbl9pbmZvLm51bV9wZW5kaW5nX2luLCAwKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJfbWFuYWdlci5jb25uZWN0aW9uX2luZm8ubnVtX2luYm91bmQsIDApOwoKICAgICAgICBsZXQgU29tZShQZWVyQWN0aW9uOjpEaXNjb25uZWN0QmFubmVkSW5jb21pbmcgeyBwZWVyX2lkIH0pID0KICAgICAgICAgICAgcGVlcl9tYW5hZ2VyLnF1ZXVlZF9hY3Rpb25zLnBvcF9mcm9udCgpCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHBhbmljISgpCiAgICAgICAgfTsKCiAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBnaXZlbl9wZWVyX2lkKQogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfY29ubmVjdGlvbl9saW1pdHMoKSB7CiAgICAgICAgbGV0IG11dCBpbmZvID0gQ29ubmVjdGlvbkluZm86OmRlZmF1bHQoKTsKICAgICAgICBpbmZvLmluY19pbigpOwogICAgICAgIGFzc2VydF9lcSEoaW5mby5udW1faW5ib3VuZCwgMSk7CiAgICAgICAgYXNzZXJ0X2VxIShpbmZvLm51bV9vdXRib3VuZCwgMCk7CiAgICAgICAgYXNzZXJ0IShpbmZvLmhhc19pbl9jYXBhY2l0eSgpKTsKCiAgICAgICAgaW5mby5kZWNyX2luKCk7CiAgICAgICAgYXNzZXJ0X2VxIShpbmZvLm51bV9pbmJvdW5kLCAwKTsKICAgICAgICBhc3NlcnRfZXEhKGluZm8ubnVtX291dGJvdW5kLCAwKTsKCiAgICAgICAgaW5mby5pbmNfb3V0KCk7CiAgICAgICAgYXNzZXJ0X2VxIShpbmZvLm51bV9pbmJvdW5kLCAwKTsKICAgICAgICBhc3NlcnRfZXEhKGluZm8ubnVtX291dGJvdW5kLCAxKTsKICAgICAgICBhc3NlcnQhKGluZm8uaGFzX291dF9jYXBhY2l0eSgpKTsKCiAgICAgICAgaW5mby5kZWNyX291dCgpOwogICAgICAgIGFzc2VydF9lcSEoaW5mby5udW1faW5ib3VuZCwgMCk7CiAgICAgICAgYXNzZXJ0X2VxIShpbmZvLm51bV9vdXRib3VuZCwgMCk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9jb25uZWN0aW9uX3BlZXJfc3RhdGUoKSB7CiAgICAgICAgbGV0IG11dCBpbmZvID0gQ29ubmVjdGlvbkluZm86OmRlZmF1bHQoKTsKICAgICAgICBpbmZvLmluY19pbigpOwoKICAgICAgICBpbmZvLmRlY3Jfc3RhdGUoUGVlckNvbm5lY3Rpb25TdGF0ZTo6SW4pOwogICAgICAgIGFzc2VydF9lcSEoaW5mby5udW1faW5ib3VuZCwgMCk7CiAgICAgICAgYXNzZXJ0X2VxIShpbmZvLm51bV9vdXRib3VuZCwgMCk7CgogICAgICAgIGluZm8uaW5jX291dCgpOwoKICAgICAgICBpbmZvLmRlY3Jfc3RhdGUoUGVlckNvbm5lY3Rpb25TdGF0ZTo6T3V0KTsKICAgICAgICBhc3NlcnRfZXEhKGluZm8ubnVtX2luYm91bmQsIDApOwogICAgICAgIGFzc2VydF9lcSEoaW5mby5udW1fb3V0Ym91bmQsIDApOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X3RydXN0ZWRfcGVlcnNfYXJlX3ByaW9yaXRpemVkKCkgewogICAgICAgIGxldCB0cnVzdGVkX3BlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCB0cnVzdGVkX3NvY2sgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLCA4MDA4KTsKICAgICAgICBsZXQgY29uZmlnID0gUGVlcnNDb25maWc6OnRlc3QoKS53aXRoX3RydXN0ZWRfbm9kZXModmVjIVtUcnVzdGVkUGVlciB7CiAgICAgICAgICAgIGhvc3Q6IEhvc3Q6OklwdjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwKICAgICAgICAgICAgdGNwX3BvcnQ6IDgwMDgsCiAgICAgICAgICAgIHVkcF9wb3J0OiA4MDA4LAogICAgICAgICAgICBpZDogdHJ1c3RlZF9wZWVyLAogICAgICAgIH1dKTsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpuZXcoY29uZmlnKTsKCiAgICAgICAgbGV0IGJhc2ljX3BlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCBiYXNpY19zb2NrID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOSk7CiAgICAgICAgcGVlcnMuYWRkX3BlZXIoYmFzaWNfcGVlciwgUGVlckFkZHI6OmZyb21fdGNwKGJhc2ljX3NvY2spLCBOb25lKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJBZGRlZChwZWVyX2lkKSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIGJhc2ljX3BlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpDb25uZWN0IHsgcGVlcl9pZCwgcmVtb3RlX2FkZHIgfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHRydXN0ZWRfcGVlcik7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHJlbW90ZV9hZGRyLCB0cnVzdGVkX3NvY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpDb25uZWN0IHsgcGVlcl9pZCwgcmVtb3RlX2FkZHIgfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIGJhc2ljX3BlZXIpOwogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShyZW1vdGVfYWRkciwgYmFzaWNfc29jayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfY29ubmVjdF90cnVzdGVkX25vZGVzX29ubHkoKSB7CiAgICAgICAgbGV0IHRydXN0ZWRfcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IHRydXN0ZWRfc29jayA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDgpOwogICAgICAgIGxldCBjb25maWcgPSBQZWVyc0NvbmZpZzo6dGVzdCgpCiAgICAgICAgICAgIC53aXRoX3RydXN0ZWRfbm9kZXModmVjIVtUcnVzdGVkUGVlciB7CiAgICAgICAgICAgICAgICBob3N0OiBIb3N0OjpJcHY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksCiAgICAgICAgICAgICAgICB0Y3BfcG9ydDogODAwOCwKICAgICAgICAgICAgICAgIHVkcF9wb3J0OiA4MDA4LAogICAgICAgICAgICAgICAgaWQ6IHRydXN0ZWRfcGVlciwKICAgICAgICAgICAgfV0pCiAgICAgICAgICAgIC53aXRoX3RydXN0ZWRfbm9kZXNfb25seSh0cnVlKTsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpuZXcoY29uZmlnKTsKCiAgICAgICAgbGV0IGJhc2ljX3BlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCBiYXNpY19zb2NrID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOSk7CiAgICAgICAgcGVlcnMuYWRkX3BlZXIoYmFzaWNfcGVlciwgUGVlckFkZHI6OmZyb21fdGNwKGJhc2ljX3NvY2spLCBOb25lKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJBZGRlZChwZWVyX2lkKSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIGJhc2ljX3BlZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpDb25uZWN0IHsgcGVlcl9pZCwgcmVtb3RlX2FkZHIgfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHRydXN0ZWRfcGVlcik7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHJlbW90ZV9hZGRyLCB0cnVzdGVkX3NvY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQogICAgICAgIHBvbGxfZm4ofGN4fCB7CiAgICAgICAgICAgIGFzc2VydCEocGVlcnMucG9sbChjeCkuaXNfcGVuZGluZygpKTsKICAgICAgICAgICAgUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgfSkKICAgICAgICAuYXdhaXQ7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfaW5jb21pbmdfd2l0aF90cnVzdGVkX25vZGVzX29ubHkoKSB7CiAgICAgICAgbGV0IHRydXN0ZWRfcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IGNvbmZpZyA9IFBlZXJzQ29uZmlnOjp0ZXN0KCkKICAgICAgICAgICAgLndpdGhfdHJ1c3RlZF9ub2Rlcyh2ZWMhW1RydXN0ZWRQZWVyIHsKICAgICAgICAgICAgICAgIGhvc3Q6IEhvc3Q6OklwdjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwKICAgICAgICAgICAgICAgIHRjcF9wb3J0OiA4MDA4LAogICAgICAgICAgICAgICAgdWRwX3BvcnQ6IDgwMDgsCiAgICAgICAgICAgICAgICBpZDogdHJ1c3RlZF9wZWVyLAogICAgICAgICAgICB9XSkKICAgICAgICAgICAgLndpdGhfdHJ1c3RlZF9ub2Rlc19vbmx5KHRydWUpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6Om5ldyhjb25maWcpOwoKICAgICAgICBsZXQgYmFzaWNfcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IGJhc2ljX3NvY2sgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLCA4MDA5KTsKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihiYXNpY19zb2NrLmlwKCkpLmlzX29rKCkpOwogICAgICAgIC8vIG5vbi10cnVzdGVkIG5vZGVzIHNob3VsZCBhbHNvIGluY3JlYXNlIHBlbmRpbmdfaW4KICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMSk7CiAgICAgICAgcGVlcnMub25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZChiYXNpY19wZWVyLCBiYXNpY19zb2NrKTsKICAgICAgICAvLyBhZnRlciB0aGUgY29ubmVjdGlvbiBpcyBlc3RhYmxpc2hlZCwgdGhlIHBlZXIgc2hvdWxkIGJlIHJlbW92ZWQsIHRoZSBudW1fcGVuZGluZ19pbgogICAgICAgIC8vIHNob3VsZCBiZSBkZWNyZWFzZWQsIGFuZCB0aGUgbnVtX2luYm91bmQgbXV0IG5vdCBiZSBpbmNyZWFzZWQKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMCk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX2luYm91bmQsIDApOwoKICAgICAgICBsZXQgU29tZShQZWVyQWN0aW9uOjpEaXNjb25uZWN0VW50cnVzdGVkSW5jb21pbmcgeyBwZWVyX2lkIH0pID0KICAgICAgICAgICAgcGVlcnMucXVldWVkX2FjdGlvbnMucG9wX2Zyb250KCkKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcGFuaWMhKCkKICAgICAgICB9OwogICAgICAgIGFzc2VydF9lcSEoYmFzaWNfcGVlciwgcGVlcl9pZCk7CiAgICAgICAgYXNzZXJ0ISghcGVlcnMucGVlcnMuY29udGFpbnNfa2V5KCZiYXNpY19wZWVyKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfaW5jb21pbmdfd2l0aG91dF90cnVzdGVkX25vZGVzX29ubHkoKSB7CiAgICAgICAgbGV0IHRydXN0ZWRfcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IGNvbmZpZyA9IFBlZXJzQ29uZmlnOjp0ZXN0KCkKICAgICAgICAgICAgLndpdGhfdHJ1c3RlZF9ub2Rlcyh2ZWMhW1RydXN0ZWRQZWVyIHsKICAgICAgICAgICAgICAgIGhvc3Q6IEhvc3Q6OklwdjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwKICAgICAgICAgICAgICAgIHRjcF9wb3J0OiA4MDA4LAogICAgICAgICAgICAgICAgdWRwX3BvcnQ6IDgwMDgsCiAgICAgICAgICAgICAgICBpZDogdHJ1c3RlZF9wZWVyLAogICAgICAgICAgICB9XSkKICAgICAgICAgICAgLndpdGhfdHJ1c3RlZF9ub2Rlc19vbmx5KGZhbHNlKTsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpuZXcoY29uZmlnKTsKCiAgICAgICAgbGV0IGJhc2ljX3BlZXIgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCBiYXNpY19zb2NrID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOSk7CiAgICAgICAgYXNzZXJ0IShwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oYmFzaWNfc29jay5pcCgpKS5pc19vaygpKTsKCiAgICAgICAgLy8gbm9uLXRydXN0ZWQgbm9kZXMgc2hvdWxkIGFsc28gaW5jcmVhc2UgcGVuZGluZ19pbgogICAgICAgIGFzc2VydF9lcSEocGVlcnMuY29ubmVjdGlvbl9pbmZvLm51bV9wZW5kaW5nX2luLCAxKTsKICAgICAgICBwZWVycy5vbl9pbmNvbWluZ19zZXNzaW9uX2VzdGFibGlzaGVkKGJhc2ljX3BlZXIsIGJhc2ljX3NvY2spOwogICAgICAgIC8vIGFmdGVyIHRoZSBjb25uZWN0aW9uIGlzIGVzdGFibGlzaGVkLCB0aGUgcGVlciBzaG91bGQgYmUgcmVtb3ZlZCwgdGhlIG51bV9wZW5kaW5nX2luCiAgICAgICAgLy8gc2hvdWxkIGJlIGRlY3JlYXNlZCwgYW5kIHRoZSBudW1faW5ib3VuZCBtdXN0IGJlIGluY3JlYXNlZAogICAgICAgIGFzc2VydF9lcSEocGVlcnMuY29ubmVjdGlvbl9pbmZvLm51bV9wZW5kaW5nX2luLCAwKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1faW5ib3VuZCwgMSk7CiAgICAgICAgYXNzZXJ0IShwZWVycy5wZWVycy5jb250YWluc19rZXkoJmJhc2ljX3BlZXIpKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9pbmNvbWluZ19hdF9jYXBhY2l0eSgpIHsKICAgICAgICBsZXQgbXV0IGNvbmZpZyA9IFBlZXJzQ29uZmlnOjp0ZXN0KCk7CiAgICAgICAgY29uZmlnLmNvbm5lY3Rpb25faW5mby5tYXhfaW5ib3VuZCA9IDE7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6bmV3KGNvbmZpZyk7CgogICAgICAgIGxldCBwZWVyID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDkpOwogICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGFkZHIuaXAoKSkuaXNfb2soKSk7CgogICAgICAgIHBlZXJzLm9uX2luY29taW5nX3Nlc3Npb25fZXN0YWJsaXNoZWQocGVlciwgYWRkcik7CgogICAgICAgIGxldCBhZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOSk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgcGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGFkZHIuaXAoKSkudW53cmFwX2VycigpLAogICAgICAgICAgICBJbmJvdW5kQ29ubmVjdGlvbkVycm9yOjpFeGNlZWRzQ2FwYWNpdHkKICAgICAgICApOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2luY29taW5nX3JhdGVfbGltaXQoKSB7CiAgICAgICAgbGV0IGNvbmZpZyA9IFBlZXJzQ29uZmlnIHsKICAgICAgICAgICAgaW5jb21pbmdfaXBfdGhyb3R0bGVfZHVyYXRpb246IER1cmF0aW9uOjpmcm9tX21pbGxpcygxMDApLAogICAgICAgICAgICAuLlBlZXJzQ29uZmlnOjp0ZXN0KCkKICAgICAgICB9OwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6Om5ldyhjb25maWcpOwoKICAgICAgICBsZXQgYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTY4LCAwLCAxLCAyKSksIDgwMDkpOwogICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGFkZHIuaXAoKSkuaXNfb2soKSk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgcGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGFkZHIuaXAoKSkudW53cmFwX2VycigpLAogICAgICAgICAgICBJbmJvdW5kQ29ubmVjdGlvbkVycm9yOjpJcEJhbm5lZAogICAgICAgICk7CgogICAgICAgIHBlZXJzLnJlbGVhc2VfaW50ZXJ2YWwucmVzZXRfaW1tZWRpYXRlbHkoKTsKICAgICAgICB0b2tpbzo6dGltZTo6c2xlZXAocGVlcnMuaW5jb21pbmdfaXBfdGhyb3R0bGVfZHVyYXRpb24pLmF3YWl0OwoKICAgICAgICAvLyBhd2FpdCB1bmJhbgogICAgICAgIHBvbGxfZm4ofGN4fCBsb29wIHsKICAgICAgICAgICAgaWYgcGVlcnMucG9sbChjeCkuaXNfcGVuZGluZygpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQb2xsOjpSZWFkeSgoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5hd2FpdDsKCiAgICAgICAgYXNzZXJ0IShwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oYWRkci5pcCgpKS5pc19vaygpKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oYWRkci5pcCgpKS51bndyYXBfZXJyKCksCiAgICAgICAgICAgIEluYm91bmRDb25uZWN0aW9uRXJyb3I6OklwQmFubmVkCiAgICAgICAgKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF90aWNrKCkgewogICAgICAgIGxldCBpcCA9IElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKTsKICAgICAgICBsZXQgc29ja2V0X2FkZHIgPSBTb2NrZXRBZGRyOjpuZXcoaXAsIDgwMDgpOwogICAgICAgIGxldCBjb25maWcgPSBQZWVyc0NvbmZpZzo6dGVzdCgpOwogICAgICAgIGxldCBtdXQgcGVlcl9tYW5hZ2VyID0gUGVlcnNNYW5hZ2VyOjpuZXcoY29uZmlnKTsKICAgICAgICBsZXQgcGVlcl9pZCA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgcGVlcl9tYW5hZ2VyLmFkZF9wZWVyKHBlZXJfaWQsIFBlZXJBZGRyOjpmcm9tX3RjcChzb2NrZXRfYWRkciksIE5vbmUpOwoKICAgICAgICB0b2tpbzo6dGltZTo6c2xlZXAoRHVyYXRpb246OmZyb21fc2VjcygxKSkuYXdhaXQ7CiAgICAgICAgcGVlcl9tYW5hZ2VyLnRpY2soKTsKCiAgICAgICAgLy8gc3RpbGwgdW5jb25uZWN0ZWQKICAgICAgICBhc3NlcnRfZXEhKHBlZXJfbWFuYWdlci5wZWVycy5nZXRfbXV0KCZwZWVyX2lkKS51bndyYXAoKS5yZXB1dGF0aW9uLCBERUZBVUxUX1JFUFVUQVRJT04pOwoKICAgICAgICAvLyBtYXJrIGFzIGNvbm5lY3RlZAogICAgICAgIHBlZXJfbWFuYWdlci5wZWVycy5nZXRfbXV0KCZwZWVyX2lkKS51bndyYXAoKS5zdGF0ZSA9IFBlZXJDb25uZWN0aW9uU3RhdGU6Ok91dDsKCiAgICAgICAgdG9raW86OnRpbWU6OnNsZWVwKER1cmF0aW9uOjpmcm9tX3NlY3MoMSkpLmF3YWl0OwogICAgICAgIHBlZXJfbWFuYWdlci50aWNrKCk7CgogICAgICAgIC8vIHN0aWxsIGF0IGRlZmF1bHQgcmVwdXRhdGlvbgogICAgICAgIGFzc2VydF9lcSEocGVlcl9tYW5hZ2VyLnBlZXJzLmdldF9tdXQoJnBlZXJfaWQpLnVud3JhcCgpLnJlcHV0YXRpb24sIERFRkFVTFRfUkVQVVRBVElPTik7CgogICAgICAgIHBlZXJfbWFuYWdlci5wZWVycy5nZXRfbXV0KCZwZWVyX2lkKS51bndyYXAoKS5yZXB1dGF0aW9uIC09IDE7CgogICAgICAgIHRva2lvOjp0aW1lOjpzbGVlcChEdXJhdGlvbjo6ZnJvbV9zZWNzKDEpKS5hd2FpdDsKICAgICAgICBwZWVyX21hbmFnZXIudGljaygpOwoKICAgICAgICAvLyB0aWNrIGFwcGxpZWQKICAgICAgICBhc3NlcnQhKHBlZXJfbWFuYWdlci5wZWVycy5nZXRfbXV0KCZwZWVyX2lkKS51bndyYXAoKS5yZXB1dGF0aW9uID49IERFRkFVTFRfUkVQVVRBVElPTik7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfcmVtb3ZlX2luY29taW5nX2FmdGVyX2Rpc2Nvbm5lY3QoKSB7CiAgICAgICAgbGV0IHBlZXJfaWQgPSBQZWVySWQ6OnJhbmRvbSgpOwogICAgICAgIGxldCBhZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOSk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6ZGVmYXVsdCgpOwoKICAgICAgICBwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oYWRkci5pcCgpKS51bndyYXAoKTsKICAgICAgICBwZWVycy5vbl9pbmNvbWluZ19zZXNzaW9uX2VzdGFibGlzaGVkKHBlZXJfaWQsIGFkZHIpOwogICAgICAgIGxldCBwZWVyID0gcGVlcnMucGVlcnMuZ2V0KCZwZWVyX2lkKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXIuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OkluKTsKICAgICAgICBhc3NlcnQhKHBlZXIucmVtb3ZlX2FmdGVyX2Rpc2Nvbm5lY3QpOwoKICAgICAgICBwZWVycy5vbl9hY3RpdmVfc2Vzc2lvbl9ncmFjZWZ1bGx5X2Nsb3NlZChwZWVyX2lkKTsKICAgICAgICBhc3NlcnQhKCFwZWVycy5wZWVycy5jb250YWluc19rZXkoJnBlZXJfaWQpKQogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2tlZXBfaW5jb21pbmdfYWZ0ZXJfZGlzY29ubmVjdF9pZl9kaXNjb3ZlcmVkKCkgewogICAgICAgIGxldCBwZWVyX2lkID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDkpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6OmRlZmF1bHQoKTsKCiAgICAgICAgcGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGFkZHIuaXAoKSkudW53cmFwKCk7CiAgICAgICAgcGVlcnMub25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZChwZWVyX2lkLCBhZGRyKTsKICAgICAgICBsZXQgcGVlciA9IHBlZXJzLnBlZXJzLmdldCgmcGVlcl9pZCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVyLnN0YXRlLCBQZWVyQ29ubmVjdGlvblN0YXRlOjpJbik7CiAgICAgICAgYXNzZXJ0IShwZWVyLnJlbW92ZV9hZnRlcl9kaXNjb25uZWN0KTsKCiAgICAgICAgLy8gdHJpZ2dlciBkaXNjb3ZlcnkgbWFudWFsbHkgd2hpbGUgdGhlIHBlZXIgaXMgc3RpbGwgY29ubmVjdGVkCiAgICAgICAgcGVlcnMuYWRkX3BlZXIocGVlcl9pZCwgUGVlckFkZHI6OmZyb21fdGNwKGFkZHIpLCBOb25lKTsKCiAgICAgICAgcGVlcnMub25fYWN0aXZlX3Nlc3Npb25fZ3JhY2VmdWxseV9jbG9zZWQocGVlcl9pZCk7CgogICAgICAgIGxldCBwZWVyID0gcGVlcnMucGVlcnMuZ2V0KCZwZWVyX2lkKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXIuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OklkbGUpOwogICAgICAgIGFzc2VydCEoIXBlZXIucmVtb3ZlX2FmdGVyX2Rpc2Nvbm5lY3QpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X3BlZXJfcmVjb25uZWN0X2FmdGVyX2dyYWNlZnVsX2Nsb3NlX3Jlc3BlY3RzX3Rocm90dGxlKCkgewogICAgICAgIGxldCB0aHJvdHRsZV9kdXJhdGlvbiA9IER1cmF0aW9uOjpmcm9tX21pbGxpcygxMDApOwogICAgICAgIGxldCBjb25maWcgPQogICAgICAgICAgICBQZWVyc0NvbmZpZyB7IGluY29taW5nX2lwX3Rocm90dGxlX2R1cmF0aW9uOiB0aHJvdHRsZV9kdXJhdGlvbiwgLi5QZWVyc0NvbmZpZzo6dGVzdCgpIH07CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6bmV3KGNvbmZpZyk7CgogICAgICAgIGxldCBwZWVyX2lkID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDkpOwoKICAgICAgICAvLyBBZGQgYXMgcmVndWxhciBwZWVyCiAgICAgICAgcGVlcnMuYWRkX3BlZXIocGVlcl9pZCwgUGVlckFkZHI6OmZyb21fdGNwKGFkZHIpLCBOb25lKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJBZGRlZChpZCkgPT4gYXNzZXJ0X2VxIShpZCwgcGVlcl9pZCksCiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6Q29ubmVjdCB7IC4uIH0gPT4ge30KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIC8vIFNpbXVsYXRlIG91dGJvdW5kIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQKICAgICAgICBwZWVycy5vbl9hY3RpdmVfb3V0Z29pbmdfZXN0YWJsaXNoZWQocGVlcl9pZCk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5wZWVycy5nZXQoJnBlZXJfaWQpLnVud3JhcCgpLnN0YXRlLCBQZWVyQ29ubmVjdGlvblN0YXRlOjpPdXQpOwoKICAgICAgICAvLyBHcmFjZWZ1bGx5IGNsb3NlIHRoZSBzZXNzaW9uCiAgICAgICAgcGVlcnMub25fYWN0aXZlX3Nlc3Npb25fZ3JhY2VmdWxseV9jbG9zZWQocGVlcl9pZCk7CgogICAgICAgIGxldCBwZWVyID0gcGVlcnMucGVlcnMuZ2V0KCZwZWVyX2lkKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXIuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OklkbGUpOwogICAgICAgIGFzc2VydCEocGVlci5iYWNrZWRfb2ZmKTsKCiAgICAgICAgLy8gVmVyaWZ5IHRoZSBwZWVyIGlzIGluIHRoZSBiYWNrZWRfb2ZmX3BlZXJzIHNldAogICAgICAgIGFzc2VydCEocGVlcnMuYmFja2VkX29mZl9wZWVycy5jb250YWluc19rZXkoJnBlZXJfaWQpKTsKCiAgICAgICAgLy8gSW1tZWRpYXRlbHkgdHJ5IHRvIHBvbGwgLSBzaG91bGQgbm90IHRyaWdnZXIgYW55IGFjdGlvbnMgeWV0CiAgICAgICAgcG9sbF9mbih8Y3h8IHsKICAgICAgICAgICAgYXNzZXJ0IShwZWVycy5wb2xsKGN4KS5pc19wZW5kaW5nKCkpOwogICAgICAgICAgICBQb2xsOjpSZWFkeSgoKSkKICAgICAgICB9KQogICAgICAgIC5hd2FpdDsKCiAgICAgICAgLy8gUGVlciBzaG91bGQgc3RpbGwgYmUgYmFja2VkIG9mZgogICAgICAgIGFzc2VydCEocGVlcnMuYmFja2VkX29mZl9wZWVycy5jb250YWluc19rZXkoJnBlZXJfaWQpKTsKICAgICAgICBhc3NlcnQhKHBlZXJzLnBlZXJzLmdldCgmcGVlcl9pZCkudW53cmFwKCkuYmFja2VkX29mZik7CgogICAgICAgIC8vIFNsZWVwIGZvciB0aGUgdGhyb3R0bGUgZHVyYXRpb24KICAgICAgICB0b2tpbzo6dGltZTo6c2xlZXAodGhyb3R0bGVfZHVyYXRpb24pLmF3YWl0OwoKICAgICAgICAvLyBBZnRlciB0aHJvdHRsZSBkdXJhdGlvbiwgZXZlbnQhIHdpbGwgcG9sbCB1bnRpbCB3ZSBnZXQgYSBDb25uZWN0IGFjdGlvbgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpDb25uZWN0IHsgcGVlcl9pZDogaWQsIC4uIH0gPT4gYXNzZXJ0X2VxIShpZCwgcGVlcl9pZCksCiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICAvLyBBZnRlciBjb25uZWN0aW9uIGlzIGluaXRpYXRlZCwgcGVlciBzaG91bGQgbm8gbG9uZ2VyIGJlIGJhY2tlZCBvZmYKICAgICAgICBhc3NlcnQhKCFwZWVycy5iYWNrZWRfb2ZmX3BlZXJzLmNvbnRhaW5zX2tleSgmcGVlcl9pZCkpOwogICAgICAgIGFzc2VydCEoIXBlZXJzLnBlZXJzLmdldCgmcGVlcl9pZCkudW53cmFwKCkuYmFja2VkX29mZik7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfYmFja2VkX29mZl9wZWVyX2Nhbl9hY2NlcHRfaW5jb21pbmdfY29ubmVjdGlvbigpIHsKICAgICAgICBsZXQgdGhyb3R0bGVfZHVyYXRpb24gPSBEdXJhdGlvbjo6ZnJvbV9taWxsaXMoMTAwKTsKICAgICAgICBsZXQgY29uZmlnID0KICAgICAgICAgICAgUGVlcnNDb25maWcgeyBpbmNvbWluZ19pcF90aHJvdHRsZV9kdXJhdGlvbjogdGhyb3R0bGVfZHVyYXRpb24sIC4uUGVlcnNDb25maWc6OnRlc3QoKSB9OwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6Om5ldyhjb25maWcpOwoKICAgICAgICBsZXQgcGVlcl9pZCA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IGFkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLCA4MDA5KTsKCiAgICAgICAgLy8gQWRkIGFzIHJlZ3VsYXIgcGVlcgogICAgICAgIHBlZXJzLmFkZF9wZWVyKHBlZXJfaWQsIFBlZXJBZGRyOjpmcm9tX3RjcChhZGRyKSwgTm9uZSk7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpQZWVyQWRkZWQoaWQpID0+IGFzc2VydF9lcSEoaWQsIHBlZXJfaWQpLAogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyAuLiB9ID0+IHt9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICAvLyBTaW11bGF0ZSBvdXRib3VuZCBjb25uZWN0aW9uIGVzdGFibGlzaGVkCiAgICAgICAgcGVlcnMub25fYWN0aXZlX291dGdvaW5nX2VzdGFibGlzaGVkKHBlZXJfaWQpOwogICAgICAgIGFzc2VydF9lcSEocGVlcnMucGVlcnMuZ2V0KCZwZWVyX2lkKS51bndyYXAoKS5zdGF0ZSwgUGVlckNvbm5lY3Rpb25TdGF0ZTo6T3V0KTsKCiAgICAgICAgLy8gR3JhY2VmdWxseSBjbG9zZSB0aGUgc2Vzc2lvbiAtIHRoaXMgd2lsbCBiYWNrIG9mZiB0aGUgcGVlcgogICAgICAgIHBlZXJzLm9uX2FjdGl2ZV9zZXNzaW9uX2dyYWNlZnVsbHlfY2xvc2VkKHBlZXJfaWQpOwoKICAgICAgICBsZXQgcGVlciA9IHBlZXJzLnBlZXJzLmdldCgmcGVlcl9pZCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVyLnN0YXRlLCBQZWVyQ29ubmVjdGlvblN0YXRlOjpJZGxlKTsKICAgICAgICBhc3NlcnQhKHBlZXIuYmFja2VkX29mZik7CiAgICAgICAgYXNzZXJ0IShwZWVycy5iYWNrZWRfb2ZmX3BlZXJzLmNvbnRhaW5zX2tleSgmcGVlcl9pZCkpOwoKICAgICAgICAvLyBOb3cgc2ltdWxhdGUgYW4gaW5jb21pbmcgY29ubmVjdGlvbiBmcm9tIHRoZSBiYWNrZWQtb2ZmIHBlZXIKICAgICAgICAvLyBGaXJzdCwgaGFuZGxlIHRoZSBpbmNvbWluZyBwZW5kaW5nIHNlc3Npb24KICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihhZGRyLmlwKCkpLmlzX29rKCkpOwogICAgICAgIGFzc2VydF9lcSEocGVlcnMuY29ubmVjdGlvbl9pbmZvLm51bV9wZW5kaW5nX2luLCAxKTsKCiAgICAgICAgLy8gRXN0YWJsaXNoIHRoZSBpbmNvbWluZyBzZXNzaW9uCiAgICAgICAgcGVlcnMub25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZChwZWVyX2lkLCBhZGRyKTsKCiAgICAgICAgLy8gUGVlciBzaG91bGQgaGF2ZSBiZWVuIGFkZGVkIHRvIGluY29taW5nIGNvbm5lY3Rpb25zCiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5wZWVycy5nZXQoJnBlZXJfaWQpLnVud3JhcCgpLnN0YXRlLCBQZWVyQ29ubmVjdGlvblN0YXRlOjpJbik7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX2luYm91bmQsIDEpOwoKICAgICAgICAvLyBQZWVyIHNob3VsZCBzdGlsbCBiZSBiYWNrZWQgb2ZmIGZvciBvdXRib3VuZCBjb25uZWN0aW9ucwogICAgICAgIGFzc2VydCEocGVlcnMuYmFja2VkX29mZl9wZWVycy5jb250YWluc19rZXkoJnBlZXJfaWQpKTsKICAgICAgICBhc3NlcnQhKHBlZXJzLnBlZXJzLmdldCgmcGVlcl9pZCkudW53cmFwKCkuYmFja2VkX29mZik7CgogICAgICAgIC8vIFZlcmlmeSB3ZSBkb24ndCB0cnkgdG8gcmVjb25uZWN0IG91dGJvdW5kIHdoaWxlIHBlZXIgaXMgYmFja2VkIG9mZgogICAgICAgIHBvbGxfZm4ofGN4fCB7CiAgICAgICAgICAgIGFzc2VydCEocGVlcnMucG9sbChjeCkuaXNfcGVuZGluZygpKTsKICAgICAgICAgICAgUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgfSkKICAgICAgICAuYXdhaXQ7CgogICAgICAgIC8vIE5vIG91dGJvdW5kIGNvbm5lY3Rpb24gc2hvdWxkIGJlIGF0dGVtcHRlZCB3aGlsZSBiYWNrZWQgb2ZmCiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5wZWVycy5nZXQoJnBlZXJfaWQpLnVud3JhcCgpLnN0YXRlLCBQZWVyQ29ubmVjdGlvblN0YXRlOjpJbik7CgogICAgICAgIC8vIEFmdGVyIHRocm90dGxlIGR1cmF0aW9uLCB0aGUgYmFja29mZiBzaG91bGQgYmUgY2xlYXJlZAogICAgICAgIHRva2lvOjp0aW1lOjpzbGVlcCh0aHJvdHRsZV9kdXJhdGlvbikuYXdhaXQ7CgogICAgICAgIHBvbGxfZm4ofGN4fCB7CiAgICAgICAgICAgIGxldCBfID0gcGVlcnMucG9sbChjeCk7CiAgICAgICAgICAgIFBvbGw6OlJlYWR5KCgpKQogICAgICAgIH0pCiAgICAgICAgLmF3YWl0OwoKICAgICAgICAvLyBCYWNrb2ZmIHNob3VsZCBiZSBjbGVhcmVkIG5vdwogICAgICAgIGFzc2VydCEoIXBlZXJzLmJhY2tlZF9vZmZfcGVlcnMuY29udGFpbnNfa2V5KCZwZWVyX2lkKSk7CiAgICAgICAgYXNzZXJ0ISghcGVlcnMucGVlcnMuZ2V0KCZwZWVyX2lkKS51bndyYXAoKS5iYWNrZWRfb2ZmKTsKCiAgICAgICAgLy8gUGVlciBzaG91bGQgc3RpbGwgYmUgaW4gaW5jb21pbmcgc3RhdGUKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLnBlZXJzLmdldCgmcGVlcl9pZCkudW53cmFwKCkuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OkluKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9pbmNvbWluZ19vdXRnb2luZ19hbHJlYWR5X2Nvbm5lY3RlZCgpIHsKICAgICAgICBsZXQgcGVlcl9pZCA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IGFkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLCA4MDA5KTsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpkZWZhdWx0KCk7CgogICAgICAgIHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihhZGRyLmlwKCkpLnVud3JhcCgpOwogICAgICAgIHBlZXJzLmFkZF9wZWVyKHBlZXJfaWQsIFBlZXJBZGRyOjpmcm9tX3RjcChhZGRyKSwgTm9uZSk7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpQZWVyQWRkZWQoXykgPT4ge30KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpDb25uZWN0IHsgLi4gfSA9PiB7fQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgcGVlcnMub25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZChwZWVyX2lkLCBhZGRyKTsKICAgICAgICBwZWVycy5vbl9hbHJlYWR5X2Nvbm5lY3RlZChEaXJlY3Rpb246Ok91dGdvaW5nKHBlZXJfaWQpKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLnBlZXJzLmdldCgmcGVlcl9pZCkudW53cmFwKCkuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OkluKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1faW5ib3VuZCwgMSk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfb3V0LCAwKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMCk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX291dGJvdW5kLCAwKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9hbHJlYWR5X2Nvbm5lY3RlZF9pbmNvbWluZ19vdXRnb2luZ19jb25uZWN0aW9uX2Vycm9yKCkgewogICAgICAgIGxldCBwZWVyX2lkID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgYWRkciA9IFNvY2tldEFkZHI6Om5ldyhJcEFkZHI6OlY0KElwdjRBZGRyOjpuZXcoMTI3LCAwLCAxLCAyKSksIDgwMDkpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6OmRlZmF1bHQoKTsKCiAgICAgICAgcGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGFkZHIuaXAoKSkudW53cmFwKCk7CiAgICAgICAgcGVlcnMuYWRkX3BlZXIocGVlcl9pZCwgUGVlckFkZHI6OmZyb21fdGNwKGFkZHIpLCBOb25lKTsKCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OlBlZXJBZGRlZChfKSA9PiB7fQogICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgIH0KCiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyAuLiB9ID0+IHt9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICBwZWVycy5vbl9pbmNvbWluZ19zZXNzaW9uX2VzdGFibGlzaGVkKHBlZXJfaWQsIGFkZHIpOwoKICAgICAgICBwZWVycy5vbl9vdXRnb2luZ19jb25uZWN0aW9uX2ZhaWx1cmUoCiAgICAgICAgICAgICZhZGRyLAogICAgICAgICAgICAmcGVlcl9pZCwKICAgICAgICAgICAgJmlvOjpFcnJvcjo6bmV3KGlvOjpFcnJvcktpbmQ6OkNvbm5lY3Rpb25SZWZ1c2VkLCAiIiksCiAgICAgICAgKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLnBlZXJzLmdldCgmcGVlcl9pZCkudW53cmFwKCkuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OkluKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1faW5ib3VuZCwgMSk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfb3V0LCAwKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1fcGVuZGluZ19pbiwgMCk7CiAgICAgICAgYXNzZXJ0X2VxIShwZWVycy5jb25uZWN0aW9uX2luZm8ubnVtX291dGJvdW5kLCAwKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9tYXhfY29uY3VycmVudF9kaWFscygpIHsKICAgICAgICBsZXQgY29uZmlnID0gUGVlcnNDb25maWc6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgbXV0IHBlZXJfbWFuYWdlciA9IFBlZXJzTWFuYWdlcjo6bmV3KGNvbmZpZyk7CiAgICAgICAgbGV0IGlwID0gSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpOwogICAgICAgIGxldCBwZWVyX2FkZHIgPSBQZWVyQWRkcjo6ZnJvbV90Y3AoU29ja2V0QWRkcjo6bmV3KGlwLCA4MDA4KSk7CiAgICAgICAgZm9yIF8gaW4gMC4ucGVlcl9tYW5hZ2VyLmNvbm5lY3Rpb25faW5mby5jb25maWcubWF4X2NvbmN1cnJlbnRfb3V0Ym91bmRfZGlhbHMgKiAyIHsKICAgICAgICAgICAgcGVlcl9tYW5hZ2VyLmFkZF9wZWVyKFBlZXJJZDo6cmFuZG9tKCksIHBlZXJfYWRkciwgTm9uZSk7CiAgICAgICAgfQoKICAgICAgICBwZWVyX21hbmFnZXIuZmlsbF9vdXRib3VuZF9zbG90cygpOwogICAgICAgIGxldCBkaWFscyA9IHBlZXJfbWFuYWdlcgogICAgICAgICAgICAucXVldWVkX2FjdGlvbnMKICAgICAgICAgICAgLml0ZXIoKQogICAgICAgICAgICAuZmlsdGVyKHxldnwgbWF0Y2hlcyEoZXYsIFBlZXJBY3Rpb246OkNvbm5lY3QgeyAuLiB9KSkKICAgICAgICAgICAgLmNvdW50KCk7CiAgICAgICAgYXNzZXJ0X2VxIShkaWFscywgcGVlcl9tYW5hZ2VyLmNvbm5lY3Rpb25faW5mby5jb25maWcubWF4X2NvbmN1cnJlbnRfb3V0Ym91bmRfZGlhbHMpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X21heF9udW1fb2ZfcGVuZGluZ19kaWFscygpIHsKICAgICAgICBsZXQgY29uZmlnID0gUGVlcnNDb25maWc6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgbXV0IHBlZXJfbWFuYWdlciA9IFBlZXJzTWFuYWdlcjo6bmV3KGNvbmZpZyk7CiAgICAgICAgbGV0IGlwID0gSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpOwogICAgICAgIGxldCBwZWVyX2FkZHIgPSBQZWVyQWRkcjo6ZnJvbV90Y3AoU29ja2V0QWRkcjo6bmV3KGlwLCA4MDA4KSk7CgogICAgICAgIC8vIGFkZCBtb3JlIHBlZXJzIHRoYW4gYWxsb3dlZAogICAgICAgIGZvciBfIGluIDAuLnBlZXJfbWFuYWdlci5jb25uZWN0aW9uX2luZm8uY29uZmlnLm1heF9jb25jdXJyZW50X291dGJvdW5kX2RpYWxzICogMiB7CiAgICAgICAgICAgIHBlZXJfbWFuYWdlci5hZGRfcGVlcihQZWVySWQ6OnJhbmRvbSgpLCBwZWVyX2FkZHIsIE5vbmUpOwogICAgICAgIH0KCiAgICAgICAgZm9yIF8gaW4gMC4ucGVlcl9tYW5hZ2VyLmNvbm5lY3Rpb25faW5mby5jb25maWcubWF4X2NvbmN1cnJlbnRfb3V0Ym91bmRfZGlhbHMgKiAyIHsKICAgICAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJfbWFuYWdlcikgewogICAgICAgICAgICAgICAgUGVlckFjdGlvbjo6UGVlckFkZGVkKF8pID0+IHt9CiAgICAgICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgXyBpbiAwLi5wZWVyX21hbmFnZXIuY29ubmVjdGlvbl9pbmZvLmNvbmZpZy5tYXhfY29uY3VycmVudF9vdXRib3VuZF9kaWFscyB7CiAgICAgICAgICAgIG1hdGNoIGV2ZW50IShwZWVyX21hbmFnZXIpIHsKICAgICAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyAuLiB9ID0+IHt9CiAgICAgICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBnZW5lcmF0ZSAnQ29ubmVjdCcgYWN0aW9ucwogICAgICAgIHBlZXJfbWFuYWdlci5maWxsX291dGJvdW5kX3Nsb3RzKCk7CgogICAgICAgIC8vIGFsbCBkaWFsZWQgY29ubmVjdGlvbnMgc2hvdWxkIGJlIGluICdQZW5kaW5nT3V0JyBzdGF0ZQogICAgICAgIGxldCBkaWFscyA9IHBlZXJfbWFuYWdlci5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfb3V0OwogICAgICAgIGFzc2VydF9lcSEoZGlhbHMsIHBlZXJfbWFuYWdlci5jb25uZWN0aW9uX2luZm8uY29uZmlnLm1heF9jb25jdXJyZW50X291dGJvdW5kX2RpYWxzKTsKCiAgICAgICAgbGV0IG51bV9wZW5kaW5nb3V0X3N0YXRlcyA9IHBlZXJfbWFuYWdlcgogICAgICAgICAgICAucGVlcnMKICAgICAgICAgICAgLml0ZXIoKQogICAgICAgICAgICAuZmlsdGVyKHwoXywgcGVlcil8IHBlZXIuc3RhdGUgPT0gUGVlckNvbm5lY3Rpb25TdGF0ZTo6UGVuZGluZ091dCkKICAgICAgICAgICAgLm1hcCh8KHBlZXJfaWQsIF8pfCAqcGVlcl9pZCkKICAgICAgICAgICAgLmNvbGxlY3Q6OjxWZWM8UGVlcklkPj4oKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBudW1fcGVuZGluZ291dF9zdGF0ZXMubGVuKCksCiAgICAgICAgICAgIHBlZXJfbWFuYWdlci5jb25uZWN0aW9uX2luZm8uY29uZmlnLm1heF9jb25jdXJyZW50X291dGJvdW5kX2RpYWxzCiAgICAgICAgKTsKCiAgICAgICAgLy8gZXN0YWJsaXNoIGRpYWxlZCBjb25uZWN0aW9ucwogICAgICAgIGZvciBwZWVyX2lkIGluICZudW1fcGVuZGluZ291dF9zdGF0ZXMgewogICAgICAgICAgICBwZWVyX21hbmFnZXIub25fYWN0aXZlX291dGdvaW5nX2VzdGFibGlzaGVkKCpwZWVyX2lkKTsKICAgICAgICB9CgogICAgICAgIC8vIGFsbCBkaWFsZWQgY29ubmVjdGlvbnMgc2hvdWxkIG5vdyBiZSBpbiAnT3V0JyBzdGF0ZQogICAgICAgIGZvciBwZWVyX2lkIGluICZudW1fcGVuZGluZ291dF9zdGF0ZXMgewogICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfbWFuYWdlci5wZWVycy5nZXQocGVlcl9pZCkudW53cmFwKCkuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6Ok91dCk7CiAgICAgICAgfQoKICAgICAgICAvLyBubyBtb3JlIHBlbmRpbmcgb3V0Ym91bmQgY29ubmVjdGlvbnMKICAgICAgICBhc3NlcnRfZXEhKHBlZXJfbWFuYWdlci5jb25uZWN0aW9uX2luZm8ubnVtX3BlbmRpbmdfb3V0LCAwKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9jb25uZWN0KCkgewogICAgICAgIGxldCBwZWVyID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgc29ja2V0X2FkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLCA4MDA4KTsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpkZWZhdWx0KCk7CiAgICAgICAgcGVlcnMuYWRkX2FuZF9jb25uZWN0KHBlZXIsIFBlZXJBZGRyOjpmcm9tX3RjcChzb2NrZXRfYWRkciksIE5vbmUpOwogICAgICAgIGFzc2VydF9lcSEocGVlcnMucGVlcnMuZ2V0KCZwZWVyKS51bndyYXAoKS5zdGF0ZSwgUGVlckNvbm5lY3Rpb25TdGF0ZTo6UGVuZGluZ091dCk7CgogICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICBQZWVyQWN0aW9uOjpDb25uZWN0IHsgcGVlcl9pZCwgcmVtb3RlX2FkZHIgfSA9PiB7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHBlZXJfaWQsIHBlZXIpOwogICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShyZW1vdGVfYWRkciwgc29ja2V0X2FkZHIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgfQoKICAgICAgICBsZXQgKHJlY29yZCwgXykgPSBwZWVycy5wZWVyX2J5X2lkKHBlZXIpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEocmVjb3JkLnRjcF9hZGRyKCksIHNvY2tldF9hZGRyKTsKICAgICAgICBhc3NlcnRfZXEhKHJlY29yZC51ZHBfYWRkcigpLCBzb2NrZXRfYWRkcik7CgogICAgICAgIC8vIGNvbm5lY3QgYWdhaW4KICAgICAgICBwZWVycy5hZGRfYW5kX2Nvbm5lY3QocGVlciwgUGVlckFkZHI6OmZyb21fdGNwKHNvY2tldF9hZGRyKSwgTm9uZSk7CgogICAgICAgIGxldCAocmVjb3JkLCBfKSA9IHBlZXJzLnBlZXJfYnlfaWQocGVlcikudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShyZWNvcmQudGNwX2FkZHIoKSwgc29ja2V0X2FkZHIpOwogICAgICAgIGFzc2VydF9lcSEocmVjb3JkLnVkcF9hZGRyKCksIHNvY2tldF9hZGRyKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9pbmNvbWluZ19jb25uZWN0aW9uX2Zyb21fYmFubmVkKCkgewogICAgICAgIGxldCBwZWVyID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgc29ja2V0X2FkZHIgPSBTb2NrZXRBZGRyOjpuZXcoSXBBZGRyOjpWNChJcHY0QWRkcjo6bmV3KDEyNywgMCwgMSwgMikpLCA4MDA4KTsKICAgICAgICBsZXQgY29uZmlnID0gUGVlcnNDb25maWc6OnRlc3QoKS53aXRoX21heF9pbmJvdW5kKDMpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6Om5ldyhjb25maWcpOwogICAgICAgIHBlZXJzLmFkZF9wZWVyKHBlZXIsIFBlZXJBZGRyOjpmcm9tX3RjcChzb2NrZXRfYWRkciksIE5vbmUpOwoKICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgUGVlckFjdGlvbjo6UGVlckFkZGVkKHBlZXJfaWQpID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CiAgICAgICAgbWF0Y2ggZXZlbnQhKHBlZXJzKSB7CiAgICAgICAgICAgIFBlZXJBY3Rpb246OkNvbm5lY3QgeyBwZWVyX2lkLCAuLiB9ID0+IHsKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXyA9PiB1bnJlYWNoYWJsZSEoKSwKICAgICAgICB9CgogICAgICAgIHBvbGxfZm4ofGN4fCB7CiAgICAgICAgICAgIGFzc2VydCEocGVlcnMucG9sbChjeCkuaXNfcGVuZGluZygpKTsKICAgICAgICAgICAgUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgfSkKICAgICAgICAuYXdhaXQ7CgogICAgICAgIC8vIHNpbXVsYXRlIG5ldyBjb25uZWN0aW9uIGRyb3BzIHdpdGggZXJyb3IKICAgICAgICBsb29wIHsKICAgICAgICAgICAgcGVlcnMub25fYWN0aXZlX3Nlc3Npb25fZHJvcHBlZCgKICAgICAgICAgICAgICAgICZzb2NrZXRfYWRkciwKICAgICAgICAgICAgICAgICZwZWVyLAogICAgICAgICAgICAgICAgJkV0aFN0cmVhbUVycm9yOjpJbnZhbGlkTWVzc2FnZShyZXRoX2V0aF93aXJlOjptZXNzYWdlOjpNZXNzYWdlRXJyb3I6OkludmFsaWQoCiAgICAgICAgICAgICAgICAgICAgcmV0aF9ldGhfd2lyZTo6RXRoVmVyc2lvbjo6RXRoNjgsCiAgICAgICAgICAgICAgICAgICAgcmV0aF9ldGhfd2lyZTo6RXRoTWVzc2FnZUlEOjpTdGF0dXMsCiAgICAgICAgICAgICAgICApKSwKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGlmIHBlZXJzLnBlZXJzLmdldCgmcGVlcikudW53cmFwKCkuaXNfYmFubmVkKCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKHNvY2tldF9hZGRyLmlwKCkpLmlzX29rKCkpOwogICAgICAgICAgICBwZWVycy5vbl9pbmNvbWluZ19zZXNzaW9uX2VzdGFibGlzaGVkKHBlZXIsIHNvY2tldF9hZGRyKTsKCiAgICAgICAgICAgIG1hdGNoIGV2ZW50IShwZWVycykgewogICAgICAgICAgICAgICAgUGVlckFjdGlvbjo6Q29ubmVjdCB7IHBlZXJfaWQsIC4uIH0gPT4gewogICAgICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocGVlcl9pZCwgcGVlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfID0+IHVucmVhY2hhYmxlISgpLAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhc3NlcnQhKHBlZXJzLnBlZXJzLmdldCgmcGVlcikudW53cmFwKCkuaXNfYmFubmVkKCkpOwoKICAgICAgICAvLyBmaWxsIGFsbCBpbmNvbWluZyBzbG90cwogICAgICAgIGZvciBfIGluIDAuLnBlZXJzLmNvbm5lY3Rpb25faW5mby5jb25maWcubWF4X2luYm91bmQgewogICAgICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihzb2NrZXRfYWRkci5pcCgpKS5pc19vaygpKTsKICAgICAgICAgICAgcGVlcnMub25faW5jb21pbmdfc2Vzc2lvbl9lc3RhYmxpc2hlZChwZWVyLCBzb2NrZXRfYWRkcik7CgogICAgICAgICAgICBtYXRjaCBldmVudCEocGVlcnMpIHsKICAgICAgICAgICAgICAgIFBlZXJBY3Rpb246OkRpc2Nvbm5lY3RCYW5uZWRJbmNvbWluZyB7IHBlZXJfaWQgfSA9PiB7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwZWVyX2lkLCBwZWVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF8gPT4gdW5yZWFjaGFibGUhKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBvbGxfZm4ofGN4fCB7CiAgICAgICAgICAgIGFzc2VydCEocGVlcnMucG9sbChjeCkuaXNfcGVuZGluZygpKTsKICAgICAgICAgICAgUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgfSkKICAgICAgICAuYXdhaXQ7CgogICAgICAgIGFzc2VydF9lcSEocGVlcnMuY29ubmVjdGlvbl9pbmZvLm51bV9pbmJvdW5kLCAwKTsKCiAgICAgICAgbGV0IG5ld19hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDMpKSwgODAwOCk7CgogICAgICAgIC8vIEFzc2VydCB3ZSBjYW4gc3RpbGwgYWNjZXB0IG5ldyBjb25uZWN0aW9ucwogICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKG5ld19hZGRyLmlwKCkpLmlzX29rKCkpOwogICAgICAgIGFzc2VydF9lcSEocGVlcnMuY29ubmVjdGlvbl9pbmZvLm51bV9wZW5kaW5nX2luLCAxKTsKCiAgICAgICAgLy8gdGhlIHRyaWdnZXJlZCBEaXNjb25uZWN0QmFubmVkSW5jb21pbmcgd2lsbCByZXN1bHQgaW4gZHJvcHBlZCBjb25uZWN0aW9ucywgYXNzZXJ0IHRoYXQKICAgICAgICAvLyBjb25uZWN0aW9uIGluZm8gaXMgdXBkYXRlZCB2aWEgdGhlIHBlZXIncyBzdGF0ZSB3aGljaCB3b3VsZCBiZSBhIG5vb3AgaGVyZSBzaW5jZSB0aGUKICAgICAgICAvLyBiYW5uZWQgcGVlcidzIHN0YXRlIGlzIGlkbGUKICAgICAgICBwZWVycy5vbl9hY3RpdmVfc2Vzc2lvbl9ncmFjZWZ1bGx5X2Nsb3NlZChwZWVyKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLmNvbm5lY3Rpb25faW5mby5udW1faW5ib3VuZCwgMCk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfYWRkX3BlbmRpbmdfY29ubmVjdCgpIHsKICAgICAgICBsZXQgcGVlciA9IFBlZXJJZDo6cmFuZG9tKCk7CiAgICAgICAgbGV0IHNvY2tldF9hZGRyID0gU29ja2V0QWRkcjo6bmV3KElwQWRkcjo6VjQoSXB2NEFkZHI6Om5ldygxMjcsIDAsIDEsIDIpKSwgODAwOCk7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6ZGVmYXVsdCgpOwogICAgICAgIHBlZXJzLmFkZF9hbmRfY29ubmVjdChwZWVyLCBQZWVyQWRkcjo6ZnJvbV90Y3Aoc29ja2V0X2FkZHIpLCBOb25lKTsKICAgICAgICBhc3NlcnRfZXEhKHBlZXJzLnBlZXJzLmdldCgmcGVlcikudW53cmFwKCkuc3RhdGUsIFBlZXJDb25uZWN0aW9uU3RhdGU6OlBlbmRpbmdPdXQpOwogICAgICAgIGFzc2VydF9lcSEocGVlcnMuY29ubmVjdGlvbl9pbmZvLm51bV9wZW5kaW5nX291dCwgMSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfZG5zX3VwZGF0ZXNfcGVlcl9hZGRyZXNzKCkgewogICAgICAgIGxldCBwZWVyX2lkID0gUGVlcklkOjpyYW5kb20oKTsKICAgICAgICBsZXQgaW5pdGlhbF9zb2NrZXQgPSBTb2NrZXRBZGRyOjpuZXcoIjEuMS4xLjEiLnBhcnNlOjo8SXBBZGRyPigpLnVud3JhcCgpLCA4MDA4KTsKICAgICAgICBsZXQgdXBkYXRlZF9pcCA9ICIyLjIuMi4yIi5wYXJzZTo6PElwQWRkcj4oKS51bndyYXAoKTsKCiAgICAgICAgbGV0IHRydXN0ZWQgPSBUcnVzdGVkUGVlciB7CiAgICAgICAgICAgIGhvc3Q6IHVybDo6SG9zdDo6SXB2NCgiMi4yLjIuMiIucGFyc2UoKS51bndyYXAoKSksCiAgICAgICAgICAgIHRjcF9wb3J0OiA4MDA4LAogICAgICAgICAgICB1ZHBfcG9ydDogODAwOCwKICAgICAgICAgICAgaWQ6IHBlZXJfaWQsCiAgICAgICAgfTsKCiAgICAgICAgbGV0IGNvbmZpZyA9IFBlZXJzQ29uZmlnOjp0ZXN0KCkud2l0aF90cnVzdGVkX25vZGVzKHZlYyFbdHJ1c3RlZC5jbG9uZSgpXSk7CiAgICAgICAgbGV0IG11dCBtYW5hZ2VyID0gUGVlcnNNYW5hZ2VyOjpuZXcoY29uZmlnKTsKICAgICAgICBtYW5hZ2VyCiAgICAgICAgICAgIC50cnVzdGVkX3BlZXJzX3Jlc29sdmVyCiAgICAgICAgICAgIC5zZXRfaW50ZXJ2YWwodG9raW86OnRpbWU6OmludGVydmFsKER1cmF0aW9uOjpmcm9tX21pbGxpcygxKSkpOwoKICAgICAgICBtYW5hZ2VyLnBlZXJzLmluc2VydCgKICAgICAgICAgICAgcGVlcl9pZCwKICAgICAgICAgICAgUGVlcjo6dHJ1c3RlZChQZWVyQWRkcjo6bmV3X3dpdGhfcG9ydHMoaW5pdGlhbF9zb2NrZXQuaXAoKSwgODAwOCwgU29tZSg4MDA4KSkpLAogICAgICAgICk7CgogICAgICAgIGZvciBfIGluIDAuLjEwMCB7CiAgICAgICAgICAgIGxldCBfID0gZXZlbnQhKG1hbmFnZXIpOwogICAgICAgICAgICBpZiBtYW5hZ2VyLnBlZXJzLmdldCgmcGVlcl9pZCkudW53cmFwKCkuYWRkci50Y3AoKS5pcCgpID09IHVwZGF0ZWRfaXAgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdG9raW86OnRpbWU6OnNsZWVwKER1cmF0aW9uOjpmcm9tX21pbGxpcygxMCkpLmF3YWl0OwogICAgICAgIH0KCiAgICAgICAgbGV0IHVwZGF0ZWRfcGVlciA9IG1hbmFnZXIucGVlcnMuZ2V0KCZwZWVyX2lkKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHVwZGF0ZWRfcGVlci5hZGRyLnRjcCgpLmlwKCksIHVwZGF0ZWRfaXApOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2lwX2ZpbHRlcl9ibG9ja3NfaW5ib3VuZF9jb25uZWN0aW9uKCkgewogICAgICAgIHVzZSByZXRoX25ldF9iYW5saXN0OjpJcEZpbHRlcjsKICAgICAgICB1c2Ugc3RkOjpuZXQ6OklwQWRkcjsKCiAgICAgICAgLy8gQ3JlYXRlIGEgZmlsdGVyIHRoYXQgb25seSBhbGxvd3MgMTkyLjE2OC4wLjAvMTYKICAgICAgICBsZXQgaXBfZmlsdGVyID0gSXBGaWx0ZXI6OmZyb21fY2lkcl9zdHJpbmcoIjE5Mi4xNjguMC4wLzE2IikudW53cmFwKCk7CiAgICAgICAgbGV0IGNvbmZpZyA9IFBlZXJzQ29uZmlnOjp0ZXN0KCkud2l0aF9pcF9maWx0ZXIoaXBfZmlsdGVyKTsKICAgICAgICBsZXQgbXV0IHBlZXJzID0gUGVlcnNNYW5hZ2VyOjpuZXcoY29uZmlnKTsKCiAgICAgICAgLy8gVHJ5IHRvIGNvbm5lY3QgZnJvbSBhbiBhbGxvd2VkIElQCiAgICAgICAgbGV0IGFsbG93ZWRfaXA6IElwQWRkciA9ICIxOTIuMTY4LjEuMTAwIi5wYXJzZSgpLnVud3JhcCgpOwogICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGFsbG93ZWRfaXApLmlzX29rKCkpOwoKICAgICAgICAvLyBUcnkgdG8gY29ubmVjdCBmcm9tIGEgZGlzYWxsb3dlZCBJUAogICAgICAgIGxldCBkaXNhbGxvd2VkX2lwOiBJcEFkZHIgPSAiMTAuMC4wLjEiLnBhcnNlKCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0IShwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oZGlzYWxsb3dlZF9pcCkuaXNfZXJyKCkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2lwX2ZpbHRlcl9ibG9ja3Nfb3V0Ym91bmRfY29ubmVjdGlvbigpIHsKICAgICAgICB1c2UgcmV0aF9uZXRfYmFubGlzdDo6SXBGaWx0ZXI7CiAgICAgICAgdXNlIHN0ZDo6bmV0OjpTb2NrZXRBZGRyOwoKICAgICAgICAvLyBDcmVhdGUgYSBmaWx0ZXIgdGhhdCBvbmx5IGFsbG93cyAxOTIuMTY4LjAuMC8xNgogICAgICAgIGxldCBpcF9maWx0ZXIgPSBJcEZpbHRlcjo6ZnJvbV9jaWRyX3N0cmluZygiMTkyLjE2OC4wLjAvMTYiKS51bndyYXAoKTsKICAgICAgICBsZXQgY29uZmlnID0gUGVlcnNDb25maWc6OnRlc3QoKS53aXRoX2lwX2ZpbHRlcihpcF9maWx0ZXIpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6Om5ldyhjb25maWcpOwoKICAgICAgICBsZXQgcGVlcl9pZCA9IFBlZXJJZDo6bmV3KFsxOyA2NF0pOwoKICAgICAgICAvLyBUcnkgdG8gYWRkIGEgcGVlciB3aXRoIGFuIGFsbG93ZWQgSVAKICAgICAgICBsZXQgYWxsb3dlZF9hZGRyOiBTb2NrZXRBZGRyID0gIjE5Mi4xNjguMS4xMDA6MzAzMDMiLnBhcnNlKCkudW53cmFwKCk7CiAgICAgICAgcGVlcnMuYWRkX3BlZXIocGVlcl9pZCwgUGVlckFkZHI6OmZyb21fdGNwKGFsbG93ZWRfYWRkciksIE5vbmUpOwogICAgICAgIGFzc2VydCEocGVlcnMucGVlcnMuY29udGFpbnNfa2V5KCZwZWVyX2lkKSk7CgogICAgICAgIC8vIFRyeSB0byBhZGQgYSBwZWVyIHdpdGggYSBkaXNhbGxvd2VkIElQCiAgICAgICAgbGV0IHBlZXJfaWQyID0gUGVlcklkOjpuZXcoWzI7IDY0XSk7CiAgICAgICAgbGV0IGRpc2FsbG93ZWRfYWRkcjogU29ja2V0QWRkciA9ICIxMC4wLjAuMTozMDMwMyIucGFyc2UoKS51bndyYXAoKTsKICAgICAgICBwZWVycy5hZGRfcGVlcihwZWVyX2lkMiwgUGVlckFkZHI6OmZyb21fdGNwKGRpc2FsbG93ZWRfYWRkciksIE5vbmUpOwogICAgICAgIGFzc2VydCEoIXBlZXJzLnBlZXJzLmNvbnRhaW5zX2tleSgmcGVlcl9pZDIpKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9pcF9maWx0ZXJfaXB2NigpIHsKICAgICAgICB1c2UgcmV0aF9uZXRfYmFubGlzdDo6SXBGaWx0ZXI7CiAgICAgICAgdXNlIHN0ZDo6bmV0OjpJcEFkZHI7CgogICAgICAgIC8vIENyZWF0ZSBhIGZpbHRlciB0aGF0IG9ubHkgYWxsb3dzIElQdjYgcmFuZ2UgMjAwMTpkYjg6Oi8zMgogICAgICAgIGxldCBpcF9maWx0ZXIgPSBJcEZpbHRlcjo6ZnJvbV9jaWRyX3N0cmluZygiMjAwMTpkYjg6Oi8zMiIpLnVud3JhcCgpOwogICAgICAgIGxldCBjb25maWcgPSBQZWVyc0NvbmZpZzo6dGVzdCgpLndpdGhfaXBfZmlsdGVyKGlwX2ZpbHRlcik7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6bmV3KGNvbmZpZyk7CgogICAgICAgIC8vIFRyeSB0byBjb25uZWN0IGZyb20gYW4gYWxsb3dlZCBJUHY2IGFkZHJlc3MKICAgICAgICBsZXQgYWxsb3dlZF9pcDogSXBBZGRyID0gIjIwMDE6ZGI4OjoxIi5wYXJzZSgpLnVud3JhcCgpOwogICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGFsbG93ZWRfaXApLmlzX29rKCkpOwoKICAgICAgICAvLyBUcnkgdG8gY29ubmVjdCBmcm9tIGEgZGlzYWxsb3dlZCBJUHY2IGFkZHJlc3MKICAgICAgICBsZXQgZGlzYWxsb3dlZF9pcDogSXBBZGRyID0gIjIwMDE6ZGI5OjoxIi5wYXJzZSgpLnVud3JhcCgpOwogICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGRpc2FsbG93ZWRfaXApLmlzX2VycigpKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9pcF9maWx0ZXJfbXVsdGlwbGVfcmFuZ2VzKCkgewogICAgICAgIHVzZSByZXRoX25ldF9iYW5saXN0OjpJcEZpbHRlcjsKICAgICAgICB1c2Ugc3RkOjpuZXQ6OklwQWRkcjsKCiAgICAgICAgLy8gQ3JlYXRlIGEgZmlsdGVyIHRoYXQgYWxsb3dzIG11bHRpcGxlIHJhbmdlcwogICAgICAgIGxldCBpcF9maWx0ZXIgPSBJcEZpbHRlcjo6ZnJvbV9jaWRyX3N0cmluZygiMTkyLjE2OC4wLjAvMTYsMTAuMC4wLjAvOCIpLnVud3JhcCgpOwogICAgICAgIGxldCBjb25maWcgPSBQZWVyc0NvbmZpZzo6dGVzdCgpLndpdGhfaXBfZmlsdGVyKGlwX2ZpbHRlcik7CiAgICAgICAgbGV0IG11dCBwZWVycyA9IFBlZXJzTWFuYWdlcjo6bmV3KGNvbmZpZyk7CgogICAgICAgIC8vIFRyeSBJUHMgZnJvbSBib3RoIGFsbG93ZWQgcmFuZ2VzCiAgICAgICAgbGV0IGlwMTogSXBBZGRyID0gIjE5Mi4xNjguMS4xIi5wYXJzZSgpLnVud3JhcCgpOwogICAgICAgIGxldCBpcDI6IElwQWRkciA9ICIxMC41LjEwLjIwIi5wYXJzZSgpLnVud3JhcCgpOwogICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGlwMSkuaXNfb2soKSk7CiAgICAgICAgYXNzZXJ0IShwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oaXAyKS5pc19vaygpKTsKCiAgICAgICAgLy8gVHJ5IElQIGZyb20gZGlzYWxsb3dlZCByYW5nZQogICAgICAgIGxldCBkaXNhbGxvd2VkX2lwOiBJcEFkZHIgPSAiMTcyLjE2LjAuMSIucGFyc2UoKS51bndyYXAoKTsKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihkaXNhbGxvd2VkX2lwKS5pc19lcnIoKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfaXBfZmlsdGVyX25vX3Jlc3RyaWN0aW9uKCkgewogICAgICAgIHVzZSByZXRoX25ldF9iYW5saXN0OjpJcEZpbHRlcjsKICAgICAgICB1c2Ugc3RkOjpuZXQ6OklwQWRkcjsKCiAgICAgICAgLy8gQ3JlYXRlIGEgZmlsdGVyIHdpdGggbm8gcmVzdHJpY3Rpb25zIChhbGxvdyBhbGwpCiAgICAgICAgbGV0IGlwX2ZpbHRlciA9IElwRmlsdGVyOjphbGxvd19hbGwoKTsKICAgICAgICBsZXQgY29uZmlnID0gUGVlcnNDb25maWc6OnRlc3QoKS53aXRoX2lwX2ZpbHRlcihpcF9maWx0ZXIpOwogICAgICAgIGxldCBtdXQgcGVlcnMgPSBQZWVyc01hbmFnZXI6Om5ldyhjb25maWcpOwoKICAgICAgICAvLyBBbGwgSVBzIHNob3VsZCBiZSBhbGxvd2VkCiAgICAgICAgbGV0IGlwMTogSXBBZGRyID0gIjE5Mi4xNjguMS4xIi5wYXJzZSgpLnVud3JhcCgpOwogICAgICAgIGxldCBpcDI6IElwQWRkciA9ICIxMC4wLjAuMSIucGFyc2UoKS51bndyYXAoKTsKICAgICAgICBsZXQgaXAzOiBJcEFkZHIgPSAiOC44LjguOCIucGFyc2UoKS51bndyYXAoKTsKICAgICAgICBhc3NlcnQhKHBlZXJzLm9uX2luY29taW5nX3BlbmRpbmdfc2Vzc2lvbihpcDEpLmlzX29rKCkpOwogICAgICAgIGFzc2VydCEocGVlcnMub25faW5jb21pbmdfcGVuZGluZ19zZXNzaW9uKGlwMikuaXNfb2soKSk7CiAgICAgICAgYXNzZXJ0IShwZWVycy5vbl9pbmNvbWluZ19wZW5kaW5nX3Nlc3Npb24oaXAzKS5pc19vaygpKTsKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L25ldHdvcmstdHlwZXMvc3JjL3BlZXJzL2FkZHIucnMiPgovLyEgYFJMUHhgIChUQ1ApIGFuZCBgRGlzY292ZXJ5YCAoVURQKSBzb2NrZXRzIG9mIGEgcGVlci4KCnVzZSBzdGQ6Om5ldDo6e0lwQWRkciwgU29ja2V0QWRkcn07CgovLy8gUmVwcmVzZW50cyBhIHBlZXIncyBhZGRyZXNzIGluZm9ybWF0aW9uLgovLy8KLy8vICMgRmllbGRzCi8vLwovLy8gLSBgdGNwYDogQSBgU29ja2V0QWRkcmAgcmVwcmVzZW50aW5nIHRoZSBwZWVyJ3MgZGF0YSB0cmFuc2ZlciBhZGRyZXNzLgovLy8gLSBgdWRwYDogQW4gb3B0aW9uYWwgYFNvY2tldEFkZHJgIHJlcHJlc2VudGluZyB0aGUgcGVlcidzIGRpc2NvdmVyIGFkZHJlc3MuIGBOb25lYCBpZiB0aGUgcGVlcgovLy8gICBpcyBkaXJlY3RseSBjb25uZWN0aW5nIHRvIHVzIG9yIHRoZSBwb3J0IGlzIHRoZSBzYW1lIHRvIGB0Y3BgJ3MKI1tkZXJpdmUoRGVidWcsIENvcHksIENsb25lLCBQYXJ0aWFsRXEsIEVxKV0KcHViIHN0cnVjdCBQZWVyQWRkciB7CiAgICB0Y3A6IFNvY2tldEFkZHIsCiAgICB1ZHA6IE9wdGlvbjxTb2NrZXRBZGRyPiwKfQoKaW1wbCBQZWVyQWRkciB7CiAgICAvLy8gUmV0dXJucyB0aGUgcGVlcidzIFRDUCBhZGRyZXNzLgogICAgcHViIGNvbnN0IGZuIHRjcCgmc2VsZikgLT4gU29ja2V0QWRkciB7CiAgICAgICAgc2VsZi50Y3AKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgcGVlcidzIFVEUCBhZGRyZXNzLgogICAgcHViIGNvbnN0IGZuIHVkcCgmc2VsZikgLT4gT3B0aW9uPFNvY2tldEFkZHI+IHsKICAgICAgICBzZWxmLnVkcAogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgbmV3IGBQZWVyQWRkcmAgd2l0aCB0aGUgZ2l2ZW4gYHRjcGAgYW5kIGB1ZHBgIGFkZHJlc3Nlcy4KICAgIHB1YiBjb25zdCBmbiBuZXcodGNwOiBTb2NrZXRBZGRyLCB1ZHA6IE9wdGlvbjxTb2NrZXRBZGRyPikgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IHRjcCwgdWRwIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyBhIG5ldyBgUGVlckFkZHJgIHdpdGggYSBgdGNwYCBhZGRyZXNzIG9ubHkuCiAgICBwdWIgY29uc3QgZm4gZnJvbV90Y3AodGNwOiBTb2NrZXRBZGRyKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgdGNwLCB1ZHA6IE5vbmUgfQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgbmV3IGBQZWVyQWRkcmAgd2l0aCB0aGUgZ2l2ZW4gYHRjcGAgYW5kIGB1ZHBgIHBvcnRzLgogICAgcHViIGZuIG5ld193aXRoX3BvcnRzKGlwOiBJcEFkZHIsIHRjcF9wb3J0OiB1MTYsIHVkcF9wb3J0OiBPcHRpb248dTE2PikgLT4gU2VsZiB7CiAgICAgICAgbGV0IHRjcCA9IFNvY2tldEFkZHI6Om5ldyhpcCwgdGNwX3BvcnQpOwogICAgICAgIGxldCB1ZHAgPSB1ZHBfcG9ydC5tYXAofHBvcnR8IFNvY2tldEFkZHI6Om5ldyhpcCwgcG9ydCkpOwogICAgICAgIFNlbGY6Om5ldyh0Y3AsIHVkcCkKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L25ldHdvcmstdHlwZXMvc3JjL3BlZXJzL2NvbmZpZy5ycyI+Ci8vISBDb25maWd1cmF0aW9uIGZvciBwZWVyaW5nLgoKdXNlIHN0ZDo6ewogICAgY29sbGVjdGlvbnM6Okhhc2hTZXQsCiAgICBpbzo6e3NlbGYsIEVycm9yS2luZH0sCiAgICBwYXRoOjpQYXRoLAogICAgdGltZTo6RHVyYXRpb24sCn07Cgp1c2UgcmV0aF9uZXRfYmFubGlzdDo6e0Jhbkxpc3QsIElwRmlsdGVyfTsKdXNlIHJldGhfbmV0d29ya19wZWVyczo6e05vZGVSZWNvcmQsIFRydXN0ZWRQZWVyfTsKdXNlIHRyYWNpbmc6OmluZm87Cgp1c2UgY3JhdGU6OntCYWNrb2ZmS2luZCwgUmVwdXRhdGlvbkNoYW5nZVdlaWdodHN9OwoKLy8vIE1heGltdW0gbnVtYmVyIG9mIGF2YWlsYWJsZSBzbG90cyBmb3Igb3V0Ym91bmQgc2Vzc2lvbnMuCnB1YiBjb25zdCBERUZBVUxUX01BWF9DT1VOVF9QRUVSU19PVVRCT1VORDogdTMyID0gMTAwOwoKLy8vIE1heGltdW0gbnVtYmVyIG9mIGF2YWlsYWJsZSBzbG90cyBmb3IgaW5ib3VuZCBzZXNzaW9ucy4KcHViIGNvbnN0IERFRkFVTFRfTUFYX0NPVU5UX1BFRVJTX0lOQk9VTkQ6IHUzMiA9IDMwOwoKLy8vIE1heGltdW0gbnVtYmVyIG9mIGF2YWlsYWJsZSBzbG90cyBmb3IgY29uY3VycmVudCBvdXRnb2luZyBkaWFscy4KLy8vCi8vLyBUaGlzIHJlc3RyaWN0cyBob3cgbWFueSBvdXRib3VuZCBkaWFscyBjYW4gYmUgcGVyZm9ybWVkIGNvbmN1cnJlbnRseS4KcHViIGNvbnN0IERFRkFVTFRfTUFYX0NPVU5UX0NPTkNVUlJFTlRfT1VUQk9VTkRfRElBTFM6IHVzaXplID0gMTU7CgovLy8gQSB0ZW1wb3JhcnkgdGltZW91dCBmb3IgaXBzIG9uIGluY29taW5nIGNvbm5lY3Rpb24gYXR0ZW1wdHMuCnB1YiBjb25zdCBJTkJPVU5EX0lQX1RIUk9UVExFX0RVUkFUSU9OOiBEdXJhdGlvbiA9IER1cmF0aW9uOjpmcm9tX3NlY3MoMzApOwoKLy8vIFRoZSBkdXJhdGlvbnMgdG8gdXNlIHdoZW4gYSBiYWNrb2ZmIHNob3VsZCBiZSBhcHBsaWVkIHRvIGEgcGVlci4KLy8vCi8vLyBTZWUgYWxzbyBbYEJhY2tvZmZLaW5kYF0uCiNbZGVyaXZlKERlYnVnLCBDbG9uZSwgQ29weSwgUGFydGlhbEVxLCBFcSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpKV0KcHViIHN0cnVjdCBQZWVyQmFja29mZkR1cmF0aW9ucyB7CiAgICAvLy8gQXBwbGllcyB0byBjb25uZWN0aW9uIHByb2JsZW1zIHdoZXJlIHRoZXJlIGlzIGEgY2hhbmNlIHRoYXQgdGhleSB3aWxsIGJlIHJlc29sdmVkIGFmdGVyIHRoZQogICAgLy8vIHNob3J0IGR1cmF0aW9uLgogICAgI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgc2VyZGUod2l0aCA9ICJodW1hbnRpbWVfc2VyZGUiKSldCiAgICBwdWIgbG93OiBEdXJhdGlvbiwKICAgIC8vLyBBcHBsaWVzIHRvIG1vcmUgc2V2ZXJlIGNvbm5lY3Rpb24gcHJvYmxlbXMgd2hlcmUgdGhlcmUgaXMgYSBsb3dlciBjaGFuY2UgdGhhdCB0aGV5IHdpbGwgYmUKICAgIC8vLyByZXNvbHZlZC4KICAgICNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKHdpdGggPSAiaHVtYW50aW1lX3NlcmRlIikpXQogICAgcHViIG1lZGl1bTogRHVyYXRpb24sCiAgICAvLy8gSW50ZW5kZWQgZm9yIHNwYW1tZXJzLCBvciBiYWQgcGVlcnMgaW4gZ2VuZXJhbC4KICAgICNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKHdpdGggPSAiaHVtYW50aW1lX3NlcmRlIikpXQogICAgcHViIGhpZ2g6IER1cmF0aW9uLAogICAgLy8vIE1heGltdW0gdG90YWwgYmFja29mZiBkdXJhdGlvbi4KICAgICNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKHdpdGggPSAiaHVtYW50aW1lX3NlcmRlIikpXQogICAgcHViIG1heDogRHVyYXRpb24sCn0KCmltcGwgUGVlckJhY2tvZmZEdXJhdGlvbnMgewogICAgLy8vIFJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgW2BEdXJhdGlvbmBdCiAgICBwdWIgY29uc3QgZm4gYmFja29mZigmc2VsZiwga2luZDogQmFja29mZktpbmQpIC0+IER1cmF0aW9uIHsKICAgICAgICBtYXRjaCBraW5kIHsKICAgICAgICAgICAgQmFja29mZktpbmQ6OkxvdyA9PiBzZWxmLmxvdywKICAgICAgICAgICAgQmFja29mZktpbmQ6Ok1lZGl1bSA9PiBzZWxmLm1lZGl1bSwKICAgICAgICAgICAgQmFja29mZktpbmQ6OkhpZ2ggPT4gc2VsZi5oaWdoLAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgdGltZXN0YW1wIHVudGlsIHdoaWNoIHdlIHNob3VsZCBiYWNrb2ZmLgogICAgLy8vCiAgICAvLy8gVGhlIEJhY2tvZmYgZHVyYXRpb24gaXMgY2FwcGVkIGJ5IHRoZSBjb25maWd1cmVkIG1heGltdW0gYmFja29mZiBkdXJhdGlvbi4KICAgIHB1YiBmbiBiYWNrb2ZmX3VudGlsKCZzZWxmLCBraW5kOiBCYWNrb2ZmS2luZCwgYmFja29mZl9jb3VudGVyOiB1OCkgLT4gc3RkOjp0aW1lOjpJbnN0YW50IHsKICAgICAgICBsZXQgYmFja29mZl90aW1lID0gc2VsZi5iYWNrb2ZmKGtpbmQpOwogICAgICAgIGxldCBiYWNrb2ZmX3RpbWUgPSBiYWNrb2ZmX3RpbWUgKyBiYWNrb2ZmX3RpbWUgKiBiYWNrb2ZmX2NvdW50ZXIgYXMgdTMyOwogICAgICAgIGxldCBub3cgPSBzdGQ6OnRpbWU6Okluc3RhbnQ6Om5vdygpOwogICAgICAgIG5vdyArIGJhY2tvZmZfdGltZS5taW4oc2VsZi5tYXgpCiAgICB9CgogICAgLy8vIFJldHVybnMgZHVyYXRpb25zIGZvciB0ZXN0aW5nLgogICAgI1tjZmcoYW55KHRlc3QsIGZlYXR1cmUgPSAidGVzdC11dGlscyIpKV0KICAgIHB1YiBjb25zdCBmbiB0ZXN0KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIGxvdzogRHVyYXRpb246OmZyb21fbWlsbGlzKDIwMCksCiAgICAgICAgICAgIG1lZGl1bTogRHVyYXRpb246OmZyb21fbWlsbGlzKDIwMCksCiAgICAgICAgICAgIGhpZ2g6IER1cmF0aW9uOjpmcm9tX21pbGxpcygyMDApLAogICAgICAgICAgICBtYXg6IER1cmF0aW9uOjpmcm9tX21pbGxpcygyMDApLAogICAgICAgIH0KICAgIH0KfQoKaW1wbCBEZWZhdWx0IGZvciBQZWVyQmFja29mZkR1cmF0aW9ucyB7CiAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIGxvdzogRHVyYXRpb246OmZyb21fc2VjcygzMCksCiAgICAgICAgICAgIC8vIDNtaW4KICAgICAgICAgICAgbWVkaXVtOiBEdXJhdGlvbjo6ZnJvbV9zZWNzKDYwICogMyksCiAgICAgICAgICAgIC8vIDE1bWluCiAgICAgICAgICAgIGhpZ2g6IER1cmF0aW9uOjpmcm9tX3NlY3MoNjAgKiAxNSksCiAgICAgICAgICAgIC8vIDFoCiAgICAgICAgICAgIG1heDogRHVyYXRpb246OmZyb21fc2Vjcyg2MCAqIDYwKSwKICAgICAgICB9CiAgICB9Cn0KCi8vLyBUcmFja3Mgc3RhdHMgYWJvdXQgY29ubmVjdGVkIG5vZGVzCiNbZGVyaXZlKERlYnVnLCBDbG9uZSwgUGFydGlhbEVxLCBFcSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpLCBzZXJkZShkZWZhdWx0KSldCnB1YiBzdHJ1Y3QgQ29ubmVjdGlvbnNDb25maWcgewogICAgLy8vIE1heGltdW0gYWxsb3dlZCBvdXRib3VuZCBjb25uZWN0aW9ucy4KICAgIHB1YiBtYXhfb3V0Ym91bmQ6IHVzaXplLAogICAgLy8vIE1heGltdW0gYWxsb3dlZCBpbmJvdW5kIGNvbm5lY3Rpb25zLgogICAgcHViIG1heF9pbmJvdW5kOiB1c2l6ZSwKICAgIC8vLyBNYXhpbXVtIGFsbG93ZWQgY29uY3VycmVudCBvdXRib3VuZCBkaWFscy4KICAgICNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKGRlZmF1bHQpKV0KICAgIHB1YiBtYXhfY29uY3VycmVudF9vdXRib3VuZF9kaWFsczogdXNpemUsCn0KCmltcGwgRGVmYXVsdCBmb3IgQ29ubmVjdGlvbnNDb25maWcgewogICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgIFNlbGYgewogICAgICAgICAgICBtYXhfb3V0Ym91bmQ6IERFRkFVTFRfTUFYX0NPVU5UX1BFRVJTX09VVEJPVU5EIGFzIHVzaXplLAogICAgICAgICAgICBtYXhfaW5ib3VuZDogREVGQVVMVF9NQVhfQ09VTlRfUEVFUlNfSU5CT1VORCBhcyB1c2l6ZSwKICAgICAgICAgICAgbWF4X2NvbmN1cnJlbnRfb3V0Ym91bmRfZGlhbHM6IERFRkFVTFRfTUFYX0NPVU5UX0NPTkNVUlJFTlRfT1VUQk9VTkRfRElBTFMsCiAgICAgICAgfQogICAgfQp9CgovLy8gQ29uZmlnIHR5cGUgZm9yIGluaXRpYXRpbmcgYSBgUGVlcnNNYW5hZ2VyYCBpbnN0YW5jZS4KI1tkZXJpdmUoRGVidWcsIENsb25lLCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgZGVyaXZlKHNlcmRlOjpTZXJpYWxpemUsIHNlcmRlOjpEZXNlcmlhbGl6ZSkpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZShkZWZhdWx0KSldCnB1YiBzdHJ1Y3QgUGVlcnNDb25maWcgewogICAgLy8vIEhvdyBvZnRlbiB0byByZWNoZWNrIGZyZWUgc2xvdHMgZm9yIG91dGJvdW5kIGNvbm5lY3Rpb25zLgogICAgI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgc2VyZGUod2l0aCA9ICJodW1hbnRpbWVfc2VyZGUiKSldCiAgICBwdWIgcmVmaWxsX3Nsb3RzX2ludGVydmFsOiBEdXJhdGlvbiwKICAgIC8vLyBUcnVzdGVkIG5vZGVzIHRvIGNvbm5lY3QgdG8gb3IgYWNjZXB0IGZyb20KICAgIHB1YiB0cnVzdGVkX25vZGVzOiBWZWM8VHJ1c3RlZFBlZXI+LAogICAgLy8vIENvbm5lY3QgdG8gb3IgYWNjZXB0IGZyb20gdHJ1c3RlZCBub2RlcyBvbmx5PwogICAgI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgc2VyZGUoYWxpYXMgPSAiY29ubmVjdF90cnVzdGVkX25vZGVzX29ubHkiKSldCiAgICBwdWIgdHJ1c3RlZF9ub2Rlc19vbmx5OiBib29sLAogICAgLy8vIEludGVydmFsIHRvIHVwZGF0ZSB0cnVzdGVkIG5vZGVzIEROUyByZXNvbHV0aW9uCiAgICAjW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZSh3aXRoID0gImh1bWFudGltZV9zZXJkZSIpKV0KICAgIHB1YiB0cnVzdGVkX25vZGVzX3Jlc29sdXRpb25faW50ZXJ2YWw6IER1cmF0aW9uLAogICAgLy8vIE1heGltdW0gbnVtYmVyIG9mIGJhY2tvZmYgYXR0ZW1wdHMgYmVmb3JlIHdlIGdpdmUgdXAgb24gYSBwZWVyIGFuZCBkcm9wcGluZy4KICAgIC8vLwogICAgLy8vIFRoZSBtYXggdGltZSBzcGVudCBvZiBhIHBlZXIgYmVmb3JlIGl0J3MgcmVtb3ZlZCBmcm9tIHRoZSBzZXQgaXMgZGV0ZXJtaW5lZCBieSB0aGUKICAgIC8vLyBjb25maWd1cmVkIGJhY2tvZmYgZHVyYXRpb24gYW5kIHRoZSBtYXggYmFja29mZiBjb3VudC4KICAgIC8vLwogICAgLy8vIFdpdGggYSBiYWNrb2ZmIGNvdW50ZXIgb2YgNSBhbmQgYSBiYWNrb2ZmIGR1cmF0aW9uIG9mIDFoLCB0aGUgbWluaW11bSB0aW1lIHNwZW50IG9mIHRoZQogICAgLy8vIHBlZXIgaW4gdGhlIHRhYmxlIGlzIHRoZSBzdW0gb2YgYWxsIGJhY2tvZmZzICgxaCArIDJoICsgM2ggKyA0aCArIDVoID0gMTVoKS4KICAgIC8vLwogICAgLy8vIE5vdGU6IHRoaXMgZG9lcyBub3QgYXBwbHkgdG8gdHJ1c3RlZCBwZWVycy4KICAgIHB1YiBtYXhfYmFja29mZl9jb3VudDogdTgsCiAgICAvLy8gQmFzaWMgbm9kZXMgdG8gY29ubmVjdCB0by4KICAgICNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKHNraXApKV0KICAgIHB1YiBiYXNpY19ub2RlczogSGFzaFNldDxOb2RlUmVjb3JkPiwKICAgIC8vLyBIb3cgbG9uZyB0byBiYW4gYmFkIHBlZXJzLgogICAgI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgc2VyZGUod2l0aCA9ICJodW1hbnRpbWVfc2VyZGUiKSldCiAgICBwdWIgYmFuX2R1cmF0aW9uOiBEdXJhdGlvbiwKICAgIC8vLyBSZXN0cmljdGlvbnMgb24gYFBlZXJJZHNgIGFuZCBJcHMuCiAgICAjW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZShza2lwKSldCiAgICBwdWIgYmFuX2xpc3Q6IEJhbkxpc3QsCiAgICAvLy8gUmVzdHJpY3Rpb25zIG9uIGNvbm5lY3Rpb25zLgogICAgcHViIGNvbm5lY3Rpb25faW5mbzogQ29ubmVjdGlvbnNDb25maWcsCiAgICAvLy8gSG93IHRvIHdlaWdoIHJlcHV0YXRpb24gY2hhbmdlcy4KICAgIHB1YiByZXB1dGF0aW9uX3dlaWdodHM6IFJlcHV0YXRpb25DaGFuZ2VXZWlnaHRzLAogICAgLy8vIEhvdyBsb25nIHRvIGJhY2tvZmYgcGVlcnMgdGhhdCB3ZSBhcmUgZmFpbGVkIHRvIGNvbm5lY3QgdG8gZm9yIG5vbi1mYXRhbCByZWFzb25zLgogICAgLy8vCiAgICAvLy8gVGhlIGJhY2tvZmYgZHVyYXRpb24gaW5jcmVhc2VzIHdpdGggbnVtYmVyIG9mIGJhY2tvZmYgYXR0ZW1wdHMuCiAgICBwdWIgYmFja29mZl9kdXJhdGlvbnM6IFBlZXJCYWNrb2ZmRHVyYXRpb25zLAogICAgLy8vIEhvdyBsb25nIHRvIHRlbXBvcmFyaWx5IGJhbiBpcHMgb24gaW5jb21pbmcgY29ubmVjdGlvbiBhdHRlbXB0cy4KICAgIC8vLwogICAgLy8vIFRoaXMgYWN0cyBhcyBhbiBJUCBiYXNlZCByYXRlIGxpbWl0LgogICAgI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgc2VyZGUoZGVmYXVsdCwgd2l0aCA9ICJodW1hbnRpbWVfc2VyZGUiKSldCiAgICBwdWIgaW5jb21pbmdfaXBfdGhyb3R0bGVfZHVyYXRpb246IER1cmF0aW9uLAogICAgLy8vIElQIGFkZHJlc3MgZmlsdGVyIGZvciByZXN0cmljdGluZyBuZXR3b3JrIGNvbm5lY3Rpb25zIHRvIHNwZWNpZmljIElQIHJhbmdlcy4KICAgIC8vLwogICAgLy8vIFNpbWlsYXIgdG8gZ2V0aCdzIC0tbmV0cmVzdHJpY3QgZmxhZy4gSWYgY29uZmlndXJlZCwgb25seSBjb25uZWN0aW9ucyB0by9mcm9tCiAgICAvLy8gSVBzIHdpdGhpbiB0aGUgc3BlY2lmaWVkIENJRFIgcmFuZ2VzIHdpbGwgYmUgYWxsb3dlZC4KICAgICNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKHNraXApKV0KICAgIHB1YiBpcF9maWx0ZXI6IElwRmlsdGVyLAp9CgppbXBsIERlZmF1bHQgZm9yIFBlZXJzQ29uZmlnIHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgcmVmaWxsX3Nsb3RzX2ludGVydmFsOiBEdXJhdGlvbjo6ZnJvbV9taWxsaXMoNV8wMDApLAogICAgICAgICAgICBjb25uZWN0aW9uX2luZm86IERlZmF1bHQ6OmRlZmF1bHQoKSwKICAgICAgICAgICAgcmVwdXRhdGlvbl93ZWlnaHRzOiBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIGJhbl9saXN0OiBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIC8vIEJhbiBwZWVycyBmb3IgMTJoCiAgICAgICAgICAgIGJhbl9kdXJhdGlvbjogRHVyYXRpb246OmZyb21fc2Vjcyg2MCAqIDYwICogMTIpLAogICAgICAgICAgICBiYWNrb2ZmX2R1cmF0aW9uczogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICB0cnVzdGVkX25vZGVzOiBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIHRydXN0ZWRfbm9kZXNfb25seTogZmFsc2UsCiAgICAgICAgICAgIHRydXN0ZWRfbm9kZXNfcmVzb2x1dGlvbl9pbnRlcnZhbDogRHVyYXRpb246OmZyb21fc2Vjcyg2MCAqIDYwKSwKICAgICAgICAgICAgYmFzaWNfbm9kZXM6IERlZmF1bHQ6OmRlZmF1bHQoKSwKICAgICAgICAgICAgbWF4X2JhY2tvZmZfY291bnQ6IDUsCiAgICAgICAgICAgIGluY29taW5nX2lwX3Rocm90dGxlX2R1cmF0aW9uOiBJTkJPVU5EX0lQX1RIUk9UVExFX0RVUkFUSU9OLAogICAgICAgICAgICBpcF9maWx0ZXI6IElwRmlsdGVyOjpkZWZhdWx0KCksCiAgICAgICAgfQogICAgfQp9CgppbXBsIFBlZXJzQ29uZmlnIHsKICAgIC8vLyBBIHNldCBvZiBgcGVlcl9pZHNgIGFuZCBpcCBhZGRyIHRoYXQgd2Ugd2FudCB0byBuZXZlciBjb25uZWN0IHRvCiAgICBwdWIgZm4gd2l0aF9iYW5fbGlzdChtdXQgc2VsZiwgYmFuX2xpc3Q6IEJhbkxpc3QpIC0+IFNlbGYgewogICAgICAgIHNlbGYuYmFuX2xpc3QgPSBiYW5fbGlzdDsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIENvbmZpZ3VyZSBob3cgbG9uZyB0byBiYW4gYmFkIHBlZXJzCiAgICBwdWIgY29uc3QgZm4gd2l0aF9iYW5fZHVyYXRpb24obXV0IHNlbGYsIGJhbl9kdXJhdGlvbjogRHVyYXRpb24pIC0+IFNlbGYgewogICAgICAgIHNlbGYuYmFuX2R1cmF0aW9uID0gYmFuX2R1cmF0aW9uOwogICAgICAgIHNlbGYKICAgIH0KCiAgICAvLy8gQ29uZmlndXJlIGhvdyBsb25nIHRvIHJlZmlsbCBvdXRib3VuZCBzbG90cwogICAgcHViIGNvbnN0IGZuIHdpdGhfcmVmaWxsX3Nsb3RzX2ludGVydmFsKG11dCBzZWxmLCBpbnRlcnZhbDogRHVyYXRpb24pIC0+IFNlbGYgewogICAgICAgIHNlbGYucmVmaWxsX3Nsb3RzX2ludGVydmFsID0gaW50ZXJ2YWw7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBNYXhpbXVtIGFsbG93ZWQgb3V0Ym91bmQgY29ubmVjdGlvbnMuCiAgICBwdWIgY29uc3QgZm4gd2l0aF9tYXhfb3V0Ym91bmQobXV0IHNlbGYsIG1heF9vdXRib3VuZDogdXNpemUpIC0+IFNlbGYgewogICAgICAgIHNlbGYuY29ubmVjdGlvbl9pbmZvLm1heF9vdXRib3VuZCA9IG1heF9vdXRib3VuZDsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIE1heGltdW0gYWxsb3dlZCBpbmJvdW5kIGNvbm5lY3Rpb25zIHdpdGggb3B0aW9uYWwgdXBkYXRlLgogICAgcHViIGNvbnN0IGZuIHdpdGhfbWF4X2luYm91bmRfb3B0KG11dCBzZWxmLCBtYXhfaW5ib3VuZDogT3B0aW9uPHVzaXplPikgLT4gU2VsZiB7CiAgICAgICAgaWYgbGV0IFNvbWUobWF4X2luYm91bmQpID0gbWF4X2luYm91bmQgewogICAgICAgICAgICBzZWxmLmNvbm5lY3Rpb25faW5mby5tYXhfaW5ib3VuZCA9IG1heF9pbmJvdW5kOwogICAgICAgIH0KICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIE1heGltdW0gYWxsb3dlZCBvdXRib3VuZCBjb25uZWN0aW9ucyB3aXRoIG9wdGlvbmFsIHVwZGF0ZS4KICAgIHB1YiBjb25zdCBmbiB3aXRoX21heF9vdXRib3VuZF9vcHQobXV0IHNlbGYsIG1heF9vdXRib3VuZDogT3B0aW9uPHVzaXplPikgLT4gU2VsZiB7CiAgICAgICAgaWYgbGV0IFNvbWUobWF4X291dGJvdW5kKSA9IG1heF9vdXRib3VuZCB7CiAgICAgICAgICAgIHNlbGYuY29ubmVjdGlvbl9pbmZvLm1heF9vdXRib3VuZCA9IG1heF9vdXRib3VuZDsKICAgICAgICB9CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBNYXhpbXVtIGFsbG93ZWQgaW5ib3VuZCBjb25uZWN0aW9ucy4KICAgIHB1YiBjb25zdCBmbiB3aXRoX21heF9pbmJvdW5kKG11dCBzZWxmLCBtYXhfaW5ib3VuZDogdXNpemUpIC0+IFNlbGYgewogICAgICAgIHNlbGYuY29ubmVjdGlvbl9pbmZvLm1heF9pbmJvdW5kID0gbWF4X2luYm91bmQ7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBNYXhpbXVtIGFsbG93ZWQgY29uY3VycmVudCBvdXRib3VuZCBkaWFscy4KICAgIHB1YiBjb25zdCBmbiB3aXRoX21heF9jb25jdXJyZW50X2RpYWxzKG11dCBzZWxmLCBtYXhfY29uY3VycmVudF9vdXRib3VuZF9kaWFsczogdXNpemUpIC0+IFNlbGYgewogICAgICAgIHNlbGYuY29ubmVjdGlvbl9pbmZvLm1heF9jb25jdXJyZW50X291dGJvdW5kX2RpYWxzID0gbWF4X2NvbmN1cnJlbnRfb3V0Ym91bmRfZGlhbHM7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBOb2RlcyB0byBhbHdheXMgY29ubmVjdCB0by4KICAgIHB1YiBmbiB3aXRoX3RydXN0ZWRfbm9kZXMobXV0IHNlbGYsIG5vZGVzOiBWZWM8VHJ1c3RlZFBlZXI+KSAtPiBTZWxmIHsKICAgICAgICBzZWxmLnRydXN0ZWRfbm9kZXMgPSBub2RlczsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIENvbm5lY3Qgb25seSB0byB0cnVzdGVkIG5vZGVzLgogICAgcHViIGNvbnN0IGZuIHdpdGhfdHJ1c3RlZF9ub2Rlc19vbmx5KG11dCBzZWxmLCB0cnVzdGVkX29ubHk6IGJvb2wpIC0+IFNlbGYgewogICAgICAgIHNlbGYudHJ1c3RlZF9ub2Rlc19vbmx5ID0gdHJ1c3RlZF9vbmx5OwogICAgICAgIHNlbGYKICAgIH0KCiAgICAvLy8gTm9kZXMgYXZhaWxhYmxlIGF0IGxhdW5jaC4KICAgIHB1YiBmbiB3aXRoX2Jhc2ljX25vZGVzKG11dCBzZWxmLCBub2RlczogSGFzaFNldDxOb2RlUmVjb3JkPikgLT4gU2VsZiB7CiAgICAgICAgc2VsZi5iYXNpY19ub2RlcyA9IG5vZGVzOwogICAgICAgIHNlbGYKICAgIH0KCiAgICAvLy8gQ29uZmlndXJlcyB0aGUgbWF4IGFsbG93ZWQgYmFja29mZiBjb3VudC4KICAgIHB1YiBjb25zdCBmbiB3aXRoX21heF9iYWNrb2ZmX2NvdW50KG11dCBzZWxmLCBtYXhfYmFja29mZl9jb3VudDogdTgpIC0+IFNlbGYgewogICAgICAgIHNlbGYubWF4X2JhY2tvZmZfY291bnQgPSBtYXhfYmFja29mZl9jb3VudDsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIENvbmZpZ3VyZXMgaG93IHRvIHdlaWdoIHJlcHV0YXRpb24gY2hhbmdlcy4KICAgIHB1YiBjb25zdCBmbiB3aXRoX3JlcHV0YXRpb25fd2VpZ2h0cygKICAgICAgICBtdXQgc2VsZiwKICAgICAgICByZXB1dGF0aW9uX3dlaWdodHM6IFJlcHV0YXRpb25DaGFuZ2VXZWlnaHRzLAogICAgKSAtPiBTZWxmIHsKICAgICAgICBzZWxmLnJlcHV0YXRpb25fd2VpZ2h0cyA9IHJlcHV0YXRpb25fd2VpZ2h0czsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIENvbmZpZ3VyZXMgaG93IGxvbmcgdG8gYmFja29mZiBwZWVycyB0aGF0IGFyZSB3ZSBmYWlsZWQgdG8gY29ubmVjdCB0byBmb3Igbm9uLWZhdGFsIHJlYXNvbnMKICAgIHB1YiBjb25zdCBmbiB3aXRoX2JhY2tvZmZfZHVyYXRpb25zKG11dCBzZWxmLCBiYWNrb2ZmX2R1cmF0aW9uczogUGVlckJhY2tvZmZEdXJhdGlvbnMpIC0+IFNlbGYgewogICAgICAgIHNlbGYuYmFja29mZl9kdXJhdGlvbnMgPSBiYWNrb2ZmX2R1cmF0aW9uczsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIG1heGltdW0gbnVtYmVyIG9mIHBlZXJzLCBpbmJvdW5kIGFuZCBvdXRib3VuZC4KICAgIHB1YiBjb25zdCBmbiBtYXhfcGVlcnMoJnNlbGYpIC0+IHVzaXplIHsKICAgICAgICBzZWxmLmNvbm5lY3Rpb25faW5mby5tYXhfb3V0Ym91bmQgKyBzZWxmLmNvbm5lY3Rpb25faW5mby5tYXhfaW5ib3VuZAogICAgfQoKICAgIC8vLyBSZWFkIGZyb20gZmlsZSBub2RlcyBhdmFpbGFibGUgYXQgbGF1bmNoLiBJZ25vcmVkIGlmIE5vbmUuCiAgICBwdWIgZm4gd2l0aF9iYXNpY19ub2Rlc19mcm9tX2ZpbGUoCiAgICAgICAgc2VsZiwKICAgICAgICBvcHRpb25hbF9maWxlOiBPcHRpb248aW1wbCBBc1JlZjxQYXRoPj4sCiAgICApIC0+IFJlc3VsdDxTZWxmLCBpbzo6RXJyb3I+IHsKICAgICAgICBsZXQgU29tZShmaWxlX3BhdGgpID0gb3B0aW9uYWxfZmlsZSBlbHNlIHsgcmV0dXJuIE9rKHNlbGYpIH07CiAgICAgICAgbGV0IHJlYWRlciA9IG1hdGNoIHN0ZDo6ZnM6OkZpbGU6Om9wZW4oZmlsZV9wYXRoLmFzX3JlZigpKSB7CiAgICAgICAgICAgIE9rKGZpbGUpID0+IGlvOjpCdWZSZWFkZXI6Om5ldyhmaWxlKSwKICAgICAgICAgICAgRXJyKGUpIGlmIGUua2luZCgpID09IEVycm9yS2luZDo6Tm90Rm91bmQgPT4gcmV0dXJuIE9rKHNlbGYpLAogICAgICAgICAgICBFcnIoZSkgPT4gRXJyKGUpPywKICAgICAgICB9OwogICAgICAgIGluZm8hKHRhcmdldDogIm5ldDo6cGVlcnMiLCBmaWxlID0gJWZpbGVfcGF0aC5hc19yZWYoKS5kaXNwbGF5KCksICJMb2FkaW5nIHNhdmVkIHBlZXJzIik7CiAgICAgICAgbGV0IG5vZGVzOiBIYXNoU2V0PE5vZGVSZWNvcmQ+ID0gc2VyZGVfanNvbjo6ZnJvbV9yZWFkZXIocmVhZGVyKT87CiAgICAgICAgT2soc2VsZi53aXRoX2Jhc2ljX25vZGVzKG5vZGVzKSkKICAgIH0KCiAgICAvLy8gQ29uZmlndXJlIHRoZSBJUCBmaWx0ZXIgZm9yIHJlc3RyaWN0aW5nIG5ldHdvcmsgY29ubmVjdGlvbnMgdG8gc3BlY2lmaWMgSVAgcmFuZ2VzLgogICAgcHViIGZuIHdpdGhfaXBfZmlsdGVyKG11dCBzZWxmLCBpcF9maWx0ZXI6IElwRmlsdGVyKSAtPiBTZWxmIHsKICAgICAgICBzZWxmLmlwX2ZpbHRlciA9IGlwX2ZpbHRlcjsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIFJldHVybnMgc2V0dGluZ3MgZm9yIHRlc3RpbmcKICAgICNbY2ZnKGFueSh0ZXN0LCBmZWF0dXJlID0gInRlc3QtdXRpbHMiKSldCiAgICBwdWIgZm4gdGVzdCgpIC0+IFNlbGYgewogICAgICAgIFNlbGYgewogICAgICAgICAgICByZWZpbGxfc2xvdHNfaW50ZXJ2YWw6IER1cmF0aW9uOjpmcm9tX21pbGxpcygxMDApLAogICAgICAgICAgICBiYWNrb2ZmX2R1cmF0aW9uczogUGVlckJhY2tvZmZEdXJhdGlvbnM6OnRlc3QoKSwKICAgICAgICAgICAgYmFuX2R1cmF0aW9uOiBEdXJhdGlvbjo6ZnJvbV9taWxsaXMoMjAwKSwKICAgICAgICAgICAgLi5EZWZhdWx0OjpkZWZhdWx0KCkKICAgICAgICB9CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL25ldC9uZXR3b3JrLXR5cGVzL3NyYy9wZWVycy9raW5kLnJzIj4KLy8hIENsYXNzaWZpY2F0aW9uIG9mIGEgcGVlciBiYXNlZCBvbiB0cnVzdC4KCi8vLyBSZXByZXNlbnRzIHRoZSBraW5kIG9mIHBlZXIKI1tkZXJpdmUoRGVidWcsIENsb25lLCBDb3B5LCBEZWZhdWx0LCBFcSwgUGFydGlhbEVxKV0KcHViIGVudW0gUGVlcktpbmQgewogICAgLy8vIEJhc2ljIHBlZXIga2luZC4KICAgICNbZGVmYXVsdF0KICAgIEJhc2ljLAogICAgLy8vIFN0YXRpYyBwZWVyLCBhZGRlZCB2aWEgSlNPTi1SUEMuCiAgICBTdGF0aWMsCiAgICAvLy8gVHJ1c3RlZCBwZWVyLgogICAgVHJ1c3RlZCwKfQoKaW1wbCBQZWVyS2luZCB7CiAgICAvLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHBlZXIgaXMgdHJ1c3RlZC4KICAgIHB1YiBjb25zdCBmbiBpc190cnVzdGVkKCZzZWxmKSAtPiBib29sIHsKICAgICAgICBtYXRjaGVzIShzZWxmLCBTZWxmOjpUcnVzdGVkKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgcGVlciBpcyBzdGF0aWMuCiAgICBwdWIgY29uc3QgZm4gaXNfc3RhdGljKCZzZWxmKSAtPiBib29sIHsKICAgICAgICBtYXRjaGVzIShzZWxmLCBTZWxmOjpTdGF0aWMpCiAgICB9CgogICAgLy8vIFJldHVybnMgYHRydWVgIGlmIHRoZSBwZWVyIGlzIGJhc2ljLgogICAgcHViIGNvbnN0IGZuIGlzX2Jhc2ljKCZzZWxmKSAtPiBib29sIHsKICAgICAgICBtYXRjaGVzIShzZWxmLCBTZWxmOjpCYXNpYykKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L25ldHdvcmstdHlwZXMvc3JjL3BlZXJzL21vZC5ycyI+CnB1YiBtb2QgYWRkcjsKcHViIG1vZCBjb25maWc7CnB1YiBtb2Qga2luZDsKcHViIG1vZCByZXB1dGF0aW9uOwpwdWIgbW9kIHN0YXRlOwoKcHViIHVzZSBjb25maWc6OntDb25uZWN0aW9uc0NvbmZpZywgUGVlcnNDb25maWd9OwpwdWIgdXNlIHJlcHV0YXRpb246OntSZXB1dGF0aW9uLCBSZXB1dGF0aW9uQ2hhbmdlLCBSZXB1dGF0aW9uQ2hhbmdlS2luZCwgUmVwdXRhdGlvbkNoYW5nZVdlaWdodHN9OwoKdXNlIGFsbG95X2VpcDIxMjQ6OkZvcmtJZDsKdXNlIHRyYWNpbmc6OnRyYWNlOwoKdXNlIGNyYXRlOjp7CiAgICBpc19iYW5uZWRfcmVwdXRhdGlvbiwgUGVlckFkZHIsIFBlZXJDb25uZWN0aW9uU3RhdGUsIFBlZXJLaW5kLCBSZXB1dGF0aW9uQ2hhbmdlT3V0Y29tZSwKICAgIERFRkFVTFRfUkVQVVRBVElPTiwKfTsKCi8vLyBUcmFja3MgaW5mbyBhYm91dCBhIHNpbmdsZSBwZWVyLgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUpXQpwdWIgc3RydWN0IFBlZXIgewogICAgLy8vIFdoZXJlIHRvIHJlYWNoIHRoZSBwZWVyLgogICAgcHViIGFkZHI6IFBlZXJBZGRyLAogICAgLy8vIFJlcHV0YXRpb24gb2YgdGhlIHBlZXIuCiAgICBwdWIgcmVwdXRhdGlvbjogaTMyLAogICAgLy8vIFRoZSBzdGF0ZSBvZiB0aGUgY29ubmVjdGlvbiwgaWYgYW55LgogICAgcHViIHN0YXRlOiBQZWVyQ29ubmVjdGlvblN0YXRlLAogICAgLy8vIFRoZSBbYEZvcmtJZGBdIHRoYXQgdGhlIHBlZXIgYW5ub3VuY2VkIHZpYSBkaXNjb3ZlcnkuCiAgICBwdWIgZm9ya19pZDogT3B0aW9uPEJveDxGb3JrSWQ+PiwKICAgIC8vLyBXaGV0aGVyIHRoZSBlbnRyeSBzaG91bGQgYmUgcmVtb3ZlZCBhZnRlciBhbiBleGlzdGluZyBzZXNzaW9uIHdhcyB0ZXJtaW5hdGVkLgogICAgcHViIHJlbW92ZV9hZnRlcl9kaXNjb25uZWN0OiBib29sLAogICAgLy8vIFRoZSBraW5kIG9mIHBlZXIKICAgIHB1YiBraW5kOiBQZWVyS2luZCwKICAgIC8vLyBXaGV0aGVyIHRoZSBwZWVyIGlzIGN1cnJlbnRseSBiYWNrZWQgb2ZmLgogICAgcHViIGJhY2tlZF9vZmY6IGJvb2wsCiAgICAvLy8gQ291bnRzIG51bWJlciBvZiB0aW1lcyB0aGUgcGVlciB3YXMgYmFja2VkIG9mZiBkdWUgdG8gYSBzZXZlcmUKICAgIC8vLyBbYEJhY2tvZmZLaW5kYF0oY3JhdGU6OkJhY2tvZmZLaW5kKS4KICAgIHB1YiBzZXZlcmVfYmFja29mZl9jb3VudGVyOiB1OCwKfQoKLy8gPT09IGltcGwgUGVlciA9PT0KCmltcGwgUGVlciB7CiAgICAvLy8gUmV0dXJucyBhIG5ldyBwZWVyIGZvciBnaXZlbiBbYFBlZXJBZGRyYF0uCiAgICBwdWIgZm4gbmV3KGFkZHI6IFBlZXJBZGRyKSAtPiBTZWxmIHsKICAgICAgICBTZWxmOjp3aXRoX3N0YXRlKGFkZHIsIERlZmF1bHQ6OmRlZmF1bHQoKSkKICAgIH0KCiAgICAvLy8gUmV0dXJucyBhIG5ldyB0cnVzdGVkIHBlZXIgZm9yIGdpdmVuIFtgUGVlckFkZHJgXS4KICAgIHB1YiBmbiB0cnVzdGVkKGFkZHI6IFBlZXJBZGRyKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsga2luZDogUGVlcktpbmQ6OlRydXN0ZWQsIC4uU2VsZjo6bmV3KGFkZHIpIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgcmVwdXRhdGlvbiBvZiB0aGUgcGVlcgogICAgcHViIGNvbnN0IGZuIHJlcHV0YXRpb24oJnNlbGYpIC0+IGkzMiB7CiAgICAgICAgc2VsZi5yZXB1dGF0aW9uCiAgICB9CgogICAgLy8vIFJldHVybnMgYSBuZXcgcGVlciBmb3IgZ2l2ZW4gW2BQZWVyQWRkcmBdIGFuZCBbYFBlZXJDb25uZWN0aW9uU3RhdGVgXS4KICAgIHB1YiBmbiB3aXRoX3N0YXRlKGFkZHI6IFBlZXJBZGRyLCBzdGF0ZTogUGVlckNvbm5lY3Rpb25TdGF0ZSkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIGFkZHIsCiAgICAgICAgICAgIHN0YXRlLAogICAgICAgICAgICByZXB1dGF0aW9uOiBERUZBVUxUX1JFUFVUQVRJT04sCiAgICAgICAgICAgIGZvcmtfaWQ6IE5vbmUsCiAgICAgICAgICAgIHJlbW92ZV9hZnRlcl9kaXNjb25uZWN0OiBmYWxzZSwKICAgICAgICAgICAga2luZDogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICBiYWNrZWRfb2ZmOiBmYWxzZSwKICAgICAgICAgICAgc2V2ZXJlX2JhY2tvZmZfY291bnRlcjogMCwKICAgICAgICB9CiAgICB9CgogICAgLy8vIFJldHVybnMgYSBuZXcgcGVlciBmb3IgZ2l2ZW4gW2BQZWVyQWRkcmBdIGFuZCBbYFBlZXJLaW5kYF0uCiAgICBwdWIgZm4gd2l0aF9raW5kKGFkZHI6IFBlZXJBZGRyLCBraW5kOiBQZWVyS2luZCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGtpbmQsIC4uU2VsZjo6bmV3KGFkZHIpIH0KICAgIH0KCiAgICAvLy8gUmVzZXRzIHRoZSByZXB1dGF0aW9uIG9mIHRoZSBwZWVyIHRvIHRoZSBkZWZhdWx0IHZhbHVlLiBUaGlzIGFsd2F5cyByZXR1cm5zCiAgICAvLy8gW2BSZXB1dGF0aW9uQ2hhbmdlT3V0Y29tZTo6Tm9uZWBdLgogICAgcHViIGNvbnN0IGZuIHJlc2V0X3JlcHV0YXRpb24oJm11dCBzZWxmKSAtPiBSZXB1dGF0aW9uQ2hhbmdlT3V0Y29tZSB7CiAgICAgICAgc2VsZi5yZXB1dGF0aW9uID0gREVGQVVMVF9SRVBVVEFUSU9OOwoKICAgICAgICBSZXB1dGF0aW9uQ2hhbmdlT3V0Y29tZTo6Tm9uZQogICAgfQoKICAgIC8vLyBBcHBsaWVzIGEgcmVwdXRhdGlvbiBjaGFuZ2UgdG8gdGhlIHBlZXIgYW5kIHJldHVybnMgd2hhdCBhY3Rpb24gc2hvdWxkIGJlIHRha2VuLgogICAgcHViIGZuIGFwcGx5X3JlcHV0YXRpb24oCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHJlcHV0YXRpb246IGkzMiwKICAgICAgICBraW5kOiBSZXB1dGF0aW9uQ2hhbmdlS2luZCwKICAgICkgLT4gUmVwdXRhdGlvbkNoYW5nZU91dGNvbWUgewogICAgICAgIGxldCBwcmV2aW91cyA9IHNlbGYucmVwdXRhdGlvbjsKICAgICAgICAvLyB3ZSBhZGQgcmVwdXRhdGlvbiBzaW5jZSBuZWdhdGl2ZSByZXB1dGF0aW9uIGNoYW5nZSBkZWNyZWFzZSB0b3RhbCByZXB1dGF0aW9uCiAgICAgICAgc2VsZi5yZXB1dGF0aW9uID0gcHJldmlvdXMuc2F0dXJhdGluZ19hZGQocmVwdXRhdGlvbik7CgogICAgICAgIHRyYWNlISh0YXJnZXQ6ICJuZXQ6OnBlZXJzIiwgcmVwdXRhdGlvbj0lc2VsZi5yZXB1dGF0aW9uLCBiYW5uZWQ9JXNlbGYuaXNfYmFubmVkKCksID9raW5kLCAiYXBwbGllZCByZXB1dGF0aW9uIGNoYW5nZSIpOwoKICAgICAgICBpZiBzZWxmLnN0YXRlLmlzX2Nvbm5lY3RlZCgpICYmIHNlbGYuaXNfYmFubmVkKCkgewogICAgICAgICAgICBzZWxmLnN0YXRlLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgcmV0dXJuIFJlcHV0YXRpb25DaGFuZ2VPdXRjb21lOjpEaXNjb25uZWN0QW5kQmFuCiAgICAgICAgfQoKICAgICAgICBpZiBzZWxmLmlzX2Jhbm5lZCgpICYmICFpc19iYW5uZWRfcmVwdXRhdGlvbihwcmV2aW91cykgewogICAgICAgICAgICByZXR1cm4gUmVwdXRhdGlvbkNoYW5nZU91dGNvbWU6OkJhbgogICAgICAgIH0KCiAgICAgICAgaWYgIXNlbGYuaXNfYmFubmVkKCkgJiYgaXNfYmFubmVkX3JlcHV0YXRpb24ocHJldmlvdXMpIHsKICAgICAgICAgICAgcmV0dXJuIFJlcHV0YXRpb25DaGFuZ2VPdXRjb21lOjpVbmJhbgogICAgICAgIH0KCiAgICAgICAgUmVwdXRhdGlvbkNoYW5nZU91dGNvbWU6Ok5vbmUKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0cnVlIGlmIHRoZSBwZWVyJ3MgcmVwdXRhdGlvbiBpcyBiZWxvdyB0aGUgYmFubmVkIHRocmVzaG9sZC4KICAgICNbaW5saW5lXQogICAgcHViIGNvbnN0IGZuIGlzX2Jhbm5lZCgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgaXNfYmFubmVkX3JlcHV0YXRpb24oc2VsZi5yZXB1dGF0aW9uKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGB0cnVlYCBpZiBwZWVyIGlzIGJhbm5lZC4KICAgICNbaW5saW5lXQogICAgcHViIGNvbnN0IGZuIGlzX2JhY2tlZF9vZmYoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIHNlbGYuYmFja2VkX29mZgogICAgfQoKICAgIC8vLyBVbmJhbnMgdGhlIHBlZXIgYnkgcmVzZXR0aW5nIGl0cyByZXB1dGF0aW9uCiAgICAjW2lubGluZV0KICAgIHB1YiBjb25zdCBmbiB1bmJhbigmbXV0IHNlbGYpIHsKICAgICAgICBzZWxmLnJlcHV0YXRpb24gPSBERUZBVUxUX1JFUFVUQVRJT04KICAgIH0KCiAgICAvLy8gUmV0dXJucyB3aGV0aGVyIHRoaXMgcGVlciBpcyB0cnVzdGVkCiAgICAjW2lubGluZV0KICAgIHB1YiBjb25zdCBmbiBpc190cnVzdGVkKCZzZWxmKSAtPiBib29sIHsKICAgICAgICBtYXRjaGVzIShzZWxmLmtpbmQsIFBlZXJLaW5kOjpUcnVzdGVkKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHdoZXRoZXIgdGhpcyBwZWVyIGlzIHN0YXRpYwogICAgI1tpbmxpbmVdCiAgICBwdWIgY29uc3QgZm4gaXNfc3RhdGljKCZzZWxmKSAtPiBib29sIHsKICAgICAgICBtYXRjaGVzIShzZWxmLmtpbmQsIFBlZXJLaW5kOjpTdGF0aWMpCiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL25ldC9uZXR3b3JrLXR5cGVzL3NyYy9wZWVycy9yZXB1dGF0aW9uLnJzIj4KLy8hIFBlZXIgcmVwdXRhdGlvbiBtYW5hZ2VtZW50CgovLy8gVGhlIGRlZmF1bHQgcmVwdXRhdGlvbiBvZiBhIHBlZXIKcHViIGNvbnN0IERFRkFVTFRfUkVQVVRBVElPTjogUmVwdXRhdGlvbiA9IDA7CgovLy8gVGhlIG1pbmltYWwgdW5pdCB3ZSdyZSBtZWFzdXJpbmcgcmVwdXRhdGlvbgpjb25zdCBSRVBVVEFUSU9OX1VOSVQ6IGkzMiA9IC0xMDI0OwoKLy8vIFRoZSByZXB1dGF0aW9uIHZhbHVlIGJlbG93IHdoaWNoIG5ldyBjb25uZWN0aW9uIGZyb20vdG8gcGVlcnMgYXJlIHJlamVjdGVkLgpwdWIgY29uc3QgQkFOTkVEX1JFUFVUQVRJT046IGkzMiA9IDUwICogUkVQVVRBVElPTl9VTklUOwoKLy8vIFRoZSByZXB1dGF0aW9uIGNoYW5nZSB0byBhcHBseSB0byBhIHBlZXIgdGhhdCBkcm9wcGVkIHRoZSBjb25uZWN0aW9uLgpjb25zdCBSRU1PVEVfRElTQ09OTkVDVF9SRVBVVEFUSU9OX0NIQU5HRTogaTMyID0gNCAqIFJFUFVUQVRJT05fVU5JVDsKCi8vLyBUaGUgcmVwdXRhdGlvbiBjaGFuZ2UgdG8gYXBwbHkgdG8gYSBwZWVyIHRoYXQgd2UgZmFpbGVkIHRvIGNvbm5lY3QgdG8uCnB1YiBjb25zdCBGQUlMRURfVE9fQ09OTkVDVF9SRVBVVEFUSU9OX0NIQU5HRTogaTMyID0gMjUgKiBSRVBVVEFUSU9OX1VOSVQ7CgovLy8gVGhlIHJlcHV0YXRpb24gY2hhbmdlIHRvIGFwcGx5IHRvIGEgcGVlciB0aGF0IGZhaWxlZCB0byByZXNwb25kIGluIHRpbWUuCmNvbnN0IFRJTUVPVVRfUkVQVVRBVElPTl9DSEFOR0U6IGkzMiA9IDQgKiBSRVBVVEFUSU9OX1VOSVQ7CgovLy8gVGhlIHJlcHV0YXRpb24gY2hhbmdlIHRvIGFwcGx5IHRvIGEgcGVlciB0aGF0IHNlbnQgYSBiYWQgbWVzc2FnZS4KY29uc3QgQkFEX01FU1NBR0VfUkVQVVRBVElPTl9DSEFOR0U6IGkzMiA9IDE2ICogUkVQVVRBVElPTl9VTklUOwoKLy8vIFRoZSByZXB1dGF0aW9uIGNoYW5nZSBhcHBsaWVzIHRvIGEgcGVlciB0aGF0IGhhcyBzZW50IGEgdHJhbnNhY3Rpb24gKGZ1bGwgb3IgaGFzaCkgdGhhdCB3ZQovLy8gYWxyZWFkeSBrbm93IGFib3V0IGFuZCBoYXZlIGFscmVhZHkgcHJldmlvdXNseSByZWNlaXZlZCBmcm9tIHRoYXQgcGVlci4KLy8vCi8vLyBOb3RlOiB0aGlzIGFwcGVhcnMgdG8gYmUgcXVpdGUgY29tbW9uIGluIHByYWN0aWNlLCBzbyBieSBkZWZhdWx0IHRoaXMgaXMgMCwgd2hpY2ggZG9lc24ndAovLy8gYXBwbHkgYW55IGNoYW5nZXMgdG8gdGhlIHBlZXIncyByZXB1dGF0aW9uLCBlZmZlY3RpdmVseSBpZ25vcmluZyBpdC4KY29uc3QgQUxSRUFEWV9TRUVOX1RSQU5TQUNUSU9OX1JFUFVUQVRJT05fQ0hBTkdFOiBpMzIgPSAwOwoKLy8vIFRoZSByZXB1dGF0aW9uIGNoYW5nZSB0byBhcHBseSB0byBhIHBlZXIgd2hpY2ggdmlvbGF0ZXMgcHJvdG9jb2wgcnVsZXM6IG1pbmltYWwgcmVwdXRhdGlvbgpjb25zdCBCQURfUFJPVE9DT0xfUkVQVVRBVElPTl9DSEFOR0U6IGkzMiA9IGkzMjo6TUlOOwoKLy8vIFRoZSByZXB1dGF0aW9uIGNoYW5nZSB0byBhcHBseSB0byBhIHBlZXIgdGhhdCBzZW50IGEgYmFkIGFubm91bmNlbWVudC4KLy8gdG9kbzogY3VycmVudCB2YWx1ZSBpcyBhIGhpbnQsIG5lZWRzIHRvIGJlIHNldCBwcm9wZXJseQpjb25zdCBCQURfQU5OT1VOQ0VNRU5UX1JFUFVUQVRJT05fQ0hBTkdFOiBpMzIgPSBSRVBVVEFUSU9OX1VOSVQ7CgovLy8gVGhlIG1heGltdW0gcmVwdXRhdGlvbiBjaGFuZ2UgdGhhdCBjYW4gYmUgYXBwbGllZCB0byBhIHRydXN0ZWQgcGVlci4KLy8vIFRoaXMgaXMgdXNlZCB0byBwcmV2ZW50IGEgc2luZ2xlIGJhZCBtZXNzYWdlIGZyb20gYSB0cnVzdGVkIHBlZXIgdG8gY2F1c2UgYSBzaWduaWZpY2FudCBjaGFuZ2UuCi8vLyBUaGlzIGdpdmVzIGEgdHJ1c3RlZCBwZWVyIG1vcmUgbGVld2F5IHdoZW4gaW50ZXJhY3Rpbmcgd2l0aCB0aGUgbm9kZSwgd2hpY2ggaXMgdXNlZnVsIGZvciBpbgovLy8gY3VzdG9tIHNldHVwcy4gQnkgbm90IHNldHRpbmcgdGhpcyB0byBgMGAgd2Ugc3RpbGwgYWxsb3cgdHJ1c3RlZCBwZWVyIHBlbmFsaXphdGlvbiBidXQgbGVzcyB0aGFuCi8vLyB1bnRydXN0ZWQgcGVlcnMuCnB1YiBjb25zdCBNQVhfVFJVU1RFRF9QRUVSX1JFUFVUQVRJT05fQ0hBTkdFOiBSZXB1dGF0aW9uID0gMiAqIFJFUFVUQVRJT05fVU5JVDsKCi8vLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gcmVwdXRhdGlvbiBpcyBiZWxvdyB0aGUgW2BCQU5ORURfUkVQVVRBVElPTmBdIHRocmVzaG9sZAojW2lubGluZV0KcHViIGNvbnN0IGZuIGlzX2Jhbm5lZF9yZXB1dGF0aW9uKHJlcHV0YXRpb246IGkzMikgLT4gYm9vbCB7CiAgICByZXB1dGF0aW9uIDwgQkFOTkVEX1JFUFVUQVRJT04KfQoKLy8vIFJldHVybnMgYHRydWVgIGlmIHRoZSBnaXZlbiByZXB1dGF0aW9uIGlzIGJlbG93IHRoZSBbYEZBSUxFRF9UT19DT05ORUNUX1JFUFVUQVRJT05fQ0hBTkdFYF0KLy8vIHRocmVzaG9sZAojW2lubGluZV0KcHViIGNvbnN0IGZuIGlzX2Nvbm5lY3Rpb25fZmFpbGVkX3JlcHV0YXRpb24ocmVwdXRhdGlvbjogaTMyKSAtPiBib29sIHsKICAgIHJlcHV0YXRpb24gPCBGQUlMRURfVE9fQ09OTkVDVF9SRVBVVEFUSU9OX0NIQU5HRQp9CgovLy8gVGhlIHR5cGUgdGhhdCB0cmFja3MgdGhlIHJlcHV0YXRpb24gc2NvcmUuCnB1YiB0eXBlIFJlcHV0YXRpb24gPSBpMzI7CgovLy8gVmFyaW91cyBraW5kcyBvZiByZXB1dGF0aW9uIGNoYW5nZXMuCiNbZGVyaXZlKERlYnVnLCBDb3B5LCBDbG9uZSwgUGFydGlhbEVxLCBFcSldCnB1YiBlbnVtIFJlcHV0YXRpb25DaGFuZ2VLaW5kIHsKICAgIC8vLyBSZWNlaXZlZCBhbiB1bnNwZWNpZmljIGJhZCBtZXNzYWdlIGZyb20gdGhlIHBlZXIKICAgIEJhZE1lc3NhZ2UsCiAgICAvLy8gUGVlciBzZW50IGEgYmFkIGJsb2NrLgogICAgLy8vCiAgICAvLy8gTm90ZTogdGhpcyB3aWxsIHdlIG9ubHkgdXNlZCBpbiBwcmUtbWVyZ2UsIHBvdyBjb25zZW5zdXMsIHNpbmNlIGFmdGVyIG5vIG1vcmUgYmxvY2sgYW5ub3VuY2VtZW50cyBhcmUgc2VudCB2aWEgZGV2cDJwOiBbRUlQLTM2NzVdKGh0dHBzOi8vZWlwcy5ldGhlcmV1bS5vcmcvRUlQUy9laXAtMzY3NSNkZXZwMnApCiAgICBCYWRCbG9jaywKICAgIC8vLyBQZWVyIHNlbnQgYSBiYWQgdHJhbnNhY3Rpb24gbWVzc2FnZS4gRS5nLiBUcmFuc2FjdGlvbnMgd2hpY2ggd2VyZW4ndCByZWNvdmVyYWJsZS4KICAgIEJhZFRyYW5zYWN0aW9ucywKICAgIC8vLyBQZWVyIHNlbnQgYSBiYWQgYW5ub3VuY2VtZW50IG1lc3NhZ2UsIGUuZy4gaW52YWxpZCB0cmFuc2FjdGlvbiB0eXBlIGZvciB0aGUgY29uZmlndXJlZAogICAgLy8vIG5ldHdvcmsuCiAgICBCYWRBbm5vdW5jZW1lbnQsCiAgICAvLy8gUGVlciBzZW50IGEgbWVzc2FnZSB0aGF0IGluY2x1ZGVkIGEgaGFzaCBvciB0cmFuc2FjdGlvbiB0aGF0IHdlIGFscmVhZHkgcmVjZWl2ZWQgZnJvbSB0aGUKICAgIC8vLyBwZWVyLgogICAgLy8vCiAgICAvLy8gQWNjb3JkaW5nIHRvIHRoZSBbRXRoIHNwZWNdKGh0dHBzOi8vZ2l0aHViLmNvbS9ldGhlcmV1bS9kZXZwMnAvYmxvYi9tYXN0ZXIvY2Fwcy9ldGgubWQpOgogICAgLy8vCiAgICAvLy8gPiBBIG5vZGUgc2hvdWxkIG5ldmVyIHNlbmQgYSB0cmFuc2FjdGlvbiBiYWNrIHRvIGEgcGVlciB0aGF0IGl0IGNhbiBkZXRlcm1pbmUgYWxyZWFkeSBrbm93cwogICAgLy8vID4gb2YgaXQgKGVpdGhlciBiZWNhdXNlIGl0IHdhcyBwcmV2aW91c2x5IHNlbnQgb3IgYmVjYXVzZSBpdCB3YXMgaW5mb3JtZWQgZnJvbSB0aGlzIHBlZXIKICAgIC8vLyA+IG9yaWdpbmFsbHkpLiBUaGlzIGlzIHVzdWFsbHkgYWNoaWV2ZWQgYnkgcmVtZW1iZXJpbmcgYSBzZXQgb2YgdHJhbnNhY3Rpb24gaGFzaGVzIHJlY2VudGx5CiAgICAvLy8gPiByZWxheWVkIGJ5IHRoZSBwZWVyLgogICAgQWxyZWFkeVNlZW5UcmFuc2FjdGlvbiwKICAgIC8vLyBQZWVyIGZhaWxlZCB0byByZXNwb25kIGluIHRpbWUuCiAgICBUaW1lb3V0LAogICAgLy8vIFBlZXIgZG9lcyBub3QgYWRoZXJlIHRvIG5ldHdvcmsgcHJvdG9jb2wgcnVsZXMuCiAgICBCYWRQcm90b2NvbCwKICAgIC8vLyBGYWlsZWQgdG8gZXN0YWJsaXNoIGEgY29ubmVjdGlvbiB0byB0aGUgcGVlci4KICAgIEZhaWxlZFRvQ29ubmVjdCwKICAgIC8vLyBDb25uZWN0aW9uIGRyb3BwZWQgYnkgcGVlci4KICAgIERyb3BwZWQsCiAgICAvLy8gUmVzZXQgdGhlIHJlcHV0YXRpb24gdG8gdGhlIGRlZmF1bHQgdmFsdWUuCiAgICBSZXNldCwKICAgIC8vLyBBcHBseSBhIHJlcHV0YXRpb24gY2hhbmdlIGJ5IHZhbHVlCiAgICBPdGhlcihSZXB1dGF0aW9uKSwKfQoKaW1wbCBSZXB1dGF0aW9uQ2hhbmdlS2luZCB7CiAgICAvLy8gUmV0dXJucyB0cnVlIGlmIHRoZSByZXB1dGF0aW9uIGNoYW5nZSBpcyBhIFtgUmVwdXRhdGlvbkNoYW5nZUtpbmQ6OlJlc2V0YF0uCiAgICBwdWIgY29uc3QgZm4gaXNfcmVzZXQoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIG1hdGNoZXMhKHNlbGYsIFNlbGY6OlJlc2V0KQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRydWUgaWYgdGhlIHJlcHV0YXRpb24gY2hhbmdlIGlzIFtgUmVwdXRhdGlvbkNoYW5nZUtpbmQ6OkRyb3BwZWRgXS4KICAgIHB1YiBjb25zdCBmbiBpc19kcm9wcGVkKCZzZWxmKSAtPiBib29sIHsKICAgICAgICBtYXRjaGVzIShzZWxmLCBTZWxmOjpEcm9wcGVkKQogICAgfQp9CgovLy8gSG93IHRoZSBbYFJlcHV0YXRpb25DaGFuZ2VLaW5kYF0gYXJlIHdlaWdodGVkLgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIFBhcnRpYWxFcSwgRXEpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKGRlZmF1bHQpKV0KcHViIHN0cnVjdCBSZXB1dGF0aW9uQ2hhbmdlV2VpZ2h0cyB7CiAgICAvLy8gV2VpZ2h0IGZvciBbYFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpCYWRNZXNzYWdlYF0KICAgIHB1YiBiYWRfbWVzc2FnZTogUmVwdXRhdGlvbiwKICAgIC8vLyBXZWlnaHQgZm9yIFtgUmVwdXRhdGlvbkNoYW5nZUtpbmQ6OkJhZEJsb2NrYF0KICAgIHB1YiBiYWRfYmxvY2s6IFJlcHV0YXRpb24sCiAgICAvLy8gV2VpZ2h0IGZvciBbYFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpCYWRUcmFuc2FjdGlvbnNgXQogICAgcHViIGJhZF90cmFuc2FjdGlvbnM6IFJlcHV0YXRpb24sCiAgICAvLy8gV2VpZ2h0IGZvciBbYFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpBbHJlYWR5U2VlblRyYW5zYWN0aW9uYF0KICAgIHB1YiBhbHJlYWR5X3NlZW5fdHJhbnNhY3Rpb25zOiBSZXB1dGF0aW9uLAogICAgLy8vIFdlaWdodCBmb3IgW2BSZXB1dGF0aW9uQ2hhbmdlS2luZDo6VGltZW91dGBdCiAgICBwdWIgdGltZW91dDogUmVwdXRhdGlvbiwKICAgIC8vLyBXZWlnaHQgZm9yIFtgUmVwdXRhdGlvbkNoYW5nZUtpbmQ6OkJhZFByb3RvY29sYF0KICAgIHB1YiBiYWRfcHJvdG9jb2w6IFJlcHV0YXRpb24sCiAgICAvLy8gV2VpZ2h0IGZvciBbYFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpGYWlsZWRUb0Nvbm5lY3RgXQogICAgcHViIGZhaWxlZF90b19jb25uZWN0OiBSZXB1dGF0aW9uLAogICAgLy8vIFdlaWdodCBmb3IgW2BSZXB1dGF0aW9uQ2hhbmdlS2luZDo6RHJvcHBlZGBdCiAgICBwdWIgZHJvcHBlZDogUmVwdXRhdGlvbiwKICAgIC8vLyBXZWlnaHQgZm9yIFtgUmVwdXRhdGlvbkNoYW5nZUtpbmQ6OkJhZEFubm91bmNlbWVudGBdCiAgICBwdWIgYmFkX2Fubm91bmNlbWVudDogUmVwdXRhdGlvbiwKfQoKLy8gPT09IGltcGwgUmVwdXRhdGlvbkNoYW5nZVdlaWdodHMgPT09CgppbXBsIFJlcHV0YXRpb25DaGFuZ2VXZWlnaHRzIHsKICAgIC8vLyBDcmVhdGVzIGEgbmV3IGluc3RhbmNlIHRoYXQgZG9lc24ndCBwZW5hbGl6ZSBhbnkga2luZCBvZiByZXB1dGF0aW9uIGNoYW5nZS4KICAgIHB1YiBjb25zdCBmbiB6ZXJvKCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIGJhZF9ibG9jazogMCwKICAgICAgICAgICAgYmFkX3RyYW5zYWN0aW9uczogMCwKICAgICAgICAgICAgYWxyZWFkeV9zZWVuX3RyYW5zYWN0aW9uczogMCwKICAgICAgICAgICAgYmFkX21lc3NhZ2U6IDAsCiAgICAgICAgICAgIHRpbWVvdXQ6IDAsCiAgICAgICAgICAgIGJhZF9wcm90b2NvbDogMCwKICAgICAgICAgICAgZmFpbGVkX3RvX2Nvbm5lY3Q6IDAsCiAgICAgICAgICAgIGRyb3BwZWQ6IDAsCiAgICAgICAgICAgIGJhZF9hbm5vdW5jZW1lbnQ6IDAsCiAgICAgICAgfQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBxdWFudGlmaWFibGUgW2BSZXB1dGF0aW9uQ2hhbmdlYF0gZm9yIHRoZSBnaXZlbiBbYFJlcHV0YXRpb25DaGFuZ2VLaW5kYF0gdXNpbmcKICAgIC8vLyB0aGUgY29uZmlndXJlZCB3ZWlnaHRzCiAgICBwdWIgZm4gY2hhbmdlKCZzZWxmLCBraW5kOiBSZXB1dGF0aW9uQ2hhbmdlS2luZCkgLT4gUmVwdXRhdGlvbkNoYW5nZSB7CiAgICAgICAgbWF0Y2gga2luZCB7CiAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpCYWRNZXNzYWdlID0+IHNlbGYuYmFkX21lc3NhZ2UuaW50bygpLAogICAgICAgICAgICBSZXB1dGF0aW9uQ2hhbmdlS2luZDo6QmFkQmxvY2sgPT4gc2VsZi5iYWRfYmxvY2suaW50bygpLAogICAgICAgICAgICBSZXB1dGF0aW9uQ2hhbmdlS2luZDo6QmFkVHJhbnNhY3Rpb25zID0+IHNlbGYuYmFkX3RyYW5zYWN0aW9ucy5pbnRvKCksCiAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpBbHJlYWR5U2VlblRyYW5zYWN0aW9uID0+IHNlbGYuYWxyZWFkeV9zZWVuX3RyYW5zYWN0aW9ucy5pbnRvKCksCiAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpUaW1lb3V0ID0+IHNlbGYudGltZW91dC5pbnRvKCksCiAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpCYWRQcm90b2NvbCA9PiBzZWxmLmJhZF9wcm90b2NvbC5pbnRvKCksCiAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpGYWlsZWRUb0Nvbm5lY3QgPT4gc2VsZi5mYWlsZWRfdG9fY29ubmVjdC5pbnRvKCksCiAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpEcm9wcGVkID0+IHNlbGYuZHJvcHBlZC5pbnRvKCksCiAgICAgICAgICAgIFJlcHV0YXRpb25DaGFuZ2VLaW5kOjpSZXNldCA9PiBERUZBVUxUX1JFUFVUQVRJT04uaW50bygpLAogICAgICAgICAgICBSZXB1dGF0aW9uQ2hhbmdlS2luZDo6T3RoZXIodmFsKSA9PiB2YWwuaW50bygpLAogICAgICAgICAgICBSZXB1dGF0aW9uQ2hhbmdlS2luZDo6QmFkQW5ub3VuY2VtZW50ID0+IHNlbGYuYmFkX2Fubm91bmNlbWVudC5pbnRvKCksCiAgICAgICAgfQogICAgfQp9CgppbXBsIERlZmF1bHQgZm9yIFJlcHV0YXRpb25DaGFuZ2VXZWlnaHRzIHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgYmFkX2Jsb2NrOiBCQURfTUVTU0FHRV9SRVBVVEFUSU9OX0NIQU5HRSwKICAgICAgICAgICAgYmFkX3RyYW5zYWN0aW9uczogQkFEX01FU1NBR0VfUkVQVVRBVElPTl9DSEFOR0UsCiAgICAgICAgICAgIGFscmVhZHlfc2Vlbl90cmFuc2FjdGlvbnM6IEFMUkVBRFlfU0VFTl9UUkFOU0FDVElPTl9SRVBVVEFUSU9OX0NIQU5HRSwKICAgICAgICAgICAgYmFkX21lc3NhZ2U6IEJBRF9NRVNTQUdFX1JFUFVUQVRJT05fQ0hBTkdFLAogICAgICAgICAgICB0aW1lb3V0OiBUSU1FT1VUX1JFUFVUQVRJT05fQ0hBTkdFLAogICAgICAgICAgICBiYWRfcHJvdG9jb2w6IEJBRF9QUk9UT0NPTF9SRVBVVEFUSU9OX0NIQU5HRSwKICAgICAgICAgICAgZmFpbGVkX3RvX2Nvbm5lY3Q6IEZBSUxFRF9UT19DT05ORUNUX1JFUFVUQVRJT05fQ0hBTkdFLAogICAgICAgICAgICBkcm9wcGVkOiBSRU1PVEVfRElTQ09OTkVDVF9SRVBVVEFUSU9OX0NIQU5HRSwKICAgICAgICAgICAgYmFkX2Fubm91bmNlbWVudDogQkFEX0FOTk9VTkNFTUVOVF9SRVBVVEFUSU9OX0NIQU5HRSwKICAgICAgICB9CiAgICB9Cn0KCi8vLyBSZXByZXNlbnRzIGEgY2hhbmdlIGluIGEgcGVlcidzIHJlcHV0YXRpb24uCiNbZGVyaXZlKERlYnVnLCBDb3B5LCBDbG9uZSwgRGVmYXVsdCldCnB1YiBzdHJ1Y3QgUmVwdXRhdGlvbkNoYW5nZShSZXB1dGF0aW9uKTsKCi8vID09PSBpbXBsIFJlcHV0YXRpb25DaGFuZ2UgPT09CgppbXBsIFJlcHV0YXRpb25DaGFuZ2UgewogICAgLy8vIEhlbHBlciB0eXBlIGZvciBlYXNpZXIgY29udmVyc2lvbgogICAgI1tpbmxpbmVdCiAgICBwdWIgY29uc3QgZm4gYXNfaTMyKHNlbGYpIC0+IFJlcHV0YXRpb24gewogICAgICAgIHNlbGYuMAogICAgfQp9CgppbXBsIEZyb208UmVwdXRhdGlvbkNoYW5nZT4gZm9yIFJlcHV0YXRpb24gewogICAgZm4gZnJvbSh2YWx1ZTogUmVwdXRhdGlvbkNoYW5nZSkgLT4gU2VsZiB7CiAgICAgICAgdmFsdWUuMAogICAgfQp9CgppbXBsIEZyb208UmVwdXRhdGlvbj4gZm9yIFJlcHV0YXRpb25DaGFuZ2UgewogICAgZm4gZnJvbSh2YWx1ZTogUmVwdXRhdGlvbikgLT4gU2VsZiB7CiAgICAgICAgU2VsZih2YWx1ZSkKICAgIH0KfQoKLy8vIE91dGNvbWVzIHdoZW4gYSByZXB1dGF0aW9uIGNoYW5nZSBpcyBhcHBsaWVkIHRvIGEgcGVlcgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIENvcHkpXQpwdWIgZW51bSBSZXB1dGF0aW9uQ2hhbmdlT3V0Y29tZSB7CiAgICAvLy8gTm90aGluZyB0byBkby4KICAgIE5vbmUsCiAgICAvLy8gQmFuIHRoZSBwZWVyLgogICAgQmFuLAogICAgLy8vIEJhbiBhbmQgZGlzY29ubmVjdAogICAgRGlzY29ubmVjdEFuZEJhbiwKICAgIC8vLyBVbmJhbiB0aGUgcGVlcgogICAgVW5iYW4sCn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL25ldC9uZXR3b3JrLXR5cGVzL3NyYy9wZWVycy9zdGF0ZS5ycyI+Ci8vISBTdGF0ZSBvZiBjb25uZWN0aW9uIHRvIGEgcGVlci4KCi8vLyBSZXByZXNlbnRzIHRoZSBraW5kIG9mIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQgdG8gdGhlIHBlZXIsIGlmIGFueQojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIENvcHksIERlZmF1bHQsIEVxLCBQYXJ0aWFsRXEpXQpwdWIgZW51bSBQZWVyQ29ubmVjdGlvblN0YXRlIHsKICAgIC8vLyBOb3QgY29ubmVjdGVkIGN1cnJlbnRseS4KICAgICNbZGVmYXVsdF0KICAgIElkbGUsCiAgICAvLy8gRGlzY29ubmVjdCBvZiBhbiBpbmNvbWluZyBjb25uZWN0aW9uIGluIHByb2dyZXNzCiAgICBEaXNjb25uZWN0aW5nSW4sCiAgICAvLy8gRGlzY29ubmVjdCBvZiBhbiBvdXRnb2luZyBjb25uZWN0aW9uIGluIHByb2dyZXNzCiAgICBEaXNjb25uZWN0aW5nT3V0LAogICAgLy8vIENvbm5lY3RlZCB2aWEgaW5jb21pbmcgY29ubmVjdGlvbi4KICAgIEluLAogICAgLy8vIENvbm5lY3RlZCB2aWEgb3V0Z29pbmcgY29ubmVjdGlvbi4KICAgIE91dCwKICAgIC8vLyBQZW5kaW5nIG91dGdvaW5nIGNvbm5lY3Rpb24uCiAgICBQZW5kaW5nT3V0LAp9CgovLyA9PT0gaW1wbCBQZWVyQ29ubmVjdGlvblN0YXRlID09PQoKaW1wbCBQZWVyQ29ubmVjdGlvblN0YXRlIHsKICAgIC8vLyBTZXRzIHRoZSBkaXNjb25uZWN0IHN0YXRlCiAgICAjW2lubGluZV0KICAgIHB1YiBjb25zdCBmbiBkaXNjb25uZWN0KCZtdXQgc2VsZikgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpJbiA9PiAqc2VsZiA9IFNlbGY6OkRpc2Nvbm5lY3RpbmdJbiwKICAgICAgICAgICAgU2VsZjo6T3V0ID0+ICpzZWxmID0gU2VsZjo6RGlzY29ubmVjdGluZ091dCwKICAgICAgICAgICAgXyA9PiB7fQogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0cnVlIGlmIHRoaXMgaXMgdGhlIGlkbGUgc3RhdGUuCiAgICAjW2lubGluZV0KICAgIHB1YiBjb25zdCBmbiBpc19pZGxlKCZzZWxmKSAtPiBib29sIHsKICAgICAgICBtYXRjaGVzIShzZWxmLCBTZWxmOjpJZGxlKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRydWUgaWYgdGhpcyBpcyBhbiBhY3RpdmUgaW5jb21pbmcgY29ubmVjdGlvbi4KICAgICNbaW5saW5lXQogICAgcHViIGNvbnN0IGZuIGlzX2luY29taW5nKCZzZWxmKSAtPiBib29sIHsKICAgICAgICBtYXRjaGVzIShzZWxmLCBTZWxmOjpJbikKICAgIH0KCiAgICAvLy8gUmV0dXJucyB3aGV0aGVyIHdlJ3JlIGN1cnJlbnRseSBjb25uZWN0ZWQgd2l0aCB0aGlzIHBlZXIKICAgICNbaW5saW5lXQogICAgcHViIGNvbnN0IGZuIGlzX2Nvbm5lY3RlZCgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgbWF0Y2hlcyEoc2VsZiwgU2VsZjo6SW4gfCBTZWxmOjpPdXQgfCBTZWxmOjpQZW5kaW5nT3V0KQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGlmIHRoZXJlJ3MgY3VycmVudGx5IG5vIGNvbm5lY3Rpb24gdG8gdGhhdCBwZWVyLgogICAgI1tpbmxpbmVdCiAgICBwdWIgY29uc3QgZm4gaXNfdW5jb25uZWN0ZWQoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIG1hdGNoZXMhKHNlbGYsIFNlbGY6OklkbGUpCiAgICB9CgogICAgLy8vIFJldHVybnMgdHJ1ZSBpZiB0aGVyZSdzIGN1cnJlbnRseSBhbiBvdXRib3VuZCBkaWFsIHRvIHRoYXQgcGVlci4KICAgICNbaW5saW5lXQogICAgcHViIGNvbnN0IGZuIGlzX3BlbmRpbmdfb3V0KCZzZWxmKSAtPiBib29sIHsKICAgICAgICBtYXRjaGVzIShzZWxmLCBTZWxmOjpQZW5kaW5nT3V0KQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvYXBpL3NyYy9tZXRyaWNzL2xpc3RlbmVyLnJzIj4KdXNlIGNyYXRlOjp7bWV0cmljczo6U3luY01ldHJpY3MsIFN0YWdlQ2hlY2twb2ludCwgU3RhZ2VJZH07CnVzZSBhbGxveV9wcmltaXRpdmVzOjpCbG9ja051bWJlcjsKdXNlIHN0ZDo6ewogICAgZnV0dXJlOjpGdXR1cmUsCiAgICBwaW46OlBpbiwKICAgIHRhc2s6OntyZWFkeSwgQ29udGV4dCwgUG9sbH0sCiAgICB0aW1lOjpEdXJhdGlvbiwKfTsKdXNlIHRva2lvOjpzeW5jOjptcHNjOjp7VW5ib3VuZGVkUmVjZWl2ZXIsIFVuYm91bmRlZFNlbmRlcn07CnVzZSB0cmFjaW5nOjp0cmFjZTsKCi8vLyBBbGlhcyB0eXBlIGZvciBtZXRyaWMgcHJvZHVjZXJzIHRvIHVzZS4KcHViIHR5cGUgTWV0cmljRXZlbnRzU2VuZGVyID0gVW5ib3VuZGVkU2VuZGVyPE1ldHJpY0V2ZW50PjsKCi8vLyBDb2xsZWN0aW9uIG9mIG1ldHJpYyBldmVudHMuCiNbZGVyaXZlKENsb25lLCBDb3B5LCBEZWJ1ZyldCnB1YiBlbnVtIE1ldHJpY0V2ZW50IHsKICAgIC8vLyBTeW5jIHJlYWNoZWQgbmV3IGhlaWdodC4gQWxsIHN0YWdlIGNoZWNrcG9pbnRzIGFyZSB1cGRhdGVkLgogICAgU3luY0hlaWdodCB7CiAgICAgICAgLy8vIE1heGltdW0gaGVpZ2h0IG1lYXN1cmVkIGluIGJsb2NrIG51bWJlciB0aGF0IHN5bmMgcmVhY2hlZC4KICAgICAgICBoZWlnaHQ6IEJsb2NrTnVtYmVyLAogICAgfSwKICAgIC8vLyBTdGFnZSByZWFjaGVkIG5ldyBjaGVja3BvaW50LgogICAgU3RhZ2VDaGVja3BvaW50IHsKICAgICAgICAvLy8gU3RhZ2UgSUQuCiAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQsCiAgICAgICAgLy8vIFN0YWdlIGNoZWNrcG9pbnQuCiAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50LAogICAgICAgIC8vLyBNYXhpbXVtIGtub3duIGJsb2NrIG51bWJlciByZWFjaGFibGUgYnkgdGhpcyBzdGFnZS4KICAgICAgICAvLy8gSWYgc3BlY2lmaWVkLCBgZW50aXRpZXNfdG90YWxgIG1ldHJpYyBpcyB1cGRhdGVkLgogICAgICAgIG1heF9ibG9ja19udW1iZXI6IE9wdGlvbjxCbG9ja051bWJlcj4sCiAgICAgICAgLy8vIFRoZSBkdXJhdGlvbiBvZiBzdGFnZSBpdGVyYXRpb24gaW5jbHVkaW5nIGRhdGFiYXNlIGNvbW1pdC4KICAgICAgICBlbGFwc2VkOiBEdXJhdGlvbiwKICAgIH0sCn0KCi8vLyBNZXRyaWNzIHJvdXRpbmUgdGhhdCBsaXN0ZW5zIHRvIG5ldyBtZXRyaWMgZXZlbnRzIG9uIHRoZSBgZXZlbnRzX3J4YCByZWNlaXZlci4KLy8vIFVwb24gcmVjZWl2aW5nIG5ldyBldmVudCwgcmVsYXRlZCBtZXRyaWNzIGFyZSB1cGRhdGVkLgojW2Rlcml2ZShEZWJ1ZyldCnB1YiBzdHJ1Y3QgTWV0cmljc0xpc3RlbmVyIHsKICAgIGV2ZW50c19yeDogVW5ib3VuZGVkUmVjZWl2ZXI8TWV0cmljRXZlbnQ+LAogICAgcHViKGNyYXRlKSBzeW5jX21ldHJpY3M6IFN5bmNNZXRyaWNzLAp9CgppbXBsIE1ldHJpY3NMaXN0ZW5lciB7CiAgICAvLy8gQ3JlYXRlcyBhIG5ldyBbYE1ldHJpY3NMaXN0ZW5lcmBdIHdpdGggdGhlIHByb3ZpZGVkIHJlY2VpdmVyIG9mIFtgTWV0cmljRXZlbnRgXS4KICAgIHB1YiBmbiBuZXcoZXZlbnRzX3J4OiBVbmJvdW5kZWRSZWNlaXZlcjxNZXRyaWNFdmVudD4pIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBldmVudHNfcngsIHN5bmNfbWV0cmljczogU3luY01ldHJpY3M6OmRlZmF1bHQoKSB9CiAgICB9CgogICAgZm4gaGFuZGxlX2V2ZW50KCZtdXQgc2VsZiwgZXZlbnQ6IE1ldHJpY0V2ZW50KSB7CiAgICAgICAgdHJhY2UhKHRhcmdldDogInN5bmM6Om1ldHJpY3MiLCA/ZXZlbnQsICJNZXRyaWMgZXZlbnQgcmVjZWl2ZWQiKTsKICAgICAgICBtYXRjaCBldmVudCB7CiAgICAgICAgICAgIE1ldHJpY0V2ZW50OjpTeW5jSGVpZ2h0IHsgaGVpZ2h0IH0gPT4gewogICAgICAgICAgICAgICAgc2VsZi51cGRhdGVfYWxsX3N0YWdlc19oZWlnaHQoaGVpZ2h0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBNZXRyaWNFdmVudDo6U3RhZ2VDaGVja3BvaW50IHsgc3RhZ2VfaWQsIGNoZWNrcG9pbnQsIG1heF9ibG9ja19udW1iZXIsIGVsYXBzZWQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgc3RhZ2VfbWV0cmljcyA9IHNlbGYuc3luY19tZXRyaWNzLmdldF9zdGFnZV9tZXRyaWNzKHN0YWdlX2lkKTsKCiAgICAgICAgICAgICAgICBzdGFnZV9tZXRyaWNzLnRvdGFsX2VsYXBzZWQuaW5jcmVtZW50KGVsYXBzZWQuYXNfc2Vjc19mNjQoKSk7CiAgICAgICAgICAgICAgICBzdGFnZV9tZXRyaWNzLmNoZWNrcG9pbnQuc2V0KGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyIGFzIGY2NCk7CgogICAgICAgICAgICAgICAgbGV0IChwcm9jZXNzZWQsIHRvdGFsKSA9IG1hdGNoIGNoZWNrcG9pbnQuZW50aXRpZXMoKSB7CiAgICAgICAgICAgICAgICAgICAgU29tZShlbnRpdGllcykgPT4gKGVudGl0aWVzLnByb2Nlc3NlZCwgU29tZShlbnRpdGllcy50b3RhbCkpLAogICAgICAgICAgICAgICAgICAgIE5vbmUgPT4gKGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyLCBtYXhfYmxvY2tfbnVtYmVyKSwKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgc3RhZ2VfbWV0cmljcy5lbnRpdGllc19wcm9jZXNzZWQuc2V0KHByb2Nlc3NlZCBhcyBmNjQpOwoKICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKHRvdGFsKSA9IHRvdGFsIHsKICAgICAgICAgICAgICAgICAgICBzdGFnZV9tZXRyaWNzLmVudGl0aWVzX3RvdGFsLnNldCh0b3RhbCBhcyBmNjQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBVcGRhdGVzIGFsbCBzdGFnZSBjaGVja3BvaW50cyB0byB0aGUgZ2l2ZW4gaGVpZ2h0IGVmZmljaWVudGx5LgogICAgZm4gdXBkYXRlX2FsbF9zdGFnZXNfaGVpZ2h0KCZtdXQgc2VsZiwgaGVpZ2h0OiBCbG9ja051bWJlcikgewogICAgICAgIGZvciBzdGFnZV9pZCBpbiBTdGFnZUlkOjpBTEwgewogICAgICAgICAgICBsZXQgc3RhZ2VfbWV0cmljcyA9IHNlbGYuc3luY19tZXRyaWNzLmdldF9zdGFnZV9tZXRyaWNzKHN0YWdlX2lkKTsKICAgICAgICAgICAgbGV0IGhlaWdodF9mNjQgPSBoZWlnaHQgYXMgZjY0OwogICAgICAgICAgICBzdGFnZV9tZXRyaWNzLmNoZWNrcG9pbnQuc2V0KGhlaWdodF9mNjQpOwogICAgICAgICAgICBzdGFnZV9tZXRyaWNzLmVudGl0aWVzX3Byb2Nlc3NlZC5zZXQoaGVpZ2h0X2Y2NCk7CiAgICAgICAgICAgIHN0YWdlX21ldHJpY3MuZW50aXRpZXNfdG90YWwuc2V0KGhlaWdodF9mNjQpOwogICAgICAgIH0KICAgIH0KfQoKaW1wbCBGdXR1cmUgZm9yIE1ldHJpY3NMaXN0ZW5lciB7CiAgICB0eXBlIE91dHB1dCA9ICgpOwoKICAgIGZuIHBvbGwoc2VsZjogUGluPCZtdXQgU2VsZj4sIGN4OiAmbXV0IENvbnRleHQ8J18+KSAtPiBQb2xsPFNlbGY6Ok91dHB1dD4gewogICAgICAgIGxldCB0aGlzID0gc2VsZi5nZXRfbXV0KCk7CgogICAgICAgIC8vIExvb3AgdW50aWwgd2UgZHJhaW4gdGhlIGBldmVudHNfcnhgIGNoYW5uZWwKICAgICAgICBsb29wIHsKICAgICAgICAgICAgbGV0IFNvbWUoZXZlbnQpID0gcmVhZHkhKHRoaXMuZXZlbnRzX3J4LnBvbGxfcmVjdihjeCkpIGVsc2UgewogICAgICAgICAgICAgICAgLy8gQ2hhbm5lbCBoYXMgY2xvc2VkCiAgICAgICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLmhhbmRsZV9ldmVudChldmVudCk7CiAgICAgICAgfQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvYXBpL3NyYy9tZXRyaWNzL21vZC5ycyI+Cm1vZCBsaXN0ZW5lcjsKbW9kIHN5bmNfbWV0cmljczsKCnB1YiB1c2UgbGlzdGVuZXI6OntNZXRyaWNFdmVudCwgTWV0cmljRXZlbnRzU2VuZGVyLCBNZXRyaWNzTGlzdGVuZXJ9Owp1c2Ugc3luY19tZXRyaWNzOjoqOwo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvc3RhZ2VzL2FwaS9zcmMvbWV0cmljcy9zeW5jX21ldHJpY3MucnMiPgp1c2UgY3JhdGU6OlN0YWdlSWQ7CnVzZSByZXRoX21ldHJpY3M6OnttZXRyaWNzOjpHYXVnZSwgTWV0cmljc307CnVzZSBzdGQ6OmNvbGxlY3Rpb25zOjpIYXNoTWFwOwoKI1tkZXJpdmUoRGVidWcsIERlZmF1bHQpXQpwdWIoY3JhdGUpIHN0cnVjdCBTeW5jTWV0cmljcyB7CiAgICAvLy8gU3RhZ2UgbWV0cmljcyBieSBzdGFnZS4KICAgIHB1YihjcmF0ZSkgc3RhZ2VzOiBIYXNoTWFwPFN0YWdlSWQsIFN0YWdlTWV0cmljcz4sCn0KCmltcGwgU3luY01ldHJpY3MgewogICAgLy8vIFJldHVybnMgZXhpc3Rpbmcgb3IgaW5pdGlhbGl6ZXMgYSBuZXcgaW5zdGFuY2Ugb2YgW2BTdGFnZU1ldHJpY3NgXSBmb3IgdGhlIHByb3ZpZGVkCiAgICAvLy8gW2BTdGFnZUlkYF0uCiAgICBwdWIoY3JhdGUpIGZuIGdldF9zdGFnZV9tZXRyaWNzKCZtdXQgc2VsZiwgc3RhZ2VfaWQ6IFN0YWdlSWQpIC0+ICZtdXQgU3RhZ2VNZXRyaWNzIHsKICAgICAgICBzZWxmLnN0YWdlcwogICAgICAgICAgICAuZW50cnkoc3RhZ2VfaWQpCiAgICAgICAgICAgIC5vcl9pbnNlcnRfd2l0aCh8fCBTdGFnZU1ldHJpY3M6Om5ld193aXRoX2xhYmVscygmWygic3RhZ2UiLCBzdGFnZV9pZC50b19zdHJpbmcoKSldKSkKICAgIH0KfQoKI1tkZXJpdmUoTWV0cmljcyldCiNbbWV0cmljcyhzY29wZSA9ICJzeW5jIildCnB1YihjcmF0ZSkgc3RydWN0IFN0YWdlTWV0cmljcyB7CiAgICAvLy8gVGhlIGJsb2NrIG51bWJlciBvZiB0aGUgbGFzdCBjb21taXQgZm9yIGEgc3RhZ2UuCiAgICBwdWIoY3JhdGUpIGNoZWNrcG9pbnQ6IEdhdWdlLAogICAgLy8vIFRoZSBudW1iZXIgb2YgcHJvY2Vzc2VkIGVudGl0aWVzIG9mIHRoZSBsYXN0IGNvbW1pdCBmb3IgYSBzdGFnZSwgaWYgYXBwbGljYWJsZS4KICAgIHB1YihjcmF0ZSkgZW50aXRpZXNfcHJvY2Vzc2VkOiBHYXVnZSwKICAgIC8vLyBUaGUgbnVtYmVyIG9mIHRvdGFsIGVudGl0aWVzIG9mIHRoZSBsYXN0IGNvbW1pdCBmb3IgYSBzdGFnZSwgaWYgYXBwbGljYWJsZS4KICAgIHB1YihjcmF0ZSkgZW50aXRpZXNfdG90YWw6IEdhdWdlLAogICAgLy8vIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyBzcGVudCBleGVjdXRpbmcgdGhlIHN0YWdlIGFuZCBjb21taXR0aW5nIHRoZSBkYXRhLgogICAgcHViKGNyYXRlKSB0b3RhbF9lbGFwc2VkOiBHYXVnZSwKfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvc3RhZ2VzL2FwaS9zcmMvcGlwZWxpbmUvYnVpbGRlci5ycyI+CnVzZSBjcmF0ZTo6e3BpcGVsaW5lOjpCb3hlZFN0YWdlLCBNZXRyaWNFdmVudHNTZW5kZXIsIFBpcGVsaW5lLCBTdGFnZSwgU3RhZ2VJZCwgU3RhZ2VTZXR9Owp1c2UgYWxsb3lfcHJpbWl0aXZlczo6e0Jsb2NrTnVtYmVyLCBCMjU2fTsKdXNlIHJldGhfcHJvdmlkZXI6Ontwcm92aWRlcnM6OlByb3ZpZGVyTm9kZVR5cGVzLCBEYXRhYmFzZVByb3ZpZGVyRmFjdG9yeSwgUHJvdmlkZXJGYWN0b3J5fTsKdXNlIHJldGhfc3RhdGljX2ZpbGU6OlN0YXRpY0ZpbGVQcm9kdWNlcjsKdXNlIHRva2lvOjpzeW5jOjp3YXRjaDsKCi8vLyBCdWlsZHMgYSBbYFBpcGVsaW5lYF0uCiNbbXVzdF91c2UgPSAiY2FsbCBgYnVpbGRgIHRvIGNvbnN0cnVjdCB0aGUgcGlwZWxpbmUiXQpwdWIgc3RydWN0IFBpcGVsaW5lQnVpbGRlcjxQcm92aWRlcj4gewogICAgLy8vIEFsbCBjb25maWd1cmVkIHN0YWdlcyBpbiB0aGUgb3JkZXIgdGhleSB3aWxsIGJlIGV4ZWN1dGVkLgogICAgc3RhZ2VzOiBWZWM8Qm94ZWRTdGFnZTxQcm92aWRlcj4+LAogICAgLy8vIFRoZSBtYXhpbXVtIGJsb2NrIG51bWJlciB0byBzeW5jIHRvLgogICAgbWF4X2Jsb2NrOiBPcHRpb248QmxvY2tOdW1iZXI+LAogICAgLy8vIEEgU2VuZGVyIGZvciB0aGUgY3VycmVudCBjaGFpbiB0aXAgdG8gc3luYyB0by4KICAgIHRpcF90eDogT3B0aW9uPHdhdGNoOjpTZW5kZXI8QjI1Nj4+LAogICAgbWV0cmljc190eDogT3B0aW9uPE1ldHJpY0V2ZW50c1NlbmRlcj4sCiAgICBmYWlsX29uX3Vud2luZDogYm9vbCwKfQoKaW1wbDxQcm92aWRlcj4gUGlwZWxpbmVCdWlsZGVyPFByb3ZpZGVyPiB7CiAgICAvLy8gQWRkIGEgc3RhZ2UgdG8gdGhlIHBpcGVsaW5lLgogICAgcHViIGZuIGFkZF9zdGFnZTxTPihtdXQgc2VsZiwgc3RhZ2U6IFMpIC0+IFNlbGYKICAgIHdoZXJlCiAgICAgICAgUzogU3RhZ2U8UHJvdmlkZXI+ICsgJ3N0YXRpYywKICAgIHsKICAgICAgICBzZWxmLnN0YWdlcy5wdXNoKEJveDo6bmV3KHN0YWdlKSk7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBBZGQgYSBzZXQgb2Ygc3RhZ2VzIHRvIHRoZSBwaXBlbGluZS4KICAgIC8vLwogICAgLy8vIFN0YWdlcyBjYW4gYmUgZ3JvdXBlZCBpbnRvIGEgc2V0IGJ5IHVzaW5nIGEgW2BTdGFnZVNldGBdLgogICAgLy8vCiAgICAvLy8gVG8gY3VzdG9taXplIHRoZSBzdGFnZXMgaW4gdGhlIHNldCAocmVvcmRlciwgZGlzYWJsZSwgaW5zZXJ0IGEgc3RhZ2UpIGNhbGwKICAgIC8vLyBbYGJ1aWxkZXJgXVtTdGFnZVNldDo6YnVpbGRlcl0gb24gdGhlIHNldCB3aGljaCB3aWxsIGNvbnZlcnQgaXQgdG8gYQogICAgLy8vIFtgU3RhZ2VTZXRCdWlsZGVyYF1bY3JhdGU6OlN0YWdlU2V0QnVpbGRlcl0uCiAgICBwdWIgZm4gYWRkX3N0YWdlczxTZXQ6IFN0YWdlU2V0PFByb3ZpZGVyPj4obXV0IHNlbGYsIHNldDogU2V0KSAtPiBTZWxmIHsKICAgICAgICBsZXQgc3RhZ2VzID0gc2V0LmJ1aWxkZXIoKS5idWlsZCgpOwogICAgICAgIHNlbGYuc3RhZ2VzLnJlc2VydmUoc3RhZ2VzLmxlbigpKTsKICAgICAgICBzZWxmLnN0YWdlcy5leHRlbmQoc3RhZ2VzKTsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIFNldCB0aGUgdGFyZ2V0IGJsb2NrLgogICAgLy8vCiAgICAvLy8gT25jZSB0aGlzIGJsb2NrIGlzIHJlYWNoZWQsIHRoZSBwaXBlbGluZSB3aWxsIHN0b3AuCiAgICBwdWIgY29uc3QgZm4gd2l0aF9tYXhfYmxvY2sobXV0IHNlbGYsIGJsb2NrOiBCbG9ja051bWJlcikgLT4gU2VsZiB7CiAgICAgICAgc2VsZi5tYXhfYmxvY2sgPSBTb21lKGJsb2NrKTsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIFNldCB0aGUgdGlwIHNlbmRlci4KICAgIHB1YiBmbiB3aXRoX3RpcF9zZW5kZXIobXV0IHNlbGYsIHRpcF90eDogd2F0Y2g6OlNlbmRlcjxCMjU2PikgLT4gU2VsZiB7CiAgICAgICAgc2VsZi50aXBfdHggPSBTb21lKHRpcF90eCk7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBTZXQgdGhlIG1ldHJpYyBldmVudHMgc2VuZGVyLgogICAgcHViIGZuIHdpdGhfbWV0cmljc190eChtdXQgc2VsZiwgbWV0cmljc190eDogTWV0cmljRXZlbnRzU2VuZGVyKSAtPiBTZWxmIHsKICAgICAgICBzZWxmLm1ldHJpY3NfdHggPSBTb21lKG1ldHJpY3NfdHgpOwogICAgICAgIHNlbGYKICAgIH0KCiAgICAvLy8gU2V0IHdoZXRoZXIgcGlwZWxpbmUgc2hvdWxkIGZhaWwgb24gdW53aW5kLgogICAgcHViIGNvbnN0IGZuIHdpdGhfZmFpbF9vbl91bndpbmQobXV0IHNlbGYsIHllczogYm9vbCkgLT4gU2VsZiB7CiAgICAgICAgc2VsZi5mYWlsX29uX3Vud2luZCA9IHllczsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIEJ1aWxkcyB0aGUgZmluYWwgW2BQaXBlbGluZWBdIHVzaW5nIHRoZSBnaXZlbiBkYXRhYmFzZS4KICAgIHB1YiBmbiBidWlsZDxOPigKICAgICAgICBzZWxmLAogICAgICAgIHByb3ZpZGVyX2ZhY3Rvcnk6IFByb3ZpZGVyRmFjdG9yeTxOPiwKICAgICAgICBzdGF0aWNfZmlsZV9wcm9kdWNlcjogU3RhdGljRmlsZVByb2R1Y2VyPFByb3ZpZGVyRmFjdG9yeTxOPj4sCiAgICApIC0+IFBpcGVsaW5lPE4+CiAgICB3aGVyZQogICAgICAgIE46IFByb3ZpZGVyTm9kZVR5cGVzLAogICAgICAgIFByb3ZpZGVyRmFjdG9yeTxOPjogRGF0YWJhc2VQcm92aWRlckZhY3Rvcnk8UHJvdmlkZXJSVyA9IFByb3ZpZGVyPiwKICAgIHsKICAgICAgICBsZXQgU2VsZiB7IHN0YWdlcywgbWF4X2Jsb2NrLCB0aXBfdHgsIG1ldHJpY3NfdHgsIGZhaWxfb25fdW53aW5kIH0gPSBzZWxmOwogICAgICAgIFBpcGVsaW5lIHsKICAgICAgICAgICAgcHJvdmlkZXJfZmFjdG9yeSwKICAgICAgICAgICAgc3RhZ2VzLAogICAgICAgICAgICBtYXhfYmxvY2ssCiAgICAgICAgICAgIHN0YXRpY19maWxlX3Byb2R1Y2VyLAogICAgICAgICAgICB0aXBfdHgsCiAgICAgICAgICAgIGV2ZW50X3NlbmRlcjogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICBwcm9ncmVzczogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICBtZXRyaWNzX3R4LAogICAgICAgICAgICBmYWlsX29uX3Vud2luZCwKICAgICAgICAgICAgbGFzdF9kZXRhY2hlZF9oZWFkX3Vud2luZF90YXJnZXQ6IE5vbmUsCiAgICAgICAgICAgIGRldGFjaGVkX2hlYWRfYXR0ZW1wdHM6IDAsCiAgICAgICAgfQogICAgfQp9CgppbXBsPFByb3ZpZGVyPiBEZWZhdWx0IGZvciBQaXBlbGluZUJ1aWxkZXI8UHJvdmlkZXI+IHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgc3RhZ2VzOiBWZWM6Om5ldygpLAogICAgICAgICAgICBtYXhfYmxvY2s6IE5vbmUsCiAgICAgICAgICAgIHRpcF90eDogTm9uZSwKICAgICAgICAgICAgbWV0cmljc190eDogTm9uZSwKICAgICAgICAgICAgZmFpbF9vbl91bndpbmQ6IGZhbHNlLAogICAgICAgIH0KICAgIH0KfQoKaW1wbDxQcm92aWRlcj4gc3RkOjpmbXQ6OkRlYnVnIGZvciBQaXBlbGluZUJ1aWxkZXI8UHJvdmlkZXI+IHsKICAgIGZuIGZtdCgmc2VsZiwgZjogJm11dCBzdGQ6OmZtdDo6Rm9ybWF0dGVyPCdfPikgLT4gc3RkOjpmbXQ6OlJlc3VsdCB7CiAgICAgICAgZi5kZWJ1Z19zdHJ1Y3QoIlBpcGVsaW5lQnVpbGRlciIpCiAgICAgICAgICAgIC5maWVsZCgic3RhZ2VzIiwgJnNlbGYuc3RhZ2VzLml0ZXIoKS5tYXAofHN0YWdlfCBzdGFnZS5pZCgpKS5jb2xsZWN0Ojo8VmVjPFN0YWdlSWQ+PigpKQogICAgICAgICAgICAuZmllbGQoIm1heF9ibG9jayIsICZzZWxmLm1heF9ibG9jaykKICAgICAgICAgICAgLmZpZWxkKCJmYWlsX29uX3Vud2luZCIsICZzZWxmLmZhaWxfb25fdW53aW5kKQogICAgICAgICAgICAuZmluaXNoKCkKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvc3RhZ2VzL2FwaS9zcmMvcGlwZWxpbmUvY3RybC5ycyI+CnVzZSBhbGxveV9laXBzOjplaXAxODk4OjpCbG9ja1dpdGhQYXJlbnQ7CnVzZSBhbGxveV9wcmltaXRpdmVzOjpCbG9ja051bWJlcjsKCi8vLyBEZXRlcm1pbmVzIHRoZSBjb250cm9sIGZsb3cgZHVyaW5nIHBpcGVsaW5lIGV4ZWN1dGlvbi4KLy8vCi8vLyBTZWUgW2BQaXBlbGluZTo6cnVuX2xvb3BgXShjcmF0ZTo6UGlwZWxpbmU6OnJ1bl9sb29wKSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KI1tkZXJpdmUoRGVidWcsIENsb25lLCBFcSwgUGFydGlhbEVxKV0KcHViIGVudW0gQ29udHJvbEZsb3cgewogICAgLy8vIEFuIHVud2luZCB3YXMgcmVxdWVzdGVkIGFuZCBtdXN0IGJlIHBlcmZvcm1lZCBiZWZvcmUgY29udGludWluZy4KICAgIFVud2luZCB7CiAgICAgICAgLy8vIFRoZSBibG9jayB0byB1bndpbmQgdG8uCiAgICAgICAgLy8vCiAgICAgICAgLy8vIFRoaXMgbWFya3MgdGhlIGhpZ2hlc3QgYmxvY2sgdG8gd2hpY2ggdGhlIHN0YWdlIHNob3VsZCB1bndpbmQgdG8uCiAgICAgICAgLy8vIEZvciBleGFtcGxlLCB1bndpbmRpbmcgdG8gYmxvY2sgMTAsIHNob3VsZCByZW1vdmUgYWxsIGRhdGEgZm9yIGJsb2NrcyBhYm92ZSAxMCAoPj0xMSkuCiAgICAgICAgdGFyZ2V0OiBCbG9ja051bWJlciwKICAgICAgICAvLy8gVGhlIGJsb2NrIHRoYXQgY2F1c2VkIHRoZSB1bndpbmQuCiAgICAgICAgYmFkX2Jsb2NrOiBCb3g8QmxvY2tXaXRoUGFyZW50PiwKICAgIH0sCiAgICAvLy8gVGhlIHBpcGVsaW5lIG1hZGUgcHJvZ3Jlc3MuCiAgICBDb250aW51ZSB7CiAgICAgICAgLy8vIEJsb2NrIG51bWJlciByZWFjaGVkIGJ5IHRoZSBzdGFnZS4KICAgICAgICBibG9ja19udW1iZXI6IEJsb2NrTnVtYmVyLAogICAgfSwKICAgIC8vLyBQaXBlbGluZSBtYWRlIG5vIHByb2dyZXNzCiAgICBOb1Byb2dyZXNzIHsKICAgICAgICAvLy8gQmxvY2sgbnVtYmVyIHJlYWNoZWQgYnkgdGhlIHN0YWdlLgogICAgICAgIGJsb2NrX251bWJlcjogT3B0aW9uPEJsb2NrTnVtYmVyPiwKICAgIH0sCn0KCmltcGwgQ29udHJvbEZsb3cgewogICAgLy8vIFdoZXRoZXIgdGhlIHBpcGVsaW5lIHNob3VsZCBjb250aW51ZSBleGVjdXRpbmcgc3RhZ2VzLgogICAgcHViIGNvbnN0IGZuIHNob3VsZF9jb250aW51ZSgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgbWF0Y2hlcyEoc2VsZiwgU2VsZjo6Q29udGludWUgeyAuLiB9IHwgU2VsZjo6Tm9Qcm9ncmVzcyB7IC4uIH0pCiAgICB9CgogICAgLy8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgY29udHJvbCBmbG93IGlzIHVud2luZC4KICAgIHB1YiBjb25zdCBmbiBpc191bndpbmQoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIG1hdGNoZXMhKHNlbGYsIFNlbGY6OlVud2luZCB7IC4uIH0pCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIHBpcGVsaW5lIGJsb2NrIG51bWJlciB0aGUgc3RhZ2UgcmVhY2hlZCwgaWYgdGhlIHN0YXRlIGlzIG5vdCBgVW53aW5kYC4KICAgIHB1YiBjb25zdCBmbiBibG9ja19udW1iZXIoJnNlbGYpIC0+IE9wdGlvbjxCbG9ja051bWJlcj4gewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpVbndpbmQgeyAuLiB9ID0+IE5vbmUsCiAgICAgICAgICAgIFNlbGY6OkNvbnRpbnVlIHsgYmxvY2tfbnVtYmVyIH0gPT4gU29tZSgqYmxvY2tfbnVtYmVyKSwKICAgICAgICAgICAgU2VsZjo6Tm9Qcm9ncmVzcyB7IGJsb2NrX251bWJlciB9ID0+ICpibG9ja19udW1iZXIsCiAgICAgICAgfQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvYXBpL3NyYy9waXBlbGluZS9ldmVudC5ycyI+CnVzZSBjcmF0ZTo6ewogICAgc3RhZ2U6OntFeGVjT3V0cHV0LCBVbndpbmRJbnB1dCwgVW53aW5kT3V0cHV0fSwKICAgIFN0YWdlQ2hlY2twb2ludCwgU3RhZ2VJZCwKfTsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkJsb2NrTnVtYmVyOwp1c2Ugc3RkOjpmbXQ6OntEaXNwbGF5LCBGb3JtYXR0ZXJ9OwoKLy8vIEFuIGV2ZW50IGVtaXR0ZWQgYnkgYSBbUGlwZWxpbmVdW2NyYXRlOjpQaXBlbGluZV0uCi8vLwovLy8gSXQgaXMgcG9zc2libGUgZm9yIG11bHRpcGxlIG9mIHRoZXNlIGV2ZW50cyB0byBiZSBlbWl0dGVkIG92ZXIgdGhlIGR1cmF0aW9uIG9mIGEgcGlwZWxpbmUncwovLy8gZXhlY3V0aW9uIHNpbmNlOgovLy8KLy8vIC0gT3RoZXIgc3RhZ2VzIG1heSBhc2sgdGhlIHBpcGVsaW5lIHRvIHVud2luZAovLy8gLSBUaGUgcGlwZWxpbmUgd2lsbCBsb29wIGluZGVmaW5pdGVseSB1bmxlc3MgYSB0YXJnZXQgYmxvY2sgaXMgc2V0CiNbZGVyaXZlKERlYnVnLCBQYXJ0aWFsRXEsIEVxLCBDbG9uZSldCnB1YiBlbnVtIFBpcGVsaW5lRXZlbnQgewogICAgLy8vIEVtaXR0ZWQgd2hlbiBhIHN0YWdlIGlzIGFib3V0IHRvIGJlIHByZXBhcmVkIGZvciBhIHJ1bi4KICAgIFByZXBhcmUgewogICAgICAgIC8vLyBQaXBlbGluZSBzdGFnZXMgcHJvZ3Jlc3MuCiAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzLAogICAgICAgIC8vLyBUaGUgc3RhZ2UgdGhhdCBpcyBhYm91dCB0byBiZSBydW4uCiAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQsCiAgICAgICAgLy8vIFRoZSBwcmV2aW91cyBjaGVja3BvaW50IG9mIHRoZSBzdGFnZS4KICAgICAgICBjaGVja3BvaW50OiBPcHRpb248U3RhZ2VDaGVja3BvaW50PiwKICAgICAgICAvLy8gVGhlIGJsb2NrIG51bWJlciB1cCB0byB3aGljaCB0aGUgc3RhZ2UgaXMgcnVubmluZywgaWYga25vd24uCiAgICAgICAgdGFyZ2V0OiBPcHRpb248QmxvY2tOdW1iZXI+LAogICAgfSwKICAgIC8vLyBFbWl0dGVkIHdoZW4gYSBzdGFnZSBpcyBhYm91dCB0byBiZSBydW4uCiAgICBSdW4gewogICAgICAgIC8vLyBQaXBlbGluZSBzdGFnZXMgcHJvZ3Jlc3MuCiAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzLAogICAgICAgIC8vLyBUaGUgc3RhZ2UgdGhhdCBpcyBhYm91dCB0byBiZSBydW4uCiAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQsCiAgICAgICAgLy8vIFRoZSBwcmV2aW91cyBjaGVja3BvaW50IG9mIHRoZSBzdGFnZS4KICAgICAgICBjaGVja3BvaW50OiBPcHRpb248U3RhZ2VDaGVja3BvaW50PiwKICAgICAgICAvLy8gVGhlIGJsb2NrIG51bWJlciB1cCB0byB3aGljaCB0aGUgc3RhZ2UgaXMgcnVubmluZywgaWYga25vd24uCiAgICAgICAgdGFyZ2V0OiBPcHRpb248QmxvY2tOdW1iZXI+LAogICAgfSwKICAgIC8vLyBFbWl0dGVkIHdoZW4gYSBzdGFnZSBoYXMgcnVuIGEgc2luZ2xlIHRpbWUuCiAgICBSYW4gewogICAgICAgIC8vLyBQaXBlbGluZSBzdGFnZXMgcHJvZ3Jlc3MuCiAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzLAogICAgICAgIC8vLyBUaGUgc3RhZ2UgdGhhdCB3YXMgcnVuLgogICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkLAogICAgICAgIC8vLyBUaGUgcmVzdWx0IG9mIGV4ZWN1dGluZyB0aGUgc3RhZ2UuCiAgICAgICAgcmVzdWx0OiBFeGVjT3V0cHV0LAogICAgfSwKICAgIC8vLyBFbWl0dGVkIHdoZW4gYSBzdGFnZSBpcyBhYm91dCB0byBiZSB1bndvdW5kLgogICAgVW53aW5kIHsKICAgICAgICAvLy8gVGhlIHN0YWdlIHRoYXQgaXMgYWJvdXQgdG8gYmUgdW53b3VuZC4KICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZCwKICAgICAgICAvLy8gVGhlIHVud2luZCBwYXJhbWV0ZXJzLgogICAgICAgIGlucHV0OiBVbndpbmRJbnB1dCwKICAgIH0sCiAgICAvLy8gRW1pdHRlZCB3aGVuIGEgc3RhZ2UgaGFzIGJlZW4gdW53b3VuZC4KICAgIFVud291bmQgewogICAgICAgIC8vLyBUaGUgc3RhZ2UgdGhhdCB3YXMgdW53b3VuZC4KICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZCwKICAgICAgICAvLy8gVGhlIHJlc3VsdCBvZiB1bndpbmRpbmcgdGhlIHN0YWdlLgogICAgICAgIHJlc3VsdDogVW53aW5kT3V0cHV0LAogICAgfSwKICAgIC8vLyBFbWl0dGVkIHdoZW4gYSBzdGFnZSBlbmNvdW50ZXJzIGFuIGVycm9yIGVpdGhlciBkdXJpbmcgZXhlY3V0aW9uIG9yIHVud2luZGluZy4KICAgIEVycm9yIHsKICAgICAgICAvLy8gVGhlIHN0YWdlIHRoYXQgZW5jb3VudGVyZWQgYW4gZXJyb3IuCiAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQsCiAgICB9LAogICAgLy8vIEVtaXR0ZWQgd2hlbiBhIHN0YWdlIHdhcyBza2lwcGVkIGR1ZSB0byBpdCdzIHJ1biBjb25kaXRpb25zIG5vdCBiZWluZyBtZXQ6CiAgICAvLy8KICAgIC8vLyAtIFRoZSBzdGFnZSBtaWdodCBoYXZlIHByb2dyZXNzZWQgYmV5b25kIHRoZSBwb2ludCBvZiBvdXIgdGFyZ2V0IGJsb2NrCiAgICAvLy8gLSBUaGUgc3RhZ2UgbWlnaHQgbm90IG5lZWQgdG8gYmUgdW53b3VuZCBzaW5jZSBpdCBoYXMgbm90IHByb2dyZXNzZWQgcGFzdCB0aGUgdW53aW5kIHRhcmdldAogICAgLy8vIC0gVGhlIHN0YWdlIHJlcXVpcmVzIHRoYXQgdGhlIHBpcGVsaW5lIGhhcyByZWFjaGVkIHRoZSB0aXAsIGJ1dCBpdCBoYXMgbm90IGRvbmUgc28geWV0CiAgICBTa2lwcGVkIHsKICAgICAgICAvLy8gVGhlIHN0YWdlIHRoYXQgd2FzIHNraXBwZWQuCiAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQsCiAgICB9LAp9CgovLy8gUGlwZWxpbmUgc3RhZ2VzIHByb2dyZXNzLgojW2Rlcml2ZShEZWJ1ZywgUGFydGlhbEVxLCBFcSwgQ2xvbmUpXQpwdWIgc3RydWN0IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgewogICAgLy8vIDEtaW5kZXhlZCBJRCBvZiB0aGUgc3RhZ2UgdGhhdCBpcyBhYm91dCB0byBiZSBydW4gb3V0IG9mIHRvdGFsIHN0YWdlcyBpbiB0aGUgcGlwZWxpbmUuCiAgICBwdWIgY3VycmVudDogdXNpemUsCiAgICAvLy8gVG90YWwgbnVtYmVyIG9mIHN0YWdlcyBpbiB0aGUgcGlwZWxpbmUuCiAgICBwdWIgdG90YWw6IHVzaXplLAp9CgppbXBsIERpc3BsYXkgZm9yIFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgewogICAgZm4gZm10KCZzZWxmLCBmOiAmbXV0IEZvcm1hdHRlcjwnXz4pIC0+IHN0ZDo6Zm10OjpSZXN1bHQgewogICAgICAgIHdyaXRlIShmLCAie30ve30iLCBzZWxmLmN1cnJlbnQsIHNlbGYudG90YWwpCiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9hcGkvc3JjL3BpcGVsaW5lL21vZC5ycyI+Cm1vZCBjdHJsOwptb2QgZXZlbnQ7CnB1YiB1c2UgY3JhdGU6OnBpcGVsaW5lOjpjdHJsOjpDb250cm9sRmxvdzsKdXNlIGNyYXRlOjp7UGlwZWxpbmVUYXJnZXQsIFN0YWdlQ2hlY2twb2ludCwgU3RhZ2VJZH07CnVzZSBhbGxveV9wcmltaXRpdmVzOjp7QmxvY2tOdW1iZXIsIEIyNTZ9OwpwdWIgdXNlIGV2ZW50OjoqOwp1c2UgZnV0dXJlc191dGlsOjpGdXR1cmU7CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjpjb25zdGFudHM6OkJFQUNPTl9DT05TRU5TVVNfUkVPUkdfVU5XSU5EX0RFUFRIOwp1c2UgcmV0aF9wcm92aWRlcjo6ewogICAgcHJvdmlkZXJzOjpQcm92aWRlck5vZGVUeXBlcywgQmxvY2tIYXNoUmVhZGVyLCBCbG9ja051bVJlYWRlciwgQ2hhaW5TdGF0ZUJsb2NrUmVhZGVyLAogICAgQ2hhaW5TdGF0ZUJsb2NrV3JpdGVyLCBEQlByb3ZpZGVyLCBEYXRhYmFzZVByb3ZpZGVyRmFjdG9yeSwgUHJvdmlkZXJGYWN0b3J5LAogICAgUHJ1bmVDaGVja3BvaW50UmVhZGVyLCBTdGFnZUNoZWNrcG9pbnRSZWFkZXIsIFN0YWdlQ2hlY2twb2ludFdyaXRlciwKfTsKdXNlIHJldGhfcHJ1bmU6OlBydW5lckJ1aWxkZXI7CnVzZSByZXRoX3N0YXRpY19maWxlOjpTdGF0aWNGaWxlUHJvZHVjZXI7CnVzZSByZXRoX3Rva2lvX3V0aWw6OntFdmVudFNlbmRlciwgRXZlbnRTdHJlYW19Owp1c2Ugc3RkOjp7CiAgICBwaW46OlBpbiwKICAgIHRpbWU6OntEdXJhdGlvbiwgSW5zdGFudH0sCn07CnVzZSB0b2tpbzo6c3luYzo6d2F0Y2g7CnVzZSB0cmFjaW5nOjoqOwoKbW9kIGJ1aWxkZXI7Cm1vZCBwcm9ncmVzczsKbW9kIHNldDsKCnVzZSBjcmF0ZTo6ewogICAgQmxvY2tFcnJvcktpbmQsIEV4ZWNJbnB1dCwgRXhlY091dHB1dCwgTWV0cmljRXZlbnQsIE1ldHJpY0V2ZW50c1NlbmRlciwgUGlwZWxpbmVFcnJvciwgU3RhZ2UsCiAgICBTdGFnZUVycm9yLCBTdGFnZUV4dCwgVW53aW5kSW5wdXQsCn07CnB1YiB1c2UgYnVpbGRlcjo6KjsKdXNlIHByb2dyZXNzOjoqOwp1c2UgcmV0aF9lcnJvcnM6OlJldGhSZXN1bHQ7CnB1YiB1c2Ugc2V0OjoqOwoKLy8vIEEgY29udGFpbmVyIGZvciBhIHF1ZXVlZCBzdGFnZS4KcHViKGNyYXRlKSB0eXBlIEJveGVkU3RhZ2U8REI+ID0gQm94PGR5biBTdGFnZTxEQj4+OwoKLy8vIFRoZSBmdXR1cmUgdGhhdCByZXR1cm5zIHRoZSBvd25lZCBwaXBlbGluZSBhbmQgdGhlIHJlc3VsdCBvZiB0aGUgcGlwZWxpbmUgcnVuLiBTZWUKLy8vIFtgUGlwZWxpbmU6OnJ1bl9hc19mdXRgXS4KcHViIHR5cGUgUGlwZWxpbmVGdXQ8Tj4gPSBQaW48Qm94PGR5biBGdXR1cmU8T3V0cHV0ID0gUGlwZWxpbmVXaXRoUmVzdWx0PE4+PiArIFNlbmQ+PjsKCi8vLyBUaGUgcGlwZWxpbmUgdHlwZSBpdHNlbGYgd2l0aCB0aGUgcmVzdWx0IG9mIFtgUGlwZWxpbmU6OnJ1bl9hc19mdXRgXQpwdWIgdHlwZSBQaXBlbGluZVdpdGhSZXN1bHQ8Tj4gPSAoUGlwZWxpbmU8Tj4sIFJlc3VsdDxDb250cm9sRmxvdywgUGlwZWxpbmVFcnJvcj4pOwoKI1tjZmdfYXR0cihkb2MsIGFxdWFtYXJpbmU6OmFxdWFtYXJpbmUpXQovLy8gQSBzdGFnZWQgc3luYyBwaXBlbGluZS4KLy8vCi8vLyBUaGUgcGlwZWxpbmUgZXhlY3V0ZXMgcXVldWVkIFtzdGFnZXNdW1N0YWdlXSBzZXJpYWxseS4gQW4gZXh0ZXJuYWwgY29tcG9uZW50IGRldGVybWluZXMgdGhlIHRpcAovLy8gb2YgdGhlIGNoYWluIGFuZCB0aGUgcGlwZWxpbmUgdGhlbiBleGVjdXRlcyBlYWNoIHN0YWdlIGluIG9yZGVyIGZyb20gdGhlIGN1cnJlbnQgbG9jYWwgY2hhaW4gdGlwCi8vLyBhbmQgdGhlIGV4dGVybmFsIGNoYWluIHRpcC4gV2hlbiBhIHN0YWdlIGlzIGV4ZWN1dGVkLCBpdCB3aWxsIHJ1biB1bnRpbCBpdCByZWFjaGVzIHRoZSBjaGFpbgovLy8gdGlwLgovLy8KLy8vIEFmdGVyIHRoZSBlbnRpcmUgcGlwZWxpbmUgaGFzIGJlZW4gcnVuLCBpdCB3aWxsIHJ1biBhZ2FpbiB1bmxlc3MgYXNrZWQgdG8gc3RvcCAoc2VlCi8vLyBbYFBpcGVsaW5lOjpzZXRfbWF4X2Jsb2NrYF0pLgovLy8KLy8vIGBpbmNsdWRlX21tZCEoImRvY3MvbWVybWFpZC9waXBlbGluZS5tbWRgIikKLy8vCi8vLyAjIFVud2luZGluZwovLy8KLy8vIEluIGNhc2Ugb2YgYSB2YWxpZGF0aW9uIGVycm9yIChhcyBkZXRlcm1pbmVkIGJ5IHRoZSBjb25zZW5zdXMgZW5naW5lKSBpbiBvbmUgb2YgdGhlIHN0YWdlcywgdGhlCi8vLyBwaXBlbGluZSB3aWxsIHVud2luZCB0aGUgc3RhZ2VzIGluIHJldmVyc2Ugb3JkZXIgb2YgZXhlY3V0aW9uLiBJdCBpcyBhbHNvIHBvc3NpYmxlIHRvCi8vLyByZXF1ZXN0IGFuIHVud2luZCBtYW51YWxseSAoc2VlIFtgUGlwZWxpbmU6OnVud2luZGBdKS4KLy8vCi8vLyAjIERlZmF1bHRzCi8vLwovLy8gVGhlIFtgRGVmYXVsdFN0YWdlc2BdKGNyYXRlOjpzZXRzOjpEZWZhdWx0U3RhZ2VzKSBhcmUgdXNlZCB0byBmdWxseSBzeW5jIHJldGguCnB1YiBzdHJ1Y3QgUGlwZWxpbmU8TjogUHJvdmlkZXJOb2RlVHlwZXM+IHsKICAgIC8vLyBQcm92aWRlciBmYWN0b3J5LgogICAgcHJvdmlkZXJfZmFjdG9yeTogUHJvdmlkZXJGYWN0b3J5PE4+LAogICAgLy8vIEFsbCBjb25maWd1cmVkIHN0YWdlcyBpbiB0aGUgb3JkZXIgdGhleSB3aWxsIGJlIGV4ZWN1dGVkLgogICAgc3RhZ2VzOiBWZWM8Qm94ZWRTdGFnZTw8UHJvdmlkZXJGYWN0b3J5PE4+IGFzIERhdGFiYXNlUHJvdmlkZXJGYWN0b3J5Pjo6UHJvdmlkZXJSVz4+LAogICAgLy8vIFRoZSBtYXhpbXVtIGJsb2NrIG51bWJlciB0byBzeW5jIHRvLgogICAgbWF4X2Jsb2NrOiBPcHRpb248QmxvY2tOdW1iZXI+LAogICAgc3RhdGljX2ZpbGVfcHJvZHVjZXI6IFN0YXRpY0ZpbGVQcm9kdWNlcjxQcm92aWRlckZhY3Rvcnk8Tj4+LAogICAgLy8vIFNlbmRlciBmb3IgZXZlbnRzIHRoZSBwaXBlbGluZSBlbWl0cy4KICAgIGV2ZW50X3NlbmRlcjogRXZlbnRTZW5kZXI8UGlwZWxpbmVFdmVudD4sCiAgICAvLy8gS2VlcHMgdHJhY2sgb2YgdGhlIHByb2dyZXNzIG9mIHRoZSBwaXBlbGluZS4KICAgIHByb2dyZXNzOiBQaXBlbGluZVByb2dyZXNzLAogICAgLy8vIEEgU2VuZGVyIGZvciB0aGUgY3VycmVudCBjaGFpbiB0aXAgdG8gc3luYyB0by4KICAgIC8vLwogICAgLy8vIFRoaXMgaXMgdXNlZCB0byBub3RpZnkgdGhlIGhlYWRlcnMgc3RhZ2UgYWJvdXQgYSBuZXcgc3luYyB0YXJnZXQuCiAgICB0aXBfdHg6IE9wdGlvbjx3YXRjaDo6U2VuZGVyPEIyNTY+PiwKICAgIG1ldHJpY3NfdHg6IE9wdGlvbjxNZXRyaWNFdmVudHNTZW5kZXI+LAogICAgLy8vIFdoZXRoZXIgYW4gdW53aW5kIHNob3VsZCBmYWlsIHRoZSBzeW5jaW5nIHByb2Nlc3MuIFNob3VsZCBvbmx5IGJlIHNldCB3aGVuIGRvd25sb2FkaW5nCiAgICAvLy8gYmxvY2tzIGZyb20gdHJ1c3RlZCBzb3VyY2VzIGFuZCBleHBlY3RpbmcgdGhlbSB0byBiZSB2YWxpZC4KICAgIGZhaWxfb25fdW53aW5kOiBib29sLAogICAgLy8vIEJsb2NrIHRoYXQgd2FzIGNob3NlbiBhcyBhIHRhcmdldCBvZiB0aGUgbGFzdCB1bndpbmQgdHJpZ2dlcmVkIGJ5CiAgICAvLy8gW2BTdGFnZUVycm9yOjpEZXRhY2hlZEhlYWRgXSBlcnJvci4KICAgIGxhc3RfZGV0YWNoZWRfaGVhZF91bndpbmRfdGFyZ2V0OiBPcHRpb248QjI1Nj4sCiAgICAvLy8gTnVtYmVyIG9mIGNvbnNlY3V0aXZlIHVud2luZCBhdHRlbXB0cyBkdWUgdG8gW2BTdGFnZUVycm9yOjpEZXRhY2hlZEhlYWRgXSBmb3IgdGhlIGN1cnJlbnQKICAgIC8vLyBmb3JrLgogICAgZGV0YWNoZWRfaGVhZF9hdHRlbXB0czogdTY0LAp9CgppbXBsPE46IFByb3ZpZGVyTm9kZVR5cGVzPiBQaXBlbGluZTxOPiB7CiAgICAvLy8gQ29uc3RydWN0IGEgcGlwZWxpbmUgdXNpbmcgYSBbYFBpcGVsaW5lQnVpbGRlcmBdLgogICAgcHViIGZuIGJ1aWxkZXIoKSAtPiBQaXBlbGluZUJ1aWxkZXI8PFByb3ZpZGVyRmFjdG9yeTxOPiBhcyBEYXRhYmFzZVByb3ZpZGVyRmFjdG9yeT46OlByb3ZpZGVyUlc+CiAgICB7CiAgICAgICAgUGlwZWxpbmVCdWlsZGVyOjpkZWZhdWx0KCkKICAgIH0KCiAgICAvLy8gUmV0dXJuIHRoZSBtaW5pbXVtIGJsb2NrIG51bWJlciBhY2hpZXZlZCBieQogICAgLy8vIGFueSBzdGFnZSBkdXJpbmcgdGhlIGV4ZWN1dGlvbiBvZiB0aGUgcGlwZWxpbmUuCiAgICBwdWIgY29uc3QgZm4gbWluaW11bV9ibG9ja19udW1iZXIoJnNlbGYpIC0+IE9wdGlvbjx1NjQ+IHsKICAgICAgICBzZWxmLnByb2dyZXNzLm1pbmltdW1fYmxvY2tfbnVtYmVyCiAgICB9CgogICAgLy8vIFNldCB0aXAgZm9yIHJldmVyc2Ugc3luYy4KICAgICNbdHJhY2tfY2FsbGVyXQogICAgcHViIGZuIHNldF90aXAoJnNlbGYsIHRpcDogQjI1NikgewogICAgICAgIGxldCBfID0gc2VsZi50aXBfdHguYXNfcmVmKCkuZXhwZWN0KCJ0aXAgc2VuZGVyIGlzIHNldCIpLnNlbmQodGlwKS5tYXBfZXJyKHxffCB7CiAgICAgICAgICAgIHdhcm4hKHRhcmdldDogInN5bmM6OnBpcGVsaW5lIiwgIkNoYWluIHRpcCBjaGFubmVsIGNsb3NlZCIpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vLyBMaXN0ZW4gZm9yIGV2ZW50cyBvbiB0aGUgcGlwZWxpbmUuCiAgICBwdWIgZm4gZXZlbnRzKCZzZWxmKSAtPiBFdmVudFN0cmVhbTxQaXBlbGluZUV2ZW50PiB7CiAgICAgICAgc2VsZi5ldmVudF9zZW5kZXIubmV3X2xpc3RlbmVyKCkKICAgIH0KCiAgICAvLy8gR2V0IGEgbXV0YWJsZSByZWZlcmVuY2UgdG8gYSBzdGFnZSBieSBpbmRleC4KICAgIHB1YiBmbiBzdGFnZSgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgaWR4OiB1c2l6ZSwKICAgICkgLT4gJm11dCBkeW4gU3RhZ2U8PFByb3ZpZGVyRmFjdG9yeTxOPiBhcyBEYXRhYmFzZVByb3ZpZGVyRmFjdG9yeT46OlByb3ZpZGVyUlc+IHsKICAgICAgICAmbXV0IHNlbGYuc3RhZ2VzW2lkeF0KICAgIH0KfQoKaW1wbDxOOiBQcm92aWRlck5vZGVUeXBlcz4gUGlwZWxpbmU8Tj4gewogICAgLy8vIFJlZ2lzdGVycyBwcm9ncmVzcyBtZXRyaWNzIGZvciBlYWNoIHJlZ2lzdGVyZWQgc3RhZ2UKICAgIHB1YiBmbiByZWdpc3Rlcl9tZXRyaWNzKCZtdXQgc2VsZikgLT4gUmVzdWx0PCgpLCBQaXBlbGluZUVycm9yPiB7CiAgICAgICAgbGV0IFNvbWUobWV0cmljc190eCkgPSAmbXV0IHNlbGYubWV0cmljc190eCBlbHNlIHsgcmV0dXJuIE9rKCgpKSB9OwogICAgICAgIGxldCBwcm92aWRlciA9IHNlbGYucHJvdmlkZXJfZmFjdG9yeS5wcm92aWRlcigpPzsKCiAgICAgICAgZm9yIHN0YWdlIGluICZzZWxmLnN0YWdlcyB7CiAgICAgICAgICAgIGxldCBzdGFnZV9pZCA9IHN0YWdlLmlkKCk7CiAgICAgICAgICAgIGxldCBfID0gbWV0cmljc190eC5zZW5kKE1ldHJpY0V2ZW50OjpTdGFnZUNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgc3RhZ2VfaWQsCiAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBwcm92aWRlci5nZXRfc3RhZ2VfY2hlY2twb2ludChzdGFnZV9pZCk/LnVud3JhcF9vcl9kZWZhdWx0KCksCiAgICAgICAgICAgICAgICBtYXhfYmxvY2tfbnVtYmVyOiBOb25lLAogICAgICAgICAgICAgICAgZWxhcHNlZDogRHVyYXRpb246OmRlZmF1bHQoKSwKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIE9rKCgpKQogICAgfQoKICAgIC8vLyBDb25zdW1lIHRoZSBwaXBlbGluZSBhbmQgcnVuIGl0IHVudGlsIGl0IHJlYWNoZXMgdGhlIHByb3ZpZGVkIHRpcCwgaWYgc2V0LiBSZXR1cm4gdGhlCiAgICAvLy8gcGlwZWxpbmUgYW5kIGl0cyByZXN1bHQgYXMgYSBmdXR1cmUuCiAgICAjW3RyYWNrX2NhbGxlcl0KICAgIHB1YiBmbiBydW5fYXNfZnV0KG11dCBzZWxmLCB0YXJnZXQ6IE9wdGlvbjxQaXBlbGluZVRhcmdldD4pIC0+IFBpcGVsaW5lRnV0PE4+IHsKICAgICAgICBsZXQgXyA9IHNlbGYucmVnaXN0ZXJfbWV0cmljcygpOwogICAgICAgIEJveDo6cGluKGFzeW5jIG1vdmUgewogICAgICAgICAgICAvLyBOT1RFOiB0aGUgdGlwIHNob3VsZCBvbmx5IGJlIE5vbmUgaWYgd2UgYXJlIGluIGNvbnRpbnVvdXMgc3luYyBtb2RlLgogICAgICAgICAgICBpZiBsZXQgU29tZSh0YXJnZXQpID0gdGFyZ2V0IHsKICAgICAgICAgICAgICAgIG1hdGNoIHRhcmdldCB7CiAgICAgICAgICAgICAgICAgICAgUGlwZWxpbmVUYXJnZXQ6OlN5bmModGlwKSA9PiBzZWxmLnNldF90aXAodGlwKSwKICAgICAgICAgICAgICAgICAgICBQaXBlbGluZVRhcmdldDo6VW53aW5kKHRhcmdldCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiBsZXQgRXJyKGVycikgPSBzZWxmLm1vdmVfdG9fc3RhdGljX2ZpbGVzKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChzZWxmLCBFcnIoZXJyLmludG8oKSkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGV0IEVycihlcnIpID0gc2VsZi51bndpbmQodGFyZ2V0LCBOb25lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHNlbGYsIEVycihlcnIpKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHJvZ3Jlc3MudXBkYXRlKHRhcmdldCk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHNlbGYsIE9rKENvbnRyb2xGbG93OjpDb250aW51ZSB7IGJsb2NrX251bWJlcjogdGFyZ2V0IH0pKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHNlbGYucnVuX2xvb3AoKS5hd2FpdDsKICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogInN5bmM6OnBpcGVsaW5lIiwgP3RhcmdldCwgP3Jlc3VsdCwgIlBpcGVsaW5lIGZpbmlzaGVkIik7CiAgICAgICAgICAgIChzZWxmLCByZXN1bHQpCiAgICAgICAgfSkKICAgIH0KCiAgICAvLy8gUnVuIHRoZSBwaXBlbGluZSBpbiBhbiBpbmZpbml0ZSBsb29wLiBXaWxsIHRlcm1pbmF0ZSBlYXJseSBpZiB0aGUgdXNlciBoYXMgc3BlY2lmaWVkCiAgICAvLy8gYSBgbWF4X2Jsb2NrYCBpbiB0aGUgcGlwZWxpbmUuCiAgICBwdWIgYXN5bmMgZm4gcnVuKCZtdXQgc2VsZikgLT4gUmVzdWx0PCgpLCBQaXBlbGluZUVycm9yPiB7CiAgICAgICAgbGV0IF8gPSBzZWxmLnJlZ2lzdGVyX21ldHJpY3MoKTsgLy8gaWdub3JlIGVycm9yCgogICAgICAgIGxvb3AgewogICAgICAgICAgICBsZXQgbmV4dF9hY3Rpb24gPSBzZWxmLnJ1bl9sb29wKCkuYXdhaXQ/OwoKICAgICAgICAgICAgaWYgbmV4dF9hY3Rpb24uaXNfdW53aW5kKCkgJiYgc2VsZi5mYWlsX29uX3Vud2luZCB7CiAgICAgICAgICAgICAgICByZXR1cm4gRXJyKFBpcGVsaW5lRXJyb3I6OlVuZXhwZWN0ZWRVbndpbmQpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRlcm1pbmF0ZSB0aGUgbG9vcCBlYXJseSBpZiBpdCdzIHJlYWNoZWQgdGhlIG1heGltdW0gdXNlcgogICAgICAgICAgICAvLyBjb25maWd1cmVkIGJsb2NrLgogICAgICAgICAgICBpZiBuZXh0X2FjdGlvbi5zaG91bGRfY29udGludWUoKSAmJgogICAgICAgICAgICAgICAgc2VsZi5wcm9ncmVzcwogICAgICAgICAgICAgICAgICAgIC5taW5pbXVtX2Jsb2NrX251bWJlcgogICAgICAgICAgICAgICAgICAgIC56aXAoc2VsZi5tYXhfYmxvY2spCiAgICAgICAgICAgICAgICAgICAgLmlzX3NvbWVfYW5kKHwocHJvZ3Jlc3MsIHRhcmdldCl8IHByb2dyZXNzID49IHRhcmdldCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHJhY2UhKAogICAgICAgICAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnBpcGVsaW5lIiwKICAgICAgICAgICAgICAgICAgICA/bmV4dF9hY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgbWluaW11bV9ibG9ja19udW1iZXIgPSA/c2VsZi5wcm9ncmVzcy5taW5pbXVtX2Jsb2NrX251bWJlciwKICAgICAgICAgICAgICAgICAgICBtYXhfYmxvY2sgPSA/c2VsZi5tYXhfYmxvY2ssCiAgICAgICAgICAgICAgICAgICAgIlRlcm1pbmF0aW5nIHBpcGVsaW5lLiIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICByZXR1cm4gT2soKCkpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8vIFBlcmZvcm1zIG9uZSBwYXNzIG9mIHRoZSBwaXBlbGluZSBhY3Jvc3MgYWxsIHN0YWdlcy4gQWZ0ZXIgc3VjY2Vzc2Z1bAogICAgLy8vIGV4ZWN1dGlvbiBvZiBlYWNoIHN0YWdlLCBpdCBwcm9jZWVkcyB0byBjb21taXQgaXQgdG8gdGhlIGRhdGFiYXNlLgogICAgLy8vCiAgICAvLy8gSWYgYW55IHN0YWdlIGlzIHVuc3VjY2Vzc2Z1bCBhdCBleGVjdXRpb24sIHdlIHByb2NlZWQgdG8KICAgIC8vLyB1bndpbmQuIFRoaXMgd2lsbCB1bmRvIHRoZSBwcm9ncmVzcyBhY3Jvc3MgdGhlIGVudGlyZSBwaXBlbGluZQogICAgLy8vIHVwIHRvIHRoZSBibG9jayB0aGF0IGNhdXNlZCB0aGUgZXJyb3IuCiAgICAvLy8KICAgIC8vLyBSZXR1cm5zIHRoZSBjb250cm9sIGZsb3cgYWZ0ZXIgaXQgcmFuIHRoZSBwaXBlbGluZS4KICAgIC8vLyBUaGlzIHdpbGwgYmUgW2BDb250cm9sRmxvdzo6Q29udGludWVgXSBvciBbYENvbnRyb2xGbG93OjpOb1Byb2dyZXNzYF0gb2YgdGhlIF9sYXN0XyBzdGFnZSBpbgogICAgLy8vIHRoZSBwaXBlbGluZSAoZm9yIGV4YW1wbGUgdGhlIGBGaW5pc2hgIHN0YWdlKS4gT3IgW2BDb250cm9sRmxvdzo6VW53aW5kYF0gb2YgdGhlIHN0YWdlCiAgICAvLy8gdGhhdCBjYXVzZWQgdGhlIHVud2luZC4KICAgIHB1YiBhc3luYyBmbiBydW5fbG9vcCgmbXV0IHNlbGYpIC0+IFJlc3VsdDxDb250cm9sRmxvdywgUGlwZWxpbmVFcnJvcj4gewogICAgICAgIHNlbGYubW92ZV90b19zdGF0aWNfZmlsZXMoKT87CgogICAgICAgIGxldCBtdXQgcHJldmlvdXNfc3RhZ2UgPSBOb25lOwogICAgICAgIGZvciBzdGFnZV9pbmRleCBpbiAwLi5zZWxmLnN0YWdlcy5sZW4oKSB7CiAgICAgICAgICAgIGxldCBzdGFnZSA9ICZzZWxmLnN0YWdlc1tzdGFnZV9pbmRleF07CiAgICAgICAgICAgIGxldCBzdGFnZV9pZCA9IHN0YWdlLmlkKCk7CgogICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAic3luYzo6cGlwZWxpbmUiLCBzdGFnZSA9ICVzdGFnZV9pZCwgIkV4ZWN1dGluZyBzdGFnZSIpOwogICAgICAgICAgICBsZXQgbmV4dCA9IHNlbGYuZXhlY3V0ZV9zdGFnZV90b19jb21wbGV0aW9uKHByZXZpb3VzX3N0YWdlLCBzdGFnZV9pbmRleCkuYXdhaXQ/OwoKICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogInN5bmM6OnBpcGVsaW5lIiwgc3RhZ2UgPSAlc3RhZ2VfaWQsID9uZXh0LCAiQ29tcGxldGVkIHN0YWdlIik7CgogICAgICAgICAgICBtYXRjaCBuZXh0IHsKICAgICAgICAgICAgICAgIENvbnRyb2xGbG93OjpOb1Byb2dyZXNzIHsgYmxvY2tfbnVtYmVyIH0gPT4gewogICAgICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKGJsb2NrX251bWJlcikgPSBibG9ja19udW1iZXIgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnByb2dyZXNzLnVwZGF0ZShibG9ja19udW1iZXIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIENvbnRyb2xGbG93OjpDb250aW51ZSB7IGJsb2NrX251bWJlciB9ID0+IHNlbGYucHJvZ3Jlc3MudXBkYXRlKGJsb2NrX251bWJlciksCiAgICAgICAgICAgICAgICBDb250cm9sRmxvdzo6VW53aW5kIHsgdGFyZ2V0LCBiYWRfYmxvY2sgfSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi51bndpbmQodGFyZ2V0LCBTb21lKGJhZF9ibG9jay5ibG9jay5udW1iZXIpKT87CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9rKENvbnRyb2xGbG93OjpVbndpbmQgeyB0YXJnZXQsIGJhZF9ibG9jayB9KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBwcmV2aW91c19zdGFnZSA9IFNvbWUoCiAgICAgICAgICAgICAgICBzZWxmLnByb3ZpZGVyX2ZhY3RvcnkKICAgICAgICAgICAgICAgICAgICAucHJvdmlkZXIoKT8KICAgICAgICAgICAgICAgICAgICAuZ2V0X3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfaWQpPwogICAgICAgICAgICAgICAgICAgIC51bndyYXBfb3JfZGVmYXVsdCgpCiAgICAgICAgICAgICAgICAgICAgLmJsb2NrX251bWJlciwKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIE9rKHNlbGYucHJvZ3Jlc3MubmV4dF9jdHJsKCkpCiAgICB9CgogICAgLy8vIFJ1biBbc3RhdGljIGZpbGUgcHJvZHVjZXJdKFN0YXRpY0ZpbGVQcm9kdWNlcikgYW5kIFtwcnVuZXJdKHJldGhfcHJ1bmU6OlBydW5lcikgdG8gKiptb3ZlKioKICAgIC8vLyBhbGwgZGF0YSBmcm9tIHRoZSBkYXRhYmFzZSB0byBzdGF0aWMgZmlsZXMgZm9yIGNvcnJlc3BvbmRpbmcKICAgIC8vLyBbc2VnbWVudHNdKHJldGhfc3RhdGljX2ZpbGVfdHlwZXM6OlN0YXRpY0ZpbGVTZWdtZW50KSwgYWNjb3JkaW5nIHRvIHRoZWlyIFtzdGFnZQogICAgLy8vIGNoZWNrcG9pbnRzXShTdGFnZUNoZWNrcG9pbnQpOgogICAgLy8vIC0gW2BTdGF0aWNGaWxlU2VnbWVudDo6SGVhZGVyc2BdKHJldGhfc3RhdGljX2ZpbGVfdHlwZXM6OlN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKSAtPgogICAgLy8vICAgW2BTdGFnZUlkOjpIZWFkZXJzYF0KICAgIC8vLyAtIFtgU3RhdGljRmlsZVNlZ21lbnQ6OlJlY2VpcHRzYF0ocmV0aF9zdGF0aWNfZmlsZV90eXBlczo6U3RhdGljRmlsZVNlZ21lbnQ6OlJlY2VpcHRzKSAtPgogICAgLy8vICAgW2BTdGFnZUlkOjpFeGVjdXRpb25gXQogICAgLy8vIC0gW2BTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25zYF0ocmV0aF9zdGF0aWNfZmlsZV90eXBlczo6U3RhdGljRmlsZVNlZ21lbnQ6OlRyYW5zYWN0aW9ucykKICAgIC8vLyAgIC0+IFtgU3RhZ2VJZDo6Qm9kaWVzYF0KICAgIC8vLwogICAgLy8vIENBVVRJT046IFRoaXMgbWV0aG9kIGxvY2tzIHRoZSBzdGF0aWMgZmlsZSBwcm9kdWNlciBNdXRleCwgaGVuY2UgY2FuIGJsb2NrIHRoZSB0aHJlYWQgaWYgdGhlCiAgICAvLy8gbG9jayBpcyBvY2N1cGllZC4KICAgIHB1YiBmbiBtb3ZlX3RvX3N0YXRpY19maWxlcygmc2VsZikgLT4gUmV0aFJlc3VsdDwoKT4gewogICAgICAgIC8vIENvcGllcyBkYXRhIGZyb20gZGF0YWJhc2UgdG8gc3RhdGljIGZpbGVzCiAgICAgICAgbGV0IGxvd2VzdF9zdGF0aWNfZmlsZV9oZWlnaHQgPQogICAgICAgICAgICBzZWxmLnN0YXRpY19maWxlX3Byb2R1Y2VyLmxvY2soKS5jb3B5X3RvX3N0YXRpY19maWxlcygpPy5taW5fYmxvY2tfbnVtKCk7CgogICAgICAgIC8vIERlbGV0ZXMgZGF0YSB3aGljaCBoYXMgYmVlbiBjb3BpZWQgdG8gc3RhdGljIGZpbGVzLgogICAgICAgIGlmIGxldCBTb21lKHBydW5lX3RpcCkgPSBsb3dlc3Rfc3RhdGljX2ZpbGVfaGVpZ2h0IHsKICAgICAgICAgICAgLy8gUnVuIHRoZSBwcnVuZXIgc28gd2UgZG9uJ3QgcG90ZW50aWFsbHkgZW5kIHVwIHdpdGggaGlnaGVyIGhlaWdodCBpbiB0aGUgZGF0YWJhc2UgdnMKICAgICAgICAgICAgLy8gc3RhdGljIGZpbGVzIGR1cmluZyBhIHBpcGVsaW5lIHVud2luZAogICAgICAgICAgICBsZXQgbXV0IHBydW5lciA9IFBydW5lckJ1aWxkZXI6Om5ldyhEZWZhdWx0OjpkZWZhdWx0KCkpCiAgICAgICAgICAgICAgICAuZGVsZXRlX2xpbWl0KHVzaXplOjpNQVgpCiAgICAgICAgICAgICAgICAuYnVpbGRfd2l0aF9wcm92aWRlcl9mYWN0b3J5KHNlbGYucHJvdmlkZXJfZmFjdG9yeS5jbG9uZSgpKTsKCiAgICAgICAgICAgIHBydW5lci5ydW4ocHJ1bmVfdGlwKT87CiAgICAgICAgfQoKICAgICAgICBPaygoKSkKICAgIH0KCiAgICAvLy8gVW53aW5kIHRoZSBzdGFnZXMgdG8gdGhlIHRhcmdldCBibG9jayAoZXhjbHVzaXZlKS4KICAgIC8vLwogICAgLy8vIElmIHRoZSB1bndpbmQgaXMgZHVlIHRvIGEgYmFkIGJsb2NrIHRoZSBudW1iZXIgb2YgdGhhdCBibG9jayBzaG91bGQgYmUgc3BlY2lmaWVkLgogICAgcHViIGZuIHVud2luZCgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgdG86IEJsb2NrTnVtYmVyLAogICAgICAgIGJhZF9ibG9jazogT3B0aW9uPEJsb2NrTnVtYmVyPiwKICAgICkgLT4gUmVzdWx0PCgpLCBQaXBlbGluZUVycm9yPiB7CiAgICAgICAgLy8gQWRkIHZhbGlkYXRpb24gYmVmb3JlIHN0YXJ0aW5nIHVud2luZAogICAgICAgIGxldCBwcm92aWRlciA9IHNlbGYucHJvdmlkZXJfZmFjdG9yeS5wcm92aWRlcigpPzsKICAgICAgICBsZXQgbGF0ZXN0X2Jsb2NrID0gcHJvdmlkZXIubGFzdF9ibG9ja19udW1iZXIoKT87CgogICAgICAgIC8vIEdldCB0aGUgYWN0dWFsIHBydW5pbmcgY29uZmlndXJhdGlvbgogICAgICAgIGxldCBwcnVuZV9tb2RlcyA9IHByb3ZpZGVyLnBydW5lX21vZGVzX3JlZigpOwoKICAgICAgICBsZXQgY2hlY2twb2ludHMgPSBwcm92aWRlci5nZXRfcHJ1bmVfY2hlY2twb2ludHMoKT87CiAgICAgICAgcHJ1bmVfbW9kZXMuZW5zdXJlX3Vud2luZF90YXJnZXRfdW5wcnVuZWQobGF0ZXN0X2Jsb2NrLCB0bywgJmNoZWNrcG9pbnRzKT87CgogICAgICAgIC8vIFVud2luZCBzdGFnZXMgaW4gcmV2ZXJzZSBvcmRlciBvZiBleGVjdXRpb24KICAgICAgICBsZXQgdW53aW5kX3BpcGVsaW5lID0gc2VsZi5zdGFnZXMuaXRlcl9tdXQoKS5yZXYoKTsKCiAgICAgICAgLy8gTGVnYWN5IEVuZ2luZTogVGhpcyBwcmV2ZW50cyBhIHJhY2UgY29uZGl0aW9uIGluIHdoaWNoIHRoZSBgU3RhdGljRmlsZVByb2R1Y2VyYCBjb3VsZAogICAgICAgIC8vIGF0dGVtcHQgdG8gcHJvY2VlZCB3aXRoIGEgZmluYWxpemVkIGJsb2NrIHdoaWNoIGhhcyBiZWVuIHVud2luZGVkCiAgICAgICAgbGV0IF9sb2NrZWRfc2ZfcHJvZHVjZXIgPSBzZWxmLnN0YXRpY19maWxlX3Byb2R1Y2VyLmxvY2soKTsKCiAgICAgICAgbGV0IG11dCBwcm92aWRlcl9ydyA9CiAgICAgICAgICAgIHNlbGYucHJvdmlkZXJfZmFjdG9yeS5kYXRhYmFzZV9wcm92aWRlcl9ydygpPy5kaXNhYmxlX2xvbmdfcmVhZF90cmFuc2FjdGlvbl9zYWZldHkoKTsKCiAgICAgICAgZm9yIHN0YWdlIGluIHVud2luZF9waXBlbGluZSB7CiAgICAgICAgICAgIGxldCBzdGFnZV9pZCA9IHN0YWdlLmlkKCk7CiAgICAgICAgICAgIGxldCBzcGFuID0gaW5mb19zcGFuISgiVW53aW5kaW5nIiwgc3RhZ2UgPSAlc3RhZ2VfaWQpOwogICAgICAgICAgICBsZXQgX2VudGVyID0gc3Bhbi5lbnRlcigpOwoKICAgICAgICAgICAgbGV0IG11dCBjaGVja3BvaW50ID0gcHJvdmlkZXJfcncuZ2V0X3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfaWQpPy51bndyYXBfb3JfZGVmYXVsdCgpOwogICAgICAgICAgICBpZiBjaGVja3BvaW50LmJsb2NrX251bWJlciA8IHRvIHsKICAgICAgICAgICAgICAgIGRlYnVnISgKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6ICJzeW5jOjpwaXBlbGluZSIsCiAgICAgICAgICAgICAgICAgICAgZnJvbSA9ICVjaGVja3BvaW50LmJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgICAgICAldG8sCiAgICAgICAgICAgICAgICAgICAgIlVud2luZCBwb2ludCB0b28gZmFyIGZvciBzdGFnZSIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBzZWxmLmV2ZW50X3NlbmRlci5ub3RpZnkoUGlwZWxpbmVFdmVudDo6U2tpcHBlZCB7IHN0YWdlX2lkIH0pOwoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGluZm8hKAogICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6cGlwZWxpbmUiLAogICAgICAgICAgICAgICAgZnJvbSA9ICVjaGVja3BvaW50LmJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgICV0bywKICAgICAgICAgICAgICAgID9iYWRfYmxvY2ssCiAgICAgICAgICAgICAgICAiU3RhcnRpbmcgdW53aW5kIgogICAgICAgICAgICApOwogICAgICAgICAgICB3aGlsZSBjaGVja3BvaW50LmJsb2NrX251bWJlciA+IHRvIHsKICAgICAgICAgICAgICAgIGxldCB1bndpbmRfc3RhcnRlZF9hdCA9IEluc3RhbnQ6Om5vdygpOwogICAgICAgICAgICAgICAgbGV0IGlucHV0ID0gVW53aW5kSW5wdXQgeyBjaGVja3BvaW50LCB1bndpbmRfdG86IHRvLCBiYWRfYmxvY2sgfTsKICAgICAgICAgICAgICAgIHNlbGYuZXZlbnRfc2VuZGVyLm5vdGlmeShQaXBlbGluZUV2ZW50OjpVbndpbmQgeyBzdGFnZV9pZCwgaW5wdXQgfSk7CgogICAgICAgICAgICAgICAgbGV0IG91dHB1dCA9IHN0YWdlLnVud2luZCgmcHJvdmlkZXJfcncsIGlucHV0KTsKICAgICAgICAgICAgICAgIG1hdGNoIG91dHB1dCB7CiAgICAgICAgICAgICAgICAgICAgT2sodW53aW5kX291dHB1dCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50ID0gdW53aW5kX291dHB1dC5jaGVja3BvaW50OwogICAgICAgICAgICAgICAgICAgICAgICBpbmZvISgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnBpcGVsaW5lIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWdlID0gJXN0YWdlX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdW53aW5kX3RvID0gdG8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzcyA9IGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyID09IHRvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIlN0YWdlIHVud291bmQiCiAgICAgICAgICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcl9ydy5zYXZlX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfaWQsIGNoZWNrcG9pbnQpPzsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vdGlmeSBldmVudCBsaXN0ZW5lcnMgYW5kIHVwZGF0ZSBtZXRyaWNzLgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmV2ZW50X3NlbmRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLm5vdGlmeShQaXBlbGluZUV2ZW50OjpVbndvdW5kIHsgc3RhZ2VfaWQsIHJlc3VsdDogdW53aW5kX291dHB1dCB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKG1ldHJpY3NfdHgpID0gJm11dCBzZWxmLm1ldHJpY3NfdHggewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IF8gPSBtZXRyaWNzX3R4LnNlbmQoTWV0cmljRXZlbnQ6OlN0YWdlQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBhc3N1bWUgaXQgd2FzIHNldCBpbiB0aGUgcHJldmlvdXMgZXhlY3V0ZSBpdGVyYXRpb24sIHNvIGl0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZG9lc24ndCBjaGFuZ2Ugd2hlbiB3ZSB1bndpbmQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2Jsb2NrX251bWJlcjogTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGFwc2VkOiB1bndpbmRfc3RhcnRlZF9hdC5lbGFwc2VkKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXBkYXRlIGZpbmFsaXplZCBibG9jayBpZiBuZWVkZWQKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxhc3Rfc2F2ZWRfZmluYWxpemVkX2Jsb2NrX251bWJlciA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcl9ydy5sYXN0X2ZpbmFsaXplZF9ibG9ja19udW1iZXIoKT87CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBOb25lLCB0aGF0IG1lYW5zIHRoZSBmaW5hbGl6ZWQgYmxvY2sgaXMgbm90IHdyaXR0ZW4gc28gd2Ugc2hvdWxkCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFsd2F5cyBzYXZlIGluIHRoYXQgY2FzZQogICAgICAgICAgICAgICAgICAgICAgICBpZiBsYXN0X3NhdmVkX2ZpbmFsaXplZF9ibG9ja19udW1iZXIuaXNfbm9uZSgpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTb21lKGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyKSA8IGxhc3Rfc2F2ZWRfZmluYWxpemVkX2Jsb2NrX251bWJlcgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcl9ydy5zYXZlX2ZpbmFsaXplZF9ibG9ja19udW1iZXIoQmxvY2tOdW1iZXI6OmZyb20oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludC5ibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApKT87CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyX3J3LmNvbW1pdCgpPzsKCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YWdlLnBvc3RfdW53aW5kX2NvbW1pdCgpPzsKCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyX3J3ID0gc2VsZi5wcm92aWRlcl9mYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3J3KCk/OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZXZlbnRfc2VuZGVyLm5vdGlmeShQaXBlbGluZUV2ZW50OjpFcnJvciB7IHN0YWdlX2lkIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEVycihQaXBlbGluZUVycm9yOjpTdGFnZShTdGFnZUVycm9yOjpGYXRhbChCb3g6Om5ldyhlcnIpKSkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBPaygoKSkKICAgIH0KCiAgICBhc3luYyBmbiBleGVjdXRlX3N0YWdlX3RvX2NvbXBsZXRpb24oCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHByZXZpb3VzX3N0YWdlOiBPcHRpb248QmxvY2tOdW1iZXI+LAogICAgICAgIHN0YWdlX2luZGV4OiB1c2l6ZSwKICAgICkgLT4gUmVzdWx0PENvbnRyb2xGbG93LCBQaXBlbGluZUVycm9yPiB7CiAgICAgICAgbGV0IHRvdGFsX3N0YWdlcyA9IHNlbGYuc3RhZ2VzLmxlbigpOwoKICAgICAgICBsZXQgc3RhZ2VfaWQgPSBzZWxmLnN0YWdlKHN0YWdlX2luZGV4KS5pZCgpOwogICAgICAgIGxldCBtdXQgbWFkZV9wcm9ncmVzcyA9IGZhbHNlOwogICAgICAgIGxldCB0YXJnZXQgPSBzZWxmLm1heF9ibG9jay5vcihwcmV2aW91c19zdGFnZSk7CgogICAgICAgIGxvb3AgewogICAgICAgICAgICBsZXQgcHJldl9jaGVja3BvaW50ID0gc2VsZi5wcm92aWRlcl9mYWN0b3J5LmdldF9zdGFnZV9jaGVja3BvaW50KHN0YWdlX2lkKT87CgogICAgICAgICAgICBsZXQgc3RhZ2VfcmVhY2hlZF9tYXhfYmxvY2sgPSBwcmV2X2NoZWNrcG9pbnQKICAgICAgICAgICAgICAgIC56aXAoc2VsZi5tYXhfYmxvY2spCiAgICAgICAgICAgICAgICAuaXNfc29tZV9hbmQofChwcmV2X3Byb2dyZXNzLCB0YXJnZXQpfCBwcmV2X3Byb2dyZXNzLmJsb2NrX251bWJlciA+PSB0YXJnZXQpOwogICAgICAgICAgICBpZiBzdGFnZV9yZWFjaGVkX21heF9ibG9jayB7CiAgICAgICAgICAgICAgICB3YXJuISgKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6ICJzeW5jOjpwaXBlbGluZSIsCiAgICAgICAgICAgICAgICAgICAgc3RhZ2UgPSAlc3RhZ2VfaWQsCiAgICAgICAgICAgICAgICAgICAgbWF4X2Jsb2NrID0gc2VsZi5tYXhfYmxvY2ssCiAgICAgICAgICAgICAgICAgICAgcHJldl9ibG9jayA9IHByZXZfY2hlY2twb2ludC5tYXAofHByb2dyZXNzfCBwcm9ncmVzcy5ibG9ja19udW1iZXIpLAogICAgICAgICAgICAgICAgICAgICJTdGFnZSByZWFjaGVkIHRhcmdldCBibG9jaywgc2tpcHBpbmcuIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHNlbGYuZXZlbnRfc2VuZGVyLm5vdGlmeShQaXBlbGluZUV2ZW50OjpTa2lwcGVkIHsgc3RhZ2VfaWQgfSk7CgogICAgICAgICAgICAgICAgLy8gV2UgcmVhY2hlZCB0aGUgbWF4aW11bSBibG9jaywgc28gd2Ugc2tpcCB0aGUgc3RhZ2UKICAgICAgICAgICAgICAgIHJldHVybiBPayhDb250cm9sRmxvdzo6Tm9Qcm9ncmVzcyB7CiAgICAgICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiBwcmV2X2NoZWNrcG9pbnQubWFwKHxwcm9ncmVzc3wgcHJvZ3Jlc3MuYmxvY2tfbnVtYmVyKSwKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBleGVjX2lucHV0ID0gRXhlY0lucHV0IHsgdGFyZ2V0LCBjaGVja3BvaW50OiBwcmV2X2NoZWNrcG9pbnQgfTsKCiAgICAgICAgICAgIHNlbGYuZXZlbnRfc2VuZGVyLm5vdGlmeShQaXBlbGluZUV2ZW50OjpQcmVwYXJlIHsKICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudDogc3RhZ2VfaW5kZXggKyAxLAogICAgICAgICAgICAgICAgICAgIHRvdGFsOiB0b3RhbF9zdGFnZXMsCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc3RhZ2VfaWQsCiAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBwcmV2X2NoZWNrcG9pbnQsCiAgICAgICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgbGV0IEVycihlcnIpID0gc2VsZi5zdGFnZShzdGFnZV9pbmRleCkuZXhlY3V0ZV9yZWFkeShleGVjX2lucHV0KS5hd2FpdCB7CiAgICAgICAgICAgICAgICBzZWxmLmV2ZW50X3NlbmRlci5ub3RpZnkoUGlwZWxpbmVFdmVudDo6RXJyb3IgeyBzdGFnZV9pZCB9KTsKICAgICAgICAgICAgICAgIG1hdGNoIHNlbGYub25fc3RhZ2VfZXJyb3Ioc3RhZ2VfaWQsIHByZXZfY2hlY2twb2ludCwgZXJyKT8gewogICAgICAgICAgICAgICAgICAgIFNvbWUoY3RybCkgPT4gcmV0dXJuIE9rKGN0cmwpLAogICAgICAgICAgICAgICAgICAgIE5vbmUgPT4gY29udGludWUsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgc3RhZ2Vfc3RhcnRlZF9hdCA9IEluc3RhbnQ6Om5vdygpOwogICAgICAgICAgICBsZXQgcHJvdmlkZXJfcncgPSBzZWxmLnByb3ZpZGVyX2ZhY3RvcnkuZGF0YWJhc2VfcHJvdmlkZXJfcncoKT87CgogICAgICAgICAgICBzZWxmLmV2ZW50X3NlbmRlci5ub3RpZnkoUGlwZWxpbmVFdmVudDo6UnVuIHsKICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudDogc3RhZ2VfaW5kZXggKyAxLAogICAgICAgICAgICAgICAgICAgIHRvdGFsOiB0b3RhbF9zdGFnZXMsCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc3RhZ2VfaWQsCiAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBwcmV2X2NoZWNrcG9pbnQsCiAgICAgICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgbWF0Y2ggc2VsZi5zdGFnZShzdGFnZV9pbmRleCkuZXhlY3V0ZSgmcHJvdmlkZXJfcncsIGV4ZWNfaW5wdXQpIHsKICAgICAgICAgICAgICAgIE9rKG91dCBAIEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50LCBkb25lIH0pID0+IHsKICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgc3RhZ2UgY2hlY2twb2ludC4KICAgICAgICAgICAgICAgICAgICBwcm92aWRlcl9ydy5zYXZlX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfaWQsIGNoZWNrcG9pbnQpPzsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29tbWl0IHByb2Nlc3NlZCBkYXRhIHRvIHRoZSBkYXRhYmFzZS4KICAgICAgICAgICAgICAgICAgICBwcm92aWRlcl9ydy5jb21taXQoKT87CgogICAgICAgICAgICAgICAgICAgIC8vIEludm9rZSBzdGFnZSBwb3N0IGNvbW1pdCBob29rLgogICAgICAgICAgICAgICAgICAgIHNlbGYuc3RhZ2Uoc3RhZ2VfaW5kZXgpLnBvc3RfZXhlY3V0ZV9jb21taXQoKT87CgogICAgICAgICAgICAgICAgICAgIC8vIE5vdGlmeSBldmVudCBsaXN0ZW5lcnMgYW5kIHVwZGF0ZSBtZXRyaWNzLgogICAgICAgICAgICAgICAgICAgIHNlbGYuZXZlbnRfc2VuZGVyLm5vdGlmeShQaXBlbGluZUV2ZW50OjpSYW4gewogICAgICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudDogc3RhZ2VfaW5kZXggKyAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IHRvdGFsX3N0YWdlcywKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogb3V0LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUobWV0cmljc190eCkgPSAmbXV0IHNlbGYubWV0cmljc190eCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBfID0gbWV0cmljc190eC5zZW5kKE1ldHJpY0V2ZW50OjpTdGFnZUNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2Jsb2NrX251bWJlcjogdGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxhcHNlZDogc3RhZ2Vfc3RhcnRlZF9hdC5lbGFwc2VkKCksCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IGJsb2NrX251bWJlciA9IGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyOwogICAgICAgICAgICAgICAgICAgIGxldCBwcmV2X2Jsb2NrX251bWJlciA9IHByZXZfY2hlY2twb2ludC51bndyYXBfb3JfZGVmYXVsdCgpLmJsb2NrX251bWJlcjsKICAgICAgICAgICAgICAgICAgICBtYWRlX3Byb2dyZXNzIHw9IGJsb2NrX251bWJlciAhPSBwcmV2X2Jsb2NrX251bWJlcjsKICAgICAgICAgICAgICAgICAgICBpZiBkb25lIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9rKGlmIG1hZGVfcHJvZ3Jlc3MgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29udHJvbEZsb3c6OkNvbnRpbnVlIHsgYmxvY2tfbnVtYmVyIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbnRyb2xGbG93OjpOb1Byb2dyZXNzIHsgYmxvY2tfbnVtYmVyOiBTb21lKGJsb2NrX251bWJlcikgfQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEVycihlcnIpID0+IHsKICAgICAgICAgICAgICAgICAgICBkcm9wKHByb3ZpZGVyX3J3KTsKICAgICAgICAgICAgICAgICAgICBzZWxmLmV2ZW50X3NlbmRlci5ub3RpZnkoUGlwZWxpbmVFdmVudDo6RXJyb3IgeyBzdGFnZV9pZCB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUoY3RybCkgPSBzZWxmLm9uX3N0YWdlX2Vycm9yKHN0YWdlX2lkLCBwcmV2X2NoZWNrcG9pbnQsIGVycik/IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9rKGN0cmwpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZuIG9uX3N0YWdlX2Vycm9yKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZCwKICAgICAgICBwcmV2X2NoZWNrcG9pbnQ6IE9wdGlvbjxTdGFnZUNoZWNrcG9pbnQ+LAogICAgICAgIGVycjogU3RhZ2VFcnJvciwKICAgICkgLT4gUmVzdWx0PE9wdGlvbjxDb250cm9sRmxvdz4sIFBpcGVsaW5lRXJyb3I+IHsKICAgICAgICBpZiBsZXQgU3RhZ2VFcnJvcjo6RGV0YWNoZWRIZWFkIHsgbG9jYWxfaGVhZCwgaGVhZGVyLCBlcnJvciB9ID0gZXJyIHsKICAgICAgICAgICAgd2FybiEodGFyZ2V0OiAic3luYzo6cGlwZWxpbmUiLCBzdGFnZSA9ICVzdGFnZV9pZCwgP2xvY2FsX2hlYWQsID9oZWFkZXIsICVlcnJvciwgIlN0YWdlIGVuY291bnRlcmVkIGRldGFjaGVkIGhlYWQiKTsKCiAgICAgICAgICAgIGlmIGxldCBTb21lKGxhc3RfZGV0YWNoZWRfaGVhZF91bndpbmRfdGFyZ2V0KSA9IHNlbGYubGFzdF9kZXRhY2hlZF9oZWFkX3Vud2luZF90YXJnZXQgewogICAgICAgICAgICAgICAgaWYgbG9jYWxfaGVhZC5ibG9jay5oYXNoID09IGxhc3RfZGV0YWNoZWRfaGVhZF91bndpbmRfdGFyZ2V0ICYmCiAgICAgICAgICAgICAgICAgICAgaGVhZGVyLmJsb2NrLm51bWJlciA9PSBsb2NhbF9oZWFkLmJsb2NrLm51bWJlciArIDEKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmRldGFjaGVkX2hlYWRfYXR0ZW1wdHMgKz0gMTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kZXRhY2hlZF9oZWFkX2F0dGVtcHRzID0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNlbGYuZGV0YWNoZWRfaGVhZF9hdHRlbXB0cyA9IDE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFdlIHVud2luZCBiZWNhdXNlIG9mIGEgZGV0YWNoZWQgaGVhZC4KICAgICAgICAgICAgbGV0IHVud2luZF90byA9IGxvY2FsX2hlYWQKICAgICAgICAgICAgICAgIC5ibG9jawogICAgICAgICAgICAgICAgLm51bWJlcgogICAgICAgICAgICAgICAgLnNhdHVyYXRpbmdfc3ViKAogICAgICAgICAgICAgICAgICAgIEJFQUNPTl9DT05TRU5TVVNfUkVPUkdfVU5XSU5EX0RFUFRILnNhdHVyYXRpbmdfbXVsKHNlbGYuZGV0YWNoZWRfaGVhZF9hdHRlbXB0cyksCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAubWF4KDEpOwoKICAgICAgICAgICAgc2VsZi5sYXN0X2RldGFjaGVkX2hlYWRfdW53aW5kX3RhcmdldCA9IHNlbGYucHJvdmlkZXJfZmFjdG9yeS5ibG9ja19oYXNoKHVud2luZF90byk/OwogICAgICAgICAgICBPayhTb21lKENvbnRyb2xGbG93OjpVbndpbmQgeyB0YXJnZXQ6IHVud2luZF90bywgYmFkX2Jsb2NrOiBsb2NhbF9oZWFkIH0pKQogICAgICAgIH0gZWxzZSBpZiBsZXQgU3RhZ2VFcnJvcjo6QmxvY2sgeyBibG9jaywgZXJyb3IgfSA9IGVyciB7CiAgICAgICAgICAgIG1hdGNoIGVycm9yIHsKICAgICAgICAgICAgICAgIEJsb2NrRXJyb3JLaW5kOjpWYWxpZGF0aW9uKHZhbGlkYXRpb25fZXJyb3IpID0+IHsKICAgICAgICAgICAgICAgICAgICBlcnJvciEoCiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnBpcGVsaW5lIiwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhZ2UgPSAlc3RhZ2VfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhZF9ibG9jayA9ICVibG9jay5ibG9jay5udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICJTdGFnZSBlbmNvdW50ZXJlZCBhIHZhbGlkYXRpb24gZXJyb3I6IHt2YWxpZGF0aW9uX2Vycm9yfSIKICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgICAgICAvLyBGSVhNRTogV2hlbiBoYW5kbGluZyBlcnJvcnMsIHdlIGRvIG5vdCBjb21taXQgdGhlIGRhdGFiYXNlIHRyYW5zYWN0aW9uLiBUaGlzCiAgICAgICAgICAgICAgICAgICAgLy8gbGVhZHMgdG8gdGhlIE1lcmtsZSBzdGFnZSBub3QgY2xlYXJpbmcgaXRzIGNoZWNrcG9pbnQsIGFuZCByZXN0YXJ0aW5nIGZyb20gYW4KICAgICAgICAgICAgICAgICAgICAvLyBpbnZhbGlkIHBsYWNlLgogICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgcmVzZXQgTWVya2xlRXhlY3V0ZSBjaGVja3BvaW50IGlmIE1lcmtsZUV4ZWN1dGUgaXRzZWxmIGZhaWxlZAogICAgICAgICAgICAgICAgICAgIGlmIHN0YWdlX2lkID09IFN0YWdlSWQ6Ok1lcmtsZUV4ZWN1dGUgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcHJvdmlkZXJfcncgPSBzZWxmLnByb3ZpZGVyX2ZhY3RvcnkuZGF0YWJhc2VfcHJvdmlkZXJfcncoKT87CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyX3J3CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2F2ZV9zdGFnZV9jaGVja3BvaW50X3Byb2dyZXNzKFN0YWdlSWQ6Ok1lcmtsZUV4ZWN1dGUsIHZlYyFbXSk/OwogICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcl9ydy5zYXZlX3N0YWdlX2NoZWNrcG9pbnQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTdGFnZUlkOjpNZXJrbGVFeGVjdXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldl9jaGVja3BvaW50LnVud3JhcF9vcl9kZWZhdWx0KCksCiAgICAgICAgICAgICAgICAgICAgICAgICk/OwoKICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXJfcncuY29tbWl0KCk/OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgdW53aW5kIGJlY2F1c2Ugb2YgYSB2YWxpZGF0aW9uIGVycm9yLiBJZiB0aGUgdW53aW5kIGl0c2VsZgogICAgICAgICAgICAgICAgICAgIC8vIGZhaWxzLCB3ZSBiYWlsIGVudGlyZWx5LAogICAgICAgICAgICAgICAgICAgIC8vIG90aGVyd2lzZSB3ZSByZXN0YXJ0IHRoZSBleGVjdXRpb24gbG9vcCBmcm9tIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGJlZ2lubmluZy4KICAgICAgICAgICAgICAgICAgICBPayhTb21lKENvbnRyb2xGbG93OjpVbndpbmQgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IHByZXZfY2hlY2twb2ludC51bndyYXBfb3JfZGVmYXVsdCgpLmJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgYmFkX2Jsb2NrOiBibG9jaywKICAgICAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEJsb2NrRXJyb3JLaW5kOjpFeGVjdXRpb24oZXhlY3V0aW9uX2Vycm9yKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IhKAogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6ICJzeW5jOjpwaXBlbGluZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YWdlID0gJXN0YWdlX2lkLAogICAgICAgICAgICAgICAgICAgICAgICBiYWRfYmxvY2sgPSAlYmxvY2suYmxvY2subnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAiU3RhZ2UgZW5jb3VudGVyZWQgYW4gZXhlY3V0aW9uIGVycm9yOiB7ZXhlY3V0aW9uX2Vycm9yfSIKICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgICAgICAvLyBXZSB1bndpbmQgYmVjYXVzZSBvZiBhbiBleGVjdXRpb24gZXJyb3IuIElmIHRoZSB1bndpbmQgaXRzZWxmCiAgICAgICAgICAgICAgICAgICAgLy8gZmFpbHMsIHdlIGJhaWwgZW50aXJlbHksCiAgICAgICAgICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIHdlIHJlc3RhcnQKICAgICAgICAgICAgICAgICAgICAvLyB0aGUgZXhlY3V0aW9uIGxvb3AgZnJvbSB0aGUgYmVnaW5uaW5nLgogICAgICAgICAgICAgICAgICAgIE9rKFNvbWUoQ29udHJvbEZsb3c6OlVud2luZCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDogcHJldl9jaGVja3BvaW50LnVud3JhcF9vcl9kZWZhdWx0KCkuYmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICBiYWRfYmxvY2s6IGJsb2NrLAogICAgICAgICAgICAgICAgICAgIH0pKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIGxldCBTdGFnZUVycm9yOjpNaXNzaW5nU3RhdGljRmlsZURhdGEgeyBibG9jaywgc2VnbWVudCB9ID0gZXJyIHsKICAgICAgICAgICAgZXJyb3IhKAogICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6cGlwZWxpbmUiLAogICAgICAgICAgICAgICAgc3RhZ2UgPSAlc3RhZ2VfaWQsCiAgICAgICAgICAgICAgICBiYWRfYmxvY2sgPSAlYmxvY2suYmxvY2subnVtYmVyLAogICAgICAgICAgICAgICAgc2VnbWVudCA9ICVzZWdtZW50LAogICAgICAgICAgICAgICAgIlN0YWdlIGlzIG1pc3Npbmcgc3RhdGljIGZpbGUgZGF0YS4iCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBPayhTb21lKENvbnRyb2xGbG93OjpVbndpbmQgewogICAgICAgICAgICAgICAgdGFyZ2V0OiBibG9jay5ibG9jay5udW1iZXIuc2F0dXJhdGluZ19zdWIoMSksCiAgICAgICAgICAgICAgICBiYWRfYmxvY2s6IGJsb2NrLAogICAgICAgICAgICB9KSkKICAgICAgICB9IGVsc2UgaWYgZXJyLmlzX2ZhdGFsKCkgewogICAgICAgICAgICBlcnJvciEodGFyZ2V0OiAic3luYzo6cGlwZWxpbmUiLCBzdGFnZSA9ICVzdGFnZV9pZCwgIlN0YWdlIGVuY291bnRlcmVkIGEgZmF0YWwgZXJyb3I6IHtlcnJ9Iik7CiAgICAgICAgICAgIEVycihlcnIuaW50bygpKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIE9uIG90aGVyIGVycm9ycyB3ZSBhc3N1bWUgdGhleSBhcmUgcmVjb3ZlcmFibGUgaWYgd2UgZGlzY2FyZCB0aGUKICAgICAgICAgICAgLy8gdHJhbnNhY3Rpb24gYW5kIHJ1biB0aGUgc3RhZ2UgYWdhaW4uCiAgICAgICAgICAgIHdhcm4hKAogICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6cGlwZWxpbmUiLAogICAgICAgICAgICAgICAgc3RhZ2UgPSAlc3RhZ2VfaWQsCiAgICAgICAgICAgICAgICAiU3RhZ2UgZW5jb3VudGVyZWQgYSBub24tZmF0YWwgZXJyb3I6IHtlcnJ9LiBSZXRyeWluZy4uLiIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgT2soTm9uZSkKICAgICAgICB9CiAgICB9Cn0KCmltcGw8TjogUHJvdmlkZXJOb2RlVHlwZXM+IHN0ZDo6Zm10OjpEZWJ1ZyBmb3IgUGlwZWxpbmU8Tj4gewogICAgZm4gZm10KCZzZWxmLCBmOiAmbXV0IHN0ZDo6Zm10OjpGb3JtYXR0ZXI8J18+KSAtPiBzdGQ6OmZtdDo6UmVzdWx0IHsKICAgICAgICBmLmRlYnVnX3N0cnVjdCgiUGlwZWxpbmUiKQogICAgICAgICAgICAuZmllbGQoInN0YWdlcyIsICZzZWxmLnN0YWdlcy5pdGVyKCkubWFwKHxzdGFnZXwgc3RhZ2UuaWQoKSkuY29sbGVjdDo6PFZlYzxTdGFnZUlkPj4oKSkKICAgICAgICAgICAgLmZpZWxkKCJtYXhfYmxvY2siLCAmc2VsZi5tYXhfYmxvY2spCiAgICAgICAgICAgIC5maWVsZCgiZXZlbnRfc2VuZGVyIiwgJnNlbGYuZXZlbnRfc2VuZGVyKQogICAgICAgICAgICAuZmllbGQoImZhaWxfb25fdW53aW5kIiwgJnNlbGYuZmFpbF9vbl91bndpbmQpCiAgICAgICAgICAgIC5maW5pc2goKQogICAgfQp9CgojW2NmZyh0ZXN0KV0KbW9kIHRlc3RzIHsKICAgIHVzZSBzdGQ6OnN5bmM6OmF0b21pYzo6T3JkZXJpbmc7CgogICAgdXNlIHN1cGVyOjoqOwogICAgdXNlIGNyYXRlOjp7dGVzdF91dGlsczo6VGVzdFN0YWdlLCBVbndpbmRPdXRwdXR9OwogICAgdXNlIGFzc2VydF9tYXRjaGVzOjphc3NlcnRfbWF0Y2hlczsKICAgIHVzZSByZXRoX2NvbnNlbnN1czo6Q29uc2Vuc3VzRXJyb3I7CiAgICB1c2UgcmV0aF9lcnJvcnM6OlByb3ZpZGVyRXJyb3I7CiAgICB1c2UgcmV0aF9wcm92aWRlcjo6dGVzdF91dGlsczo6e2NyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnksIE1vY2tOb2RlVHlwZXNXaXRoREJ9OwogICAgdXNlIHJldGhfcHJ1bmU6OlBydW5lTW9kZXM7CiAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjpnZW5lcmF0b3JzOjp7c2VsZiwgcmFuZG9tX2Jsb2NrX3dpdGhfcGFyZW50fTsKICAgIHVzZSB0b2tpb19zdHJlYW06OlN0cmVhbUV4dDsKCiAgICAjW3Rlc3RdCiAgICBmbiByZWNvcmRfcHJvZ3Jlc3NfY2FsY3VsYXRlc19vdXRsaWVycygpIHsKICAgICAgICBsZXQgbXV0IHByb2dyZXNzID0gUGlwZWxpbmVQcm9ncmVzczo6ZGVmYXVsdCgpOwoKICAgICAgICBwcm9ncmVzcy51cGRhdGUoMTApOwogICAgICAgIGFzc2VydF9lcSEocHJvZ3Jlc3MubWluaW11bV9ibG9ja19udW1iZXIsIFNvbWUoMTApKTsKICAgICAgICBhc3NlcnRfZXEhKHByb2dyZXNzLm1heGltdW1fYmxvY2tfbnVtYmVyLCBTb21lKDEwKSk7CgogICAgICAgIHByb2dyZXNzLnVwZGF0ZSgyMCk7CiAgICAgICAgYXNzZXJ0X2VxIShwcm9ncmVzcy5taW5pbXVtX2Jsb2NrX251bWJlciwgU29tZSgxMCkpOwogICAgICAgIGFzc2VydF9lcSEocHJvZ3Jlc3MubWF4aW11bV9ibG9ja19udW1iZXIsIFNvbWUoMjApKTsKCiAgICAgICAgcHJvZ3Jlc3MudXBkYXRlKDEpOwogICAgICAgIGFzc2VydF9lcSEocHJvZ3Jlc3MubWluaW11bV9ibG9ja19udW1iZXIsIFNvbWUoMSkpOwogICAgICAgIGFzc2VydF9lcSEocHJvZ3Jlc3MubWF4aW11bV9ibG9ja19udW1iZXIsIFNvbWUoMjApKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiBwcm9ncmVzc19jdHJsX2Zsb3coKSB7CiAgICAgICAgbGV0IG11dCBwcm9ncmVzcyA9IFBpcGVsaW5lUHJvZ3Jlc3M6OmRlZmF1bHQoKTsKCiAgICAgICAgYXNzZXJ0X2VxIShwcm9ncmVzcy5uZXh0X2N0cmwoKSwgQ29udHJvbEZsb3c6Ok5vUHJvZ3Jlc3MgeyBibG9ja19udW1iZXI6IE5vbmUgfSk7CgogICAgICAgIHByb2dyZXNzLnVwZGF0ZSgxKTsKICAgICAgICBhc3NlcnRfZXEhKHByb2dyZXNzLm5leHRfY3RybCgpLCBDb250cm9sRmxvdzo6Q29udGludWUgeyBibG9ja19udW1iZXI6IDEgfSk7CiAgICB9CgogICAgLy8vIFJ1bnMgYSBzaW1wbGUgcGlwZWxpbmUuCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gcnVuX3BpcGVsaW5lKCkgewogICAgICAgIGxldCBwcm92aWRlcl9mYWN0b3J5ID0gY3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeSgpOwoKICAgICAgICBsZXQgc3RhZ2VfYSA9IFRlc3RTdGFnZTo6bmV3KFN0YWdlSWQ6Ok90aGVyKCJBIikpCiAgICAgICAgICAgIC5hZGRfZXhlYyhPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMjApLCBkb25lOiB0cnVlIH0pKTsKICAgICAgICBsZXQgKHN0YWdlX2EsIHBvc3RfZXhlY3V0ZV9jb21taXRfY291bnRlcl9hKSA9IHN0YWdlX2Eud2l0aF9wb3N0X2V4ZWN1dGVfY29tbWl0X2NvdW50ZXIoKTsKICAgICAgICBsZXQgKHN0YWdlX2EsIHBvc3RfdW53aW5kX2NvbW1pdF9jb3VudGVyX2EpID0gc3RhZ2VfYS53aXRoX3Bvc3RfdW53aW5kX2NvbW1pdF9jb3VudGVyKCk7CgogICAgICAgIGxldCBzdGFnZV9iID0gVGVzdFN0YWdlOjpuZXcoU3RhZ2VJZDo6T3RoZXIoIkIiKSkKICAgICAgICAgICAgLmFkZF9leGVjKE9rKEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldygxMCksIGRvbmU6IHRydWUgfSkpOwogICAgICAgIGxldCAoc3RhZ2VfYiwgcG9zdF9leGVjdXRlX2NvbW1pdF9jb3VudGVyX2IpID0gc3RhZ2VfYi53aXRoX3Bvc3RfZXhlY3V0ZV9jb21taXRfY291bnRlcigpOwogICAgICAgIGxldCAoc3RhZ2VfYiwgcG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXJfYikgPSBzdGFnZV9iLndpdGhfcG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXIoKTsKCiAgICAgICAgbGV0IG11dCBwaXBlbGluZSA9IFBpcGVsaW5lOjo8TW9ja05vZGVUeXBlc1dpdGhEQj46OmJ1aWxkZXIoKQogICAgICAgICAgICAuYWRkX3N0YWdlKHN0YWdlX2EpCiAgICAgICAgICAgIC5hZGRfc3RhZ2Uoc3RhZ2VfYikKICAgICAgICAgICAgLndpdGhfbWF4X2Jsb2NrKDEwKQogICAgICAgICAgICAuYnVpbGQoCiAgICAgICAgICAgICAgICBwcm92aWRlcl9mYWN0b3J5LmNsb25lKCksCiAgICAgICAgICAgICAgICBTdGF0aWNGaWxlUHJvZHVjZXI6Om5ldyhwcm92aWRlcl9mYWN0b3J5LmNsb25lKCksIFBydW5lTW9kZXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgICk7CiAgICAgICAgbGV0IGV2ZW50cyA9IHBpcGVsaW5lLmV2ZW50cygpOwoKICAgICAgICAvLyBSdW4gcGlwZWxpbmUKICAgICAgICB0b2tpbzo6c3Bhd24oYXN5bmMgbW92ZSB7CiAgICAgICAgICAgIHBpcGVsaW5lLnJ1bigpLmF3YWl0LnVud3JhcCgpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBDaGVjayB0aGF0IHRoZSBzdGFnZXMgd2VyZSBydW4gaW4gb3JkZXIKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBldmVudHMuY29sbGVjdDo6PFZlYzxQaXBlbGluZUV2ZW50Pj4oKS5hd2FpdCwKICAgICAgICAgICAgdmVjIVsKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlByZXBhcmUgewogICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7IGN1cnJlbnQ6IDEsIHRvdGFsOiAyIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJBIiksCiAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogTm9uZSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IFNvbWUoMTApLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlJ1biB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMSwgdG90YWw6IDIgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBOb25lLAogICAgICAgICAgICAgICAgICAgIHRhcmdldDogU29tZSgxMCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6UmFuIHsKICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgeyBjdXJyZW50OiAxLCB0b3RhbDogMiB9LAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQSIpLAogICAgICAgICAgICAgICAgICAgIHJlc3VsdDogRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDIwKSwgZG9uZTogdHJ1ZSB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlByZXBhcmUgewogICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7IGN1cnJlbnQ6IDIsIHRvdGFsOiAyIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJCIiksCiAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogTm9uZSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IFNvbWUoMTApLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlJ1biB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMiwgdG90YWw6IDIgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkIiKSwKICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBOb25lLAogICAgICAgICAgICAgICAgICAgIHRhcmdldDogU29tZSgxMCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6UmFuIHsKICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgeyBjdXJyZW50OiAyLCB0b3RhbDogMiB9LAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQiIpLAogICAgICAgICAgICAgICAgICAgIHJlc3VsdDogRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDEwKSwgZG9uZTogdHJ1ZSB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgXQogICAgICAgICk7CgogICAgICAgIGFzc2VydF9lcSEocG9zdF9leGVjdXRlX2NvbW1pdF9jb3VudGVyX2EubG9hZChPcmRlcmluZzo6UmVsYXhlZCksIDEpOwogICAgICAgIGFzc2VydF9lcSEocG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXJfYS5sb2FkKE9yZGVyaW5nOjpSZWxheGVkKSwgMCk7CgogICAgICAgIGFzc2VydF9lcSEocG9zdF9leGVjdXRlX2NvbW1pdF9jb3VudGVyX2IubG9hZChPcmRlcmluZzo6UmVsYXhlZCksIDEpOwogICAgICAgIGFzc2VydF9lcSEocG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXJfYi5sb2FkKE9yZGVyaW5nOjpSZWxheGVkKSwgMCk7CiAgICB9CgogICAgLy8vIFVud2luZHMgYSBzaW1wbGUgcGlwZWxpbmUuCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdW53aW5kX3BpcGVsaW5lKCkgewogICAgICAgIGxldCBwcm92aWRlcl9mYWN0b3J5ID0gY3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeSgpOwoKICAgICAgICBsZXQgc3RhZ2VfYSA9IFRlc3RTdGFnZTo6bmV3KFN0YWdlSWQ6Ok90aGVyKCJBIikpCiAgICAgICAgICAgIC5hZGRfZXhlYyhPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMTAwKSwgZG9uZTogdHJ1ZSB9KSkKICAgICAgICAgICAgLmFkZF91bndpbmQoT2soVW53aW5kT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMSkgfSkpOwogICAgICAgIGxldCAoc3RhZ2VfYSwgcG9zdF9leGVjdXRlX2NvbW1pdF9jb3VudGVyX2EpID0gc3RhZ2VfYS53aXRoX3Bvc3RfZXhlY3V0ZV9jb21taXRfY291bnRlcigpOwogICAgICAgIGxldCAoc3RhZ2VfYSwgcG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXJfYSkgPSBzdGFnZV9hLndpdGhfcG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXIoKTsKCiAgICAgICAgbGV0IHN0YWdlX2IgPSBUZXN0U3RhZ2U6Om5ldyhTdGFnZUlkOjpPdGhlcigiQiIpKQogICAgICAgICAgICAuYWRkX2V4ZWMoT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDEwKSwgZG9uZTogdHJ1ZSB9KSkKICAgICAgICAgICAgLmFkZF91bndpbmQoT2soVW53aW5kT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMSkgfSkpOwogICAgICAgIGxldCAoc3RhZ2VfYiwgcG9zdF9leGVjdXRlX2NvbW1pdF9jb3VudGVyX2IpID0gc3RhZ2VfYi53aXRoX3Bvc3RfZXhlY3V0ZV9jb21taXRfY291bnRlcigpOwogICAgICAgIGxldCAoc3RhZ2VfYiwgcG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXJfYikgPSBzdGFnZV9iLndpdGhfcG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXIoKTsKCiAgICAgICAgbGV0IHN0YWdlX2MgPSBUZXN0U3RhZ2U6Om5ldyhTdGFnZUlkOjpPdGhlcigiQyIpKQogICAgICAgICAgICAuYWRkX2V4ZWMoT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDIwKSwgZG9uZTogdHJ1ZSB9KSkKICAgICAgICAgICAgLmFkZF91bndpbmQoT2soVW53aW5kT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMSkgfSkpOwogICAgICAgIGxldCAoc3RhZ2VfYywgcG9zdF9leGVjdXRlX2NvbW1pdF9jb3VudGVyX2MpID0gc3RhZ2VfYy53aXRoX3Bvc3RfZXhlY3V0ZV9jb21taXRfY291bnRlcigpOwogICAgICAgIGxldCAoc3RhZ2VfYywgcG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXJfYykgPSBzdGFnZV9jLndpdGhfcG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXIoKTsKCiAgICAgICAgbGV0IG11dCBwaXBlbGluZSA9IFBpcGVsaW5lOjo8TW9ja05vZGVUeXBlc1dpdGhEQj46OmJ1aWxkZXIoKQogICAgICAgICAgICAuYWRkX3N0YWdlKHN0YWdlX2EpCiAgICAgICAgICAgIC5hZGRfc3RhZ2Uoc3RhZ2VfYikKICAgICAgICAgICAgLmFkZF9zdGFnZShzdGFnZV9jKQogICAgICAgICAgICAud2l0aF9tYXhfYmxvY2soMTApCiAgICAgICAgICAgIC5idWlsZCgKICAgICAgICAgICAgICAgIHByb3ZpZGVyX2ZhY3RvcnkuY2xvbmUoKSwKICAgICAgICAgICAgICAgIFN0YXRpY0ZpbGVQcm9kdWNlcjo6bmV3KHByb3ZpZGVyX2ZhY3RvcnkuY2xvbmUoKSwgUHJ1bmVNb2Rlczo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgKTsKICAgICAgICBsZXQgZXZlbnRzID0gcGlwZWxpbmUuZXZlbnRzKCk7CgogICAgICAgIC8vIFJ1biBwaXBlbGluZQogICAgICAgIHRva2lvOjpzcGF3bihhc3luYyBtb3ZlIHsKICAgICAgICAgICAgLy8gU3luYyBmaXJzdAogICAgICAgICAgICBwaXBlbGluZS5ydW4oKS5hd2FpdC5leHBlY3QoIkNvdWxkIG5vdCBydW4gcGlwZWxpbmUiKTsKCiAgICAgICAgICAgIC8vIFVud2luZAogICAgICAgICAgICBwaXBlbGluZS51bndpbmQoMSwgTm9uZSkuZXhwZWN0KCJDb3VsZCBub3QgdW53aW5kIHBpcGVsaW5lIik7CiAgICAgICAgfSk7CgogICAgICAgIC8vIENoZWNrIHRoYXQgdGhlIHN0YWdlcyB3ZXJlIHVud291bmQgaW4gcmV2ZXJzZSBvcmRlcgogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGV2ZW50cy5jb2xsZWN0Ojo8VmVjPFBpcGVsaW5lRXZlbnQ+PigpLmF3YWl0LAogICAgICAgICAgICB2ZWMhWwogICAgICAgICAgICAgICAgLy8gRXhlY3V0aW5nCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpQcmVwYXJlIHsKICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgeyBjdXJyZW50OiAxLCB0b3RhbDogMyB9LAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQSIpLAogICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBTb21lKDEwKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpSdW4gewogICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7IGN1cnJlbnQ6IDEsIHRvdGFsOiAzIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJBIiksCiAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogTm9uZSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IFNvbWUoMTApLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlJhbiB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMSwgdG90YWw6IDMgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldygxMDApLCBkb25lOiB0cnVlIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6UHJlcGFyZSB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMiwgdG90YWw6IDMgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkIiKSwKICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBOb25lLAogICAgICAgICAgICAgICAgICAgIHRhcmdldDogU29tZSgxMCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6UnVuIHsKICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgeyBjdXJyZW50OiAyLCB0b3RhbDogMyB9LAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQiIpLAogICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBTb21lKDEwKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpSYW4gewogICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7IGN1cnJlbnQ6IDIsIHRvdGFsOiAzIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJCIiksCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMTApLCBkb25lOiB0cnVlIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6UHJlcGFyZSB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMywgdG90YWw6IDMgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkMiKSwKICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBOb25lLAogICAgICAgICAgICAgICAgICAgIHRhcmdldDogU29tZSgxMCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6UnVuIHsKICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgeyBjdXJyZW50OiAzLCB0b3RhbDogMyB9LAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQyIpLAogICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBTb21lKDEwKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpSYW4gewogICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7IGN1cnJlbnQ6IDMsIHRvdGFsOiAzIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJDIiksCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMjApLCBkb25lOiB0cnVlIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gVW53aW5kaW5nCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpVbndpbmQgewogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQyIpLAogICAgICAgICAgICAgICAgICAgIGlucHV0OiBVbndpbmRJbnB1dCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDIwKSwKICAgICAgICAgICAgICAgICAgICAgICAgdW53aW5kX3RvOiAxLAogICAgICAgICAgICAgICAgICAgICAgICBiYWRfYmxvY2s6IE5vbmUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6VW53b3VuZCB7CiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJDIiksCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBVbndpbmRPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldygxKSB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlVud2luZCB7CiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJCIiksCiAgICAgICAgICAgICAgICAgICAgaW5wdXQ6IFVud2luZElucHV0IHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMTApLAogICAgICAgICAgICAgICAgICAgICAgICB1bndpbmRfdG86IDEsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhZF9ibG9jazogTm9uZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpVbndvdW5kIHsKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkIiKSwKICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDEpIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6VW53aW5kIHsKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICBpbnB1dDogVW53aW5kSW5wdXQgewogICAgICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldygxMDApLAogICAgICAgICAgICAgICAgICAgICAgICB1bndpbmRfdG86IDEsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhZF9ibG9jazogTm9uZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpVbndvdW5kIHsKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDEpIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICBdCiAgICAgICAgKTsKCiAgICAgICAgYXNzZXJ0X2VxIShwb3N0X2V4ZWN1dGVfY29tbWl0X2NvdW50ZXJfYS5sb2FkKE9yZGVyaW5nOjpSZWxheGVkKSwgMSk7CiAgICAgICAgYXNzZXJ0X2VxIShwb3N0X3Vud2luZF9jb21taXRfY291bnRlcl9hLmxvYWQoT3JkZXJpbmc6OlJlbGF4ZWQpLCAxKTsKCiAgICAgICAgYXNzZXJ0X2VxIShwb3N0X2V4ZWN1dGVfY29tbWl0X2NvdW50ZXJfYi5sb2FkKE9yZGVyaW5nOjpSZWxheGVkKSwgMSk7CiAgICAgICAgYXNzZXJ0X2VxIShwb3N0X3Vud2luZF9jb21taXRfY291bnRlcl9iLmxvYWQoT3JkZXJpbmc6OlJlbGF4ZWQpLCAxKTsKCiAgICAgICAgYXNzZXJ0X2VxIShwb3N0X2V4ZWN1dGVfY29tbWl0X2NvdW50ZXJfYy5sb2FkKE9yZGVyaW5nOjpSZWxheGVkKSwgMSk7CiAgICAgICAgYXNzZXJ0X2VxIShwb3N0X3Vud2luZF9jb21taXRfY291bnRlcl9jLmxvYWQoT3JkZXJpbmc6OlJlbGF4ZWQpLCAxKTsKICAgIH0KCiAgICAvLy8gVW53aW5kcyBhIHBpcGVsaW5lIHdpdGggaW50ZXJtZWRpYXRlIHByb2dyZXNzLgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHVud2luZF9waXBlbGluZV93aXRoX2ludGVybWVkaWF0ZV9wcm9ncmVzcygpIHsKICAgICAgICBsZXQgcHJvdmlkZXJfZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKCiAgICAgICAgbGV0IG11dCBwaXBlbGluZSA9IFBpcGVsaW5lOjo8TW9ja05vZGVUeXBlc1dpdGhEQj46OmJ1aWxkZXIoKQogICAgICAgICAgICAuYWRkX3N0YWdlKAogICAgICAgICAgICAgICAgVGVzdFN0YWdlOjpuZXcoU3RhZ2VJZDo6T3RoZXIoIkEiKSkKICAgICAgICAgICAgICAgICAgICAuYWRkX2V4ZWMoT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDEwMCksIGRvbmU6IHRydWUgfSkpCiAgICAgICAgICAgICAgICAgICAgLmFkZF91bndpbmQoT2soVW53aW5kT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoNTApIH0pKSwKICAgICAgICAgICAgKQogICAgICAgICAgICAuYWRkX3N0YWdlKAogICAgICAgICAgICAgICAgVGVzdFN0YWdlOjpuZXcoU3RhZ2VJZDo6T3RoZXIoIkIiKSkKICAgICAgICAgICAgICAgICAgICAuYWRkX2V4ZWMoT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDEwKSwgZG9uZTogdHJ1ZSB9KSksCiAgICAgICAgICAgICkKICAgICAgICAgICAgLndpdGhfbWF4X2Jsb2NrKDEwKQogICAgICAgICAgICAuYnVpbGQoCiAgICAgICAgICAgICAgICBwcm92aWRlcl9mYWN0b3J5LmNsb25lKCksCiAgICAgICAgICAgICAgICBTdGF0aWNGaWxlUHJvZHVjZXI6Om5ldyhwcm92aWRlcl9mYWN0b3J5LmNsb25lKCksIFBydW5lTW9kZXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgICk7CiAgICAgICAgbGV0IGV2ZW50cyA9IHBpcGVsaW5lLmV2ZW50cygpOwoKICAgICAgICAvLyBSdW4gcGlwZWxpbmUKICAgICAgICB0b2tpbzo6c3Bhd24oYXN5bmMgbW92ZSB7CiAgICAgICAgICAgIC8vIFN5bmMgZmlyc3QKICAgICAgICAgICAgcGlwZWxpbmUucnVuKCkuYXdhaXQuZXhwZWN0KCJDb3VsZCBub3QgcnVuIHBpcGVsaW5lIik7CgogICAgICAgICAgICAvLyBVbndpbmQKICAgICAgICAgICAgcGlwZWxpbmUudW53aW5kKDUwLCBOb25lKS5leHBlY3QoIkNvdWxkIG5vdCB1bndpbmQgcGlwZWxpbmUiKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQ2hlY2sgdGhhdCB0aGUgc3RhZ2VzIHdlcmUgdW53b3VuZCBpbiByZXZlcnNlIG9yZGVyCiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgZXZlbnRzLmNvbGxlY3Q6OjxWZWM8UGlwZWxpbmVFdmVudD4+KCkuYXdhaXQsCiAgICAgICAgICAgIHZlYyFbCiAgICAgICAgICAgICAgICAvLyBFeGVjdXRpbmcKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlByZXBhcmUgewogICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7IGN1cnJlbnQ6IDEsIHRvdGFsOiAyIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJBIiksCiAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogTm9uZSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IFNvbWUoMTApLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlJ1biB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMSwgdG90YWw6IDIgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBOb25lLAogICAgICAgICAgICAgICAgICAgIHRhcmdldDogU29tZSgxMCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6UmFuIHsKICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgeyBjdXJyZW50OiAxLCB0b3RhbDogMiB9LAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQSIpLAogICAgICAgICAgICAgICAgICAgIHJlc3VsdDogRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDEwMCksIGRvbmU6IHRydWUgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpQcmVwYXJlIHsKICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgeyBjdXJyZW50OiAyLCB0b3RhbDogMiB9LAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQiIpLAogICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBTb21lKDEwKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpSdW4gewogICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7IGN1cnJlbnQ6IDIsIHRvdGFsOiAyIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJCIiksCiAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogTm9uZSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IFNvbWUoMTApLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlJhbiB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMiwgdG90YWw6IDIgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkIiKSwKICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldygxMCksIGRvbmU6IHRydWUgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyBVbndpbmRpbmcKICAgICAgICAgICAgICAgIC8vIE5vdGhpbmcgdG8gdW53aW5kIGluIHN0YWdlICJCIgogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6U2tpcHBlZCB7IHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQiIpIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpVbndpbmQgewogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQSIpLAogICAgICAgICAgICAgICAgICAgIGlucHV0OiBVbndpbmRJbnB1dCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDEwMCksCiAgICAgICAgICAgICAgICAgICAgICAgIHVud2luZF90bzogNTAsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhZF9ibG9jazogTm9uZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpVbndvdW5kIHsKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDUwKSB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgXQogICAgICAgICk7CiAgICB9CgogICAgLy8vIFJ1bnMgYSBwaXBlbGluZSB0aGF0IHVud2luZHMgZHVyaW5nIHN5bmMuCiAgICAvLy8KICAgIC8vLyBUaGUgZmxvdyBpczoKICAgIC8vLwogICAgLy8vIC0gU3RhZ2UgQSBzeW5jcyB0byBibG9jayAxMAogICAgLy8vIC0gU3RhZ2UgQiB0cmlnZ2VycyBhbiB1bndpbmQsIG1hcmtpbmcgYmxvY2sgNSBhcyBiYWQKICAgIC8vLyAtIFN0YWdlIEIgdW53aW5kcyB0byBpdHMgcHJldmlvdXMgcHJvZ3Jlc3MsIGJsb2NrIDAgYnV0IHNpbmNlIGl0IGlzIHN0aWxsIGF0IGJsb2NrIDAsIGl0IGlzCiAgICAvLy8gICBza2lwcGVkIGVudGlyZWx5ICh0aGVyZSBpcyBub3RoaW5nIHRvIHVud2luZCkKICAgIC8vLyAtIFN0YWdlIEEgdW53aW5kcyB0byBpdHMgcHJldmlvdXMgcHJvZ3Jlc3MsIGJsb2NrIDAKICAgIC8vLyAtIFN0YWdlIEEgc3luY3MgYmFjayB1cCB0byBibG9jayAxMAogICAgLy8vIC0gU3RhZ2UgQiBzeW5jcyB0byBibG9jayAxMAogICAgLy8vIC0gVGhlIHBpcGVsaW5lIGZpbmlzaGVzCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gcnVuX3BpcGVsaW5lX3dpdGhfdW53aW5kKCkgewogICAgICAgIGxldCBwcm92aWRlcl9mYWN0b3J5ID0gY3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeSgpOwoKICAgICAgICBsZXQgbXV0IHBpcGVsaW5lID0gUGlwZWxpbmU6OjxNb2NrTm9kZVR5cGVzV2l0aERCPjo6YnVpbGRlcigpCiAgICAgICAgICAgIC5hZGRfc3RhZ2UoCiAgICAgICAgICAgICAgICBUZXN0U3RhZ2U6Om5ldyhTdGFnZUlkOjpPdGhlcigiQSIpKQogICAgICAgICAgICAgICAgICAgIC5hZGRfZXhlYyhPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMTApLCBkb25lOiB0cnVlIH0pKQogICAgICAgICAgICAgICAgICAgIC5hZGRfdW53aW5kKE9rKFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDApIH0pKQogICAgICAgICAgICAgICAgICAgIC5hZGRfZXhlYyhPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMTApLCBkb25lOiB0cnVlIH0pKSwKICAgICAgICAgICAgKQogICAgICAgICAgICAuYWRkX3N0YWdlKAogICAgICAgICAgICAgICAgVGVzdFN0YWdlOjpuZXcoU3RhZ2VJZDo6T3RoZXIoIkIiKSkKICAgICAgICAgICAgICAgICAgICAuYWRkX2V4ZWMoRXJyKFN0YWdlRXJyb3I6OkJsb2NrIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2s6IEJveDo6bmV3KHJhbmRvbV9ibG9ja193aXRoX3BhcmVudCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICZtdXQgZ2VuZXJhdG9yczo6cm5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA1LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICAgICAgICAgICAgICApKSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IEJsb2NrRXJyb3JLaW5kOjpWYWxpZGF0aW9uKENvbnNlbnN1c0Vycm9yOjpCYXNlRmVlTWlzc2luZyksCiAgICAgICAgICAgICAgICAgICAgfSkpCiAgICAgICAgICAgICAgICAgICAgLmFkZF91bndpbmQoT2soVW53aW5kT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMCkgfSkpCiAgICAgICAgICAgICAgICAgICAgLmFkZF9leGVjKE9rKEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldygxMCksIGRvbmU6IHRydWUgfSkpLAogICAgICAgICAgICApCiAgICAgICAgICAgIC53aXRoX21heF9ibG9jaygxMCkKICAgICAgICAgICAgLmJ1aWxkKAogICAgICAgICAgICAgICAgcHJvdmlkZXJfZmFjdG9yeS5jbG9uZSgpLAogICAgICAgICAgICAgICAgU3RhdGljRmlsZVByb2R1Y2VyOjpuZXcocHJvdmlkZXJfZmFjdG9yeS5jbG9uZSgpLCBQcnVuZU1vZGVzOjpkZWZhdWx0KCkpLAogICAgICAgICAgICApOwogICAgICAgIGxldCBldmVudHMgPSBwaXBlbGluZS5ldmVudHMoKTsKCiAgICAgICAgLy8gUnVuIHBpcGVsaW5lCiAgICAgICAgdG9raW86OnNwYXduKGFzeW5jIG1vdmUgewogICAgICAgICAgICBwaXBlbGluZS5ydW4oKS5hd2FpdC5leHBlY3QoIkNvdWxkIG5vdCBydW4gcGlwZWxpbmUiKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQ2hlY2sgdGhhdCB0aGUgc3RhZ2VzIHdlcmUgdW53b3VuZCBpbiByZXZlcnNlIG9yZGVyCiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgZXZlbnRzLmNvbGxlY3Q6OjxWZWM8UGlwZWxpbmVFdmVudD4+KCkuYXdhaXQsCiAgICAgICAgICAgIHZlYyFbCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpQcmVwYXJlIHsKICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgeyBjdXJyZW50OiAxLCB0b3RhbDogMiB9LAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQSIpLAogICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBTb21lKDEwKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpSdW4gewogICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7IGN1cnJlbnQ6IDEsIHRvdGFsOiAyIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJBIiksCiAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogTm9uZSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IFNvbWUoMTApLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlJhbiB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMSwgdG90YWw6IDIgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldygxMCksIGRvbmU6IHRydWUgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpQcmVwYXJlIHsKICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgeyBjdXJyZW50OiAyLCB0b3RhbDogMiB9LAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQiIpLAogICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBTb21lKDEwKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpSdW4gewogICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7IGN1cnJlbnQ6IDIsIHRvdGFsOiAyIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJCIiksCiAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogTm9uZSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IFNvbWUoMTApLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OkVycm9yIHsgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJCIikgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlVud2luZCB7CiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJBIiksCiAgICAgICAgICAgICAgICAgICAgaW5wdXQ6IFVud2luZElucHV0IHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMTApLAogICAgICAgICAgICAgICAgICAgICAgICB1bndpbmRfdG86IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhZF9ibG9jazogU29tZSg1KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpVbndvdW5kIHsKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDApIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUGlwZWxpbmVFdmVudDo6UHJlcGFyZSB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMSwgdG90YWw6IDIgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KDApKSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IFNvbWUoMTApLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlJ1biB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMSwgdG90YWw6IDIgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KDApKSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IFNvbWUoMTApLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlJhbiB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMSwgdG90YWw6IDIgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkEiKSwKICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldygxMCksIGRvbmU6IHRydWUgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpQcmVwYXJlIHsKICAgICAgICAgICAgICAgICAgICBwaXBlbGluZV9zdGFnZXNfcHJvZ3Jlc3M6IFBpcGVsaW5lU3RhZ2VzUHJvZ3Jlc3MgeyBjdXJyZW50OiAyLCB0b3RhbDogMiB9LAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2lkOiBTdGFnZUlkOjpPdGhlcigiQiIpLAogICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBTb21lKDEwKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBQaXBlbGluZUV2ZW50OjpSdW4gewogICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lX3N0YWdlc19wcm9ncmVzczogUGlwZWxpbmVTdGFnZXNQcm9ncmVzcyB7IGN1cnJlbnQ6IDIsIHRvdGFsOiAyIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQ6Ok90aGVyKCJCIiksCiAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogTm9uZSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IFNvbWUoMTApLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFBpcGVsaW5lRXZlbnQ6OlJhbiB7CiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmVfc3RhZ2VzX3Byb2dyZXNzOiBQaXBlbGluZVN0YWdlc1Byb2dyZXNzIHsgY3VycmVudDogMiwgdG90YWw6IDIgfSwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9pZDogU3RhZ2VJZDo6T3RoZXIoIkIiKSwKICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldygxMCksIGRvbmU6IHRydWUgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF0KICAgICAgICApOwogICAgfQoKICAgIC8vLyBDaGVja3MgdGhhdCB0aGUgcGlwZWxpbmUgcmUtcnVucyBzdGFnZXMgb24gbm9uLWZhdGFsIGVycm9ycyBhbmQgc3RvcHMgb24gZmF0YWwgb25lcy4KICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBwaXBlbGluZV9lcnJvcl9oYW5kbGluZygpIHsKICAgICAgICAvLyBOb24tZmF0YWwKICAgICAgICBsZXQgcHJvdmlkZXJfZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKICAgICAgICBsZXQgbXV0IHBpcGVsaW5lID0gUGlwZWxpbmU6OjxNb2NrTm9kZVR5cGVzV2l0aERCPjo6YnVpbGRlcigpCiAgICAgICAgICAgIC5hZGRfc3RhZ2UoCiAgICAgICAgICAgICAgICBUZXN0U3RhZ2U6Om5ldyhTdGFnZUlkOjpPdGhlcigiTm9uRmF0YWwiKSkKICAgICAgICAgICAgICAgICAgICAuYWRkX2V4ZWMoRXJyKFN0YWdlRXJyb3I6OlJlY292ZXJhYmxlKEJveDo6bmV3KHN0ZDo6Zm10OjpFcnJvcikpKSkKICAgICAgICAgICAgICAgICAgICAuYWRkX2V4ZWMoT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDEwKSwgZG9uZTogdHJ1ZSB9KSksCiAgICAgICAgICAgICkKICAgICAgICAgICAgLndpdGhfbWF4X2Jsb2NrKDEwKQogICAgICAgICAgICAuYnVpbGQoCiAgICAgICAgICAgICAgICBwcm92aWRlcl9mYWN0b3J5LmNsb25lKCksCiAgICAgICAgICAgICAgICBTdGF0aWNGaWxlUHJvZHVjZXI6Om5ldyhwcm92aWRlcl9mYWN0b3J5LmNsb25lKCksIFBydW5lTW9kZXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgICk7CiAgICAgICAgbGV0IHJlc3VsdCA9IHBpcGVsaW5lLnJ1bigpLmF3YWl0OwogICAgICAgIGFzc2VydF9tYXRjaGVzIShyZXN1bHQsIE9rKCgpKSk7CgogICAgICAgIC8vIEZhdGFsCiAgICAgICAgbGV0IHByb3ZpZGVyX2ZhY3RvcnkgPSBjcmVhdGVfdGVzdF9wcm92aWRlcl9mYWN0b3J5KCk7CiAgICAgICAgbGV0IG11dCBwaXBlbGluZSA9IFBpcGVsaW5lOjo8TW9ja05vZGVUeXBlc1dpdGhEQj46OmJ1aWxkZXIoKQogICAgICAgICAgICAuYWRkX3N0YWdlKFRlc3RTdGFnZTo6bmV3KFN0YWdlSWQ6Ok90aGVyKCJGYXRhbCIpKS5hZGRfZXhlYyhFcnIoCiAgICAgICAgICAgICAgICBTdGFnZUVycm9yOjpEYXRhYmFzZUludGVncml0eShQcm92aWRlckVycm9yOjpCbG9ja0JvZHlJbmRpY2VzTm90Rm91bmQoNSkpLAogICAgICAgICAgICApKSkKICAgICAgICAgICAgLmJ1aWxkKAogICAgICAgICAgICAgICAgcHJvdmlkZXJfZmFjdG9yeS5jbG9uZSgpLAogICAgICAgICAgICAgICAgU3RhdGljRmlsZVByb2R1Y2VyOjpuZXcocHJvdmlkZXJfZmFjdG9yeS5jbG9uZSgpLCBQcnVuZU1vZGVzOjpkZWZhdWx0KCkpLAogICAgICAgICAgICApOwogICAgICAgIGxldCByZXN1bHQgPSBwaXBlbGluZS5ydW4oKS5hd2FpdDsKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoCiAgICAgICAgICAgIHJlc3VsdCwKICAgICAgICAgICAgRXJyKFBpcGVsaW5lRXJyb3I6OlN0YWdlKFN0YWdlRXJyb3I6OkRhdGFiYXNlSW50ZWdyaXR5KAogICAgICAgICAgICAgICAgUHJvdmlkZXJFcnJvcjo6QmxvY2tCb2R5SW5kaWNlc05vdEZvdW5kKDUpCiAgICAgICAgICAgICkpKQogICAgICAgICk7CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9hcGkvc3JjL3BpcGVsaW5lL3Byb2dyZXNzLnJzIj4KdXNlIGNyYXRlOjp7dXRpbDo6b3B0LCBDb250cm9sRmxvd307CnVzZSBhbGxveV9wcmltaXRpdmVzOjpCbG9ja051bWJlcjsKCiNbZGVyaXZlKERlYnVnLCBEZWZhdWx0KV0KcHViKGNyYXRlKSBzdHJ1Y3QgUGlwZWxpbmVQcm9ncmVzcyB7CiAgICAvLy8gQmxvY2sgbnVtYmVyIHJlYWNoZWQgYnkgdGhlIHN0YWdlLgogICAgcHViKGNyYXRlKSBibG9ja19udW1iZXI6IE9wdGlvbjxCbG9ja051bWJlcj4sCiAgICAvLy8gVGhlIG1heGltdW0gYmxvY2sgbnVtYmVyIGFjaGlldmVkIGJ5IGFueSBzdGFnZSBkdXJpbmcgdGhlIGV4ZWN1dGlvbiBvZiB0aGUgcGlwZWxpbmUuCiAgICBwdWIoY3JhdGUpIG1heGltdW1fYmxvY2tfbnVtYmVyOiBPcHRpb248QmxvY2tOdW1iZXI+LAogICAgLy8vIFRoZSBtaW5pbXVtIGJsb2NrIG51bWJlciBhY2hpZXZlZCBieSBhbnkgc3RhZ2UgZHVyaW5nIHRoZSBleGVjdXRpb24gb2YgdGhlIHBpcGVsaW5lLgogICAgcHViKGNyYXRlKSBtaW5pbXVtX2Jsb2NrX251bWJlcjogT3B0aW9uPEJsb2NrTnVtYmVyPiwKfQoKaW1wbCBQaXBlbGluZVByb2dyZXNzIHsKICAgIHB1YihjcmF0ZSkgZm4gdXBkYXRlKCZtdXQgc2VsZiwgYmxvY2tfbnVtYmVyOiBCbG9ja051bWJlcikgewogICAgICAgIHNlbGYuYmxvY2tfbnVtYmVyID0gU29tZShibG9ja19udW1iZXIpOwogICAgICAgIHNlbGYubWluaW11bV9ibG9ja19udW1iZXIgPSBvcHQ6Om1pbihzZWxmLm1pbmltdW1fYmxvY2tfbnVtYmVyLCBibG9ja19udW1iZXIpOwogICAgICAgIHNlbGYubWF4aW11bV9ibG9ja19udW1iZXIgPSBvcHQ6Om1heChzZWxmLm1heGltdW1fYmxvY2tfbnVtYmVyLCBibG9ja19udW1iZXIpOwogICAgfQoKICAgIC8vLyBHZXQgbmV4dCBjb250cm9sIGZsb3cgc3RlcAogICAgcHViKGNyYXRlKSBjb25zdCBmbiBuZXh0X2N0cmwoJnNlbGYpIC0+IENvbnRyb2xGbG93IHsKICAgICAgICBtYXRjaCBzZWxmLmJsb2NrX251bWJlciB7CiAgICAgICAgICAgIFNvbWUoYmxvY2tfbnVtYmVyKSA9PiBDb250cm9sRmxvdzo6Q29udGludWUgeyBibG9ja19udW1iZXIgfSwKICAgICAgICAgICAgTm9uZSA9PiBDb250cm9sRmxvdzo6Tm9Qcm9ncmVzcyB7IGJsb2NrX251bWJlcjogTm9uZSB9LAogICAgICAgIH0KICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvc3RhZ2VzL2FwaS9zcmMvcGlwZWxpbmUvc2V0LnJzIj4KdXNlIGNyYXRlOjp7U3RhZ2UsIFN0YWdlSWR9Owp1c2Ugc3RkOjp7CiAgICBjb2xsZWN0aW9uczo6SGFzaE1hcCwKICAgIGZtdDo6e0RlYnVnLCBGb3JtYXR0ZXJ9LAp9OwoKLy8vIENvbWJpbmVzIG11bHRpcGxlIFtgU3RhZ2VgXXMgaW50byBhIHNpbmdsZSB1bml0LgovLy8KLy8vIEEgW2BTdGFnZVNldGBdIGlzIGEgbG9naWNhbCBjaHVuayBvZiBzdGFnZXMgdGhhdCBkZXBlbmQgb24gZWFjaCBvdGhlci4gSXQgaXMgdXAgdG8gdGhlCi8vLyBpbmRpdmlkdWFsIHN0YWdlIHNldHMgdG8gZGV0ZXJtaW5lIHdoYXQga2luZCBvZiBjb25maWd1cmF0aW9uIHRoZXkgZXhwb3NlLgovLy8KLy8vIEluZGl2aWR1YWwgc3RhZ2VzIGluIHRoZSBzZXQgY2FuIGJlIGFkZGVkLCByZW1vdmVkIGFuZCBvdmVycmlkZGVuIHVzaW5nIFtgU3RhZ2VTZXRCdWlsZGVyYF0uCnB1YiB0cmFpdCBTdGFnZVNldDxQcm92aWRlcj46IFNpemVkIHsKICAgIC8vLyBDb25maWd1cmVzIHRoZSBzdGFnZXMgaW4gdGhlIHNldC4KICAgIGZuIGJ1aWxkZXIoc2VsZikgLT4gU3RhZ2VTZXRCdWlsZGVyPFByb3ZpZGVyPjsKCiAgICAvLy8gT3ZlcnJpZGVzIHRoZSBnaXZlbiBbYFN0YWdlYF0sIGlmIGl0IGlzIGluIHRoaXMgc2V0LgogICAgLy8vCiAgICAvLy8gIyBQYW5pY3MKICAgIC8vLwogICAgLy8vIFBhbmljcyBpZiB0aGUgW2BTdGFnZWBdIGlzIG5vdCBpbiB0aGlzIHNldC4KICAgIGZuIHNldDxTOiBTdGFnZTxQcm92aWRlcj4gKyAnc3RhdGljPihzZWxmLCBzdGFnZTogUykgLT4gU3RhZ2VTZXRCdWlsZGVyPFByb3ZpZGVyPiB7CiAgICAgICAgc2VsZi5idWlsZGVyKCkuc2V0KHN0YWdlKQogICAgfQp9CgpzdHJ1Y3QgU3RhZ2VFbnRyeTxQcm92aWRlcj4gewogICAgc3RhZ2U6IEJveDxkeW4gU3RhZ2U8UHJvdmlkZXI+PiwKICAgIGVuYWJsZWQ6IGJvb2wsCn0KCmltcGw8UHJvdmlkZXI+IERlYnVnIGZvciBTdGFnZUVudHJ5PFByb3ZpZGVyPiB7CiAgICBmbiBmbXQoJnNlbGYsIGY6ICZtdXQgRm9ybWF0dGVyPCdfPikgLT4gc3RkOjpmbXQ6OlJlc3VsdCB7CiAgICAgICAgZi5kZWJ1Z19zdHJ1Y3QoIlN0YWdlRW50cnkiKQogICAgICAgICAgICAuZmllbGQoInN0YWdlIiwgJnNlbGYuc3RhZ2UuaWQoKSkKICAgICAgICAgICAgLmZpZWxkKCJlbmFibGVkIiwgJnNlbGYuZW5hYmxlZCkKICAgICAgICAgICAgLmZpbmlzaCgpCiAgICB9Cn0KCi8vLyBIZWxwZXIgdG8gY3JlYXRlIGFuZCBjb25maWd1cmUgYSBbYFN0YWdlU2V0YF0uCi8vLwovLy8gVGhlIGJ1aWxkZXIgcHJvdmlkZXMgb3JkZXJpbmcgaGVscGVycyB0byBlbnN1cmUgdGhhdCBzdGFnZXMgdGhhdCBkZXBlbmQgb24gZWFjaCBvdGhlciBhcmUgYWRkZWQKLy8vIHRvIHRoZSBmaW5hbCBzeW5jIHBpcGVsaW5lIGJlZm9yZS9hZnRlciB0aGVpciBkZXBlbmRlbmNpZXMuCi8vLwovLy8gU3RhZ2VzIGluc2lkZSB0aGUgc2V0IGNhbiBiZSBkaXNhYmxlZCwgZW5hYmxlZCwgb3ZlcnJpZGRlbiBhbmQgcmVvcmRlcmVkLgpwdWIgc3RydWN0IFN0YWdlU2V0QnVpbGRlcjxQcm92aWRlcj4gewogICAgc3RhZ2VzOiBIYXNoTWFwPFN0YWdlSWQsIFN0YWdlRW50cnk8UHJvdmlkZXI+PiwKICAgIG9yZGVyOiBWZWM8U3RhZ2VJZD4sCn0KCmltcGw8UHJvdmlkZXI+IERlZmF1bHQgZm9yIFN0YWdlU2V0QnVpbGRlcjxQcm92aWRlcj4gewogICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBzdGFnZXM6IEhhc2hNYXA6OmRlZmF1bHQoKSwgb3JkZXI6IFZlYzo6bmV3KCkgfQogICAgfQp9CgppbXBsPFByb3ZpZGVyPiBEZWJ1ZyBmb3IgU3RhZ2VTZXRCdWlsZGVyPFByb3ZpZGVyPiB7CiAgICBmbiBmbXQoJnNlbGYsIGY6ICZtdXQgRm9ybWF0dGVyPCdfPikgLT4gc3RkOjpmbXQ6OlJlc3VsdCB7CiAgICAgICAgZi5kZWJ1Z19zdHJ1Y3QoIlN0YWdlU2V0QnVpbGRlciIpCiAgICAgICAgICAgIC5maWVsZCgic3RhZ2VzIiwgJnNlbGYuc3RhZ2VzKQogICAgICAgICAgICAuZmllbGQoIm9yZGVyIiwgJnNlbGYub3JkZXIpCiAgICAgICAgICAgIC5maW5pc2goKQogICAgfQp9CgppbXBsPFByb3ZpZGVyPiBTdGFnZVNldEJ1aWxkZXI8UHJvdmlkZXI+IHsKICAgIGZuIGluZGV4X29mKCZzZWxmLCBzdGFnZV9pZDogU3RhZ2VJZCkgLT4gdXNpemUgewogICAgICAgIGxldCBpbmRleCA9IHNlbGYub3JkZXIuaXRlcigpLnBvc2l0aW9uKHwmaWR8IGlkID09IHN0YWdlX2lkKTsKCiAgICAgICAgaW5kZXgudW53cmFwX29yX2Vsc2UofHwgcGFuaWMhKCJTdGFnZSBkb2VzIG5vdCBleGlzdCBpbiBzZXQ6IHtzdGFnZV9pZH0iKSkKICAgIH0KCiAgICBmbiB1cHNlcnRfc3RhZ2Vfc3RhdGUoJm11dCBzZWxmLCBzdGFnZTogQm94PGR5biBTdGFnZTxQcm92aWRlcj4+LCBhZGRlZF9hdF9pbmRleDogdXNpemUpIHsKICAgICAgICBsZXQgc3RhZ2VfaWQgPSBzdGFnZS5pZCgpOwogICAgICAgIGlmIHNlbGYuc3RhZ2VzLmluc2VydChzdGFnZS5pZCgpLCBTdGFnZUVudHJ5IHsgc3RhZ2UsIGVuYWJsZWQ6IHRydWUgfSkuaXNfc29tZSgpICYmCiAgICAgICAgICAgIGxldCBTb21lKHRvX3JlbW92ZSkgPSBzZWxmCiAgICAgICAgICAgICAgICAub3JkZXIKICAgICAgICAgICAgICAgIC5pdGVyKCkKICAgICAgICAgICAgICAgIC5lbnVtZXJhdGUoKQogICAgICAgICAgICAgICAgLmZpbmQofChpLCBpZCl8ICppICE9IGFkZGVkX2F0X2luZGV4ICYmICoqaWQgPT0gc3RhZ2VfaWQpCiAgICAgICAgICAgICAgICAubWFwKHwoaSwgXyl8IGkpCiAgICAgICAgewogICAgICAgICAgICBzZWxmLm9yZGVyLnJlbW92ZSh0b19yZW1vdmUpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gT3ZlcnJpZGVzIHRoZSBnaXZlbiBbYFN0YWdlYF0sIGlmIGl0IGlzIGluIHRoaXMgc2V0LgogICAgLy8vCiAgICAvLy8gIyBQYW5pY3MKICAgIC8vLwogICAgLy8vIFBhbmljcyBpZiB0aGUgW2BTdGFnZWBdIGlzIG5vdCBpbiB0aGlzIHNldC4KICAgIHB1YiBmbiBzZXQ8UzogU3RhZ2U8UHJvdmlkZXI+ICsgJ3N0YXRpYz4obXV0IHNlbGYsIHN0YWdlOiBTKSAtPiBTZWxmIHsKICAgICAgICBsZXQgZW50cnkgPSBzZWxmCiAgICAgICAgICAgIC5zdGFnZXMKICAgICAgICAgICAgLmdldF9tdXQoJnN0YWdlLmlkKCkpCiAgICAgICAgICAgIC51bndyYXBfb3JfZWxzZSh8fCBwYW5pYyEoIlN0YWdlIGRvZXMgbm90IGV4aXN0IGluIHNldDoge30iLCBzdGFnZS5pZCgpKSk7CiAgICAgICAgZW50cnkuc3RhZ2UgPSBCb3g6Om5ldyhzdGFnZSk7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBSZXR1cm5zIGl0ZXJhdG9yIG92ZXIgdGhlIHN0YWdlcyBpbiB0aGlzIHNldCwKICAgIC8vLyBJbiB0aGUgc2FtZSBvcmRlciB0aGV5IHdvdWxkIGJlIGV4ZWN1dGVkIGluIHRoZSBwaXBlbGluZS4KICAgIHB1YiBmbiBzdGFnZXMoJnNlbGYpIC0+IGltcGwgSXRlcmF0b3I8SXRlbSA9IFN0YWdlSWQ+ICsgJ18gewogICAgICAgIHNlbGYub3JkZXIuaXRlcigpLmNvcGllZCgpCiAgICB9CgogICAgLy8vIFJlcGxhY2VzIGEgc3RhZ2Ugd2l0aCB0aGUgZ2l2ZW4gSUQgd2l0aCBhIG5ldyBzdGFnZS4KICAgIC8vLwogICAgLy8vIElmIHRoZSBuZXcgc3RhZ2UgaGFzIGEgZGlmZmVyZW50IElELAogICAgLy8vIGl0IHdpbGwgbWFpbnRhaW4gdGhlIG9yaWdpbmFsIHN0YWdlJ3MgcG9zaXRpb24gaW4gdGhlIGV4ZWN1dGlvbiBvcmRlci4KICAgIHB1YiBmbiByZXBsYWNlPFM6IFN0YWdlPFByb3ZpZGVyPiArICdzdGF0aWM+KG11dCBzZWxmLCBzdGFnZV9pZDogU3RhZ2VJZCwgc3RhZ2U6IFMpIC0+IFNlbGYgewogICAgICAgIHNlbGYuc3RhZ2VzCiAgICAgICAgICAgIC5nZXQoJnN0YWdlX2lkKQogICAgICAgICAgICAudW53cmFwX29yX2Vsc2UofHwgcGFuaWMhKCJTdGFnZSBkb2VzIG5vdCBleGlzdCBpbiBzZXQ6IHtzdGFnZV9pZH0iKSk7CgogICAgICAgIGlmIHN0YWdlLmlkKCkgPT0gc3RhZ2VfaWQgewogICAgICAgICAgICByZXR1cm4gc2VsZi5zZXQoc3RhZ2UpOwogICAgICAgIH0KICAgICAgICBsZXQgaW5kZXggPSBzZWxmLmluZGV4X29mKHN0YWdlX2lkKTsKICAgICAgICBzZWxmLnN0YWdlcy5yZW1vdmUoJnN0YWdlX2lkKTsKICAgICAgICBzZWxmLm9yZGVyW2luZGV4XSA9IHN0YWdlLmlkKCk7CiAgICAgICAgc2VsZi51cHNlcnRfc3RhZ2Vfc3RhdGUoQm94OjpuZXcoc3RhZ2UpLCBpbmRleCk7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBBZGRzIHRoZSBnaXZlbiBbYFN0YWdlYF0gYXQgdGhlIGVuZCBvZiB0aGlzIHNldC4KICAgIC8vLwogICAgLy8vIElmIHRoZSBzdGFnZSB3YXMgYWxyZWFkeSBpbiB0aGUgZ3JvdXAsIGl0IGlzIHJlbW92ZWQgZnJvbSBpdHMgcHJldmlvdXMgcGxhY2UuCiAgICBwdWIgZm4gYWRkX3N0YWdlPFM6IFN0YWdlPFByb3ZpZGVyPiArICdzdGF0aWM+KG11dCBzZWxmLCBzdGFnZTogUykgLT4gU2VsZiB7CiAgICAgICAgbGV0IHRhcmdldF9pbmRleCA9IHNlbGYub3JkZXIubGVuKCk7CiAgICAgICAgc2VsZi5vcmRlci5wdXNoKHN0YWdlLmlkKCkpOwogICAgICAgIHNlbGYudXBzZXJ0X3N0YWdlX3N0YXRlKEJveDo6bmV3KHN0YWdlKSwgdGFyZ2V0X2luZGV4KTsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIEFkZHMgdGhlIGdpdmVuIFtgU3RhZ2VgXSBhdCB0aGUgZW5kIG9mIHRoaXMgc2V0IGlmIGl0J3MgW2BTb21lYF0uCiAgICAvLy8KICAgIC8vLyBJZiB0aGUgc3RhZ2Ugd2FzIGFscmVhZHkgaW4gdGhlIGdyb3VwLCBpdCBpcyByZW1vdmVkIGZyb20gaXRzIHByZXZpb3VzIHBsYWNlLgogICAgcHViIGZuIGFkZF9zdGFnZV9vcHQ8UzogU3RhZ2U8UHJvdmlkZXI+ICsgJ3N0YXRpYz4oc2VsZiwgc3RhZ2U6IE9wdGlvbjxTPikgLT4gU2VsZiB7CiAgICAgICAgaWYgbGV0IFNvbWUoc3RhZ2UpID0gc3RhZ2UgewogICAgICAgICAgICBzZWxmLmFkZF9zdGFnZShzdGFnZSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmCiAgICAgICAgfQogICAgfQoKICAgIC8vLyBBZGRzIHRoZSBnaXZlbiBbYFN0YWdlU2V0YF0gdG8gdGhlIGVuZCBvZiB0aGlzIHNldC4KICAgIC8vLwogICAgLy8vIElmIGEgc3RhZ2UgaXMgaW4gYm90aCBzZXRzLCBpdCBpcyByZW1vdmVkIGZyb20gaXRzIHByZXZpb3VzIHBsYWNlIGluIHRoaXMgc2V0LiBCZWNhdXNlIG9mCiAgICAvLy8gdGhpcywgaXQgaXMgYWR2aXNhYmxlIHRvIG1lcmdlIHNldHMgZmlyc3QgYW5kIHJlLW9yZGVyIHN0YWdlcyBhZnRlciBpZiBuZWVkZWQuCiAgICBwdWIgZm4gYWRkX3NldDxTZXQ6IFN0YWdlU2V0PFByb3ZpZGVyPj4obXV0IHNlbGYsIHNldDogU2V0KSAtPiBTZWxmIHsKICAgICAgICBmb3Igc3RhZ2UgaW4gc2V0LmJ1aWxkZXIoKS5idWlsZCgpIHsKICAgICAgICAgICAgbGV0IHRhcmdldF9pbmRleCA9IHNlbGYub3JkZXIubGVuKCk7CiAgICAgICAgICAgIHNlbGYub3JkZXIucHVzaChzdGFnZS5pZCgpKTsKICAgICAgICAgICAgc2VsZi51cHNlcnRfc3RhZ2Vfc3RhdGUoc3RhZ2UsIHRhcmdldF9pbmRleCk7CiAgICAgICAgfQogICAgICAgIHNlbGYKICAgIH0KCiAgICAvLy8gQWRkcyB0aGUgZ2l2ZW4gW2BTdGFnZWBdIGJlZm9yZSB0aGUgc3RhZ2Ugd2l0aCB0aGUgZ2l2ZW4gW2BTdGFnZUlkYF0uCiAgICAvLy8KICAgIC8vLyBJZiB0aGUgc3RhZ2Ugd2FzIGFscmVhZHkgaW4gdGhlIGdyb3VwLCBpdCBpcyByZW1vdmVkIGZyb20gaXRzIHByZXZpb3VzIHBsYWNlLgogICAgLy8vCiAgICAvLy8gIyBQYW5pY3MKICAgIC8vLwogICAgLy8vIFBhbmljcyBpZiB0aGUgZGVwZW5kZW5jeSBzdGFnZSBpcyBub3QgaW4gdGhpcyBzZXQuCiAgICBwdWIgZm4gYWRkX2JlZm9yZTxTOiBTdGFnZTxQcm92aWRlcj4gKyAnc3RhdGljPihtdXQgc2VsZiwgc3RhZ2U6IFMsIGJlZm9yZTogU3RhZ2VJZCkgLT4gU2VsZiB7CiAgICAgICAgbGV0IHRhcmdldF9pbmRleCA9IHNlbGYuaW5kZXhfb2YoYmVmb3JlKTsKICAgICAgICBzZWxmLm9yZGVyLmluc2VydCh0YXJnZXRfaW5kZXgsIHN0YWdlLmlkKCkpOwogICAgICAgIHNlbGYudXBzZXJ0X3N0YWdlX3N0YXRlKEJveDo6bmV3KHN0YWdlKSwgdGFyZ2V0X2luZGV4KTsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIEFkZHMgdGhlIGdpdmVuIFtgU3RhZ2VgXSBhZnRlciB0aGUgc3RhZ2Ugd2l0aCB0aGUgZ2l2ZW4gW2BTdGFnZUlkYF0uCiAgICAvLy8KICAgIC8vLyBJZiB0aGUgc3RhZ2Ugd2FzIGFscmVhZHkgaW4gdGhlIGdyb3VwLCBpdCBpcyByZW1vdmVkIGZyb20gaXRzIHByZXZpb3VzIHBsYWNlLgogICAgLy8vCiAgICAvLy8gIyBQYW5pY3MKICAgIC8vLwogICAgLy8vIFBhbmljcyBpZiB0aGUgZGVwZW5kZW5jeSBzdGFnZSBpcyBub3QgaW4gdGhpcyBzZXQuCiAgICBwdWIgZm4gYWRkX2FmdGVyPFM6IFN0YWdlPFByb3ZpZGVyPiArICdzdGF0aWM+KG11dCBzZWxmLCBzdGFnZTogUywgYWZ0ZXI6IFN0YWdlSWQpIC0+IFNlbGYgewogICAgICAgIGxldCB0YXJnZXRfaW5kZXggPSBzZWxmLmluZGV4X29mKGFmdGVyKSArIDE7CiAgICAgICAgc2VsZi5vcmRlci5pbnNlcnQodGFyZ2V0X2luZGV4LCBzdGFnZS5pZCgpKTsKICAgICAgICBzZWxmLnVwc2VydF9zdGFnZV9zdGF0ZShCb3g6Om5ldyhzdGFnZSksIHRhcmdldF9pbmRleCk7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBFbmFibGVzIHRoZSBnaXZlbiBzdGFnZS4KICAgIC8vLwogICAgLy8vIEFsbCBzdGFnZXMgd2l0aGluIGEgW2BTdGFnZVNldGBdIGFyZSBlbmFibGVkIGJ5IGRlZmF1bHQuCiAgICAvLy8KICAgIC8vLyAjIFBhbmljcwogICAgLy8vCiAgICAvLy8gUGFuaWNzIGlmIHRoZSBzdGFnZSBpcyBub3QgaW4gdGhpcyBzZXQuCiAgICBwdWIgZm4gZW5hYmxlKG11dCBzZWxmLCBzdGFnZV9pZDogU3RhZ2VJZCkgLT4gU2VsZiB7CiAgICAgICAgbGV0IGVudHJ5ID0KICAgICAgICAgICAgc2VsZi5zdGFnZXMuZ2V0X211dCgmc3RhZ2VfaWQpLmV4cGVjdCgiQ2Fubm90IGVuYWJsZSBhIHN0YWdlIHRoYXQgaXMgbm90IGluIHRoZSBzZXQuIik7CiAgICAgICAgZW50cnkuZW5hYmxlZCA9IHRydWU7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBEaXNhYmxlcyB0aGUgZ2l2ZW4gc3RhZ2UuCiAgICAvLy8KICAgIC8vLyBUaGUgZGlzYWJsZWQgW2BTdGFnZWBdIGtlZXBzIGl0cyBwbGFjZSBpbiB0aGUgc2V0LCBzbyBpdCBjYW4gYmUgdXNlZCBmb3Igb3JkZXJpbmcgd2l0aAogICAgLy8vIFtgU3RhZ2VTZXRCdWlsZGVyOjphZGRfYmVmb3JlYF0gb3IgW2BTdGFnZVNldEJ1aWxkZXI6OmFkZF9hZnRlcmBdLCBvciBpdCBjYW4gYmUgcmUtZW5hYmxlZC4KICAgIC8vLwogICAgLy8vIEFsbCBzdGFnZXMgd2l0aGluIGEgW2BTdGFnZVNldGBdIGFyZSBlbmFibGVkIGJ5IGRlZmF1bHQuCiAgICAvLy8KICAgIC8vLyAjIFBhbmljcwogICAgLy8vCiAgICAvLy8gUGFuaWNzIGlmIHRoZSBzdGFnZSBpcyBub3QgaW4gdGhpcyBzZXQuCiAgICAjW3RyYWNrX2NhbGxlcl0KICAgIHB1YiBmbiBkaXNhYmxlKG11dCBzZWxmLCBzdGFnZV9pZDogU3RhZ2VJZCkgLT4gU2VsZiB7CiAgICAgICAgbGV0IGVudHJ5ID0gc2VsZgogICAgICAgICAgICAuc3RhZ2VzCiAgICAgICAgICAgIC5nZXRfbXV0KCZzdGFnZV9pZCkKICAgICAgICAgICAgLnVud3JhcF9vcl9lbHNlKHx8IHBhbmljISgiQ2Fubm90IGRpc2FibGUgYSBzdGFnZSB0aGF0IGlzIG5vdCBpbiB0aGUgc2V0OiB7c3RhZ2VfaWR9IikpOwogICAgICAgIGVudHJ5LmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIERpc2FibGVzIGFsbCBnaXZlbiBzdGFnZXMuIFNlZSBbYGRpc2FibGVgXShTZWxmOjpkaXNhYmxlKS4KICAgIC8vLwogICAgLy8vIElmIGFueSBvZiB0aGUgc3RhZ2VzIGlzIG5vdCBpbiB0aGlzIHNldCwgaXQgaXMgaWdub3JlZC4KICAgIHB1YiBmbiBkaXNhYmxlX2FsbChtdXQgc2VsZiwgc3RhZ2VzOiAmW1N0YWdlSWRdKSAtPiBTZWxmIHsKICAgICAgICBmb3Igc3RhZ2VfaWQgaW4gc3RhZ2VzIHsKICAgICAgICAgICAgbGV0IFNvbWUoZW50cnkpID0gc2VsZi5zdGFnZXMuZ2V0X211dChzdGFnZV9pZCkgZWxzZSB7IGNvbnRpbnVlIH07CiAgICAgICAgICAgIGVudHJ5LmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBEaXNhYmxlcyB0aGUgZ2l2ZW4gc3RhZ2UgaWYgdGhlIGdpdmVuIGNsb3N1cmUgcmV0dXJucyB0cnVlLgogICAgLy8vCiAgICAvLy8gU2VlIFtgU2VsZjo6ZGlzYWJsZWBdCiAgICAjW3RyYWNrX2NhbGxlcl0KICAgIHB1YiBmbiBkaXNhYmxlX2lmPEY+KHNlbGYsIHN0YWdlX2lkOiBTdGFnZUlkLCBmOiBGKSAtPiBTZWxmCiAgICB3aGVyZQogICAgICAgIEY6IEZuT25jZSgpIC0+IGJvb2wsCiAgICB7CiAgICAgICAgaWYgZigpIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZGlzYWJsZShzdGFnZV9pZCkKICAgICAgICB9CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBEaXNhYmxlcyBhbGwgZ2l2ZW4gc3RhZ2VzIGlmIHRoZSBnaXZlbiBjbG9zdXJlIHJldHVybnMgdHJ1ZS4KICAgIC8vLwogICAgLy8vIFNlZSBbYFNlbGY6OmRpc2FibGVgXQogICAgI1t0cmFja19jYWxsZXJdCiAgICBwdWIgZm4gZGlzYWJsZV9hbGxfaWY8Rj4oc2VsZiwgc3RhZ2VzOiAmW1N0YWdlSWRdLCBmOiBGKSAtPiBTZWxmCiAgICB3aGVyZQogICAgICAgIEY6IEZuT25jZSgpIC0+IGJvb2wsCiAgICB7CiAgICAgICAgaWYgZigpIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZGlzYWJsZV9hbGwoc3RhZ2VzKQogICAgICAgIH0KICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIENvbnN1bWVzIHRoZSBidWlsZGVyIGFuZCByZXR1cm5zIHRoZSBjb250YWluZWQgW2BTdGFnZWBdcyBpbiB0aGUgb3JkZXIgc3BlY2lmaWVkLgogICAgcHViIGZuIGJ1aWxkKG11dCBzZWxmKSAtPiBWZWM8Qm94PGR5biBTdGFnZTxQcm92aWRlcj4+PiB7CiAgICAgICAgbGV0IG11dCBzdGFnZXMgPSBWZWM6Om5ldygpOwogICAgICAgIGZvciBpZCBpbiAmc2VsZi5vcmRlciB7CiAgICAgICAgICAgIGlmIGxldCBTb21lKGVudHJ5KSA9IHNlbGYuc3RhZ2VzLnJlbW92ZShpZCkgJiYKICAgICAgICAgICAgICAgIGVudHJ5LmVuYWJsZWQKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3RhZ2VzLnB1c2goZW50cnkuc3RhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN0YWdlcwogICAgfQp9CgppbXBsPFByb3ZpZGVyPiBTdGFnZVNldDxQcm92aWRlcj4gZm9yIFN0YWdlU2V0QnVpbGRlcjxQcm92aWRlcj4gewogICAgZm4gYnVpbGRlcihzZWxmKSAtPiBTZWxmIHsKICAgICAgICBzZWxmCiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9hcGkvc3JjL2xpYi5ycyI+Ci8vISBTdGFnZWQgc3luY2luZyBwcmltaXRpdmVzIGZvciByZXRoLgovLyEKLy8hICMjIEZlYXR1cmUgRmxhZ3MKLy8hCi8vISAtIGB0ZXN0LXV0aWxzYDogVXRpbGl0aWVzIGZvciB0ZXN0aW5nCgojIVtkb2MoCiAgICBodG1sX2xvZ29fdXJsID0gImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9wYXJhZGlnbXh5ei9yZXRoL21haW4vYXNzZXRzL3JldGgtZG9jcy5wbmciLAogICAgaHRtbF9mYXZpY29uX3VybCA9ICJodHRwczovL2F2YXRhcnMwLmdpdGh1YnVzZXJjb250ZW50LmNvbS91Lzk3MzY5NDY2P3M9MjU2IiwKICAgIGlzc3VlX3RyYWNrZXJfYmFzZV91cmwgPSAiaHR0cHM6Ly9naXRodWIuY29tL3BhcmFkaWdteHl6L3JldGgvaXNzdWVzLyIKKV0KIyFbY2ZnX2F0dHIoZG9jc3JzLCBmZWF0dXJlKGRvY19jZmcpKV0KIyFbY2ZnX2F0dHIobm90KHRlc3QpLCB3YXJuKHVudXNlZF9jcmF0ZV9kZXBlbmRlbmNpZXMpKV0KCm1vZCBlcnJvcjsKbW9kIG1ldHJpY3M7Cm1vZCBwaXBlbGluZTsKbW9kIHN0YWdlOwojW2NmZyhhbnkodGVzdCwgZmVhdHVyZSA9ICJ0ZXN0LXV0aWxzIikpXQpwdWIgbW9kIHRlc3RfdXRpbHM7Cm1vZCB1dGlsOwoKcHViIHVzZSBjcmF0ZTo6bWV0cmljczo6KjsKcHViIHVzZSBlcnJvcjo6KjsKcHViIHVzZSBwaXBlbGluZTo6KjsKcHViIHVzZSBzdGFnZTo6KjsKCnVzZSBhcXVhbWFyaW5lIGFzIF87CgovLyByZS1leHBvcnQgdGhlIHN0YWdlcyB0eXBlcyBmb3IgY29udmVuaWVuY2UKcHViIHVzZSByZXRoX3N0YWdlc190eXBlczo6KjsKPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9hcGkvc3JjL3N0YWdlLnJzIj4KdXNlIGNyYXRlOjp7ZXJyb3I6OlN0YWdlRXJyb3IsIFN0YWdlQ2hlY2twb2ludCwgU3RhZ2VJZH07CnVzZSBhbGxveV9wcmltaXRpdmVzOjp7QmxvY2tOdW1iZXIsIFR4TnVtYmVyfTsKdXNlIHJldGhfcHJvdmlkZXI6OntCbG9ja1JlYWRlciwgUHJvdmlkZXJFcnJvciwgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwgU3RhdGljRmlsZVNlZ21lbnR9Owp1c2Ugc3RkOjp7CiAgICBjbXA6OnttYXgsIG1pbn0sCiAgICBmdXR1cmU6Ontwb2xsX2ZuLCBGdXR1cmV9LAogICAgb3BzOjp7UmFuZ2UsIFJhbmdlSW5jbHVzaXZlfSwKICAgIHRhc2s6OntDb250ZXh0LCBQb2xsfSwKfTsKdXNlIHRyYWNpbmc6Omluc3RydW1lbnQ7CgovLy8gU3RhZ2UgZXhlY3V0aW9uIGlucHV0LCBzZWUgW2BTdGFnZTo6ZXhlY3V0ZWBdLgojW2Rlcml2ZShEZWJ1ZywgRGVmYXVsdCwgUGFydGlhbEVxLCBFcSwgQ2xvbmUsIENvcHkpXQpwdWIgc3RydWN0IEV4ZWNJbnB1dCB7CiAgICAvLy8gVGhlIHRhcmdldCBibG9jayBudW1iZXIgdGhlIHN0YWdlIG5lZWRzIHRvIGV4ZWN1dGUgdG93YXJkcy4KICAgIHB1YiB0YXJnZXQ6IE9wdGlvbjxCbG9ja051bWJlcj4sCiAgICAvLy8gVGhlIGNoZWNrcG9pbnQgb2YgdGhpcyBzdGFnZSB0aGUgbGFzdCB0aW1lIGl0IHdhcyBleGVjdXRlZC4KICAgIHB1YiBjaGVja3BvaW50OiBPcHRpb248U3RhZ2VDaGVja3BvaW50PiwKfQoKLy8vIFJldHVybiB0eXBlIGZvciBbYEV4ZWNJbnB1dDo6bmV4dF9ibG9ja19yYW5nZV93aXRoX3RocmVzaG9sZGBdLgojW2Rlcml2ZShEZWJ1ZywgUGFydGlhbEVxLCBFcSwgQ2xvbmUpXQpwdWIgc3RydWN0IEJsb2NrUmFuZ2VPdXRwdXQgewogICAgLy8vIFRoZSBibG9jayByYW5nZSB0byBleGVjdXRlLgogICAgcHViIGJsb2NrX3JhbmdlOiBSYW5nZUluY2x1c2l2ZTxCbG9ja051bWJlcj4sCiAgICAvLy8gV2hldGhlciB0aGlzIGlzIHRoZSBmaW5hbCByYW5nZSB0byBleGVjdXRlLgogICAgcHViIGlzX2ZpbmFsX3JhbmdlOiBib29sLAp9CgovLy8gUmV0dXJuIHR5cGUgZm9yIFtgRXhlY0lucHV0OjpuZXh0X2Jsb2NrX3JhbmdlX3dpdGhfdHJhbnNhY3Rpb25fdGhyZXNob2xkYF0uCiNbZGVyaXZlKERlYnVnLCBQYXJ0aWFsRXEsIEVxLCBDbG9uZSldCnB1YiBzdHJ1Y3QgVHJhbnNhY3Rpb25SYW5nZU91dHB1dCB7CiAgICAvLy8gVGhlIHRyYW5zYWN0aW9uIHJhbmdlIHRvIGV4ZWN1dGUuCiAgICBwdWIgdHhfcmFuZ2U6IFJhbmdlPFR4TnVtYmVyPiwKICAgIC8vLyBUaGUgYmxvY2sgcmFuZ2UgdG8gZXhlY3V0ZS4KICAgIHB1YiBibG9ja19yYW5nZTogUmFuZ2VJbmNsdXNpdmU8QmxvY2tOdW1iZXI+LAogICAgLy8vIFdoZXRoZXIgdGhpcyBpcyB0aGUgZmluYWwgcmFuZ2UgdG8gZXhlY3V0ZS4KICAgIHB1YiBpc19maW5hbF9yYW5nZTogYm9vbCwKfQoKaW1wbCBFeGVjSW5wdXQgewogICAgLy8vIFJldHVybiB0aGUgY2hlY2twb2ludCBvZiB0aGUgc3RhZ2Ugb3IgZGVmYXVsdC4KICAgIHB1YiBmbiBjaGVja3BvaW50KCZzZWxmKSAtPiBTdGFnZUNoZWNrcG9pbnQgewogICAgICAgIHNlbGYuY2hlY2twb2ludC51bndyYXBfb3JfZGVmYXVsdCgpCiAgICB9CgogICAgLy8vIFJldHVybiB0aGUgbmV4dCBibG9jayBudW1iZXIgYWZ0ZXIgdGhlIGN1cnJlbnQKICAgIC8vLyArMSBpcyBuZWVkZWQgdG8gc2tpcCB0aGUgcHJlc2VudCBibG9jayBhbmQgYWx3YXlzIHN0YXJ0IGZyb20gYmxvY2sgbnVtYmVyIDEsIG5vdCAwLgogICAgcHViIGZuIG5leHRfYmxvY2soJnNlbGYpIC0+IEJsb2NrTnVtYmVyIHsKICAgICAgICBsZXQgY3VycmVudF9ibG9jayA9IHNlbGYuY2hlY2twb2ludCgpOwogICAgICAgIGN1cnJlbnRfYmxvY2suYmxvY2tfbnVtYmVyICsgMQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFyZ2V0IGJsb2NrIG51bWJlciBoYXMgYWxyZWFkeSBiZWVuIHJlYWNoZWQuCiAgICBwdWIgZm4gdGFyZ2V0X3JlYWNoZWQoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIHNlbGYuY2hlY2twb2ludCgpLmJsb2NrX251bWJlciA+PSBzZWxmLnRhcmdldCgpCiAgICB9CgogICAgLy8vIFJldHVybiB0aGUgdGFyZ2V0IGJsb2NrIG51bWJlciBvciBkZWZhdWx0LgogICAgcHViIGZuIHRhcmdldCgmc2VsZikgLT4gQmxvY2tOdW1iZXIgewogICAgICAgIHNlbGYudGFyZ2V0LnVud3JhcF9vcl9kZWZhdWx0KCkKICAgIH0KCiAgICAvLy8gUmV0dXJuIG5leHQgYmxvY2sgcmFuZ2UgdGhhdCBuZWVkcyB0byBiZSBleGVjdXRlZC4KICAgIHB1YiBmbiBuZXh0X2Jsb2NrX3JhbmdlKCZzZWxmKSAtPiBSYW5nZUluY2x1c2l2ZTxCbG9ja051bWJlcj4gewogICAgICAgIHNlbGYubmV4dF9ibG9ja19yYW5nZV93aXRoX3RocmVzaG9sZCh1NjQ6Ok1BWCkuYmxvY2tfcmFuZ2UKICAgIH0KCiAgICAvLy8gUmV0dXJuIHRydWUgaWYgdGhpcyBpcyB0aGUgZmlyc3QgYmxvY2sgcmFuZ2UgdG8gZXhlY3V0ZS4KICAgIHB1YiBjb25zdCBmbiBpc19maXJzdF9yYW5nZSgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgc2VsZi5jaGVja3BvaW50LmlzX25vbmUoKQogICAgfQoKICAgIC8vLyBSZXR1cm4gdGhlIG5leHQgYmxvY2sgcmFuZ2UgdG8gZXhlY3V0ZS4KICAgIHB1YiBmbiBuZXh0X2Jsb2NrX3JhbmdlX3dpdGhfdGhyZXNob2xkKCZzZWxmLCB0aHJlc2hvbGQ6IHU2NCkgLT4gQmxvY2tSYW5nZU91dHB1dCB7CiAgICAgICAgbGV0IGN1cnJlbnRfYmxvY2sgPSBzZWxmLmNoZWNrcG9pbnQoKTsKICAgICAgICBsZXQgc3RhcnQgPSBjdXJyZW50X2Jsb2NrLmJsb2NrX251bWJlciArIDE7CiAgICAgICAgbGV0IHRhcmdldCA9IHNlbGYudGFyZ2V0KCk7CgogICAgICAgIGxldCBlbmQgPSBtaW4odGFyZ2V0LCBjdXJyZW50X2Jsb2NrLmJsb2NrX251bWJlci5zYXR1cmF0aW5nX2FkZCh0aHJlc2hvbGQpKTsKCiAgICAgICAgbGV0IGlzX2ZpbmFsX3JhbmdlID0gZW5kID09IHRhcmdldDsKICAgICAgICBCbG9ja1JhbmdlT3V0cHV0IHsgYmxvY2tfcmFuZ2U6IHN0YXJ0Li49ZW5kLCBpc19maW5hbF9yYW5nZSB9CiAgICB9CgogICAgLy8vIFJldHVybiB0aGUgbmV4dCBibG9jayByYW5nZSBkZXRlcm1pbmVkIHRoZSBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIHdpdGhpbiBpdC4KICAgIC8vLyBUaGlzIGZ1bmN0aW9uIHdhbGtzIHRoZSBibG9jayBpbmRpY2VzIHVudGlsIGVpdGhlciB0aGUgZW5kIG9mIHRoZSByYW5nZSBpcyByZWFjaGVkIG9yCiAgICAvLy8gdGhlIG51bWJlciBvZiB0cmFuc2FjdGlvbnMgZXhjZWVkcyB0aGUgdGhyZXNob2xkLgogICAgLy8vCiAgICAvLy8gUmV0dXJucyBbYE5vbmVgXSBpZiBubyB0cmFuc2FjdGlvbnMgYXJlIGZvdW5kIGZvciB0aGUgY3VycmVudCBleGVjdXRpb24gaW5wdXQuCiAgICAjW2luc3RydW1lbnQobGV2ZWwgPSAiZGVidWciLCB0YXJnZXQgPSAic3luYzo6c3RhZ2VzIiwgc2tpcChwcm92aWRlciksIHJldCldCiAgICBwdWIgZm4gbmV4dF9ibG9ja19yYW5nZV93aXRoX3RyYW5zYWN0aW9uX3RocmVzaG9sZDxQcm92aWRlcj4oCiAgICAgICAgJnNlbGYsCiAgICAgICAgcHJvdmlkZXI6ICZQcm92aWRlciwKICAgICAgICB0eF90aHJlc2hvbGQ6IHU2NCwKICAgICkgLT4gUmVzdWx0PE9wdGlvbjxUcmFuc2FjdGlvblJhbmdlT3V0cHV0PiwgU3RhZ2VFcnJvcj4KICAgIHdoZXJlCiAgICAgICAgUHJvdmlkZXI6IFN0YXRpY0ZpbGVQcm92aWRlckZhY3RvcnkgKyBCbG9ja1JlYWRlciwKICAgIHsKICAgICAgICAvLyBHZXQgbG93ZXN0IGF2YWlsYWJsZSBibG9jayBudW1iZXIgZm9yIHRyYW5zYWN0aW9ucwogICAgICAgIGxldCBTb21lKGxvd2VzdF90cmFuc2FjdGlvbnNfYmxvY2spID0KICAgICAgICAgICAgcHJvdmlkZXIuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKS5nZXRfbG93ZXN0X3JhbmdlX3N0YXJ0KFN0YXRpY0ZpbGVTZWdtZW50OjpUcmFuc2FjdGlvbnMpCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBPayhOb25lKQogICAgICAgIH07CgogICAgICAgIC8vIFdlIGNhbiBvbmx5IHByb2Nlc3MgdHJhbnNhY3Rpb25zIHRoYXQgaGF2ZSBhc3NvY2lhdGVkIHN0YXRpYyBmaWxlcywgc28gd2UgY2FwIHRoZSBzdGFydAogICAgICAgIC8vIGJsb2NrIGJ5IGxvd2VzdCBhdmFpbGFibGUgYmxvY2sgbnVtYmVyLgogICAgICAgIC8vCiAgICAgICAgLy8gQ2VydGFpbiB0cmFuc2FjdGlvbnMgbWF5IG5vdCBoYXZlIGFzc29jaWF0ZWQgc3RhdGljIGZpbGVzIHdoZW4gdXNlciBkZWxldGVzIHRoZW0KICAgICAgICAvLyBtYW51YWxseS4gSW4gdGhhdCBjYXNlLCB3ZSBjYW4ndCBwcm9jZXNzIHRoZW0sIGFuZCBuZWVkIHRvIGFkanVzdCB0aGUgc3RhcnQgYmxvY2sKICAgICAgICAvLyBhY2NvcmRpbmdseS4KICAgICAgICBsZXQgc3RhcnRfYmxvY2sgPSBzZWxmLm5leHRfYmxvY2soKS5tYXgobG93ZXN0X3RyYW5zYWN0aW9uc19ibG9jayk7CiAgICAgICAgbGV0IHRhcmdldF9ibG9jayA9IHNlbGYudGFyZ2V0KCk7CgogICAgICAgIC8vIElmIHRoZSBzdGFydCBibG9jayBpcyBncmVhdGVyIHRoYW4gdGhlIHRhcmdldCwgdGhlbiB0aGVyZSdzIG5vIHRyYW5zYWN0aW9ucyB0byBwcm9jZXNzCiAgICAgICAgLy8gYW5kIHdlIHJldHVybiBlYXJseS4gSXQncyBwb3NzaWJsZSB0byB0cmlnZ2VyIHRoaXMgc2NlbmFyaW8gd2hlbiBydW5uaW5nIGByZXRoCiAgICAgICAgLy8gc3RhZ2UgcnVuYCBtYW51YWxseSBmb3IgYSByYW5nZSBvZiB0cmFuc2FjdGlvbnMgdGhhdCBkb2Vzbid0IGV4aXN0LgogICAgICAgIGlmIHN0YXJ0X2Jsb2NrID4gdGFyZ2V0X2Jsb2NrIHsKICAgICAgICAgICAgcmV0dXJuIE9rKE5vbmUpCiAgICAgICAgfQoKICAgICAgICBsZXQgc3RhcnRfYmxvY2tfYm9keSA9IHByb3ZpZGVyCiAgICAgICAgICAgIC5ibG9ja19ib2R5X2luZGljZXMoc3RhcnRfYmxvY2spPwogICAgICAgICAgICAub2tfb3IoUHJvdmlkZXJFcnJvcjo6QmxvY2tCb2R5SW5kaWNlc05vdEZvdW5kKHN0YXJ0X2Jsb2NrKSk/OwogICAgICAgIGxldCBmaXJzdF90eF9udW0gPSBzdGFydF9ibG9ja19ib2R5LmZpcnN0X3R4X251bSgpOwoKICAgICAgICBsZXQgdGFyZ2V0X2Jsb2NrX2JvZHkgPSBwcm92aWRlcgogICAgICAgICAgICAuYmxvY2tfYm9keV9pbmRpY2VzKHRhcmdldF9ibG9jayk/CiAgICAgICAgICAgIC5va19vcihQcm92aWRlckVycm9yOjpCbG9ja0JvZHlJbmRpY2VzTm90Rm91bmQodGFyZ2V0X2Jsb2NrKSk/OwoKICAgICAgICAvLyBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIGxlZnQgdG8gZXhlY3V0ZS4KICAgICAgICBsZXQgYWxsX3R4X2NudCA9IHRhcmdldF9ibG9ja19ib2R5Lm5leHRfdHhfbnVtKCkgLSBmaXJzdF90eF9udW07CgogICAgICAgIGlmIGFsbF90eF9jbnQgPT0gMCB7CiAgICAgICAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIG1vcmUgdHJhbnNhY3Rpb24gcmV0dXJuIGJhY2suCiAgICAgICAgICAgIHJldHVybiBPayhOb25lKQogICAgICAgIH0KCiAgICAgICAgLy8gZ2V0IGJsb2NrIG9mIHRoaXMgdHgKICAgICAgICBsZXQgKGVuZF9ibG9jaywgaXNfZmluYWxfcmFuZ2UsIG5leHRfdHhfbnVtKSA9IGlmIGFsbF90eF9jbnQgPD0gdHhfdGhyZXNob2xkIHsKICAgICAgICAgICAgKHRhcmdldF9ibG9jaywgdHJ1ZSwgdGFyZ2V0X2Jsb2NrX2JvZHkubmV4dF90eF9udW0oKSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBnZXQgdHggYmxvY2sgbnVtYmVyLiBuZXh0X3R4X251bSBpbiB0aGlzIGNhc2Ugd2lsbCBiZSBsZXNzIHRoYW4gYWxsX3R4X2NudC4KICAgICAgICAgICAgLy8gU28gd2UgYXJlIHN1cmUgdGhhdCB0cmFuc2FjdGlvbiBtdXN0IGV4aXN0LgogICAgICAgICAgICBsZXQgZW5kX2Jsb2NrX251bWJlciA9IHByb3ZpZGVyCiAgICAgICAgICAgICAgICAuYmxvY2tfYnlfdHJhbnNhY3Rpb25faWQoZmlyc3RfdHhfbnVtICsgdHhfdGhyZXNob2xkKT8KICAgICAgICAgICAgICAgIC5leHBlY3QoImJsb2NrIG9mIHR4IG11c3QgZXhpc3QiKTsKICAgICAgICAgICAgLy8gd2Ugd2FudCB0byBnZXQgcmFuZ2Ugb2YgYWxsIHRyYW5zYWN0aW9ucyBvZiB0aGlzIGJsb2NrLCBzbyB3ZSBhcmUgZmV0Y2hpbmcgYmxvY2sKICAgICAgICAgICAgLy8gYm9keS4KICAgICAgICAgICAgbGV0IGVuZF9ibG9ja19ib2R5ID0gcHJvdmlkZXIKICAgICAgICAgICAgICAgIC5ibG9ja19ib2R5X2luZGljZXMoZW5kX2Jsb2NrX251bWJlcik/CiAgICAgICAgICAgICAgICAub2tfb3IoUHJvdmlkZXJFcnJvcjo6QmxvY2tCb2R5SW5kaWNlc05vdEZvdW5kKGVuZF9ibG9ja19udW1iZXIpKT87CiAgICAgICAgICAgIChlbmRfYmxvY2tfbnVtYmVyLCBmYWxzZSwgZW5kX2Jsb2NrX2JvZHkubmV4dF90eF9udW0oKSkKICAgICAgICB9OwoKICAgICAgICBsZXQgdHhfcmFuZ2UgPSBmaXJzdF90eF9udW0uLm5leHRfdHhfbnVtOwogICAgICAgIE9rKFNvbWUoVHJhbnNhY3Rpb25SYW5nZU91dHB1dCB7CiAgICAgICAgICAgIHR4X3JhbmdlLAogICAgICAgICAgICBibG9ja19yYW5nZTogc3RhcnRfYmxvY2suLj1lbmRfYmxvY2ssCiAgICAgICAgICAgIGlzX2ZpbmFsX3JhbmdlLAogICAgICAgIH0pKQogICAgfQp9CgovLy8gU3RhZ2UgdW53aW5kIGlucHV0LCBzZWUgW2BTdGFnZTo6dW53aW5kYF0uCiNbZGVyaXZlKERlYnVnLCBEZWZhdWx0LCBQYXJ0aWFsRXEsIEVxLCBDbG9uZSwgQ29weSldCnB1YiBzdHJ1Y3QgVW53aW5kSW5wdXQgewogICAgLy8vIFRoZSBjdXJyZW50IGhpZ2hlc3QgY2hlY2twb2ludCBvZiB0aGUgc3RhZ2UuCiAgICBwdWIgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50LAogICAgLy8vIFRoZSBibG9jayB0byB1bndpbmQgdG8uCiAgICBwdWIgdW53aW5kX3RvOiBCbG9ja051bWJlciwKICAgIC8vLyBUaGUgYmFkIGJsb2NrIHRoYXQgY2F1c2VkIHRoZSB1bndpbmQsIGlmIGFueS4KICAgIHB1YiBiYWRfYmxvY2s6IE9wdGlvbjxCbG9ja051bWJlcj4sCn0KCmltcGwgVW53aW5kSW5wdXQgewogICAgLy8vIFJldHVybiBuZXh0IGJsb2NrIHJhbmdlIHRoYXQgbmVlZHMgdG8gYmUgdW53b3VuZC4KICAgIHB1YiBmbiB1bndpbmRfYmxvY2tfcmFuZ2UoJnNlbGYpIC0+IFJhbmdlSW5jbHVzaXZlPEJsb2NrTnVtYmVyPiB7CiAgICAgICAgc2VsZi51bndpbmRfYmxvY2tfcmFuZ2Vfd2l0aF90aHJlc2hvbGQodTY0OjpNQVgpLjAKICAgIH0KCiAgICAvLy8gUmV0dXJuIHRoZSBuZXh0IGJsb2NrIHJhbmdlIHRvIHVud2luZCBhbmQgdGhlIGJsb2NrIHdlJ3JlIHVud2luZGluZyB0by4KICAgIHB1YiBmbiB1bndpbmRfYmxvY2tfcmFuZ2Vfd2l0aF90aHJlc2hvbGQoCiAgICAgICAgJnNlbGYsCiAgICAgICAgdGhyZXNob2xkOiB1NjQsCiAgICApIC0+IChSYW5nZUluY2x1c2l2ZTxCbG9ja051bWJlcj4sIEJsb2NrTnVtYmVyLCBib29sKSB7CiAgICAgICAgLy8gKzEgaXMgdG8gc2tpcCB0aGUgYmxvY2sgd2UncmUgdW53aW5kaW5nIHRvCiAgICAgICAgbGV0IG11dCBzdGFydCA9IHNlbGYudW53aW5kX3RvICsgMTsKICAgICAgICBsZXQgZW5kID0gc2VsZi5jaGVja3BvaW50OwoKICAgICAgICBzdGFydCA9IG1heChzdGFydCwgZW5kLmJsb2NrX251bWJlci5zYXR1cmF0aW5nX3N1Yih0aHJlc2hvbGQpKTsKCiAgICAgICAgbGV0IHVud2luZF90byA9IHN0YXJ0IC0gMTsKCiAgICAgICAgbGV0IGlzX2ZpbmFsX3JhbmdlID0gdW53aW5kX3RvID09IHNlbGYudW53aW5kX3RvOwogICAgICAgIChzdGFydC4uPWVuZC5ibG9ja19udW1iZXIsIHVud2luZF90bywgaXNfZmluYWxfcmFuZ2UpCiAgICB9Cn0KCi8vLyBUaGUgb3V0cHV0IG9mIGEgc3RhZ2UgZXhlY3V0aW9uLgojW2Rlcml2ZShEZWJ1ZywgUGFydGlhbEVxLCBFcSwgQ2xvbmUpXQpwdWIgc3RydWN0IEV4ZWNPdXRwdXQgewogICAgLy8vIEhvdyBmYXIgdGhlIHN0YWdlIGdvdC4KICAgIHB1YiBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQsCiAgICAvLy8gV2hldGhlciBvciBub3QgdGhlIHN0YWdlIGlzIGRvbmUuCiAgICBwdWIgZG9uZTogYm9vbCwKfQoKaW1wbCBFeGVjT3V0cHV0IHsKICAgIC8vLyBNYXJrIHRoZSBzdGFnZSBhcyBub3QgZG9uZSwgY2hlY2twb2ludGluZyBhdCB0aGUgZ2l2ZW4gcGxhY2UuCiAgICBwdWIgY29uc3QgZm4gaW5fcHJvZ3Jlc3MoY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50KSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgY2hlY2twb2ludCwgZG9uZTogZmFsc2UgfQogICAgfQoKICAgIC8vLyBNYXJrIHRoZSBzdGFnZSBhcyBkb25lLCBjaGVja3BvaW50aW5nIGF0IHRoZSBnaXZlbiBwbGFjZS4KICAgIHB1YiBjb25zdCBmbiBkb25lKGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGNoZWNrcG9pbnQsIGRvbmU6IHRydWUgfQogICAgfQp9CgovLy8gVGhlIG91dHB1dCBvZiBhIHN0YWdlIHVud2luZGluZy4KI1tkZXJpdmUoRGVidWcsIFBhcnRpYWxFcSwgRXEsIENsb25lKV0KcHViIHN0cnVjdCBVbndpbmRPdXRwdXQgewogICAgLy8vIFRoZSBjaGVja3BvaW50IGF0IHdoaWNoIHRoZSBzdGFnZSBoYXMgdW53b3VuZCB0by4KICAgIHB1YiBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQsCn0KCi8vLyBBIHN0YWdlIGlzIGEgc2VnbWVudGVkIHBhcnQgb2YgdGhlIHN5bmNpbmcgcHJvY2VzcyBvZiB0aGUgbm9kZS4KLy8vCi8vLyBFYWNoIHN0YWdlIHRha2VzIGNhcmUgb2YgYSB3ZWxsLWRlZmluZWQgdGFzaywgc3VjaCBhcyBkb3dubG9hZGluZyBoZWFkZXJzIG9yIGV4ZWN1dGluZwovLy8gdHJhbnNhY3Rpb25zLCBhbmQgcGVyc2lzdCB0aGVpciByZXN1bHRzIHRvIGEgZGF0YWJhc2UuCi8vLwovLy8gU3RhZ2VzIG11c3QgaGF2ZSBhIHVuaXF1ZSBbSURdW1N0YWdlSWRdIGFuZCBpbXBsZW1lbnQgYSB3YXkgdG8gInJvbGwgZm9yd2FyZHMiCi8vLyAoW2BTdGFnZTo6ZXhlY3V0ZWBdKSBhbmQgYSB3YXkgdG8gInJvbGwgYmFjayIgKFtgU3RhZ2U6OnVud2luZGBdKS4KLy8vCi8vLyBTdGFnZXMgYXJlIGV4ZWN1dGVkIGFzIHBhcnQgb2YgYSBwaXBlbGluZSB3aGVyZSB0aGV5IGFyZSBleGVjdXRlZCBzZXJpYWxseS4KLy8vCi8vLyBTdGFnZXMgcmVjZWl2ZSBbYERCUHJvdmlkZXJgXShyZXRoX3Byb3ZpZGVyOjpEQlByb3ZpZGVyKS4KI1thdXRvX2ltcGw6OmF1dG9faW1wbChCb3gpXQpwdWIgdHJhaXQgU3RhZ2U8UHJvdmlkZXI+OiBTZW5kIHsKICAgIC8vLyBHZXQgdGhlIElEIG9mIHRoZSBzdGFnZS4KICAgIC8vLwogICAgLy8vIFN0YWdlIElEcyBtdXN0IGJlIHVuaXF1ZS4KICAgIGZuIGlkKCZzZWxmKSAtPiBTdGFnZUlkOwoKICAgIC8vLyBSZXR1cm5zIGBQb2xsOjpSZWFkeShPaygoKSkpYCB3aGVuIHRoZSBzdGFnZSBpcyByZWFkeSB0byBleGVjdXRlIHRoZSBnaXZlbiByYW5nZS4KICAgIC8vLwogICAgLy8vIFRoaXMgbWV0aG9kIGlzIGhlYXZpbHkgaW5zcGlyZWQgYnkgW3Rvd2VyXShodHRwczovL2NyYXRlcy5pby9jcmF0ZXMvdG93ZXIpJ3MgYFNlcnZpY2VgIHRyYWl0LgogICAgLy8vIEFueSBhc3luY2hyb25vdXMgdGFza3Mgb3IgY29tbXVuaWNhdGlvbiBzaG91bGQgYmUgaGFuZGxlZCBpbiBgcG9sbF9leGVjdXRlX3JlYWR5YCwgZS5nLgogICAgLy8vIG1vdmluZyBkb3dubG9hZGVkIGl0ZW1zIGZyb20gZG93bmxvYWRlcnMgdG8gYW4gaW50ZXJuYWwgYnVmZmVyIGluIHRoZSBzdGFnZS4KICAgIC8vLwogICAgLy8vIElmIHRoZSBzdGFnZSBoYXMgYW55IHBlbmRpbmcgZXh0ZXJuYWwgc3RhdGUsIHRoZW4gYFBvbGw6OlBlbmRpbmdgIGlzIHJldHVybmVkLgogICAgLy8vCiAgICAvLy8gSWYgYFBvbGw6OlJlYWR5KEVycihfKSlgIGlzIHJldHVybmVkLCB0aGUgc3RhZ2UgbWF5IG5vdCBiZSBhYmxlIHRvIGV4ZWN1dGUgYW55bW9yZQogICAgLy8vIGRlcGVuZGluZyBvbiB0aGUgc3BlY2lmaWMgZXJyb3IuIEluIHRoYXQgY2FzZSwgYW4gdW53aW5kIG11c3QgYmUgaXNzdWVkIGluc3RlYWQuCiAgICAvLy8KICAgIC8vLyBPbmNlIGBQb2xsOjpSZWFkeShPaygoKSkpYCBpcyByZXR1cm5lZCwgdGhlIHN0YWdlIG1heSBiZSBleGVjdXRlZCBvbmNlIHVzaW5nIGBleGVjdXRlYC4KICAgIC8vLyBVbnRpbCB0aGUgc3RhZ2UgaGFzIGJlZW4gZXhlY3V0ZWQsIHJlcGVhdGVkIGNhbGxzIHRvIGBwb2xsX2V4ZWN1dGVfcmVhZHlgIG11c3QgcmV0dXJuIGVpdGhlcgogICAgLy8vIGBQb2xsOjpSZWFkeShPaygoKSkpYCBvciBgUG9sbDo6UmVhZHkoRXJyKF8pKWAuCiAgICAvLy8KICAgIC8vLyBOb3RlIHRoYXQgYHBvbGxfZXhlY3V0ZV9yZWFkeWAgbWF5IHJlc2VydmUgc2hhcmVkIHJlc291cmNlcyB0aGF0IGFyZSBjb25zdW1lZCBpbiBhCiAgICAvLy8gc3Vic2VxdWVudCBjYWxsIG9mIGBleGVjdXRlYCwgZS5nLiBpbnRlcm5hbCBidWZmZXJzLiBJdCBpcyBjcnVjaWFsIGZvciBpbXBsZW1lbnRhdGlvbnMKICAgIC8vLyB0byBub3QgYXNzdW1lIHRoYXQgYGV4ZWN1dGVgIHdpbGwgYWx3YXlzIGJlIGludm9rZWQgYW5kIHRvIGVuc3VyZSB0aGF0IHRob3NlIHJlc291cmNlcwogICAgLy8vIGFyZSBhcHByb3ByaWF0ZWx5IHJlbGVhc2VkIGlmIHRoZSBzdGFnZSBpcyBkcm9wcGVkIGJlZm9yZSBgZXhlY3V0ZWAgaXMgY2FsbGVkLgogICAgLy8vCiAgICAvLy8gRm9yIHRoZSBzYW1lIHJlYXNvbiwgaXQgaXMgYWxzbyBpbXBvcnRhbnQgdGhhdCBhbnkgc2hhcmVkIHJlc291cmNlcyBkbyBub3QgZXhoaWJpdAogICAgLy8vIHVuYm91bmRlZCBncm93dGggb24gcmVwZWF0ZWQgY2FsbHMgdG8gYHBvbGxfZXhlY3V0ZV9yZWFkeWAuCiAgICAvLy8KICAgIC8vLyBVbndpbmRzIG1heSBoYXBwZW4gd2l0aG91dCBjb25zdWx0aW5nIGBwb2xsX2V4ZWN1dGVfcmVhZHlgIGZpcnN0LgogICAgZm4gcG9sbF9leGVjdXRlX3JlYWR5KAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBfY3g6ICZtdXQgQ29udGV4dDwnXz4sCiAgICAgICAgX2lucHV0OiBFeGVjSW5wdXQsCiAgICApIC0+IFBvbGw8UmVzdWx0PCgpLCBTdGFnZUVycm9yPj4gewogICAgICAgIFBvbGw6OlJlYWR5KE9rKCgpKSkKICAgIH0KCiAgICAvLy8gRXhlY3V0ZSB0aGUgc3RhZ2UuCiAgICAvLy8gSXQgaXMgZXhwZWN0ZWQgdGhhdCB0aGUgc3RhZ2Ugd2lsbCB3cml0ZSBhbGwgbmVjZXNzYXJ5IGRhdGEgdG8gdGhlIGRhdGFiYXNlCiAgICAvLy8gdXBvbiBpbnZva2luZyB0aGlzIG1ldGhvZC4KICAgIGZuIGV4ZWN1dGUoJm11dCBzZWxmLCBwcm92aWRlcjogJlByb3ZpZGVyLCBpbnB1dDogRXhlY0lucHV0KSAtPiBSZXN1bHQ8RXhlY091dHB1dCwgU3RhZ2VFcnJvcj47CgogICAgLy8vIFBvc3QgZXhlY3V0aW9uIGNvbW1pdCBob29rLgogICAgLy8vCiAgICAvLy8gVGhpcyBpcyBjYWxsZWQgYWZ0ZXIgdGhlIHN0YWdlIGhhcyBiZWVuIGV4ZWN1dGVkIGFuZCB0aGUgZGF0YSBoYXMgYmVlbiBjb21taXR0ZWQgYnkgdGhlCiAgICAvLy8gcHJvdmlkZXIuIFRoZSBzdGFnZSBtYXkgd2FudCB0byBwYXNzIHNvbWUgZGF0YSBmcm9tIFtgU2VsZjo6ZXhlY3V0ZWBdIHZpYSB0aGUgaW50ZXJuYWwKICAgIC8vLyBmaWVsZC4KICAgIGZuIHBvc3RfZXhlY3V0ZV9jb21taXQoJm11dCBzZWxmKSAtPiBSZXN1bHQ8KCksIFN0YWdlRXJyb3I+IHsKICAgICAgICBPaygoKSkKICAgIH0KCiAgICAvLy8gVW53aW5kIHRoZSBzdGFnZS4KICAgIGZuIHVud2luZCgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgcHJvdmlkZXI6ICZQcm92aWRlciwKICAgICAgICBpbnB1dDogVW53aW5kSW5wdXQsCiAgICApIC0+IFJlc3VsdDxVbndpbmRPdXRwdXQsIFN0YWdlRXJyb3I+OwoKICAgIC8vLyBQb3N0IHVud2luZCBjb21taXQgaG9vay4KICAgIC8vLwogICAgLy8vIFRoaXMgaXMgY2FsbGVkIGFmdGVyIHRoZSBzdGFnZSBoYXMgYmVlbiB1bndvdW5kIGFuZCB0aGUgZGF0YSBoYXMgYmVlbiBjb21taXR0ZWQgYnkgdGhlCiAgICAvLy8gcHJvdmlkZXIuIFRoZSBzdGFnZSBtYXkgd2FudCB0byBwYXNzIHNvbWUgZGF0YSBmcm9tIFtgU2VsZjo6dW53aW5kYF0gdmlhIHRoZSBpbnRlcm5hbAogICAgLy8vIGZpZWxkLgogICAgZm4gcG9zdF91bndpbmRfY29tbWl0KCZtdXQgc2VsZikgLT4gUmVzdWx0PCgpLCBTdGFnZUVycm9yPiB7CiAgICAgICAgT2soKCkpCiAgICB9Cn0KCi8vLyBbU3RhZ2VdIHRyYWl0IGV4dGVuc2lvbi4KcHViIHRyYWl0IFN0YWdlRXh0PFByb3ZpZGVyPjogU3RhZ2U8UHJvdmlkZXI+IHsKICAgIC8vLyBVdGlsaXR5IGV4dGVuc2lvbiBmb3IgdGhlIGBTdGFnZWAgdHJhaXQgdGhhdCBpbnZva2VzIGBTdGFnZTo6cG9sbF9leGVjdXRlX3JlYWR5YAogICAgLy8vIHdpdGggW2Bwb2xsX2ZuYF0gY29udGV4dC4gRm9yIG1vcmUgaW5mb3JtYXRpb24gc2VlIFtgU3RhZ2U6OnBvbGxfZXhlY3V0ZV9yZWFkeWBdLgogICAgZm4gZXhlY3V0ZV9yZWFkeSgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgaW5wdXQ6IEV4ZWNJbnB1dCwKICAgICkgLT4gaW1wbCBGdXR1cmU8T3V0cHV0ID0gUmVzdWx0PCgpLCBTdGFnZUVycm9yPj4gKyBTZW5kIHsKICAgICAgICBwb2xsX2ZuKG1vdmUgfGN4fCBzZWxmLnBvbGxfZXhlY3V0ZV9yZWFkeShjeCwgaW5wdXQpKQogICAgfQp9CgppbXBsPFByb3ZpZGVyLCBTOiBTdGFnZTxQcm92aWRlcj4gKyA/U2l6ZWQ+IFN0YWdlRXh0PFByb3ZpZGVyPiBmb3IgUyB7fQoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2UgcmV0aF9jaGFpbnNwZWM6Ok1BSU5ORVQ7CiAgICB1c2UgcmV0aF9kYjo6dGVzdF91dGlsczo6ewogICAgICAgIGNyZWF0ZV90ZXN0X3JvY2tzZGJfZGlyLCBjcmVhdGVfdGVzdF9yd19kYiwgY3JlYXRlX3Rlc3Rfc3RhdGljX2ZpbGVzX2RpciwKICAgIH07CiAgICB1c2UgcmV0aF9kYl9hcGk6Onttb2RlbHM6OlN0b3JlZEJsb2NrQm9keUluZGljZXMsIHRhYmxlcywgdHJhbnNhY3Rpb246OkRiVHhNdXR9OwogICAgdXNlIHJldGhfcHJvdmlkZXI6OnsKICAgICAgICBwcm92aWRlcnM6OlJvY2tzREJQcm92aWRlciwgdGVzdF91dGlsczo6TW9ja05vZGVUeXBlc1dpdGhEQiwgUHJvdmlkZXJGYWN0b3J5LAogICAgICAgIFN0YXRpY0ZpbGVQcm92aWRlckJ1aWxkZXIsIFN0YXRpY0ZpbGVQcm92aWRlckZhY3RvcnksIFN0YXRpY0ZpbGVTZWdtZW50LAogICAgfTsKICAgIHVzZSByZXRoX3N0YWdlc190eXBlczo6U3RhZ2VDaGVja3BvaW50OwogICAgdXNlIHJldGhfdGVzdGluZ191dGlsczo6Z2VuZXJhdG9yczo6e3NlbGYsIHJhbmRvbV9zaWduZWRfdHh9OwoKICAgIHVzZSBjcmF0ZTo6RXhlY0lucHV0OwoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfZXhlY19pbnB1dF9uZXh0X2Jsb2NrX3JhbmdlX3dpdGhfdHJhbnNhY3Rpb25fdGhyZXNob2xkKCkgewogICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CiAgICAgICAgbGV0IHByb3ZpZGVyX2ZhY3RvcnkgPSBQcm92aWRlckZhY3Rvcnk6OjxNb2NrTm9kZVR5cGVzV2l0aERCPjo6bmV3KAogICAgICAgICAgICBjcmVhdGVfdGVzdF9yd19kYigpLAogICAgICAgICAgICBNQUlOTkVULmNsb25lKCksCiAgICAgICAgICAgIFN0YXRpY0ZpbGVQcm92aWRlckJ1aWxkZXI6OnJlYWRfd3JpdGUoY3JlYXRlX3Rlc3Rfc3RhdGljX2ZpbGVzX2RpcigpLjAua2VlcCgpKQogICAgICAgICAgICAgICAgLndpdGhfYmxvY2tzX3Blcl9maWxlKDEpCiAgICAgICAgICAgICAgICAuYnVpbGQoKQogICAgICAgICAgICAgICAgLnVud3JhcCgpLAogICAgICAgICAgICBSb2Nrc0RCUHJvdmlkZXI6OmJ1aWxkZXIoY3JlYXRlX3Rlc3Rfcm9ja3NkYl9kaXIoKS4wLmtlZXAoKSkuYnVpbGQoKS51bndyYXAoKSwKICAgICAgICApCiAgICAgICAgLnVud3JhcCgpOwoKICAgICAgICAvLyBXaXRob3V0IGNoZWNrcG9pbnQsIHdpdGhvdXQgdHJhbnNhY3Rpb25zIGluIHN0YXRpYyBmaWxlcwogICAgICAgIHsKICAgICAgICAgICAgbGV0IGV4ZWNfaW5wdXQgPSBFeGVjSW5wdXQgeyB0YXJnZXQ6IFNvbWUoMTAwKSwgY2hlY2twb2ludDogTm9uZSB9OwoKICAgICAgICAgICAgbGV0IHJhbmdlX291dHB1dCA9IGV4ZWNfaW5wdXQKICAgICAgICAgICAgICAgIC5uZXh0X2Jsb2NrX3JhbmdlX3dpdGhfdHJhbnNhY3Rpb25fdGhyZXNob2xkKCZwcm92aWRlcl9mYWN0b3J5LCAxMCkKICAgICAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICAgICAgYXNzZXJ0IShyYW5nZV9vdXRwdXQuaXNfbm9uZSgpKTsKICAgICAgICB9CgogICAgICAgIC8vIFdpdGggY2hlY2twb2ludCBhdCBibG9jayAxMCwgd2l0aG91dCB0cmFuc2FjdGlvbnMgaW4gc3RhdGljIGZpbGVzCiAgICAgICAgewogICAgICAgICAgICBsZXQgZXhlY19pbnB1dCA9CiAgICAgICAgICAgICAgICBFeGVjSW5wdXQgeyB0YXJnZXQ6IFNvbWUoMSksIGNoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VDaGVja3BvaW50OjpuZXcoMTApKSB9OwoKICAgICAgICAgICAgbGV0IHJhbmdlX291dHB1dCA9IGV4ZWNfaW5wdXQKICAgICAgICAgICAgICAgIC5uZXh0X2Jsb2NrX3JhbmdlX3dpdGhfdHJhbnNhY3Rpb25fdGhyZXNob2xkKCZwcm92aWRlcl9mYWN0b3J5LCAxMCkKICAgICAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICAgICAgYXNzZXJ0IShyYW5nZV9vdXRwdXQuaXNfbm9uZSgpKTsKICAgICAgICB9CgogICAgICAgIC8vIFdpdGhvdXQgY2hlY2twb2ludCwgd2l0aCB0cmFuc2FjdGlvbnMgaW4gc3RhdGljIGZpbGVzIHN0YXJ0aW5nIGZyb20gYmxvY2sgMQogICAgICAgIHsKICAgICAgICAgICAgbGV0IGV4ZWNfaW5wdXQgPSBFeGVjSW5wdXQgeyB0YXJnZXQ6IFNvbWUoMSksIGNoZWNrcG9pbnQ6IE5vbmUgfTsKCiAgICAgICAgICAgIGxldCBtdXQgcHJvdmlkZXJfcncgPSBwcm92aWRlcl9mYWN0b3J5LnByb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgICAgIHByb3ZpZGVyX3J3CiAgICAgICAgICAgICAgICAudHhfbXV0KCkKICAgICAgICAgICAgICAgIC5wdXQ6Ojx0YWJsZXM6OkJsb2NrQm9keUluZGljZXM+KAogICAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgICAgU3RvcmVkQmxvY2tCb2R5SW5kaWNlcyB7IGZpcnN0X3R4X251bTogMCwgdHhfY291bnQ6IDIgfSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICAgICAgbGV0IG11dCB3cml0ZXIgPQogICAgICAgICAgICAgICAgcHJvdmlkZXJfcncuZ2V0X3N0YXRpY19maWxlX3dyaXRlcigwLCBTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25zKS51bndyYXAoKTsKICAgICAgICAgICAgd3JpdGVyLmluY3JlbWVudF9ibG9jaygwKS51bndyYXAoKTsKICAgICAgICAgICAgd3JpdGVyLmluY3JlbWVudF9ibG9jaygxKS51bndyYXAoKTsKICAgICAgICAgICAgd3JpdGVyLmFwcGVuZF90cmFuc2FjdGlvbigwLCAmcmFuZG9tX3NpZ25lZF90eCgmbXV0IHJuZykpLnVud3JhcCgpOwogICAgICAgICAgICB3cml0ZXIuYXBwZW5kX3RyYW5zYWN0aW9uKDEsICZyYW5kb21fc2lnbmVkX3R4KCZtdXQgcm5nKSkudW53cmFwKCk7CiAgICAgICAgICAgIGRyb3Aod3JpdGVyKTsKICAgICAgICAgICAgcHJvdmlkZXJfcncuY29tbWl0KCkudW53cmFwKCk7CgogICAgICAgICAgICBsZXQgcmFuZ2Vfb3V0cHV0ID0gZXhlY19pbnB1dAogICAgICAgICAgICAgICAgLm5leHRfYmxvY2tfcmFuZ2Vfd2l0aF90cmFuc2FjdGlvbl90aHJlc2hvbGQoJnByb3ZpZGVyX2ZhY3RvcnksIDEwKQogICAgICAgICAgICAgICAgLnVud3JhcCgpCiAgICAgICAgICAgICAgICAudW53cmFwKCk7CiAgICAgICAgICAgIGFzc2VydF9lcSEocmFuZ2Vfb3V0cHV0LnR4X3JhbmdlLCAwLi4yKTsKICAgICAgICAgICAgYXNzZXJ0X2VxIShyYW5nZV9vdXRwdXQuYmxvY2tfcmFuZ2UsIDEuLj0xKTsKICAgICAgICAgICAgYXNzZXJ0IShyYW5nZV9vdXRwdXQuaXNfZmluYWxfcmFuZ2UpOwogICAgICAgIH0KCiAgICAgICAgLy8gV2l0aCBjaGVja3BvaW50IGF0IGJsb2NrIDEsIHdpdGggdHJhbnNhY3Rpb25zIGluIHN0YXRpYyBmaWxlcyBzdGFydGluZyBmcm9tIGJsb2NrIDEKICAgICAgICB7CiAgICAgICAgICAgIGxldCBleGVjX2lucHV0ID0KICAgICAgICAgICAgICAgIEV4ZWNJbnB1dCB7IHRhcmdldDogU29tZSgyKSwgY2hlY2twb2ludDogU29tZShTdGFnZUNoZWNrcG9pbnQ6Om5ldygxKSkgfTsKCiAgICAgICAgICAgIGxldCBtdXQgcHJvdmlkZXJfcncgPSBwcm92aWRlcl9mYWN0b3J5LnByb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgICAgIHByb3ZpZGVyX3J3CiAgICAgICAgICAgICAgICAudHhfbXV0KCkKICAgICAgICAgICAgICAgIC5wdXQ6Ojx0YWJsZXM6OkJsb2NrQm9keUluZGljZXM+KAogICAgICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICAgICAgU3RvcmVkQmxvY2tCb2R5SW5kaWNlcyB7IGZpcnN0X3R4X251bTogMiwgdHhfY291bnQ6IDEgfSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICAgICAgbGV0IG11dCB3cml0ZXIgPQogICAgICAgICAgICAgICAgcHJvdmlkZXJfcncuZ2V0X3N0YXRpY19maWxlX3dyaXRlcigxLCBTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25zKS51bndyYXAoKTsKICAgICAgICAgICAgd3JpdGVyLmluY3JlbWVudF9ibG9jaygyKS51bndyYXAoKTsKICAgICAgICAgICAgd3JpdGVyLmFwcGVuZF90cmFuc2FjdGlvbigyLCAmcmFuZG9tX3NpZ25lZF90eCgmbXV0IHJuZykpLnVud3JhcCgpOwogICAgICAgICAgICBkcm9wKHdyaXRlcik7CiAgICAgICAgICAgIHByb3ZpZGVyX3J3LmNvbW1pdCgpLnVud3JhcCgpOwoKICAgICAgICAgICAgbGV0IHJhbmdlX291dHB1dCA9IGV4ZWNfaW5wdXQKICAgICAgICAgICAgICAgIC5uZXh0X2Jsb2NrX3JhbmdlX3dpdGhfdHJhbnNhY3Rpb25fdGhyZXNob2xkKCZwcm92aWRlcl9mYWN0b3J5LCAxMCkKICAgICAgICAgICAgICAgIC51bndyYXAoKQogICAgICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgICAgICBhc3NlcnRfZXEhKHJhbmdlX291dHB1dC50eF9yYW5nZSwgMi4uMyk7CiAgICAgICAgICAgIGFzc2VydF9lcSEocmFuZ2Vfb3V0cHV0LmJsb2NrX3JhbmdlLCAyLi49Mik7CiAgICAgICAgICAgIGFzc2VydCEocmFuZ2Vfb3V0cHV0LmlzX2ZpbmFsX3JhbmdlKTsKICAgICAgICB9CgogICAgICAgIC8vIFdpdGhvdXQgY2hlY2twb2ludCwgd2l0aCB0cmFuc2FjdGlvbnMgaW4gc3RhdGljIGZpbGVzIHN0YXJ0aW5nIGZyb20gYmxvY2sgMgogICAgICAgIHsKICAgICAgICAgICAgbGV0IGV4ZWNfaW5wdXQgPSBFeGVjSW5wdXQgeyB0YXJnZXQ6IFNvbWUoMiksIGNoZWNrcG9pbnQ6IE5vbmUgfTsKCiAgICAgICAgICAgIHByb3ZpZGVyX2ZhY3RvcnkKICAgICAgICAgICAgICAgIC5zdGF0aWNfZmlsZV9wcm92aWRlcigpCiAgICAgICAgICAgICAgICAuZGVsZXRlX2phcihTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25zLCAwKQogICAgICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgICAgICBwcm92aWRlcl9mYWN0b3J5CiAgICAgICAgICAgICAgICAuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKQogICAgICAgICAgICAgICAgLmRlbGV0ZV9qYXIoU3RhdGljRmlsZVNlZ21lbnQ6OlRyYW5zYWN0aW9ucywgMSkKICAgICAgICAgICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgICAgIGxldCByYW5nZV9vdXRwdXQgPSBleGVjX2lucHV0CiAgICAgICAgICAgICAgICAubmV4dF9ibG9ja19yYW5nZV93aXRoX3RyYW5zYWN0aW9uX3RocmVzaG9sZCgmcHJvdmlkZXJfZmFjdG9yeSwgMTApCiAgICAgICAgICAgICAgICAudW53cmFwKCkKICAgICAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICAgICAgYXNzZXJ0X2VxIShyYW5nZV9vdXRwdXQudHhfcmFuZ2UsIDIuLjMpOwogICAgICAgICAgICBhc3NlcnRfZXEhKHJhbmdlX291dHB1dC5ibG9ja19yYW5nZSwgMi4uPTIpOwogICAgICAgICAgICBhc3NlcnQhKHJhbmdlX291dHB1dC5pc19maW5hbF9yYW5nZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBXaXRob3V0IGNoZWNrcG9pbnQsIHdpdGggdHJhbnNhY3Rpb25zIGluIHN0YXRpYyBmaWxlcyBzdGFydGluZyBmcm9tIGJsb2NrIDIKICAgICAgICB7CiAgICAgICAgICAgIGxldCBleGVjX2lucHV0ID0KICAgICAgICAgICAgICAgIEV4ZWNJbnB1dCB7IHRhcmdldDogU29tZSgzKSwgY2hlY2twb2ludDogU29tZShTdGFnZUNoZWNrcG9pbnQ6Om5ldygyKSkgfTsKCiAgICAgICAgICAgIGxldCBtdXQgcHJvdmlkZXJfcncgPSBwcm92aWRlcl9mYWN0b3J5LnByb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgICAgIHByb3ZpZGVyX3J3CiAgICAgICAgICAgICAgICAudHhfbXV0KCkKICAgICAgICAgICAgICAgIC5wdXQ6Ojx0YWJsZXM6OkJsb2NrQm9keUluZGljZXM+KAogICAgICAgICAgICAgICAgICAgIDMsCiAgICAgICAgICAgICAgICAgICAgU3RvcmVkQmxvY2tCb2R5SW5kaWNlcyB7IGZpcnN0X3R4X251bTogMywgdHhfY291bnQ6IDEgfSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICAgICAgbGV0IG11dCB3cml0ZXIgPQogICAgICAgICAgICAgICAgcHJvdmlkZXJfcncuZ2V0X3N0YXRpY19maWxlX3dyaXRlcigxLCBTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25zKS51bndyYXAoKTsKICAgICAgICAgICAgd3JpdGVyLmluY3JlbWVudF9ibG9jaygzKS51bndyYXAoKTsKICAgICAgICAgICAgd3JpdGVyLmFwcGVuZF90cmFuc2FjdGlvbigzLCAmcmFuZG9tX3NpZ25lZF90eCgmbXV0IHJuZykpLnVud3JhcCgpOwogICAgICAgICAgICBkcm9wKHdyaXRlcik7CiAgICAgICAgICAgIHByb3ZpZGVyX3J3LmNvbW1pdCgpLnVud3JhcCgpOwoKICAgICAgICAgICAgbGV0IHJhbmdlX291dHB1dCA9IGV4ZWNfaW5wdXQKICAgICAgICAgICAgICAgIC5uZXh0X2Jsb2NrX3JhbmdlX3dpdGhfdHJhbnNhY3Rpb25fdGhyZXNob2xkKCZwcm92aWRlcl9mYWN0b3J5LCAxMCkKICAgICAgICAgICAgICAgIC51bndyYXAoKQogICAgICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgICAgICBhc3NlcnRfZXEhKHJhbmdlX291dHB1dC50eF9yYW5nZSwgMy4uNCk7CiAgICAgICAgICAgIGFzc2VydF9lcSEocmFuZ2Vfb3V0cHV0LmJsb2NrX3JhbmdlLCAzLi49Myk7CiAgICAgICAgICAgIGFzc2VydCEocmFuZ2Vfb3V0cHV0LmlzX2ZpbmFsX3JhbmdlKTsKICAgICAgICB9CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9hcGkvc3JjL3Rlc3RfdXRpbHMucnMiPgojIVthbGxvdyhtaXNzaW5nX2RvY3MpXQoKdXNlIGNyYXRlOjp7RXhlY0lucHV0LCBFeGVjT3V0cHV0LCBTdGFnZSwgU3RhZ2VFcnJvciwgU3RhZ2VJZCwgVW53aW5kSW5wdXQsIFVud2luZE91dHB1dH07CnVzZSBzdGQ6OnsKICAgIGNvbGxlY3Rpb25zOjpWZWNEZXF1ZSwKICAgIHN5bmM6OnsKICAgICAgICBhdG9taWM6OntBdG9taWNVc2l6ZSwgT3JkZXJpbmd9LAogICAgICAgIEFyYywKICAgIH0sCn07CgovLy8gQSB0ZXN0IHN0YWdlIHRoYXQgY2FuIGJlIHVzZWQgZm9yIHRlc3RpbmcuCi8vLwovLy8gVGhpcyBjYW4gYmUgdXNlZCB0byBtb2NrIGV4cGVjdGVkIG91dHB1dHMgb2YgW2BTdGFnZTo6ZXhlY3V0ZWBdIGFuZCBbYFN0YWdlOjp1bndpbmRgXQojW2Rlcml2ZShEZWJ1ZyldCnB1YiBzdHJ1Y3QgVGVzdFN0YWdlIHsKICAgIGlkOiBTdGFnZUlkLAogICAgZXhlY19vdXRwdXRzOiBWZWNEZXF1ZTxSZXN1bHQ8RXhlY091dHB1dCwgU3RhZ2VFcnJvcj4+LAogICAgdW53aW5kX291dHB1dHM6IFZlY0RlcXVlPFJlc3VsdDxVbndpbmRPdXRwdXQsIFN0YWdlRXJyb3I+PiwKICAgIHBvc3RfZXhlY3V0ZV9jb21taXRfY291bnRlcjogQXJjPEF0b21pY1VzaXplPiwKICAgIHBvc3RfdW53aW5kX2NvbW1pdF9jb3VudGVyOiBBcmM8QXRvbWljVXNpemU+LAp9CgppbXBsIFRlc3RTdGFnZSB7CiAgICBwdWIgZm4gbmV3KGlkOiBTdGFnZUlkKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgaWQsCiAgICAgICAgICAgIGV4ZWNfb3V0cHV0czogVmVjRGVxdWU6Om5ldygpLAogICAgICAgICAgICB1bndpbmRfb3V0cHV0czogVmVjRGVxdWU6Om5ldygpLAogICAgICAgICAgICBwb3N0X2V4ZWN1dGVfY29tbWl0X2NvdW50ZXI6IEFyYzo6bmV3KEF0b21pY1VzaXplOjpuZXcoMCkpLAogICAgICAgICAgICBwb3N0X3Vud2luZF9jb21taXRfY291bnRlcjogQXJjOjpuZXcoQXRvbWljVXNpemU6Om5ldygwKSksCiAgICAgICAgfQogICAgfQoKICAgIHB1YiBmbiB3aXRoX2V4ZWMobXV0IHNlbGYsIGV4ZWNfb3V0cHV0czogVmVjRGVxdWU8UmVzdWx0PEV4ZWNPdXRwdXQsIFN0YWdlRXJyb3I+PikgLT4gU2VsZiB7CiAgICAgICAgc2VsZi5leGVjX291dHB1dHMgPSBleGVjX291dHB1dHM7CiAgICAgICAgc2VsZgogICAgfQoKICAgIHB1YiBmbiB3aXRoX3Vud2luZCgKICAgICAgICBtdXQgc2VsZiwKICAgICAgICB1bndpbmRfb3V0cHV0czogVmVjRGVxdWU8UmVzdWx0PFVud2luZE91dHB1dCwgU3RhZ2VFcnJvcj4+LAogICAgKSAtPiBTZWxmIHsKICAgICAgICBzZWxmLnVud2luZF9vdXRwdXRzID0gdW53aW5kX291dHB1dHM7CiAgICAgICAgc2VsZgogICAgfQoKICAgIHB1YiBmbiBhZGRfZXhlYyhtdXQgc2VsZiwgb3V0cHV0OiBSZXN1bHQ8RXhlY091dHB1dCwgU3RhZ2VFcnJvcj4pIC0+IFNlbGYgewogICAgICAgIHNlbGYuZXhlY19vdXRwdXRzLnB1c2hfYmFjayhvdXRwdXQpOwogICAgICAgIHNlbGYKICAgIH0KCiAgICBwdWIgZm4gYWRkX3Vud2luZChtdXQgc2VsZiwgb3V0cHV0OiBSZXN1bHQ8VW53aW5kT3V0cHV0LCBTdGFnZUVycm9yPikgLT4gU2VsZiB7CiAgICAgICAgc2VsZi51bndpbmRfb3V0cHV0cy5wdXNoX2JhY2sob3V0cHV0KTsKICAgICAgICBzZWxmCiAgICB9CgogICAgcHViIGZuIHdpdGhfcG9zdF9leGVjdXRlX2NvbW1pdF9jb3VudGVyKG11dCBzZWxmKSAtPiAoU2VsZiwgQXJjPEF0b21pY1VzaXplPikgewogICAgICAgIGxldCBjb3VudGVyID0gQXJjOjpuZXcoQXRvbWljVXNpemU6Om5ldygwKSk7CiAgICAgICAgc2VsZi5wb3N0X2V4ZWN1dGVfY29tbWl0X2NvdW50ZXIgPSBjb3VudGVyLmNsb25lKCk7CiAgICAgICAgKHNlbGYsIGNvdW50ZXIpCiAgICB9CgogICAgcHViIGZuIHdpdGhfcG9zdF91bndpbmRfY29tbWl0X2NvdW50ZXIobXV0IHNlbGYpIC0+IChTZWxmLCBBcmM8QXRvbWljVXNpemU+KSB7CiAgICAgICAgbGV0IGNvdW50ZXIgPSBBcmM6Om5ldyhBdG9taWNVc2l6ZTo6bmV3KDApKTsKICAgICAgICBzZWxmLnBvc3RfdW53aW5kX2NvbW1pdF9jb3VudGVyID0gY291bnRlci5jbG9uZSgpOwogICAgICAgIChzZWxmLCBjb3VudGVyKQogICAgfQp9CgppbXBsPFByb3ZpZGVyPiBTdGFnZTxQcm92aWRlcj4gZm9yIFRlc3RTdGFnZSB7CiAgICBmbiBpZCgmc2VsZikgLT4gU3RhZ2VJZCB7CiAgICAgICAgc2VsZi5pZAogICAgfQoKICAgIGZuIGV4ZWN1dGUoJm11dCBzZWxmLCBfOiAmUHJvdmlkZXIsIF9pbnB1dDogRXhlY0lucHV0KSAtPiBSZXN1bHQ8RXhlY091dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIHNlbGYuZXhlY19vdXRwdXRzCiAgICAgICAgICAgIC5wb3BfZnJvbnQoKQogICAgICAgICAgICAudW53cmFwX29yX2Vsc2UofHwgcGFuaWMhKCJUZXN0IHN0YWdlIHt9IGV4ZWN1dGVkIHRvbyBtYW55IHRpbWVzLiIsIHNlbGYuaWQpKQogICAgfQoKICAgIGZuIHBvc3RfZXhlY3V0ZV9jb21taXQoJm11dCBzZWxmKSAtPiBSZXN1bHQ8KCksIFN0YWdlRXJyb3I+IHsKICAgICAgICBzZWxmLnBvc3RfZXhlY3V0ZV9jb21taXRfY291bnRlci5mZXRjaF9hZGQoMSwgT3JkZXJpbmc6OlJlbGF4ZWQpOwoKICAgICAgICBPaygoKSkKICAgIH0KCiAgICBmbiB1bndpbmQoJm11dCBzZWxmLCBfOiAmUHJvdmlkZXIsIF9pbnB1dDogVW53aW5kSW5wdXQpIC0+IFJlc3VsdDxVbndpbmRPdXRwdXQsIFN0YWdlRXJyb3I+IHsKICAgICAgICBzZWxmLnVud2luZF9vdXRwdXRzCiAgICAgICAgICAgIC5wb3BfZnJvbnQoKQogICAgICAgICAgICAudW53cmFwX29yX2Vsc2UofHwgcGFuaWMhKCJUZXN0IHN0YWdlIHt9IHVud291bmQgdG9vIG1hbnkgdGltZXMuIiwgc2VsZi5pZCkpCiAgICB9CgogICAgZm4gcG9zdF91bndpbmRfY29tbWl0KCZtdXQgc2VsZikgLT4gUmVzdWx0PCgpLCBTdGFnZUVycm9yPiB7CiAgICAgICAgc2VsZi5wb3N0X3Vud2luZF9jb21taXRfY291bnRlci5mZXRjaF9hZGQoMSwgT3JkZXJpbmc6OlJlbGF4ZWQpOwoKICAgICAgICBPaygoKSkKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvc3RhZ2VzL2FwaS9zcmMvdXRpbC5ycyI+CnB1YihjcmF0ZSkgbW9kIG9wdCB7CiAgICAvLy8gR2V0IGFuIFtPcHRpb25dIHdpdGggdGhlIG1heGltdW0gdmFsdWUsIGNvbXBhcmVkIGJldHdlZW4gdGhlIHBhc3NlZCBpbiB2YWx1ZSBhbmQgdGhlIGlubmVyCiAgICAvLy8gdmFsdWUgb2YgdGhlIFtPcHRpb25dLiBJZiB0aGUgW09wdGlvbl0gaXMgYE5vbmVgLCB0aGVuIGFuIG9wdGlvbiBjb250YWluaW5nIHRoZSBwYXNzZWQgaW4KICAgIC8vLyB2YWx1ZSB3aWxsIGJlIHJldHVybmVkLgogICAgcHViKGNyYXRlKSBmbiBtYXg8VDogT3JkICsgQ29weT4oYTogT3B0aW9uPFQ+LCBiOiBUKSAtPiBPcHRpb248VD4gewogICAgICAgIGEubWFwX29yKFNvbWUoYiksIHx2fCBTb21lKHN0ZDo6Y21wOjptYXgodiwgYikpKQogICAgfQoKICAgIC8vLyBHZXQgYW4gW09wdGlvbl0gd2l0aCB0aGUgbWluaW11bSB2YWx1ZSwgY29tcGFyZWQgYmV0d2VlbiB0aGUgcGFzc2VkIGluIHZhbHVlIGFuZCB0aGUgaW5uZXIKICAgIC8vLyB2YWx1ZSBvZiB0aGUgW09wdGlvbl0uIElmIHRoZSBbT3B0aW9uXSBpcyBgTm9uZWAsIHRoZW4gYW4gb3B0aW9uIGNvbnRhaW5pbmcgdGhlIHBhc3NlZCBpbgogICAgLy8vIHZhbHVlIHdpbGwgYmUgcmV0dXJuZWQuCiAgICBwdWIoY3JhdGUpIGZuIG1pbjxUOiBPcmQgKyBDb3B5PihhOiBPcHRpb248VD4sIGI6IFQpIC0+IE9wdGlvbjxUPiB7CiAgICAgICAgYS5tYXBfb3IoU29tZShiKSwgfHZ8IFNvbWUoc3RkOjpjbXA6Om1pbih2LCBiKSkpCiAgICB9CgogICAgI1tjZmcodGVzdCldCiAgICBtb2QgdGVzdHMgewogICAgICAgIHVzZSBzdXBlcjo6KjsKCiAgICAgICAgI1t0ZXN0XQogICAgICAgIGZuIG9wdF9tYXgoKSB7CiAgICAgICAgICAgIGFzc2VydF9lcSEobWF4KE5vbmUsIDUpLCBTb21lKDUpKTsKICAgICAgICAgICAgYXNzZXJ0X2VxIShtYXgoU29tZSgxKSwgNSksIFNvbWUoNSkpOwogICAgICAgICAgICBhc3NlcnRfZXEhKG1heChTb21lKDEwKSwgNSksIFNvbWUoMTApKTsKICAgICAgICB9CgogICAgICAgICNbdGVzdF0KICAgICAgICBmbiBvcHRfbWluKCkgewogICAgICAgICAgICBhc3NlcnRfZXEhKG1pbihOb25lLCA1KSwgU29tZSg1KSk7CiAgICAgICAgICAgIGFzc2VydF9lcSEobWluKFNvbWUoMSksIDUpLCBTb21lKDEpKTsKICAgICAgICAgICAgYXNzZXJ0X2VxIShtaW4oU29tZSgxMCksIDUpLCBTb21lKDUpKTsKICAgICAgICB9CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9zdGFnZXMvc3JjL3N0YWdlcy9ib2RpZXMucnMiPgp1c2Ugc3VwZXI6Om1pc3Npbmdfc3RhdGljX2RhdGFfZXJyb3I7CnVzZSBmdXR1cmVzX3V0aWw6OlRyeVN0cmVhbUV4dDsKdXNlIHJldGhfZGJfYXBpOjp7CiAgICBjdXJzb3I6OkRiQ3Vyc29yUk8sCiAgICB0YWJsZXMsCiAgICB0cmFuc2FjdGlvbjo6e0RiVHgsIERiVHhNdXR9LAp9Owp1c2UgcmV0aF9uZXR3b3JrX3AycDo6Ym9kaWVzOjp7ZG93bmxvYWRlcjo6Qm9keURvd25sb2FkZXIsIHJlc3BvbnNlOjpCbG9ja1Jlc3BvbnNlfTsKdXNlIHJldGhfcHJvdmlkZXI6OnsKICAgIHByb3ZpZGVyczo6U3RhdGljRmlsZVdyaXRlciwgQmxvY2tSZWFkZXIsIEJsb2NrV3JpdGVyLCBEQlByb3ZpZGVyLCBQcm92aWRlckVycm9yLAogICAgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwgU3RhdHNSZWFkZXIsCn07CnVzZSByZXRoX3N0YWdlc19hcGk6OnsKICAgIEVudGl0aWVzQ2hlY2twb2ludCwgRXhlY0lucHV0LCBFeGVjT3V0cHV0LCBTdGFnZSwgU3RhZ2VDaGVja3BvaW50LCBTdGFnZUVycm9yLCBTdGFnZUlkLAogICAgVW53aW5kSW5wdXQsIFVud2luZE91dHB1dCwKfTsKdXNlIHJldGhfc3RhdGljX2ZpbGVfdHlwZXM6OlN0YXRpY0ZpbGVTZWdtZW50Owp1c2UgcmV0aF9zdG9yYWdlX2Vycm9yczo6cHJvdmlkZXI6OlByb3ZpZGVyUmVzdWx0Owp1c2Ugc3RkOjp7CiAgICBjbXA6Ok9yZGVyaW5nLAogICAgdGFzazo6e3JlYWR5LCBDb250ZXh0LCBQb2xsfSwKfTsKdXNlIHRyYWNpbmc6Oio7CgovLy8gVGhlIGJvZHkgc3RhZ2UgZG93bmxvYWRzIGJsb2NrIGJvZGllcy4KLy8vCi8vLyBUaGUgYm9keSBzdGFnZSBkb3dubG9hZHMgYmxvY2sgYm9kaWVzIGZvciBhbGwgYmxvY2sgaGVhZGVycyBzdG9yZWQgbG9jYWxseSBpbiBzdG9yYWdlLgovLy8KLy8vICMgRW1wdHkgYmxvY2tzCi8vLwovLy8gQmxvY2tzIHdpdGggYW4gb21tZXJzIGhhc2ggY29ycmVzcG9uZGluZyB0byBubyBvbW1lcnMgKmFuZCogYSB0cmFuc2FjdGlvbiByb290IGNvcnJlc3BvbmRpbmcgdG8KLy8vIG5vIHRyYW5zYWN0aW9ucyB3aWxsIG5vdCBoYXZlIGEgYmxvY2sgYm9keSBkb3dubG9hZGVkIGZvciB0aGVtLCBzaW5jZSBpdCB3b3VsZCBiZSBtZWFuaW5nbGVzcyB0bwovLy8gZG8gc28uCi8vLwovLy8gVGhpcyBhbHNvIG1lYW5zIHRoYXQgaWYgdGhlcmUgaXMgbm8gYm9keSBmb3IgdGhlIGJsb2NrIGluIHN0b3JhZ2UgKGFzc3VtaW5nIHRoZQovLy8gYmxvY2sgbnVtYmVyIDw9IHRoZSBzeW5jZWQgYmxvY2sgb2YgdGhpcyBzdGFnZSksIHRoZW4gdGhlIGJsb2NrIGNhbiBiZSBjb25zaWRlcmVkIGVtcHR5LgovLy8KLy8vICMgVGFibGVzCi8vLwovLy8gVGhlIGJvZGllcyBhcmUgcHJvY2Vzc2VkIGFuZCBkYXRhIGlzIGluc2VydGVkIGludG8gdGhlc2UgdGFibGVzOgovLy8KLy8vIC0gW2BCbG9ja09tbWVyc2BdW3JldGhfZGJfYXBpOjp0YWJsZXM6OkJsb2NrT21tZXJzXQovLy8gLSBbYEJsb2NrQm9kaWVzYF1bcmV0aF9kYl9hcGk6OnRhYmxlczo6QmxvY2tCb2R5SW5kaWNlc10KLy8vIC0gW2BUcmFuc2FjdGlvbnNgXVtyZXRoX2RiX2FwaTo6dGFibGVzOjpUcmFuc2FjdGlvbnNdCi8vLyAtIFtgVHJhbnNhY3Rpb25CbG9ja3NgXVtyZXRoX2RiX2FwaTo6dGFibGVzOjpUcmFuc2FjdGlvbkJsb2Nrc10KLy8vCi8vLyAjIEdlbmVzaXMKLy8vCi8vLyBUaGlzIHN0YWdlIGV4cGVjdHMgdGhhdCB0aGUgZ2VuZXNpcyBoYXMgYmVlbiBpbnNlcnRlZCBpbnRvIHRoZSBhcHByb3ByaWF0ZSB0YWJsZXM6Ci8vLwovLy8gLSBUaGUgaGVhZGVyIHRhYmxlcyAoc2VlIFtgSGVhZGVyU3RhZ2VgXVtjcmF0ZTo6c3RhZ2VzOjpIZWFkZXJTdGFnZV0pCi8vLyAtIFRoZSBbYEJsb2NrT21tZXJzYF1bcmV0aF9kYl9hcGk6OnRhYmxlczo6QmxvY2tPbW1lcnNdIHRhYmxlCi8vLyAtIFRoZSBbYEJsb2NrQm9kaWVzYF1bcmV0aF9kYl9hcGk6OnRhYmxlczo6QmxvY2tCb2R5SW5kaWNlc10gdGFibGUKLy8vIC0gVGhlIFtgVHJhbnNhY3Rpb25zYF1bcmV0aF9kYl9hcGk6OnRhYmxlczo6VHJhbnNhY3Rpb25zXSB0YWJsZQojW2Rlcml2ZShEZWJ1ZyldCnB1YiBzdHJ1Y3QgQm9keVN0YWdlPEQ6IEJvZHlEb3dubG9hZGVyPiB7CiAgICAvLy8gVGhlIGJvZHkgZG93bmxvYWRlci4KICAgIGRvd25sb2FkZXI6IEQsCiAgICAvLy8gQmxvY2sgcmVzcG9uc2UgYnVmZmVyLgogICAgYnVmZmVyOiBPcHRpb248VmVjPEJsb2NrUmVzcG9uc2U8RDo6QmxvY2s+Pj4sCn0KCmltcGw8RDogQm9keURvd25sb2FkZXI+IEJvZHlTdGFnZTxEPiB7CiAgICAvLy8gQ3JlYXRlIG5ldyBib2RpZXMgc3RhZ2UgZnJvbSBkb3dubG9hZGVyLgogICAgcHViIGNvbnN0IGZuIG5ldyhkb3dubG9hZGVyOiBEKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgZG93bmxvYWRlciwgYnVmZmVyOiBOb25lIH0KICAgIH0KfQoKLy8vIEVuc3VyZXMgdGhhdCBzdGF0aWMgZmlsZXMgYW5kIGRhdGFiYXNlIGFyZSBpbiBzeW5jLgpwdWIoY3JhdGUpIGZuIGVuc3VyZV9jb25zaXN0ZW5jeTxQcm92aWRlcj4oCiAgICBwcm92aWRlcjogJlByb3ZpZGVyLAogICAgdW53aW5kX2Jsb2NrOiBPcHRpb248dTY0PiwKKSAtPiBSZXN1bHQ8KCksIFN0YWdlRXJyb3I+CndoZXJlCiAgICBQcm92aWRlcjogREJQcm92aWRlcjxUeDogRGJUeE11dD4gKyBCbG9ja1JlYWRlciArIFN0YXRpY0ZpbGVQcm92aWRlckZhY3RvcnksCnsKICAgIC8vIEdldCBpZCBmb3IgdGhlIG5leHQgdHhfbnVtIG9mIHplcm8gaWYgdGhlcmUgYXJlIG5vIHRyYW5zYWN0aW9ucy4KICAgIGxldCBuZXh0X3R4X251bSA9IHByb3ZpZGVyCiAgICAgICAgLnR4X3JlZigpCiAgICAgICAgLmN1cnNvcl9yZWFkOjo8dGFibGVzOjpUcmFuc2FjdGlvbkJsb2Nrcz4oKT8KICAgICAgICAubGFzdCgpPwogICAgICAgIC5tYXAofChpZCwgXyl8IGlkICsgMSkKICAgICAgICAudW53cmFwX29yX2RlZmF1bHQoKTsKCiAgICBsZXQgc3RhdGljX2ZpbGVfcHJvdmlkZXIgPSBwcm92aWRlci5zdGF0aWNfZmlsZV9wcm92aWRlcigpOwoKICAgIC8vIE1ha2Ugc3VyZSBUcmFuc2FjdGlvbnMgc3RhdGljIGZpbGUgaXMgYXQgdGhlIHNhbWUgaGVpZ2h0LiBJZiBpdCdzIGZ1cnRoZXIsIHRoaXMKICAgIC8vIGlucHV0IGV4ZWN1dGlvbiB3YXMgaW50ZXJydXB0ZWQgcHJldmlvdXNseSBhbmQgd2UgbmVlZCB0byB1bndpbmQgdGhlIHN0YXRpYyBmaWxlLgogICAgbGV0IG5leHRfc3RhdGljX2ZpbGVfdHhfbnVtID0gc3RhdGljX2ZpbGVfcHJvdmlkZXIKICAgICAgICAuZ2V0X2hpZ2hlc3Rfc3RhdGljX2ZpbGVfdHgoU3RhdGljRmlsZVNlZ21lbnQ6OlRyYW5zYWN0aW9ucykKICAgICAgICAubWFwKHxpZHwgaWQgKyAxKQogICAgICAgIC51bndyYXBfb3JfZGVmYXVsdCgpOwoKICAgIG1hdGNoIG5leHRfc3RhdGljX2ZpbGVfdHhfbnVtLmNtcCgmbmV4dF90eF9udW0pIHsKICAgICAgICAvLyBJZiBzdGF0aWMgZmlsZXMgYXJlIGFoZWFkLCB3ZSBhcmUgY3VycmVudGx5IHVud2luZGluZyB0aGUgc3RhZ2Ugb3Igd2UgZGlkbid0IHJlYWNoCiAgICAgICAgLy8gdGhlIGRhdGFiYXNlIGNvbW1pdCBpbiBhIHByZXZpb3VzIHN0YWdlIHJ1bi4gU28sIG91ciBvbmx5IHNvbHV0aW9uIGlzIHRvIHVud2luZCB0aGUKICAgICAgICAvLyBzdGF0aWMgZmlsZXMgYW5kIHByb2NlZWQgZnJvbSB0aGUgZGF0YWJhc2UgZXhwZWN0ZWQgaGVpZ2h0LgogICAgICAgIE9yZGVyaW5nOjpHcmVhdGVyID0+IHsKICAgICAgICAgICAgbGV0IGhpZ2hlc3RfZGJfYmxvY2sgPSBwcm92aWRlci50eF9yZWYoKS5lbnRyaWVzOjo8dGFibGVzOjpCbG9ja0JvZHlJbmRpY2VzPigpPyBhcyB1NjQ7CiAgICAgICAgICAgIGxldCBtdXQgc3RhdGljX2ZpbGVfcHJvZHVjZXIgPQogICAgICAgICAgICAgICAgc3RhdGljX2ZpbGVfcHJvdmlkZXIubGF0ZXN0X3dyaXRlcihTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25zKT87CiAgICAgICAgICAgIHN0YXRpY19maWxlX3Byb2R1Y2VyCiAgICAgICAgICAgICAgICAucHJ1bmVfdHJhbnNhY3Rpb25zKG5leHRfc3RhdGljX2ZpbGVfdHhfbnVtIC0gbmV4dF90eF9udW0sIGhpZ2hlc3RfZGJfYmxvY2spPzsKICAgICAgICAgICAgLy8gU2luY2UgdGhpcyBpcyBhIGRhdGFiYXNlIDwtPiBzdGF0aWMgZmlsZSBpbmNvbnNpc3RlbmN5LCB3ZSBjb21taXQgdGhlIGNoYW5nZQogICAgICAgICAgICAvLyBzdHJhaWdodCBhd2F5LgogICAgICAgICAgICBzdGF0aWNfZmlsZV9wcm9kdWNlci5jb21taXQoKT87CiAgICAgICAgfQogICAgICAgIC8vIElmIHN0YXRpYyBmaWxlcyBhcmUgYmVoaW5kLCB0aGVuIHRoZXJlIHdhcyBzb21lIGNvcnJ1cHRpb24gb3IgbG9zcyBvZiBmaWxlcy4gVGhpcwogICAgICAgIC8vIGVycm9yIHdpbGwgdHJpZ2dlciBhbiB1bndpbmQsIHRoYXQgd2lsbCBicmluZyB0aGUgZGF0YWJhc2UgdG8gdGhlIHNhbWUgaGVpZ2h0IGFzIHRoZQogICAgICAgIC8vIHN0YXRpYyBmaWxlcy4KICAgICAgICBPcmRlcmluZzo6TGVzcyA9PiB7CiAgICAgICAgICAgIC8vIElmIHdlIGFyZSBhbHJlYWR5IGluIHRoZSBwcm9jZXNzIG9mIHVud2luZCwgdGhpcyBtaWdodCBiZSBmaW5lIGJlY2F1c2Ugd2Ugd2lsbAogICAgICAgICAgICAvLyBmaXggdGhlIGluY29uc2lzdGVuY3kgcmlnaHQgYXdheS4KICAgICAgICAgICAgaWYgbGV0IFNvbWUodW53aW5kX3RvKSA9IHVud2luZF9ibG9jayB7CiAgICAgICAgICAgICAgICBsZXQgbmV4dF90eF9udW1fYWZ0ZXJfdW53aW5kID0gcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAuYmxvY2tfYm9keV9pbmRpY2VzKHVud2luZF90byk/CiAgICAgICAgICAgICAgICAgICAgLm1hcCh8YnwgYi5uZXh0X3R4X251bSgpKQogICAgICAgICAgICAgICAgICAgIC5va19vcihQcm92aWRlckVycm9yOjpCbG9ja0JvZHlJbmRpY2VzTm90Rm91bmQodW53aW5kX3RvKSk/OwoKICAgICAgICAgICAgICAgIC8vIFRoaXMgbWVhbnMgd2UgbmVlZCBhIGRlZXBlciB1bndpbmQuCiAgICAgICAgICAgICAgICBpZiBuZXh0X3R4X251bV9hZnRlcl91bndpbmQgPiBuZXh0X3N0YXRpY19maWxlX3R4X251bSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEVycihtaXNzaW5nX3N0YXRpY19kYXRhX2Vycm9yKAogICAgICAgICAgICAgICAgICAgICAgICBuZXh0X3N0YXRpY19maWxlX3R4X251bS5zYXR1cmF0aW5nX3N1YigxKSwKICAgICAgICAgICAgICAgICAgICAgICAgJnN0YXRpY19maWxlX3Byb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAgICAgU3RhdGljRmlsZVNlZ21lbnQ6OlRyYW5zYWN0aW9ucywKICAgICAgICAgICAgICAgICAgICApPykKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBFcnIobWlzc2luZ19zdGF0aWNfZGF0YV9lcnJvcigKICAgICAgICAgICAgICAgICAgICBuZXh0X3N0YXRpY19maWxlX3R4X251bS5zYXR1cmF0aW5nX3N1YigxKSwKICAgICAgICAgICAgICAgICAgICAmc3RhdGljX2ZpbGVfcHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgU3RhdGljRmlsZVNlZ21lbnQ6OlRyYW5zYWN0aW9ucywKICAgICAgICAgICAgICAgICk/KQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIE9yZGVyaW5nOjpFcXVhbCA9PiB7fQogICAgfQoKICAgIE9rKCgpKQp9CgppbXBsPFByb3ZpZGVyLCBEPiBTdGFnZTxQcm92aWRlcj4gZm9yIEJvZHlTdGFnZTxEPgp3aGVyZQogICAgUHJvdmlkZXI6IERCUHJvdmlkZXI8VHg6IERiVHhNdXQ+CiAgICAgICAgKyBTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5CiAgICAgICAgKyBTdGF0c1JlYWRlcgogICAgICAgICsgQmxvY2tSZWFkZXIKICAgICAgICArIEJsb2NrV3JpdGVyPEJsb2NrID0gRDo6QmxvY2s+LAogICAgRDogQm9keURvd25sb2FkZXIsCnsKICAgIC8vLyBSZXR1cm4gdGhlIGlkIG9mIHRoZSBzdGFnZQogICAgZm4gaWQoJnNlbGYpIC0+IFN0YWdlSWQgewogICAgICAgIFN0YWdlSWQ6OkJvZGllcwogICAgfQoKICAgIGZuIHBvbGxfZXhlY3V0ZV9yZWFkeSgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgY3g6ICZtdXQgQ29udGV4dDwnXz4sCiAgICAgICAgaW5wdXQ6IEV4ZWNJbnB1dCwKICAgICkgLT4gUG9sbDxSZXN1bHQ8KCksIFN0YWdlRXJyb3I+PiB7CiAgICAgICAgaWYgaW5wdXQudGFyZ2V0X3JlYWNoZWQoKSB8fCBzZWxmLmJ1ZmZlci5pc19zb21lKCkgewogICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoT2soKCkpKQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIHRoZSBoZWFkZXIgcmFuZ2Ugb24gdGhlIGRvd25sb2FkZXIKICAgICAgICBzZWxmLmRvd25sb2FkZXIuc2V0X2Rvd25sb2FkX3JhbmdlKGlucHV0Lm5leHRfYmxvY2tfcmFuZ2UoKSk/OwoKICAgICAgICAvLyBQb2xsIG5leHQgZG93bmxvYWRlciBpdGVtLgogICAgICAgIGxldCBtYXliZV9uZXh0X3Jlc3VsdCA9IHJlYWR5IShzZWxmLmRvd25sb2FkZXIudHJ5X3BvbGxfbmV4dF91bnBpbihjeCkpOwoKICAgICAgICAvLyBUYXNrIGRvd25sb2FkZXIgY2FuIHJldHVybiBgTm9uZWAgb25seSBpZiB0aGUgcmVzcG9uc2UgcmVsYXlpbmcgY2hhbm5lbCB3YXMgY2xvc2VkLiBUaGlzCiAgICAgICAgLy8gaXMgYSBmYXRhbCBlcnJvciB0byBwcmV2ZW50IHRoZSBwaXBlbGluZSBmcm9tIHJ1bm5pbmcgZm9yZXZlci4KICAgICAgICBsZXQgcmVzcG9uc2UgPSBtYXRjaCBtYXliZV9uZXh0X3Jlc3VsdCB7CiAgICAgICAgICAgIFNvbWUoT2soZG93bmxvYWRlZCkpID0+IHsKICAgICAgICAgICAgICAgIHNlbGYuYnVmZmVyID0gU29tZShkb3dubG9hZGVkKTsKICAgICAgICAgICAgICAgIE9rKCgpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIFNvbWUoRXJyKGVycikpID0+IEVycihlcnIuaW50bygpKSwKICAgICAgICAgICAgTm9uZSA9PiBFcnIoU3RhZ2VFcnJvcjo6Q2hhbm5lbENsb3NlZCksCiAgICAgICAgfTsKICAgICAgICBQb2xsOjpSZWFkeShyZXNwb25zZSkKICAgIH0KCiAgICAvLy8gRG93bmxvYWQgYmxvY2sgYm9kaWVzIGZyb20gdGhlIGxhc3QgY2hlY2twb2ludCBmb3IgdGhpcyBzdGFnZSB1cCB1bnRpbCB0aGUgbGF0ZXN0IHN5bmNlZAogICAgLy8vIGhlYWRlciwgbGltaXRlZCBieSB0aGUgc3RhZ2UncyBiYXRjaCBzaXplLgogICAgZm4gZXhlY3V0ZSgmbXV0IHNlbGYsIHByb3ZpZGVyOiAmUHJvdmlkZXIsIGlucHV0OiBFeGVjSW5wdXQpIC0+IFJlc3VsdDxFeGVjT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgaWYgaW5wdXQudGFyZ2V0X3JlYWNoZWQoKSB7CiAgICAgICAgICAgIHJldHVybiBPayhFeGVjT3V0cHV0Ojpkb25lKGlucHV0LmNoZWNrcG9pbnQoKSkpCiAgICAgICAgfQogICAgICAgIGxldCAoZnJvbV9ibG9jaywgdG9fYmxvY2spID0gaW5wdXQubmV4dF9ibG9ja19yYW5nZSgpLmludG9faW5uZXIoKTsKCiAgICAgICAgZW5zdXJlX2NvbnNpc3RlbmN5KHByb3ZpZGVyLCBOb25lKT87CgogICAgICAgIGRlYnVnISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OmJvZGllcyIsIHN0YWdlX3Byb2dyZXNzID0gZnJvbV9ibG9jaywgdGFyZ2V0ID0gdG9fYmxvY2ssICJDb21tZW5jaW5nIHN5bmMiKTsKCiAgICAgICAgbGV0IGJ1ZmZlciA9IHNlbGYuYnVmZmVyLnRha2UoKS5va19vcihTdGFnZUVycm9yOjpNaXNzaW5nRG93bmxvYWRCdWZmZXIpPzsKICAgICAgICB0cmFjZSEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpib2RpZXMiLCBib2RpZXNfbGVuID0gYnVmZmVyLmxlbigpLCAiV3JpdGluZyBibG9ja3MiKTsKICAgICAgICBsZXQgaGlnaGVzdF9ibG9jayA9IGJ1ZmZlci5sYXN0KCkubWFwKHxyfCByLmJsb2NrX251bWJlcigpKS51bndyYXBfb3IoZnJvbV9ibG9jayk7CgogICAgICAgIC8vIFdyaXRlIGJvZGllcyB0byBkYXRhYmFzZS4KICAgICAgICBwcm92aWRlci5hcHBlbmRfYmxvY2tfYm9kaWVzKAogICAgICAgICAgICBidWZmZXIuaXRlcigpLm1hcCh8cmVzcG9uc2V8IChyZXNwb25zZS5ibG9ja19udW1iZXIoKSwgcmVzcG9uc2UuYm9keSgpKSkuY29sbGVjdCgpLAogICAgICAgICk/OwoKICAgICAgICAvLyBUaGUgc3RhZ2UgaXMgImRvbmUiIGlmOgogICAgICAgIC8vIC0gV2UgZ290IGZld2VyIGJsb2NrcyB0aGFuIG91ciB0YXJnZXQKICAgICAgICAvLyAtIFdlIHJlYWNoZWQgb3VyIHRhcmdldCBhbmQgdGhlIHRhcmdldCB3YXMgbm90IGxpbWl0ZWQgYnkgdGhlIGJhdGNoIHNpemUgb2YgdGhlIHN0YWdlCiAgICAgICAgbGV0IGRvbmUgPSBoaWdoZXN0X2Jsb2NrID09IHRvX2Jsb2NrOwogICAgICAgIE9rKEV4ZWNPdXRwdXQgewogICAgICAgICAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhoaWdoZXN0X2Jsb2NrKQogICAgICAgICAgICAgICAgLndpdGhfZW50aXRpZXNfc3RhZ2VfY2hlY2twb2ludChzdGFnZV9jaGVja3BvaW50KHByb3ZpZGVyKT8pLAogICAgICAgICAgICBkb25lLAogICAgICAgIH0pCiAgICB9CgogICAgLy8vIFVud2luZCB0aGUgc3RhZ2UuCiAgICBmbiB1bndpbmQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICAgICAgaW5wdXQ6IFVud2luZElucHV0LAogICAgKSAtPiBSZXN1bHQ8VW53aW5kT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgc2VsZi5idWZmZXIudGFrZSgpOwoKICAgICAgICBlbnN1cmVfY29uc2lzdGVuY3kocHJvdmlkZXIsIFNvbWUoaW5wdXQudW53aW5kX3RvKSk/OwogICAgICAgIHByb3ZpZGVyLnJlbW92ZV9ib2RpZXNfYWJvdmUoaW5wdXQudW53aW5kX3RvKT87CgogICAgICAgIE9rKFVud2luZE91dHB1dCB7CiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KGlucHV0LnVud2luZF90bykKICAgICAgICAgICAgICAgIC53aXRoX2VudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfY2hlY2twb2ludChwcm92aWRlcik/KSwKICAgICAgICB9KQogICAgfQp9CgovLyBUT0RPKGFsZXhleSk6IGlkZWFsbHksIHdlIHdhbnQgdG8gbWVhc3VyZSBCb2RpZXMgc3RhZ2UgcHJvZ3Jlc3MgaW4gYnl0ZXMsIGJ1dCBpdCdzIGhhcmQgdG8ga25vdwovLyAgYmVmb3JlaGFuZCBob3cgbWFueSBieXRlcyB3ZSBuZWVkIHRvIGRvd25sb2FkLiBTbyB0aGUgZ29vZCBzb2x1dGlvbiB3b3VsZCBiZSB0byBtZWFzdXJlIHRoZQovLyAgcHJvZ3Jlc3MgaW4gZ2FzIGFzIGEgcHJveHkgdG8gc2l6ZS4gRXhlY3V0aW9uIHN0YWdlIHVzZXMgYSBzaW1pbGFyIGFwcHJvYWNoLgpmbiBzdGFnZV9jaGVja3BvaW50PFByb3ZpZGVyPihwcm92aWRlcjogJlByb3ZpZGVyKSAtPiBQcm92aWRlclJlc3VsdDxFbnRpdGllc0NoZWNrcG9pbnQ+CndoZXJlCiAgICBQcm92aWRlcjogU3RhdHNSZWFkZXIgKyBTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5LAp7CiAgICBPayhFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgIHByb2Nlc3NlZDogcHJvdmlkZXIuY291bnRfZW50cmllczo6PHRhYmxlczo6QmxvY2tCb2R5SW5kaWNlcz4oKT8gYXMgdTY0LAogICAgICAgIC8vIENvdW50IG9ubHkgc3RhdGljIGZpbGVzIGVudHJpZXMuIElmIHdlIGNvdW50IHRoZSBkYXRhYmFzZSBlbnRyaWVzIHRvbywgd2UgbWF5IGhhdmUKICAgICAgICAvLyBkdXBsaWNhdGVzLiBXZSdyZSBzdXJlIHRoYXQgdGhlIHN0YXRpYyBmaWxlcyBoYXZlIGFsbCBlbnRyaWVzIHRoYXQgZGF0YWJhc2UgaGFzLAogICAgICAgIC8vIGJlY2F1c2Ugd2UgcnVuIHRoZSBgU3RhdGljRmlsZVByb2R1Y2VyYCBiZWZvcmUgc3RhcnRpbmcgdGhlIHBpcGVsaW5lLgogICAgICAgIHRvdGFsOiBwcm92aWRlci5zdGF0aWNfZmlsZV9wcm92aWRlcigpLmNvdW50X2VudHJpZXM6Ojx0YWJsZXM6OkhlYWRlcnM+KCk/IGFzIHU2NCwKICAgIH0pCn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdHMgewogICAgdXNlIHN1cGVyOjoqOwogICAgdXNlIGNyYXRlOjp0ZXN0X3V0aWxzOjp7CiAgICAgICAgc3RhZ2VfdGVzdF9zdWl0ZV9leHQsIEV4ZWN1dGVTdGFnZVRlc3RSdW5uZXIsIFN0YWdlVGVzdFJ1bm5lciwgVW53aW5kU3RhZ2VUZXN0UnVubmVyLAogICAgfTsKICAgIHVzZSBhc3NlcnRfbWF0Y2hlczo6YXNzZXJ0X21hdGNoZXM7CiAgICB1c2UgcmV0aF9wcm92aWRlcjo6U3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeTsKICAgIHVzZSByZXRoX3N0YWdlc19hcGk6OlN0YWdlVW5pdENoZWNrcG9pbnQ7CiAgICB1c2UgdGVzdF91dGlsczo6KjsKCiAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCEoQm9keVRlc3RSdW5uZXIsIGJvZHkpOwoKICAgIC8vLyBDaGVja3MgdGhhdCB0aGUgc3RhZ2UgZG93bmxvYWRzIGF0IG1vc3QgYGJhdGNoX3NpemVgIGJsb2Nrcy4KICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBwYXJ0aWFsX2JvZHlfZG93bmxvYWQoKSB7CiAgICAgICAgbGV0IChzdGFnZV9wcm9ncmVzcywgcHJldmlvdXNfc3RhZ2UpID0gKDEsIDIwMCk7CgogICAgICAgIC8vIFNldCB1cCB0ZXN0IHJ1bm5lcgogICAgICAgIGxldCBtdXQgcnVubmVyID0gQm9keVRlc3RSdW5uZXI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgewogICAgICAgICAgICB0YXJnZXQ6IFNvbWUocHJldmlvdXNfc3RhZ2UpLAogICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KHN0YWdlX3Byb2dyZXNzKSksCiAgICAgICAgfTsKICAgICAgICBydW5uZXIuc2VlZF9leGVjdXRpb24oaW5wdXQpLmV4cGVjdCgiZmFpbGVkIHRvIHNlZWQgZXhlY3V0aW9uIik7CgogICAgICAgIC8vIFNldCB0aGUgYmF0Y2ggc2l6ZSAobWF4IHdlIHN5bmMgcGVyIHN0YWdlIGV4ZWN1dGlvbikgdG8gbGVzcyB0aGFuIHRoZSBudW1iZXIgb2YgYmxvY2tzCiAgICAgICAgLy8gdGhlIHByZXZpb3VzIHN0YWdlIHN5bmNlZCAoMTAgdnMgMjApCiAgICAgICAgbGV0IGJhdGNoX3NpemUgPSAxMDsKICAgICAgICBydW5uZXIuc2V0X2JhdGNoX3NpemUoYmF0Y2hfc2l6ZSk7CgogICAgICAgIC8vIFJ1biB0aGUgc3RhZ2UKICAgICAgICBsZXQgcnggPSBydW5uZXIuZXhlY3V0ZShpbnB1dCk7CgogICAgICAgIC8vIENoZWNrIHRoYXQgd2Ugb25seSBzeW5jZWQgYXJvdW5kIGBiYXRjaF9zaXplYCBibG9ja3MgZXZlbiB0aG91Z2ggdGhlIG51bWJlciBvZiBibG9ja3MKICAgICAgICAvLyBzeW5jZWQgYnkgdGhlIHByZXZpb3VzIHN0YWdlIGlzIGhpZ2hlcgogICAgICAgIGxldCBvdXRwdXQgPSByeC5hd2FpdC51bndyYXAoKTsKICAgICAgICBydW5uZXIuZGIoKS5mYWN0b3J5LnN0YXRpY19maWxlX3Byb3ZpZGVyKCkuY29tbWl0KCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKAogICAgICAgICAgICBvdXRwdXQsCiAgICAgICAgICAgIE9rKEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgc3RhZ2VfY2hlY2twb2ludDogU29tZShTdGFnZVVuaXRDaGVja3BvaW50OjpFbnRpdGllcyhFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZCwgLy8gMSBzZWVkZWQgYmxvY2sgYm9keSArIGJhdGNoIHNpemUKICAgICAgICAgICAgICAgICAgICB0b3RhbCAvLyBzZWVkZWQgaGVhZGVycwogICAgICAgICAgICAgICAgfSkpCiAgICAgICAgICAgIH0sIGRvbmU6IGZhbHNlIH0pIGlmIGJsb2NrX251bWJlciA8IDIwMCAmJgogICAgICAgICAgICAgICAgcHJvY2Vzc2VkID09IGJhdGNoX3NpemUgKyAxICYmIHRvdGFsID09IHByZXZpb3VzX3N0YWdlICsgMQogICAgICAgICk7CiAgICAgICAgYXNzZXJ0IShydW5uZXIudmFsaWRhdGVfZXhlY3V0aW9uKGlucHV0LCBvdXRwdXQub2soKSkuaXNfb2soKSwgImV4ZWN1dGlvbiB2YWxpZGF0aW9uIik7CiAgICB9CgogICAgLy8vIFNhbWUgYXMgW2BwYXJ0aWFsX2JvZHlfZG93bmxvYWRgXSBleGNlcHQgdGhlIGBiYXRjaF9zaXplYCBpcyBub3QgaGl0LgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGZ1bGxfYm9keV9kb3dubG9hZCgpIHsKICAgICAgICBsZXQgKHN0YWdlX3Byb2dyZXNzLCBwcmV2aW91c19zdGFnZSkgPSAoMSwgMjApOwoKICAgICAgICAvLyBTZXQgdXAgdGVzdCBydW5uZXIKICAgICAgICBsZXQgbXV0IHJ1bm5lciA9IEJvZHlUZXN0UnVubmVyOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IGlucHV0ID0gRXhlY0lucHV0IHsKICAgICAgICAgICAgdGFyZ2V0OiBTb21lKHByZXZpb3VzX3N0YWdlKSwKICAgICAgICAgICAgY2hlY2twb2ludDogU29tZShTdGFnZUNoZWNrcG9pbnQ6Om5ldyhzdGFnZV9wcm9ncmVzcykpLAogICAgICAgIH07CiAgICAgICAgcnVubmVyLnNlZWRfZXhlY3V0aW9uKGlucHV0KS5leHBlY3QoImZhaWxlZCB0byBzZWVkIGV4ZWN1dGlvbiIpOwoKICAgICAgICAvLyBTZXQgdGhlIGJhdGNoIHNpemUgdG8gbW9yZSB0aGFuIHdoYXQgdGhlIHByZXZpb3VzIHN0YWdlIHN5bmNlZCAoNDAgdnMgMjApCiAgICAgICAgcnVubmVyLnNldF9iYXRjaF9zaXplKDQwKTsKCiAgICAgICAgLy8gUnVuIHRoZSBzdGFnZQogICAgICAgIGxldCByeCA9IHJ1bm5lci5leGVjdXRlKGlucHV0KTsKCiAgICAgICAgLy8gQ2hlY2sgdGhhdCB3ZSBzeW5jZWQgYWxsIGJsb2NrcyBzdWNjZXNzZnVsbHksIGV2ZW4gdGhvdWdoIG91ciBgYmF0Y2hfc2l6ZWAgYWxsb3dzIHVzIHRvCiAgICAgICAgLy8gc3luYyBtb3JlIChpZiB0aGVyZSB3ZXJlIG1vcmUgaGVhZGVycykKICAgICAgICBsZXQgb3V0cHV0ID0gcnguYXdhaXQudW53cmFwKCk7CiAgICAgICAgcnVubmVyLmRiKCkuZmFjdG9yeS5zdGF0aWNfZmlsZV9wcm92aWRlcigpLmNvbW1pdCgpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9tYXRjaGVzISgKICAgICAgICAgICAgb3V0cHV0LAogICAgICAgICAgICBPayhFeGVjT3V0cHV0IHsKICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiAyMCwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50OiBTb21lKFN0YWdlVW5pdENoZWNrcG9pbnQ6OkVudGl0aWVzKEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZCwKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWwKICAgICAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkb25lOiB0cnVlCiAgICAgICAgICAgIH0pIGlmIHByb2Nlc3NlZCArIDEgPT0gdG90YWwgJiYgdG90YWwgPT0gcHJldmlvdXNfc3RhZ2UgKyAxCiAgICAgICAgKTsKICAgICAgICBhc3NlcnQhKHJ1bm5lci52YWxpZGF0ZV9leGVjdXRpb24oaW5wdXQsIG91dHB1dC5vaygpKS5pc19vaygpLCAiZXhlY3V0aW9uIHZhbGlkYXRpb24iKTsKICAgIH0KCiAgICAvLy8gU2FtZSBhcyBbYGZ1bGxfYm9keV9kb3dubG9hZGBdIGV4Y2VwdCB3ZSBoYXZlIG1hZGUgcHJvZ3Jlc3MgYmVmb3JlCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gc3luY19mcm9tX3ByZXZpb3VzX3Byb2dyZXNzKCkgewogICAgICAgIGxldCAoc3RhZ2VfcHJvZ3Jlc3MsIHByZXZpb3VzX3N0YWdlKSA9ICgxLCAyMSk7CgogICAgICAgIC8vIFNldCB1cCB0ZXN0IHJ1bm5lcgogICAgICAgIGxldCBtdXQgcnVubmVyID0gQm9keVRlc3RSdW5uZXI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgewogICAgICAgICAgICB0YXJnZXQ6IFNvbWUocHJldmlvdXNfc3RhZ2UpLAogICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KHN0YWdlX3Byb2dyZXNzKSksCiAgICAgICAgfTsKICAgICAgICBydW5uZXIuc2VlZF9leGVjdXRpb24oaW5wdXQpLmV4cGVjdCgiZmFpbGVkIHRvIHNlZWQgZXhlY3V0aW9uIik7CgogICAgICAgIGxldCBiYXRjaF9zaXplID0gMTA7CiAgICAgICAgcnVubmVyLnNldF9iYXRjaF9zaXplKGJhdGNoX3NpemUpOwoKICAgICAgICAvLyBSdW4gdGhlIHN0YWdlCiAgICAgICAgbGV0IHJ4ID0gcnVubmVyLmV4ZWN1dGUoaW5wdXQpOwoKICAgICAgICAvLyBDaGVjayB0aGF0IHdlIHN5bmNlZCBhdCBsZWFzdCAxMCBibG9ja3MKICAgICAgICBsZXQgZmlyc3RfcnVuID0gcnguYXdhaXQudW53cmFwKCk7CiAgICAgICAgcnVubmVyLmRiKCkuZmFjdG9yeS5zdGF0aWNfZmlsZV9wcm92aWRlcigpLmNvbW1pdCgpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9tYXRjaGVzISgKICAgICAgICAgICAgZmlyc3RfcnVuLAogICAgICAgICAgICBPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgIGJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgIHN0YWdlX2NoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VVbml0Q2hlY2twb2ludDo6RW50aXRpZXMoRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWQsCiAgICAgICAgICAgICAgICAgICAgdG90YWwKICAgICAgICAgICAgICAgIH0pKQogICAgICAgICAgICB9LCBkb25lOiBmYWxzZSB9KSBpZiBibG9ja19udW1iZXIgPj0gMTAgJiYKICAgICAgICAgICAgICAgIHByb2Nlc3NlZCAtIDEgPT0gYmF0Y2hfc2l6ZSAmJiB0b3RhbCA9PSBwcmV2aW91c19zdGFnZSArIDEKICAgICAgICApOwogICAgICAgIGxldCBmaXJzdF9ydW5fY2hlY2twb2ludCA9IGZpcnN0X3J1bi51bndyYXAoKS5jaGVja3BvaW50OwoKICAgICAgICAvLyBFeGVjdXRlIGFnYWluIG9uIHRvcCBvZiB0aGUgcHJldmlvdXMgcnVuCiAgICAgICAgbGV0IGlucHV0ID0KICAgICAgICAgICAgRXhlY0lucHV0IHsgdGFyZ2V0OiBTb21lKHByZXZpb3VzX3N0YWdlKSwgY2hlY2twb2ludDogU29tZShmaXJzdF9ydW5fY2hlY2twb2ludCkgfTsKICAgICAgICBsZXQgcnggPSBydW5uZXIuZXhlY3V0ZShpbnB1dCk7CgogICAgICAgIC8vIENoZWNrIHRoYXQgd2Ugc3luY2VkIG1vcmUgYmxvY2tzCiAgICAgICAgbGV0IG91dHB1dCA9IHJ4LmF3YWl0LnVud3JhcCgpOwogICAgICAgIHJ1bm5lci5kYigpLmZhY3Rvcnkuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKS5jb21taXQoKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoCiAgICAgICAgICAgIG91dHB1dCwKICAgICAgICAgICAgT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICBibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50OiBTb21lKFN0YWdlVW5pdENoZWNrcG9pbnQ6OkVudGl0aWVzKEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkLAogICAgICAgICAgICAgICAgICAgIHRvdGFsCiAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgfSwgZG9uZTogdHJ1ZSB9KSBpZiBibG9ja19udW1iZXIgPiBmaXJzdF9ydW5fY2hlY2twb2ludC5ibG9ja19udW1iZXIgJiYKICAgICAgICAgICAgICAgIHByb2Nlc3NlZCArIDEgPT0gdG90YWwgJiYgdG90YWwgPT0gcHJldmlvdXNfc3RhZ2UgKyAxCiAgICAgICAgKTsKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoCiAgICAgICAgICAgIHJ1bm5lci52YWxpZGF0ZV9leGVjdXRpb24oaW5wdXQsIG91dHB1dC5vaygpKSwKICAgICAgICAgICAgT2soXyksCiAgICAgICAgICAgICJleGVjdXRpb24gdmFsaWRhdGlvbiIKICAgICAgICApOwogICAgfQoKICAgIC8vLyBDaGVja3MgdGhhdCB0aGUgc3RhZ2UgdW53aW5kcyBjb3JyZWN0bHksIGV2ZW4gaWYgYSB0cmFuc2FjdGlvbiBpbiBhIGJsb2NrIGlzIG1pc3NpbmcuCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdW53aW5kX21pc3NpbmdfdHgoKSB7CiAgICAgICAgbGV0IChzdGFnZV9wcm9ncmVzcywgcHJldmlvdXNfc3RhZ2UpID0gKDEsIDIwKTsKCiAgICAgICAgLy8gU2V0IHVwIHRlc3QgcnVubmVyCiAgICAgICAgbGV0IG11dCBydW5uZXIgPSBCb2R5VGVzdFJ1bm5lcjo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBpbnB1dCA9IEV4ZWNJbnB1dCB7CiAgICAgICAgICAgIHRhcmdldDogU29tZShwcmV2aW91c19zdGFnZSksCiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VDaGVja3BvaW50OjpuZXcoc3RhZ2VfcHJvZ3Jlc3MpKSwKICAgICAgICB9OwogICAgICAgIHJ1bm5lci5zZWVkX2V4ZWN1dGlvbihpbnB1dCkuZXhwZWN0KCJmYWlsZWQgdG8gc2VlZCBleGVjdXRpb24iKTsKCiAgICAgICAgLy8gU2V0IHRoZSBiYXRjaCBzaXplIHRvIG1vcmUgdGhhbiB3aGF0IHRoZSBwcmV2aW91cyBzdGFnZSBzeW5jZWQgKDQwIHZzIDIwKQogICAgICAgIHJ1bm5lci5zZXRfYmF0Y2hfc2l6ZSg0MCk7CgogICAgICAgIC8vIFJ1biB0aGUgc3RhZ2UKICAgICAgICBsZXQgcnggPSBydW5uZXIuZXhlY3V0ZShpbnB1dCk7CgogICAgICAgIC8vIENoZWNrIHRoYXQgd2Ugc3luY2VkIGFsbCBibG9ja3Mgc3VjY2Vzc2Z1bGx5LCBldmVuIHRob3VnaCBvdXIgYGJhdGNoX3NpemVgIGFsbG93cyB1cyB0bwogICAgICAgIC8vIHN5bmMgbW9yZSAoaWYgdGhlcmUgd2VyZSBtb3JlIGhlYWRlcnMpCiAgICAgICAgbGV0IG91dHB1dCA9IHJ4LmF3YWl0LnVud3JhcCgpOwogICAgICAgIHJ1bm5lci5kYigpLmZhY3Rvcnkuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKS5jb21taXQoKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoCiAgICAgICAgICAgIG91dHB1dCwKICAgICAgICAgICAgT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICBibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50OiBTb21lKFN0YWdlVW5pdENoZWNrcG9pbnQ6OkVudGl0aWVzKEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkLAogICAgICAgICAgICAgICAgICAgIHRvdGFsCiAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgfSwgZG9uZTogdHJ1ZSB9KSBpZiBibG9ja19udW1iZXIgPT0gcHJldmlvdXNfc3RhZ2UgJiYKICAgICAgICAgICAgICAgIHByb2Nlc3NlZCArIDEgPT0gdG90YWwgJiYgdG90YWwgPT0gcHJldmlvdXNfc3RhZ2UgKyAxCiAgICAgICAgKTsKICAgICAgICBsZXQgY2hlY2twb2ludCA9IG91dHB1dC51bndyYXAoKS5jaGVja3BvaW50OwogICAgICAgIHJ1bm5lcgogICAgICAgICAgICAudmFsaWRhdGVfZGJfYmxvY2tzKGlucHV0LmNoZWNrcG9pbnQoKS5ibG9ja19udW1iZXIsIGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyKQogICAgICAgICAgICAuZXhwZWN0KCJXcml0dGVuIGJsb2NrIGRhdGEgaW52YWxpZCIpOwoKICAgICAgICAvLyBEZWxldGUgYSB0cmFuc2FjdGlvbgogICAgICAgIGxldCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IHJ1bm5lci5kYigpLmZhY3Rvcnkuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKTsKICAgICAgICB7CiAgICAgICAgICAgIGxldCBtdXQgc3RhdGljX2ZpbGVfcHJvZHVjZXIgPQogICAgICAgICAgICAgICAgc3RhdGljX2ZpbGVfcHJvdmlkZXIubGF0ZXN0X3dyaXRlcihTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25zKS51bndyYXAoKTsKICAgICAgICAgICAgc3RhdGljX2ZpbGVfcHJvZHVjZXIucHJ1bmVfdHJhbnNhY3Rpb25zKDEsIGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyKS51bndyYXAoKTsKICAgICAgICAgICAgc3RhdGljX2ZpbGVfcHJvZHVjZXIuY29tbWl0KCkudW53cmFwKCk7CiAgICAgICAgfQogICAgICAgIC8vIFVud2luZCBhbGwgb2YgaXQKICAgICAgICBsZXQgdW53aW5kX3RvID0gMTsKICAgICAgICBsZXQgaW5wdXQgPSBVbndpbmRJbnB1dCB7IGJhZF9ibG9jazogTm9uZSwgY2hlY2twb2ludCwgdW53aW5kX3RvIH07CiAgICAgICAgbGV0IHJlcyA9IHJ1bm5lci51bndpbmQoaW5wdXQpLmF3YWl0OwogICAgICAgIGFzc2VydF9tYXRjaGVzISgKICAgICAgICAgICAgcmVzLAogICAgICAgICAgICBPayhVbndpbmRPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiAxLAogICAgICAgICAgICAgICAgc3RhZ2VfY2hlY2twb2ludDogU29tZShTdGFnZVVuaXRDaGVja3BvaW50OjpFbnRpdGllcyhFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZDogMSwKICAgICAgICAgICAgICAgICAgICB0b3RhbAogICAgICAgICAgICAgICAgfSkpCiAgICAgICAgICAgIH19KSBpZiB0b3RhbCA9PSBwcmV2aW91c19zdGFnZSArIDEKICAgICAgICApOwoKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEocnVubmVyLnZhbGlkYXRlX3Vud2luZChpbnB1dCksIE9rKF8pLCAidW53aW5kIHZhbGlkYXRpb24iKTsKICAgIH0KCiAgICBtb2QgdGVzdF91dGlscyB7CiAgICAgICAgdXNlIGNyYXRlOjp7CiAgICAgICAgICAgIHN0YWdlczo6Ym9kaWVzOjpCb2R5U3RhZ2UsCiAgICAgICAgICAgIHRlc3RfdXRpbHM6OnsKICAgICAgICAgICAgICAgIEV4ZWN1dGVTdGFnZVRlc3RSdW5uZXIsIFN0YWdlVGVzdFJ1bm5lciwgVGVzdFJ1bm5lckVycm9yLCBUZXN0U3RhZ2VEQiwKICAgICAgICAgICAgICAgIFVud2luZFN0YWdlVGVzdFJ1bm5lciwKICAgICAgICAgICAgfSwKICAgICAgICB9OwogICAgICAgIHVzZSBhbGxveV9jb25zZW5zdXM6OntCbG9ja0hlYWRlciwgSGVhZGVyfTsKICAgICAgICB1c2UgYWxsb3lfcHJpbWl0aXZlczo6e0Jsb2NrTnVtYmVyLCBUeE51bWJlciwgQjI1Nn07CiAgICAgICAgdXNlIGZ1dHVyZXNfdXRpbDo6U3RyZWFtOwogICAgICAgIHVzZSByZXRoX2RiOjp7c3RhdGljX2ZpbGU6OkhlYWRlcldpdGhIYXNoTWFzaywgdGFibGVzfTsKICAgICAgICB1c2UgcmV0aF9kYl9hcGk6OnsKICAgICAgICAgICAgY3Vyc29yOjpEYkN1cnNvclJPLAogICAgICAgICAgICBtb2RlbHM6OntTdG9yZWRCbG9ja0JvZHlJbmRpY2VzLCBTdG9yZWRCbG9ja09tbWVyc30sCiAgICAgICAgICAgIHRyYW5zYWN0aW9uOjp7RGJUeCwgRGJUeE11dH0sCiAgICAgICAgfTsKICAgICAgICB1c2UgcmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjp7QmxvY2ssIEJsb2NrQm9keX07CiAgICAgICAgdXNlIHJldGhfbmV0d29ya19wMnA6OnsKICAgICAgICAgICAgYm9kaWVzOjp7CiAgICAgICAgICAgICAgICBkb3dubG9hZGVyOjp7Qm9keURvd25sb2FkZXIsIEJvZHlEb3dubG9hZGVyUmVzdWx0fSwKICAgICAgICAgICAgICAgIHJlc3BvbnNlOjpCbG9ja1Jlc3BvbnNlLAogICAgICAgICAgICB9LAogICAgICAgICAgICBlcnJvcjo6RG93bmxvYWRSZXN1bHQsCiAgICAgICAgfTsKICAgICAgICB1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6e1NlYWxlZEJsb2NrLCBTZWFsZWRIZWFkZXJ9OwogICAgICAgIHVzZSByZXRoX3Byb3ZpZGVyOjp7CiAgICAgICAgICAgIHByb3ZpZGVyczo6U3RhdGljRmlsZVdyaXRlciwgdGVzdF91dGlsczo6TW9ja05vZGVUeXBlc1dpdGhEQiwgSGVhZGVyUHJvdmlkZXIsCiAgICAgICAgICAgIFByb3ZpZGVyRmFjdG9yeSwgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwgVHJhbnNhY3Rpb25zUHJvdmlkZXIsCiAgICAgICAgfTsKICAgICAgICB1c2UgcmV0aF9zdGFnZXNfYXBpOjp7RXhlY0lucHV0LCBFeGVjT3V0cHV0LCBVbndpbmRJbnB1dH07CiAgICAgICAgdXNlIHJldGhfc3RhdGljX2ZpbGVfdHlwZXM6OlN0YXRpY0ZpbGVTZWdtZW50OwogICAgICAgIHVzZSByZXRoX3Rlc3RpbmdfdXRpbHM6OmdlbmVyYXRvcnM6OnsKICAgICAgICAgICAgc2VsZiwgcmFuZG9tX2Jsb2NrX3JhbmdlLCByYW5kb21fc2lnbmVkX3R4LCBCbG9ja1JhbmdlUGFyYW1zLAogICAgICAgIH07CiAgICAgICAgdXNlIHN0ZDo6ewogICAgICAgICAgICBjb2xsZWN0aW9uczo6e0hhc2hNYXAsIFZlY0RlcXVlfSwKICAgICAgICAgICAgb3BzOjpSYW5nZUluY2x1c2l2ZSwKICAgICAgICAgICAgcGluOjpQaW4sCiAgICAgICAgICAgIHRhc2s6OntDb250ZXh0LCBQb2xsfSwKICAgICAgICB9OwoKICAgICAgICAvLy8gVGhlIGJsb2NrIGhhc2ggb2YgdGhlIGdlbmVzaXMgYmxvY2suCiAgICAgICAgcHViKGNyYXRlKSBjb25zdCBHRU5FU0lTX0hBU0g6IEIyNTYgPSBCMjU2OjpaRVJPOwoKICAgICAgICAvLy8gQSBoZWxwZXIgdG8gY3JlYXRlIGEgY29sbGVjdGlvbiBvZiBibG9jayBib2RpZXMga2V5ZWQgYnkgdGhlaXIgaGFzaC4KICAgICAgICBwdWIoY3JhdGUpIGZuIGJvZHlfYnlfaGFzaChibG9jazogJlNlYWxlZEJsb2NrPEJsb2NrPikgLT4gKEIyNTYsIEJsb2NrQm9keSkgewogICAgICAgICAgICAoYmxvY2suaGFzaCgpLCBibG9jay5ib2R5KCkuY2xvbmUoKSkKICAgICAgICB9CgogICAgICAgIC8vLyBBIGhlbHBlciBzdHJ1Y3QgZm9yIHJ1bm5pbmcgdGhlIFtgQm9keVN0YWdlYF0uCiAgICAgICAgcHViKGNyYXRlKSBzdHJ1Y3QgQm9keVRlc3RSdW5uZXIgewogICAgICAgICAgICByZXNwb25zZXM6IEhhc2hNYXA8QjI1NiwgQmxvY2tCb2R5PiwKICAgICAgICAgICAgZGI6IFRlc3RTdGFnZURCLAogICAgICAgICAgICBiYXRjaF9zaXplOiB1NjQsCiAgICAgICAgfQoKICAgICAgICBpbXBsIERlZmF1bHQgZm9yIEJvZHlUZXN0UnVubmVyIHsKICAgICAgICAgICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgICAgICAgICAgU2VsZiB7IHJlc3BvbnNlczogSGFzaE1hcDo6ZGVmYXVsdCgpLCBkYjogVGVzdFN0YWdlREI6OmRlZmF1bHQoKSwgYmF0Y2hfc2l6ZTogMTAwMCB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGwgQm9keVRlc3RSdW5uZXIgewogICAgICAgICAgICBwdWIoY3JhdGUpIGZuIHNldF9iYXRjaF9zaXplKCZtdXQgc2VsZiwgYmF0Y2hfc2l6ZTogdTY0KSB7CiAgICAgICAgICAgICAgICBzZWxmLmJhdGNoX3NpemUgPSBiYXRjaF9zaXplOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwdWIoY3JhdGUpIGZuIHNldF9yZXNwb25zZXMoJm11dCBzZWxmLCByZXNwb25zZXM6IEhhc2hNYXA8QjI1NiwgQmxvY2tCb2R5PikgewogICAgICAgICAgICAgICAgc2VsZi5yZXNwb25zZXMgPSByZXNwb25zZXM7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGwgU3RhZ2VUZXN0UnVubmVyIGZvciBCb2R5VGVzdFJ1bm5lciB7CiAgICAgICAgICAgIHR5cGUgUyA9IEJvZHlTdGFnZTxUZXN0Qm9keURvd25sb2FkZXI+OwoKICAgICAgICAgICAgZm4gZGIoJnNlbGYpIC0+ICZUZXN0U3RhZ2VEQiB7CiAgICAgICAgICAgICAgICAmc2VsZi5kYgogICAgICAgICAgICB9CgogICAgICAgICAgICBmbiBzdGFnZSgmc2VsZikgLT4gU2VsZjo6UyB7CiAgICAgICAgICAgICAgICBCb2R5U3RhZ2U6Om5ldyhUZXN0Qm9keURvd25sb2FkZXI6Om5ldygKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLmZhY3RvcnkuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlc3BvbnNlcy5jbG9uZSgpLAogICAgICAgICAgICAgICAgICAgIHNlbGYuYmF0Y2hfc2l6ZSwKICAgICAgICAgICAgICAgICkpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGwgRXhlY3V0ZVN0YWdlVGVzdFJ1bm5lciBmb3IgQm9keVRlc3RSdW5uZXIgewogICAgICAgICAgICB0eXBlIFNlZWQgPSBWZWM8U2VhbGVkQmxvY2s8QmxvY2s+PjsKCiAgICAgICAgICAgIGZuIHNlZWRfZXhlY3V0aW9uKCZtdXQgc2VsZiwgaW5wdXQ6IEV4ZWNJbnB1dCkgLT4gUmVzdWx0PFNlbGY6OlNlZWQsIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICAgICAgbGV0IHN0YXJ0ID0gaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlcjsKICAgICAgICAgICAgICAgIGxldCBlbmQgPSBpbnB1dC50YXJnZXQoKTsKCiAgICAgICAgICAgICAgICBsZXQgc3RhdGljX2ZpbGVfcHJvdmlkZXIgPSBzZWxmLmRiLmZhY3Rvcnkuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKTsKCiAgICAgICAgICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwoKICAgICAgICAgICAgICAgIC8vIFN0YXRpYyBmaWxlcyBkbyBub3Qgc3VwcG9ydCBnYXBzIGluIGhlYWRlcnMsIHNvIHdlIG5lZWQgdG8gZ2VuZXJhdGUgMCB0byBlbmQKICAgICAgICAgICAgICAgIGxldCBibG9ja3MgPSByYW5kb21fYmxvY2tfcmFuZ2UoCiAgICAgICAgICAgICAgICAgICAgJm11dCBybmcsCiAgICAgICAgICAgICAgICAgICAgMC4uPWVuZCwKICAgICAgICAgICAgICAgICAgICBCbG9ja1JhbmdlUGFyYW1zIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50OiBTb21lKEdFTkVTSVNfSEFTSCksCiAgICAgICAgICAgICAgICAgICAgICAgIHR4X2NvdW50OiAwLi4yLAogICAgICAgICAgICAgICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2VsZi5kYi5pbnNlcnRfaGVhZGVycyhibG9ja3MuaXRlcigpLm1hcCh8YmxvY2t8IGJsb2NrLnNlYWxlZF9oZWFkZXIoKSkpPzsKICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKHByb2dyZXNzKSA9IGJsb2Nrcy5nZXQoc3RhcnQgYXMgdXNpemUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbnNlcnQgbGFzdCBwcm9ncmVzcyBkYXRhCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgdHggPSBzZWxmLmRiLmZhY3RvcnkucHJvdmlkZXJfcncoKT8uaW50b190eCgpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IHN0YXRpY19maWxlX3Byb2R1Y2VyID0gc3RhdGljX2ZpbGVfcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRfd3JpdGVyKHN0YXJ0LCBTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25zKT87CgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYm9keSA9IFN0b3JlZEJsb2NrQm9keUluZGljZXMgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RfdHhfbnVtOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHhfY291bnQ6IHByb2dyZXNzLnRyYW5zYWN0aW9uX2NvdW50KCkgYXMgdTY0LAogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGljX2ZpbGVfcHJvZHVjZXIuc2V0X2Jsb2NrX3JhbmdlKDAuLj1wcm9ncmVzcy5udW1iZXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgYm9keS50eF9udW1fcmFuZ2UoKS50cnlfZm9yX2VhY2gofHR4X251bXwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRyYW5zYWN0aW9uID0gcmFuZG9tX3NpZ25lZF90eCgmbXV0IHJuZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0aWNfZmlsZV9wcm9kdWNlci5hcHBlbmRfdHJhbnNhY3Rpb24odHhfbnVtLCAmdHJhbnNhY3Rpb24pLm1hcChkcm9wKQogICAgICAgICAgICAgICAgICAgICAgICB9KT87CgogICAgICAgICAgICAgICAgICAgICAgICBpZiBib2R5LnR4X2NvdW50ICE9IDAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpUcmFuc2FjdGlvbkJsb2Nrcz4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9keS5sYXN0X3R4X251bSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzLm51bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICk/OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OkJsb2NrQm9keUluZGljZXM+KHByb2dyZXNzLm51bWJlciwgYm9keSk/OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgIXByb2dyZXNzLm9tbWVyc19oYXNoX2lzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpCbG9ja09tbWVycz4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MubnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0b3JlZEJsb2NrT21tZXJzIHsgb21tZXJzOiBwcm9ncmVzcy5ib2R5KCkub21tZXJzLmNsb25lKCkgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICk/OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBzdGF0aWNfZmlsZV9wcm9kdWNlci5jb21taXQoKT87CiAgICAgICAgICAgICAgICAgICAgICAgIHR4LmNvbW1pdCgpPzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWxmLnNldF9yZXNwb25zZXMoYmxvY2tzLml0ZXIoKS5tYXAoYm9keV9ieV9oYXNoKS5jb2xsZWN0KCkpOwogICAgICAgICAgICAgICAgT2soYmxvY2tzKQogICAgICAgICAgICB9CgogICAgICAgICAgICBmbiB2YWxpZGF0ZV9leGVjdXRpb24oCiAgICAgICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgICAgIGlucHV0OiBFeGVjSW5wdXQsCiAgICAgICAgICAgICAgICBvdXRwdXQ6IE9wdGlvbjxFeGVjT3V0cHV0PiwKICAgICAgICAgICAgKSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICAgICAgbGV0IGhpZ2hlc3RfYmxvY2sgPSBtYXRjaCBvdXRwdXQuYXNfcmVmKCkgewogICAgICAgICAgICAgICAgICAgIFNvbWUob3V0cHV0KSA9PiBvdXRwdXQuY2hlY2twb2ludCwKICAgICAgICAgICAgICAgICAgICBOb25lID0+IGlucHV0LmNoZWNrcG9pbnQoKSwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5ibG9ja19udW1iZXI7CiAgICAgICAgICAgICAgICBzZWxmLnZhbGlkYXRlX2RiX2Jsb2NrcyhoaWdoZXN0X2Jsb2NrLCBoaWdoZXN0X2Jsb2NrKQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpbXBsIFVud2luZFN0YWdlVGVzdFJ1bm5lciBmb3IgQm9keVRlc3RSdW5uZXIgewogICAgICAgICAgICBmbiB2YWxpZGF0ZV91bndpbmQoJnNlbGYsIGlucHV0OiBVbndpbmRJbnB1dCkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgICAgIHNlbGYuZGIuZW5zdXJlX25vX2VudHJ5X2Fib3ZlOjo8dGFibGVzOjpCbG9ja0JvZHlJbmRpY2VzLCBfPigKICAgICAgICAgICAgICAgICAgICBpbnB1dC51bndpbmRfdG8sCiAgICAgICAgICAgICAgICAgICAgfGtleXwga2V5LAogICAgICAgICAgICAgICAgKT87CiAgICAgICAgICAgICAgICBzZWxmLmRiCiAgICAgICAgICAgICAgICAgICAgLmVuc3VyZV9ub19lbnRyeV9hYm92ZTo6PHRhYmxlczo6QmxvY2tPbW1lcnMsIF8+KGlucHV0LnVud2luZF90bywgfGtleXwga2V5KT87CiAgICAgICAgICAgICAgICBpZiBsZXQgU29tZShsYXN0X3R4X2lkKSA9IHNlbGYuZ2V0X2xhc3RfdHhfaWQoKT8gewogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIKICAgICAgICAgICAgICAgICAgICAgICAgLmVuc3VyZV9ub19lbnRyeV9hYm92ZTo6PHRhYmxlczo6VHJhbnNhY3Rpb25zLCBfPihsYXN0X3R4X2lkLCB8a2V5fCBrZXkpPzsKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLmVuc3VyZV9ub19lbnRyeV9hYm92ZTo6PHRhYmxlczo6VHJhbnNhY3Rpb25CbG9ja3MsIF8+KAogICAgICAgICAgICAgICAgICAgICAgICBsYXN0X3R4X2lkLAogICAgICAgICAgICAgICAgICAgICAgICB8a2V5fCBrZXksCiAgICAgICAgICAgICAgICAgICAgKT87CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBPaygoKSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaW1wbCBCb2R5VGVzdFJ1bm5lciB7CiAgICAgICAgICAgIC8vLyBHZXQgdGhlIGxhc3QgYXZhaWxhYmxlIHR4IGlkIGlmIGFueQogICAgICAgICAgICBwdWIoY3JhdGUpIGZuIGdldF9sYXN0X3R4X2lkKCZzZWxmKSAtPiBSZXN1bHQ8T3B0aW9uPFR4TnVtYmVyPiwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgICAgICBsZXQgbGFzdF9ib2R5ID0gc2VsZi5kYi5xdWVyeSh8dHh8IHsKICAgICAgICAgICAgICAgICAgICBsZXQgdiA9IHR4LmN1cnNvcl9yZWFkOjo8dGFibGVzOjpCbG9ja0JvZHlJbmRpY2VzPigpPy5sYXN0KCk/OwogICAgICAgICAgICAgICAgICAgIE9rKHYpCiAgICAgICAgICAgICAgICB9KT87CiAgICAgICAgICAgICAgICBPayhtYXRjaCBsYXN0X2JvZHkgewogICAgICAgICAgICAgICAgICAgIFNvbWUoKF8sIGJvZHkpKSBpZiBib2R5LnR4X2NvdW50ICE9IDAgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBTb21lKGJvZHkuZmlyc3RfdHhfbnVtICsgYm9keS50eF9jb3VudCAtIDEpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8gPT4gTm9uZSwKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vLyBWYWxpZGF0ZSB0aGF0IHRoZSBpbnNlcnRlZCBibG9jayBkYXRhIGlzIHZhbGlkCiAgICAgICAgICAgIHB1YihjcmF0ZSkgZm4gdmFsaWRhdGVfZGJfYmxvY2tzKAogICAgICAgICAgICAgICAgJnNlbGYsCiAgICAgICAgICAgICAgICBwcmV2X3Byb2dyZXNzOiBCbG9ja051bWJlciwKICAgICAgICAgICAgICAgIGhpZ2hlc3RfYmxvY2s6IEJsb2NrTnVtYmVyLAogICAgICAgICAgICApIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgICAgICBsZXQgc3RhdGljX2ZpbGVfcHJvdmlkZXIgPSBzZWxmLmRiLmZhY3Rvcnkuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKTsKCiAgICAgICAgICAgICAgICBzZWxmLmRiLnF1ZXJ5KHx0eHwgewogICAgICAgICAgICAgICAgICAgIC8vIEFjcXVpcmUgY3Vyc29ycyBvbiBib2R5IHJlbGF0ZWQgdGFibGVzCiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBib2RpZXNfY3Vyc29yID0gdHguY3Vyc29yX3JlYWQ6Ojx0YWJsZXM6OkJsb2NrQm9keUluZGljZXM+KCk/OwogICAgICAgICAgICAgICAgICAgIGxldCBtdXQgb21tZXJzX2N1cnNvciA9IHR4LmN1cnNvcl9yZWFkOjo8dGFibGVzOjpCbG9ja09tbWVycz4oKT87CiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCB0eF9ibG9ja19jdXJzb3IgPSB0eC5jdXJzb3JfcmVhZDo6PHRhYmxlczo6VHJhbnNhY3Rpb25CbG9ja3M+KCk/OwoKICAgICAgICAgICAgICAgICAgICBsZXQgZmlyc3RfYm9keV9rZXkgPSBtYXRjaCBib2RpZXNfY3Vyc29yLmZpcnN0KCk/IHsKICAgICAgICAgICAgICAgICAgICAgICAgU29tZSgoa2V5LCBfKSkgPT4ga2V5LAogICAgICAgICAgICAgICAgICAgICAgICBOb25lID0+IHJldHVybiBPaygoKSksCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBwcmV2X251bWJlcjogT3B0aW9uPEJsb2NrTnVtYmVyPiA9IE5vbmU7CgoKICAgICAgICAgICAgICAgICAgICBmb3IgZW50cnkgaW4gYm9kaWVzX2N1cnNvci53YWxrKFNvbWUoZmlyc3RfYm9keV9rZXkpKT8gewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgKG51bWJlciwgYm9keSkgPSBlbnRyeT87CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBWYWxpZGF0ZSBzZXF1ZW50aWFsaXR5IG9ubHkgYWZ0ZXIgcHJldiBwcm9ncmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2luY2UgdGhlIGRhdGEgYmVmb3JlIGlzIG1vY2tlZCBhbmQgY2FuIGNvbnRhaW4gZ2FwcwogICAgICAgICAgICAgICAgICAgICAgICBpZiBudW1iZXIgPiBwcmV2X3Byb2dyZXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBsZXQgU29tZShwcmV2X2tleSkgPSBwcmV2X251bWJlciB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShwcmV2X2tleSArIDEsIG51bWJlciwgIkJvZHkgZW50cmllcyBtdXN0IGJlIHNlcXVlbnRpYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFZhbGlkYXRlIHRoYXQgdGhlIGN1cnJlbnQgZW50cnkgaXMgYmVsb3cgb3IgZXF1YWxzIHRvIHRoZSBoaWdoZXN0IGFsbG93ZWQgYmxvY2sKICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0ISgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlciA8PSBoaWdoZXN0X2Jsb2NrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIldlIHdyb3RlIGEgYmxvY2sgYm9keSBvdXRzaWRlIG9mIG91ciBzeW5jZWQgcmFuZ2UuIEZvdW5kIGJsb2NrIHdpdGggbnVtYmVyIHtudW1iZXJ9LCBoaWdoZXN0IGJsb2NrIGFjY29yZGluZyB0byBzdGFnZSBpcyB7aGlnaGVzdF9ibG9ja30iLAogICAgICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGhlYWRlciA9IHN0YXRpY19maWxlX3Byb3ZpZGVyLmhlYWRlcl9ieV9udW1iZXIobnVtYmVyKT8uZXhwZWN0KCJ0byBiZSBwcmVzZW50Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFZhbGlkYXRlIHRoYXQgb21tZXJzIGV4aXN0IGlmIGFueQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgc3RvcmVkX29tbWVycyA9ICBvbW1lcnNfY3Vyc29yLnNlZWtfZXhhY3QobnVtYmVyKT87CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGhlYWRlci5vbW1lcnNfaGFzaF9pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydCEoc3RvcmVkX29tbWVycy5pc19ub25lKCksICJVbmV4cGVjdGVkIG9tbWVycyBlbnRyeSIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0IShzdG9yZWRfb21tZXJzLmlzX3NvbWUoKSwgIk1pc3Npbmcgb21tZXJzIGVudHJ5Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0eF9ibG9ja19pZCA9IHR4X2Jsb2NrX2N1cnNvci5zZWVrX2V4YWN0KGJvZHkubGFzdF90eF9udW0oKSk/Lm1hcCh8KF8sYil8IGIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiBib2R5LnR4X2NvdW50ID09IDAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0X25lISh0eF9ibG9ja19pZCxTb21lKG51bWJlcikpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0X2VxISh0eF9ibG9ja19pZCwgU29tZShudW1iZXIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHR4X2lkIGluIGJvZHkudHhfbnVtX3JhbmdlKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0IShzdGF0aWNfZmlsZV9wcm92aWRlci50cmFuc2FjdGlvbl9ieV9pZCh0eF9pZCk/LmlzX3NvbWUoKSwgIlRyYW5zYWN0aW9uIGlzIG1pc3NpbmcuIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZfbnVtYmVyID0gU29tZShudW1iZXIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBPaygoKSkKICAgICAgICAgICAgICAgIH0pPzsKICAgICAgICAgICAgICAgIE9rKCgpKQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLy8gQSBbYEJvZHlEb3dubG9hZGVyYF0gdGhhdCBpcyBiYWNrZWQgYnkgYW4gaW50ZXJuYWwgW2BIYXNoTWFwYF0gZm9yIHRlc3RpbmcuCiAgICAgICAgI1tkZXJpdmUoRGVidWcpXQogICAgICAgIHB1YihjcmF0ZSkgc3RydWN0IFRlc3RCb2R5RG93bmxvYWRlciB7CiAgICAgICAgICAgIHByb3ZpZGVyX2ZhY3Rvcnk6IFByb3ZpZGVyRmFjdG9yeTxNb2NrTm9kZVR5cGVzV2l0aERCPiwKICAgICAgICAgICAgcmVzcG9uc2VzOiBIYXNoTWFwPEIyNTYsIEJsb2NrQm9keT4sCiAgICAgICAgICAgIGhlYWRlcnM6IFZlY0RlcXVlPFNlYWxlZEhlYWRlcj4sCiAgICAgICAgICAgIGJhdGNoX3NpemU6IHU2NCwKICAgICAgICB9CgogICAgICAgIGltcGwgVGVzdEJvZHlEb3dubG9hZGVyIHsKICAgICAgICAgICAgcHViKGNyYXRlKSBmbiBuZXcoCiAgICAgICAgICAgICAgICBwcm92aWRlcl9mYWN0b3J5OiBQcm92aWRlckZhY3Rvcnk8TW9ja05vZGVUeXBlc1dpdGhEQj4sCiAgICAgICAgICAgICAgICByZXNwb25zZXM6IEhhc2hNYXA8QjI1NiwgQmxvY2tCb2R5PiwKICAgICAgICAgICAgICAgIGJhdGNoX3NpemU6IHU2NCwKICAgICAgICAgICAgKSAtPiBTZWxmIHsKICAgICAgICAgICAgICAgIFNlbGYgeyBwcm92aWRlcl9mYWN0b3J5LCByZXNwb25zZXMsIGhlYWRlcnM6IFZlY0RlcXVlOjpkZWZhdWx0KCksIGJhdGNoX3NpemUgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpbXBsIEJvZHlEb3dubG9hZGVyIGZvciBUZXN0Qm9keURvd25sb2FkZXIgewogICAgICAgICAgICB0eXBlIEJsb2NrID0gQmxvY2s7CgogICAgICAgICAgICBmbiBzZXRfZG93bmxvYWRfcmFuZ2UoCiAgICAgICAgICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgICAgICAgICByYW5nZTogUmFuZ2VJbmNsdXNpdmU8QmxvY2tOdW1iZXI+LAogICAgICAgICAgICApIC0+IERvd25sb2FkUmVzdWx0PCgpPiB7CiAgICAgICAgICAgICAgICBsZXQgc3RhdGljX2ZpbGVfcHJvdmlkZXIgPSBzZWxmLnByb3ZpZGVyX2ZhY3Rvcnkuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKTsKCiAgICAgICAgICAgICAgICBmb3IgaGVhZGVyIGluIHN0YXRpY19maWxlX3Byb3ZpZGVyLmZldGNoX3JhbmdlX2l0ZXIoCiAgICAgICAgICAgICAgICAgICAgU3RhdGljRmlsZVNlZ21lbnQ6OkhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgKnJhbmdlLnN0YXJ0KCkuLipyYW5nZS5lbmQoKSArIDEsCiAgICAgICAgICAgICAgICAgICAgfGN1cnNvciwgbnVtYmVyfCBjdXJzb3IuZ2V0X3R3bzo6PEhlYWRlcldpdGhIYXNoTWFzazxIZWFkZXI+PihudW1iZXIuaW50bygpKSwKICAgICAgICAgICAgICAgICk/IHsKICAgICAgICAgICAgICAgICAgICBpZiBsZXQgU29tZSgoaGVhZGVyLCBoYXNoKSkgPSBoZWFkZXI/IHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWFkZXJzLnB1c2hfYmFjayhTZWFsZWRIZWFkZXI6Om5ldyhoZWFkZXIsIGhhc2gpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgT2soKCkpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGwgU3RyZWFtIGZvciBUZXN0Qm9keURvd25sb2FkZXIgewogICAgICAgICAgICB0eXBlIEl0ZW0gPSBCb2R5RG93bmxvYWRlclJlc3VsdDxCbG9jaz47CiAgICAgICAgICAgIGZuIHBvbGxfbmV4dChzZWxmOiBQaW48Jm11dCBTZWxmPiwgX2N4OiAmbXV0IENvbnRleHQ8J18+KSAtPiBQb2xsPE9wdGlvbjxTZWxmOjpJdGVtPj4gewogICAgICAgICAgICAgICAgbGV0IHRoaXMgPSBzZWxmLmdldF9tdXQoKTsKCiAgICAgICAgICAgICAgICBpZiB0aGlzLmhlYWRlcnMuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KE5vbmUpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGV0IG11dCByZXNwb25zZSA9CiAgICAgICAgICAgICAgICAgICAgVmVjOjp3aXRoX2NhcGFjaXR5KHN0ZDo6Y21wOjptaW4odGhpcy5oZWFkZXJzLmxlbigpLCB0aGlzLmJhdGNoX3NpemUgYXMgdXNpemUpKTsKICAgICAgICAgICAgICAgIHdoaWxlIGxldCBTb21lKGhlYWRlcikgPSB0aGlzLmhlYWRlcnMucG9wX2Zyb250KCkgewogICAgICAgICAgICAgICAgICAgIGlmIGhlYWRlci5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UucHVzaChCbG9ja1Jlc3BvbnNlOjpFbXB0eShoZWFkZXIpKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBib2R5ID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzcG9uc2VzLnJlbW92ZSgmaGVhZGVyLmhhc2goKSkuZXhwZWN0KCJyZXF1ZXN0ZWQgdW5rbm93biBib2R5Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnB1c2goQmxvY2tSZXNwb25zZTo6RnVsbChTZWFsZWRCbG9jazo6ZnJvbV9zZWFsZWRfcGFydHMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXIsIGJvZHksCiAgICAgICAgICAgICAgICAgICAgICAgICkpKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIHJlc3BvbnNlLmxlbigpIGFzIHU2NCA+PSB0aGlzLmJhdGNoX3NpemUgewogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAhcmVzcG9uc2UuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KFNvbWUoT2socmVzcG9uc2UpKSkKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBwYW5pYyEoInJlcXVlc3RlZCBib2RpZXMgd2l0aG91dCBzZXR0aW5nIGhlYWRlcnMiKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvc3RhZ2VzL3NyYy9zdGFnZXMvZXJhLnJzIj4KdXNlIGNyYXRlOjp7U3RhZ2VDaGVja3BvaW50LCBTdGFnZUlkfTsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OntCbG9ja0hhc2gsIEJsb2NrTnVtYmVyfTsKdXNlIGZ1dHVyZXNfdXRpbDo6e1N0cmVhbSwgU3RyZWFtRXh0fTsKdXNlIHJlcXdlc3Q6OntDbGllbnQsIFVybH07CnVzZSByZXRoX2NvbmZpZzo6Y29uZmlnOjpFdGxDb25maWc7CnVzZSByZXRoX2RiX2FwaTo6e3RhYmxlOjpWYWx1ZSwgdHJhbnNhY3Rpb246OkRiVHhNdXR9Owp1c2UgcmV0aF9lcmE6Ontjb21tb246OmZpbGVfb3BzOjpTdHJlYW1SZWFkZXIsIGVyYTE6OmZpbGU6OkVyYTFSZWFkZXJ9Owp1c2UgcmV0aF9lcmFfZG93bmxvYWRlcjo6e3JlYWRfZGlyLCBFcmFDbGllbnQsIEVyYU1ldGEsIEVyYVN0cmVhbSwgRXJhU3RyZWFtQ29uZmlnfTsKdXNlIHJldGhfZXJhX3V0aWxzIGFzIGVyYTsKdXNlIHJldGhfZXRsOjpDb2xsZWN0b3I7CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjp7RnVsbEJsb2NrQm9keSwgRnVsbEJsb2NrSGVhZGVyLCBOb2RlUHJpbWl0aXZlc307CnVzZSByZXRoX3Byb3ZpZGVyOjp7CiAgICBCbG9ja1JlYWRlciwgQmxvY2tXcml0ZXIsIERCUHJvdmlkZXIsIFN0YWdlQ2hlY2twb2ludFdyaXRlciwgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwKICAgIFN0YXRpY0ZpbGVXcml0ZXIsCn07CnVzZSByZXRoX3N0YWdlc19hcGk6OntFeGVjSW5wdXQsIEV4ZWNPdXRwdXQsIFN0YWdlLCBTdGFnZUVycm9yLCBVbndpbmRJbnB1dCwgVW53aW5kT3V0cHV0fTsKdXNlIHJldGhfc3RhdGljX2ZpbGVfdHlwZXM6OlN0YXRpY0ZpbGVTZWdtZW50Owp1c2Ugc3RkOjp7CiAgICBmbXQ6OntEZWJ1ZywgRm9ybWF0dGVyfSwKICAgIGl0ZXIsCiAgICBwYXRoOjpQYXRoLAogICAgdGFzazo6e3JlYWR5LCBDb250ZXh0LCBQb2xsfSwKfTsKCnR5cGUgSXRlbTxIZWFkZXIsIEJvZHk+ID0KICAgIEJveDxkeW4gSXRlcmF0b3I8SXRlbSA9IGV5cmU6OlJlc3VsdDwoSGVhZGVyLCBCb2R5KT4+ICsgU2VuZCArIFN5bmMgKyBVbnBpbj47CnR5cGUgVGhyZWFkU2FmZUVyYVN0cmVhbTxIZWFkZXIsIEJvZHk+ID0KICAgIEJveDxkeW4gU3RyZWFtPEl0ZW0gPSBleXJlOjpSZXN1bHQ8SXRlbTxIZWFkZXIsIEJvZHk+Pj4gKyBTZW5kICsgU3luYyArIFVucGluPjsKCi8vLyBUaGUgW0VSQTFdKGh0dHBzOi8vZ2l0aHViLmNvbS9ldGgtY2xpZW50cy9lMnN0b3JlLWZvcm1hdC1zcGVjcy9ibG9iL21haW4vZm9ybWF0cy9lcmExLm1kKQovLy8gcHJlLW1lcmdlIGhpc3Rvcnkgc3RhZ2UuCi8vLwovLy8gSW1wb3J0cyBibG9jayBoZWFkZXJzIGFuZCBib2RpZXMgZnJvbSBnZW5lc2lzIHVwIHRvIHRoZSBsYXN0IHByZS1tZXJnZSBibG9jay4gUmVjZWlwdHMgYXJlCi8vLyBnZW5lcmF0ZWQgYnkgZXhlY3V0aW9uLiBFeGVjdXRpb24gaXMgbm90IGRvbmUgaW4gdGhpcyBzdGFnZS4KcHViIHN0cnVjdCBFcmFTdGFnZTxIZWFkZXIsIEJvZHksIFN0cmVhbUZhY3Rvcnk+IHsKICAgIC8vLyBUaGUgYHNvdXJjZWAgY3JlYXRlcyBgc3RyZWFtYC4KICAgIHNvdXJjZTogT3B0aW9uPFN0cmVhbUZhY3Rvcnk+LAogICAgLy8vIEEgbWFwIG9mIGJsb2NrIGhhc2ggdG8gYmxvY2sgaGVpZ2h0IGNvbGxlY3RlZCB3aGVuIHByb2Nlc3NpbmcgaGVhZGVycyBhbmQgaW5zZXJ0ZWQgaW50bwogICAgLy8vIGRhdGFiYXNlIGFmdGVyd2FyZC4KICAgIGhhc2hfY29sbGVjdG9yOiBDb2xsZWN0b3I8QmxvY2tIYXNoLCBCbG9ja051bWJlcj4sCiAgICAvLy8gTGFzdCBleHRyYWN0ZWQgaXRlcmF0b3Igb2YgYmxvY2sgYEhlYWRlcmAgYW5kIGBCb2R5YCBwYWlycy4KICAgIGl0ZW06IE9wdGlvbjxJdGVtPEhlYWRlciwgQm9keT4+LAogICAgLy8vIEEgc3RyZWFtIG9mIFtgSXRlbWBdcywgaS5lLiBpdGVyYXRvcnMgb3ZlciBibG9jayBgSGVhZGVyYCBhbmQgYEJvZHlgIHBhaXJzLgogICAgc3RyZWFtOiBPcHRpb248VGhyZWFkU2FmZUVyYVN0cmVhbTxIZWFkZXIsIEJvZHk+PiwKfQoKdHJhaXQgRXJhU3RyZWFtRmFjdG9yeTxIZWFkZXIsIEJvZHk+IHsKICAgIGZuIGNyZWF0ZShzZWxmLCBpbnB1dDogRXhlY0lucHV0KSAtPiBSZXN1bHQ8VGhyZWFkU2FmZUVyYVN0cmVhbTxIZWFkZXIsIEJvZHk+LCBTdGFnZUVycm9yPjsKfQoKaW1wbDxIZWFkZXIsIEJvZHk+IEVyYVN0cmVhbUZhY3Rvcnk8SGVhZGVyLCBCb2R5PiBmb3IgRXJhSW1wb3J0U291cmNlCndoZXJlCiAgICBIZWFkZXI6IEZ1bGxCbG9ja0hlYWRlciArIFZhbHVlLAogICAgQm9keTogRnVsbEJsb2NrQm9keTxPbW1lckhlYWRlciA9IEhlYWRlcj4sCnsKICAgIGZuIGNyZWF0ZShzZWxmLCBpbnB1dDogRXhlY0lucHV0KSAtPiBSZXN1bHQ8VGhyZWFkU2FmZUVyYVN0cmVhbTxIZWFkZXIsIEJvZHk+LCBTdGFnZUVycm9yPiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OlBhdGgocGF0aCkgPT4gU2VsZjo6Y29udmVydCgKICAgICAgICAgICAgICAgIHJlYWRfZGlyKHBhdGgsIGlucHV0Lm5leHRfYmxvY2soKSkubWFwX2Vycih8ZXwgU3RhZ2VFcnJvcjo6RmF0YWwoZS5pbnRvKCkpKT8sCiAgICAgICAgICAgICksCiAgICAgICAgICAgIFNlbGY6OlVybCh1cmwsIGZvbGRlcikgPT4gewogICAgICAgICAgICAgICAgbGV0IF8gPSByZXRoX2ZzX3V0aWw6OmNyZWF0ZV9kaXJfYWxsKCZmb2xkZXIpOwogICAgICAgICAgICAgICAgbGV0IGNsaWVudCA9IEVyYUNsaWVudDo6bmV3KENsaWVudDo6bmV3KCksIHVybCwgZm9sZGVyKTsKCiAgICAgICAgICAgICAgICBTZWxmOjpjb252ZXJ0KEVyYVN0cmVhbTo6bmV3KAogICAgICAgICAgICAgICAgICAgIGNsaWVudCwKICAgICAgICAgICAgICAgICAgICBFcmFTdHJlYW1Db25maWc6OmRlZmF1bHQoKS5zdGFydF9mcm9tKGlucHV0Lm5leHRfYmxvY2soKSksCiAgICAgICAgICAgICAgICApKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgppbXBsIEVyYUltcG9ydFNvdXJjZSB7CiAgICBmbiBjb252ZXJ0PEhlYWRlciwgQm9keT4oCiAgICAgICAgc3RyZWFtOiBpbXBsIFN0cmVhbTxJdGVtID0gZXlyZTo6UmVzdWx0PGltcGwgRXJhTWV0YSArIFNlbmQgKyBTeW5jICsgJ3N0YXRpYyArIFVucGluPj4KICAgICAgICAgICAgKyBTZW5kCiAgICAgICAgICAgICsgU3luYwogICAgICAgICAgICArICdzdGF0aWMKICAgICAgICAgICAgKyBVbnBpbiwKICAgICkgLT4gUmVzdWx0PFRocmVhZFNhZmVFcmFTdHJlYW08SGVhZGVyLCBCb2R5PiwgU3RhZ2VFcnJvcj4KICAgIHdoZXJlCiAgICAgICAgSGVhZGVyOiBGdWxsQmxvY2tIZWFkZXIgKyBWYWx1ZSwKICAgICAgICBCb2R5OiBGdWxsQmxvY2tCb2R5PE9tbWVySGVhZGVyID0gSGVhZGVyPiwKICAgIHsKICAgICAgICBPayhCb3g6Om5ldyhCb3g6OnBpbihzdHJlYW0ubWFwKHxtZXRhfCB7CiAgICAgICAgICAgIG1ldGEuYW5kX3RoZW4ofG1ldGF8IHsKICAgICAgICAgICAgICAgIGxldCBmaWxlID0gcmV0aF9mc191dGlsOjpvcGVuKG1ldGEucGF0aCgpKT87CiAgICAgICAgICAgICAgICBsZXQgcmVhZGVyID0gRXJhMVJlYWRlcjo6bmV3KGZpbGUpOwogICAgICAgICAgICAgICAgbGV0IGl0ZXIgPSByZWFkZXIuaXRlcigpOwogICAgICAgICAgICAgICAgbGV0IGl0ZXIgPSBpdGVyLm1hcChlcmE6OmRlY29kZSk7CiAgICAgICAgICAgICAgICBsZXQgaXRlciA9IGl0ZXIuY2hhaW4oCiAgICAgICAgICAgICAgICAgICAgaXRlcjo6b25jZV93aXRoKG1vdmUgfHwgbWF0Y2ggbWV0YS5tYXJrX2FzX3Byb2Nlc3NlZCgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgT2soLi4pID0+IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgIEVycihlKSA9PiBTb21lKEVycihlKSksCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAuZmxhdHRlbigpLAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBPayhCb3g6Om5ldyhpdGVyKSBhcyBJdGVtPEhlYWRlciwgQm9keT4pCiAgICAgICAgICAgIH0pCiAgICAgICAgfSkpKSkKICAgIH0KfQoKaW1wbDxIZWFkZXI6IERlYnVnLCBCb2R5OiBEZWJ1ZywgRjogRGVidWc+IERlYnVnIGZvciBFcmFTdGFnZTxIZWFkZXIsIEJvZHksIEY+IHsKICAgIGZuIGZtdCgmc2VsZiwgZjogJm11dCBGb3JtYXR0ZXI8J18+KSAtPiBzdGQ6OmZtdDo6UmVzdWx0IHsKICAgICAgICBmLmRlYnVnX3N0cnVjdCgiRXJhU3RhZ2UiKQogICAgICAgICAgICAuZmllbGQoInNvdXJjZSIsICZzZWxmLnNvdXJjZSkKICAgICAgICAgICAgLmZpZWxkKCJoYXNoX2NvbGxlY3RvciIsICZzZWxmLmhhc2hfY29sbGVjdG9yKQogICAgICAgICAgICAuZmllbGQoIml0ZW0iLCAmc2VsZi5pdGVtLmlzX3NvbWUoKSkKICAgICAgICAgICAgLmZpZWxkKCJzdHJlYW0iLCAmImR5biBTdHJlYW0iKQogICAgICAgICAgICAuZmluaXNoKCkKICAgIH0KfQoKaW1wbDxIZWFkZXIsIEJvZHksIEY+IEVyYVN0YWdlPEhlYWRlciwgQm9keSwgRj4gewogICAgLy8vIENyZWF0ZXMgYSBuZXcgW2BFcmFTdGFnZWBdLgogICAgcHViIGZuIG5ldyhzb3VyY2U6IE9wdGlvbjxGPiwgZXRsX2NvbmZpZzogRXRsQ29uZmlnKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgc291cmNlLAogICAgICAgICAgICBpdGVtOiBOb25lLAogICAgICAgICAgICBzdHJlYW06IE5vbmUsCiAgICAgICAgICAgIGhhc2hfY29sbGVjdG9yOiBDb2xsZWN0b3I6Om5ldyhldGxfY29uZmlnLmZpbGVfc2l6ZSwgZXRsX2NvbmZpZy5kaXIpLAogICAgICAgIH0KICAgIH0KfQoKaW1wbDxQcm92aWRlciwgTiwgRj4gU3RhZ2U8UHJvdmlkZXI+IGZvciBFcmFTdGFnZTxOOjpCbG9ja0hlYWRlciwgTjo6QmxvY2tCb2R5LCBGPgp3aGVyZQogICAgUHJvdmlkZXI6IERCUHJvdmlkZXI8VHg6IERiVHhNdXQ+CiAgICAgICAgKyBTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5PFByaW1pdGl2ZXMgPSBOPgogICAgICAgICsgQmxvY2tXcml0ZXI8QmxvY2sgPSBOOjpCbG9jaz4KICAgICAgICArIEJsb2NrUmVhZGVyPEJsb2NrID0gTjo6QmxvY2s+CiAgICAgICAgKyBTdGFnZUNoZWNrcG9pbnRXcml0ZXIsCiAgICBGOiBFcmFTdHJlYW1GYWN0b3J5PE46OkJsb2NrSGVhZGVyLCBOOjpCbG9ja0JvZHk+ICsgU2VuZCArIFN5bmMgKyBDbG9uZSwKICAgIE46IE5vZGVQcmltaXRpdmVzPEJsb2NrSGVhZGVyOiBWYWx1ZT4sCnsKICAgIGZuIGlkKCZzZWxmKSAtPiBTdGFnZUlkIHsKICAgICAgICBTdGFnZUlkOjpFcmEKICAgIH0KCiAgICBmbiBwb2xsX2V4ZWN1dGVfcmVhZHkoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIGN4OiAmbXV0IENvbnRleHQ8J18+LAogICAgICAgIGlucHV0OiBFeGVjSW5wdXQsCiAgICApIC0+IFBvbGw8UmVzdWx0PCgpLCBTdGFnZUVycm9yPj4gewogICAgICAgIGlmIGlucHV0LnRhcmdldF9yZWFjaGVkKCkgfHwgc2VsZi5pdGVtLmlzX3NvbWUoKSB7CiAgICAgICAgICAgIHJldHVybiBQb2xsOjpSZWFkeShPaygoKSkpOwogICAgICAgIH0KCiAgICAgICAgaWYgc2VsZi5zdHJlYW0uaXNfbm9uZSgpICYmCiAgICAgICAgICAgIGxldCBTb21lKHNvdXJjZSkgPSBzZWxmLnNvdXJjZS5jbG9uZSgpCiAgICAgICAgewogICAgICAgICAgICBzZWxmLnN0cmVhbS5yZXBsYWNlKHNvdXJjZS5jcmVhdGUoaW5wdXQpPyk7CiAgICAgICAgfQogICAgICAgIGlmIGxldCBTb21lKHN0cmVhbSkgPSAmbXV0IHNlbGYuc3RyZWFtICYmCiAgICAgICAgICAgIGxldCBTb21lKG5leHQpID0gcmVhZHkhKHN0cmVhbS5wb2xsX25leHRfdW5waW4oY3gpKQogICAgICAgICAgICAgICAgLnRyYW5zcG9zZSgpCiAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXwgU3RhZ2VFcnJvcjo6RmF0YWwoZS5pbnRvKCkpKT8KICAgICAgICB7CiAgICAgICAgICAgIHNlbGYuaXRlbS5yZXBsYWNlKG5leHQpOwogICAgICAgIH0KCiAgICAgICAgUG9sbDo6UmVhZHkoT2soKCkpKQogICAgfQoKICAgIGZuIGV4ZWN1dGUoJm11dCBzZWxmLCBwcm92aWRlcjogJlByb3ZpZGVyLCBpbnB1dDogRXhlY0lucHV0KSAtPiBSZXN1bHQ8RXhlY091dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIGxldCBoZWlnaHQgPSBpZiBsZXQgU29tZShlcmEpID0gc2VsZi5pdGVtLnRha2UoKSB7CiAgICAgICAgICAgIGxldCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IHByb3ZpZGVyLnN0YXRpY19maWxlX3Byb3ZpZGVyKCk7CgogICAgICAgICAgICAvLyBDb25zaXN0ZW5jeSBjaGVjayBvZiBleHBlY3RlZCBoZWFkZXJzIGluIHN0YXRpYyBmaWxlcyB2cyBEQiBpcyBkb25lIG9uCiAgICAgICAgICAgIC8vIHByb3ZpZGVyOjpzeW5jX2dhcCB3aGVuIHBvbGxfZXhlY3V0ZV9yZWFkeSBpcyBwb2xsZWQuCiAgICAgICAgICAgIGxldCBsYXN0X2hlYWRlcl9udW1iZXIgPSBzdGF0aWNfZmlsZV9wcm92aWRlcgogICAgICAgICAgICAgICAgLmdldF9oaWdoZXN0X3N0YXRpY19maWxlX2Jsb2NrKFN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKQogICAgICAgICAgICAgICAgLnVud3JhcF9vcl9kZWZhdWx0KCk7CgogICAgICAgICAgICAvLyBBbHRob3VnaCBoZWFkZXJzIHdlcmUgZG93bmxvYWRlZCBpbiByZXZlcnNlIG9yZGVyLCB0aGUgY29sbGVjdG9yIGl0ZXJhdGVzIGl0IGluCiAgICAgICAgICAgIC8vIGFzY2VuZGluZyBvcmRlcgogICAgICAgICAgICBsZXQgbXV0IHdyaXRlciA9IHN0YXRpY19maWxlX3Byb3ZpZGVyLmxhdGVzdF93cml0ZXIoU3RhdGljRmlsZVNlZ21lbnQ6OkhlYWRlcnMpPzsKCiAgICAgICAgICAgIGxldCBoZWlnaHQgPSBlcmE6OnByb2Nlc3NfaXRlcigKICAgICAgICAgICAgICAgIGVyYSwKICAgICAgICAgICAgICAgICZtdXQgd3JpdGVyLAogICAgICAgICAgICAgICAgcHJvdmlkZXIsCiAgICAgICAgICAgICAgICAmbXV0IHNlbGYuaGFzaF9jb2xsZWN0b3IsCiAgICAgICAgICAgICAgICBsYXN0X2hlYWRlcl9udW1iZXIuLj1pbnB1dC50YXJnZXQoKSwKICAgICAgICAgICAgKQogICAgICAgICAgICAubWFwX2Vycih8ZXwgU3RhZ2VFcnJvcjo6RmF0YWwoZS5pbnRvKCkpKT87CgogICAgICAgICAgICBpZiAhc2VsZi5oYXNoX2NvbGxlY3Rvci5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgIGVyYTo6YnVpbGRfaW5kZXgocHJvdmlkZXIsICZtdXQgc2VsZi5oYXNoX2NvbGxlY3RvcikKICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXwgU3RhZ2VFcnJvcjo6UmVjb3ZlcmFibGUoZS5pbnRvKCkpKT87CiAgICAgICAgICAgICAgICBzZWxmLmhhc2hfY29sbGVjdG9yLmNsZWFyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGVyYTo6c2F2ZV9zdGFnZV9jaGVja3BvaW50cygKICAgICAgICAgICAgICAgIHByb3ZpZGVyLAogICAgICAgICAgICAgICAgaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICAgIGlucHV0LnRhcmdldCgpLAogICAgICAgICAgICApPzsKCiAgICAgICAgICAgIGhlaWdodAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIE5vIGVyYSBmaWxlcyB0byBwcm9jZXNzLiBSZXR1cm4gdGhlIGhpZ2hlc3QgYmxvY2sgd2UncmUgYXdhcmUgb2YgdG8gYXZvaWQKICAgICAgICAgICAgLy8gbGltaXRpbmcgc3Vic2VxdWVudCBzdGFnZXMgd2l0aCBhbiBvdXRkYXRlZCBjaGVja3BvaW50LgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gd2hlbjoKICAgICAgICAgICAgLy8gMS4gRXJhIGltcG9ydCBpcyBjb21wbGV0ZSAoYWxsIHByZS1tZXJnZSBibG9ja3MgaW1wb3J0ZWQpCiAgICAgICAgICAgIC8vIDIuIE5vIGVyYSBpbXBvcnQgc291cmNlIHdhcyBjb25maWd1cmVkCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIFdlIHJldHVybiBtYXgoY2hlY2twb2ludCwgaGlnaGVzdF9oZWFkZXIsIHRhcmdldCkgdG8gZW5zdXJlIHdlIGRvbid0IHJldHVybgogICAgICAgICAgICAvLyBhIHN0YWxlIGNoZWNrcG9pbnQgdGhhdCBjb3VsZCBsaW1pdCBzdWJzZXF1ZW50IHN0YWdlcyBsaWtlIEhlYWRlcnMuCiAgICAgICAgICAgIGxldCBoaWdoZXN0X2hlYWRlciA9IHByb3ZpZGVyCiAgICAgICAgICAgICAgICAuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKQogICAgICAgICAgICAgICAgLmdldF9oaWdoZXN0X3N0YXRpY19maWxlX2Jsb2NrKFN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKQogICAgICAgICAgICAgICAgLnVud3JhcF9vcl9kZWZhdWx0KCk7CgogICAgICAgICAgICBsZXQgY2hlY2twb2ludCA9IGlucHV0LmNoZWNrcG9pbnQoKS5ibG9ja19udW1iZXI7CiAgICAgICAgICAgIGxldCBmcm9tX3RhcmdldCA9IGlucHV0LnRhcmdldC51bndyYXBfb3IoY2hlY2twb2ludCk7CgogICAgICAgICAgICBjaGVja3BvaW50Lm1heChoaWdoZXN0X2hlYWRlcikubWF4KGZyb21fdGFyZ2V0KQogICAgICAgIH07CgogICAgICAgIE9rKEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhoZWlnaHQpLCBkb25lOiBoZWlnaHQgPj0gaW5wdXQudGFyZ2V0KCkgfSkKICAgIH0KCiAgICBmbiB1bndpbmQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIF9wcm92aWRlcjogJlByb3ZpZGVyLAogICAgICAgIGlucHV0OiBVbndpbmRJbnB1dCwKICAgICkgLT4gUmVzdWx0PFVud2luZE91dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIE9rKFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQ6IGlucHV0LmNoZWNrcG9pbnQud2l0aF9ibG9ja19udW1iZXIoaW5wdXQudW53aW5kX3RvKSB9KQogICAgfQp9CgovLy8gRGVzY3JpYmVzIHdoZXJlIHRvIGdldCB0aGUgZXJhIGZpbGVzIGZyb20uCiNbZGVyaXZlKERlYnVnLCBDbG9uZSldCnB1YiBlbnVtIEVyYUltcG9ydFNvdXJjZSB7CiAgICAvLy8gUmVtb3RlIEhUVFAgYWNjZXNzaWJsZSBob3N0LgogICAgVXJsKFVybCwgQm94PFBhdGg+KSwKICAgIC8vLyBMb2NhbCBkaXJlY3RvcnkuCiAgICBQYXRoKEJveDxQYXRoPiksCn0KCmltcGwgRXJhSW1wb3J0U291cmNlIHsKICAgIC8vLyBNYXliZSBjb25zdHJ1Y3RzIGEgbmV3IGBFcmFJbXBvcnRTb3VyY2VgIGRlcGVuZGluZyBvbiB0aGUgYXJndW1lbnRzLgogICAgLy8vCiAgICAvLy8gT25seSBvbmUgb2YgYHVybGAgb3IgYHBhdGhgIHNob3VsZCBiZSBwcm92aWRlZCwgYnV0IHVwaG9sZGluZyB0aGlzIGludmFyaWFudCBpcyBkZWxlZ2F0ZWQKICAgIC8vLyBhYm92ZSBzbyB0aGF0IGJvdGggcGFyYW1ldGVycyBjYW4gYmUgYWNjZXB0ZWQuCiAgICAvLy8KICAgIC8vLyAjIEFyZ3VtZW50cwogICAgLy8vICogVGhlIGBwYXRoYCB1c2VzIGEgZGlyZWN0b3J5IGFzIHRoZSBpbXBvcnQgc291cmNlLiBJdCBhbmQgaXRzIGNvbnRlbnRzIG11c3QgYmUgcmVhZGFibGUuCiAgICAvLy8gKiBUaGUgYHVybGAgdXNlcyBhbiBIVFRQIGNsaWVudCB0byBsaXN0IGFuZCBkb3dubG9hZCBmaWxlcy4KICAgIC8vLyAqIFRoZSBgZGVmYXVsdGAgZ2l2ZXMgdGhlIGRlZmF1bHQgW2BVcmxgXSBpZiBub25lIG9mIHRoZSBwcmV2aW91cyBwYXJhbWV0ZXJzIGFyZSBwcm92aWRlZC4KICAgIC8vLyAqIEZvciBhbnkgW2BVcmxgXSB0aGUgYGZvbGRlcmAgaXMgdXNlZCBhcyB0aGUgZG93bmxvYWQgZGlyZWN0b3J5IGZvciBzdG9yaW5nIGZpbGVzCiAgICAvLy8gICB0ZW1wb3JhcmlseS4gSXQgYW5kIGl0cyBjb250ZW50cyBtdXN0IGJlIHJlYWRhYmxlIGFuZCB3cml0YWJsZS4KICAgIHB1YiBmbiBtYXliZV9uZXcoCiAgICAgICAgcGF0aDogT3B0aW9uPEJveDxQYXRoPj4sCiAgICAgICAgdXJsOiBPcHRpb248VXJsPiwKICAgICAgICBkZWZhdWx0OiBpbXBsIEZuT25jZSgpIC0+IE9wdGlvbjxVcmw+LAogICAgICAgIGZvbGRlcjogaW1wbCBGbk9uY2UoKSAtPiBCb3g8UGF0aD4sCiAgICApIC0+IE9wdGlvbjxTZWxmPiB7CiAgICAgICAgcGF0aC5tYXAoU2VsZjo6UGF0aCkub3JfZWxzZSh8fCB1cmwub3JfZWxzZShkZWZhdWx0KS5tYXAofHVybHwgU2VsZjo6VXJsKHVybCwgZm9sZGVyKCkpKSkKICAgIH0KfQoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6Oio7CiAgICB1c2UgY3JhdGU6OnRlc3RfdXRpbHM6OnsKICAgICAgICBzdGFnZV90ZXN0X3N1aXRlLCBFeGVjdXRlU3RhZ2VUZXN0UnVubmVyLCBTdGFnZVRlc3RSdW5uZXIsIFVud2luZFN0YWdlVGVzdFJ1bm5lciwKICAgIH07CiAgICB1c2UgYWxsb3lfcHJpbWl0aXZlczo6QjI1NjsKICAgIHVzZSBhc3NlcnRfbWF0Y2hlczo6YXNzZXJ0X21hdGNoZXM7CiAgICB1c2UgcmV0aF9kYl9hcGk6OnRhYmxlczsKICAgIHVzZSByZXRoX3Byb3ZpZGVyOjpCbG9ja0hhc2hSZWFkZXI7CiAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjpnZW5lcmF0b3JzOjp7c2VsZiwgcmFuZG9tX2hlYWRlcn07CiAgICB1c2UgdGVzdF9ydW5uZXI6OkVyYVRlc3RSdW5uZXI7CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfZXJhX3JhbmdlX2VuZHNfYmVsb3dfdGFyZ2V0KCkgewogICAgICAgIGxldCBlcmFfY2FwID0gMjsKICAgICAgICBsZXQgdGFyZ2V0ID0gMjAwMDA7CgogICAgICAgIGxldCBtdXQgcnVubmVyID0gRXJhVGVzdFJ1bm5lcjo6ZGVmYXVsdCgpOwoKICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgeyB0YXJnZXQ6IFNvbWUoZXJhX2NhcCksIGNoZWNrcG9pbnQ6IE5vbmUgfTsKICAgICAgICBydW5uZXIuc2VlZF9leGVjdXRpb24oaW5wdXQpLnVud3JhcCgpOwoKICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgeyB0YXJnZXQ6IFNvbWUodGFyZ2V0KSwgY2hlY2twb2ludDogTm9uZSB9OwogICAgICAgIGxldCBvdXRwdXQgPSBydW5uZXIuZXhlY3V0ZShpbnB1dCkuYXdhaXQudW53cmFwKCk7CgogICAgICAgIHJ1bm5lci5jb21taXQoKTsKCiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKAogICAgICAgICAgICBvdXRwdXQsCiAgICAgICAgICAgIE9rKEV4ZWNPdXRwdXQgewogICAgICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50IHsgYmxvY2tfbnVtYmVyLCBzdGFnZV9jaGVja3BvaW50OiBOb25lIH0sCiAgICAgICAgICAgICAgICBkb25lOiBmYWxzZQogICAgICAgICAgICB9KSBpZiBibG9ja19udW1iZXIgPT0gZXJhX2NhcAogICAgICAgICk7CgogICAgICAgIGxldCBvdXRwdXQgPSBvdXRwdXQudW53cmFwKCk7CiAgICAgICAgbGV0IHZhbGlkYXRpb25fb3V0cHV0ID0gcnVubmVyLnZhbGlkYXRlX2V4ZWN1dGlvbihpbnB1dCwgU29tZShvdXRwdXQuY2xvbmUoKSkpOwoKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEodmFsaWRhdGlvbl9vdXRwdXQsIE9rKCgpKSk7CgogICAgICAgIHJ1bm5lci50YWtlX3Jlc3BvbnNlcygpOwoKICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgeyB0YXJnZXQ6IFNvbWUodGFyZ2V0KSwgY2hlY2twb2ludDogU29tZShvdXRwdXQuY2hlY2twb2ludCkgfTsKICAgICAgICBsZXQgb3V0cHV0ID0gcnVubmVyLmV4ZWN1dGUoaW5wdXQpLmF3YWl0LnVud3JhcCgpOwoKICAgICAgICBydW5uZXIuY29tbWl0KCk7CgogICAgICAgIGFzc2VydF9tYXRjaGVzISgKICAgICAgICAgICAgb3V0cHV0LAogICAgICAgICAgICBPayhFeGVjT3V0cHV0IHsKICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludCB7IGJsb2NrX251bWJlciwgc3RhZ2VfY2hlY2twb2ludDogTm9uZSB9LAogICAgICAgICAgICAgICAgZG9uZTogdHJ1ZQogICAgICAgICAgICB9KSBpZiBibG9ja19udW1iZXIgPT0gdGFyZ2V0CiAgICAgICAgKTsKCiAgICAgICAgbGV0IHZhbGlkYXRpb25fb3V0cHV0ID0gcnVubmVyLnZhbGlkYXRlX2V4ZWN1dGlvbihpbnB1dCwgb3V0cHV0Lm9rKCkpOwoKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEodmFsaWRhdGlvbl9vdXRwdXQsIE9rKCgpKSk7CiAgICB9CgogICAgbW9kIHRlc3RfcnVubmVyIHsKICAgICAgICB1c2Ugc3VwZXI6Oio7CiAgICAgICAgdXNlIGNyYXRlOjp0ZXN0X3V0aWxzOjp7VGVzdFJ1bm5lckVycm9yLCBUZXN0U3RhZ2VEQn07CiAgICAgICAgdXNlIGFsbG95X2NvbnNlbnN1czo6e0Jsb2NrQm9keSwgSGVhZGVyfTsKICAgICAgICB1c2UgZnV0dXJlc191dGlsOjpzdHJlYW07CiAgICAgICAgdXNlIHJldGhfZGJfYXBpOjp7CiAgICAgICAgICAgIGN1cnNvcjo6RGJDdXJzb3JSTywKICAgICAgICAgICAgbW9kZWxzOjp7U3RvcmVkQmxvY2tCb2R5SW5kaWNlcywgU3RvcmVkQmxvY2tPbW1lcnN9LAogICAgICAgICAgICB0cmFuc2FjdGlvbjo6RGJUeCwKICAgICAgICB9OwogICAgICAgIHVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OlRyYW5zYWN0aW9uU2lnbmVkOwogICAgICAgIHVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjp7U2VhbGVkQmxvY2ssIFNlYWxlZEhlYWRlcn07CiAgICAgICAgdXNlIHJldGhfcHJvdmlkZXI6OntCbG9ja051bVJlYWRlciwgSGVhZGVyUHJvdmlkZXIsIFRyYW5zYWN0aW9uc1Byb3ZpZGVyfTsKICAgICAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjpnZW5lcmF0b3JzOjp7CiAgICAgICAgICAgIHJhbmRvbV9ibG9ja19yYW5nZSwgcmFuZG9tX3NpZ25lZF90eCwgQmxvY2tSYW5nZVBhcmFtcywKICAgICAgICB9OwogICAgICAgIHVzZSB0b2tpbzo6c3luYzo6d2F0Y2g7CgogICAgICAgIHB1YihjcmF0ZSkgc3RydWN0IEVyYVRlc3RSdW5uZXIgewogICAgICAgICAgICBjaGFubmVsOiAod2F0Y2g6OlNlbmRlcjxCMjU2Piwgd2F0Y2g6OlJlY2VpdmVyPEIyNTY+KSwKICAgICAgICAgICAgZGI6IFRlc3RTdGFnZURCLAogICAgICAgICAgICByZXNwb25zZXM6IE9wdGlvbjxWZWM8KEhlYWRlciwgQmxvY2tCb2R5PFRyYW5zYWN0aW9uU2lnbmVkPik+PiwKICAgICAgICB9CgogICAgICAgIGltcGwgRGVmYXVsdCBmb3IgRXJhVGVzdFJ1bm5lciB7CiAgICAgICAgICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICAgICAgICAgIFNlbGYgewogICAgICAgICAgICAgICAgICAgIGNoYW5uZWw6IHdhdGNoOjpjaGFubmVsKEIyNTY6OlpFUk8pLAogICAgICAgICAgICAgICAgICAgIGRiOiBUZXN0U3RhZ2VEQjo6ZGVmYXVsdCgpLAogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlczogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpbXBsIFN0YWdlVGVzdFJ1bm5lciBmb3IgRXJhVGVzdFJ1bm5lciB7CiAgICAgICAgICAgIHR5cGUgUyA9IEVyYVN0YWdlPEhlYWRlciwgQmxvY2tCb2R5PFRyYW5zYWN0aW9uU2lnbmVkPiwgU3R1YlJlc3BvbnNlcz47CgogICAgICAgICAgICBmbiBkYigmc2VsZikgLT4gJlRlc3RTdGFnZURCIHsKICAgICAgICAgICAgICAgICZzZWxmLmRiCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZuIHN0YWdlKCZzZWxmKSAtPiBTZWxmOjpTIHsKICAgICAgICAgICAgICAgIEVyYVN0YWdlOjpuZXcoc2VsZi5yZXNwb25zZXMuY2xvbmUoKS5tYXAoU3R1YlJlc3BvbnNlcyksIEV0bENvbmZpZzo6ZGVmYXVsdCgpKQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpbXBsIEV4ZWN1dGVTdGFnZVRlc3RSdW5uZXIgZm9yIEVyYVRlc3RSdW5uZXIgewogICAgICAgICAgICB0eXBlIFNlZWQgPSBWZWM8U2VhbGVkQmxvY2s8cmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpCbG9jaz4+OwoKICAgICAgICAgICAgZm4gc2VlZF9leGVjdXRpb24oJm11dCBzZWxmLCBpbnB1dDogRXhlY0lucHV0KSAtPiBSZXN1bHQ8U2VsZjo6U2VlZCwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgICAgICBsZXQgc3RhcnQgPSBpbnB1dC5jaGVja3BvaW50KCkuYmxvY2tfbnVtYmVyOwogICAgICAgICAgICAgICAgbGV0IGVuZCA9IGlucHV0LnRhcmdldCgpOwoKICAgICAgICAgICAgICAgIGxldCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IHNlbGYuZGIuZmFjdG9yeS5zdGF0aWNfZmlsZV9wcm92aWRlcigpOwoKICAgICAgICAgICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CgogICAgICAgICAgICAgICAgLy8gU3RhdGljIGZpbGVzIGRvIG5vdCBzdXBwb3J0IGdhcHMgaW4gaGVhZGVycywgc28gd2UgbmVlZCB0byBnZW5lcmF0ZSAwIHRvIGVuZAogICAgICAgICAgICAgICAgbGV0IGJsb2NrcyA9IHJhbmRvbV9ibG9ja19yYW5nZSgKICAgICAgICAgICAgICAgICAgICAmbXV0IHJuZywKICAgICAgICAgICAgICAgICAgICAwLi49ZW5kLAogICAgICAgICAgICAgICAgICAgIEJsb2NrUmFuZ2VQYXJhbXMgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IFNvbWUoQjI1Njo6WkVSTyksCiAgICAgICAgICAgICAgICAgICAgICAgIHR4X2NvdW50OiAwLi4yLAogICAgICAgICAgICAgICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2VsZi5kYi5pbnNlcnRfaGVhZGVycyhibG9ja3MuaXRlcigpLm1hcCh8YmxvY2t8IGJsb2NrLnNlYWxlZF9oZWFkZXIoKSkpPzsKICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKHByb2dyZXNzKSA9IGJsb2Nrcy5nZXQoc3RhcnQgYXMgdXNpemUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbnNlcnQgbGFzdCBwcm9ncmVzcyBkYXRhCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgdHggPSBzZWxmLmRiLmZhY3RvcnkucHJvdmlkZXJfcncoKT8uaW50b190eCgpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IHN0YXRpY19maWxlX3Byb2R1Y2VyID0gc3RhdGljX2ZpbGVfcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRfd3JpdGVyKHN0YXJ0LCBTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25zKT87CgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYm9keSA9IFN0b3JlZEJsb2NrQm9keUluZGljZXMgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RfdHhfbnVtOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHhfY291bnQ6IHByb2dyZXNzLnRyYW5zYWN0aW9uX2NvdW50KCkgYXMgdTY0LAogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGljX2ZpbGVfcHJvZHVjZXIuc2V0X2Jsb2NrX3JhbmdlKDAuLj1wcm9ncmVzcy5udW1iZXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgYm9keS50eF9udW1fcmFuZ2UoKS50cnlfZm9yX2VhY2gofHR4X251bXwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRyYW5zYWN0aW9uID0gcmFuZG9tX3NpZ25lZF90eCgmbXV0IHJuZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0aWNfZmlsZV9wcm9kdWNlci5hcHBlbmRfdHJhbnNhY3Rpb24odHhfbnVtLCAmdHJhbnNhY3Rpb24pLm1hcChkcm9wKQogICAgICAgICAgICAgICAgICAgICAgICB9KT87CgogICAgICAgICAgICAgICAgICAgICAgICBpZiBib2R5LnR4X2NvdW50ICE9IDAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpUcmFuc2FjdGlvbkJsb2Nrcz4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9keS5sYXN0X3R4X251bSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzLm51bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICk/OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OkJsb2NrQm9keUluZGljZXM+KHByb2dyZXNzLm51bWJlciwgYm9keSk/OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgIXByb2dyZXNzLm9tbWVyc19oYXNoX2lzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpCbG9ja09tbWVycz4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MubnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0b3JlZEJsb2NrT21tZXJzIHsgb21tZXJzOiBwcm9ncmVzcy5ib2R5KCkub21tZXJzLmNsb25lKCkgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICk/OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBzdGF0aWNfZmlsZV9wcm9kdWNlci5jb21taXQoKT87CiAgICAgICAgICAgICAgICAgICAgICAgIHR4LmNvbW1pdCgpPzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWxmLnJlc3BvbnNlcy5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgIGJsb2Nrcy5pdGVyKCkubWFwKHx2fCAodi5oZWFkZXIoKS5jbG9uZSgpLCB2LmJvZHkoKS5jbG9uZSgpKSkuY29sbGVjdCgpLAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIE9rKGJsb2NrcykKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8vIFZhbGlkYXRlIHN0b3JlZCBoZWFkZXJzIGFuZCBib2RpZXMKICAgICAgICAgICAgZm4gdmFsaWRhdGVfZXhlY3V0aW9uKAogICAgICAgICAgICAgICAgJnNlbGYsCiAgICAgICAgICAgICAgICBpbnB1dDogRXhlY0lucHV0LAogICAgICAgICAgICAgICAgb3V0cHV0OiBPcHRpb248RXhlY091dHB1dD4sCiAgICAgICAgICAgICkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgICAgIGxldCBpbml0aWFsX2NoZWNrcG9pbnQgPSBpbnB1dC5jaGVja3BvaW50KCkuYmxvY2tfbnVtYmVyOwogICAgICAgICAgICAgICAgbWF0Y2ggb3V0cHV0IHsKICAgICAgICAgICAgICAgICAgICBTb21lKG91dHB1dCkgaWYgb3V0cHV0LmNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyID4gaW5pdGlhbF9jaGVja3BvaW50ID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHByb3ZpZGVyID0gc2VsZi5kYi5mYWN0b3J5LnByb3ZpZGVyKCk/OwoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGJsb2NrX251bSBpbiBpbml0aWFsX2NoZWNrcG9pbnQuLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNoZWNrcG9pbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYmxvY2tfbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1pbihzZWxmLnJlc3BvbnNlcy5hc19yZWYoKS5tYXAofHZ8IHYubGVuKCkpLnVud3JhcF9vcl9kZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXMgQmxvY2tOdW1iZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxvb2sgdXAgdGhlIGhlYWRlciBoYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgaGFzaCA9IHByb3ZpZGVyLmJsb2NrX2hhc2goYmxvY2tfbnVtKT8uZXhwZWN0KCJubyBoZWFkZXIgaGFzaCIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHZhbGlkYXRlIHRoZSBoZWFkZXIgbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKHByb3ZpZGVyLmJsb2NrX251bWJlcihoYXNoKT8sIFNvbWUoYmxvY2tfbnVtKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdmFsaWRhdGUgdGhlIGhlYWRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGhlYWRlciA9IHByb3ZpZGVyLmhlYWRlcl9ieV9udW1iZXIoYmxvY2tfbnVtKT87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnQhKGhlYWRlci5pc19zb21lKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGhlYWRlciA9IFNlYWxlZEhlYWRlcjo6c2VhbF9zbG93KGhlYWRlci51bndyYXAoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKGhlYWRlci5oYXNoKCksIGhhc2gpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnZhbGlkYXRlX2RiX2Jsb2NrcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dC5jaGVja3BvaW50LmJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dC5jaGVja3BvaW50LmJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgKT87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8gPT4gc2VsZi5jaGVja19ub19oZWFkZXJfZW50cnlfYWJvdmUoaW5pdGlhbF9jaGVja3BvaW50KT8sCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgT2soKCkpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFzeW5jIGZuIGFmdGVyX2V4ZWN1dGlvbigmc2VsZiwgaGVhZGVyczogU2VsZjo6U2VlZCkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgICAgIGxldCB0aXAgPSBpZiBoZWFkZXJzLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgICAgIGxldCB0aXAgPSByYW5kb21faGVhZGVyKCZtdXQgZ2VuZXJhdG9yczo6cm5nKCksIDAsIE5vbmUpOwogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X2hlYWRlcnMoaXRlcjo6b25jZSgmdGlwKSk/OwogICAgICAgICAgICAgICAgICAgIHRpcC5oYXNoKCkKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaGVhZGVycy5sYXN0KCkudW53cmFwKCkuaGFzaCgpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3RpcCh0aXApOwogICAgICAgICAgICAgICAgT2soKCkpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGwgVW53aW5kU3RhZ2VUZXN0UnVubmVyIGZvciBFcmFUZXN0UnVubmVyIHsKICAgICAgICAgICAgZm4gdmFsaWRhdGVfdW53aW5kKCZzZWxmLCBfaW5wdXQ6IFVud2luZElucHV0KSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICAgICAgT2soKCkpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGwgRXJhVGVzdFJ1bm5lciB7CiAgICAgICAgICAgIHB1YihjcmF0ZSkgZm4gY2hlY2tfbm9faGVhZGVyX2VudHJ5X2Fib3ZlKAogICAgICAgICAgICAgICAgJnNlbGYsCiAgICAgICAgICAgICAgICBibG9jazogQmxvY2tOdW1iZXIsCiAgICAgICAgICAgICkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgICAgIHNlbGYuZGIKICAgICAgICAgICAgICAgICAgICAuZW5zdXJlX25vX2VudHJ5X2Fib3ZlX2J5X3ZhbHVlOjo8dGFibGVzOjpIZWFkZXJOdW1iZXJzLCBfPihibG9jaywgfHZhbHwgdmFsKT87CiAgICAgICAgICAgICAgICBzZWxmLmRiLmVuc3VyZV9ub19lbnRyeV9hYm92ZTo6PHRhYmxlczo6Q2Fub25pY2FsSGVhZGVycywgXz4oYmxvY2ssIHxrZXl8IGtleSk/OwogICAgICAgICAgICAgICAgc2VsZi5kYi5lbnN1cmVfbm9fZW50cnlfYWJvdmU6Ojx0YWJsZXM6OkhlYWRlcnMsIF8+KGJsb2NrLCB8a2V5fCBrZXkpPzsKICAgICAgICAgICAgICAgIE9rKCgpKQogICAgICAgICAgICB9CgogICAgICAgICAgICBwdWIoY3JhdGUpIGZuIHNlbmRfdGlwKCZzZWxmLCB0aXA6IEIyNTYpIHsKICAgICAgICAgICAgICAgIHNlbGYuY2hhbm5lbC4wLnNlbmQodGlwKS5leHBlY3QoImZhaWxlZCB0byBzZW5kIHRpcCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLy8gVmFsaWRhdGUgdGhhdCB0aGUgaW5zZXJ0ZWQgYmxvY2sgZGF0YSBpcyB2YWxpZAogICAgICAgICAgICBwdWIoY3JhdGUpIGZuIHZhbGlkYXRlX2RiX2Jsb2NrcygKICAgICAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICAgICAgcHJldl9wcm9ncmVzczogQmxvY2tOdW1iZXIsCiAgICAgICAgICAgICAgICBoaWdoZXN0X2Jsb2NrOiBCbG9ja051bWJlciwKICAgICAgICAgICAgKSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICAgICAgbGV0IHN0YXRpY19maWxlX3Byb3ZpZGVyID0gc2VsZi5kYi5mYWN0b3J5LnN0YXRpY19maWxlX3Byb3ZpZGVyKCk7CgogICAgICAgICAgICAgICAgc2VsZi5kYi5xdWVyeSh8dHh8IHsKICAgICAgICAgICAgICAgICAgICAvLyBBY3F1aXJlIGN1cnNvcnMgb24gYm9keSByZWxhdGVkIHRhYmxlcwogICAgICAgICAgICAgICAgICAgIGxldCBtdXQgYm9kaWVzX2N1cnNvciA9IHR4LmN1cnNvcl9yZWFkOjo8dGFibGVzOjpCbG9ja0JvZHlJbmRpY2VzPigpPzsKICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IG9tbWVyc19jdXJzb3IgPSB0eC5jdXJzb3JfcmVhZDo6PHRhYmxlczo6QmxvY2tPbW1lcnM+KCk/OwogICAgICAgICAgICAgICAgICAgIGxldCBtdXQgdHhfYmxvY2tfY3Vyc29yID0gdHguY3Vyc29yX3JlYWQ6Ojx0YWJsZXM6OlRyYW5zYWN0aW9uQmxvY2tzPigpPzsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGZpcnN0X2JvZHlfa2V5ID0gbWF0Y2ggYm9kaWVzX2N1cnNvci5maXJzdCgpPyB7CiAgICAgICAgICAgICAgICAgICAgICAgIFNvbWUoKGtleSwgXykpID0+IGtleSwKICAgICAgICAgICAgICAgICAgICAgICAgTm9uZSA9PiByZXR1cm4gT2soKCkpLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGxldCBtdXQgcHJldl9udW1iZXI6IE9wdGlvbjxCbG9ja051bWJlcj4gPSBOb25lOwoKCiAgICAgICAgICAgICAgICAgICAgZm9yIGVudHJ5IGluIGJvZGllc19jdXJzb3Iud2FsayhTb21lKGZpcnN0X2JvZHlfa2V5KSk/IHsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IChudW1iZXIsIGJvZHkpID0gZW50cnk/OwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmFsaWRhdGUgc2VxdWVudGlhbGl0eSBvbmx5IGFmdGVyIHByZXYgcHJvZ3Jlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNpbmNlIHRoZSBkYXRhIGJlZm9yZSBpcyBtb2NrZWQgYW5kIGNhbiBjb250YWluIGdhcHMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbnVtYmVyID4gcHJldl9wcm9ncmVzcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgbGV0IFNvbWUocHJldl9rZXkpID0gcHJldl9udW1iZXIgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocHJldl9rZXkgKyAxLCBudW1iZXIsICJCb2R5IGVudHJpZXMgbXVzdCBiZSBzZXF1ZW50aWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBWYWxpZGF0ZSB0aGF0IHRoZSBjdXJyZW50IGVudHJ5IGlzIGJlbG93IG9yIGVxdWFscyB0byB0aGUgaGlnaGVzdCBhbGxvd2VkIGJsb2NrCiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydCEoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIgPD0gaGlnaGVzdF9ibG9jaywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJXZSB3cm90ZSBhIGJsb2NrIGJvZHkgb3V0c2lkZSBvZiBvdXIgc3luY2VkIHJhbmdlLiBGb3VuZCBibG9jayB3aXRoIG51bWJlciB7bnVtYmVyfSwgaGlnaGVzdCBibG9jayBhY2NvcmRpbmcgdG8gc3RhZ2UgaXMge2hpZ2hlc3RfYmxvY2t9IiwKICAgICAgICAgICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBoZWFkZXIgPSBzdGF0aWNfZmlsZV9wcm92aWRlci5oZWFkZXJfYnlfbnVtYmVyKG51bWJlcik/LmV4cGVjdCgidG8gYmUgcHJlc2VudCIpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBWYWxpZGF0ZSB0aGF0IG9tbWVycyBleGlzdCBpZiBhbnkKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHN0b3JlZF9vbW1lcnMgPSAgb21tZXJzX2N1cnNvci5zZWVrX2V4YWN0KG51bWJlcik/OwogICAgICAgICAgICAgICAgICAgICAgICBpZiBoZWFkZXIub21tZXJzX2hhc2hfaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnQhKHN0b3JlZF9vbW1lcnMuaXNfbm9uZSgpLCAiVW5leHBlY3RlZCBvbW1lcnMgZW50cnkiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydCEoc3RvcmVkX29tbWVycy5pc19zb21lKCksICJNaXNzaW5nIG9tbWVycyBlbnRyeSIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgdHhfYmxvY2tfaWQgPSB0eF9ibG9ja19jdXJzb3Iuc2Vla19leGFjdChib2R5Lmxhc3RfdHhfbnVtKCkpPy5tYXAofChfLGIpfCBiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYm9keS50eF9jb3VudCA9PSAwIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9uZSEodHhfYmxvY2tfaWQsU29tZShudW1iZXIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9lcSEodHhfYmxvY2tfaWQsIFNvbWUobnVtYmVyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciB0eF9pZCBpbiBib2R5LnR4X251bV9yYW5nZSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydCEoc3RhdGljX2ZpbGVfcHJvdmlkZXIudHJhbnNhY3Rpb25fYnlfaWQodHhfaWQpPy5pc19zb21lKCksICJUcmFuc2FjdGlvbiBpcyBtaXNzaW5nLiIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBwcmV2X251bWJlciA9IFNvbWUobnVtYmVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgT2soKCkpCiAgICAgICAgICAgICAgICB9KT87CiAgICAgICAgICAgICAgICBPaygoKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcHViKGNyYXRlKSBmbiB0YWtlX3Jlc3BvbnNlcygmbXV0IHNlbGYpIHsKICAgICAgICAgICAgICAgIHNlbGYucmVzcG9uc2VzLnRha2UoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcHViKGNyYXRlKSBmbiBjb21taXQoJnNlbGYpIHsKICAgICAgICAgICAgICAgIHNlbGYuZGIuZmFjdG9yeS5zdGF0aWNfZmlsZV9wcm92aWRlcigpLmNvbW1pdCgpLnVud3JhcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAjW2Rlcml2ZShDbG9uZSldCiAgICAgICAgcHViKGNyYXRlKSBzdHJ1Y3QgU3R1YlJlc3BvbnNlcyhWZWM8KEhlYWRlciwgQmxvY2tCb2R5PFRyYW5zYWN0aW9uU2lnbmVkPik+KTsKCiAgICAgICAgaW1wbCBFcmFTdHJlYW1GYWN0b3J5PEhlYWRlciwgQmxvY2tCb2R5PFRyYW5zYWN0aW9uU2lnbmVkPj4gZm9yIFN0dWJSZXNwb25zZXMgewogICAgICAgICAgICBmbiBjcmVhdGUoCiAgICAgICAgICAgICAgICBzZWxmLAogICAgICAgICAgICAgICAgX2lucHV0OiBFeGVjSW5wdXQsCiAgICAgICAgICAgICkgLT4gUmVzdWx0PFRocmVhZFNhZmVFcmFTdHJlYW08SGVhZGVyLCBCbG9ja0JvZHk8VHJhbnNhY3Rpb25TaWduZWQ+PiwgU3RhZ2VFcnJvcj4KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV0IHN0cmVhbSA9IHN0cmVhbTo6aXRlcih2ZWMhW3NlbGYuMF0pOwoKICAgICAgICAgICAgICAgIE9rKEJveDo6bmV3KEJveDo6cGluKHN0cmVhbS5tYXAofG1ldGF8IHsKICAgICAgICAgICAgICAgICAgICBPayhCb3g6Om5ldyhtZXRhLmludG9faXRlcigpLm1hcChPaykpCiAgICAgICAgICAgICAgICAgICAgICAgIGFzIEl0ZW08SGVhZGVyLCBCbG9ja0JvZHk8VHJhbnNhY3Rpb25TaWduZWQ+PikKICAgICAgICAgICAgICAgIH0pKSkpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgc3RhZ2VfdGVzdF9zdWl0ZSEoRXJhVGVzdFJ1bm5lciwgZXJhKTsKfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvc3RhZ2VzL3N0YWdlcy9zcmMvc3RhZ2VzL2ZpbmlzaC5ycyI+CnVzZSByZXRoX3N0YWdlc19hcGk6OnsKICAgIEV4ZWNJbnB1dCwgRXhlY091dHB1dCwgU3RhZ2UsIFN0YWdlQ2hlY2twb2ludCwgU3RhZ2VFcnJvciwgU3RhZ2VJZCwgVW53aW5kSW5wdXQsIFVud2luZE91dHB1dCwKfTsKCi8vLyBUaGUgZmluaXNoIHN0YWdlLgovLy8KLy8vIFRoaXMgc3RhZ2UgZG9lcyBub3Qgd3JpdGUgYW55dGhpbmc7IGl0J3MgY2hlY2twb2ludCBpcyB1c2VkIHRvIGRlbm90ZSB0aGUgaGlnaGVzdCBmdWxseSBzeW5jZWQKLy8vIGJsb2NrLgojW2Rlcml2ZShEZWZhdWx0LCBEZWJ1ZywgQ2xvbmUpXQojW25vbl9leGhhdXN0aXZlXQpwdWIgc3RydWN0IEZpbmlzaFN0YWdlOwoKaW1wbDxQcm92aWRlcj4gU3RhZ2U8UHJvdmlkZXI+IGZvciBGaW5pc2hTdGFnZSB7CiAgICBmbiBpZCgmc2VsZikgLT4gU3RhZ2VJZCB7CiAgICAgICAgU3RhZ2VJZDo6RmluaXNoCiAgICB9CgogICAgZm4gZXhlY3V0ZSgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgX3Byb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICAgICAgaW5wdXQ6IEV4ZWNJbnB1dCwKICAgICkgLT4gUmVzdWx0PEV4ZWNPdXRwdXQsIFN0YWdlRXJyb3I+IHsKICAgICAgICBPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoaW5wdXQudGFyZ2V0KCkpLCBkb25lOiB0cnVlIH0pCiAgICB9CgogICAgZm4gdW53aW5kKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBfcHJvdmlkZXI6ICZQcm92aWRlciwKICAgICAgICBpbnB1dDogVW53aW5kSW5wdXQsCiAgICApIC0+IFJlc3VsdDxVbndpbmRPdXRwdXQsIFN0YWdlRXJyb3I+IHsKICAgICAgICBPayhVbndpbmRPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhpbnB1dC51bndpbmRfdG8pIH0pCiAgICB9Cn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdHMgewogICAgdXNlIHN1cGVyOjoqOwogICAgdXNlIGNyYXRlOjp0ZXN0X3V0aWxzOjp7CiAgICAgICAgc3RhZ2VfdGVzdF9zdWl0ZV9leHQsIEV4ZWN1dGVTdGFnZVRlc3RSdW5uZXIsIFN0YWdlVGVzdFJ1bm5lciwgVGVzdFJ1bm5lckVycm9yLAogICAgICAgIFRlc3RTdGFnZURCLCBVbndpbmRTdGFnZVRlc3RSdW5uZXIsCiAgICB9OwogICAgdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OlNlYWxlZEhlYWRlcjsKICAgIHVzZSByZXRoX3Byb3ZpZGVyOjpwcm92aWRlcnM6OlN0YXRpY0ZpbGVXcml0ZXI7CiAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjp7CiAgICAgICAgZ2VuZXJhdG9ycywKICAgICAgICBnZW5lcmF0b3JzOjp7cmFuZG9tX2hlYWRlciwgcmFuZG9tX2hlYWRlcl9yYW5nZX0sCiAgICB9OwoKICAgIHN0YWdlX3Rlc3Rfc3VpdGVfZXh0IShGaW5pc2hUZXN0UnVubmVyLCBmaW5pc2gpOwoKICAgICNbZGVyaXZlKERlZmF1bHQpXQogICAgc3RydWN0IEZpbmlzaFRlc3RSdW5uZXIgewogICAgICAgIGRiOiBUZXN0U3RhZ2VEQiwKICAgIH0KCiAgICBpbXBsIFN0YWdlVGVzdFJ1bm5lciBmb3IgRmluaXNoVGVzdFJ1bm5lciB7CiAgICAgICAgdHlwZSBTID0gRmluaXNoU3RhZ2U7CgogICAgICAgIGZuIGRiKCZzZWxmKSAtPiAmVGVzdFN0YWdlREIgewogICAgICAgICAgICAmc2VsZi5kYgogICAgICAgIH0KCiAgICAgICAgZm4gc3RhZ2UoJnNlbGYpIC0+IFNlbGY6OlMgewogICAgICAgICAgICBGaW5pc2hTdGFnZQogICAgICAgIH0KICAgIH0KCiAgICBpbXBsIEV4ZWN1dGVTdGFnZVRlc3RSdW5uZXIgZm9yIEZpbmlzaFRlc3RSdW5uZXIgewogICAgICAgIHR5cGUgU2VlZCA9IFZlYzxTZWFsZWRIZWFkZXI+OwoKICAgICAgICBmbiBzZWVkX2V4ZWN1dGlvbigmbXV0IHNlbGYsIGlucHV0OiBFeGVjSW5wdXQpIC0+IFJlc3VsdDxTZWxmOjpTZWVkLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgbGV0IHN0YXJ0ID0gaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlcjsKICAgICAgICAgICAgbGV0IG11dCBybmcgPSBnZW5lcmF0b3JzOjpybmcoKTsKICAgICAgICAgICAgbGV0IGhlYWQgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCBzdGFydCwgTm9uZSk7CiAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X2hlYWRlcnMoc3RkOjppdGVyOjpvbmNlKCZoZWFkKSk/OwoKICAgICAgICAgICAgLy8gdXNlIHByZXZpb3VzIHByb2dyZXNzIGFzIHNlZWQgc2l6ZQogICAgICAgICAgICBsZXQgZW5kID0gaW5wdXQudGFyZ2V0LnVud3JhcF9vcl9kZWZhdWx0KCkgKyAxOwoKICAgICAgICAgICAgaWYgc3RhcnQgKyAxID49IGVuZCB7CiAgICAgICAgICAgICAgICByZXR1cm4gT2soVmVjOjpkZWZhdWx0KCkpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBtdXQgaGVhZGVycyA9IHJhbmRvbV9oZWFkZXJfcmFuZ2UoJm11dCBybmcsIHN0YXJ0ICsgMS4uZW5kLCBoZWFkLmhhc2goKSk7CiAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X2hlYWRlcnMoaGVhZGVycy5pdGVyKCkpPzsKICAgICAgICAgICAgaGVhZGVycy5pbnNlcnQoMCwgaGVhZCk7CiAgICAgICAgICAgIE9rKGhlYWRlcnMpCiAgICAgICAgfQoKICAgICAgICBmbiB2YWxpZGF0ZV9leGVjdXRpb24oCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBpbnB1dDogRXhlY0lucHV0LAogICAgICAgICAgICBvdXRwdXQ6IE9wdGlvbjxFeGVjT3V0cHV0PiwKICAgICAgICApIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgIGlmIGxldCBTb21lKG91dHB1dCkgPSBvdXRwdXQgewogICAgICAgICAgICAgICAgYXNzZXJ0IShvdXRwdXQuZG9uZSwgInN0YWdlIHNob3VsZCBhbHdheXMgYmUgZG9uZSIpOwogICAgICAgICAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgICAgICAgICBvdXRwdXQuY2hlY2twb2ludC5ibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgaW5wdXQudGFyZ2V0KCksCiAgICAgICAgICAgICAgICAgICAgInN0YWdlIHByb2dyZXNzIHNob3VsZCBhbHdheXMgbWF0Y2ggcHJvZ3Jlc3Mgb2YgcHJldmlvdXMgc3RhZ2UiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0KICAgIH0KCiAgICBpbXBsIFVud2luZFN0YWdlVGVzdFJ1bm5lciBmb3IgRmluaXNoVGVzdFJ1bm5lciB7CiAgICAgICAgZm4gdmFsaWRhdGVfdW53aW5kKCZzZWxmLCBfaW5wdXQ6IFVud2luZElucHV0KSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICBPaygoKSkKICAgICAgICB9CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9zdGFnZXMvc3JjL3N0YWdlcy9oYXNoaW5nX2FjY291bnQucnMiPgp1c2UgYWxsb3lfcHJpbWl0aXZlczo6e2tlY2NhazI1NiwgQjI1Nn07CnVzZSBpdGVydG9vbHM6Okl0ZXJ0b29sczsKdXNlIHJldGhfY29uZmlnOjpjb25maWc6OntFdGxDb25maWcsIEhhc2hpbmdDb25maWd9Owp1c2UgcmV0aF9kYl9hcGk6OnsKICAgIGN1cnNvcjo6e0RiQ3Vyc29yUk8sIERiQ3Vyc29yUld9LAogICAgdGFibGVzLAogICAgdHJhbnNhY3Rpb246OntEYlR4LCBEYlR4TXV0fSwKICAgIFJhd0tleSwgUmF3VGFibGUsIFJhd1ZhbHVlLAp9Owp1c2UgcmV0aF9ldGw6OkNvbGxlY3RvcjsKdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OkFjY291bnQ7CnVzZSByZXRoX3Byb3ZpZGVyOjp7QWNjb3VudEV4dFJlYWRlciwgREJQcm92aWRlciwgSGFzaGluZ1dyaXRlciwgU3RhdHNSZWFkZXJ9Owp1c2UgcmV0aF9zdGFnZXNfYXBpOjp7CiAgICBBY2NvdW50SGFzaGluZ0NoZWNrcG9pbnQsIEVudGl0aWVzQ2hlY2twb2ludCwgRXhlY0lucHV0LCBFeGVjT3V0cHV0LCBTdGFnZSwgU3RhZ2VDaGVja3BvaW50LAogICAgU3RhZ2VFcnJvciwgU3RhZ2VJZCwgVW53aW5kSW5wdXQsIFVud2luZE91dHB1dCwKfTsKdXNlIHJldGhfc3RvcmFnZV9lcnJvcnM6OnByb3ZpZGVyOjpQcm92aWRlclJlc3VsdDsKdXNlIHN0ZDo6ewogICAgZm10OjpEZWJ1ZywKICAgIG9wczo6e1JhbmdlLCBSYW5nZUluY2x1c2l2ZX0sCiAgICBzeW5jOjptcHNjOjp7c2VsZiwgUmVjZWl2ZXJ9LAp9Owp1c2UgdHJhY2luZzo6KjsKCi8vLyBNYXhpbXVtIG51bWJlciBvZiBjaGFubmVscyB0aGF0IGNhbiBleGlzdCBpbiBtZW1vcnkuCmNvbnN0IE1BWElNVU1fQ0hBTk5FTFM6IHVzaXplID0gMTBfMDAwOwoKLy8vIE1heGltdW0gbnVtYmVyIG9mIGFjY291bnRzIHRvIGhhc2ggcGVyIHJheW9uIHdvcmtlciBqb2IuCmNvbnN0IFdPUktFUl9DSFVOS19TSVpFOiB1c2l6ZSA9IDEwMDsKCi8vLyBBY2NvdW50IGhhc2hpbmcgc3RhZ2UgaGFzaGVzIHBsYWluIGFjY291bnQuCi8vLyBUaGlzIGlzIHByZXBhcmF0aW9uIGJlZm9yZSBnZW5lcmF0aW5nIGludGVybWVkaWF0ZSBoYXNoZXMgYW5kIGNhbGN1bGF0aW5nIE1lcmtsZSB0cmVlIHJvb3QuCiNbZGVyaXZlKENsb25lLCBEZWJ1ZyldCnB1YiBzdHJ1Y3QgQWNjb3VudEhhc2hpbmdTdGFnZSB7CiAgICAvLy8gVGhlIHRocmVzaG9sZCAoaW4gbnVtYmVyIG9mIGJsb2NrcykgZm9yIHN3aXRjaGluZyBiZXR3ZWVuIGluY3JlbWVudGFsCiAgICAvLy8gaGFzaGluZyBhbmQgZnVsbCBzdG9yYWdlIGhhc2hpbmcuCiAgICBwdWIgY2xlYW5fdGhyZXNob2xkOiB1NjQsCiAgICAvLy8gVGhlIG1heGltdW0gbnVtYmVyIG9mIGFjY291bnRzIHRvIHByb2Nlc3MgYmVmb3JlIGNvbW1pdHRpbmcgZHVyaW5nIHVud2luZC4KICAgIHB1YiBjb21taXRfdGhyZXNob2xkOiB1NjQsCiAgICAvLy8gRVRMIGNvbmZpZ3VyYXRpb24KICAgIHB1YiBldGxfY29uZmlnOiBFdGxDb25maWcsCn0KCmltcGwgQWNjb3VudEhhc2hpbmdTdGFnZSB7CiAgICAvLy8gQ3JlYXRlIG5ldyBpbnN0YW5jZSBvZiBbYEFjY291bnRIYXNoaW5nU3RhZ2VgXS4KICAgIHB1YiBjb25zdCBmbiBuZXcoY29uZmlnOiBIYXNoaW5nQ29uZmlnLCBldGxfY29uZmlnOiBFdGxDb25maWcpIC0+IFNlbGYgewogICAgICAgIFNlbGYgewogICAgICAgICAgICBjbGVhbl90aHJlc2hvbGQ6IGNvbmZpZy5jbGVhbl90aHJlc2hvbGQsCiAgICAgICAgICAgIGNvbW1pdF90aHJlc2hvbGQ6IGNvbmZpZy5jb21taXRfdGhyZXNob2xkLAogICAgICAgICAgICBldGxfY29uZmlnLAogICAgICAgIH0KICAgIH0KfQoKI1tjZmcoYW55KHRlc3QsIGZlYXR1cmUgPSAidGVzdC11dGlscyIpKV0KaW1wbCBBY2NvdW50SGFzaGluZ1N0YWdlIHsKICAgIC8vLyBJbml0aWFsaXplcyB0aGUgYFBsYWluQWNjb3VudFN0YXRlYCB0YWJsZSB3aXRoIGBudW1fYWNjb3VudHNgIGhhdmluZyBzb21lIHJhbmRvbSBzdGF0ZQogICAgLy8vIGF0IHRoZSB0YXJnZXQgYmxvY2ssIHdpdGggYHR4c19yYW5nZWAgdHJhbnNhY3Rpb25zIGluIGVhY2ggYmxvY2suCiAgICAvLy8KICAgIC8vLyBQcm9jZWVkcyB0byBnbyB0byB0aGUgYEJsb2NrVHJhbnNpdGlvbkluZGV4YCBlbmQsIGdvIGJhY2sgYHRyYW5zaXRpb25zYCBhbmQgY2hhbmdlIHRoZQogICAgLy8vIGFjY291bnQgc3RhdGUgaW4gdGhlIGBBY2NvdW50Q2hhbmdlU2V0c2AgdGFibGUuCiAgICBwdWIgZm4gc2VlZDxUeDogRGJUeCArIERiVHhNdXQgKyAnc3RhdGljLCBOOiByZXRoX3Byb3ZpZGVyOjpwcm92aWRlcnM6OlByb3ZpZGVyTm9kZVR5cGVzPigKICAgICAgICBwcm92aWRlcjogJnJldGhfcHJvdmlkZXI6OkRhdGFiYXNlUHJvdmlkZXI8VHgsIE4+LAogICAgICAgIG9wdHM6IFNlZWRPcHRzLAogICAgKSAtPiBSZXN1bHQ8VmVjPChhbGxveV9wcmltaXRpdmVzOjpBZGRyZXNzLCBBY2NvdW50KT4sIFN0YWdlRXJyb3I+CiAgICB3aGVyZQogICAgICAgIE46OlByaW1pdGl2ZXM6IHJldGhfcHJpbWl0aXZlc190cmFpdHM6Ok5vZGVQcmltaXRpdmVzPAogICAgICAgICAgICBCbG9jayA9IHJldGhfZXRoZXJldW1fcHJpbWl0aXZlczo6QmxvY2ssCiAgICAgICAgICAgIEJsb2NrSGVhZGVyID0gcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6SGVhZGVyLAogICAgICAgID4sCiAgICB7CiAgICAgICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OlUyNTY7CiAgICAgICAgdXNlIHJldGhfZGJfYXBpOjptb2RlbHM6OkFjY291bnRCZWZvcmVUeDsKICAgICAgICB1c2UgcmV0aF9wcm92aWRlcjo6e0Jsb2NrV3JpdGVyLCBTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5LCBTdGF0aWNGaWxlV3JpdGVyfTsKICAgICAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjp7CiAgICAgICAgICAgIGdlbmVyYXRvcnMsCiAgICAgICAgICAgIGdlbmVyYXRvcnM6OntyYW5kb21fYmxvY2tfcmFuZ2UsIHJhbmRvbV9lb2FfYWNjb3VudHMsIEJsb2NrUmFuZ2VQYXJhbXN9LAogICAgICAgIH07CgogICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CgogICAgICAgIGxldCBibG9ja3MgPSByYW5kb21fYmxvY2tfcmFuZ2UoCiAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICBvcHRzLmJsb2Nrcy5jbG9uZSgpLAogICAgICAgICAgICBCbG9ja1JhbmdlUGFyYW1zIHsgcGFyZW50OiBTb21lKEIyNTY6OlpFUk8pLCB0eF9jb3VudDogb3B0cy50eHMsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgKTsKCiAgICAgICAgZm9yIGJsb2NrIGluIGJsb2NrcyB7CiAgICAgICAgICAgIHByb3ZpZGVyLmluc2VydF9ibG9jaygmYmxvY2sudHJ5X3JlY292ZXIoKS51bndyYXAoKSkudW53cmFwKCk7CiAgICAgICAgfQogICAgICAgIHByb3ZpZGVyCiAgICAgICAgICAgIC5zdGF0aWNfZmlsZV9wcm92aWRlcigpCiAgICAgICAgICAgIC5sYXRlc3Rfd3JpdGVyKHJldGhfc3RhdGljX2ZpbGVfdHlwZXM6OlN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKQogICAgICAgICAgICAudW53cmFwKCkKICAgICAgICAgICAgLmNvbW1pdCgpCiAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICBsZXQgbXV0IGFjY291bnRzID0gcmFuZG9tX2VvYV9hY2NvdW50cygmbXV0IHJuZywgb3B0cy5hY2NvdW50cyk7CiAgICAgICAgewogICAgICAgICAgICAvLyBBY2NvdW50IFN0YXRlIGdlbmVyYXRvcgogICAgICAgICAgICBsZXQgbXV0IGFjY291bnRfY3Vyc29yID0KICAgICAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmN1cnNvcl93cml0ZTo6PHRhYmxlczo6UGxhaW5BY2NvdW50U3RhdGU+KCk/OwogICAgICAgICAgICBhY2NvdW50cy5zb3J0X2J5KHxhLCBifCBhLjAuY21wKCZiLjApKTsKICAgICAgICAgICAgZm9yIChhZGRyLCBhY2MpIGluICZhY2NvdW50cyB7CiAgICAgICAgICAgICAgICBhY2NvdW50X2N1cnNvci5hcHBlbmQoKmFkZHIsIGFjYyk/OwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgbXV0IGFjY19jaGFuZ2VzZXRfY3Vyc29yID0KICAgICAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmN1cnNvcl93cml0ZTo6PHRhYmxlczo6QWNjb3VudENoYW5nZVNldHM+KCk/OwogICAgICAgICAgICBmb3IgKHQsIChhZGRyLCBhY2MpKSBpbiBvcHRzLmJsb2Nrcy56aXAoJmFjY291bnRzKSB7CiAgICAgICAgICAgICAgICBsZXQgQWNjb3VudCB7IG5vbmNlLCBiYWxhbmNlLCAuLiB9ID0gYWNjOwogICAgICAgICAgICAgICAgbGV0IHByZXZfYWNjID0gQWNjb3VudCB7CiAgICAgICAgICAgICAgICAgICAgbm9uY2U6IG5vbmNlIC0gMSwKICAgICAgICAgICAgICAgICAgICBiYWxhbmNlOiBiYWxhbmNlIC0gVTI1Njo6ZnJvbSgxKSwKICAgICAgICAgICAgICAgICAgICBieXRlY29kZV9oYXNoOiBOb25lLAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGxldCBhY2NfYmVmb3JlX3R4ID0gQWNjb3VudEJlZm9yZVR4IHsgYWRkcmVzczogKmFkZHIsIGluZm86IFNvbWUocHJldl9hY2MpIH07CiAgICAgICAgICAgICAgICBhY2NfY2hhbmdlc2V0X2N1cnNvci5hcHBlbmQodCwgJmFjY19iZWZvcmVfdHgpPzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgT2soYWNjb3VudHMpCiAgICB9Cn0KCmltcGwgRGVmYXVsdCBmb3IgQWNjb3VudEhhc2hpbmdTdGFnZSB7CiAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIGNsZWFuX3RocmVzaG9sZDogNTAwXzAwMCwKICAgICAgICAgICAgY29tbWl0X3RocmVzaG9sZDogMTAwXzAwMCwKICAgICAgICAgICAgZXRsX2NvbmZpZzogRXRsQ29uZmlnOjpkZWZhdWx0KCksCiAgICAgICAgfQogICAgfQp9CgppbXBsPFByb3ZpZGVyPiBTdGFnZTxQcm92aWRlcj4gZm9yIEFjY291bnRIYXNoaW5nU3RhZ2UKd2hlcmUKICAgIFByb3ZpZGVyOiBEQlByb3ZpZGVyPFR4OiBEYlR4TXV0PiArIEhhc2hpbmdXcml0ZXIgKyBBY2NvdW50RXh0UmVhZGVyICsgU3RhdHNSZWFkZXIsCnsKICAgIC8vLyBSZXR1cm4gdGhlIGlkIG9mIHRoZSBzdGFnZQogICAgZm4gaWQoJnNlbGYpIC0+IFN0YWdlSWQgewogICAgICAgIFN0YWdlSWQ6OkFjY291bnRIYXNoaW5nCiAgICB9CgogICAgLy8vIEV4ZWN1dGUgdGhlIHN0YWdlLgogICAgZm4gZXhlY3V0ZSgmbXV0IHNlbGYsIHByb3ZpZGVyOiAmUHJvdmlkZXIsIGlucHV0OiBFeGVjSW5wdXQpIC0+IFJlc3VsdDxFeGVjT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgaWYgaW5wdXQudGFyZ2V0X3JlYWNoZWQoKSB7CiAgICAgICAgICAgIHJldHVybiBPayhFeGVjT3V0cHV0Ojpkb25lKGlucHV0LmNoZWNrcG9pbnQoKSkpCiAgICAgICAgfQoKICAgICAgICBsZXQgKGZyb21fYmxvY2ssIHRvX2Jsb2NrKSA9IGlucHV0Lm5leHRfYmxvY2tfcmFuZ2UoKS5pbnRvX2lubmVyKCk7CgogICAgICAgIC8vIGlmIHRoZXJlIGFyZSBtb3JlIGJsb2NrcyB0aGVuIHRocmVzaG9sZCBpdCBpcyBmYXN0ZXIgdG8gZ28gb3ZlciBQbGFpbiBzdGF0ZSBhbmQgaGFzaCBhbGwKICAgICAgICAvLyBhY2NvdW50IG90aGVyd2lzZSB0YWtlIGNoYW5nZXNldHMgYWdncmVnYXRlIHRoZSBzZXRzIGFuZCBhcHBseSBoYXNoaW5nIHRvCiAgICAgICAgLy8gQWNjb3VudEhhc2hpbmcgdGFibGUuIEFsc28sIGlmIHdlIHN0YXJ0IGZyb20gZ2VuZXNpcywgd2UgbmVlZCB0byBoYXNoIGZyb20gc2NyYXRjaCwgYXMKICAgICAgICAvLyBnZW5lc2lzIGFjY291bnRzIGFyZSBub3QgaW4gY2hhbmdlc2V0LgogICAgICAgIGlmIHRvX2Jsb2NrIC0gZnJvbV9ibG9jayA+IHNlbGYuY2xlYW5fdGhyZXNob2xkIHx8IGZyb21fYmxvY2sgPT0gMSB7CiAgICAgICAgICAgIGxldCB0eCA9IHByb3ZpZGVyLnR4X3JlZigpOwoKICAgICAgICAgICAgLy8gY2xlYXIgdGFibGUsIGxvYWQgYWxsIGFjY291bnRzIGFuZCBoYXNoIGl0CiAgICAgICAgICAgIHR4LmNsZWFyOjo8dGFibGVzOjpIYXNoZWRBY2NvdW50cz4oKT87CgogICAgICAgICAgICBsZXQgbXV0IGFjY291bnRzX2N1cnNvciA9IHR4LmN1cnNvcl9yZWFkOjo8UmF3VGFibGU8dGFibGVzOjpQbGFpbkFjY291bnRTdGF0ZT4+KCk/OwogICAgICAgICAgICBsZXQgbXV0IGNvbGxlY3RvciA9CiAgICAgICAgICAgICAgICBDb2xsZWN0b3I6Om5ldyhzZWxmLmV0bF9jb25maWcuZmlsZV9zaXplLCBzZWxmLmV0bF9jb25maWcuZGlyLmNsb25lKCkpOwogICAgICAgICAgICBsZXQgbXV0IGNoYW5uZWxzID0gVmVjOjp3aXRoX2NhcGFjaXR5KE1BWElNVU1fQ0hBTk5FTFMpOwoKICAgICAgICAgICAgLy8gY2hhbm5lbHMgdXNlZCB0byByZXR1cm4gcmVzdWx0IG9mIGFjY291bnQgaGFzaGluZwogICAgICAgICAgICBmb3IgY2h1bmsgaW4gJmFjY291bnRzX2N1cnNvci53YWxrKE5vbmUpPy5jaHVua3MoV09SS0VSX0NIVU5LX1NJWkUpIHsKICAgICAgICAgICAgICAgIC8vIEFuIF91bm9yZGVyZWRfIGNoYW5uZWwgdG8gcmVjZWl2ZSByZXN1bHRzIGZyb20gYSByYXlvbiBqb2IKICAgICAgICAgICAgICAgIGxldCAodHgsIHJ4KSA9IG1wc2M6OmNoYW5uZWwoKTsKICAgICAgICAgICAgICAgIGNoYW5uZWxzLnB1c2gocngpOwoKICAgICAgICAgICAgICAgIGxldCBjaHVuayA9IGNodW5rLmNvbGxlY3Q6OjxSZXN1bHQ8VmVjPF8+LCBfPj4oKT87CiAgICAgICAgICAgICAgICAvLyBTcGF3biB0aGUgaGFzaGluZyB0YXNrIG9udG8gdGhlIGdsb2JhbCByYXlvbiBwb29sCiAgICAgICAgICAgICAgICByYXlvbjo6c3Bhd24obW92ZSB8fCB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChhZGRyZXNzLCBhY2NvdW50KSBpbiBjaHVuayB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhZGRyZXNzID0gYWRkcmVzcy5rZXkoKS51bndyYXAoKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IF8gPSB0eC5zZW5kKChSYXdLZXk6Om5ldyhrZWNjYWsyNTYoYWRkcmVzcykpLCBhY2NvdW50KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gRmx1c2ggdG8gRVRMIHdoZW4gY2hhbm5lbHMgbGVuZ3RoIHJlYWNoZXMgTUFYSU1VTV9DSEFOTkVMUwogICAgICAgICAgICAgICAgaWYgIWNoYW5uZWxzLmlzX2VtcHR5KCkgJiYgY2hhbm5lbHMubGVuKCkuaXNfbXVsdGlwbGVfb2YoTUFYSU1VTV9DSEFOTkVMUykgewogICAgICAgICAgICAgICAgICAgIGNvbGxlY3QoJm11dCBjaGFubmVscywgJm11dCBjb2xsZWN0b3IpPzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29sbGVjdCgmbXV0IGNoYW5uZWxzLCAmbXV0IGNvbGxlY3Rvcik/OwoKICAgICAgICAgICAgbGV0IG11dCBoYXNoZWRfYWNjb3VudF9jdXJzb3IgPQogICAgICAgICAgICAgICAgdHguY3Vyc29yX3dyaXRlOjo8UmF3VGFibGU8dGFibGVzOjpIYXNoZWRBY2NvdW50cz4+KCk/OwoKICAgICAgICAgICAgbGV0IHRvdGFsX2hhc2hlcyA9IGNvbGxlY3Rvci5sZW4oKTsKICAgICAgICAgICAgbGV0IGludGVydmFsID0gKHRvdGFsX2hhc2hlcyAvIDEwKS5tYXgoMSk7CiAgICAgICAgICAgIGZvciAoaW5kZXgsIGl0ZW0pIGluIGNvbGxlY3Rvci5pdGVyKCk/LmVudW1lcmF0ZSgpIHsKICAgICAgICAgICAgICAgIGlmIGluZGV4ID4gMCAmJiBpbmRleC5pc19tdWx0aXBsZV9vZihpbnRlcnZhbCkgewogICAgICAgICAgICAgICAgICAgIGluZm8hKAogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6Omhhc2hpbmdfYWNjb3VudCIsCiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzID0gJWZvcm1hdCEoIns6LjJ9JSIsIChpbmRleCBhcyBmNjQgLyB0b3RhbF9oYXNoZXMgYXMgZjY0KSAqIDEwMC4wKSwKICAgICAgICAgICAgICAgICAgICAgICAgIkluc2VydGluZyBoYXNoZXMiCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBsZXQgKGtleSwgdmFsdWUpID0gaXRlbT87CiAgICAgICAgICAgICAgICBoYXNoZWRfYWNjb3VudF9jdXJzb3IKICAgICAgICAgICAgICAgICAgICAuYXBwZW5kKFJhd0tleTo6PEIyNTY+Ojpmcm9tX3ZlYyhrZXkpLCAmUmF3VmFsdWU6OjxBY2NvdW50Pjo6ZnJvbV92ZWModmFsdWUpKT87CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBBZ2dyZWdhdGUgYWxsIHRyYW5zaXRpb24gY2hhbmdlc2V0cyBhbmQgbWFrZSBhIGxpc3Qgb2YgYWNjb3VudHMgdGhhdCBoYXZlIGJlZW4KICAgICAgICAgICAgLy8gY2hhbmdlZC4KICAgICAgICAgICAgbGV0IGxpc3RzID0gcHJvdmlkZXIuY2hhbmdlZF9hY2NvdW50c193aXRoX3JhbmdlKGZyb21fYmxvY2suLj10b19ibG9jayk/OwogICAgICAgICAgICAvLyBJdGVyYXRlIG92ZXIgcGxhaW4gc3RhdGUgYW5kIGdldCBuZXdlc3QgdmFsdWUuCiAgICAgICAgICAgIC8vIEFzc3VtcHRpb24gd2UgYXJlIG9rYXkgdG8gbWFrZSBpcyB0aGF0IHBsYWluc3RhdGUgcmVwcmVzZW50CiAgICAgICAgICAgIC8vIGBwcmV2aW91c19zdGFnZV9wcm9ncmVzc2Agc3RhdGUuCiAgICAgICAgICAgIGxldCBhY2NvdW50cyA9IHByb3ZpZGVyLmJhc2ljX2FjY291bnRzKGxpc3RzKT87CiAgICAgICAgICAgIC8vIEluc2VydCBhbmQgaGFzaCBhY2NvdW50cyB0byBoYXNoaW5nIHRhYmxlCiAgICAgICAgICAgIHByb3ZpZGVyLmluc2VydF9hY2NvdW50X2Zvcl9oYXNoaW5nKGFjY291bnRzKT87CiAgICAgICAgfQoKICAgICAgICAvLyBXZSBmaW5pc2hlZCB0aGUgaGFzaGluZyBzdGFnZSwgbm8gZnV0dXJlIGl0ZXJhdGlvbnMgaXMgZXhwZWN0ZWQgZm9yIHRoZSBzYW1lIGJsb2NrIHJhbmdlLAogICAgICAgIC8vIHNvIG5vIGNoZWNrcG9pbnQgaXMgbmVlZGVkLgogICAgICAgIGxldCBjaGVja3BvaW50ID0gU3RhZ2VDaGVja3BvaW50OjpuZXcoaW5wdXQudGFyZ2V0KCkpCiAgICAgICAgICAgIC53aXRoX2FjY291bnRfaGFzaGluZ19zdGFnZV9jaGVja3BvaW50KEFjY291bnRIYXNoaW5nQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICBwcm9ncmVzczogc3RhZ2VfY2hlY2twb2ludF9wcm9ncmVzcyhwcm92aWRlcik/LAogICAgICAgICAgICAgICAgLi5EZWZhdWx0OjpkZWZhdWx0KCkKICAgICAgICAgICAgfSk7CgogICAgICAgIE9rKEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50LCBkb25lOiB0cnVlIH0pCiAgICB9CgogICAgLy8vIFVud2luZCB0aGUgc3RhZ2UuCiAgICBmbiB1bndpbmQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICAgICAgaW5wdXQ6IFVud2luZElucHV0LAogICAgKSAtPiBSZXN1bHQ8VW53aW5kT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgbGV0IChyYW5nZSwgdW53aW5kX3Byb2dyZXNzLCBfKSA9CiAgICAgICAgICAgIGlucHV0LnVud2luZF9ibG9ja19yYW5nZV93aXRoX3RocmVzaG9sZChzZWxmLmNvbW1pdF90aHJlc2hvbGQpOwoKICAgICAgICAvLyBBZ2dyZWdhdGUgYWxsIHRyYW5zaXRpb24gY2hhbmdlc2V0cyBhbmQgbWFrZSBhIGxpc3Qgb2YgYWNjb3VudHMgdGhhdCBoYXZlIGJlZW4gY2hhbmdlZC4KICAgICAgICBwcm92aWRlci51bndpbmRfYWNjb3VudF9oYXNoaW5nX3JhbmdlKHJhbmdlKT87CgogICAgICAgIGxldCBtdXQgc3RhZ2VfY2hlY2twb2ludCA9CiAgICAgICAgICAgIGlucHV0LmNoZWNrcG9pbnQuYWNjb3VudF9oYXNoaW5nX3N0YWdlX2NoZWNrcG9pbnQoKS51bndyYXBfb3JfZGVmYXVsdCgpOwoKICAgICAgICBzdGFnZV9jaGVja3BvaW50LnByb2dyZXNzID0gc3RhZ2VfY2hlY2twb2ludF9wcm9ncmVzcyhwcm92aWRlcik/OwoKICAgICAgICBPayhVbndpbmRPdXRwdXQgewogICAgICAgICAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyh1bndpbmRfcHJvZ3Jlc3MpCiAgICAgICAgICAgICAgICAud2l0aF9hY2NvdW50X2hhc2hpbmdfc3RhZ2VfY2hlY2twb2ludChzdGFnZV9jaGVja3BvaW50KSwKICAgICAgICB9KQogICAgfQp9CgovLy8gRmx1c2hlcyBjaGFubmVscyBoYXNoZXMgdG8gRVRMIGNvbGxlY3Rvci4KZm4gY29sbGVjdCgKICAgIGNoYW5uZWxzOiAmbXV0IFZlYzxSZWNlaXZlcjwoUmF3S2V5PEIyNTY+LCBSYXdWYWx1ZTxBY2NvdW50Pik+PiwKICAgIGNvbGxlY3RvcjogJm11dCBDb2xsZWN0b3I8UmF3S2V5PEIyNTY+LCBSYXdWYWx1ZTxBY2NvdW50Pj4sCikgLT4gUmVzdWx0PCgpLCBTdGFnZUVycm9yPiB7CiAgICBmb3IgY2hhbm5lbCBpbiBjaGFubmVscy5pdGVyX211dCgpIHsKICAgICAgICB3aGlsZSBsZXQgT2soKGtleSwgdikpID0gY2hhbm5lbC5yZWN2KCkgewogICAgICAgICAgICBjb2xsZWN0b3IuaW5zZXJ0KGtleSwgdik/OwogICAgICAgIH0KICAgIH0KICAgIGluZm8hKHRhcmdldDogInN5bmM6OnN0YWdlczo6aGFzaGluZ19hY2NvdW50IiwgIkhhc2hlZCB7fSBlbnRyaWVzIiwgY29sbGVjdG9yLmxlbigpKTsKICAgIGNoYW5uZWxzLmNsZWFyKCk7CiAgICBPaygoKSkKfQoKLy8gVE9ETzogUmV3cml0ZSB0aGlzCi8vLyBgU2VlZE9wdHNgIHByb3ZpZGVzIGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycyBmb3IgY2FsbGluZyBgQWNjb3VudEhhc2hpbmdTdGFnZTo6c2VlZGAKLy8vIGluIHVuaXQgdGVzdHMgb3IgYmVuY2htYXJrcyB0byBnZW5lcmF0ZSBhbiBpbml0aWFsIGRhdGFiYXNlIHN0YXRlIGZvciBydW5uaW5nIHRoZQovLy8gc3RhZ2UuCi8vLwovLy8gSW4gb3JkZXIgdG8gY2hlY2sgdGhlICJmdWxsIGhhc2hpbmciIG1vZGUgb2YgdGhlIHN0YWdlIHlvdSB3YW50IHRvIGdlbmVyYXRlIG1vcmUKLy8vIHRyYW5zaXRpb25zIHRoYW4gYEFjY291bnRIYXNoaW5nU3RhZ2UuY2xlYW5fdGhyZXNob2xkYC4gVGhpcyByZXF1aXJlczoKLy8vIDEuIENyZWF0aW5nIGVub3VnaCBibG9ja3Mgc28gdGhlcmUncyBlbm91Z2ggdHJhbnNhY3Rpb25zIHRvIGdlbmVyYXRlIHRoZSByZXF1aXJlZCB0cmFuc2l0aW9uCi8vLyAgICBrZXlzIGluIHRoZSBgQmxvY2tUcmFuc2l0aW9uSW5kZXhgICh3aGljaCBkZXBlbmRzIG9uIHRoZSBgVHhUcmFuc2l0aW9uSW5kZXhgIGludGVybmFsbHkpCi8vLyAyLiBTZXR0aW5nIGBibG9ja3MubGVuKCkgPiBjbGVhbl90aHJlc2hvbGRgIHNvIHRoYXQgdGhlcmUncyBlbm91Z2ggZGlmZnMgdG8gYWN0dWFsbHkgdGFrZSB0aGUKLy8vICAgIDJuZCBjb2RlcGF0aAojW2Rlcml2ZShDbG9uZSwgRGVidWcpXQpwdWIgc3RydWN0IFNlZWRPcHRzIHsKICAgIC8vLyBUaGUgcmFuZ2Ugb2YgYmxvY2tzIHRvIGJlIGdlbmVyYXRlZAogICAgcHViIGJsb2NrczogUmFuZ2VJbmNsdXNpdmU8dTY0PiwKICAgIC8vLyBUaGUgbnVtYmVyIG9mIGFjY291bnRzIHRvIGJlIGdlbmVyYXRlZAogICAgcHViIGFjY291bnRzOiB1c2l6ZSwKICAgIC8vLyBUaGUgcmFuZ2Ugb2YgdHJhbnNhY3Rpb25zIHRvIGJlIGdlbmVyYXRlZCBwZXIgYmxvY2suCiAgICBwdWIgdHhzOiBSYW5nZTx1OD4sCn0KCmZuIHN0YWdlX2NoZWNrcG9pbnRfcHJvZ3Jlc3MocHJvdmlkZXI6ICZpbXBsIFN0YXRzUmVhZGVyKSAtPiBQcm92aWRlclJlc3VsdDxFbnRpdGllc0NoZWNrcG9pbnQ+IHsKICAgIE9rKEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgcHJvY2Vzc2VkOiBwcm92aWRlci5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpIYXNoZWRBY2NvdW50cz4oKT8gYXMgdTY0LAogICAgICAgIHRvdGFsOiBwcm92aWRlci5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpQbGFpbkFjY291bnRTdGF0ZT4oKT8gYXMgdTY0LAogICAgfSkKfQoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6Oio7CiAgICB1c2UgY3JhdGU6OnRlc3RfdXRpbHM6OnsKICAgICAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCwgRXhlY3V0ZVN0YWdlVGVzdFJ1bm5lciwgU3RhZ2VUZXN0UnVubmVyLCBUZXN0UnVubmVyRXJyb3IsCiAgICAgICAgVW53aW5kU3RhZ2VUZXN0UnVubmVyLAogICAgfTsKICAgIHVzZSBhbGxveV9wcmltaXRpdmVzOjpVMjU2OwogICAgdXNlIGFzc2VydF9tYXRjaGVzOjphc3NlcnRfbWF0Y2hlczsKICAgIHVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjpBY2NvdW50OwogICAgdXNlIHJldGhfcHJvdmlkZXI6OnByb3ZpZGVyczo6U3RhdGljRmlsZVdyaXRlcjsKICAgIHVzZSByZXRoX3N0YWdlc19hcGk6OlN0YWdlVW5pdENoZWNrcG9pbnQ7CiAgICB1c2UgdGVzdF91dGlsczo6KjsKCiAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCEoQWNjb3VudEhhc2hpbmdUZXN0UnVubmVyLCBhY2NvdW50X2hhc2hpbmcpOwoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBleGVjdXRlX2NsZWFuX2FjY291bnRfaGFzaGluZygpIHsKICAgICAgICBsZXQgKHByZXZpb3VzX3N0YWdlLCBzdGFnZV9wcm9ncmVzcykgPSAoMjAsIDEwKTsKICAgICAgICAvLyBTZXQgdXAgdGhlIHJ1bm5lcgogICAgICAgIGxldCBtdXQgcnVubmVyID0gQWNjb3VudEhhc2hpbmdUZXN0UnVubmVyOjpkZWZhdWx0KCk7CiAgICAgICAgcnVubmVyLnNldF9jbGVhbl90aHJlc2hvbGQoMSk7CgogICAgICAgIGxldCBpbnB1dCA9IEV4ZWNJbnB1dCB7CiAgICAgICAgICAgIHRhcmdldDogU29tZShwcmV2aW91c19zdGFnZSksCiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VDaGVja3BvaW50OjpuZXcoc3RhZ2VfcHJvZ3Jlc3MpKSwKICAgICAgICB9OwoKICAgICAgICBydW5uZXIuc2VlZF9leGVjdXRpb24oaW5wdXQpLmV4cGVjdCgiZmFpbGVkIHRvIHNlZWQgZXhlY3V0aW9uIik7CgogICAgICAgIGxldCByeCA9IHJ1bm5lci5leGVjdXRlKGlucHV0KTsKICAgICAgICBsZXQgcmVzdWx0ID0gcnguYXdhaXQudW53cmFwKCk7CgogICAgICAgIGFzc2VydF9tYXRjaGVzISgKICAgICAgICAgICAgcmVzdWx0LAogICAgICAgICAgICBPayhFeGVjT3V0cHV0IHsKICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2NoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VVbml0Q2hlY2twb2ludDo6QWNjb3VudChBY2NvdW50SGFzaGluZ0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAuLgogICAgICAgICAgICAgICAgICAgIH0pKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkb25lOiB0cnVlLAogICAgICAgICAgICB9KSBpZiBibG9ja19udW1iZXIgPT0gcHJldmlvdXNfc3RhZ2UgJiYKICAgICAgICAgICAgICAgIHByb2Nlc3NlZCA9PSB0b3RhbCAmJgogICAgICAgICAgICAgICAgdG90YWwgPT0gcnVubmVyLmRiLmNvdW50X2VudHJpZXM6Ojx0YWJsZXM6OlBsYWluQWNjb3VudFN0YXRlPigpLnVud3JhcCgpIGFzIHU2NAogICAgICAgICk7CgogICAgICAgIC8vIFZhbGlkYXRlIHRoZSBzdGFnZSBleGVjdXRpb24KICAgICAgICBhc3NlcnQhKHJ1bm5lci52YWxpZGF0ZV9leGVjdXRpb24oaW5wdXQsIHJlc3VsdC5vaygpKS5pc19vaygpLCAiZXhlY3V0aW9uIHZhbGlkYXRpb24iKTsKICAgIH0KCiAgICBtb2QgdGVzdF91dGlscyB7CiAgICAgICAgdXNlIHN1cGVyOjoqOwogICAgICAgIHVzZSBjcmF0ZTo6dGVzdF91dGlsczo6VGVzdFN0YWdlREI7CiAgICAgICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkFkZHJlc3M7CiAgICAgICAgdXNlIHJldGhfcHJvdmlkZXI6OkRhdGFiYXNlUHJvdmlkZXJGYWN0b3J5OwoKICAgICAgICBwdWIoY3JhdGUpIHN0cnVjdCBBY2NvdW50SGFzaGluZ1Rlc3RSdW5uZXIgewogICAgICAgICAgICBwdWIoY3JhdGUpIGRiOiBUZXN0U3RhZ2VEQiwKICAgICAgICAgICAgY29tbWl0X3RocmVzaG9sZDogdTY0LAogICAgICAgICAgICBjbGVhbl90aHJlc2hvbGQ6IHU2NCwKICAgICAgICAgICAgZXRsX2NvbmZpZzogRXRsQ29uZmlnLAogICAgICAgIH0KCiAgICAgICAgaW1wbCBBY2NvdW50SGFzaGluZ1Rlc3RSdW5uZXIgewogICAgICAgICAgICBwdWIoY3JhdGUpIGZuIHNldF9jbGVhbl90aHJlc2hvbGQoJm11dCBzZWxmLCB0aHJlc2hvbGQ6IHU2NCkgewogICAgICAgICAgICAgICAgc2VsZi5jbGVhbl90aHJlc2hvbGQgPSB0aHJlc2hvbGQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICNbZXhwZWN0KGRlYWRfY29kZSldCiAgICAgICAgICAgIHB1YihjcmF0ZSkgZm4gc2V0X2NvbW1pdF90aHJlc2hvbGQoJm11dCBzZWxmLCB0aHJlc2hvbGQ6IHU2NCkgewogICAgICAgICAgICAgICAgc2VsZi5jb21taXRfdGhyZXNob2xkID0gdGhyZXNob2xkOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLy8gSXRlcmF0ZXMgb3ZlciBgUGxhaW5BY2NvdW50YCB0YWJsZSBhbmQgY2hlY2tzIHRoYXQgdGhlIGFjY291bnRzIG1hdGNoIHRoZSBvbmVzCiAgICAgICAgICAgIC8vLyBpbiB0aGUgYEhhc2hlZEFjY291bnRzYCB0YWJsZQogICAgICAgICAgICBwdWIoY3JhdGUpIGZuIGNoZWNrX2hhc2hlZF9hY2NvdW50cygmc2VsZikgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgICAgIHNlbGYuZGIucXVlcnkofHR4fCB7CiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBhY2NfY3Vyc29yID0gdHguY3Vyc29yX3JlYWQ6Ojx0YWJsZXM6OlBsYWluQWNjb3VudFN0YXRlPigpPzsKICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IGhhc2hlZF9hY2NfY3Vyc29yID0gdHguY3Vyc29yX3JlYWQ6Ojx0YWJsZXM6Okhhc2hlZEFjY291bnRzPigpPzsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgbGV0IFNvbWUoKGFkZHJlc3MsIGFjY291bnQpKSA9IGFjY19jdXJzb3IubmV4dCgpPyB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBoYXNoZWRfYWRkciA9IGtlY2NhazI1NihhZGRyZXNzKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUoKF8sIGFjYykpID0gaGFzaGVkX2FjY19jdXJzb3Iuc2Vla19leGFjdChoYXNoZWRfYWRkcik/IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9lcSEoYWNjLCBhY2NvdW50KQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIE9rKCgpKQogICAgICAgICAgICAgICAgfSk/OwoKICAgICAgICAgICAgICAgIE9rKCgpKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLy8gU2FtZSBhcyBgY2hlY2tfaGFzaGVkX2FjY291bnRzYCwgb25seSB0aGF0IGNoZWNrcyB3aXRoIHRoZSBvbGQgYWNjb3VudCBzdGF0ZSwKICAgICAgICAgICAgLy8vIG5hbWVseSwgdGhlIHNhbWUgYWNjb3VudCB3aXRoIG5vbmNlIC0gMSBhbmQgYmFsYW5jZSAtIDEuCiAgICAgICAgICAgIHB1YihjcmF0ZSkgZm4gY2hlY2tfb2xkX2hhc2hlZF9hY2NvdW50cygmc2VsZikgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgICAgIHNlbGYuZGIucXVlcnkofHR4fCB7CiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBhY2NfY3Vyc29yID0gdHguY3Vyc29yX3JlYWQ6Ojx0YWJsZXM6OlBsYWluQWNjb3VudFN0YXRlPigpPzsKICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IGhhc2hlZF9hY2NfY3Vyc29yID0gdHguY3Vyc29yX3JlYWQ6Ojx0YWJsZXM6Okhhc2hlZEFjY291bnRzPigpPzsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgbGV0IFNvbWUoKGFkZHJlc3MsIGFjY291bnQpKSA9IGFjY19jdXJzb3IubmV4dCgpPyB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBBY2NvdW50IHsgbm9uY2UsIGJhbGFuY2UsIC4uIH0gPSBhY2NvdW50OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgb2xkX2FjYyA9IEFjY291bnQgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9uY2U6IG5vbmNlIC0gMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhbGFuY2U6IGJhbGFuY2UgLSBVMjU2Ojpmcm9tKDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnl0ZWNvZGVfaGFzaDogTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGhhc2hlZF9hZGRyID0ga2VjY2FrMjU2KGFkZHJlc3MpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiBsZXQgU29tZSgoXywgYWNjKSkgPSBoYXNoZWRfYWNjX2N1cnNvci5zZWVrX2V4YWN0KGhhc2hlZF9hZGRyKT8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0X2VxIShhY2MsIG9sZF9hY2MpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgT2soKCkpCiAgICAgICAgICAgICAgICB9KT87CgogICAgICAgICAgICAgICAgT2soKCkpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGwgRGVmYXVsdCBmb3IgQWNjb3VudEhhc2hpbmdUZXN0UnVubmVyIHsKICAgICAgICAgICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgICAgICAgICAgU2VsZiB7CiAgICAgICAgICAgICAgICAgICAgZGI6IFRlc3RTdGFnZURCOjpkZWZhdWx0KCksCiAgICAgICAgICAgICAgICAgICAgY29tbWl0X3RocmVzaG9sZDogMTAwMCwKICAgICAgICAgICAgICAgICAgICBjbGVhbl90aHJlc2hvbGQ6IDEwMDAsCiAgICAgICAgICAgICAgICAgICAgZXRsX2NvbmZpZzogRXRsQ29uZmlnOjpkZWZhdWx0KCksCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGwgU3RhZ2VUZXN0UnVubmVyIGZvciBBY2NvdW50SGFzaGluZ1Rlc3RSdW5uZXIgewogICAgICAgICAgICB0eXBlIFMgPSBBY2NvdW50SGFzaGluZ1N0YWdlOwoKICAgICAgICAgICAgZm4gZGIoJnNlbGYpIC0+ICZUZXN0U3RhZ2VEQiB7CiAgICAgICAgICAgICAgICAmc2VsZi5kYgogICAgICAgICAgICB9CgogICAgICAgICAgICBmbiBzdGFnZSgmc2VsZikgLT4gU2VsZjo6UyB7CiAgICAgICAgICAgICAgICBTZWxmOjpTIHsKICAgICAgICAgICAgICAgICAgICBjb21taXRfdGhyZXNob2xkOiBzZWxmLmNvbW1pdF90aHJlc2hvbGQsCiAgICAgICAgICAgICAgICAgICAgY2xlYW5fdGhyZXNob2xkOiBzZWxmLmNsZWFuX3RocmVzaG9sZCwKICAgICAgICAgICAgICAgICAgICBldGxfY29uZmlnOiBzZWxmLmV0bF9jb25maWcuY2xvbmUoKSwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaW1wbCBFeGVjdXRlU3RhZ2VUZXN0UnVubmVyIGZvciBBY2NvdW50SGFzaGluZ1Rlc3RSdW5uZXIgewogICAgICAgICAgICB0eXBlIFNlZWQgPSBWZWM8KEFkZHJlc3MsIEFjY291bnQpPjsKCiAgICAgICAgICAgIGZuIHNlZWRfZXhlY3V0aW9uKCZtdXQgc2VsZiwgaW5wdXQ6IEV4ZWNJbnB1dCkgLT4gUmVzdWx0PFNlbGY6OlNlZWQsIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICAgICAgbGV0IHByb3ZpZGVyID0gc2VsZi5kYi5mYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3J3KCk/OwogICAgICAgICAgICAgICAgbGV0IHJlcyA9IE9rKEFjY291bnRIYXNoaW5nU3RhZ2U6OnNlZWQoCiAgICAgICAgICAgICAgICAgICAgJnByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgIFNlZWRPcHRzIHsgYmxvY2tzOiAwLi49aW5wdXQudGFyZ2V0KCksIGFjY291bnRzOiAxMCwgdHhzOiAwLi4zIH0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAudW53cmFwKCkpOwogICAgICAgICAgICAgICAgcHJvdmlkZXIuY29tbWl0KCkuZXhwZWN0KCJmYWlsZWQgdG8gY29tbWl0Iik7CiAgICAgICAgICAgICAgICByZXMKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm4gdmFsaWRhdGVfZXhlY3V0aW9uKAogICAgICAgICAgICAgICAgJnNlbGYsCiAgICAgICAgICAgICAgICBpbnB1dDogRXhlY0lucHV0LAogICAgICAgICAgICAgICAgb3V0cHV0OiBPcHRpb248RXhlY091dHB1dD4sCiAgICAgICAgICAgICkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKG91dHB1dCkgPSBvdXRwdXQgewogICAgICAgICAgICAgICAgICAgIGxldCBzdGFydF9ibG9jayA9IGlucHV0Lm5leHRfYmxvY2soKTsKICAgICAgICAgICAgICAgICAgICBsZXQgZW5kX2Jsb2NrID0gb3V0cHV0LmNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyOwogICAgICAgICAgICAgICAgICAgIGlmIHN0YXJ0X2Jsb2NrID4gZW5kX2Jsb2NrIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9rKCgpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbGYuY2hlY2tfaGFzaGVkX2FjY291bnRzKCkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaW1wbCBVbndpbmRTdGFnZVRlc3RSdW5uZXIgZm9yIEFjY291bnRIYXNoaW5nVGVzdFJ1bm5lciB7CiAgICAgICAgICAgIGZuIHZhbGlkYXRlX3Vud2luZCgmc2VsZiwgX2lucHV0OiBVbndpbmRJbnB1dCkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgICAgIHNlbGYuY2hlY2tfb2xkX2hhc2hlZF9hY2NvdW50cygpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9zdGFnZXMvc3JjL3N0YWdlcy9oYXNoaW5nX3N0b3JhZ2UucnMiPgp1c2UgYWxsb3lfcHJpbWl0aXZlczo6e2IyNTYsIGJ5dGVzOjpCdWZNdXQsIGtlY2NhazI1NiwgQWRkcmVzcywgQjI1Nn07CnVzZSBpdGVydG9vbHM6Okl0ZXJ0b29sczsKdXNlIHJldGhfY29uZmlnOjpjb25maWc6OntFdGxDb25maWcsIEhhc2hpbmdDb25maWd9Owp1c2UgcmV0aF9kYl9hcGk6OnsKICAgIGN1cnNvcjo6e0RiQ3Vyc29yUk8sIERiRHVwQ3Vyc29yUld9LAogICAgbW9kZWxzOjp7QmxvY2tOdW1iZXJBZGRyZXNzLCBDb21wYWN0VTI1Nn0sCiAgICB0YWJsZTo6RGVjb21wcmVzcywKICAgIHRhYmxlcywKICAgIHRyYW5zYWN0aW9uOjp7RGJUeCwgRGJUeE11dH0sCn07CnVzZSByZXRoX2V0bDo6Q29sbGVjdG9yOwp1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6U3RvcmFnZUVudHJ5Owp1c2UgcmV0aF9wcm92aWRlcjo6e0RCUHJvdmlkZXIsIEhhc2hpbmdXcml0ZXIsIFN0YXRzUmVhZGVyLCBTdG9yYWdlUmVhZGVyfTsKdXNlIHJldGhfc3RhZ2VzX2FwaTo6ewogICAgRW50aXRpZXNDaGVja3BvaW50LCBFeGVjSW5wdXQsIEV4ZWNPdXRwdXQsIFN0YWdlLCBTdGFnZUNoZWNrcG9pbnQsIFN0YWdlRXJyb3IsIFN0YWdlSWQsCiAgICBTdG9yYWdlSGFzaGluZ0NoZWNrcG9pbnQsIFVud2luZElucHV0LCBVbndpbmRPdXRwdXQsCn07CnVzZSByZXRoX3N0b3JhZ2VfZXJyb3JzOjpwcm92aWRlcjo6UHJvdmlkZXJSZXN1bHQ7CnVzZSBzdGQ6OnsKICAgIGZtdDo6RGVidWcsCiAgICBzeW5jOjptcHNjOjp7c2VsZiwgUmVjZWl2ZXJ9LAp9Owp1c2UgdHJhY2luZzo6KjsKCi8vLyBNYXhpbXVtIG51bWJlciBvZiBjaGFubmVscyB0aGF0IGNhbiBleGlzdCBpbiBtZW1vcnkuCmNvbnN0IE1BWElNVU1fQ0hBTk5FTFM6IHVzaXplID0gMTBfMDAwOwoKLy8vIE1heGltdW0gbnVtYmVyIG9mIHN0b3JhZ2UgZW50cmllcyB0byBoYXNoIHBlciByYXlvbiB3b3JrZXIgam9iLgpjb25zdCBXT1JLRVJfQ0hVTktfU0laRTogdXNpemUgPSAxMDA7CgovLy8gS2VjY2FrMjU2IGhhc2ggb2YgdGhlIHplcm8gYWRkcmVzcy4KY29uc3QgSEFTSEVEX1pFUk9fQUREUkVTUzogQjI1NiA9CiAgICBiMjU2ISgiMHg1MzgwYzdiN2FlODFhNThlYjk4ZDljNzhkZTRhMWZkN2ZkOTUzNWZjOTUzZWQyYmU2MDJkYWFhNDE3NjczMTJhIik7CgovLy8gU3RvcmFnZSBoYXNoaW5nIHN0YWdlIGhhc2hlcyBwbGFpbiBzdG9yYWdlLgovLy8gVGhpcyBpcyBwcmVwYXJhdGlvbiBiZWZvcmUgZ2VuZXJhdGluZyBpbnRlcm1lZGlhdGUgaGFzaGVzIGFuZCBjYWxjdWxhdGluZyBNZXJrbGUgdHJlZSByb290LgojW2Rlcml2ZShEZWJ1ZyldCnB1YiBzdHJ1Y3QgU3RvcmFnZUhhc2hpbmdTdGFnZSB7CiAgICAvLy8gVGhlIHRocmVzaG9sZCAoaW4gbnVtYmVyIG9mIGJsb2NrcykgZm9yIHN3aXRjaGluZyBiZXR3ZWVuIGluY3JlbWVudGFsCiAgICAvLy8gaGFzaGluZyBhbmQgZnVsbCBzdG9yYWdlIGhhc2hpbmcuCiAgICBwdWIgY2xlYW5fdGhyZXNob2xkOiB1NjQsCiAgICAvLy8gVGhlIG1heGltdW0gbnVtYmVyIG9mIHNsb3RzIHRvIHByb2Nlc3MgYmVmb3JlIGNvbW1pdHRpbmcgZHVyaW5nIHVud2luZC4KICAgIHB1YiBjb21taXRfdGhyZXNob2xkOiB1NjQsCiAgICAvLy8gRVRMIGNvbmZpZ3VyYXRpb24KICAgIHB1YiBldGxfY29uZmlnOiBFdGxDb25maWcsCn0KCmltcGwgU3RvcmFnZUhhc2hpbmdTdGFnZSB7CiAgICAvLy8gQ3JlYXRlIG5ldyBpbnN0YW5jZSBvZiBbYFN0b3JhZ2VIYXNoaW5nU3RhZ2VgXS4KICAgIHB1YiBjb25zdCBmbiBuZXcoY29uZmlnOiBIYXNoaW5nQ29uZmlnLCBldGxfY29uZmlnOiBFdGxDb25maWcpIC0+IFNlbGYgewogICAgICAgIFNlbGYgewogICAgICAgICAgICBjbGVhbl90aHJlc2hvbGQ6IGNvbmZpZy5jbGVhbl90aHJlc2hvbGQsCiAgICAgICAgICAgIGNvbW1pdF90aHJlc2hvbGQ6IGNvbmZpZy5jb21taXRfdGhyZXNob2xkLAogICAgICAgICAgICBldGxfY29uZmlnLAogICAgICAgIH0KICAgIH0KfQoKaW1wbCBEZWZhdWx0IGZvciBTdG9yYWdlSGFzaGluZ1N0YWdlIHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgY2xlYW5fdGhyZXNob2xkOiA1MDBfMDAwLAogICAgICAgICAgICBjb21taXRfdGhyZXNob2xkOiAxMDBfMDAwLAogICAgICAgICAgICBldGxfY29uZmlnOiBFdGxDb25maWc6OmRlZmF1bHQoKSwKICAgICAgICB9CiAgICB9Cn0KCmltcGw8UHJvdmlkZXI+IFN0YWdlPFByb3ZpZGVyPiBmb3IgU3RvcmFnZUhhc2hpbmdTdGFnZQp3aGVyZQogICAgUHJvdmlkZXI6IERCUHJvdmlkZXI8VHg6IERiVHhNdXQ+ICsgU3RvcmFnZVJlYWRlciArIEhhc2hpbmdXcml0ZXIgKyBTdGF0c1JlYWRlciwKewogICAgLy8vIFJldHVybiB0aGUgaWQgb2YgdGhlIHN0YWdlCiAgICBmbiBpZCgmc2VsZikgLT4gU3RhZ2VJZCB7CiAgICAgICAgU3RhZ2VJZDo6U3RvcmFnZUhhc2hpbmcKICAgIH0KCiAgICAvLy8gRXhlY3V0ZSB0aGUgc3RhZ2UuCiAgICBmbiBleGVjdXRlKCZtdXQgc2VsZiwgcHJvdmlkZXI6ICZQcm92aWRlciwgaW5wdXQ6IEV4ZWNJbnB1dCkgLT4gUmVzdWx0PEV4ZWNPdXRwdXQsIFN0YWdlRXJyb3I+IHsKICAgICAgICBsZXQgdHggPSBwcm92aWRlci50eF9yZWYoKTsKICAgICAgICBpZiBpbnB1dC50YXJnZXRfcmVhY2hlZCgpIHsKICAgICAgICAgICAgcmV0dXJuIE9rKEV4ZWNPdXRwdXQ6OmRvbmUoaW5wdXQuY2hlY2twb2ludCgpKSkKICAgICAgICB9CgogICAgICAgIGxldCAoZnJvbV9ibG9jaywgdG9fYmxvY2spID0gaW5wdXQubmV4dF9ibG9ja19yYW5nZSgpLmludG9faW5uZXIoKTsKCiAgICAgICAgLy8gaWYgdGhlcmUgYXJlIG1vcmUgYmxvY2tzIHRoZW4gdGhyZXNob2xkIGl0IGlzIGZhc3RlciB0byBnbyBvdmVyIFBsYWluIHN0YXRlIGFuZCBoYXNoIGFsbAogICAgICAgIC8vIGFjY291bnQgb3RoZXJ3aXNlIHRha2UgY2hhbmdlc2V0cyBhZ2dyZWdhdGUgdGhlIHNldHMgYW5kIGFwcGx5IGhhc2hpbmcgdG8KICAgICAgICAvLyBBY2NvdW50SGFzaGluZyB0YWJsZS4gQWxzbywgaWYgd2Ugc3RhcnQgZnJvbSBnZW5lc2lzLCB3ZSBuZWVkIHRvIGhhc2ggZnJvbSBzY3JhdGNoLCBhcwogICAgICAgIC8vIGdlbmVzaXMgYWNjb3VudHMgYXJlIG5vdCBpbiBjaGFuZ2VzZXQsIGFsb25nIHdpdGggdGhlaXIgc3RvcmFnZXMuCiAgICAgICAgaWYgdG9fYmxvY2sgLSBmcm9tX2Jsb2NrID4gc2VsZi5jbGVhbl90aHJlc2hvbGQgfHwgZnJvbV9ibG9jayA9PSAxIHsKICAgICAgICAgICAgLy8gY2xlYXIgdGFibGUsIGxvYWQgYWxsIGFjY291bnRzIGFuZCBoYXNoIGl0CiAgICAgICAgICAgIHR4LmNsZWFyOjo8dGFibGVzOjpIYXNoZWRTdG9yYWdlcz4oKT87CgogICAgICAgICAgICBsZXQgbXV0IHN0b3JhZ2VfY3Vyc29yID0gdHguY3Vyc29yX3JlYWQ6Ojx0YWJsZXM6OlBsYWluU3RvcmFnZVN0YXRlPigpPzsKICAgICAgICAgICAgbGV0IG11dCBjb2xsZWN0b3IgPQogICAgICAgICAgICAgICAgQ29sbGVjdG9yOjpuZXcoc2VsZi5ldGxfY29uZmlnLmZpbGVfc2l6ZSwgc2VsZi5ldGxfY29uZmlnLmRpci5jbG9uZSgpKTsKICAgICAgICAgICAgbGV0IG11dCBjaGFubmVscyA9IFZlYzo6d2l0aF9jYXBhY2l0eShNQVhJTVVNX0NIQU5ORUxTKTsKCiAgICAgICAgICAgIGZvciBjaHVuayBpbiAmc3RvcmFnZV9jdXJzb3Iud2FsayhOb25lKT8uY2h1bmtzKFdPUktFUl9DSFVOS19TSVpFKSB7CiAgICAgICAgICAgICAgICAvLyBBbiBfdW5vcmRlcmVkXyBjaGFubmVsIHRvIHJlY2VpdmUgcmVzdWx0cyBmcm9tIGEgcmF5b24gam9iCiAgICAgICAgICAgICAgICBsZXQgKHR4LCByeCkgPSBtcHNjOjpjaGFubmVsKCk7CiAgICAgICAgICAgICAgICBjaGFubmVscy5wdXNoKHJ4KTsKCiAgICAgICAgICAgICAgICBsZXQgY2h1bmsgPSBjaHVuay5jb2xsZWN0Ojo8UmVzdWx0PFZlYzxfPiwgXz4+KCk/OwogICAgICAgICAgICAgICAgLy8gU3Bhd24gdGhlIGhhc2hpbmcgdGFzayBvbnRvIHRoZSBnbG9iYWwgcmF5b24gcG9vbAogICAgICAgICAgICAgICAgcmF5b246OnNwYXduKG1vdmUgfHwgewogICAgICAgICAgICAgICAgICAgIC8vIENhY2hlIGhhc2hlZCBhZGRyZXNzIHNpbmNlIFBsYWluU3RvcmFnZVN0YXRlIGlzIHNvcnRlZCBieSBhZGRyZXNzCiAgICAgICAgICAgICAgICAgICAgbGV0IChtdXQgbGFzdF9hZGRyLCBtdXQgaGFzaGVkX2FkZHIpID0gKEFkZHJlc3M6OlpFUk8sIEhBU0hFRF9aRVJPX0FERFJFU1MpOwogICAgICAgICAgICAgICAgICAgIGZvciAoYWRkcmVzcywgc2xvdCkgaW4gY2h1bmsgewogICAgICAgICAgICAgICAgICAgICAgICBpZiBhZGRyZXNzICE9IGxhc3RfYWRkciB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0X2FkZHIgPSBhZGRyZXNzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzaGVkX2FkZHIgPSBrZWNjYWsyNTYoYWRkcmVzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBhZGRyX2tleSA9IFZlYzo6d2l0aF9jYXBhY2l0eSg2NCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJfa2V5LnB1dF9zbGljZShoYXNoZWRfYWRkci5hc19zbGljZSgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkcl9rZXkucHV0X3NsaWNlKGtlY2NhazI1NihzbG90LmtleSkuYXNfc2xpY2UoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBfID0gdHguc2VuZCgoYWRkcl9rZXksIENvbXBhY3RVMjU2Ojpmcm9tKHNsb3QudmFsdWUpKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gRmx1c2ggdG8gRVRMIHdoZW4gY2hhbm5lbHMgbGVuZ3RoIHJlYWNoZXMgTUFYSU1VTV9DSEFOTkVMUwogICAgICAgICAgICAgICAgaWYgIWNoYW5uZWxzLmlzX2VtcHR5KCkgJiYgY2hhbm5lbHMubGVuKCkuaXNfbXVsdGlwbGVfb2YoTUFYSU1VTV9DSEFOTkVMUykgewogICAgICAgICAgICAgICAgICAgIGNvbGxlY3QoJm11dCBjaGFubmVscywgJm11dCBjb2xsZWN0b3IpPzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29sbGVjdCgmbXV0IGNoYW5uZWxzLCAmbXV0IGNvbGxlY3Rvcik/OwoKICAgICAgICAgICAgbGV0IHRvdGFsX2hhc2hlcyA9IGNvbGxlY3Rvci5sZW4oKTsKICAgICAgICAgICAgbGV0IGludGVydmFsID0gKHRvdGFsX2hhc2hlcyAvIDEwKS5tYXgoMSk7CiAgICAgICAgICAgIGxldCBtdXQgY3Vyc29yID0gdHguY3Vyc29yX2R1cF93cml0ZTo6PHRhYmxlczo6SGFzaGVkU3RvcmFnZXM+KCk/OwogICAgICAgICAgICBmb3IgKGluZGV4LCBpdGVtKSBpbiBjb2xsZWN0b3IuaXRlcigpPy5lbnVtZXJhdGUoKSB7CiAgICAgICAgICAgICAgICBpZiBpbmRleCA+IDAgJiYgaW5kZXguaXNfbXVsdGlwbGVfb2YoaW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICBpbmZvISgKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpoYXNoaW5nX3N0b3JhZ2UiLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzcyA9ICVmb3JtYXQhKCJ7Oi4yfSUiLCAoaW5kZXggYXMgZjY0IC8gdG90YWxfaGFzaGVzIGFzIGY2NCkgKiAxMDAuMCksCiAgICAgICAgICAgICAgICAgICAgICAgICJJbnNlcnRpbmcgaGFzaGVzIgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGV0IChhZGRyX2tleSwgdmFsdWUpID0gaXRlbT87CiAgICAgICAgICAgICAgICBjdXJzb3IuYXBwZW5kX2R1cCgKICAgICAgICAgICAgICAgICAgICBCMjU2Ojpmcm9tX3NsaWNlKCZhZGRyX2tleVsuLjMyXSksCiAgICAgICAgICAgICAgICAgICAgU3RvcmFnZUVudHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBCMjU2Ojpmcm9tX3NsaWNlKCZhZGRyX2tleVszMi4uXSksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBDb21wYWN0VTI1Njo6ZGVjb21wcmVzc19vd25lZCh2YWx1ZSk/LmludG8oKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgKT87CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBBZ2dyZWdhdGUgYWxsIGNoYW5nZXNldHMgYW5kIG1ha2UgbGlzdCBvZiBzdG9yYWdlcyB0aGF0IGhhdmUgYmVlbgogICAgICAgICAgICAvLyBjaGFuZ2VkLgogICAgICAgICAgICBsZXQgbGlzdHMgPSBwcm92aWRlci5jaGFuZ2VkX3N0b3JhZ2VzX3dpdGhfcmFuZ2UoZnJvbV9ibG9jay4uPXRvX2Jsb2NrKT87CiAgICAgICAgICAgIC8vIGl0ZXJhdGUgb3ZlciBwbGFpbiBzdGF0ZSBhbmQgZ2V0IG5ld2VzdCBzdG9yYWdlIHZhbHVlLgogICAgICAgICAgICAvLyBBc3N1bXB0aW9uIHdlIGFyZSBva2F5IHdpdGggaXMgdGhhdCBwbGFpbiBzdGF0ZSByZXByZXNlbnQKICAgICAgICAgICAgLy8gYHByZXZpb3VzX3N0YWdlX3Byb2dyZXNzYCBzdGF0ZS4KICAgICAgICAgICAgbGV0IHN0b3JhZ2VzID0gcHJvdmlkZXIucGxhaW5fc3RhdGVfc3RvcmFnZXMobGlzdHMpPzsKICAgICAgICAgICAgcHJvdmlkZXIuaW5zZXJ0X3N0b3JhZ2VfZm9yX2hhc2hpbmcoc3RvcmFnZXMpPzsKICAgICAgICB9CgogICAgICAgIC8vIFdlIGZpbmlzaGVkIHRoZSBoYXNoaW5nIHN0YWdlLCBubyBmdXR1cmUgaXRlcmF0aW9ucyBpcyBleHBlY3RlZCBmb3IgdGhlIHNhbWUgYmxvY2sgcmFuZ2UsCiAgICAgICAgLy8gc28gbm8gY2hlY2twb2ludCBpcyBuZWVkZWQuCiAgICAgICAgbGV0IGNoZWNrcG9pbnQgPSBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhpbnB1dC50YXJnZXQoKSkKICAgICAgICAgICAgLndpdGhfc3RvcmFnZV9oYXNoaW5nX3N0YWdlX2NoZWNrcG9pbnQoU3RvcmFnZUhhc2hpbmdDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgIHByb2dyZXNzOiBzdGFnZV9jaGVja3BvaW50X3Byb2dyZXNzKHByb3ZpZGVyKT8sCiAgICAgICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgICAgICB9KTsKCiAgICAgICAgT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQsIGRvbmU6IHRydWUgfSkKICAgIH0KCiAgICAvLy8gVW53aW5kIHRoZSBzdGFnZS4KICAgIGZuIHVud2luZCgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgcHJvdmlkZXI6ICZQcm92aWRlciwKICAgICAgICBpbnB1dDogVW53aW5kSW5wdXQsCiAgICApIC0+IFJlc3VsdDxVbndpbmRPdXRwdXQsIFN0YWdlRXJyb3I+IHsKICAgICAgICBsZXQgKHJhbmdlLCB1bndpbmRfcHJvZ3Jlc3MsIF8pID0KICAgICAgICAgICAgaW5wdXQudW53aW5kX2Jsb2NrX3JhbmdlX3dpdGhfdGhyZXNob2xkKHNlbGYuY29tbWl0X3RocmVzaG9sZCk7CgogICAgICAgIHByb3ZpZGVyLnVud2luZF9zdG9yYWdlX2hhc2hpbmdfcmFuZ2UoQmxvY2tOdW1iZXJBZGRyZXNzOjpyYW5nZShyYW5nZSkpPzsKCiAgICAgICAgbGV0IG11dCBzdGFnZV9jaGVja3BvaW50ID0KICAgICAgICAgICAgaW5wdXQuY2hlY2twb2ludC5zdG9yYWdlX2hhc2hpbmdfc3RhZ2VfY2hlY2twb2ludCgpLnVud3JhcF9vcl9kZWZhdWx0KCk7CgogICAgICAgIHN0YWdlX2NoZWNrcG9pbnQucHJvZ3Jlc3MgPSBzdGFnZV9jaGVja3BvaW50X3Byb2dyZXNzKHByb3ZpZGVyKT87CgogICAgICAgIE9rKFVud2luZE91dHB1dCB7CiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KHVud2luZF9wcm9ncmVzcykKICAgICAgICAgICAgICAgIC53aXRoX3N0b3JhZ2VfaGFzaGluZ19zdGFnZV9jaGVja3BvaW50KHN0YWdlX2NoZWNrcG9pbnQpLAogICAgICAgIH0pCiAgICB9Cn0KCi8vLyBGbHVzaGVzIGNoYW5uZWxzIGhhc2hlcyB0byBFVEwgY29sbGVjdG9yLgpmbiBjb2xsZWN0KAogICAgY2hhbm5lbHM6ICZtdXQgVmVjPFJlY2VpdmVyPChWZWM8dTg+LCBDb21wYWN0VTI1Nik+PiwKICAgIGNvbGxlY3RvcjogJm11dCBDb2xsZWN0b3I8VmVjPHU4PiwgQ29tcGFjdFUyNTY+LAopIC0+IFJlc3VsdDwoKSwgU3RhZ2VFcnJvcj4gewogICAgZm9yIGNoYW5uZWwgaW4gY2hhbm5lbHMuaXRlcl9tdXQoKSB7CiAgICAgICAgd2hpbGUgbGV0IE9rKChrZXksIHYpKSA9IGNoYW5uZWwucmVjdigpIHsKICAgICAgICAgICAgY29sbGVjdG9yLmluc2VydChrZXksIHYpPzsKICAgICAgICB9CiAgICB9CiAgICBpbmZvISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6Omhhc2hpbmdfc3RvcmFnZSIsICJIYXNoZWQge30gZW50cmllcyIsIGNvbGxlY3Rvci5sZW4oKSk7CiAgICBjaGFubmVscy5jbGVhcigpOwogICAgT2soKCkpCn0KCmZuIHN0YWdlX2NoZWNrcG9pbnRfcHJvZ3Jlc3MocHJvdmlkZXI6ICZpbXBsIFN0YXRzUmVhZGVyKSAtPiBQcm92aWRlclJlc3VsdDxFbnRpdGllc0NoZWNrcG9pbnQ+IHsKICAgIE9rKEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgcHJvY2Vzc2VkOiBwcm92aWRlci5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpIYXNoZWRTdG9yYWdlcz4oKT8gYXMgdTY0LAogICAgICAgIHRvdGFsOiBwcm92aWRlci5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpQbGFpblN0b3JhZ2VTdGF0ZT4oKT8gYXMgdTY0LAogICAgfSkKfQoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6Oio7CiAgICB1c2UgY3JhdGU6OnRlc3RfdXRpbHM6OnsKICAgICAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCwgRXhlY3V0ZVN0YWdlVGVzdFJ1bm5lciwgU3RhZ2VUZXN0UnVubmVyLCBUZXN0UnVubmVyRXJyb3IsCiAgICAgICAgVGVzdFN0YWdlREIsIFVud2luZFN0YWdlVGVzdFJ1bm5lciwKICAgIH07CiAgICB1c2UgYWxsb3lfcHJpbWl0aXZlczo6e0FkZHJlc3MsIFUyNTZ9OwogICAgdXNlIGFzc2VydF9tYXRjaGVzOjphc3NlcnRfbWF0Y2hlczsKICAgIHVzZSByYW5kOjpSbmc7CiAgICB1c2UgcmV0aF9kYl9hcGk6OnsKICAgICAgICBjdXJzb3I6OntEYkN1cnNvclJXLCBEYkR1cEN1cnNvclJPfSwKICAgICAgICBtb2RlbHM6OlN0b3JlZEJsb2NrQm9keUluZGljZXMsCiAgICB9OwogICAgdXNlIHJldGhfZXRoZXJldW1fcHJpbWl0aXZlczo6QmxvY2s7CiAgICB1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6U2VhbGVkQmxvY2s7CiAgICB1c2UgcmV0aF9wcm92aWRlcjo6cHJvdmlkZXJzOjpTdGF0aWNGaWxlV3JpdGVyOwogICAgdXNlIHJldGhfdGVzdGluZ191dGlsczo6Z2VuZXJhdG9yczo6ewogICAgICAgIHNlbGYsIHJhbmRvbV9ibG9ja19yYW5nZSwgcmFuZG9tX2NvbnRyYWN0X2FjY291bnRfcmFuZ2UsIEJsb2NrUmFuZ2VQYXJhbXMsCiAgICB9OwoKICAgIHN0YWdlX3Rlc3Rfc3VpdGVfZXh0IShTdG9yYWdlSGFzaGluZ1Rlc3RSdW5uZXIsIHN0b3JhZ2VfaGFzaGluZyk7CgogICAgLy8vIEV4ZWN1dGUgd2l0aCBsb3cgY2xlYW4gdGhyZXNob2xkIHNvIGFzIHRvIGhhc2ggd2hvbGUgc3RvcmFnZQogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGV4ZWN1dGVfY2xlYW5fc3RvcmFnZV9oYXNoaW5nKCkgewogICAgICAgIGxldCAocHJldmlvdXNfc3RhZ2UsIHN0YWdlX3Byb2dyZXNzKSA9ICg1MDAsIDEwMCk7CgogICAgICAgIC8vIFNldCB1cCB0aGUgcnVubmVyCiAgICAgICAgbGV0IG11dCBydW5uZXIgPSBTdG9yYWdlSGFzaGluZ1Rlc3RSdW5uZXI6OmRlZmF1bHQoKTsKCiAgICAgICAgLy8gc2V0IGxvdyBjbGVhbiB0aHJlc2hvbGQgc28gd2UgaGFzaCB0aGUgd2hvbGUgc3RvcmFnZQogICAgICAgIHJ1bm5lci5zZXRfY2xlYW5fdGhyZXNob2xkKDEpOwoKICAgICAgICAvLyBzZXQgbG93IGNvbW1pdCB0aHJlc2hvbGQgc28gd2UgZm9yY2UgZWFjaCBlbnRyeSB0byBiZSBhIHR4LmNvbW1pdCBhbmQgbWFrZSBzdXJlIHdlIGRvbid0CiAgICAgICAgLy8gaGFuZyBvbiBvbmUga2V5LiBTZWVkIGV4ZWN1dGlvbiBpbnNlcnRzIG1vcmUgdGhhbiBvbmUgc3RvcmFnZSBlbnRyeSBwZXIgYWRkcmVzcy4KICAgICAgICBydW5uZXIuc2V0X2NvbW1pdF90aHJlc2hvbGQoMSk7CgogICAgICAgIGxldCBtdXQgaW5wdXQgPSBFeGVjSW5wdXQgewogICAgICAgICAgICB0YXJnZXQ6IFNvbWUocHJldmlvdXNfc3RhZ2UpLAogICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KHN0YWdlX3Byb2dyZXNzKSksCiAgICAgICAgfTsKCiAgICAgICAgcnVubmVyLnNlZWRfZXhlY3V0aW9uKGlucHV0KS5leHBlY3QoImZhaWxlZCB0byBzZWVkIGV4ZWN1dGlvbiIpOwoKICAgICAgICBsb29wIHsKICAgICAgICAgICAgaWYgbGV0IE9rKHJlc3VsdCBAIEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50LCBkb25lIH0pID0KICAgICAgICAgICAgICAgIHJ1bm5lci5leGVjdXRlKGlucHV0KS5hd2FpdC51bndyYXAoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAhZG9uZSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXZpb3VzX2NoZWNrcG9pbnQgPSBpbnB1dAogICAgICAgICAgICAgICAgICAgICAgICAuY2hlY2twb2ludAogICAgICAgICAgICAgICAgICAgICAgICAuYW5kX3RoZW4ofGNoZWNrcG9pbnR8IGNoZWNrcG9pbnQuc3RvcmFnZV9oYXNoaW5nX3N0YWdlX2NoZWNrcG9pbnQoKSkKICAgICAgICAgICAgICAgICAgICAgICAgLnVud3JhcF9vcl9kZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0X21hdGNoZXMhKGNoZWNrcG9pbnQuc3RvcmFnZV9oYXNoaW5nX3N0YWdlX2NoZWNrcG9pbnQoKSwgU29tZShTdG9yYWdlSGFzaGluZ0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAuLgogICAgICAgICAgICAgICAgICAgIH0pIGlmIHByb2Nlc3NlZCA9PSBwcmV2aW91c19jaGVja3BvaW50LnByb2dyZXNzLnByb2Nlc3NlZCArIDEgJiYKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWwgPT0gcnVubmVyLmRiLmNvdW50X2VudHJpZXM6Ojx0YWJsZXM6OlBsYWluU3RvcmFnZVN0YXRlPigpLnVud3JhcCgpIGFzIHU2NCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENvbnRpbnVlIGZyb20gY2hlY2twb2ludAogICAgICAgICAgICAgICAgICAgIGlucHV0LmNoZWNrcG9pbnQgPSBTb21lKGNoZWNrcG9pbnQpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyLCBwcmV2aW91c19zdGFnZSk7CiAgICAgICAgICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoY2hlY2twb2ludC5zdG9yYWdlX2hhc2hpbmdfc3RhZ2VfY2hlY2twb2ludCgpLCBTb21lKFN0b3JhZ2VIYXNoaW5nQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiBFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIC4uCiAgICAgICAgICAgICAgICAgICAgfSkgaWYgcHJvY2Vzc2VkID09IHRvdGFsICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsID09IHJ1bm5lci5kYi5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpQbGFpblN0b3JhZ2VTdGF0ZT4oKS51bndyYXAoKSBhcyB1NjQpOwoKICAgICAgICAgICAgICAgIC8vIFZhbGlkYXRlIHRoZSBzdGFnZSBleGVjdXRpb24KICAgICAgICAgICAgICAgIGFzc2VydCEoCiAgICAgICAgICAgICAgICAgICAgcnVubmVyLnZhbGlkYXRlX2V4ZWN1dGlvbihpbnB1dCwgU29tZShyZXN1bHQpKS5pc19vaygpLAogICAgICAgICAgICAgICAgICAgICJleGVjdXRpb24gdmFsaWRhdGlvbiIKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYW5pYyEoIkZhaWxlZCBleGVjdXRpb24iKTsKICAgICAgICB9CiAgICB9CgogICAgc3RydWN0IFN0b3JhZ2VIYXNoaW5nVGVzdFJ1bm5lciB7CiAgICAgICAgZGI6IFRlc3RTdGFnZURCLAogICAgICAgIGNvbW1pdF90aHJlc2hvbGQ6IHU2NCwKICAgICAgICBjbGVhbl90aHJlc2hvbGQ6IHU2NCwKICAgICAgICBldGxfY29uZmlnOiBFdGxDb25maWcsCiAgICB9CgogICAgaW1wbCBEZWZhdWx0IGZvciBTdG9yYWdlSGFzaGluZ1Rlc3RSdW5uZXIgewogICAgICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICAgICAgU2VsZiB7CiAgICAgICAgICAgICAgICBkYjogVGVzdFN0YWdlREI6OmRlZmF1bHQoKSwKICAgICAgICAgICAgICAgIGNvbW1pdF90aHJlc2hvbGQ6IDEwMDAsCiAgICAgICAgICAgICAgICBjbGVhbl90aHJlc2hvbGQ6IDEwMDAsCiAgICAgICAgICAgICAgICBldGxfY29uZmlnOiBFdGxDb25maWc6OmRlZmF1bHQoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpbXBsIFN0YWdlVGVzdFJ1bm5lciBmb3IgU3RvcmFnZUhhc2hpbmdUZXN0UnVubmVyIHsKICAgICAgICB0eXBlIFMgPSBTdG9yYWdlSGFzaGluZ1N0YWdlOwoKICAgICAgICBmbiBkYigmc2VsZikgLT4gJlRlc3RTdGFnZURCIHsKICAgICAgICAgICAgJnNlbGYuZGIKICAgICAgICB9CgogICAgICAgIGZuIHN0YWdlKCZzZWxmKSAtPiBTZWxmOjpTIHsKICAgICAgICAgICAgU2VsZjo6UyB7CiAgICAgICAgICAgICAgICBjb21taXRfdGhyZXNob2xkOiBzZWxmLmNvbW1pdF90aHJlc2hvbGQsCiAgICAgICAgICAgICAgICBjbGVhbl90aHJlc2hvbGQ6IHNlbGYuY2xlYW5fdGhyZXNob2xkLAogICAgICAgICAgICAgICAgZXRsX2NvbmZpZzogc2VsZi5ldGxfY29uZmlnLmNsb25lKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaW1wbCBFeGVjdXRlU3RhZ2VUZXN0UnVubmVyIGZvciBTdG9yYWdlSGFzaGluZ1Rlc3RSdW5uZXIgewogICAgICAgIHR5cGUgU2VlZCA9IFZlYzxTZWFsZWRCbG9jazxCbG9jaz4+OwoKICAgICAgICBmbiBzZWVkX2V4ZWN1dGlvbigmbXV0IHNlbGYsIGlucHV0OiBFeGVjSW5wdXQpIC0+IFJlc3VsdDxTZWxmOjpTZWVkLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgbGV0IHN0YWdlX3Byb2dyZXNzID0gaW5wdXQubmV4dF9ibG9jaygpOwogICAgICAgICAgICBsZXQgZW5kID0gaW5wdXQudGFyZ2V0KCk7CiAgICAgICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CgogICAgICAgICAgICBsZXQgbl9hY2NvdW50cyA9IDMxOwogICAgICAgICAgICBsZXQgbXV0IGFjY291bnRzID0gcmFuZG9tX2NvbnRyYWN0X2FjY291bnRfcmFuZ2UoJm11dCBybmcsICZtdXQgKDAuLm5fYWNjb3VudHMpKTsKCiAgICAgICAgICAgIGxldCBibG9ja3MgPSByYW5kb21fYmxvY2tfcmFuZ2UoCiAgICAgICAgICAgICAgICAmbXV0IHJuZywKICAgICAgICAgICAgICAgIHN0YWdlX3Byb2dyZXNzLi49ZW5kLAogICAgICAgICAgICAgICAgQmxvY2tSYW5nZVBhcmFtcyB7IHBhcmVudDogU29tZShCMjU2OjpaRVJPKSwgdHhfY291bnQ6IDAuLjMsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBzZWxmLmRiLmluc2VydF9oZWFkZXJzKGJsb2Nrcy5pdGVyKCkubWFwKHxibG9ja3wgYmxvY2suc2VhbGVkX2hlYWRlcigpKSk/OwogICAgICAgICAgICBsZXQgbXV0IHR4X2hhc2hfbnVtYmVycyA9IFZlYzo6bmV3KCk7CgogICAgICAgICAgICBsZXQgaXRlciA9IGJsb2Nrcy5pdGVyKCk7CiAgICAgICAgICAgIGxldCBtdXQgbmV4dF90eF9udW0gPSAwOwogICAgICAgICAgICBsZXQgbXV0IGZpcnN0X3R4X251bSA9IG5leHRfdHhfbnVtOwogICAgICAgICAgICBmb3IgcHJvZ3Jlc3MgaW4gaXRlciB7CiAgICAgICAgICAgICAgICAvLyBJbnNlcnQgbGFzdCBwcm9ncmVzcyBkYXRhCiAgICAgICAgICAgICAgICBsZXQgYmxvY2tfbnVtYmVyID0gcHJvZ3Jlc3MubnVtYmVyOwogICAgICAgICAgICAgICAgc2VsZi5kYi5jb21taXQofHR4fCB7CiAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MuYm9keSgpLnRyYW5zYWN0aW9ucy5pdGVyKCkudHJ5X2Zvcl9lYWNoKAogICAgICAgICAgICAgICAgICAgICAgICB8dHJhbnNhY3Rpb258IC0+IFJlc3VsdDwoKSwgcmV0aF9kYjo6RGF0YWJhc2VFcnJvcj4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHhfaGFzaF9udW1iZXJzLnB1c2goKCp0cmFuc2FjdGlvbi50eF9oYXNoKCksIG5leHRfdHhfbnVtKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OlRyYW5zYWN0aW9ucz4obmV4dF90eF9udW0sIHRyYW5zYWN0aW9uLmNsb25lKCkpPzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgKGFkZHIsIF8pID0gYWNjb3VudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0X211dCgocm5nLnJhbmRvbTo6PHU2ND4oKSAlIG5fYWNjb3VudHMpIGFzIHVzaXplKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgXyBpbiAwLi4yIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbmV3X2VudHJ5ID0gU3RvcmFnZUVudHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBrZWNjYWsyNTYoW3JuZy5yYW5kb206Ojx1OD4oKV0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogVTI1Njo6ZnJvbShybmcucmFuZG9tOjo8dTg+KCkgJSAzMCArIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pbnNlcnRfc3RvcmFnZV9lbnRyeSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChibG9ja19udW1iZXIsICphZGRyKS5pbnRvKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld19lbnRyeSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MubnVtYmVyID09IHN0YWdlX3Byb2dyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk/OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRfdHhfbnVtICs9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBPaygoKSkKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICApPzsKCiAgICAgICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIHJld2FyZHMKICAgICAgICAgICAgICAgICAgICBsZXQgaGFzX3Jld2FyZDogYm9vbCA9IHJuZy5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiBoYXNfcmV3YXJkIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pbnNlcnRfc3RvcmFnZV9lbnRyeSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGJsb2NrX251bWJlciwgQWRkcmVzczo6cmFuZG9tKCkpLmludG8oKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0b3JhZ2VFbnRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBrZWNjYWsyNTYoIm1pbmluZyIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBVMjU2Ojpmcm9tKHJuZy5yYW5kb206Ojx1MzI+KCkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzLm51bWJlciA9PSBzdGFnZV9wcm9ncmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgKT87CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgYm9keSA9IFN0b3JlZEJsb2NrQm9keUluZGljZXMgewogICAgICAgICAgICAgICAgICAgICAgICBmaXJzdF90eF9udW0sCiAgICAgICAgICAgICAgICAgICAgICAgIHR4X2NvdW50OiBwcm9ncmVzcy50cmFuc2FjdGlvbl9jb3VudCgpIGFzIHU2NCwKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBmaXJzdF90eF9udW0gPSBuZXh0X3R4X251bTsKCiAgICAgICAgICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpCbG9ja0JvZHlJbmRpY2VzPihwcm9ncmVzcy5udW1iZXIsIGJvZHkpPzsKICAgICAgICAgICAgICAgICAgICBPaygoKSkKICAgICAgICAgICAgICAgIH0pPzsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLmRiLmluc2VydF90eF9oYXNoX251bWJlcnModHhfaGFzaF9udW1iZXJzKT87CgogICAgICAgICAgICBPayhibG9ja3MpCiAgICAgICAgfQoKICAgICAgICBmbiB2YWxpZGF0ZV9leGVjdXRpb24oCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBpbnB1dDogRXhlY0lucHV0LAogICAgICAgICAgICBvdXRwdXQ6IE9wdGlvbjxFeGVjT3V0cHV0PiwKICAgICAgICApIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgIGlmIGxldCBTb21lKG91dHB1dCkgPSBvdXRwdXQgewogICAgICAgICAgICAgICAgbGV0IHN0YXJ0X2Jsb2NrID0gaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlciArIDE7CiAgICAgICAgICAgICAgICBsZXQgZW5kX2Jsb2NrID0gb3V0cHV0LmNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyOwogICAgICAgICAgICAgICAgaWYgc3RhcnRfYmxvY2sgPiBlbmRfYmxvY2sgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBPaygoKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLmNoZWNrX2hhc2hlZF9zdG9yYWdlKCkKICAgICAgICB9CiAgICB9CgogICAgaW1wbCBVbndpbmRTdGFnZVRlc3RSdW5uZXIgZm9yIFN0b3JhZ2VIYXNoaW5nVGVzdFJ1bm5lciB7CiAgICAgICAgZm4gdmFsaWRhdGVfdW53aW5kKCZzZWxmLCBpbnB1dDogVW53aW5kSW5wdXQpIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgIHNlbGYudW53aW5kX3N0b3JhZ2UoaW5wdXQpPzsKICAgICAgICAgICAgc2VsZi5jaGVja19oYXNoZWRfc3RvcmFnZSgpCiAgICAgICAgfQogICAgfQoKICAgIGltcGwgU3RvcmFnZUhhc2hpbmdUZXN0UnVubmVyIHsKICAgICAgICBmbiBzZXRfY2xlYW5fdGhyZXNob2xkKCZtdXQgc2VsZiwgdGhyZXNob2xkOiB1NjQpIHsKICAgICAgICAgICAgc2VsZi5jbGVhbl90aHJlc2hvbGQgPSB0aHJlc2hvbGQ7CiAgICAgICAgfQoKICAgICAgICBmbiBzZXRfY29tbWl0X3RocmVzaG9sZCgmbXV0IHNlbGYsIHRocmVzaG9sZDogdTY0KSB7CiAgICAgICAgICAgIHNlbGYuY29tbWl0X3RocmVzaG9sZCA9IHRocmVzaG9sZDsKICAgICAgICB9CgogICAgICAgIGZuIGNoZWNrX2hhc2hlZF9zdG9yYWdlKCZzZWxmKSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICBzZWxmLmRiCiAgICAgICAgICAgICAgICAucXVlcnkofHR4fCB7CiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBzdG9yYWdlX2N1cnNvciA9IHR4LmN1cnNvcl9kdXBfcmVhZDo6PHRhYmxlczo6UGxhaW5TdG9yYWdlU3RhdGU+KCk/OwogICAgICAgICAgICAgICAgICAgIGxldCBtdXQgaGFzaGVkX3N0b3JhZ2VfY3Vyc29yID0KICAgICAgICAgICAgICAgICAgICAgICAgdHguY3Vyc29yX2R1cF9yZWFkOjo8dGFibGVzOjpIYXNoZWRTdG9yYWdlcz4oKT87CgogICAgICAgICAgICAgICAgICAgIGxldCBtdXQgZXhwZWN0ZWQgPSAwOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSBsZXQgU29tZSgoYWRkcmVzcywgZW50cnkpKSA9IHN0b3JhZ2VfY3Vyc29yLm5leHQoKT8gewogICAgICAgICAgICAgICAgICAgICAgICBsZXQga2V5ID0ga2VjY2FrMjU2KGVudHJ5LmtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBnb3QgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzaGVkX3N0b3JhZ2VfY3Vyc29yLnNlZWtfYnlfa2V5X3N1YmtleShrZWNjYWsyNTYoYWRkcmVzcyksIGtleSk/OwogICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ290LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgU29tZShTdG9yYWdlRW50cnkgeyBrZXksIC4uZW50cnkgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAie2V4cGVjdGVkfToge2FkZHJlc3M6P30iCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkICs9IDE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxldCBjb3VudCA9IHR4LmN1cnNvcl9kdXBfcmVhZDo6PHRhYmxlczo6SGFzaGVkU3RvcmFnZXM+KCk/LndhbGsoTm9uZSk/LmNvdW50KCk7CgogICAgICAgICAgICAgICAgICAgIGFzc2VydF9lcSEoY291bnQsIGV4cGVjdGVkKTsKICAgICAgICAgICAgICAgICAgICBPaygoKSkKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXwgZS5pbnRvKCkpCiAgICAgICAgfQoKICAgICAgICBmbiBpbnNlcnRfc3RvcmFnZV9lbnRyeTxUWDogRGJUeE11dD4oCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICB0eDogJlRYLAogICAgICAgICAgICBibl9hZGRyZXNzOiBCbG9ja051bWJlckFkZHJlc3MsCiAgICAgICAgICAgIGVudHJ5OiBTdG9yYWdlRW50cnksCiAgICAgICAgICAgIGhhc2g6IGJvb2wsCiAgICAgICAgKSAtPiBSZXN1bHQ8KCksIHJldGhfZGI6OkRhdGFiYXNlRXJyb3I+IHsKICAgICAgICAgICAgbGV0IG11dCBzdG9yYWdlX2N1cnNvciA9IHR4LmN1cnNvcl9kdXBfd3JpdGU6Ojx0YWJsZXM6OlBsYWluU3RvcmFnZVN0YXRlPigpPzsKICAgICAgICAgICAgbGV0IHByZXZfZW50cnkgPQogICAgICAgICAgICAgICAgbWF0Y2ggc3RvcmFnZV9jdXJzb3Iuc2Vla19ieV9rZXlfc3Via2V5KGJuX2FkZHJlc3MuYWRkcmVzcygpLCBlbnRyeS5rZXkpPyB7CiAgICAgICAgICAgICAgICAgICAgU29tZShlKSBpZiBlLmtleSA9PSBlbnRyeS5rZXkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0eC5kZWxldGU6Ojx0YWJsZXM6OlBsYWluU3RvcmFnZVN0YXRlPihibl9hZGRyZXNzLmFkZHJlc3MoKSwgU29tZShlKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5leHBlY3QoImZhaWxlZCB0byBkZWxldGUgZW50cnkiKTsKICAgICAgICAgICAgICAgICAgICAgICAgZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfID0+IFN0b3JhZ2VFbnRyeSB7IGtleTogZW50cnkua2V5LCB2YWx1ZTogVTI1Njo6ZnJvbSgwKSB9LAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpQbGFpblN0b3JhZ2VTdGF0ZT4oYm5fYWRkcmVzcy5hZGRyZXNzKCksIGVudHJ5KT87CgogICAgICAgICAgICBpZiBoYXNoIHsKICAgICAgICAgICAgICAgIGxldCBoYXNoZWRfYWRkcmVzcyA9IGtlY2NhazI1Nihibl9hZGRyZXNzLmFkZHJlc3MoKSk7CiAgICAgICAgICAgICAgICBsZXQgaGFzaGVkX2VudHJ5ID0gU3RvcmFnZUVudHJ5IHsga2V5OiBrZWNjYWsyNTYoZW50cnkua2V5KSwgdmFsdWU6IGVudHJ5LnZhbHVlIH07CgogICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUoZSkgPSB0eAogICAgICAgICAgICAgICAgICAgIC5jdXJzb3JfZHVwX3dyaXRlOjo8dGFibGVzOjpIYXNoZWRTdG9yYWdlcz4oKT8KICAgICAgICAgICAgICAgICAgICAuc2Vla19ieV9rZXlfc3Via2V5KGhhc2hlZF9hZGRyZXNzLCBoYXNoZWRfZW50cnkua2V5KT8KICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKHxlfCBlLmtleSA9PSBoYXNoZWRfZW50cnkua2V5KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHR4LmRlbGV0ZTo6PHRhYmxlczo6SGFzaGVkU3RvcmFnZXM+KGhhc2hlZF9hZGRyZXNzLCBTb21lKGUpKQogICAgICAgICAgICAgICAgICAgICAgICAuZXhwZWN0KCJmYWlsZWQgdG8gZGVsZXRlIGVudHJ5Iik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpIYXNoZWRTdG9yYWdlcz4oaGFzaGVkX2FkZHJlc3MsIGhhc2hlZF9lbnRyeSk/OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OlN0b3JhZ2VDaGFuZ2VTZXRzPihibl9hZGRyZXNzLCBwcmV2X2VudHJ5KT87CiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0KCiAgICAgICAgZm4gdW53aW5kX3N0b3JhZ2UoJnNlbGYsIGlucHV0OiBVbndpbmRJbnB1dCkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgdHJhY2luZzo6ZGVidWchKCJ1bndpbmRpbmcgc3RvcmFnZS4uLiIpOwogICAgICAgICAgICBsZXQgdGFyZ2V0X2Jsb2NrID0gaW5wdXQudW53aW5kX3RvOwogICAgICAgICAgICBzZWxmLmRiLmNvbW1pdCh8dHh8IHsKICAgICAgICAgICAgICAgIGxldCBtdXQgc3RvcmFnZV9jdXJzb3IgPSB0eC5jdXJzb3JfZHVwX3dyaXRlOjo8dGFibGVzOjpQbGFpblN0b3JhZ2VTdGF0ZT4oKT87CiAgICAgICAgICAgICAgICBsZXQgbXV0IGNoYW5nZXNldF9jdXJzb3IgPSB0eC5jdXJzb3JfZHVwX3JlYWQ6Ojx0YWJsZXM6OlN0b3JhZ2VDaGFuZ2VTZXRzPigpPzsKCiAgICAgICAgICAgICAgICBsZXQgbXV0IHJldl9jaGFuZ2VzZXRfd2Fsa2VyID0gY2hhbmdlc2V0X2N1cnNvci53YWxrX2JhY2soTm9uZSk/OwoKICAgICAgICAgICAgICAgIHdoaWxlIGxldCBTb21lKChibl9hZGRyZXNzLCBlbnRyeSkpID0gcmV2X2NoYW5nZXNldF93YWxrZXIubmV4dCgpLnRyYW5zcG9zZSgpPyB7CiAgICAgICAgICAgICAgICAgICAgaWYgYm5fYWRkcmVzcy5ibG9ja19udW1iZXIoKSA8IHRhcmdldF9ibG9jayB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiBzdG9yYWdlX2N1cnNvcgogICAgICAgICAgICAgICAgICAgICAgICAuc2Vla19ieV9rZXlfc3Via2V5KGJuX2FkZHJlc3MuYWRkcmVzcygpLCBlbnRyeS5rZXkpPwogICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKHxlfCBlLmtleSA9PSBlbnRyeS5rZXkpCiAgICAgICAgICAgICAgICAgICAgICAgIC5pc19zb21lKCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JhZ2VfY3Vyc29yLmRlbGV0ZV9jdXJyZW50KCk/OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgIWVudHJ5LnZhbHVlLmlzX3plcm8oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JhZ2VfY3Vyc29yLnVwc2VydChibl9hZGRyZXNzLmFkZHJlc3MoKSwgJmVudHJ5KT87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgT2soKCkpCiAgICAgICAgICAgIH0pPzsKICAgICAgICAgICAgT2soKCkpCiAgICAgICAgfQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvc3RhZ2VzL3NyYy9zdGFnZXMvaGVhZGVycy5ycyI+CnVzZSBhbGxveV9jb25zZW5zdXM6OkJsb2NrSGVhZGVyOwp1c2UgYWxsb3lfcHJpbWl0aXZlczo6e0Jsb2NrSGFzaCwgQmxvY2tOdW1iZXIsIEJ5dGVzLCBCMjU2fTsKdXNlIGZ1dHVyZXNfdXRpbDo6U3RyZWFtRXh0Owp1c2UgcmV0aF9jb25maWc6OmNvbmZpZzo6RXRsQ29uZmlnOwp1c2UgcmV0aF9kYl9hcGk6OnsKICAgIGN1cnNvcjo6e0RiQ3Vyc29yUk8sIERiQ3Vyc29yUld9LAogICAgdGFibGU6OlZhbHVlLAogICAgdGFibGVzLAogICAgdHJhbnNhY3Rpb246OntEYlR4LCBEYlR4TXV0fSwKICAgIERiVHhVbndpbmRFeHQsIFJhd0tleSwgUmF3VGFibGUsIFJhd1ZhbHVlLAp9Owp1c2UgcmV0aF9ldGw6OkNvbGxlY3RvcjsKdXNlIHJldGhfbmV0d29ya19wMnA6OmhlYWRlcnM6OnsKICAgIGRvd25sb2FkZXI6OntIZWFkZXJEb3dubG9hZGVyLCBIZWFkZXJTeW5jR2FwLCBTeW5jVGFyZ2V0fSwKICAgIGVycm9yOjpIZWFkZXJzRG93bmxvYWRlckVycm9yLAp9Owp1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6ewogICAgc2VyZGVfYmluY29kZV9jb21wYXQsIEZ1bGxCbG9ja0hlYWRlciwgSGVhZGVyVHksIE5vZGVQcmltaXRpdmVzLCBTZWFsZWRIZWFkZXIsCn07CnVzZSByZXRoX3Byb3ZpZGVyOjp7CiAgICBwcm92aWRlcnM6OlN0YXRpY0ZpbGVXcml0ZXIsIEJsb2NrSGFzaFJlYWRlciwgREJQcm92aWRlciwgSGVhZGVyU3luY0dhcFByb3ZpZGVyLAogICAgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwKfTsKdXNlIHJldGhfc3RhZ2VzX2FwaTo6ewogICAgQ2hlY2twb2ludEJsb2NrUmFuZ2UsIEVudGl0aWVzQ2hlY2twb2ludCwgRXhlY0lucHV0LCBFeGVjT3V0cHV0LCBIZWFkZXJzQ2hlY2twb2ludCwgU3RhZ2UsCiAgICBTdGFnZUNoZWNrcG9pbnQsIFN0YWdlRXJyb3IsIFN0YWdlSWQsIFVud2luZElucHV0LCBVbndpbmRPdXRwdXQsCn07CnVzZSByZXRoX3N0YXRpY19maWxlX3R5cGVzOjpTdGF0aWNGaWxlU2VnbWVudDsKdXNlIHN0ZDo6dGFzazo6e3JlYWR5LCBDb250ZXh0LCBQb2xsfTsKCnVzZSB0b2tpbzo6c3luYzo6d2F0Y2g7CnVzZSB0cmFjaW5nOjoqOwoKLy8vIFRoZSBoZWFkZXJzIHN0YWdlLgovLy8KLy8vIFRoZSBoZWFkZXJzIHN0YWdlIGRvd25sb2FkcyBhbGwgYmxvY2sgaGVhZGVycyBmcm9tIHRoZSBoaWdoZXN0IGJsb2NrIGluIHN0b3JhZ2UgdG8KLy8vIHRoZSBwZXJjZWl2ZWQgaGlnaGVzdCBibG9jayBvbiB0aGUgbmV0d29yay4KLy8vCi8vLyBUaGUgaGVhZGVycyBhcmUgcHJvY2Vzc2VkIGFuZCBkYXRhIGlzIGluc2VydGVkIGludG8gc3RhdGljIGZpbGVzLCBhcyB3ZWxsIGFzIGludG8gdGhlCi8vLyBbYEhlYWRlck51bWJlcnNgXVtyZXRoX2RiX2FwaTo6dGFibGVzOjpIZWFkZXJOdW1iZXJzXSB0YWJsZS4KLy8vCi8vLyBOT1RFOiBUaGlzIHN0YWdlIGRvd25sb2FkcyBoZWFkZXJzIGluIHJldmVyc2UgYW5kIHB1c2hlcyB0aGVtIHRvIHRoZSBFVEwgW2BDb2xsZWN0b3JgXS4gSXQgdGhlbgovLy8gcHJvY2VlZHMgdG8gcHVzaCB0aGVtIHNlcXVlbnRpYWxseSB0byBzdGF0aWMgZmlsZXMuIFRoZSBzdGFnZSBjaGVja3BvaW50IGlzIG5vdCB1cGRhdGVkIHVudGlsCi8vLyB0aGlzIHN0YWdlIGlzIGRvbmUuCiNbZGVyaXZlKERlYnVnKV0KcHViIHN0cnVjdCBIZWFkZXJTdGFnZTxQcm92aWRlciwgRG93bmxvYWRlcjogSGVhZGVyRG93bmxvYWRlcj4gewogICAgLy8vIERhdGFiYXNlIGhhbmRsZS4KICAgIHByb3ZpZGVyOiBQcm92aWRlciwKICAgIC8vLyBTdHJhdGVneSBmb3IgZG93bmxvYWRpbmcgdGhlIGhlYWRlcnMKICAgIGRvd25sb2FkZXI6IERvd25sb2FkZXIsCiAgICAvLy8gVGhlIHRpcCBmb3IgdGhlIHN0YWdlLgogICAgLy8vCiAgICAvLy8gVGhpcyBkZXRlcm1pbmVzIHRoZSBzeW5jIHRhcmdldCBvZiB0aGUgc3RhZ2UgKHNldCBieSB0aGUgcGlwZWxpbmUpLgogICAgdGlwOiB3YXRjaDo6UmVjZWl2ZXI8QjI1Nj4sCiAgICAvLy8gQ3VycmVudCBzeW5jIGdhcC4KICAgIHN5bmNfZ2FwOiBPcHRpb248SGVhZGVyU3luY0dhcDxEb3dubG9hZGVyOjpIZWFkZXI+PiwKICAgIC8vLyBFVEwgY29sbGVjdG9yIHdpdGggYEhlYWRlckhhc2hgIC0+IGBCbG9ja051bWJlcmAKICAgIGhhc2hfY29sbGVjdG9yOiBDb2xsZWN0b3I8QmxvY2tIYXNoLCBCbG9ja051bWJlcj4sCiAgICAvLy8gRVRMIGNvbGxlY3RvciB3aXRoIGBCbG9ja051bWJlcmAgLT4gYEJpbmNvZGVTZWFsZWRIZWFkZXJgCiAgICBoZWFkZXJfY29sbGVjdG9yOiBDb2xsZWN0b3I8QmxvY2tOdW1iZXIsIEJ5dGVzPiwKICAgIC8vLyBSZXR1cm5zIHRydWUgaWYgdGhlIEVUTCBjb2xsZWN0b3IgaGFzIGFsbCBuZWNlc3NhcnkgaGVhZGVycyB0byBmaWxsIHRoZSBnYXAuCiAgICBpc19ldGxfcmVhZHk6IGJvb2wsCn0KCi8vID09PSBpbXBsIEhlYWRlclN0YWdlID09PQoKaW1wbDxQcm92aWRlciwgRG93bmxvYWRlcj4gSGVhZGVyU3RhZ2U8UHJvdmlkZXIsIERvd25sb2FkZXI+CndoZXJlCiAgICBEb3dubG9hZGVyOiBIZWFkZXJEb3dubG9hZGVyLAp7CiAgICAvLy8gQ3JlYXRlIGEgbmV3IGhlYWRlciBzdGFnZQogICAgcHViIGZuIG5ldygKICAgICAgICBkYXRhYmFzZTogUHJvdmlkZXIsCiAgICAgICAgZG93bmxvYWRlcjogRG93bmxvYWRlciwKICAgICAgICB0aXA6IHdhdGNoOjpSZWNlaXZlcjxCMjU2PiwKICAgICAgICBldGxfY29uZmlnOiBFdGxDb25maWcsCiAgICApIC0+IFNlbGYgewogICAgICAgIFNlbGYgewogICAgICAgICAgICBwcm92aWRlcjogZGF0YWJhc2UsCiAgICAgICAgICAgIGRvd25sb2FkZXIsCiAgICAgICAgICAgIHRpcCwKICAgICAgICAgICAgc3luY19nYXA6IE5vbmUsCiAgICAgICAgICAgIGhhc2hfY29sbGVjdG9yOiBDb2xsZWN0b3I6Om5ldyhldGxfY29uZmlnLmZpbGVfc2l6ZSAvIDIsIGV0bF9jb25maWcuZGlyLmNsb25lKCkpLAogICAgICAgICAgICBoZWFkZXJfY29sbGVjdG9yOiBDb2xsZWN0b3I6Om5ldyhldGxfY29uZmlnLmZpbGVfc2l6ZSAvIDIsIGV0bF9jb25maWcuZGlyKSwKICAgICAgICAgICAgaXNfZXRsX3JlYWR5OiBmYWxzZSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIFdyaXRlIGRvd25sb2FkZWQgaGVhZGVycyB0byBzdG9yYWdlIGZyb20gRVRMLgogICAgLy8vCiAgICAvLy8gV3JpdGVzIHRvIHN0YXRpYyBmaWxlcyAoIGBIZWFkZXIgfCBIZWFkZXJURCB8IEhlYWRlckhhc2hgICkgYW5kIFtgdGFibGVzOjpIZWFkZXJOdW1iZXJzYF0KICAgIC8vLyBkYXRhYmFzZSB0YWJsZS4KICAgIGZuIHdyaXRlX2hlYWRlcnM8UD4oJm11dCBzZWxmLCBwcm92aWRlcjogJlApIC0+IFJlc3VsdDxCbG9ja051bWJlciwgU3RhZ2VFcnJvcj4KICAgIHdoZXJlCiAgICAgICAgUDogREJQcm92aWRlcjxUeDogRGJUeE11dD4gKyBTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5LAogICAgICAgIERvd25sb2FkZXI6IEhlYWRlckRvd25sb2FkZXI8SGVhZGVyID0gPFA6OlByaW1pdGl2ZXMgYXMgTm9kZVByaW1pdGl2ZXM+OjpCbG9ja0hlYWRlcj4sCiAgICAgICAgPFA6OlByaW1pdGl2ZXMgYXMgTm9kZVByaW1pdGl2ZXM+OjpCbG9ja0hlYWRlcjogVmFsdWUgKyBGdWxsQmxvY2tIZWFkZXIsCiAgICB7CiAgICAgICAgbGV0IHRvdGFsX2hlYWRlcnMgPSBzZWxmLmhlYWRlcl9jb2xsZWN0b3IubGVuKCk7CgogICAgICAgIGluZm8hKHRhcmdldDogInN5bmM6OnN0YWdlczo6aGVhZGVycyIsIHRvdGFsID0gdG90YWxfaGVhZGVycywgIldyaXRpbmcgaGVhZGVycyIpOwoKICAgICAgICBsZXQgc3RhdGljX2ZpbGVfcHJvdmlkZXIgPSBwcm92aWRlci5zdGF0aWNfZmlsZV9wcm92aWRlcigpOwoKICAgICAgICAvLyBDb25zaXN0ZW5jeSBjaGVjayBvZiBleHBlY3RlZCBoZWFkZXJzIGluIHN0YXRpYyBmaWxlcyB2cyBEQiBpcyBkb25lIG9uIHByb3ZpZGVyOjpzeW5jX2dhcAogICAgICAgIC8vIHdoZW4gcG9sbF9leGVjdXRlX3JlYWR5IGlzIHBvbGxlZC4KICAgICAgICBsZXQgbXV0IGxhc3RfaGVhZGVyX251bWJlciA9IHN0YXRpY19maWxlX3Byb3ZpZGVyCiAgICAgICAgICAgIC5nZXRfaGlnaGVzdF9zdGF0aWNfZmlsZV9ibG9jayhTdGF0aWNGaWxlU2VnbWVudDo6SGVhZGVycykKICAgICAgICAgICAgLnVud3JhcF9vcl9kZWZhdWx0KCk7CgogICAgICAgIC8vIEFsdGhvdWdoIGhlYWRlcnMgd2VyZSBkb3dubG9hZGVkIGluIHJldmVyc2Ugb3JkZXIsIHRoZSBjb2xsZWN0b3IgaXRlcmF0ZXMgaXQgaW4gYXNjZW5kaW5nCiAgICAgICAgLy8gb3JkZXIKICAgICAgICBsZXQgbXV0IHdyaXRlciA9IHN0YXRpY19maWxlX3Byb3ZpZGVyLmxhdGVzdF93cml0ZXIoU3RhdGljRmlsZVNlZ21lbnQ6OkhlYWRlcnMpPzsKICAgICAgICBsZXQgaW50ZXJ2YWwgPSAodG90YWxfaGVhZGVycyAvIDEwKS5tYXgoMSk7CiAgICAgICAgZm9yIChpbmRleCwgaGVhZGVyKSBpbiBzZWxmLmhlYWRlcl9jb2xsZWN0b3IuaXRlcigpPy5lbnVtZXJhdGUoKSB7CiAgICAgICAgICAgIGxldCAoXywgaGVhZGVyX2J1ZikgPSBoZWFkZXI/OwoKICAgICAgICAgICAgaWYgaW5kZXggPiAwICYmIGluZGV4LmlzX211bHRpcGxlX29mKGludGVydmFsKSAmJiB0b3RhbF9oZWFkZXJzID4gMTAwIHsKICAgICAgICAgICAgICAgIGluZm8hKHRhcmdldDogInN5bmM6OnN0YWdlczo6aGVhZGVycyIsIHByb2dyZXNzID0gJWZvcm1hdCEoIns6LjJ9JSIsIChpbmRleCBhcyBmNjQgLyB0b3RhbF9oZWFkZXJzIGFzIGY2NCkgKiAxMDAuMCksICJXcml0aW5nIGhlYWRlcnMiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IHNlYWxlZF9oZWFkZXI6IFNlYWxlZEhlYWRlcjxEb3dubG9hZGVyOjpIZWFkZXI+ID0KICAgICAgICAgICAgICAgIGJpbmNvZGU6OmRlc2VyaWFsaXplOjo8c2VyZGVfYmluY29kZV9jb21wYXQ6OlNlYWxlZEhlYWRlcjwnXywgXz4+KCZoZWFkZXJfYnVmKQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKHxlcnJ8IFN0YWdlRXJyb3I6OkZhdGFsKEJveDo6bmV3KGVycikpKT8KICAgICAgICAgICAgICAgICAgICAuaW50bygpOwoKICAgICAgICAgICAgbGV0IChoZWFkZXIsIGhlYWRlcl9oYXNoKSA9IHNlYWxlZF9oZWFkZXIuc3BsaXRfcmVmKCk7CiAgICAgICAgICAgIGlmIGhlYWRlci5udW1iZXIoKSA9PSAwIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdF9oZWFkZXJfbnVtYmVyID0gaGVhZGVyLm51bWJlcigpOwoKICAgICAgICAgICAgLy8gQXBwZW5kIHRvIEhlYWRlcnMgc2VnbWVudAogICAgICAgICAgICB3cml0ZXIuYXBwZW5kX2hlYWRlcihoZWFkZXIsIGhlYWRlcl9oYXNoKT87CiAgICAgICAgfQoKICAgICAgICBpbmZvISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OmhlYWRlcnMiLCB0b3RhbCA9IHRvdGFsX2hlYWRlcnMsICJXcml0aW5nIGhlYWRlcnMgaGFzaCBpbmRleCIpOwoKICAgICAgICBsZXQgbXV0IGN1cnNvcl9oZWFkZXJfbnVtYmVycyA9CiAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmN1cnNvcl93cml0ZTo6PFJhd1RhYmxlPHRhYmxlczo6SGVhZGVyTnVtYmVycz4+KCk/OwogICAgICAgIC8vIElmIHdlIG9ubHkgaGF2ZSB0aGUgZ2VuZXNpcyBibG9jayBoYXNoLCB0aGVuIHdlIGFyZSBhdCBmaXJzdCBzeW5jLCBhbmQgd2UgY2FuIHJlbW92ZSBpdCwKICAgICAgICAvLyBhZGQgaXQgdG8gdGhlIGNvbGxlY3RvciBhbmQgdXNlIHR4LmFwcGVuZCBvbiBhbGwgaGFzaGVzLgogICAgICAgIGxldCBmaXJzdF9zeW5jID0gaWYgcHJvdmlkZXIudHhfcmVmKCkuZW50cmllczo6PFJhd1RhYmxlPHRhYmxlczo6SGVhZGVyTnVtYmVycz4+KCk/ID09IDEgJiYKICAgICAgICAgICAgbGV0IFNvbWUoKGhhc2gsIGJsb2NrX251bWJlcikpID0gY3Vyc29yX2hlYWRlcl9udW1iZXJzLmxhc3QoKT8gJiYKICAgICAgICAgICAgYmxvY2tfbnVtYmVyLnZhbHVlKCk/ID09IDAKICAgICAgICB7CiAgICAgICAgICAgIHNlbGYuaGFzaF9jb2xsZWN0b3IuaW5zZXJ0KGhhc2gua2V5KCk/LCAwKT87CiAgICAgICAgICAgIGN1cnNvcl9oZWFkZXJfbnVtYmVycy5kZWxldGVfY3VycmVudCgpPzsKICAgICAgICAgICAgdHJ1ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgfTsKCiAgICAgICAgLy8gU2luY2UgRVRMIHNvcnRzIGFsbCBlbnRyaWVzIGJ5IGhhc2hlcywgd2UgYXJlIGVpdGhlciBhcHBlbmRpbmcgKGZpcnN0IHN5bmMpIG9yIGluc2VydGluZwogICAgICAgIC8vIGluIG9yZGVyIChmdXJ0aGVyIHN5bmNzKS4KICAgICAgICBmb3IgKGluZGV4LCBoYXNoX3RvX251bWJlcikgaW4gc2VsZi5oYXNoX2NvbGxlY3Rvci5pdGVyKCk/LmVudW1lcmF0ZSgpIHsKICAgICAgICAgICAgbGV0IChoYXNoLCBudW1iZXIpID0gaGFzaF90b19udW1iZXI/OwoKICAgICAgICAgICAgaWYgaW5kZXggPiAwICYmIGluZGV4LmlzX211bHRpcGxlX29mKGludGVydmFsKSAmJiB0b3RhbF9oZWFkZXJzID4gMTAwIHsKICAgICAgICAgICAgICAgIGluZm8hKHRhcmdldDogInN5bmM6OnN0YWdlczo6aGVhZGVycyIsIHByb2dyZXNzID0gJWZvcm1hdCEoIns6LjJ9JSIsIChpbmRleCBhcyBmNjQgLyB0b3RhbF9oZWFkZXJzIGFzIGY2NCkgKiAxMDAuMCksICJXcml0aW5nIGhlYWRlcnMgaGFzaCBpbmRleCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiBmaXJzdF9zeW5jIHsKICAgICAgICAgICAgICAgIGN1cnNvcl9oZWFkZXJfbnVtYmVycy5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgUmF3S2V5Ojo8QmxvY2tIYXNoPjo6ZnJvbV92ZWMoaGFzaCksCiAgICAgICAgICAgICAgICAgICAgJlJhd1ZhbHVlOjo8QmxvY2tOdW1iZXI+Ojpmcm9tX3ZlYyhudW1iZXIpLAogICAgICAgICAgICAgICAgKT87CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJzb3JfaGVhZGVyX251bWJlcnMudXBzZXJ0KAogICAgICAgICAgICAgICAgICAgIFJhd0tleTo6PEJsb2NrSGFzaD46OmZyb21fdmVjKGhhc2gpLAogICAgICAgICAgICAgICAgICAgICZSYXdWYWx1ZTo6PEJsb2NrTnVtYmVyPjo6ZnJvbV92ZWMobnVtYmVyKSwKICAgICAgICAgICAgICAgICk/OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBPayhsYXN0X2hlYWRlcl9udW1iZXIpCiAgICB9Cn0KCmltcGw8UHJvdmlkZXIsIFAsIEQ+IFN0YWdlPFByb3ZpZGVyPiBmb3IgSGVhZGVyU3RhZ2U8UCwgRD4Kd2hlcmUKICAgIFByb3ZpZGVyOiBEQlByb3ZpZGVyPFR4OiBEYlR4TXV0PiArIFN0YXRpY0ZpbGVQcm92aWRlckZhY3RvcnksCiAgICBQOiBIZWFkZXJTeW5jR2FwUHJvdmlkZXI8SGVhZGVyID0gPFByb3ZpZGVyOjpQcmltaXRpdmVzIGFzIE5vZGVQcmltaXRpdmVzPjo6QmxvY2tIZWFkZXI+LAogICAgRDogSGVhZGVyRG93bmxvYWRlcjxIZWFkZXIgPSA8UHJvdmlkZXI6OlByaW1pdGl2ZXMgYXMgTm9kZVByaW1pdGl2ZXM+OjpCbG9ja0hlYWRlcj4sCiAgICA8UHJvdmlkZXI6OlByaW1pdGl2ZXMgYXMgTm9kZVByaW1pdGl2ZXM+OjpCbG9ja0hlYWRlcjogRnVsbEJsb2NrSGVhZGVyICsgVmFsdWUsCnsKICAgIC8vLyBSZXR1cm4gdGhlIGlkIG9mIHRoZSBzdGFnZQogICAgZm4gaWQoJnNlbGYpIC0+IFN0YWdlSWQgewogICAgICAgIFN0YWdlSWQ6OkhlYWRlcnMKICAgIH0KCiAgICBmbiBwb2xsX2V4ZWN1dGVfcmVhZHkoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIGN4OiAmbXV0IENvbnRleHQ8J18+LAogICAgICAgIGlucHV0OiBFeGVjSW5wdXQsCiAgICApIC0+IFBvbGw8UmVzdWx0PCgpLCBTdGFnZUVycm9yPj4gewogICAgICAgIGxldCBjdXJyZW50X2NoZWNrcG9pbnQgPSBpbnB1dC5jaGVja3BvaW50KCk7CgogICAgICAgIC8vIFJldHVybiBpZiBzdGFnZSBoYXMgYWxyZWFkeSBjb21wbGV0ZWQgdGhlIGdhcCBvbiB0aGUgRVRMIGZpbGVzCiAgICAgICAgaWYgc2VsZi5pc19ldGxfcmVhZHkgewogICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoT2soKCkpKQogICAgICAgIH0KCiAgICAgICAgLy8gTG9va3VwIHRoZSBoZWFkIGFuZCB0aXAgb2YgdGhlIHN5bmMgcmFuZ2UKICAgICAgICBsZXQgbG9jYWxfaGVhZCA9IHNlbGYucHJvdmlkZXIubG9jYWxfdGlwX2hlYWRlcihjdXJyZW50X2NoZWNrcG9pbnQuYmxvY2tfbnVtYmVyKT87CiAgICAgICAgbGV0IHRhcmdldCA9IFN5bmNUYXJnZXQ6OlRpcCgqc2VsZi50aXAuYm9ycm93KCkpOwogICAgICAgIGxldCBnYXAgPSBIZWFkZXJTeW5jR2FwIHsgbG9jYWxfaGVhZCwgdGFyZ2V0IH07CiAgICAgICAgbGV0IHRpcCA9IGdhcC50YXJnZXQudGlwKCk7CgogICAgICAgIC8vIE5vdGhpbmcgdG8gc3luYwogICAgICAgIGlmIGdhcC5pc19jbG9zZWQoKSB7CiAgICAgICAgICAgIGluZm8hKAogICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpoZWFkZXJzIiwKICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQgPSAlY3VycmVudF9jaGVja3BvaW50LmJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgIHRhcmdldCA9ID90aXAsCiAgICAgICAgICAgICAgICAiVGFyZ2V0IGJsb2NrIGFscmVhZHkgcmVhY2hlZCIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgc2VsZi5pc19ldGxfcmVhZHkgPSB0cnVlOwogICAgICAgICAgICBzZWxmLnN5bmNfZ2FwID0gU29tZShnYXApOwogICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoT2soKCkpKQogICAgICAgIH0KCiAgICAgICAgZGVidWchKHRhcmdldDogInN5bmM6OnN0YWdlczo6aGVhZGVycyIsID90aXAsIGhlYWQgPSA/Z2FwLmxvY2FsX2hlYWQuaGFzaCgpLCAiQ29tbWVuY2luZyBzeW5jIik7CiAgICAgICAgbGV0IGxvY2FsX2hlYWRfbnVtYmVyID0gZ2FwLmxvY2FsX2hlYWQubnVtYmVyKCk7CgogICAgICAgIC8vIGxldCB0aGUgZG93bmxvYWRlciBrbm93IHdoYXQgdG8gc3luYwogICAgICAgIGlmIHNlbGYuc3luY19nYXAgIT0gU29tZShnYXAuY2xvbmUoKSkgewogICAgICAgICAgICBzZWxmLnN5bmNfZ2FwID0gU29tZShnYXAuY2xvbmUoKSk7CiAgICAgICAgICAgIHNlbGYuZG93bmxvYWRlci51cGRhdGVfc3luY19nYXAoZ2FwLmxvY2FsX2hlYWQsIGdhcC50YXJnZXQpOwogICAgICAgIH0KCiAgICAgICAgLy8gV2Ugb25seSB3YW50IHRvIHN0b3Agb25jZSB3ZSBoYXZlIGFsbCB0aGUgaGVhZGVycyBvbiBFVEwgZmlsZXNwYWNlIChkaXNrKS4KICAgICAgICBsb29wIHsKICAgICAgICAgICAgbWF0Y2ggcmVhZHkhKHNlbGYuZG93bmxvYWRlci5wb2xsX25leHRfdW5waW4oY3gpKSB7CiAgICAgICAgICAgICAgICBTb21lKE9rKGhlYWRlcnMpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaW5mbyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpoZWFkZXJzIiwgdG90YWwgPSBoZWFkZXJzLmxlbigpLCBmcm9tX2Jsb2NrID0gaGVhZGVycy5maXJzdCgpLm1hcCh8aHwgaC5udW1iZXIoKSksIHRvX2Jsb2NrID0gaGVhZGVycy5sYXN0KCkubWFwKHxofCBoLm51bWJlcigpKSwgIlJlY2VpdmVkIGhlYWRlcnMiKTsKICAgICAgICAgICAgICAgICAgICBmb3IgaGVhZGVyIGluIGhlYWRlcnMgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgaGVhZGVyX251bWJlciA9IGhlYWRlci5udW1iZXIoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGFzaF9jb2xsZWN0b3IuaW5zZXJ0KGhlYWRlci5oYXNoKCksIGhlYWRlcl9udW1iZXIpPzsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWFkZXJfY29sbGVjdG9yLmluc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcl9udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBCeXRlczo6ZnJvbSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5jb2RlOjpzZXJpYWxpemUoJnNlcmRlX2JpbmNvZGVfY29tcGF0OjpTZWFsZWRIZWFkZXI6OmZyb20oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZoZWFkZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyfCBTdGFnZUVycm9yOjpGYXRhbChCb3g6Om5ldyhlcnIpKSk/LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgKT87CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBIZWFkZXJzIGFyZSBkb3dubG9hZGVkIGluIHJldmVyc2UsIHNvIGlmIHdlIHJlYWNoIGhlcmUsIHdlIGtub3cgd2UgaGF2ZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBmaWxsZWQgdGhlIGdhcC4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgaGVhZGVyX251bWJlciA9PSBsb2NhbF9oZWFkX251bWJlciArIDEgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pc19ldGxfcmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KE9rKCgpKSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFNvbWUoRXJyKEhlYWRlcnNEb3dubG9hZGVyRXJyb3I6OkRldGFjaGVkSGVhZCB7IGxvY2FsX2hlYWQsIGhlYWRlciwgZXJyb3IgfSkpID0+IHsKICAgICAgICAgICAgICAgICAgICBlcnJvciEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpoZWFkZXJzIiwgJWVycm9yLCAiQ2Fubm90IGF0dGFjaCBoZWFkZXIgdG8gaGVhZCIpOwogICAgICAgICAgICAgICAgICAgIHNlbGYuc3luY19nYXAgPSBOb25lOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBQb2xsOjpSZWFkeShFcnIoU3RhZ2VFcnJvcjo6RGV0YWNoZWRIZWFkIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxfaGVhZDogQm94OjpuZXcobG9jYWxfaGVhZC5ibG9ja193aXRoX3BhcmVudCgpKSwKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyOiBCb3g6Om5ldyhoZWFkZXIuYmxvY2tfd2l0aF9wYXJlbnQoKSksCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLAogICAgICAgICAgICAgICAgICAgIH0pKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgTm9uZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zeW5jX2dhcCA9IE5vbmU7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KEVycihTdGFnZUVycm9yOjpDaGFubmVsQ2xvc2VkKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLy8gRG93bmxvYWQgdGhlIGhlYWRlcnMgaW4gcmV2ZXJzZSBvcmRlciAoZmFsbGluZyBibG9jayBudW1iZXJzKQogICAgLy8vIHN0YXJ0aW5nIGZyb20gdGhlIHRpcCBvZiB0aGUgY2hhaW4KICAgIGZuIGV4ZWN1dGUoJm11dCBzZWxmLCBwcm92aWRlcjogJlByb3ZpZGVyLCBpbnB1dDogRXhlY0lucHV0KSAtPiBSZXN1bHQ8RXhlY091dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIGxldCBjdXJyZW50X2NoZWNrcG9pbnQgPSBpbnB1dC5jaGVja3BvaW50KCk7CgogICAgICAgIGlmIHNlbGYuc3luY19nYXAudGFrZSgpLm9rX29yKFN0YWdlRXJyb3I6Ok1pc3NpbmdTeW5jR2FwKT8uaXNfY2xvc2VkKCkgewogICAgICAgICAgICBzZWxmLmlzX2V0bF9yZWFkeSA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm4gT2soRXhlY091dHB1dDo6ZG9uZShjdXJyZW50X2NoZWNrcG9pbnQpKQogICAgICAgIH0KCiAgICAgICAgLy8gV2Ugc2hvdWxkIGJlIGhlcmUgb25seSBhZnRlciB3ZSBoYXZlIGRvd25sb2FkZWQgYWxsIGhlYWRlcnMgaW50byB0aGUgZGlzayBidWZmZXIgKEVUTCkuCiAgICAgICAgaWYgIXNlbGYuaXNfZXRsX3JlYWR5IHsKICAgICAgICAgICAgcmV0dXJuIEVycihTdGFnZUVycm9yOjpNaXNzaW5nRG93bmxvYWRCdWZmZXIpCiAgICAgICAgfQoKICAgICAgICAvLyBSZXNldCBmbGFnCiAgICAgICAgc2VsZi5pc19ldGxfcmVhZHkgPSBmYWxzZTsKCiAgICAgICAgLy8gV3JpdGUgdGhlIGhlYWRlcnMgYW5kIHJlbGF0ZWQgdGFibGVzIHRvIERCIGZyb20gRVRMIHNwYWNlCiAgICAgICAgbGV0IHRvX2JlX3Byb2Nlc3NlZCA9IHNlbGYuaGFzaF9jb2xsZWN0b3IubGVuKCkgYXMgdTY0OwogICAgICAgIGxldCBsYXN0X2hlYWRlcl9udW1iZXIgPSBzZWxmLndyaXRlX2hlYWRlcnMocHJvdmlkZXIpPzsKCiAgICAgICAgLy8gQ2xlYXIgRVRMIGNvbGxlY3RvcnMKICAgICAgICBzZWxmLmhhc2hfY29sbGVjdG9yLmNsZWFyKCk7CiAgICAgICAgc2VsZi5oZWFkZXJfY29sbGVjdG9yLmNsZWFyKCk7CgogICAgICAgIE9rKEV4ZWNPdXRwdXQgewogICAgICAgICAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhsYXN0X2hlYWRlcl9udW1iZXIpLndpdGhfaGVhZGVyc19zdGFnZV9jaGVja3BvaW50KAogICAgICAgICAgICAgICAgSGVhZGVyc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgIGJsb2NrX3JhbmdlOiBDaGVja3BvaW50QmxvY2tSYW5nZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IGlucHV0LmNoZWNrcG9pbnQoKS5ibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvOiBsYXN0X2hlYWRlcl9udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkOiBpbnB1dC5jaGVja3BvaW50KCkuYmxvY2tfbnVtYmVyICsgdG9fYmVfcHJvY2Vzc2VkLAogICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogbGFzdF9oZWFkZXJfbnVtYmVyLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICApLAogICAgICAgICAgICAvLyBXZSBvbmx5IHJlYWNoIGhlcmUgaWYgYWxsIGhlYWRlcnMgaGF2ZSBiZWVuIGRvd25sb2FkZWQgYnkgRVRMLCBhbmQgcHVzaGVkIHRvIERCIGFsbAogICAgICAgICAgICAvLyBpbiBvbmUgc3RhZ2UgcnVuLgogICAgICAgICAgICBkb25lOiB0cnVlLAogICAgICAgIH0pCiAgICB9CgogICAgLy8vIFVud2luZCB0aGUgc3RhZ2UuCiAgICBmbiB1bndpbmQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICAgICAgaW5wdXQ6IFVud2luZElucHV0LAogICAgKSAtPiBSZXN1bHQ8VW53aW5kT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgc2VsZi5zeW5jX2dhcC50YWtlKCk7CgogICAgICAgIC8vIEZpcnN0IHVud2luZCB0aGUgZGIgdGFibGVzLCB1bnRpbCB0aGUgdW53aW5kX3RvIGJsb2NrIG51bWJlci4gdXNlIHRoZSB3YWxrZXIgdG8gdW53aW5kCiAgICAgICAgLy8gSGVhZGVyTnVtYmVycyBiYXNlZCBvbiB0aGUgaW5kZXggaW4gQ2Fub25pY2FsSGVhZGVycwogICAgICAgIC8vIHVud2luZCBmcm9tIHRoZSBuZXh0IGJsb2NrIG51bWJlciBzaW5jZSB0aGUgdW53aW5kX3RvIGJsb2NrIGlzIGV4Y2x1c2l2ZQogICAgICAgIHByb3ZpZGVyCiAgICAgICAgICAgIC50eF9yZWYoKQogICAgICAgICAgICAudW53aW5kX3RhYmxlX2J5X3dhbGtlcjo6PHRhYmxlczo6Q2Fub25pY2FsSGVhZGVycywgdGFibGVzOjpIZWFkZXJOdW1iZXJzPigKICAgICAgICAgICAgICAgIChpbnB1dC51bndpbmRfdG8gKyAxKS4uLAogICAgICAgICAgICApPzsKICAgICAgICBwcm92aWRlci50eF9yZWYoKS51bndpbmRfdGFibGVfYnlfbnVtOjo8dGFibGVzOjpDYW5vbmljYWxIZWFkZXJzPihpbnB1dC51bndpbmRfdG8pPzsKICAgICAgICBsZXQgdW5maW5hbGl6ZWRfaGVhZGVyc191bndvdW5kID0gcHJvdmlkZXIudHhfcmVmKCkudW53aW5kX3RhYmxlX2J5X251bTo6PHRhYmxlczo6SGVhZGVyczwKICAgICAgICAgICAgSGVhZGVyVHk8UHJvdmlkZXI6OlByaW1pdGl2ZXM+LAogICAgICAgID4+KGlucHV0LnVud2luZF90byk/OwoKICAgICAgICAvLyBkZXRlcm1pbmUgaG93IG1hbnkgaGVhZGVycyB0byB1bndpbmQgZnJvbSB0aGUgc3RhdGljIGZpbGVzIGJhc2VkIG9uIHRoZSBoaWdoZXN0IGJsb2NrIGFuZAogICAgICAgIC8vIHRoZSB1bndpbmRfdG8gYmxvY2sKICAgICAgICBsZXQgc3RhdGljX2ZpbGVfcHJvdmlkZXIgPSBwcm92aWRlci5zdGF0aWNfZmlsZV9wcm92aWRlcigpOwogICAgICAgIGxldCBoaWdoZXN0X2Jsb2NrID0gc3RhdGljX2ZpbGVfcHJvdmlkZXIKICAgICAgICAgICAgLmdldF9oaWdoZXN0X3N0YXRpY19maWxlX2Jsb2NrKFN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKQogICAgICAgICAgICAudW53cmFwX29yX2RlZmF1bHQoKTsKICAgICAgICBsZXQgc3RhdGljX2ZpbGVfaGVhZGVyc190b191bndpbmQgPSBoaWdoZXN0X2Jsb2NrIC0gaW5wdXQudW53aW5kX3RvOwogICAgICAgIGZvciBibG9ja19udW1iZXIgaW4gKGlucHV0LnVud2luZF90byArIDEpLi49aGlnaGVzdF9ibG9jayB7CiAgICAgICAgICAgIGxldCBoYXNoID0gc3RhdGljX2ZpbGVfcHJvdmlkZXIuYmxvY2tfaGFzaChibG9ja19udW1iZXIpPzsKICAgICAgICAgICAgLy8gd2UgaGF2ZSB0byBkZWxldGUgZnJvbSBIZWFkZXJOdW1iZXJzIGhlcmUgYXMgd2VsbCBhcyBpbiB0aGUgYWJvdmUgdW53aW5kLCBzaW5jZSB0aGF0CiAgICAgICAgICAgIC8vIG1hcHBpbmcgY29udGFpbnMgZW50cmllcyBmb3IgYm90aCBoZWFkZXJzIGluIHRoZSBkYiBhbmQgaGVhZGVycyBpbiBzdGF0aWMgZmlsZXMKICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gc28gaWYgd2UgYXJlIHVud2luZGluZyBwYXN0IHRoZSBsb3dlc3QgYmxvY2sgaW4gdGhlIGRiLCB3ZSBoYXZlIHRvIGl0ZXJhdGUgdGhyb3VnaAogICAgICAgICAgICAvLyB0aGUgSGVhZGVyTnVtYmVycyBlbnRyaWVzIHRoYXQgd2UnbGwgZGVsZXRlIGluIHN0YXRpYyBmaWxlcyBiZWxvdwogICAgICAgICAgICBpZiBsZXQgU29tZShoZWFkZXJfaGFzaCkgPSBoYXNoIHsKICAgICAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmRlbGV0ZTo6PHRhYmxlczo6SGVhZGVyTnVtYmVycz4oaGVhZGVyX2hhc2gsIE5vbmUpPzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTm93IHVud2luZCB0aGUgc3RhdGljIGZpbGVzIHVudGlsIHRoZSB1bndpbmRfdG8gYmxvY2sgbnVtYmVyCiAgICAgICAgbGV0IG11dCB3cml0ZXIgPSBzdGF0aWNfZmlsZV9wcm92aWRlci5sYXRlc3Rfd3JpdGVyKFN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKT87CiAgICAgICAgd3JpdGVyLnBydW5lX2hlYWRlcnMoc3RhdGljX2ZpbGVfaGVhZGVyc190b191bndpbmQpPzsKCiAgICAgICAgLy8gU2V0IHRoZSBzdGFnZSBjaGVja3BvaW50IGVudGl0aWVzIHByb2Nlc3NlZCBiYXNlZCBvbiBob3cgbXVjaCB3ZSB1bndvdW5kIC0gd2UgYWRkIHRoZQogICAgICAgIC8vIGhlYWRlcnMgdW53b3VuZCBmcm9tIHN0YXRpYyBmaWxlcyBhbmQgZGIKICAgICAgICBsZXQgc3RhZ2VfY2hlY2twb2ludCA9CiAgICAgICAgICAgIGlucHV0LmNoZWNrcG9pbnQuaGVhZGVyc19zdGFnZV9jaGVja3BvaW50KCkubWFwKHxzdGFnZV9jaGVja3BvaW50fCBIZWFkZXJzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICBibG9ja19yYW5nZTogc3RhZ2VfY2hlY2twb2ludC5ibG9ja19yYW5nZSwKICAgICAgICAgICAgICAgIHByb2dyZXNzOiBFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZDogc3RhZ2VfY2hlY2twb2ludC5wcm9ncmVzcy5wcm9jZXNzZWQuc2F0dXJhdGluZ19zdWIoCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRpY19maWxlX2hlYWRlcnNfdG9fdW53aW5kICsgdW5maW5hbGl6ZWRfaGVhZGVyc191bndvdW5kIGFzIHU2NCwKICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIHRvdGFsOiBzdGFnZV9jaGVja3BvaW50LnByb2dyZXNzLnRvdGFsLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfSk7CgogICAgICAgIGxldCBtdXQgY2hlY2twb2ludCA9IFN0YWdlQ2hlY2twb2ludDo6bmV3KGlucHV0LnVud2luZF90byk7CiAgICAgICAgaWYgbGV0IFNvbWUoc3RhZ2VfY2hlY2twb2ludCkgPSBzdGFnZV9jaGVja3BvaW50IHsKICAgICAgICAgICAgY2hlY2twb2ludCA9IGNoZWNrcG9pbnQud2l0aF9oZWFkZXJzX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfY2hlY2twb2ludCk7CiAgICAgICAgfQoKICAgICAgICBPayhVbndpbmRPdXRwdXQgeyBjaGVja3BvaW50IH0pCiAgICB9Cn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdHMgewogICAgdXNlIHN1cGVyOjoqOwogICAgdXNlIGNyYXRlOjp0ZXN0X3V0aWxzOjp7CiAgICAgICAgc3RhZ2VfdGVzdF9zdWl0ZSwgRXhlY3V0ZVN0YWdlVGVzdFJ1bm5lciwgU3RhZ2VUZXN0UnVubmVyLCBVbndpbmRTdGFnZVRlc3RSdW5uZXIsCiAgICB9OwogICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkIyNTY7CiAgICB1c2UgYXNzZXJ0X21hdGNoZXM6OmFzc2VydF9tYXRjaGVzOwogICAgdXNlIHJldGhfcHJvdmlkZXI6OntEYXRhYmFzZVByb3ZpZGVyRmFjdG9yeSwgUHJvdmlkZXJGYWN0b3J5LCBTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5fTsKICAgIHVzZSByZXRoX3N0YWdlc19hcGk6OlN0YWdlVW5pdENoZWNrcG9pbnQ7CiAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjpnZW5lcmF0b3JzOjp7c2VsZiwgcmFuZG9tX2hlYWRlciwgcmFuZG9tX2hlYWRlcl9yYW5nZX07CiAgICB1c2Ugc3RkOjpzeW5jOjpBcmM7CiAgICB1c2UgdGVzdF9ydW5uZXI6OkhlYWRlcnNUZXN0UnVubmVyOwoKICAgIG1vZCB0ZXN0X3J1bm5lciB7CiAgICAgICAgdXNlIHN1cGVyOjoqOwogICAgICAgIHVzZSBjcmF0ZTo6dGVzdF91dGlsczo6e1Rlc3RSdW5uZXJFcnJvciwgVGVzdFN0YWdlREJ9OwogICAgICAgIHVzZSByZXRoX2NvbnNlbnN1czo6dGVzdF91dGlsczo6VGVzdENvbnNlbnN1czsKICAgICAgICB1c2UgcmV0aF9kb3dubG9hZGVyczo6aGVhZGVyczo6cmV2ZXJzZV9oZWFkZXJzOjp7CiAgICAgICAgICAgIFJldmVyc2VIZWFkZXJzRG93bmxvYWRlciwgUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyQnVpbGRlciwKICAgICAgICB9OwogICAgICAgIHVzZSByZXRoX25ldHdvcmtfcDJwOjp0ZXN0X3V0aWxzOjp7VGVzdEhlYWRlckRvd25sb2FkZXIsIFRlc3RIZWFkZXJzQ2xpZW50fTsKICAgICAgICB1c2UgcmV0aF9wcm92aWRlcjo6e3Rlc3RfdXRpbHM6Ok1vY2tOb2RlVHlwZXNXaXRoREIsIEJsb2NrTnVtUmVhZGVyLCBIZWFkZXJQcm92aWRlcn07CiAgICAgICAgdXNlIHRva2lvOjpzeW5jOjp3YXRjaDsKCiAgICAgICAgcHViKGNyYXRlKSBzdHJ1Y3QgSGVhZGVyc1Rlc3RSdW5uZXI8RDogSGVhZGVyRG93bmxvYWRlcj4gewogICAgICAgICAgICBwdWIoY3JhdGUpIGNsaWVudDogVGVzdEhlYWRlcnNDbGllbnQsCiAgICAgICAgICAgIGNoYW5uZWw6ICh3YXRjaDo6U2VuZGVyPEIyNTY+LCB3YXRjaDo6UmVjZWl2ZXI8QjI1Nj4pLAogICAgICAgICAgICBkb3dubG9hZGVyX2ZhY3Rvcnk6IEJveDxkeW4gRm4oKSAtPiBEICsgU2VuZCArIFN5bmMgKyAnc3RhdGljPiwKICAgICAgICAgICAgZGI6IFRlc3RTdGFnZURCLAogICAgICAgIH0KCiAgICAgICAgaW1wbCBEZWZhdWx0IGZvciBIZWFkZXJzVGVzdFJ1bm5lcjxUZXN0SGVhZGVyRG93bmxvYWRlcj4gewogICAgICAgICAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgICAgICAgICBsZXQgY2xpZW50ID0gVGVzdEhlYWRlcnNDbGllbnQ6OmRlZmF1bHQoKTsKICAgICAgICAgICAgICAgIFNlbGYgewogICAgICAgICAgICAgICAgICAgIGNsaWVudDogY2xpZW50LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgY2hhbm5lbDogd2F0Y2g6OmNoYW5uZWwoQjI1Njo6WkVSTyksCgogICAgICAgICAgICAgICAgICAgIGRvd25sb2FkZXJfZmFjdG9yeTogQm94OjpuZXcobW92ZSB8fCB7CiAgICAgICAgICAgICAgICAgICAgICAgIFRlc3RIZWFkZXJEb3dubG9hZGVyOjpuZXcoY2xpZW50LmNsb25lKCksIDEwMDAsIDEwMDApCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgZGI6IFRlc3RTdGFnZURCOjpkZWZhdWx0KCksCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGw8RDogSGVhZGVyRG93bmxvYWRlcjxIZWFkZXIgPSBhbGxveV9jb25zZW5zdXM6OkhlYWRlcj4gKyAnc3RhdGljPiBTdGFnZVRlc3RSdW5uZXIKICAgICAgICAgICAgZm9yIEhlYWRlcnNUZXN0UnVubmVyPEQ+CiAgICAgICAgewogICAgICAgICAgICB0eXBlIFMgPSBIZWFkZXJTdGFnZTxQcm92aWRlckZhY3Rvcnk8TW9ja05vZGVUeXBlc1dpdGhEQj4sIEQ+OwoKICAgICAgICAgICAgZm4gZGIoJnNlbGYpIC0+ICZUZXN0U3RhZ2VEQiB7CiAgICAgICAgICAgICAgICAmc2VsZi5kYgogICAgICAgICAgICB9CgogICAgICAgICAgICBmbiBzdGFnZSgmc2VsZikgLT4gU2VsZjo6UyB7CiAgICAgICAgICAgICAgICBIZWFkZXJTdGFnZTo6bmV3KAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuZmFjdG9yeS5jbG9uZSgpLAogICAgICAgICAgICAgICAgICAgICgqc2VsZi5kb3dubG9hZGVyX2ZhY3RvcnkpKCksCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jaGFubmVsLjEuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBFdGxDb25maWc6OmRlZmF1bHQoKSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaW1wbDxEOiBIZWFkZXJEb3dubG9hZGVyPEhlYWRlciA9IGFsbG95X2NvbnNlbnN1czo6SGVhZGVyPiArICdzdGF0aWM+IEV4ZWN1dGVTdGFnZVRlc3RSdW5uZXIKICAgICAgICAgICAgZm9yIEhlYWRlcnNUZXN0UnVubmVyPEQ+CiAgICAgICAgewogICAgICAgICAgICB0eXBlIFNlZWQgPSBWZWM8U2VhbGVkSGVhZGVyPjsKCiAgICAgICAgICAgIGZuIHNlZWRfZXhlY3V0aW9uKCZtdXQgc2VsZiwgaW5wdXQ6IEV4ZWNJbnB1dCkgLT4gUmVzdWx0PFNlbGY6OlNlZWQsIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICAgICAgbGV0IG11dCBybmcgPSBnZW5lcmF0b3JzOjpybmcoKTsKICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IGlucHV0LmNoZWNrcG9pbnQoKS5ibG9ja19udW1iZXI7CiAgICAgICAgICAgICAgICBsZXQgaGVhZGVycyA9IHJhbmRvbV9oZWFkZXJfcmFuZ2UoJm11dCBybmcsIDAuLnN0YXJ0ICsgMSwgQjI1Njo6WkVSTyk7CiAgICAgICAgICAgICAgICBsZXQgaGVhZCA9IGhlYWRlcnMubGFzdCgpLmNsb25lZCgpLnVud3JhcCgpOwogICAgICAgICAgICAgICAgc2VsZi5kYi5pbnNlcnRfaGVhZGVycyhoZWFkZXJzLml0ZXIoKSk/OwoKICAgICAgICAgICAgICAgIC8vIHVzZSBwcmV2aW91cyBjaGVja3BvaW50IGFzIHNlZWQgc2l6ZQogICAgICAgICAgICAgICAgbGV0IGVuZCA9IGlucHV0LnRhcmdldC51bndyYXBfb3JfZGVmYXVsdCgpICsgMTsKCiAgICAgICAgICAgICAgICBpZiBzdGFydCArIDEgPj0gZW5kIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2soVmVjOjpkZWZhdWx0KCkpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGV0IG11dCBoZWFkZXJzID0gcmFuZG9tX2hlYWRlcl9yYW5nZSgmbXV0IHJuZywgc3RhcnQgKyAxLi5lbmQsIGhlYWQuaGFzaCgpKTsKICAgICAgICAgICAgICAgIGhlYWRlcnMuaW5zZXJ0KDAsIGhlYWQpOwogICAgICAgICAgICAgICAgT2soaGVhZGVycykKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8vIFZhbGlkYXRlIHN0b3JlZCBoZWFkZXJzCiAgICAgICAgICAgIGZuIHZhbGlkYXRlX2V4ZWN1dGlvbigKICAgICAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICAgICAgaW5wdXQ6IEV4ZWNJbnB1dCwKICAgICAgICAgICAgICAgIG91dHB1dDogT3B0aW9uPEV4ZWNPdXRwdXQ+LAogICAgICAgICAgICApIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgICAgICBsZXQgaW5pdGlhbF9jaGVja3BvaW50ID0gaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlcjsKICAgICAgICAgICAgICAgIG1hdGNoIG91dHB1dCB7CiAgICAgICAgICAgICAgICAgICAgU29tZShvdXRwdXQpIGlmIG91dHB1dC5jaGVja3BvaW50LmJsb2NrX251bWJlciA+IGluaXRpYWxfY2hlY2twb2ludCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwcm92aWRlciA9IHNlbGYuZGIuZmFjdG9yeS5wcm92aWRlcigpPzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBibG9ja19udW0gaW4gaW5pdGlhbF9jaGVja3BvaW50Li5vdXRwdXQuY2hlY2twb2ludC5ibG9ja19udW1iZXIgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbG9vayB1cCB0aGUgaGVhZGVyIGhhc2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBoYXNoID0gcHJvdmlkZXIuYmxvY2tfaGFzaChibG9ja19udW0pPy5leHBlY3QoIm5vIGhlYWRlciBoYXNoIik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdmFsaWRhdGUgdGhlIGhlYWRlciBudW1iZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9lcSEocHJvdmlkZXIuYmxvY2tfbnVtYmVyKGhhc2gpPywgU29tZShibG9ja19udW0pKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB2YWxpZGF0ZSB0aGUgaGVhZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgaGVhZGVyID0gcHJvdmlkZXIuaGVhZGVyX2J5X251bWJlcihibG9ja19udW0pPzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydCEoaGVhZGVyLmlzX3NvbWUoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgaGVhZGVyID0gU2VhbGVkSGVhZGVyOjpzZWFsX3Nsb3coaGVhZGVyLnVud3JhcCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9lcSEoaGVhZGVyLmhhc2goKSwgaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgXyA9PiBzZWxmLmNoZWNrX25vX2hlYWRlcl9lbnRyeV9hYm92ZShpbml0aWFsX2NoZWNrcG9pbnQpPywKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBPaygoKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYXN5bmMgZm4gYWZ0ZXJfZXhlY3V0aW9uKCZzZWxmLCBoZWFkZXJzOiBTZWxmOjpTZWVkKSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICAgICAgc2VsZi5jbGllbnQuZXh0ZW5kKGhlYWRlcnMuaXRlcigpLm1hcCh8aHwgaC5jbG9uZV9oZWFkZXIoKSkpLmF3YWl0OwogICAgICAgICAgICAgICAgbGV0IHRpcCA9IGlmIGhlYWRlcnMuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRpcCA9IHJhbmRvbV9oZWFkZXIoJm11dCBnZW5lcmF0b3JzOjpybmcoKSwgMCwgTm9uZSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5pbnNlcnRfaGVhZGVycyhzdGQ6Oml0ZXI6Om9uY2UoJnRpcCkpPzsKICAgICAgICAgICAgICAgICAgICB0aXAuaGFzaCgpCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGhlYWRlcnMubGFzdCgpLnVud3JhcCgpLmhhc2goKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90aXAodGlwKTsKICAgICAgICAgICAgICAgIE9rKCgpKQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpbXBsPEQ6IEhlYWRlckRvd25sb2FkZXI8SGVhZGVyID0gYWxsb3lfY29uc2Vuc3VzOjpIZWFkZXI+ICsgJ3N0YXRpYz4gVW53aW5kU3RhZ2VUZXN0UnVubmVyCiAgICAgICAgICAgIGZvciBIZWFkZXJzVGVzdFJ1bm5lcjxEPgogICAgICAgIHsKICAgICAgICAgICAgZm4gdmFsaWRhdGVfdW53aW5kKCZzZWxmLCBpbnB1dDogVW53aW5kSW5wdXQpIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgICAgICBzZWxmLmNoZWNrX25vX2hlYWRlcl9lbnRyeV9hYm92ZShpbnB1dC51bndpbmRfdG8pCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGwgSGVhZGVyc1Rlc3RSdW5uZXI8UmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyPFRlc3RIZWFkZXJzQ2xpZW50Pj4gewogICAgICAgICAgICBwdWIoY3JhdGUpIGZuIHdpdGhfbGluZWFyX2Rvd25sb2FkZXIoKSAtPiBTZWxmIHsKICAgICAgICAgICAgICAgIGxldCBjbGllbnQgPSBUZXN0SGVhZGVyc0NsaWVudDo6ZGVmYXVsdCgpOwogICAgICAgICAgICAgICAgU2VsZiB7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50OiBjbGllbnQuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBjaGFubmVsOiB3YXRjaDo6Y2hhbm5lbChCMjU2OjpaRVJPKSwKICAgICAgICAgICAgICAgICAgICBkb3dubG9hZGVyX2ZhY3Rvcnk6IEJveDo6bmV3KG1vdmUgfHwgewogICAgICAgICAgICAgICAgICAgICAgICBSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJCdWlsZGVyOjpkZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zdHJlYW1fYmF0Y2hfc2l6ZSg1MDApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYnVpbGQoY2xpZW50LmNsb25lKCksIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSkpCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgZGI6IFRlc3RTdGFnZURCOjpkZWZhdWx0KCksCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGltcGw8RDogSGVhZGVyRG93bmxvYWRlcj4gSGVhZGVyc1Rlc3RSdW5uZXI8RD4gewogICAgICAgICAgICBwdWIoY3JhdGUpIGZuIGNoZWNrX25vX2hlYWRlcl9lbnRyeV9hYm92ZSgKICAgICAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICAgICAgYmxvY2s6IEJsb2NrTnVtYmVyLAogICAgICAgICAgICApIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgICAgICBzZWxmLmRiCiAgICAgICAgICAgICAgICAgICAgLmVuc3VyZV9ub19lbnRyeV9hYm92ZV9ieV92YWx1ZTo6PHRhYmxlczo6SGVhZGVyTnVtYmVycywgXz4oYmxvY2ssIHx2YWx8IHZhbCk/OwogICAgICAgICAgICAgICAgc2VsZi5kYi5lbnN1cmVfbm9fZW50cnlfYWJvdmU6Ojx0YWJsZXM6OkNhbm9uaWNhbEhlYWRlcnMsIF8+KGJsb2NrLCB8a2V5fCBrZXkpPzsKICAgICAgICAgICAgICAgIHNlbGYuZGIuZW5zdXJlX25vX2VudHJ5X2Fib3ZlOjo8dGFibGVzOjpIZWFkZXJzLCBfPihibG9jaywgfGtleXwga2V5KT87CiAgICAgICAgICAgICAgICBPaygoKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcHViKGNyYXRlKSBmbiBzZW5kX3RpcCgmc2VsZiwgdGlwOiBCMjU2KSB7CiAgICAgICAgICAgICAgICBzZWxmLmNoYW5uZWwuMC5zZW5kKHRpcCkuZXhwZWN0KCJmYWlsZWQgdG8gc2VuZCB0aXAiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBzdGFnZV90ZXN0X3N1aXRlIShIZWFkZXJzVGVzdFJ1bm5lciwgaGVhZGVycyk7CgogICAgLy8vIEV4ZWN1dGUgdGhlIHN0YWdlIHdpdGggbGluZWFyIGRvd25sb2FkZXIsIHVud2luZHMsIGFuZCBlbnN1cmVzIHRoYXQgdGhlIGRhdGFiYXNlIHRhYmxlcwogICAgLy8vIGFsb25nIHdpdGggdGhlIHN0YXRpYyBmaWxlcyBhcmUgY2xlYW5lZCB1cC4KICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBleGVjdXRlX3dpdGhfbGluZWFyX2Rvd25sb2FkZXJfdW53aW5kKCkgewogICAgICAgIGxldCBtdXQgcnVubmVyID0gSGVhZGVyc1Rlc3RSdW5uZXI6OndpdGhfbGluZWFyX2Rvd25sb2FkZXIoKTsKICAgICAgICBsZXQgKGNoZWNrcG9pbnQsIHByZXZpb3VzX3N0YWdlKSA9ICgxMDAwLCAxMjAwKTsKICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgewogICAgICAgICAgICB0YXJnZXQ6IFNvbWUocHJldmlvdXNfc3RhZ2UpLAogICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KGNoZWNrcG9pbnQpKSwKICAgICAgICB9OwogICAgICAgIGxldCBoZWFkZXJzID0gcnVubmVyLnNlZWRfZXhlY3V0aW9uKGlucHV0KS5leHBlY3QoImZhaWxlZCB0byBzZWVkIGV4ZWN1dGlvbiIpOwogICAgICAgIGxldCByeCA9IHJ1bm5lci5leGVjdXRlKGlucHV0KTsKCiAgICAgICAgcnVubmVyLmNsaWVudC5leHRlbmQoaGVhZGVycy5pdGVyKCkucmV2KCkubWFwKHxofCBoLmNsb25lX2hlYWRlcigpKSkuYXdhaXQ7CgogICAgICAgIC8vIHNraXAgYGFmdGVyX2V4ZWN1dGlvbmAgaG9vayBmb3IgbGluZWFyIGRvd25sb2FkZXIKICAgICAgICBsZXQgdGlwID0gaGVhZGVycy5sYXN0KCkudW53cmFwKCk7CiAgICAgICAgcnVubmVyLnNlbmRfdGlwKHRpcC5oYXNoKCkpOwoKICAgICAgICBsZXQgcmVzdWx0ID0gcnguYXdhaXQudW53cmFwKCk7CiAgICAgICAgcnVubmVyLmRiKCkuZmFjdG9yeS5zdGF0aWNfZmlsZV9wcm92aWRlcigpLmNvbW1pdCgpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9tYXRjaGVzIShyZXN1bHQsIE9rKEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQgewogICAgICAgICAgICBibG9ja19udW1iZXIsCiAgICAgICAgICAgIHN0YWdlX2NoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VVbml0Q2hlY2twb2ludDo6SGVhZGVycyhIZWFkZXJzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICBibG9ja19yYW5nZTogQ2hlY2twb2ludEJsb2NrUmFuZ2UgewogICAgICAgICAgICAgICAgICAgIGZyb20sCiAgICAgICAgICAgICAgICAgICAgdG8KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWQsCiAgICAgICAgICAgICAgICAgICAgdG90YWwsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pKQogICAgICAgIH0sIGRvbmU6IHRydWUgfSkgaWYgYmxvY2tfbnVtYmVyID09IHRpcC5udW1iZXIgJiYKICAgICAgICAgICAgZnJvbSA9PSBjaGVja3BvaW50ICYmIHRvID09IHByZXZpb3VzX3N0YWdlICYmCiAgICAgICAgICAgIC8vIC0xIGJlY2F1c2Ugd2UgZG9uJ3QgbmVlZCB0byBkb3dubG9hZCB0aGUgbG9jYWwgaGVhZAogICAgICAgICAgICBwcm9jZXNzZWQgPT0gY2hlY2twb2ludCArIGhlYWRlcnMubGVuKCkgYXMgdTY0IC0gMSAmJiB0b3RhbCA9PSB0aXAubnVtYmVyCiAgICAgICAgKTsKICAgICAgICBhc3NlcnQhKHJ1bm5lci52YWxpZGF0ZV9leGVjdXRpb24oaW5wdXQsIHJlc3VsdC5vaygpKS5pc19vaygpLCAidmFsaWRhdGlvbiBmYWlsZWQiKTsKICAgICAgICBhc3NlcnQhKHJ1bm5lci5zdGFnZSgpLmhhc2hfY29sbGVjdG9yLmlzX2VtcHR5KCkpOwogICAgICAgIGFzc2VydCEocnVubmVyLnN0YWdlKCkuaGVhZGVyX2NvbGxlY3Rvci5pc19lbXB0eSgpKTsKCiAgICAgICAgLy8gbGV0J3MgaW5zZXJ0IHNvbWUgYmxvY2tzIHVzaW5nIGFwcGVuZF9ibG9ja3Nfd2l0aF9zdGF0ZQogICAgICAgIGxldCBzZWFsZWRfaGVhZGVycyA9IHJhbmRvbV9oZWFkZXJfcmFuZ2UoCiAgICAgICAgICAgICZtdXQgZ2VuZXJhdG9yczo6cm5nKCksCiAgICAgICAgICAgIHRpcC5udW1iZXIgKyAxLi50aXAubnVtYmVyICsgMTAsCiAgICAgICAgICAgIHRpcC5oYXNoKCksCiAgICAgICAgKTsKCiAgICAgICAgbGV0IHByb3ZpZGVyID0gcnVubmVyLmRiKCkuZmFjdG9yeS5kYXRhYmFzZV9wcm92aWRlcl9ydygpLnVud3JhcCgpOwogICAgICAgIGxldCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IHByb3ZpZGVyLnN0YXRpY19maWxlX3Byb3ZpZGVyKCk7CiAgICAgICAgbGV0IG11dCB3cml0ZXIgPSBzdGF0aWNfZmlsZV9wcm92aWRlci5sYXRlc3Rfd3JpdGVyKFN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKS51bndyYXAoKTsKICAgICAgICBmb3IgaGVhZGVyIGluIHNlYWxlZF9oZWFkZXJzIHsKICAgICAgICAgICAgd3JpdGVyLmFwcGVuZF9oZWFkZXIoaGVhZGVyLmhlYWRlcigpLCAmaGVhZGVyLmhhc2goKSkudW53cmFwKCk7CiAgICAgICAgfQogICAgICAgIGRyb3Aod3JpdGVyKTsKCiAgICAgICAgcHJvdmlkZXIuY29tbWl0KCkudW53cmFwKCk7CgogICAgICAgIC8vIG5vdyB3ZSBjYW4gdW53aW5kIDEwIGJsb2NrcwogICAgICAgIGxldCB1bndpbmRfaW5wdXQgPSBVbndpbmRJbnB1dCB7CiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KHRpcC5udW1iZXIgKyAxMCksCiAgICAgICAgICAgIHVud2luZF90bzogdGlwLm51bWJlciwKICAgICAgICAgICAgYmFkX2Jsb2NrOiBOb25lLAogICAgICAgIH07CgogICAgICAgIGxldCB1bndpbmRfb3V0cHV0ID0gcnVubmVyLnVud2luZCh1bndpbmRfaW5wdXQpLmF3YWl0LnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEodW53aW5kX291dHB1dC5jaGVja3BvaW50LmJsb2NrX251bWJlciwgdGlwLm51bWJlcik7CgogICAgICAgIC8vIHZhbGlkYXRlIHRoZSB1bndpbmQsIGVuc3VyZSB0aGF0IHRoZSB0YWJsZXMgYXJlIGNsZWFuZWQgdXAKICAgICAgICBhc3NlcnQhKHJ1bm5lci52YWxpZGF0ZV91bndpbmQodW53aW5kX2lucHV0KS5pc19vaygpKTsKICAgIH0KCiAgICAvLy8gRXhlY3V0ZSB0aGUgc3RhZ2Ugd2l0aCBsaW5lYXIgZG93bmxvYWRlcgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGV4ZWN1dGVfd2l0aF9saW5lYXJfZG93bmxvYWRlcigpIHsKICAgICAgICBsZXQgbXV0IHJ1bm5lciA9IEhlYWRlcnNUZXN0UnVubmVyOjp3aXRoX2xpbmVhcl9kb3dubG9hZGVyKCk7CiAgICAgICAgbGV0IChjaGVja3BvaW50LCBwcmV2aW91c19zdGFnZSkgPSAoMTAwMCwgMTIwMCk7CiAgICAgICAgbGV0IGlucHV0ID0gRXhlY0lucHV0IHsKICAgICAgICAgICAgdGFyZ2V0OiBTb21lKHByZXZpb3VzX3N0YWdlKSwKICAgICAgICAgICAgY2hlY2twb2ludDogU29tZShTdGFnZUNoZWNrcG9pbnQ6Om5ldyhjaGVja3BvaW50KSksCiAgICAgICAgfTsKICAgICAgICBsZXQgaGVhZGVycyA9IHJ1bm5lci5zZWVkX2V4ZWN1dGlvbihpbnB1dCkuZXhwZWN0KCJmYWlsZWQgdG8gc2VlZCBleGVjdXRpb24iKTsKICAgICAgICBsZXQgcnggPSBydW5uZXIuZXhlY3V0ZShpbnB1dCk7CgogICAgICAgIHJ1bm5lci5jbGllbnQuZXh0ZW5kKGhlYWRlcnMuaXRlcigpLnJldigpLm1hcCh8aHwgaC5jbG9uZV9oZWFkZXIoKSkpLmF3YWl0OwoKICAgICAgICAvLyBza2lwIGBhZnRlcl9leGVjdXRpb25gIGhvb2sgZm9yIGxpbmVhciBkb3dubG9hZGVyCiAgICAgICAgbGV0IHRpcCA9IGhlYWRlcnMubGFzdCgpLnVud3JhcCgpOwogICAgICAgIHJ1bm5lci5zZW5kX3RpcCh0aXAuaGFzaCgpKTsKCiAgICAgICAgbGV0IHJlc3VsdCA9IHJ4LmF3YWl0LnVud3JhcCgpOwogICAgICAgIHJ1bm5lci5kYigpLmZhY3Rvcnkuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKS5jb21taXQoKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEocmVzdWx0LCBPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50IHsKICAgICAgICAgICAgYmxvY2tfbnVtYmVyLAogICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50OiBTb21lKFN0YWdlVW5pdENoZWNrcG9pbnQ6OkhlYWRlcnMoSGVhZGVyc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgYmxvY2tfcmFuZ2U6IENoZWNrcG9pbnRCbG9ja1JhbmdlIHsKICAgICAgICAgICAgICAgICAgICBmcm9tLAogICAgICAgICAgICAgICAgICAgIHRvCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcHJvZ3Jlc3M6IEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkLAogICAgICAgICAgICAgICAgICAgIHRvdGFsLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSkKICAgICAgICB9LCBkb25lOiB0cnVlIH0pIGlmIGJsb2NrX251bWJlciA9PSB0aXAubnVtYmVyICYmCiAgICAgICAgICAgIGZyb20gPT0gY2hlY2twb2ludCAmJiB0byA9PSBwcmV2aW91c19zdGFnZSAmJgogICAgICAgICAgICAvLyAtMSBiZWNhdXNlIHdlIGRvbid0IG5lZWQgdG8gZG93bmxvYWQgdGhlIGxvY2FsIGhlYWQKICAgICAgICAgICAgcHJvY2Vzc2VkID09IGNoZWNrcG9pbnQgKyBoZWFkZXJzLmxlbigpIGFzIHU2NCAtIDEgJiYgdG90YWwgPT0gdGlwLm51bWJlcgogICAgICAgICk7CiAgICAgICAgYXNzZXJ0IShydW5uZXIudmFsaWRhdGVfZXhlY3V0aW9uKGlucHV0LCByZXN1bHQub2soKSkuaXNfb2soKSwgInZhbGlkYXRpb24gZmFpbGVkIik7CiAgICAgICAgYXNzZXJ0IShydW5uZXIuc3RhZ2UoKS5oYXNoX2NvbGxlY3Rvci5pc19lbXB0eSgpKTsKICAgICAgICBhc3NlcnQhKHJ1bm5lci5zdGFnZSgpLmhlYWRlcl9jb2xsZWN0b3IuaXNfZW1wdHkoKSk7CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9zdGFnZXMvc3JjL3N0YWdlcy9pbmRleF9hY2NvdW50X2hpc3RvcnkucnMiPgp1c2UgY3JhdGU6OnN0YWdlczo6dXRpbHM6OmNvbGxlY3RfaGlzdG9yeV9pbmRpY2VzOwoKdXNlIHN1cGVyOjp7Y29sbGVjdF9hY2NvdW50X2hpc3RvcnlfaW5kaWNlcywgbG9hZF9oaXN0b3J5X2luZGljZXN9Owp1c2UgYWxsb3lfcHJpbWl0aXZlczo6QWRkcmVzczsKdXNlIHJldGhfY29uZmlnOjpjb25maWc6OntFdGxDb25maWcsIEluZGV4SGlzdG9yeUNvbmZpZ307CnVzZSByZXRoX2RiX2FwaTo6e21vZGVsczo6U2hhcmRlZEtleSwgdGFibGU6OkRlY29kZSwgdGFibGVzLCB0cmFuc2FjdGlvbjo6RGJUeE11dH07CnVzZSByZXRoX3Byb3ZpZGVyOjp7CiAgICBEQlByb3ZpZGVyLCBIaXN0b3J5V3JpdGVyLCBQcnVuZUNoZWNrcG9pbnRSZWFkZXIsIFBydW5lQ2hlY2twb2ludFdyaXRlciwgU3RvcmFnZVNldHRpbmdzQ2FjaGUsCn07CnVzZSByZXRoX3BydW5lX3R5cGVzOjp7UHJ1bmVDaGVja3BvaW50LCBQcnVuZU1vZGUsIFBydW5lUHVycG9zZSwgUHJ1bmVTZWdtZW50fTsKdXNlIHJldGhfc3RhZ2VzX2FwaTo6ewogICAgRXhlY0lucHV0LCBFeGVjT3V0cHV0LCBTdGFnZSwgU3RhZ2VDaGVja3BvaW50LCBTdGFnZUVycm9yLCBTdGFnZUlkLCBVbndpbmRJbnB1dCwgVW53aW5kT3V0cHV0LAp9Owp1c2Ugc3RkOjpmbXQ6OkRlYnVnOwp1c2UgdHJhY2luZzo6aW5mbzsKCi8vLyBTdGFnZSBpcyBpbmRleGluZyBoaXN0b3J5IHRoZSBhY2NvdW50IGNoYW5nZXNldHMgZ2VuZXJhdGVkIGluCi8vLyBbYEV4ZWN1dGlvblN0YWdlYF1bY3JhdGU6OnN0YWdlczo6RXhlY3V0aW9uU3RhZ2VdLiBGb3IgbW9yZSBpbmZvcm1hdGlvbgovLy8gb24gaW5kZXggc2hhcmRpbmcgdGFrZSBhIGxvb2sgYXQgW2B0YWJsZXM6OkFjY291bnRzSGlzdG9yeWBdCiNbZGVyaXZlKERlYnVnKV0KcHViIHN0cnVjdCBJbmRleEFjY291bnRIaXN0b3J5U3RhZ2UgewogICAgLy8vIE51bWJlciBvZiBibG9ja3MgYWZ0ZXIgd2hpY2ggdGhlIGNvbnRyb2wKICAgIC8vLyBmbG93IHdpbGwgYmUgcmV0dXJuZWQgdG8gdGhlIHBpcGVsaW5lIGZvciBjb21taXQuCiAgICBwdWIgY29tbWl0X3RocmVzaG9sZDogdTY0LAogICAgLy8vIFBydW5pbmcgY29uZmlndXJhdGlvbi4KICAgIHB1YiBwcnVuZV9tb2RlOiBPcHRpb248UHJ1bmVNb2RlPiwKICAgIC8vLyBFVEwgY29uZmlndXJhdGlvbgogICAgcHViIGV0bF9jb25maWc6IEV0bENvbmZpZywKfQoKaW1wbCBJbmRleEFjY291bnRIaXN0b3J5U3RhZ2UgewogICAgLy8vIENyZWF0ZSBuZXcgaW5zdGFuY2Ugb2YgW2BJbmRleEFjY291bnRIaXN0b3J5U3RhZ2VgXS4KICAgIHB1YiBjb25zdCBmbiBuZXcoCiAgICAgICAgY29uZmlnOiBJbmRleEhpc3RvcnlDb25maWcsCiAgICAgICAgZXRsX2NvbmZpZzogRXRsQ29uZmlnLAogICAgICAgIHBydW5lX21vZGU6IE9wdGlvbjxQcnVuZU1vZGU+LAogICAgKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgY29tbWl0X3RocmVzaG9sZDogY29uZmlnLmNvbW1pdF90aHJlc2hvbGQsIGV0bF9jb25maWcsIHBydW5lX21vZGUgfQogICAgfQp9CgppbXBsIERlZmF1bHQgZm9yIEluZGV4QWNjb3VudEhpc3RvcnlTdGFnZSB7CiAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGNvbW1pdF90aHJlc2hvbGQ6IDEwMF8wMDAsIHBydW5lX21vZGU6IE5vbmUsIGV0bF9jb25maWc6IEV0bENvbmZpZzo6ZGVmYXVsdCgpIH0KICAgIH0KfQoKaW1wbDxQcm92aWRlcj4gU3RhZ2U8UHJvdmlkZXI+IGZvciBJbmRleEFjY291bnRIaXN0b3J5U3RhZ2UKd2hlcmUKICAgIFByb3ZpZGVyOiBEQlByb3ZpZGVyPFR4OiBEYlR4TXV0PgogICAgICAgICsgSGlzdG9yeVdyaXRlcgogICAgICAgICsgUHJ1bmVDaGVja3BvaW50UmVhZGVyCiAgICAgICAgKyBQcnVuZUNoZWNrcG9pbnRXcml0ZXIKICAgICAgICArIHJldGhfc3RvcmFnZV9hcGk6OkNoYW5nZVNldFJlYWRlcgogICAgICAgICsgcmV0aF9wcm92aWRlcjo6U3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeQogICAgICAgICsgU3RvcmFnZVNldHRpbmdzQ2FjaGUsCnsKICAgIC8vLyBSZXR1cm4gdGhlIGlkIG9mIHRoZSBzdGFnZQogICAgZm4gaWQoJnNlbGYpIC0+IFN0YWdlSWQgewogICAgICAgIFN0YWdlSWQ6OkluZGV4QWNjb3VudEhpc3RvcnkKICAgIH0KCiAgICAvLy8gRXhlY3V0ZSB0aGUgc3RhZ2UuCiAgICBmbiBleGVjdXRlKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBwcm92aWRlcjogJlByb3ZpZGVyLAogICAgICAgIG11dCBpbnB1dDogRXhlY0lucHV0LAogICAgKSAtPiBSZXN1bHQ8RXhlY091dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIGlmIGxldCBTb21lKCh0YXJnZXRfcHJ1bmFibGVfYmxvY2ssIHBydW5lX21vZGUpKSA9IHNlbGYKICAgICAgICAgICAgLnBydW5lX21vZGUKICAgICAgICAgICAgLm1hcCh8bW9kZXwgewogICAgICAgICAgICAgICAgbW9kZS5wcnVuZV90YXJnZXRfYmxvY2soCiAgICAgICAgICAgICAgICAgICAgaW5wdXQudGFyZ2V0KCksCiAgICAgICAgICAgICAgICAgICAgUHJ1bmVTZWdtZW50OjpBY2NvdW50SGlzdG9yeSwKICAgICAgICAgICAgICAgICAgICBQcnVuZVB1cnBvc2U6OlVzZXIsCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC50cmFuc3Bvc2UoKT8KICAgICAgICAgICAgLmZsYXR0ZW4oKSAmJgogICAgICAgICAgICB0YXJnZXRfcHJ1bmFibGVfYmxvY2sgPiBpbnB1dC5jaGVja3BvaW50KCkuYmxvY2tfbnVtYmVyCiAgICAgICAgewogICAgICAgICAgICBpbnB1dC5jaGVja3BvaW50ID0gU29tZShTdGFnZUNoZWNrcG9pbnQ6Om5ldyh0YXJnZXRfcHJ1bmFibGVfYmxvY2spKTsKCiAgICAgICAgICAgIC8vIFNhdmUgcHJ1bmUgY2hlY2twb2ludCBvbmx5IGlmIHdlIGRvbid0IGhhdmUgb25lIGFscmVhZHkuCiAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgcHJ1bmVyIG1heSBza2lwIHRoZSB1bnBydW5lZCByYW5nZSBvZiBibG9ja3MuCiAgICAgICAgICAgIGlmIHByb3ZpZGVyLmdldF9wcnVuZV9jaGVja3BvaW50KFBydW5lU2VnbWVudDo6QWNjb3VudEhpc3RvcnkpPy5pc19ub25lKCkgewogICAgICAgICAgICAgICAgcHJvdmlkZXIuc2F2ZV9wcnVuZV9jaGVja3BvaW50KAogICAgICAgICAgICAgICAgICAgIFBydW5lU2VnbWVudDo6QWNjb3VudEhpc3RvcnksCiAgICAgICAgICAgICAgICAgICAgUHJ1bmVDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiBTb21lKHRhcmdldF9wcnVuYWJsZV9ibG9jayksCiAgICAgICAgICAgICAgICAgICAgICAgIHR4X251bWJlcjogTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgcHJ1bmVfbW9kZSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgKT87CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIGlucHV0LnRhcmdldF9yZWFjaGVkKCkgewogICAgICAgICAgICByZXR1cm4gT2soRXhlY091dHB1dDo6ZG9uZShpbnB1dC5jaGVja3BvaW50KCkpKQogICAgICAgIH0KCiAgICAgICAgbGV0IG11dCByYW5nZSA9IGlucHV0Lm5leHRfYmxvY2tfcmFuZ2UoKTsKICAgICAgICBsZXQgZmlyc3Rfc3luYyA9IGlucHV0LmNoZWNrcG9pbnQoKS5ibG9ja19udW1iZXIgPT0gMDsKCiAgICAgICAgLy8gT24gZmlyc3Qgc3luYyB3ZSBtaWdodCBoYXZlIGhpc3RvcnkgY29taW5nIGZyb20gZ2VuZXNpcy4gV2UgY2xlYXIgdGhlIHRhYmxlIHNpbmNlIGl0J3MKICAgICAgICAvLyBmYXN0ZXIgdG8gcmVidWlsZCBmcm9tIHNjcmF0Y2guCiAgICAgICAgaWYgZmlyc3Rfc3luYyB7CiAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmNsZWFyOjo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KCk/OwogICAgICAgICAgICByYW5nZSA9IDAuLj0qaW5wdXQubmV4dF9ibG9ja19yYW5nZSgpLmVuZCgpOwogICAgICAgIH0KCiAgICAgICAgaW5mbyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjppbmRleF9hY2NvdW50X2hpc3Rvcnk6OmV4ZWMiLCA/Zmlyc3Rfc3luYywgIkNvbGxlY3RpbmcgaW5kaWNlcyIpOwoKICAgICAgICBsZXQgY29sbGVjdG9yID0gaWYgcHJvdmlkZXIuY2FjaGVkX3N0b3JhZ2Vfc2V0dGluZ3MoKS5hY2NvdW50X2NoYW5nZXNldHNfaW5fc3RhdGljX2ZpbGVzIHsKICAgICAgICAgICAgLy8gVXNlIHRoZSBwcm92aWRlci1iYXNlZCBjb2xsZWN0aW9uIHRoYXQgY2FuIHJlYWQgZnJvbSBzdGF0aWMgZmlsZXMuCiAgICAgICAgICAgIGNvbGxlY3RfYWNjb3VudF9oaXN0b3J5X2luZGljZXMocHJvdmlkZXIsIHJhbmdlLmNsb25lKCksICZzZWxmLmV0bF9jb25maWcpPwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbGxlY3RfaGlzdG9yeV9pbmRpY2VzOjo8XywgdGFibGVzOjpBY2NvdW50Q2hhbmdlU2V0cywgdGFibGVzOjpBY2NvdW50c0hpc3RvcnksIF8+KAogICAgICAgICAgICAgICAgcHJvdmlkZXIsCiAgICAgICAgICAgICAgICByYW5nZS5jbG9uZSgpLAogICAgICAgICAgICAgICAgU2hhcmRlZEtleTo6bmV3LAogICAgICAgICAgICAgICAgfChpbmRleCwgdmFsdWUpfCAoaW5kZXgsIHZhbHVlLmFkZHJlc3MpLAogICAgICAgICAgICAgICAgJnNlbGYuZXRsX2NvbmZpZywKICAgICAgICAgICAgKT8KICAgICAgICB9OwoKICAgICAgICBpbmZvISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OmluZGV4X2FjY291bnRfaGlzdG9yeTo6ZXhlYyIsICJMb2FkaW5nIGluZGljZXMgaW50byBkYXRhYmFzZSIpOwogICAgICAgIGxvYWRfaGlzdG9yeV9pbmRpY2VzOjo8XywgdGFibGVzOjpBY2NvdW50c0hpc3RvcnksIF8+KAogICAgICAgICAgICBwcm92aWRlciwKICAgICAgICAgICAgY29sbGVjdG9yLAogICAgICAgICAgICBmaXJzdF9zeW5jLAogICAgICAgICAgICBTaGFyZGVkS2V5OjpuZXcsCiAgICAgICAgICAgIFNoYXJkZWRLZXk6OjxBZGRyZXNzPjo6ZGVjb2RlX293bmVkLAogICAgICAgICAgICB8a2V5fCBrZXkua2V5LAogICAgICAgICk/OwoKICAgICAgICBPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoKnJhbmdlLmVuZCgpKSwgZG9uZTogdHJ1ZSB9KQogICAgfQoKICAgIC8vLyBVbndpbmQgdGhlIHN0YWdlLgogICAgZm4gdW53aW5kKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBwcm92aWRlcjogJlByb3ZpZGVyLAogICAgICAgIGlucHV0OiBVbndpbmRJbnB1dCwKICAgICkgLT4gUmVzdWx0PFVud2luZE91dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIGxldCAocmFuZ2UsIHVud2luZF9wcm9ncmVzcywgXykgPQogICAgICAgICAgICBpbnB1dC51bndpbmRfYmxvY2tfcmFuZ2Vfd2l0aF90aHJlc2hvbGQoc2VsZi5jb21taXRfdGhyZXNob2xkKTsKCiAgICAgICAgcHJvdmlkZXIudW53aW5kX2FjY291bnRfaGlzdG9yeV9pbmRpY2VzX3JhbmdlKHJhbmdlKT87CgogICAgICAgIC8vIGZyb20gSGlzdG9yeUluZGV4IGhpZ2hlciB0aGFuIHRoYXQgbnVtYmVyLgogICAgICAgIE9rKFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KHVud2luZF9wcm9ncmVzcykgfSkKICAgIH0KfQoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6Oio7CiAgICB1c2UgY3JhdGU6OnRlc3RfdXRpbHM6OnsKICAgICAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCwgRXhlY3V0ZVN0YWdlVGVzdFJ1bm5lciwgU3RhZ2VUZXN0UnVubmVyLCBUZXN0UnVubmVyRXJyb3IsCiAgICAgICAgVGVzdFN0YWdlREIsIFVud2luZFN0YWdlVGVzdFJ1bm5lciwKICAgIH07CiAgICB1c2UgYWxsb3lfcHJpbWl0aXZlczo6e2FkZHJlc3MsIEJsb2NrTnVtYmVyLCBCMjU2fTsKICAgIHVzZSBpdGVydG9vbHM6Okl0ZXJ0b29sczsKICAgIHVzZSByZXRoX2RiX2FwaTo6ewogICAgICAgIGN1cnNvcjo6RGJDdXJzb3JSTywKICAgICAgICBtb2RlbHM6OnsKICAgICAgICAgICAgc2hhcmRlZF9rZXksIHNoYXJkZWRfa2V5OjpOVU1fT0ZfSU5ESUNFU19JTl9TSEFSRCwgQWNjb3VudEJlZm9yZVR4LAogICAgICAgICAgICBTdG9yZWRCbG9ja0JvZHlJbmRpY2VzLAogICAgICAgIH0sCiAgICAgICAgdHJhbnNhY3Rpb246OkRiVHgsCiAgICAgICAgQmxvY2tOdW1iZXJMaXN0LAogICAgfTsKICAgIHVzZSByZXRoX3Byb3ZpZGVyOjp7cHJvdmlkZXJzOjpTdGF0aWNGaWxlV3JpdGVyLCBEYXRhYmFzZVByb3ZpZGVyRmFjdG9yeX07CiAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjpnZW5lcmF0b3JzOjp7CiAgICAgICAgc2VsZiwgcmFuZG9tX2Jsb2NrX3JhbmdlLCByYW5kb21fY2hhbmdlc2V0X3JhbmdlLCByYW5kb21fY29udHJhY3RfYWNjb3VudF9yYW5nZSwKICAgICAgICBCbG9ja1JhbmdlUGFyYW1zLAogICAgfTsKICAgIHVzZSBzdGQ6OmNvbGxlY3Rpb25zOjpCVHJlZU1hcDsKCiAgICBjb25zdCBBRERSRVNTOiBBZGRyZXNzID0gYWRkcmVzcyEoIjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMSIpOwoKICAgIGNvbnN0IExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRDogQmxvY2tOdW1iZXIgPSBOVU1fT0ZfSU5ESUNFU19JTl9TSEFSRCBhcyBCbG9ja051bWJlcjsKICAgIGNvbnN0IE1BWF9CTE9DSzogQmxvY2tOdW1iZXIgPSBOVU1fT0ZfSU5ESUNFU19JTl9TSEFSRCBhcyBCbG9ja051bWJlciArIDI7CgogICAgY29uc3QgZm4gYWNjKCkgLT4gQWNjb3VudEJlZm9yZVR4IHsKICAgICAgICBBY2NvdW50QmVmb3JlVHggeyBhZGRyZXNzOiBBRERSRVNTLCBpbmZvOiBOb25lIH0KICAgIH0KCiAgICAvLy8gU2hhcmQgZm9yIGFjY291bnQKICAgIGNvbnN0IGZuIHNoYXJkKHNoYXJkX2luZGV4OiB1NjQpIC0+IFNoYXJkZWRLZXk8QWRkcmVzcz4gewogICAgICAgIFNoYXJkZWRLZXkgeyBrZXk6IEFERFJFU1MsIGhpZ2hlc3RfYmxvY2tfbnVtYmVyOiBzaGFyZF9pbmRleCB9CiAgICB9CgogICAgZm4gbGlzdChsaXN0OiAmW3U2NF0pIC0+IEJsb2NrTnVtYmVyTGlzdCB7CiAgICAgICAgQmxvY2tOdW1iZXJMaXN0OjpuZXcobGlzdC5pdGVyKCkuY29waWVkKCkpLnVud3JhcCgpCiAgICB9CgogICAgZm4gY2FzdCgKICAgICAgICB0YWJsZTogVmVjPChTaGFyZGVkS2V5PEFkZHJlc3M+LCBCbG9ja051bWJlckxpc3QpPiwKICAgICkgLT4gQlRyZWVNYXA8U2hhcmRlZEtleTxBZGRyZXNzPiwgVmVjPHU2ND4+IHsKICAgICAgICB0YWJsZQogICAgICAgICAgICAuaW50b19pdGVyKCkKICAgICAgICAgICAgLm1hcCh8KGssIHYpfCB7CiAgICAgICAgICAgICAgICBsZXQgdiA9IHYuaXRlcigpLmNvbGxlY3QoKTsKICAgICAgICAgICAgICAgIChrLCB2KQogICAgICAgICAgICB9KQogICAgICAgICAgICAuY29sbGVjdCgpCiAgICB9CgogICAgZm4gcGFydGlhbF9zZXR1cChkYjogJlRlc3RTdGFnZURCKSB7CiAgICAgICAgLy8gc2V0dXAKICAgICAgICBkYi5jb21taXQofHR4fCB7CiAgICAgICAgICAgIGZvciBibG9jayBpbiAwLi49TUFYX0JMT0NLIHsKICAgICAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6QmxvY2tCb2R5SW5kaWNlcz4oCiAgICAgICAgICAgICAgICAgICAgYmxvY2ssCiAgICAgICAgICAgICAgICAgICAgU3RvcmVkQmxvY2tCb2R5SW5kaWNlcyB7IHR4X2NvdW50OiAzLCAuLkRlZmF1bHQ6OmRlZmF1bHQoKSB9LAogICAgICAgICAgICAgICAgKT87CiAgICAgICAgICAgICAgICAvLyBzZXR1cCBjaGFuZ2VzZXQgdGhhdCBpcyBnb2luZyB0byBiZSBhcHBsaWVkIHRvIGhpc3RvcnkgaW5kZXgKICAgICAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6QWNjb3VudENoYW5nZVNldHM+KGJsb2NrLCBhY2MoKSk/OwogICAgICAgICAgICB9CiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0pCiAgICAgICAgLnVud3JhcCgpCiAgICB9CgogICAgZm4gcnVuKGRiOiAmVGVzdFN0YWdlREIsIHJ1bl90bzogdTY0LCBpbnB1dF9jaGVja3BvaW50OiBPcHRpb248QmxvY2tOdW1iZXI+KSB7CiAgICAgICAgbGV0IGlucHV0ID0gRXhlY0lucHV0IHsKICAgICAgICAgICAgdGFyZ2V0OiBTb21lKHJ1bl90byksCiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IGlucHV0X2NoZWNrcG9pbnQKICAgICAgICAgICAgICAgIC5tYXAofGJsb2NrX251bWJlcnwgU3RhZ2VDaGVja3BvaW50IHsgYmxvY2tfbnVtYmVyLCBzdGFnZV9jaGVja3BvaW50OiBOb25lIH0pLAogICAgICAgIH07CiAgICAgICAgbGV0IG11dCBzdGFnZSA9IEluZGV4QWNjb3VudEhpc3RvcnlTdGFnZTo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBwcm92aWRlciA9IGRiLmZhY3RvcnkuZGF0YWJhc2VfcHJvdmlkZXJfcncoKS51bndyYXAoKTsKICAgICAgICBsZXQgb3V0ID0gc3RhZ2UuZXhlY3V0ZSgmcHJvdmlkZXIsIGlucHV0KS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKG91dCwgRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KHJ1bl90byksIGRvbmU6IHRydWUgfSk7CiAgICAgICAgcHJvdmlkZXIuY29tbWl0KCkudW53cmFwKCk7CiAgICB9CgogICAgZm4gdW53aW5kKGRiOiAmVGVzdFN0YWdlREIsIHVud2luZF9mcm9tOiB1NjQsIHVud2luZF90bzogdTY0KSB7CiAgICAgICAgbGV0IGlucHV0ID0gVW53aW5kSW5wdXQgewogICAgICAgICAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyh1bndpbmRfZnJvbSksCiAgICAgICAgICAgIHVud2luZF90bywKICAgICAgICAgICAgLi5EZWZhdWx0OjpkZWZhdWx0KCkKICAgICAgICB9OwogICAgICAgIGxldCBtdXQgc3RhZ2UgPSBJbmRleEFjY291bnRIaXN0b3J5U3RhZ2U6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgcHJvdmlkZXIgPSBkYi5mYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgbGV0IG91dCA9IHN0YWdlLnVud2luZCgmcHJvdmlkZXIsIGlucHV0KS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKG91dCwgVW53aW5kT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcodW53aW5kX3RvKSB9KTsKICAgICAgICBwcm92aWRlci5jb21taXQoKS51bndyYXAoKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gaW5zZXJ0X2luZGV4X3RvX2dlbmVzaXMoKSB7CiAgICAgICAgLy8gaW5pdAogICAgICAgIGxldCBkYiA9IFRlc3RTdGFnZURCOjpkZWZhdWx0KCk7CgogICAgICAgIC8vIHNldHVwCiAgICAgICAgcGFydGlhbF9zZXR1cCgmZGIpOwoKICAgICAgICAvLyBydW4KICAgICAgICBydW4oJmRiLCAzLCBOb25lKTsKCiAgICAgICAgLy8gdmVyaWZ5CiAgICAgICAgbGV0IHRhYmxlID0gY2FzdChkYi50YWJsZTo6PHRhYmxlczo6QWNjb3VudHNIaXN0b3J5PigpLnVud3JhcCgpKTsKICAgICAgICBhc3NlcnRfZXEhKHRhYmxlLCBCVHJlZU1hcDo6ZnJvbShbKHNoYXJkKHU2NDo6TUFYKSwgdmVjIVswLCAxLCAyLCAzXSldKSk7CgogICAgICAgIC8vIHVud2luZAogICAgICAgIHVud2luZCgmZGIsIDMsIDApOwoKICAgICAgICAvLyB2ZXJpZnkgaW5pdGlhbCBzdGF0ZQogICAgICAgIGxldCB0YWJsZSA9IGNhc3QoZGIudGFibGU6Ojx0YWJsZXM6OkFjY291bnRzSGlzdG9yeT4oKS51bndyYXAoKSk7CiAgICAgICAgYXNzZXJ0X2VxISh0YWJsZSwgQlRyZWVNYXA6OmZyb20oWyhzaGFyZCh1NjQ6Ok1BWCksIHZlYyFbMF0pXSkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBpbnNlcnRfaW5kZXhfdG9fbm90X2VtcHR5X3NoYXJkKCkgewogICAgICAgIC8vIGluaXQKICAgICAgICBsZXQgZGIgPSBUZXN0U3RhZ2VEQjo6ZGVmYXVsdCgpOwoKICAgICAgICAvLyBzZXR1cAogICAgICAgIHBhcnRpYWxfc2V0dXAoJmRiKTsKICAgICAgICBkYi5jb21taXQofHR4fCB7CiAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6QWNjb3VudHNIaXN0b3J5PihzaGFyZCh1NjQ6Ok1BWCksIGxpc3QoJlsxLCAyLCAzXSkpLnVud3JhcCgpOwogICAgICAgICAgICBPaygoKSkKICAgICAgICB9KQogICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgLy8gcnVuCiAgICAgICAgcnVuKCZkYiwgNSwgU29tZSgzKSk7CgogICAgICAgIC8vIHZlcmlmeQogICAgICAgIGxldCB0YWJsZSA9IGNhc3QoZGIudGFibGU6Ojx0YWJsZXM6OkFjY291bnRzSGlzdG9yeT4oKS51bndyYXAoKSk7CiAgICAgICAgYXNzZXJ0X2VxISh0YWJsZSwgQlRyZWVNYXA6OmZyb20oWyhzaGFyZCh1NjQ6Ok1BWCksIHZlYyFbMSwgMiwgMywgNCwgNV0pXSkpOwoKICAgICAgICAvLyB1bndpbmQKICAgICAgICB1bndpbmQoJmRiLCA1LCAzKTsKCiAgICAgICAgLy8gdmVyaWZ5IGluaXRpYWwgc3RhdGUKICAgICAgICBsZXQgdGFibGUgPSBjYXN0KGRiLnRhYmxlOjo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KCkudW53cmFwKCkpOwogICAgICAgIGFzc2VydF9lcSEodGFibGUsIEJUcmVlTWFwOjpmcm9tKFsoc2hhcmQodTY0OjpNQVgpLCB2ZWMhWzEsIDIsIDNdKV0pKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gaW5zZXJ0X2luZGV4X3RvX2Z1bGxfc2hhcmQoKSB7CiAgICAgICAgLy8gaW5pdAogICAgICAgIGxldCBkYiA9IFRlc3RTdGFnZURCOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IGZ1bGxfbGlzdCA9ICgxLi49TEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEKS5jb2xsZWN0Ojo8VmVjPF8+PigpOwogICAgICAgIGFzc2VydF9lcSEoZnVsbF9saXN0LmxlbigpLCBOVU1fT0ZfSU5ESUNFU19JTl9TSEFSRCk7CgogICAgICAgIC8vIHNldHVwCiAgICAgICAgcGFydGlhbF9zZXR1cCgmZGIpOwogICAgICAgIGRiLmNvbW1pdCh8dHh8IHsKICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KHNoYXJkKHU2NDo6TUFYKSwgbGlzdCgmZnVsbF9saXN0KSkudW53cmFwKCk7CiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0pCiAgICAgICAgLnVud3JhcCgpOwoKICAgICAgICAvLyBydW4KICAgICAgICBydW4oJmRiLCBMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAyLCBTb21lKExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCkpOwoKICAgICAgICAvLyB2ZXJpZnkKICAgICAgICBsZXQgdGFibGUgPSBjYXN0KGRiLnRhYmxlOjo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KCkudW53cmFwKCkpOwogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIHRhYmxlLAogICAgICAgICAgICBCVHJlZU1hcDo6ZnJvbShbCiAgICAgICAgICAgICAgICAoc2hhcmQoTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEKSwgZnVsbF9saXN0LmNsb25lKCkpLAogICAgICAgICAgICAgICAgKHNoYXJkKHU2NDo6TUFYKSwgdmVjIVtMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAxLCBMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAyXSkKICAgICAgICAgICAgXSkKICAgICAgICApOwoKICAgICAgICAvLyB1bndpbmQKICAgICAgICB1bndpbmQoJmRiLCBMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAyLCBMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQpOwoKICAgICAgICAvLyB2ZXJpZnkgaW5pdGlhbCBzdGF0ZQogICAgICAgIGxldCB0YWJsZSA9IGNhc3QoZGIudGFibGU6Ojx0YWJsZXM6OkFjY291bnRzSGlzdG9yeT4oKS51bndyYXAoKSk7CiAgICAgICAgYXNzZXJ0X2VxISh0YWJsZSwgQlRyZWVNYXA6OmZyb20oWyhzaGFyZCh1NjQ6Ok1BWCksIGZ1bGxfbGlzdCldKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGluc2VydF9pbmRleF90b19maWxsX3NoYXJkKCkgewogICAgICAgIC8vIGluaXQKICAgICAgICBsZXQgZGIgPSBUZXN0U3RhZ2VEQjo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBtdXQgYWxtb3N0X2Z1bGxfbGlzdCA9ICgxLi49TEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEIC0gMikuY29sbGVjdDo6PFZlYzxfPj4oKTsKCiAgICAgICAgLy8gc2V0dXAKICAgICAgICBwYXJ0aWFsX3NldHVwKCZkYik7CiAgICAgICAgZGIuY29tbWl0KHx0eHwgewogICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OkFjY291bnRzSGlzdG9yeT4oc2hhcmQodTY0OjpNQVgpLCBsaXN0KCZhbG1vc3RfZnVsbF9saXN0KSkudW53cmFwKCk7CiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0pCiAgICAgICAgLnVud3JhcCgpOwoKICAgICAgICAvLyBydW4KICAgICAgICBydW4oJmRiLCBMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQsIFNvbWUoTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEIC0gMikpOwoKICAgICAgICAvLyB2ZXJpZnkKICAgICAgICBhbG1vc3RfZnVsbF9saXN0LnB1c2goTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEIC0gMSk7CiAgICAgICAgYWxtb3N0X2Z1bGxfbGlzdC5wdXNoKExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCk7CiAgICAgICAgbGV0IHRhYmxlID0gY2FzdChkYi50YWJsZTo6PHRhYmxlczo6QWNjb3VudHNIaXN0b3J5PigpLnVud3JhcCgpKTsKICAgICAgICBhc3NlcnRfZXEhKHRhYmxlLCBCVHJlZU1hcDo6ZnJvbShbKHNoYXJkKHU2NDo6TUFYKSwgYWxtb3N0X2Z1bGxfbGlzdC5jbG9uZSgpKV0pKTsKCiAgICAgICAgLy8gdW53aW5kCiAgICAgICAgdW53aW5kKCZkYiwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJELCBMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgLSAyKTsKCiAgICAgICAgLy8gdmVyaWZ5IGluaXRpYWwgc3RhdGUKICAgICAgICBhbG1vc3RfZnVsbF9saXN0LnBvcCgpOwogICAgICAgIGFsbW9zdF9mdWxsX2xpc3QucG9wKCk7CiAgICAgICAgbGV0IHRhYmxlID0gY2FzdChkYi50YWJsZTo6PHRhYmxlczo6QWNjb3VudHNIaXN0b3J5PigpLnVud3JhcCgpKTsKICAgICAgICBhc3NlcnRfZXEhKHRhYmxlLCBCVHJlZU1hcDo6ZnJvbShbKHNoYXJkKHU2NDo6TUFYKSwgYWxtb3N0X2Z1bGxfbGlzdCldKSk7CgogICAgICAgIC8vIHZlcmlmeSBpbml0aWFsIHN0YXRlCiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGluc2VydF9pbmRleF9zZWNvbmRfaGFsZl9zaGFyZCgpIHsKICAgICAgICAvLyBpbml0CiAgICAgICAgbGV0IGRiID0gVGVzdFN0YWdlREI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgbXV0IGFsbW9zdF9mdWxsX2xpc3QgPSAoMS4uPUxBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCAtIDEpLmNvbGxlY3Q6OjxWZWM8Xz4+KCk7CgogICAgICAgIC8vIHNldHVwCiAgICAgICAgcGFydGlhbF9zZXR1cCgmZGIpOwogICAgICAgIGRiLmNvbW1pdCh8dHh8IHsKICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KHNoYXJkKHU2NDo6TUFYKSwgbGlzdCgmYWxtb3N0X2Z1bGxfbGlzdCkpLnVud3JhcCgpOwogICAgICAgICAgICBPaygoKSkKICAgICAgICB9KQogICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgLy8gcnVuCiAgICAgICAgcnVuKCZkYiwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEICsgMSwgU29tZShMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgLSAxKSk7CgogICAgICAgIC8vIHZlcmlmeQogICAgICAgIGFsbW9zdF9mdWxsX2xpc3QucHVzaChMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQpOwogICAgICAgIGxldCB0YWJsZSA9IGNhc3QoZGIudGFibGU6Ojx0YWJsZXM6OkFjY291bnRzSGlzdG9yeT4oKS51bndyYXAoKSk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgdGFibGUsCiAgICAgICAgICAgIEJUcmVlTWFwOjpmcm9tKFsKICAgICAgICAgICAgICAgIChzaGFyZChMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQpLCBhbG1vc3RfZnVsbF9saXN0LmNsb25lKCkpLAogICAgICAgICAgICAgICAgKHNoYXJkKHU2NDo6TUFYKSwgdmVjIVtMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAxXSkKICAgICAgICAgICAgXSkKICAgICAgICApOwoKICAgICAgICAvLyB1bndpbmQKICAgICAgICB1bndpbmQoJmRiLCBMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQsIExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCAtIDEpOwoKICAgICAgICAvLyB2ZXJpZnkgaW5pdGlhbCBzdGF0ZQogICAgICAgIGFsbW9zdF9mdWxsX2xpc3QucG9wKCk7CiAgICAgICAgbGV0IHRhYmxlID0gY2FzdChkYi50YWJsZTo6PHRhYmxlczo6QWNjb3VudHNIaXN0b3J5PigpLnVud3JhcCgpKTsKICAgICAgICBhc3NlcnRfZXEhKHRhYmxlLCBCVHJlZU1hcDo6ZnJvbShbKHNoYXJkKHU2NDo6TUFYKSwgYWxtb3N0X2Z1bGxfbGlzdCldKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGluc2VydF9pbmRleF90b190aGlyZF9zaGFyZCgpIHsKICAgICAgICAvLyBpbml0CiAgICAgICAgbGV0IGRiID0gVGVzdFN0YWdlREI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgZnVsbF9saXN0ID0gKDEuLj1MQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQpLmNvbGxlY3Q6OjxWZWM8Xz4+KCk7CgogICAgICAgIC8vIHNldHVwCiAgICAgICAgcGFydGlhbF9zZXR1cCgmZGIpOwogICAgICAgIGRiLmNvbW1pdCh8dHh8IHsKICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KHNoYXJkKDEpLCBsaXN0KCZmdWxsX2xpc3QpKS51bndyYXAoKTsKICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KHNoYXJkKDIpLCBsaXN0KCZmdWxsX2xpc3QpKS51bndyYXAoKTsKICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KAogICAgICAgICAgICAgICAgc2hhcmQodTY0OjpNQVgpLAogICAgICAgICAgICAgICAgbGlzdCgmW0xBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCArIDFdKSwKICAgICAgICAgICAgKQogICAgICAgICAgICAudW53cmFwKCk7CiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0pCiAgICAgICAgLnVud3JhcCgpOwoKICAgICAgICBydW4oJmRiLCBMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAyLCBTb21lKExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCArIDEpKTsKCiAgICAgICAgLy8gdmVyaWZ5CiAgICAgICAgbGV0IHRhYmxlID0gY2FzdChkYi50YWJsZTo6PHRhYmxlczo6QWNjb3VudHNIaXN0b3J5PigpLnVud3JhcCgpKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICB0YWJsZSwKICAgICAgICAgICAgQlRyZWVNYXA6OmZyb20oWwogICAgICAgICAgICAgICAgKHNoYXJkKDEpLCBmdWxsX2xpc3QuY2xvbmUoKSksCiAgICAgICAgICAgICAgICAoc2hhcmQoMiksIGZ1bGxfbGlzdC5jbG9uZSgpKSwKICAgICAgICAgICAgICAgIChzaGFyZCh1NjQ6Ok1BWCksIHZlYyFbTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEICsgMSwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEICsgMl0pCiAgICAgICAgICAgIF0pCiAgICAgICAgKTsKCiAgICAgICAgLy8gdW53aW5kCiAgICAgICAgdW53aW5kKCZkYiwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEICsgMiwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEICsgMSk7CgogICAgICAgIC8vIHZlcmlmeSBpbml0aWFsIHN0YXRlCiAgICAgICAgbGV0IHRhYmxlID0gY2FzdChkYi50YWJsZTo6PHRhYmxlczo6QWNjb3VudHNIaXN0b3J5PigpLnVud3JhcCgpKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICB0YWJsZSwKICAgICAgICAgICAgQlRyZWVNYXA6OmZyb20oWwogICAgICAgICAgICAgICAgKHNoYXJkKDEpLCBmdWxsX2xpc3QuY2xvbmUoKSksCiAgICAgICAgICAgICAgICAoc2hhcmQoMiksIGZ1bGxfbGlzdCksCiAgICAgICAgICAgICAgICAoc2hhcmQodTY0OjpNQVgpLCB2ZWMhW0xBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCArIDFdKQogICAgICAgICAgICBdKQogICAgICAgICk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGluc2VydF9pbmRleF93aXRoX3BydW5lX21vZGUoKSB7CiAgICAgICAgLy8gaW5pdAogICAgICAgIGxldCBkYiA9IFRlc3RTdGFnZURCOjpkZWZhdWx0KCk7CgogICAgICAgIC8vIHNldHVwCiAgICAgICAgZGIuY29tbWl0KHx0eHwgewogICAgICAgICAgICAvLyB3ZSBqdXN0IG5lZWQgZmlyc3QgYW5kIGxhc3QKICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpCbG9ja0JvZHlJbmRpY2VzPigKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBTdG9yZWRCbG9ja0JvZHlJbmRpY2VzIHsgdHhfY291bnQ6IDMsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgICAgICkKICAgICAgICAgICAgLnVud3JhcCgpOwoKICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpCbG9ja0JvZHlJbmRpY2VzPigKICAgICAgICAgICAgICAgIDEwMCwKICAgICAgICAgICAgICAgIFN0b3JlZEJsb2NrQm9keUluZGljZXMgeyB0eF9jb3VudDogNSwgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfSwKICAgICAgICAgICAgKQogICAgICAgICAgICAudW53cmFwKCk7CgogICAgICAgICAgICAvLyBzZXR1cCBjaGFuZ2VzZXQgdGhhdCBhcmUgZ29pbmcgdG8gYmUgYXBwbGllZCB0byBoaXN0b3J5IGluZGV4CiAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6QWNjb3VudENoYW5nZVNldHM+KDIwLCBhY2MoKSkudW53cmFwKCk7CiAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6QWNjb3VudENoYW5nZVNldHM+KDM2LCBhY2MoKSkudW53cmFwKCk7CiAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6QWNjb3VudENoYW5nZVNldHM+KDEwMCwgYWNjKCkpLnVud3JhcCgpOwogICAgICAgICAgICBPaygoKSkKICAgICAgICB9KQogICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgLy8gcnVuCiAgICAgICAgbGV0IGlucHV0ID0gRXhlY0lucHV0IHsgdGFyZ2V0OiBTb21lKDIwMDAwKSwgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfTsKICAgICAgICBsZXQgbXV0IHN0YWdlID0gSW5kZXhBY2NvdW50SGlzdG9yeVN0YWdlIHsKICAgICAgICAgICAgcHJ1bmVfbW9kZTogU29tZShQcnVuZU1vZGU6OkJlZm9yZSgzNikpLAogICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgIH07CiAgICAgICAgbGV0IHByb3ZpZGVyID0gZGIuZmFjdG9yeS5kYXRhYmFzZV9wcm92aWRlcl9ydygpLnVud3JhcCgpOwogICAgICAgIGxldCBvdXQgPSBzdGFnZS5leGVjdXRlKCZwcm92aWRlciwgaW5wdXQpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEob3V0LCBFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoMjAwMDApLCBkb25lOiB0cnVlIH0pOwogICAgICAgIHByb3ZpZGVyLmNvbW1pdCgpLnVud3JhcCgpOwoKICAgICAgICAvLyB2ZXJpZnkKICAgICAgICBsZXQgdGFibGUgPSBjYXN0KGRiLnRhYmxlOjo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KCkudW53cmFwKCkpOwogICAgICAgIGFzc2VydF9lcSEodGFibGUsIEJUcmVlTWFwOjpmcm9tKFsoc2hhcmQodTY0OjpNQVgpLCB2ZWMhWzM2LCAxMDBdKV0pKTsKCiAgICAgICAgLy8gdW53aW5kCiAgICAgICAgdW53aW5kKCZkYiwgMjAwMDAsIDApOwoKICAgICAgICAvLyB2ZXJpZnkgaW5pdGlhbCBzdGF0ZQogICAgICAgIGxldCB0YWJsZSA9IGRiLnRhYmxlOjo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0ISh0YWJsZS5pc19lbXB0eSgpKTsKICAgIH0KCiAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCEoSW5kZXhBY2NvdW50SGlzdG9yeVRlc3RSdW5uZXIsIGluZGV4X2FjY291bnRfaGlzdG9yeSk7CgogICAgc3RydWN0IEluZGV4QWNjb3VudEhpc3RvcnlUZXN0UnVubmVyIHsKICAgICAgICBwdWIoY3JhdGUpIGRiOiBUZXN0U3RhZ2VEQiwKICAgICAgICBjb21taXRfdGhyZXNob2xkOiB1NjQsCiAgICAgICAgcHJ1bmVfbW9kZTogT3B0aW9uPFBydW5lTW9kZT4sCiAgICB9CgogICAgaW1wbCBEZWZhdWx0IGZvciBJbmRleEFjY291bnRIaXN0b3J5VGVzdFJ1bm5lciB7CiAgICAgICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgICAgICBTZWxmIHsgZGI6IFRlc3RTdGFnZURCOjpkZWZhdWx0KCksIGNvbW1pdF90aHJlc2hvbGQ6IDEwMDAsIHBydW5lX21vZGU6IE5vbmUgfQogICAgICAgIH0KICAgIH0KCiAgICBpbXBsIFN0YWdlVGVzdFJ1bm5lciBmb3IgSW5kZXhBY2NvdW50SGlzdG9yeVRlc3RSdW5uZXIgewogICAgICAgIHR5cGUgUyA9IEluZGV4QWNjb3VudEhpc3RvcnlTdGFnZTsKCiAgICAgICAgZm4gZGIoJnNlbGYpIC0+ICZUZXN0U3RhZ2VEQiB7CiAgICAgICAgICAgICZzZWxmLmRiCiAgICAgICAgfQoKICAgICAgICBmbiBzdGFnZSgmc2VsZikgLT4gU2VsZjo6UyB7CiAgICAgICAgICAgIFNlbGY6OlMgewogICAgICAgICAgICAgICAgY29tbWl0X3RocmVzaG9sZDogc2VsZi5jb21taXRfdGhyZXNob2xkLAogICAgICAgICAgICAgICAgcHJ1bmVfbW9kZTogc2VsZi5wcnVuZV9tb2RlLAogICAgICAgICAgICAgICAgZXRsX2NvbmZpZzogRXRsQ29uZmlnOjpkZWZhdWx0KCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaW1wbCBFeGVjdXRlU3RhZ2VUZXN0UnVubmVyIGZvciBJbmRleEFjY291bnRIaXN0b3J5VGVzdFJ1bm5lciB7CiAgICAgICAgdHlwZSBTZWVkID0gKCk7CgogICAgICAgIGZuIHNlZWRfZXhlY3V0aW9uKCZtdXQgc2VsZiwgaW5wdXQ6IEV4ZWNJbnB1dCkgLT4gUmVzdWx0PFNlbGY6OlNlZWQsIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICBsZXQgc3RhZ2VfcHJvY2VzcyA9IGlucHV0LmNoZWNrcG9pbnQoKS5ibG9ja19udW1iZXI7CiAgICAgICAgICAgIGxldCBzdGFydCA9IHN0YWdlX3Byb2Nlc3MgKyAxOwogICAgICAgICAgICBsZXQgZW5kID0gaW5wdXQudGFyZ2V0KCk7CiAgICAgICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CgogICAgICAgICAgICBsZXQgbnVtX29mX2FjY291bnRzID0gMzE7CiAgICAgICAgICAgIGxldCBhY2NvdW50cyA9IHJhbmRvbV9jb250cmFjdF9hY2NvdW50X3JhbmdlKCZtdXQgcm5nLCAmbXV0ICgwLi5udW1fb2ZfYWNjb3VudHMpKQogICAgICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgICAgICAuY29sbGVjdDo6PEJUcmVlTWFwPF8sIF8+PigpOwoKICAgICAgICAgICAgbGV0IGJsb2NrcyA9IHJhbmRvbV9ibG9ja19yYW5nZSgKICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgc3RhcnQuLj1lbmQsCiAgICAgICAgICAgICAgICBCbG9ja1JhbmdlUGFyYW1zIHsgcGFyZW50OiBTb21lKEIyNTY6OlpFUk8pLCB0eF9jb3VudDogMC4uMywgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfSwKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGxldCAoY2hhbmdlc2V0cywgXykgPSByYW5kb21fY2hhbmdlc2V0X3JhbmdlKAogICAgICAgICAgICAgICAgJm11dCBybmcsCiAgICAgICAgICAgICAgICBibG9ja3MuaXRlcigpLAogICAgICAgICAgICAgICAgYWNjb3VudHMuaW50b19pdGVyKCkubWFwKHwoYWRkciwgYWNjKXwgKGFkZHIsIChhY2MsIFZlYzo6bmV3KCkpKSksCiAgICAgICAgICAgICAgICAwLi4zLAogICAgICAgICAgICAgICAgMC4uMjU2LAogICAgICAgICAgICApOwoKICAgICAgICAgICAgLy8gYWRkIGJsb2NrIGNoYW5nZXNldCBmcm9tIGJsb2NrIDEuCiAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X2NoYW5nZXNldHMoY2hhbmdlc2V0cywgU29tZShzdGFydCkpPzsKCiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0KCiAgICAgICAgZm4gdmFsaWRhdGVfZXhlY3V0aW9uKAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgaW5wdXQ6IEV4ZWNJbnB1dCwKICAgICAgICAgICAgb3V0cHV0OiBPcHRpb248RXhlY091dHB1dD4sCiAgICAgICAgKSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICBpZiBsZXQgU29tZShvdXRwdXQpID0gb3V0cHV0IHsKICAgICAgICAgICAgICAgIGxldCBzdGFydF9ibG9jayA9IGlucHV0Lm5leHRfYmxvY2soKTsKICAgICAgICAgICAgICAgIGxldCBlbmRfYmxvY2sgPSBvdXRwdXQuY2hlY2twb2ludC5ibG9ja19udW1iZXI7CiAgICAgICAgICAgICAgICBpZiBzdGFydF9ibG9jayA+IGVuZF9ibG9jayB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9rKCgpKQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0LAogICAgICAgICAgICAgICAgICAgIEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhpbnB1dC50YXJnZXQoKSksIGRvbmU6IHRydWUgfQogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBsZXQgcHJvdmlkZXIgPSBzZWxmLmRiLmZhY3RvcnkucHJvdmlkZXIoKT87CiAgICAgICAgICAgICAgICBsZXQgbXV0IGNoYW5nZXNldF9jdXJzb3IgPQogICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmN1cnNvcl9yZWFkOjo8dGFibGVzOjpBY2NvdW50Q2hhbmdlU2V0cz4oKT87CgogICAgICAgICAgICAgICAgbGV0IGFjY291bnRfdHJhbnNpdGlvbnMgPQogICAgICAgICAgICAgICAgICAgIGNoYW5nZXNldF9jdXJzb3Iud2Fsa19yYW5nZShzdGFydF9ibG9jay4uPWVuZF9ibG9jayk/LnRyeV9mb2xkKAogICAgICAgICAgICAgICAgICAgICAgICBCVHJlZU1hcDo6bmV3KCksCiAgICAgICAgICAgICAgICAgICAgICAgIHxtdXQgYWNjb3VudHM6IEJUcmVlTWFwPEFkZHJlc3MsIFZlYzx1NjQ+PiwKICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5fAogICAgICAgICAgICAgICAgICAgICAgICAgLT4gUmVzdWx0PF8sIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IChpbmRleCwgYWNjb3VudCkgPSBlbnRyeT87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50cy5lbnRyeShhY2NvdW50LmFkZHJlc3MpLm9yX2RlZmF1bHQoKS5wdXNoKGluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9rKGFjY291bnRzKQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICk/OwoKICAgICAgICAgICAgICAgIGxldCBtdXQgcmVzdWx0ID0gQlRyZWVNYXA6Om5ldygpOwogICAgICAgICAgICAgICAgZm9yIChhZGRyZXNzLCBpbmRpY2VzKSBpbiBhY2NvdW50X3RyYW5zaXRpb25zIHsKICAgICAgICAgICAgICAgICAgICAvLyBjaHVuayBpbmRpY2VzIGFuZCBpbnNlcnQgdGhlbSBpbiBzaGFyZHMgb2YgTiBzaXplLgogICAgICAgICAgICAgICAgICAgIGxldCBtdXQgY2h1bmtzID0gaW5kaWNlcwogICAgICAgICAgICAgICAgICAgICAgICAuaXRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgIC5jaHVua3Moc2hhcmRlZF9rZXk6Ok5VTV9PRl9JTkRJQ0VTX0lOX1NIQVJEKQogICAgICAgICAgICAgICAgICAgICAgICAuaW50b19pdGVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCh8Y2h1bmtzfCBjaHVua3MuY29waWVkKCkuY29sbGVjdDo6PFZlYzxfPj4oKSkKICAgICAgICAgICAgICAgICAgICAgICAgLmNvbGxlY3Q6OjxWZWM8VmVjPF8+Pj4oKTsKICAgICAgICAgICAgICAgICAgICBsZXQgbGFzdF9jaHVuayA9IGNodW5rcy5wb3AoKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIGxpc3QgaW4gY2h1bmtzIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmluc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNoYXJkZWRLZXk6Om5ldygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICpsaXN0Lmxhc3QoKS5leHBlY3QoIkNodWNrIGRvZXMgbm90IHJldHVybiBlbXB0eSBsaXN0IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXMgQmxvY2tOdW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdCwKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKGxhc3RfbGlzdCkgPSBsYXN0X2NodW5rIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmluc2VydChTaGFyZGVkS2V5OjpuZXcoYWRkcmVzcywgdTY0OjpNQVgpLCBsYXN0X2xpc3QpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGV0IHRhYmxlID0gY2FzdChzZWxmLmRiLnRhYmxlOjo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KCkudW53cmFwKCkpOwogICAgICAgICAgICAgICAgYXNzZXJ0X2VxISh0YWJsZSwgcmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBPaygoKSkKICAgICAgICB9CiAgICB9CgogICAgaW1wbCBVbndpbmRTdGFnZVRlc3RSdW5uZXIgZm9yIEluZGV4QWNjb3VudEhpc3RvcnlUZXN0UnVubmVyIHsKICAgICAgICBmbiB2YWxpZGF0ZV91bndpbmQoJnNlbGYsIF9pbnB1dDogVW53aW5kSW5wdXQpIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgIGxldCB0YWJsZSA9IHNlbGYuZGIudGFibGU6Ojx0YWJsZXM6OkFjY291bnRzSGlzdG9yeT4oKS51bndyYXAoKTsKICAgICAgICAgICAgYXNzZXJ0ISh0YWJsZS5pc19lbXB0eSgpKTsKICAgICAgICAgICAgT2soKCkpCiAgICAgICAgfQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvc3RhZ2VzL3NyYy9zdGFnZXMvaW5kZXhfc3RvcmFnZV9oaXN0b3J5LnJzIj4KdXNlIHN1cGVyOjp7Y29sbGVjdF9oaXN0b3J5X2luZGljZXMsIGxvYWRfaGlzdG9yeV9pbmRpY2VzfTsKdXNlIGNyYXRlOjp7U3RhZ2VDaGVja3BvaW50LCBTdGFnZUlkfTsKdXNlIHJldGhfY29uZmlnOjpjb25maWc6OntFdGxDb25maWcsIEluZGV4SGlzdG9yeUNvbmZpZ307CnVzZSByZXRoX2RiX2FwaTo6ewogICAgbW9kZWxzOjp7c3RvcmFnZV9zaGFyZGVkX2tleTo6U3RvcmFnZVNoYXJkZWRLZXksIEFkZHJlc3NTdG9yYWdlS2V5LCBCbG9ja051bWJlckFkZHJlc3N9LAogICAgdGFibGU6OkRlY29kZSwKICAgIHRhYmxlcywKICAgIHRyYW5zYWN0aW9uOjpEYlR4TXV0LAp9Owp1c2UgcmV0aF9wcm92aWRlcjo6e0RCUHJvdmlkZXIsIEhpc3RvcnlXcml0ZXIsIFBydW5lQ2hlY2twb2ludFJlYWRlciwgUHJ1bmVDaGVja3BvaW50V3JpdGVyfTsKdXNlIHJldGhfcHJ1bmVfdHlwZXM6OntQcnVuZUNoZWNrcG9pbnQsIFBydW5lTW9kZSwgUHJ1bmVQdXJwb3NlLCBQcnVuZVNlZ21lbnR9Owp1c2UgcmV0aF9zdGFnZXNfYXBpOjp7RXhlY0lucHV0LCBFeGVjT3V0cHV0LCBTdGFnZSwgU3RhZ2VFcnJvciwgVW53aW5kSW5wdXQsIFVud2luZE91dHB1dH07CnVzZSBzdGQ6OmZtdDo6RGVidWc7CnVzZSB0cmFjaW5nOjppbmZvOwoKLy8vIFN0YWdlIGlzIGluZGV4aW5nIGhpc3RvcnkgdGhlIGFjY291bnQgY2hhbmdlc2V0cyBnZW5lcmF0ZWQgaW4KLy8vIFtgRXhlY3V0aW9uU3RhZ2VgXVtjcmF0ZTo6c3RhZ2VzOjpFeGVjdXRpb25TdGFnZV0uIEZvciBtb3JlIGluZm9ybWF0aW9uCi8vLyBvbiBpbmRleCBzaGFyZGluZyB0YWtlIGEgbG9vayBhdCBbYHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5YF0uCiNbZGVyaXZlKERlYnVnKV0KcHViIHN0cnVjdCBJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2UgewogICAgLy8vIE51bWJlciBvZiBibG9ja3MgYWZ0ZXIgd2hpY2ggdGhlIGNvbnRyb2wKICAgIC8vLyBmbG93IHdpbGwgYmUgcmV0dXJuZWQgdG8gdGhlIHBpcGVsaW5lIGZvciBjb21taXQuCiAgICBwdWIgY29tbWl0X3RocmVzaG9sZDogdTY0LAogICAgLy8vIFBydW5pbmcgY29uZmlndXJhdGlvbi4KICAgIHB1YiBwcnVuZV9tb2RlOiBPcHRpb248UHJ1bmVNb2RlPiwKICAgIC8vLyBFVEwgY29uZmlndXJhdGlvbgogICAgcHViIGV0bF9jb25maWc6IEV0bENvbmZpZywKfQoKaW1wbCBJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2UgewogICAgLy8vIENyZWF0ZSBuZXcgaW5zdGFuY2Ugb2YgW2BJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2VgXS4KICAgIHB1YiBjb25zdCBmbiBuZXcoCiAgICAgICAgY29uZmlnOiBJbmRleEhpc3RvcnlDb25maWcsCiAgICAgICAgZXRsX2NvbmZpZzogRXRsQ29uZmlnLAogICAgICAgIHBydW5lX21vZGU6IE9wdGlvbjxQcnVuZU1vZGU+LAogICAgKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgY29tbWl0X3RocmVzaG9sZDogY29uZmlnLmNvbW1pdF90aHJlc2hvbGQsIHBydW5lX21vZGUsIGV0bF9jb25maWcgfQogICAgfQp9CgppbXBsIERlZmF1bHQgZm9yIEluZGV4U3RvcmFnZUhpc3RvcnlTdGFnZSB7CiAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGNvbW1pdF90aHJlc2hvbGQ6IDEwMF8wMDAsIHBydW5lX21vZGU6IE5vbmUsIGV0bF9jb25maWc6IEV0bENvbmZpZzo6ZGVmYXVsdCgpIH0KICAgIH0KfQoKaW1wbDxQcm92aWRlcj4gU3RhZ2U8UHJvdmlkZXI+IGZvciBJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2UKd2hlcmUKICAgIFByb3ZpZGVyOgogICAgICAgIERCUHJvdmlkZXI8VHg6IERiVHhNdXQ+ICsgUHJ1bmVDaGVja3BvaW50V3JpdGVyICsgSGlzdG9yeVdyaXRlciArIFBydW5lQ2hlY2twb2ludFJlYWRlciwKewogICAgLy8vIFJldHVybiB0aGUgaWQgb2YgdGhlIHN0YWdlCiAgICBmbiBpZCgmc2VsZikgLT4gU3RhZ2VJZCB7CiAgICAgICAgU3RhZ2VJZDo6SW5kZXhTdG9yYWdlSGlzdG9yeQogICAgfQoKICAgIC8vLyBFeGVjdXRlIHRoZSBzdGFnZS4KICAgIGZuIGV4ZWN1dGUoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICAgICAgbXV0IGlucHV0OiBFeGVjSW5wdXQsCiAgICApIC0+IFJlc3VsdDxFeGVjT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgaWYgbGV0IFNvbWUoKHRhcmdldF9wcnVuYWJsZV9ibG9jaywgcHJ1bmVfbW9kZSkpID0gc2VsZgogICAgICAgICAgICAucHJ1bmVfbW9kZQogICAgICAgICAgICAubWFwKHxtb2RlfCB7CiAgICAgICAgICAgICAgICBtb2RlLnBydW5lX3RhcmdldF9ibG9jaygKICAgICAgICAgICAgICAgICAgICBpbnB1dC50YXJnZXQoKSwKICAgICAgICAgICAgICAgICAgICBQcnVuZVNlZ21lbnQ6OlN0b3JhZ2VIaXN0b3J5LAogICAgICAgICAgICAgICAgICAgIFBydW5lUHVycG9zZTo6VXNlciwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnRyYW5zcG9zZSgpPwogICAgICAgICAgICAuZmxhdHRlbigpICYmCiAgICAgICAgICAgIHRhcmdldF9wcnVuYWJsZV9ibG9jayA+IGlucHV0LmNoZWNrcG9pbnQoKS5ibG9ja19udW1iZXIKICAgICAgICB7CiAgICAgICAgICAgIGlucHV0LmNoZWNrcG9pbnQgPSBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KHRhcmdldF9wcnVuYWJsZV9ibG9jaykpOwoKICAgICAgICAgICAgLy8gU2F2ZSBwcnVuZSBjaGVja3BvaW50IG9ubHkgaWYgd2UgZG9uJ3QgaGF2ZSBvbmUgYWxyZWFkeS4KICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBwcnVuZXIgbWF5IHNraXAgdGhlIHVucHJ1bmVkIHJhbmdlIG9mIGJsb2Nrcy4KICAgICAgICAgICAgaWYgcHJvdmlkZXIuZ2V0X3BydW5lX2NoZWNrcG9pbnQoUHJ1bmVTZWdtZW50OjpTdG9yYWdlSGlzdG9yeSk/LmlzX25vbmUoKSB7CiAgICAgICAgICAgICAgICBwcm92aWRlci5zYXZlX3BydW5lX2NoZWNrcG9pbnQoCiAgICAgICAgICAgICAgICAgICAgUHJ1bmVTZWdtZW50OjpTdG9yYWdlSGlzdG9yeSwKICAgICAgICAgICAgICAgICAgICBQcnVuZUNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgICAgICBibG9ja19udW1iZXI6IFNvbWUodGFyZ2V0X3BydW5hYmxlX2Jsb2NrKSwKICAgICAgICAgICAgICAgICAgICAgICAgdHhfbnVtYmVyOiBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICBwcnVuZV9tb2RlLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICApPzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgaW5wdXQudGFyZ2V0X3JlYWNoZWQoKSB7CiAgICAgICAgICAgIHJldHVybiBPayhFeGVjT3V0cHV0Ojpkb25lKGlucHV0LmNoZWNrcG9pbnQoKSkpCiAgICAgICAgfQoKICAgICAgICBsZXQgbXV0IHJhbmdlID0gaW5wdXQubmV4dF9ibG9ja19yYW5nZSgpOwogICAgICAgIGxldCBmaXJzdF9zeW5jID0gaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlciA9PSAwOwoKICAgICAgICAvLyBPbiBmaXJzdCBzeW5jIHdlIG1pZ2h0IGhhdmUgaGlzdG9yeSBjb21pbmcgZnJvbSBnZW5lc2lzLiBXZSBjbGVhciB0aGUgdGFibGUgc2luY2UgaXQncwogICAgICAgIC8vIGZhc3RlciB0byByZWJ1aWxkIGZyb20gc2NyYXRjaC4KICAgICAgICBpZiBmaXJzdF9zeW5jIHsKICAgICAgICAgICAgcHJvdmlkZXIudHhfcmVmKCkuY2xlYXI6Ojx0YWJsZXM6OlN0b3JhZ2VzSGlzdG9yeT4oKT87CiAgICAgICAgICAgIHJhbmdlID0gMC4uPSppbnB1dC5uZXh0X2Jsb2NrX3JhbmdlKCkuZW5kKCk7CiAgICAgICAgfQoKICAgICAgICBpbmZvISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OmluZGV4X3N0b3JhZ2VfaGlzdG9yeTo6ZXhlYyIsID9maXJzdF9zeW5jLCAiQ29sbGVjdGluZyBpbmRpY2VzIik7CiAgICAgICAgbGV0IGNvbGxlY3RvciA9CiAgICAgICAgICAgIGNvbGxlY3RfaGlzdG9yeV9pbmRpY2VzOjo8XywgdGFibGVzOjpTdG9yYWdlQ2hhbmdlU2V0cywgdGFibGVzOjpTdG9yYWdlc0hpc3RvcnksIF8+KAogICAgICAgICAgICAgICAgcHJvdmlkZXIsCiAgICAgICAgICAgICAgICBCbG9ja051bWJlckFkZHJlc3M6OnJhbmdlKHJhbmdlLmNsb25lKCkpLAogICAgICAgICAgICAgICAgfEFkZHJlc3NTdG9yYWdlS2V5KChhZGRyZXNzLCBzdG9yYWdlX2tleSkpLCBoaWdoZXN0X2Jsb2NrX251bWJlcnwgewogICAgICAgICAgICAgICAgICAgIFN0b3JhZ2VTaGFyZGVkS2V5OjpuZXcoYWRkcmVzcywgc3RvcmFnZV9rZXksIGhpZ2hlc3RfYmxvY2tfbnVtYmVyKQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHwoa2V5LCB2YWx1ZSl8IChrZXkuYmxvY2tfbnVtYmVyKCksIEFkZHJlc3NTdG9yYWdlS2V5KChrZXkuYWRkcmVzcygpLCB2YWx1ZS5rZXkpKSksCiAgICAgICAgICAgICAgICAmc2VsZi5ldGxfY29uZmlnLAogICAgICAgICAgICApPzsKCiAgICAgICAgaW5mbyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjppbmRleF9zdG9yYWdlX2hpc3Rvcnk6OmV4ZWMiLCAiTG9hZGluZyBpbmRpY2VzIGludG8gZGF0YWJhc2UiKTsKICAgICAgICBsb2FkX2hpc3RvcnlfaW5kaWNlczo6PF8sIHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5LCBfPigKICAgICAgICAgICAgcHJvdmlkZXIsCiAgICAgICAgICAgIGNvbGxlY3RvciwKICAgICAgICAgICAgZmlyc3Rfc3luYywKICAgICAgICAgICAgfEFkZHJlc3NTdG9yYWdlS2V5KChhZGRyZXNzLCBzdG9yYWdlX2tleSkpLCBoaWdoZXN0X2Jsb2NrX251bWJlcnwgewogICAgICAgICAgICAgICAgU3RvcmFnZVNoYXJkZWRLZXk6Om5ldyhhZGRyZXNzLCBzdG9yYWdlX2tleSwgaGlnaGVzdF9ibG9ja19udW1iZXIpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFN0b3JhZ2VTaGFyZGVkS2V5OjpkZWNvZGVfb3duZWQsCiAgICAgICAgICAgIHxrZXl8IEFkZHJlc3NTdG9yYWdlS2V5KChrZXkuYWRkcmVzcywga2V5LnNoYXJkZWRfa2V5LmtleSkpLAogICAgICAgICk/OwoKICAgICAgICBPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoKnJhbmdlLmVuZCgpKSwgZG9uZTogdHJ1ZSB9KQogICAgfQoKICAgIC8vLyBVbndpbmQgdGhlIHN0YWdlLgogICAgZm4gdW53aW5kKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBwcm92aWRlcjogJlByb3ZpZGVyLAogICAgICAgIGlucHV0OiBVbndpbmRJbnB1dCwKICAgICkgLT4gUmVzdWx0PFVud2luZE91dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIGxldCAocmFuZ2UsIHVud2luZF9wcm9ncmVzcywgXykgPQogICAgICAgICAgICBpbnB1dC51bndpbmRfYmxvY2tfcmFuZ2Vfd2l0aF90aHJlc2hvbGQoc2VsZi5jb21taXRfdGhyZXNob2xkKTsKCiAgICAgICAgcHJvdmlkZXIudW53aW5kX3N0b3JhZ2VfaGlzdG9yeV9pbmRpY2VzX3JhbmdlKEJsb2NrTnVtYmVyQWRkcmVzczo6cmFuZ2UocmFuZ2UpKT87CgogICAgICAgIE9rKFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KHVud2luZF9wcm9ncmVzcykgfSkKICAgIH0KfQoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6Oio7CiAgICB1c2UgY3JhdGU6OnRlc3RfdXRpbHM6OnsKICAgICAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCwgRXhlY3V0ZVN0YWdlVGVzdFJ1bm5lciwgU3RhZ2VUZXN0UnVubmVyLCBUZXN0UnVubmVyRXJyb3IsCiAgICAgICAgVGVzdFN0YWdlREIsIFVud2luZFN0YWdlVGVzdFJ1bm5lciwKICAgIH07CiAgICB1c2UgYWxsb3lfcHJpbWl0aXZlczo6e2FkZHJlc3MsIGIyNTYsIEFkZHJlc3MsIEJsb2NrTnVtYmVyLCBCMjU2LCBVMjU2fTsKICAgIHVzZSBpdGVydG9vbHM6Okl0ZXJ0b29sczsKICAgIHVzZSByZXRoX2RiX2FwaTo6ewogICAgICAgIGN1cnNvcjo6RGJDdXJzb3JSTywKICAgICAgICBtb2RlbHM6OnsKICAgICAgICAgICAgc2hhcmRlZF9rZXksIHN0b3JhZ2Vfc2hhcmRlZF9rZXk6Ok5VTV9PRl9JTkRJQ0VTX0lOX1NIQVJELCBTaGFyZGVkS2V5LAogICAgICAgICAgICBTdG9yZWRCbG9ja0JvZHlJbmRpY2VzLAogICAgICAgIH0sCiAgICAgICAgdHJhbnNhY3Rpb246OkRiVHgsCiAgICAgICAgQmxvY2tOdW1iZXJMaXN0LAogICAgfTsKICAgIHVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjpTdG9yYWdlRW50cnk7CiAgICB1c2UgcmV0aF9wcm92aWRlcjo6e3Byb3ZpZGVyczo6U3RhdGljRmlsZVdyaXRlciwgRGF0YWJhc2VQcm92aWRlckZhY3Rvcnl9OwogICAgdXNlIHJldGhfdGVzdGluZ191dGlsczo6Z2VuZXJhdG9yczo6ewogICAgICAgIHNlbGYsIHJhbmRvbV9ibG9ja19yYW5nZSwgcmFuZG9tX2NoYW5nZXNldF9yYW5nZSwgcmFuZG9tX2NvbnRyYWN0X2FjY291bnRfcmFuZ2UsCiAgICAgICAgQmxvY2tSYW5nZVBhcmFtcywKICAgIH07CiAgICB1c2Ugc3RkOjpjb2xsZWN0aW9uczo6QlRyZWVNYXA7CgogICAgY29uc3QgQUREUkVTUzogQWRkcmVzcyA9IGFkZHJlc3MhKCIweDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDEiKTsKICAgIGNvbnN0IFNUT1JBR0VfS0VZOiBCMjU2ID0KICAgICAgICBiMjU2ISgiMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAxIik7CgogICAgY29uc3QgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEOiBCbG9ja051bWJlciA9IE5VTV9PRl9JTkRJQ0VTX0lOX1NIQVJEIGFzIEJsb2NrTnVtYmVyOwogICAgY29uc3QgTUFYX0JMT0NLOiBCbG9ja051bWJlciA9IE5VTV9PRl9JTkRJQ0VTX0lOX1NIQVJEIGFzIEJsb2NrTnVtYmVyICsgMjsKCiAgICBjb25zdCBmbiBzdG9yYWdlKGtleTogQjI1NikgLT4gU3RvcmFnZUVudHJ5IHsKICAgICAgICAvLyBWYWx1ZSBpcyBub3QgdXNlZCBpbiBpbmRleGluZyBzdGFnZS4KICAgICAgICBTdG9yYWdlRW50cnkgeyBrZXksIHZhbHVlOiBVMjU2OjpaRVJPIH0KICAgIH0KCiAgICBjb25zdCBmbiBibG9ja19udW1iZXJfYWRkcmVzcyhibG9ja19udW1iZXI6IHU2NCkgLT4gQmxvY2tOdW1iZXJBZGRyZXNzIHsKICAgICAgICBCbG9ja051bWJlckFkZHJlc3MoKGJsb2NrX251bWJlciwgQUREUkVTUykpCiAgICB9CgogICAgLy8vIFNoYXJkIGZvciBhY2NvdW50CiAgICBjb25zdCBmbiBzaGFyZChzaGFyZF9pbmRleDogdTY0KSAtPiBTdG9yYWdlU2hhcmRlZEtleSB7CiAgICAgICAgU3RvcmFnZVNoYXJkZWRLZXkgewogICAgICAgICAgICBhZGRyZXNzOiBBRERSRVNTLAogICAgICAgICAgICBzaGFyZGVkX2tleTogU2hhcmRlZEtleSB7IGtleTogU1RPUkFHRV9LRVksIGhpZ2hlc3RfYmxvY2tfbnVtYmVyOiBzaGFyZF9pbmRleCB9LAogICAgICAgIH0KICAgIH0KCiAgICBmbiBsaXN0KGxpc3Q6ICZbdTY0XSkgLT4gQmxvY2tOdW1iZXJMaXN0IHsKICAgICAgICBCbG9ja051bWJlckxpc3Q6Om5ldyhsaXN0Lml0ZXIoKS5jb3BpZWQoKSkudW53cmFwKCkKICAgIH0KCiAgICBmbiBjYXN0KAogICAgICAgIHRhYmxlOiBWZWM8KFN0b3JhZ2VTaGFyZGVkS2V5LCBCbG9ja051bWJlckxpc3QpPiwKICAgICkgLT4gQlRyZWVNYXA8U3RvcmFnZVNoYXJkZWRLZXksIFZlYzx1NjQ+PiB7CiAgICAgICAgdGFibGUKICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgIC5tYXAofChrLCB2KXwgewogICAgICAgICAgICAgICAgbGV0IHYgPSB2Lml0ZXIoKS5jb2xsZWN0KCk7CiAgICAgICAgICAgICAgICAoaywgdikKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLmNvbGxlY3QoKQogICAgfQoKICAgIGZuIHBhcnRpYWxfc2V0dXAoZGI6ICZUZXN0U3RhZ2VEQikgewogICAgICAgIC8vIHNldHVwCiAgICAgICAgZGIuY29tbWl0KHx0eHwgewogICAgICAgICAgICBmb3IgYmxvY2sgaW4gMC4uPU1BWF9CTE9DSyB7CiAgICAgICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OkJsb2NrQm9keUluZGljZXM+KAogICAgICAgICAgICAgICAgICAgIGJsb2NrLAogICAgICAgICAgICAgICAgICAgIFN0b3JlZEJsb2NrQm9keUluZGljZXMgeyB0eF9jb3VudDogMywgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfSwKICAgICAgICAgICAgICAgICk/OwogICAgICAgICAgICAgICAgLy8gc2V0dXAgY2hhbmdlc2V0IHRoYXQgaXMgZ29pbmcgdG8gYmUgYXBwbGllZCB0byBoaXN0b3J5IGluZGV4CiAgICAgICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OlN0b3JhZ2VDaGFuZ2VTZXRzPigKICAgICAgICAgICAgICAgICAgICBibG9ja19udW1iZXJfYWRkcmVzcyhibG9jayksCiAgICAgICAgICAgICAgICAgICAgc3RvcmFnZShTVE9SQUdFX0tFWSksCiAgICAgICAgICAgICAgICApPzsKICAgICAgICAgICAgfQogICAgICAgICAgICBPaygoKSkKICAgICAgICB9KQogICAgICAgIC51bndyYXAoKQogICAgfQoKICAgIGZuIHJ1bihkYjogJlRlc3RTdGFnZURCLCBydW5fdG86IHU2NCwgaW5wdXRfY2hlY2twb2ludDogT3B0aW9uPEJsb2NrTnVtYmVyPikgewogICAgICAgIGxldCBpbnB1dCA9IEV4ZWNJbnB1dCB7CiAgICAgICAgICAgIHRhcmdldDogU29tZShydW5fdG8pLAogICAgICAgICAgICBjaGVja3BvaW50OiBpbnB1dF9jaGVja3BvaW50CiAgICAgICAgICAgICAgICAubWFwKHxibG9ja19udW1iZXJ8IFN0YWdlQ2hlY2twb2ludCB7IGJsb2NrX251bWJlciwgc3RhZ2VfY2hlY2twb2ludDogTm9uZSB9KSwKICAgICAgICB9OwogICAgICAgIGxldCBtdXQgc3RhZ2UgPSBJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2U6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgcHJvdmlkZXIgPSBkYi5mYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgbGV0IG91dCA9IHN0YWdlLmV4ZWN1dGUoJnByb3ZpZGVyLCBpbnB1dCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShvdXQsIEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhydW5fdG8pLCBkb25lOiB0cnVlIH0pOwogICAgICAgIHByb3ZpZGVyLmNvbW1pdCgpLnVud3JhcCgpOwogICAgfQoKICAgIGZuIHVud2luZChkYjogJlRlc3RTdGFnZURCLCB1bndpbmRfZnJvbTogdTY0LCB1bndpbmRfdG86IHU2NCkgewogICAgICAgIGxldCBpbnB1dCA9IFVud2luZElucHV0IHsKICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcodW53aW5kX2Zyb20pLAogICAgICAgICAgICB1bndpbmRfdG8sCiAgICAgICAgICAgIC4uRGVmYXVsdDo6ZGVmYXVsdCgpCiAgICAgICAgfTsKICAgICAgICBsZXQgbXV0IHN0YWdlID0gSW5kZXhTdG9yYWdlSGlzdG9yeVN0YWdlOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IHByb3ZpZGVyID0gZGIuZmFjdG9yeS5kYXRhYmFzZV9wcm92aWRlcl9ydygpLnVud3JhcCgpOwogICAgICAgIGxldCBvdXQgPSBzdGFnZS51bndpbmQoJnByb3ZpZGVyLCBpbnB1dCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShvdXQsIFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KHVud2luZF90bykgfSk7CiAgICAgICAgcHJvdmlkZXIuY29tbWl0KCkudW53cmFwKCk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGluc2VydF9pbmRleF90b19nZW5lc2lzKCkgewogICAgICAgIC8vIGluaXQKICAgICAgICBsZXQgZGIgPSBUZXN0U3RhZ2VEQjo6ZGVmYXVsdCgpOwoKICAgICAgICAvLyBzZXR1cAogICAgICAgIHBhcnRpYWxfc2V0dXAoJmRiKTsKCiAgICAgICAgLy8gcnVuCiAgICAgICAgcnVuKCZkYiwgMywgTm9uZSk7CgogICAgICAgIC8vIHZlcmlmeQogICAgICAgIGxldCB0YWJsZSA9IGNhc3QoZGIudGFibGU6Ojx0YWJsZXM6OlN0b3JhZ2VzSGlzdG9yeT4oKS51bndyYXAoKSk7CiAgICAgICAgYXNzZXJ0X2VxISh0YWJsZSwgQlRyZWVNYXA6OmZyb20oWyhzaGFyZCh1NjQ6Ok1BWCksIHZlYyFbMCwgMSwgMiwgM10pXSkpOwoKICAgICAgICAvLyB1bndpbmQKICAgICAgICB1bndpbmQoJmRiLCA1LCAwKTsKCiAgICAgICAgLy8gdmVyaWZ5IGluaXRpYWwgc3RhdGUKICAgICAgICBsZXQgdGFibGUgPSBjYXN0KGRiLnRhYmxlOjo8dGFibGVzOjpTdG9yYWdlc0hpc3Rvcnk+KCkudW53cmFwKCkpOwogICAgICAgIGFzc2VydF9lcSEodGFibGUsIEJUcmVlTWFwOjpmcm9tKFsoc2hhcmQodTY0OjpNQVgpLCB2ZWMhWzBdKV0pKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gaW5zZXJ0X2luZGV4X3RvX25vdF9lbXB0eV9zaGFyZCgpIHsKICAgICAgICAvLyBpbml0CiAgICAgICAgbGV0IGRiID0gVGVzdFN0YWdlREI6OmRlZmF1bHQoKTsKCiAgICAgICAgLy8gc2V0dXAKICAgICAgICBwYXJ0aWFsX3NldHVwKCZkYik7CiAgICAgICAgZGIuY29tbWl0KHx0eHwgewogICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OlN0b3JhZ2VzSGlzdG9yeT4oc2hhcmQodTY0OjpNQVgpLCBsaXN0KCZbMSwgMiwgM10pKS51bndyYXAoKTsKICAgICAgICAgICAgT2soKCkpCiAgICAgICAgfSkKICAgICAgICAudW53cmFwKCk7CgogICAgICAgIC8vIHJ1bgogICAgICAgIHJ1bigmZGIsIDUsIFNvbWUoMykpOwoKICAgICAgICAvLyB2ZXJpZnkKICAgICAgICBsZXQgdGFibGUgPSBjYXN0KGRiLnRhYmxlOjo8dGFibGVzOjpTdG9yYWdlc0hpc3Rvcnk+KCkudW53cmFwKCkpOwogICAgICAgIGFzc2VydF9lcSEodGFibGUsIEJUcmVlTWFwOjpmcm9tKFsoc2hhcmQodTY0OjpNQVgpLCB2ZWMhWzEsIDIsIDMsIDQsIDVdKV0pKTsKCiAgICAgICAgLy8gdW53aW5kCiAgICAgICAgdW53aW5kKCZkYiwgNSwgMyk7CgogICAgICAgIC8vIHZlcmlmeSBpbml0aWFsIHN0YXRlCiAgICAgICAgbGV0IHRhYmxlID0gY2FzdChkYi50YWJsZTo6PHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5PigpLnVud3JhcCgpKTsKICAgICAgICBhc3NlcnRfZXEhKHRhYmxlLCBCVHJlZU1hcDo6ZnJvbShbKHNoYXJkKHU2NDo6TUFYKSwgdmVjIVsxLCAyLCAzXSldKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGluc2VydF9pbmRleF90b19mdWxsX3NoYXJkKCkgewogICAgICAgIC8vIGluaXQKICAgICAgICBsZXQgZGIgPSBUZXN0U3RhZ2VEQjo6ZGVmYXVsdCgpOwogICAgICAgIC8vIGNoYW5nZSBkb2VzIG5vdCBtYXR0ZXIgb25seSB0aGF0IGFjY291bnQgaXMgcHJlc2VudCBpbiBjaGFuZ2VzZXQuCiAgICAgICAgbGV0IGZ1bGxfbGlzdCA9ICgxLi49TEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEKS5jb2xsZWN0Ojo8VmVjPF8+PigpOwoKICAgICAgICAvLyBzZXR1cAogICAgICAgIHBhcnRpYWxfc2V0dXAoJmRiKTsKICAgICAgICBkYi5jb21taXQofHR4fCB7CiAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5PihzaGFyZCh1NjQ6Ok1BWCksIGxpc3QoJmZ1bGxfbGlzdCkpLnVud3JhcCgpOwogICAgICAgICAgICBPaygoKSkKICAgICAgICB9KQogICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgLy8gcnVuCiAgICAgICAgcnVuKCZkYiwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEICsgMiwgU29tZShMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQpKTsKCiAgICAgICAgLy8gdmVyaWZ5CiAgICAgICAgbGV0IHRhYmxlID0gY2FzdChkYi50YWJsZTo6PHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5PigpLnVud3JhcCgpKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICB0YWJsZSwKICAgICAgICAgICAgQlRyZWVNYXA6OmZyb20oWwogICAgICAgICAgICAgICAgKHNoYXJkKExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCksIGZ1bGxfbGlzdC5jbG9uZSgpKSwKICAgICAgICAgICAgICAgIChzaGFyZCh1NjQ6Ok1BWCksIHZlYyFbTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEICsgMSwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEICsgMl0pCiAgICAgICAgICAgIF0pCiAgICAgICAgKTsKCiAgICAgICAgLy8gdW53aW5kCiAgICAgICAgdW53aW5kKCZkYiwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEICsgMiwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEKTsKCiAgICAgICAgLy8gdmVyaWZ5IGluaXRpYWwgc3RhdGUKICAgICAgICBsZXQgdGFibGUgPSBjYXN0KGRiLnRhYmxlOjo8dGFibGVzOjpTdG9yYWdlc0hpc3Rvcnk+KCkudW53cmFwKCkpOwogICAgICAgIGFzc2VydF9lcSEodGFibGUsIEJUcmVlTWFwOjpmcm9tKFsoc2hhcmQodTY0OjpNQVgpLCBmdWxsX2xpc3QpXSkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBpbnNlcnRfaW5kZXhfdG9fZmlsbF9zaGFyZCgpIHsKICAgICAgICAvLyBpbml0CiAgICAgICAgbGV0IGRiID0gVGVzdFN0YWdlREI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgbXV0IGFsbW9zdF9mdWxsX2xpc3QgPSAoMS4uPUxBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCAtIDIpLmNvbGxlY3Q6OjxWZWM8Xz4+KCk7CgogICAgICAgIC8vIHNldHVwCiAgICAgICAgcGFydGlhbF9zZXR1cCgmZGIpOwogICAgICAgIGRiLmNvbW1pdCh8dHh8IHsKICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpTdG9yYWdlc0hpc3Rvcnk+KHNoYXJkKHU2NDo6TUFYKSwgbGlzdCgmYWxtb3N0X2Z1bGxfbGlzdCkpLnVud3JhcCgpOwogICAgICAgICAgICBPaygoKSkKICAgICAgICB9KQogICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgLy8gcnVuCiAgICAgICAgcnVuKCZkYiwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJELCBTb21lKExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCAtIDIpKTsKCiAgICAgICAgLy8gdmVyaWZ5CiAgICAgICAgYWxtb3N0X2Z1bGxfbGlzdC5wdXNoKExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCAtIDEpOwogICAgICAgIGFsbW9zdF9mdWxsX2xpc3QucHVzaChMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQpOwogICAgICAgIGxldCB0YWJsZSA9IGNhc3QoZGIudGFibGU6Ojx0YWJsZXM6OlN0b3JhZ2VzSGlzdG9yeT4oKS51bndyYXAoKSk7CiAgICAgICAgYXNzZXJ0X2VxISh0YWJsZSwgQlRyZWVNYXA6OmZyb20oWyhzaGFyZCh1NjQ6Ok1BWCksIGFsbW9zdF9mdWxsX2xpc3QuY2xvbmUoKSldKSk7CgogICAgICAgIC8vIHVud2luZAogICAgICAgIHVud2luZCgmZGIsIExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEIC0gMik7CgogICAgICAgIC8vIHZlcmlmeSBpbml0aWFsIHN0YXRlCiAgICAgICAgYWxtb3N0X2Z1bGxfbGlzdC5wb3AoKTsKICAgICAgICBhbG1vc3RfZnVsbF9saXN0LnBvcCgpOwogICAgICAgIGxldCB0YWJsZSA9IGNhc3QoZGIudGFibGU6Ojx0YWJsZXM6OlN0b3JhZ2VzSGlzdG9yeT4oKS51bndyYXAoKSk7CiAgICAgICAgYXNzZXJ0X2VxISh0YWJsZSwgQlRyZWVNYXA6OmZyb20oWyhzaGFyZCh1NjQ6Ok1BWCksIGFsbW9zdF9mdWxsX2xpc3QpXSkpOwoKICAgICAgICAvLyB2ZXJpZnkgaW5pdGlhbCBzdGF0ZQogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBpbnNlcnRfaW5kZXhfc2Vjb25kX2hhbGZfc2hhcmQoKSB7CiAgICAgICAgLy8gaW5pdAogICAgICAgIGxldCBkYiA9IFRlc3RTdGFnZURCOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IG11dCBjbG9zZV9mdWxsX2xpc3QgPSAoMS4uPUxBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCAtIDEpLmNvbGxlY3Q6OjxWZWM8Xz4+KCk7CgogICAgICAgIC8vIHNldHVwCiAgICAgICAgcGFydGlhbF9zZXR1cCgmZGIpOwogICAgICAgIGRiLmNvbW1pdCh8dHh8IHsKICAgICAgICAgICAgdHgucHV0Ojo8dGFibGVzOjpTdG9yYWdlc0hpc3Rvcnk+KHNoYXJkKHU2NDo6TUFYKSwgbGlzdCgmY2xvc2VfZnVsbF9saXN0KSkudW53cmFwKCk7CiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0pCiAgICAgICAgLnVud3JhcCgpOwoKICAgICAgICAvLyBydW4KICAgICAgICBydW4oJmRiLCBMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAxLCBTb21lKExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCAtIDEpKTsKCiAgICAgICAgLy8gdmVyaWZ5CiAgICAgICAgY2xvc2VfZnVsbF9saXN0LnB1c2goTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEKTsKICAgICAgICBsZXQgdGFibGUgPSBjYXN0KGRiLnRhYmxlOjo8dGFibGVzOjpTdG9yYWdlc0hpc3Rvcnk+KCkudW53cmFwKCkpOwogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIHRhYmxlLAogICAgICAgICAgICBCVHJlZU1hcDo6ZnJvbShbCiAgICAgICAgICAgICAgICAoc2hhcmQoTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEKSwgY2xvc2VfZnVsbF9saXN0LmNsb25lKCkpLAogICAgICAgICAgICAgICAgKHNoYXJkKHU2NDo6TUFYKSwgdmVjIVtMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAxXSkKICAgICAgICAgICAgXSkKICAgICAgICApOwoKICAgICAgICAvLyB1bndpbmQKICAgICAgICB1bndpbmQoJmRiLCBMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQsIExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCAtIDEpOwoKICAgICAgICAvLyB2ZXJpZnkgaW5pdGlhbCBzdGF0ZQogICAgICAgIGNsb3NlX2Z1bGxfbGlzdC5wb3AoKTsKICAgICAgICBsZXQgdGFibGUgPSBjYXN0KGRiLnRhYmxlOjo8dGFibGVzOjpTdG9yYWdlc0hpc3Rvcnk+KCkudW53cmFwKCkpOwogICAgICAgIGFzc2VydF9lcSEodGFibGUsIEJUcmVlTWFwOjpmcm9tKFsoc2hhcmQodTY0OjpNQVgpLCBjbG9zZV9mdWxsX2xpc3QpXSkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBpbnNlcnRfaW5kZXhfdG9fdGhpcmRfc2hhcmQoKSB7CiAgICAgICAgLy8gaW5pdAogICAgICAgIGxldCBkYiA9IFRlc3RTdGFnZURCOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IGZ1bGxfbGlzdCA9ICgxLi49TEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEKS5jb2xsZWN0Ojo8VmVjPF8+PigpOwoKICAgICAgICAvLyBzZXR1cAogICAgICAgIHBhcnRpYWxfc2V0dXAoJmRiKTsKICAgICAgICBkYi5jb21taXQofHR4fCB7CiAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5PihzaGFyZCgxKSwgbGlzdCgmZnVsbF9saXN0KSkudW53cmFwKCk7CiAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5PihzaGFyZCgyKSwgbGlzdCgmZnVsbF9saXN0KSkudW53cmFwKCk7CiAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5PigKICAgICAgICAgICAgICAgIHNoYXJkKHU2NDo6TUFYKSwKICAgICAgICAgICAgICAgIGxpc3QoJltMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAxXSksCiAgICAgICAgICAgICkKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgICAgICBPaygoKSkKICAgICAgICB9KQogICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgcnVuKCZkYiwgTEFTVF9CTE9DS19JTl9GVUxMX1NIQVJEICsgMiwgU29tZShMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAxKSk7CgogICAgICAgIC8vIHZlcmlmeQogICAgICAgIGxldCB0YWJsZSA9IGNhc3QoZGIudGFibGU6Ojx0YWJsZXM6OlN0b3JhZ2VzSGlzdG9yeT4oKS51bndyYXAoKSk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgdGFibGUsCiAgICAgICAgICAgIEJUcmVlTWFwOjpmcm9tKFsKICAgICAgICAgICAgICAgIChzaGFyZCgxKSwgZnVsbF9saXN0LmNsb25lKCkpLAogICAgICAgICAgICAgICAgKHNoYXJkKDIpLCBmdWxsX2xpc3QuY2xvbmUoKSksCiAgICAgICAgICAgICAgICAoc2hhcmQodTY0OjpNQVgpLCB2ZWMhW0xBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCArIDEsIExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCArIDJdKQogICAgICAgICAgICBdKQogICAgICAgICk7CgogICAgICAgIC8vIHVud2luZAogICAgICAgIHVud2luZCgmZGIsIExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCArIDIsIExBU1RfQkxPQ0tfSU5fRlVMTF9TSEFSRCArIDEpOwoKICAgICAgICAvLyB2ZXJpZnkgaW5pdGlhbCBzdGF0ZQogICAgICAgIGxldCB0YWJsZSA9IGNhc3QoZGIudGFibGU6Ojx0YWJsZXM6OlN0b3JhZ2VzSGlzdG9yeT4oKS51bndyYXAoKSk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgdGFibGUsCiAgICAgICAgICAgIEJUcmVlTWFwOjpmcm9tKFsKICAgICAgICAgICAgICAgIChzaGFyZCgxKSwgZnVsbF9saXN0LmNsb25lKCkpLAogICAgICAgICAgICAgICAgKHNoYXJkKDIpLCBmdWxsX2xpc3QpLAogICAgICAgICAgICAgICAgKHNoYXJkKHU2NDo6TUFYKSwgdmVjIVtMQVNUX0JMT0NLX0lOX0ZVTExfU0hBUkQgKyAxXSkKICAgICAgICAgICAgXSkKICAgICAgICApOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBpbnNlcnRfaW5kZXhfd2l0aF9wcnVuZV9tb2RlKCkgewogICAgICAgIC8vIGluaXQKICAgICAgICBsZXQgZGIgPSBUZXN0U3RhZ2VEQjo6ZGVmYXVsdCgpOwoKICAgICAgICAvLyBzZXR1cAogICAgICAgIGRiLmNvbW1pdCh8dHh8IHsKICAgICAgICAgICAgLy8gd2UganVzdCBuZWVkIGZpcnN0IGFuZCBsYXN0CiAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6QmxvY2tCb2R5SW5kaWNlcz4oCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgU3RvcmVkQmxvY2tCb2R5SW5kaWNlcyB7IHR4X2NvdW50OiAzLCAuLkRlZmF1bHQ6OmRlZmF1bHQoKSB9LAogICAgICAgICAgICApCiAgICAgICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgICAgIHR4LnB1dDo6PHRhYmxlczo6QmxvY2tCb2R5SW5kaWNlcz4oCiAgICAgICAgICAgICAgICAxMDAsCiAgICAgICAgICAgICAgICBTdG9yZWRCbG9ja0JvZHlJbmRpY2VzIHsgdHhfY291bnQ6IDUsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgICAgICkKICAgICAgICAgICAgLnVud3JhcCgpOwoKICAgICAgICAgICAgLy8gc2V0dXAgY2hhbmdlc2V0IHRoYXQgYXJlIGdvaW5nIHRvIGJlIGFwcGxpZWQgdG8gaGlzdG9yeSBpbmRleAogICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OlN0b3JhZ2VDaGFuZ2VTZXRzPihibG9ja19udW1iZXJfYWRkcmVzcygyMCksIHN0b3JhZ2UoU1RPUkFHRV9LRVkpKQogICAgICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OlN0b3JhZ2VDaGFuZ2VTZXRzPihibG9ja19udW1iZXJfYWRkcmVzcygzNiksIHN0b3JhZ2UoU1RPUkFHRV9LRVkpKQogICAgICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6OlN0b3JhZ2VDaGFuZ2VTZXRzPihibG9ja19udW1iZXJfYWRkcmVzcygxMDApLCBzdG9yYWdlKFNUT1JBR0VfS0VZKSkKICAgICAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICAgICAgT2soKCkpCiAgICAgICAgfSkKICAgICAgICAudW53cmFwKCk7CgogICAgICAgIC8vIHJ1bgogICAgICAgIGxldCBpbnB1dCA9IEV4ZWNJbnB1dCB7IHRhcmdldDogU29tZSgyMDAwMCksIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH07CiAgICAgICAgbGV0IG11dCBzdGFnZSA9IEluZGV4U3RvcmFnZUhpc3RvcnlTdGFnZSB7CiAgICAgICAgICAgIHBydW5lX21vZGU6IFNvbWUoUHJ1bmVNb2RlOjpCZWZvcmUoMzYpKSwKICAgICAgICAgICAgLi5EZWZhdWx0OjpkZWZhdWx0KCkKICAgICAgICB9OwogICAgICAgIGxldCBwcm92aWRlciA9IGRiLmZhY3RvcnkuZGF0YWJhc2VfcHJvdmlkZXJfcncoKS51bndyYXAoKTsKICAgICAgICBsZXQgb3V0ID0gc3RhZ2UuZXhlY3V0ZSgmcHJvdmlkZXIsIGlucHV0KS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKG91dCwgRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KDIwMDAwKSwgZG9uZTogdHJ1ZSB9KTsKICAgICAgICBwcm92aWRlci5jb21taXQoKS51bndyYXAoKTsKCiAgICAgICAgLy8gdmVyaWZ5CiAgICAgICAgbGV0IHRhYmxlID0gY2FzdChkYi50YWJsZTo6PHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5PigpLnVud3JhcCgpKTsKICAgICAgICBhc3NlcnRfZXEhKHRhYmxlLCBCVHJlZU1hcDo6ZnJvbShbKHNoYXJkKHU2NDo6TUFYKSwgdmVjIVszNiwgMTAwXSldKSk7CgogICAgICAgIC8vIHVud2luZAogICAgICAgIHVud2luZCgmZGIsIDIwMDAwLCAwKTsKCiAgICAgICAgLy8gdmVyaWZ5IGluaXRpYWwgc3RhdGUKICAgICAgICBsZXQgdGFibGUgPSBkYi50YWJsZTo6PHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5PigpLnVud3JhcCgpOwogICAgICAgIGFzc2VydCEodGFibGUuaXNfZW1wdHkoKSk7CiAgICB9CgogICAgc3RhZ2VfdGVzdF9zdWl0ZV9leHQhKEluZGV4U3RvcmFnZUhpc3RvcnlUZXN0UnVubmVyLCBpbmRleF9zdG9yYWdlX2hpc3RvcnkpOwoKICAgIHN0cnVjdCBJbmRleFN0b3JhZ2VIaXN0b3J5VGVzdFJ1bm5lciB7CiAgICAgICAgcHViKGNyYXRlKSBkYjogVGVzdFN0YWdlREIsCiAgICAgICAgY29tbWl0X3RocmVzaG9sZDogdTY0LAogICAgICAgIHBydW5lX21vZGU6IE9wdGlvbjxQcnVuZU1vZGU+LAogICAgfQoKICAgIGltcGwgRGVmYXVsdCBmb3IgSW5kZXhTdG9yYWdlSGlzdG9yeVRlc3RSdW5uZXIgewogICAgICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICAgICAgU2VsZiB7IGRiOiBUZXN0U3RhZ2VEQjo6ZGVmYXVsdCgpLCBjb21taXRfdGhyZXNob2xkOiAxMDAwLCBwcnVuZV9tb2RlOiBOb25lIH0KICAgICAgICB9CiAgICB9CgogICAgaW1wbCBTdGFnZVRlc3RSdW5uZXIgZm9yIEluZGV4U3RvcmFnZUhpc3RvcnlUZXN0UnVubmVyIHsKICAgICAgICB0eXBlIFMgPSBJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2U7CgogICAgICAgIGZuIGRiKCZzZWxmKSAtPiAmVGVzdFN0YWdlREIgewogICAgICAgICAgICAmc2VsZi5kYgogICAgICAgIH0KCiAgICAgICAgZm4gc3RhZ2UoJnNlbGYpIC0+IFNlbGY6OlMgewogICAgICAgICAgICBTZWxmOjpTIHsKICAgICAgICAgICAgICAgIGNvbW1pdF90aHJlc2hvbGQ6IHNlbGYuY29tbWl0X3RocmVzaG9sZCwKICAgICAgICAgICAgICAgIHBydW5lX21vZGU6IHNlbGYucHJ1bmVfbW9kZSwKICAgICAgICAgICAgICAgIGV0bF9jb25maWc6IEV0bENvbmZpZzo6ZGVmYXVsdCgpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGltcGwgRXhlY3V0ZVN0YWdlVGVzdFJ1bm5lciBmb3IgSW5kZXhTdG9yYWdlSGlzdG9yeVRlc3RSdW5uZXIgewogICAgICAgIHR5cGUgU2VlZCA9ICgpOwoKICAgICAgICBmbiBzZWVkX2V4ZWN1dGlvbigmbXV0IHNlbGYsIGlucHV0OiBFeGVjSW5wdXQpIC0+IFJlc3VsdDxTZWxmOjpTZWVkLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgbGV0IHN0YWdlX3Byb2Nlc3MgPSBpbnB1dC5jaGVja3BvaW50KCkuYmxvY2tfbnVtYmVyOwogICAgICAgICAgICBsZXQgc3RhcnQgPSBzdGFnZV9wcm9jZXNzICsgMTsKICAgICAgICAgICAgbGV0IGVuZCA9IGlucHV0LnRhcmdldCgpOwogICAgICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwoKICAgICAgICAgICAgbGV0IG51bV9vZl9hY2NvdW50cyA9IDMxOwogICAgICAgICAgICBsZXQgYWNjb3VudHMgPSByYW5kb21fY29udHJhY3RfYWNjb3VudF9yYW5nZSgmbXV0IHJuZywgJm11dCAoMC4ubnVtX29mX2FjY291bnRzKSkKICAgICAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAgICAgLmNvbGxlY3Q6OjxCVHJlZU1hcDxfLCBfPj4oKTsKCiAgICAgICAgICAgIGxldCBibG9ja3MgPSByYW5kb21fYmxvY2tfcmFuZ2UoCiAgICAgICAgICAgICAgICAmbXV0IHJuZywKICAgICAgICAgICAgICAgIHN0YXJ0Li49ZW5kLAogICAgICAgICAgICAgICAgQmxvY2tSYW5nZVBhcmFtcyB7IHBhcmVudDogU29tZShCMjU2OjpaRVJPKSwgdHhfY291bnQ6IDAuLjMsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBsZXQgKGNoYW5nZXNldHMsIF8pID0gcmFuZG9tX2NoYW5nZXNldF9yYW5nZSgKICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgYmxvY2tzLml0ZXIoKSwKICAgICAgICAgICAgICAgIGFjY291bnRzLmludG9faXRlcigpLm1hcCh8KGFkZHIsIGFjYyl8IChhZGRyLCAoYWNjLCBWZWM6Om5ldygpKSkpLAogICAgICAgICAgICAgICAgMC4uMywKICAgICAgICAgICAgICAgIDAuLnU2NDo6TUFYLAogICAgICAgICAgICApOwoKICAgICAgICAgICAgLy8gYWRkIGJsb2NrIGNoYW5nZXNldCBmcm9tIGJsb2NrIDEuCiAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X2NoYW5nZXNldHMoY2hhbmdlc2V0cywgU29tZShzdGFydCkpPzsKCiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0KCiAgICAgICAgZm4gdmFsaWRhdGVfZXhlY3V0aW9uKAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgaW5wdXQ6IEV4ZWNJbnB1dCwKICAgICAgICAgICAgb3V0cHV0OiBPcHRpb248RXhlY091dHB1dD4sCiAgICAgICAgKSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICBpZiBsZXQgU29tZShvdXRwdXQpID0gb3V0cHV0IHsKICAgICAgICAgICAgICAgIGxldCBzdGFydF9ibG9jayA9IGlucHV0Lm5leHRfYmxvY2soKTsKICAgICAgICAgICAgICAgIGxldCBlbmRfYmxvY2sgPSBvdXRwdXQuY2hlY2twb2ludC5ibG9ja19udW1iZXI7CiAgICAgICAgICAgICAgICBpZiBzdGFydF9ibG9jayA+IGVuZF9ibG9jayB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9rKCgpKQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0LAogICAgICAgICAgICAgICAgICAgIEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhpbnB1dC50YXJnZXQoKSksIGRvbmU6IHRydWUgfQogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBsZXQgcHJvdmlkZXIgPSBzZWxmLmRiLmZhY3RvcnkucHJvdmlkZXIoKT87CiAgICAgICAgICAgICAgICBsZXQgbXV0IGNoYW5nZXNldF9jdXJzb3IgPQogICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmN1cnNvcl9yZWFkOjo8dGFibGVzOjpTdG9yYWdlQ2hhbmdlU2V0cz4oKT87CgogICAgICAgICAgICAgICAgbGV0IHN0b3JhZ2VfdHJhbnNpdGlvbnMgPSBjaGFuZ2VzZXRfY3Vyc29yCiAgICAgICAgICAgICAgICAgICAgLndhbGtfcmFuZ2UoQmxvY2tOdW1iZXJBZGRyZXNzOjpyYW5nZShzdGFydF9ibG9jay4uPWVuZF9ibG9jaykpPwogICAgICAgICAgICAgICAgICAgIC50cnlfZm9sZCgKICAgICAgICAgICAgICAgICAgICAgICAgQlRyZWVNYXA6Om5ldygpLAogICAgICAgICAgICAgICAgICAgICAgICB8bXV0IHN0b3JhZ2VzOiBCVHJlZU1hcDwoQWRkcmVzcywgQjI1NiksIFZlYzx1NjQ+PiwKICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5fAogICAgICAgICAgICAgICAgICAgICAgICAgLT4gUmVzdWx0PF8sIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IChpbmRleCwgc3RvcmFnZSkgPSBlbnRyeT87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9yYWdlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5lbnRyeSgoaW5kZXguYWRkcmVzcygpLCBzdG9yYWdlLmtleSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm9yX2RlZmF1bHQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5wdXNoKGluZGV4LmJsb2NrX251bWJlcigpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9rKHN0b3JhZ2VzKQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICk/OwoKICAgICAgICAgICAgICAgIGxldCBtdXQgcmVzdWx0ID0gQlRyZWVNYXA6Om5ldygpOwogICAgICAgICAgICAgICAgZm9yIChwYXJ0aWFsX2tleSwgaW5kaWNlcykgaW4gc3RvcmFnZV90cmFuc2l0aW9ucyB7CiAgICAgICAgICAgICAgICAgICAgLy8gY2h1bmsgaW5kaWNlcyBhbmQgaW5zZXJ0IHRoZW0gaW4gc2hhcmRzIG9mIE4gc2l6ZS4KICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IGNodW5rcyA9IGluZGljZXMKICAgICAgICAgICAgICAgICAgICAgICAgLml0ZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAuY2h1bmtzKHNoYXJkZWRfa2V5OjpOVU1fT0ZfSU5ESUNFU19JTl9TSEFSRCkKICAgICAgICAgICAgICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAofGNodW5rc3wgY2h1bmtzLmNvcGllZCgpLmNvbGxlY3Q6OjxWZWM8dTY0Pj4oKSkKICAgICAgICAgICAgICAgICAgICAgICAgLmNvbGxlY3Q6OjxWZWM8VmVjPF8+Pj4oKTsKICAgICAgICAgICAgICAgICAgICBsZXQgbGFzdF9jaHVuayA9IGNodW5rcy5wb3AoKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIGxpc3QgaW4gY2h1bmtzIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmluc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0b3JhZ2VTaGFyZGVkS2V5OjpuZXcoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbF9rZXkuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0aWFsX2tleS4xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICpsaXN0Lmxhc3QoKS5leHBlY3QoIkNodWNrIGRvZXMgbm90IHJldHVybiBlbXB0eSBsaXN0IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXMgQmxvY2tOdW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdCwKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKGxhc3RfbGlzdCkgPSBsYXN0X2NodW5rIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmluc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0b3JhZ2VTaGFyZGVkS2V5OjpuZXcocGFydGlhbF9rZXkuMCwgcGFydGlhbF9rZXkuMSwgdTY0OjpNQVgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9saXN0LAogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGV0IHRhYmxlID0gY2FzdChzZWxmLmRiLnRhYmxlOjo8dGFibGVzOjpTdG9yYWdlc0hpc3Rvcnk+KCkudW53cmFwKCkpOwogICAgICAgICAgICAgICAgYXNzZXJ0X2VxISh0YWJsZSwgcmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBPaygoKSkKICAgICAgICB9CiAgICB9CgogICAgaW1wbCBVbndpbmRTdGFnZVRlc3RSdW5uZXIgZm9yIEluZGV4U3RvcmFnZUhpc3RvcnlUZXN0UnVubmVyIHsKICAgICAgICBmbiB2YWxpZGF0ZV91bndpbmQoJnNlbGYsIF9pbnB1dDogVW53aW5kSW5wdXQpIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgIGxldCB0YWJsZSA9IHNlbGYuZGIudGFibGU6Ojx0YWJsZXM6OlN0b3JhZ2VzSGlzdG9yeT4oKS51bndyYXAoKTsKICAgICAgICAgICAgYXNzZXJ0ISh0YWJsZS5pc19lbXB0eSgpKTsKICAgICAgICAgICAgT2soKCkpCiAgICAgICAgfQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvc3RhZ2VzL3NyYy9zdGFnZXMvbWVya2xlX2NoYW5nZXNldHMucnMiPgp1c2UgY3JhdGU6OnN0YWdlczo6bWVya2xlOjpJTlZBTElEX1NUQVRFX1JPT1RfRVJST1JfTUVTU0FHRTsKdXNlIGFsbG95X2NvbnNlbnN1czo6QmxvY2tIZWFkZXI7CnVzZSBhbGxveV9wcmltaXRpdmVzOjpCbG9ja051bWJlcjsKdXNlIHJldGhfY29uc2Vuc3VzOjpDb25zZW5zdXNFcnJvcjsKdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OntHb3RFeHBlY3RlZCwgU2VhbGVkSGVhZGVyfTsKdXNlIHJldGhfcHJvdmlkZXI6OnsKICAgIEJsb2NrTnVtUmVhZGVyLCBDaGFpblN0YXRlQmxvY2tSZWFkZXIsIENoYW5nZVNldFJlYWRlciwgREJQcm92aWRlciwgSGVhZGVyUHJvdmlkZXIsCiAgICBQcm92aWRlckVycm9yLCBQcnVuZUNoZWNrcG9pbnRSZWFkZXIsIFBydW5lQ2hlY2twb2ludFdyaXRlciwgU3RhZ2VDaGVja3BvaW50UmVhZGVyLAogICAgU3RhZ2VDaGVja3BvaW50V3JpdGVyLCBUcmllV3JpdGVyLAp9Owp1c2UgcmV0aF9wcnVuZV90eXBlczo6ewogICAgUHJ1bmVDaGVja3BvaW50LCBQcnVuZU1vZGUsIFBydW5lU2VnbWVudCwgTUVSS0xFX0NIQU5HRVNFVFNfUkVURU5USU9OX0JMT0NLUywKfTsKdXNlIHJldGhfc3RhZ2VzX2FwaTo6ewogICAgQmxvY2tFcnJvcktpbmQsIEV4ZWNJbnB1dCwgRXhlY091dHB1dCwgU3RhZ2UsIFN0YWdlQ2hlY2twb2ludCwgU3RhZ2VFcnJvciwgU3RhZ2VJZCwKICAgIFVud2luZElucHV0LCBVbndpbmRPdXRwdXQsCn07CnVzZSByZXRoX3RyaWU6OnsKICAgIHVwZGF0ZXM6OlRyaWVVcGRhdGVzLCBIYXNoZWRQb3N0U3RhdGVTb3J0ZWQsIEtlY2Nha0tleUhhc2hlciwgU3RhdGVSb290LCBUcmllSW5wdXRTb3J0ZWQsCn07CnVzZSByZXRoX3RyaWVfZGI6OntEYXRhYmFzZUhhc2hlZFBvc3RTdGF0ZSwgRGF0YWJhc2VTdGF0ZVJvb3R9Owp1c2Ugc3RkOjp7b3BzOjpSYW5nZSwgc3luYzo6QXJjfTsKdXNlIHRyYWNpbmc6OntkZWJ1ZywgZXJyb3J9OwoKLy8vIFRoZSBgTWVya2xlQ2hhbmdlU2V0c2Agc3RhZ2UuCi8vLwovLy8gVGhpcyBzdGFnZSBwcm9jZXNzZXMgYW5kIG1haW50YWlucyB0cmllIGNoYW5nZXNldHMgZnJvbSB0aGUgZmluYWxpemVkIGJsb2NrIHRvIHRoZSBsYXRlc3QgYmxvY2suCiNbZGVyaXZlKERlYnVnLCBDbG9uZSldCnB1YiBzdHJ1Y3QgTWVya2xlQ2hhbmdlU2V0cyB7CiAgICAvLy8gVGhlIG51bWJlciBvZiBibG9ja3MgdG8gcmV0YWluIGNoYW5nZXNldHMgZm9yLCB1c2VkIGFzIGEgZmFsbGJhY2sgd2hlbiB0aGUgZmluYWxpemVkIGJsb2NrCiAgICAvLy8gaXMgbm90IGZvdW5kLiBEZWZhdWx0cyB0byBbYE1FUktMRV9DSEFOR0VTRVRTX1JFVEVOVElPTl9CTE9DS1NgXSAoMiBlcG9jaHMgaW4gYmVhY29uCiAgICAvLy8gY2hhaW4pLgogICAgcmV0ZW50aW9uX2Jsb2NrczogdTY0LAp9CgppbXBsIE1lcmtsZUNoYW5nZVNldHMgewogICAgLy8vIENyZWF0ZXMgYSBuZXcgYE1lcmtsZUNoYW5nZVNldHNgIHN0YWdlIHdpdGggdGhlIGRlZmF1bHQgcmV0ZW50aW9uIGJsb2Nrcy4KICAgIHB1YiBjb25zdCBmbiBuZXcoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgcmV0ZW50aW9uX2Jsb2NrczogTUVSS0xFX0NIQU5HRVNFVFNfUkVURU5USU9OX0JMT0NLUyB9CiAgICB9CgogICAgLy8vIENyZWF0ZXMgYSBuZXcgYE1lcmtsZUNoYW5nZVNldHNgIHN0YWdlIHdpdGggYSBjdXN0b20gZmluYWxpemVkIGJsb2NrIGhlaWdodC4KICAgIHB1YiBjb25zdCBmbiB3aXRoX3JldGVudGlvbl9ibG9ja3MocmV0ZW50aW9uX2Jsb2NrczogdTY0KSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgcmV0ZW50aW9uX2Jsb2NrcyB9CiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIHJhbmdlIG9mIGJsb2NrcyB3aGljaCBhcmUgYWxyZWFkeSBjb21wdXRlZC4gV2lsbCByZXR1cm4gYW4gZW1wdHkgcmFuZ2UgaWYgbm9uZQogICAgLy8vIGhhdmUgYmVlbiBjb21wdXRlZC4KICAgIGZuIGNvbXB1dGVkX3JhbmdlPFByb3ZpZGVyPigKICAgICAgICBwcm92aWRlcjogJlByb3ZpZGVyLAogICAgICAgIGNoZWNrcG9pbnQ6IE9wdGlvbjxTdGFnZUNoZWNrcG9pbnQ+LAogICAgKSAtPiBSZXN1bHQ8UmFuZ2U8QmxvY2tOdW1iZXI+LCBTdGFnZUVycm9yPgogICAgd2hlcmUKICAgICAgICBQcm92aWRlcjogUHJ1bmVDaGVja3BvaW50UmVhZGVyLAogICAgewogICAgICAgIGxldCB0byA9IGNoZWNrcG9pbnQubWFwKHxjaGt8IGNoay5ibG9ja19udW1iZXIpLnVud3JhcF9vcl9kZWZhdWx0KCk7CgogICAgICAgIC8vIEdldCB0aGUgcHJ1bmUgY2hlY2twb2ludCBmb3IgTWVya2xlQ2hhbmdlU2V0cyB0byB1c2UgYXMgdGhlIGxvd2VyIGJvdW5kLiBJZiB0aGVyZSdzIG5vCiAgICAgICAgLy8gcHJ1bmUgY2hlY2twb2ludCBvciBpZiB0aGUgcHJ1bmVkIGJsb2NrIG51bWJlciBpcyBOb25lLCByZXR1cm4gZW1wdHkgcmFuZ2UKICAgICAgICBsZXQgU29tZShmcm9tKSA9IHByb3ZpZGVyCiAgICAgICAgICAgIC5nZXRfcHJ1bmVfY2hlY2twb2ludChQcnVuZVNlZ21lbnQ6Ok1lcmtsZUNoYW5nZVNldHMpPwogICAgICAgICAgICAuYW5kX3RoZW4ofGNoa3wgY2hrLmJsb2NrX251bWJlcikKICAgICAgICAgICAgLy8gcHJ1bmUgY2hlY2twb2ludCBpbmRpY2F0ZXMgdGhlIGxhc3QgYmxvY2sgcHJ1bmVkLCBzbyB0aGUgYmxvY2sgYWZ0ZXIgaXMgdGhlIHN0YXJ0IG9mCiAgICAgICAgICAgIC8vIHRoZSBjb21wdXRlZCBkYXRhCiAgICAgICAgICAgIC5tYXAofGJsb2NrX251bWJlcnwgYmxvY2tfbnVtYmVyICsgMSkKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIE9rKDAuLjApCiAgICAgICAgfTsKCiAgICAgICAgT2soZnJvbS4udG8gKyAxKQogICAgfQoKICAgIC8vLyBEZXRlcm1pbmVzIHRoZSB0YXJnZXQgcmFuZ2UgZm9yIGNoYW5nZXNldCBjb21wdXRhdGlvbiBiYXNlZCBvbiB0aGUgY2hlY2twb2ludCBhbmQgcHJvdmlkZXIKICAgIC8vLyBzdGF0ZS4KICAgIC8vLwogICAgLy8vIFJldHVybnMgdGhlIHRhcmdldCByYW5nZSAoZXhjbHVzaXZlIGVuZCkgdG8gY29tcHV0ZSBjaGFuZ2VzZXRzIGZvci4KICAgIGZuIGRldGVybWluZV90YXJnZXRfcmFuZ2U8UHJvdmlkZXI+KAogICAgICAgICZzZWxmLAogICAgICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICApIC0+IFJlc3VsdDxSYW5nZTxCbG9ja051bWJlcj4sIFN0YWdlRXJyb3I+CiAgICB3aGVyZQogICAgICAgIFByb3ZpZGVyOiBTdGFnZUNoZWNrcG9pbnRSZWFkZXIgKyBDaGFpblN0YXRlQmxvY2tSZWFkZXIsCiAgICB7CiAgICAgICAgLy8gR2V0IG1lcmtsZSBjaGVja3BvaW50IHdoaWNoIHJlcHJlc2VudHMgb3VyIHRhcmdldCBlbmQgYmxvY2sKICAgICAgICBsZXQgbWVya2xlX2NoZWNrcG9pbnQgPSBwcm92aWRlcgogICAgICAgICAgICAuZ2V0X3N0YWdlX2NoZWNrcG9pbnQoU3RhZ2VJZDo6TWVya2xlRXhlY3V0ZSk/CiAgICAgICAgICAgIC5tYXAofGNoZWNrcG9pbnR8IGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyKQogICAgICAgICAgICAudW53cmFwX29yKDApOwoKICAgICAgICBsZXQgdGFyZ2V0X2VuZCA9IG1lcmtsZV9jaGVja3BvaW50ICsgMTsgLy8gZXhjbHVzaXZlCgogICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgdGFyZ2V0IHJhbmdlIGJhc2VkIG9uIHRoZSBmaW5hbGl6ZWQgYmxvY2sgYW5kIHRoZSB0YXJnZXQgYmxvY2suCiAgICAgICAgLy8gV2UgbWFpbnRhaW4gY2hhbmdlc2V0cyBmcm9tIHRoZSBmaW5hbGl6ZWQgYmxvY2sgdG8gdGhlIGxhdGVzdCBibG9jay4KICAgICAgICBsZXQgZmluYWxpemVkX2Jsb2NrID0gcHJvdmlkZXIubGFzdF9maW5hbGl6ZWRfYmxvY2tfbnVtYmVyKCk/OwoKICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIGZhbGxiYWNrIHN0YXJ0IHBvc2l0aW9uIGJhc2VkIG9uIHJldGVudGlvbiBibG9ja3MKICAgICAgICBsZXQgcmV0ZW50aW9uX2Jhc2VkX3N0YXJ0ID0gbWVya2xlX2NoZWNrcG9pbnQuc2F0dXJhdGluZ19zdWIoc2VsZi5yZXRlbnRpb25fYmxvY2tzKTsKCiAgICAgICAgLy8gSWYgdGhlIGZpbmFsaXplZCBibG9jayB3YXMgd2F5IGluIHRoZSBwYXN0IHRoZW4gd2UgZG9uJ3Qgd2FudCB0byBnZW5lcmF0ZSBjaGFuZ2VzZXRzIGZvcgogICAgICAgIC8vIGFsbCBvZiB0aG9zZSBwYXN0IGJsb2Nrczsgd2Ugb25seSBjYXJlIGFib3V0IHRoZSByZWNlbnQgaGlzdG9yeS4KICAgICAgICAvLwogICAgICAgIC8vIFVzZSBtYXhpbXVtIG9mIGZpbmFsaXplZF9ibG9jayBhbmQgcmV0ZW50aW9uX2Jhc2VkX3N0YXJ0IGlmIGZpbmFsaXplZF9ibG9jayBleGlzdHMsCiAgICAgICAgLy8gb3RoZXJ3aXNlIGp1c3QgdXNlIHJldGVudGlvbl9iYXNlZF9zdGFydC4KICAgICAgICBsZXQgbXV0IHRhcmdldF9zdGFydCA9IGZpbmFsaXplZF9ibG9jawogICAgICAgICAgICAubWFwKHxmaW5hbGl6ZWR8IGZpbmFsaXplZC5zYXR1cmF0aW5nX2FkZCgxKS5tYXgocmV0ZW50aW9uX2Jhc2VkX3N0YXJ0KSkKICAgICAgICAgICAgLnVud3JhcF9vcihyZXRlbnRpb25fYmFzZWRfc3RhcnQpOwoKICAgICAgICAvLyBXZSBjYW5ub3QgcmV2ZXJ0IHRoZSBnZW5lc2lzIGJsb2NrOyB0YXJnZXRfc3RhcnQgbXVzdCBiZSA+MAogICAgICAgIHRhcmdldF9zdGFydCA9IHRhcmdldF9zdGFydC5tYXgoMSk7CgogICAgICAgIE9rKHRhcmdldF9zdGFydC4udGFyZ2V0X2VuZCkKICAgIH0KCiAgICAvLy8gQ2FsY3VsYXRlcyB0aGUgdHJpZSB1cGRhdGVzIGdpdmVuIGEgW2BUcmllSW5wdXRTb3J0ZWRgXSwgYXNzZXJ0aW5nIHRoYXQgdGhlIHJlc3VsdGluZyBzdGF0ZQogICAgLy8vIHJvb3QgbWF0Y2hlcyB0aGUgZXhwZWN0ZWQgb25lIGZvciB0aGUgYmxvY2suCiAgICBmbiBjYWxjdWxhdGVfYmxvY2tfdHJpZV91cGRhdGVzPFByb3ZpZGVyOiBEQlByb3ZpZGVyICsgSGVhZGVyUHJvdmlkZXI+KAogICAgICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICAgICAgYmxvY2tfbnVtYmVyOiBCbG9ja051bWJlciwKICAgICAgICBpbnB1dDogVHJpZUlucHV0U29ydGVkLAogICAgKSAtPiBSZXN1bHQ8VHJpZVVwZGF0ZXMsIFN0YWdlRXJyb3I+IHsKICAgICAgICBsZXQgKHJvb3QsIHRyaWVfdXBkYXRlcykgPQogICAgICAgICAgICBTdGF0ZVJvb3Q6Om92ZXJsYXlfcm9vdF9mcm9tX25vZGVzX3dpdGhfdXBkYXRlcyhwcm92aWRlci50eF9yZWYoKSwgaW5wdXQpLm1hcF9lcnIoCiAgICAgICAgICAgICAgICB8ZXwgewogICAgICAgICAgICAgICAgICAgIGVycm9yISgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnN0YWdlczo6bWVya2xlX2NoYW5nZXNldHMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/YmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIkluY3JlbWVudGFsIHN0YXRlIHJvb3QgZmFpbGVkISB7SU5WQUxJRF9TVEFURV9ST09UX0VSUk9SX01FU1NBR0V9Iik7CiAgICAgICAgICAgICAgICAgICAgU3RhZ2VFcnJvcjo6RmF0YWwoQm94OjpuZXcoZSkpCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICApPzsKCiAgICAgICAgbGV0IGJsb2NrID0gcHJvdmlkZXIKICAgICAgICAgICAgLmhlYWRlcl9ieV9udW1iZXIoYmxvY2tfbnVtYmVyKT8KICAgICAgICAgICAgLm9rX29yX2Vsc2UofHwgUHJvdmlkZXJFcnJvcjo6SGVhZGVyTm90Rm91bmQoYmxvY2tfbnVtYmVyLmludG8oKSkpPzsKCiAgICAgICAgbGV0IChnb3QsIGV4cGVjdGVkKSA9IChyb290LCBibG9jay5zdGF0ZV9yb290KCkpOwogICAgICAgIGlmIGdvdCAhPSBleHBlY3RlZCB7CiAgICAgICAgICAgIC8vIE9ubHkgc2VhbCB0aGUgaGVhZGVyIHdoZW4gd2UgbmVlZCBpdCBmb3IgdGhlIGVycm9yCiAgICAgICAgICAgIGxldCBoZWFkZXIgPSBTZWFsZWRIZWFkZXI6OnNlYWxfc2xvdyhibG9jayk7CiAgICAgICAgICAgIGVycm9yISgKICAgICAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnN0YWdlczo6bWVya2xlX2NoYW5nZXNldHMiLAogICAgICAgICAgICAgICAgP2Jsb2NrX251bWJlciwKICAgICAgICAgICAgICAgID9nb3QsCiAgICAgICAgICAgICAgICA/ZXhwZWN0ZWQsCiAgICAgICAgICAgICAgICAiRmFpbGVkIHRvIHZlcmlmeSBibG9jayBzdGF0ZSByb290ISB7SU5WQUxJRF9TVEFURV9ST09UX0VSUk9SX01FU1NBR0V9IiwKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmV0dXJuIEVycihTdGFnZUVycm9yOjpCbG9jayB7CiAgICAgICAgICAgICAgICBlcnJvcjogQmxvY2tFcnJvcktpbmQ6OlZhbGlkYXRpb24oQ29uc2Vuc3VzRXJyb3I6OkJvZHlTdGF0ZVJvb3REaWZmKAogICAgICAgICAgICAgICAgICAgIEdvdEV4cGVjdGVkIHsgZ290LCBleHBlY3RlZCB9LmludG8oKSwKICAgICAgICAgICAgICAgICkpLAogICAgICAgICAgICAgICAgYmxvY2s6IEJveDo6bmV3KGhlYWRlci5ibG9ja193aXRoX3BhcmVudCgpKSwKICAgICAgICAgICAgfSkKICAgICAgICB9CgogICAgICAgIE9rKHRyaWVfdXBkYXRlcykKICAgIH0KCiAgICBmbiBwb3B1bGF0ZV9yYW5nZTxQcm92aWRlcj4oCiAgICAgICAgcHJvdmlkZXI6ICZQcm92aWRlciwKICAgICAgICB0YXJnZXRfcmFuZ2U6IFJhbmdlPEJsb2NrTnVtYmVyPiwKICAgICkgLT4gUmVzdWx0PCgpLCBTdGFnZUVycm9yPgogICAgd2hlcmUKICAgICAgICBQcm92aWRlcjogU3RhZ2VDaGVja3BvaW50UmVhZGVyCiAgICAgICAgICAgICsgVHJpZVdyaXRlcgogICAgICAgICAgICArIERCUHJvdmlkZXIKICAgICAgICAgICAgKyBIZWFkZXJQcm92aWRlcgogICAgICAgICAgICArIENoYWluU3RhdGVCbG9ja1JlYWRlcgogICAgICAgICAgICArIEJsb2NrTnVtUmVhZGVyCiAgICAgICAgICAgICsgQ2hhbmdlU2V0UmVhZGVyLAogICAgewogICAgICAgIGxldCB0YXJnZXRfc3RhcnQgPSB0YXJnZXRfcmFuZ2Uuc3RhcnQ7CiAgICAgICAgbGV0IHRhcmdldF9lbmQgPSB0YXJnZXRfcmFuZ2UuZW5kOwogICAgICAgIGRlYnVnISgKICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6c3RhZ2VzOjptZXJrbGVfY2hhbmdlc2V0cyIsCiAgICAgICAgICAgID90YXJnZXRfcmFuZ2UsCiAgICAgICAgICAgICJTdGFydGluZyB0cmllIGNoYW5nZXNldCBjb21wdXRhdGlvbiIsCiAgICAgICAgKTsKCiAgICAgICAgLy8gV2UgbmVlZCB0byBkaXN0aW5ndWlzaCBhIGN1bXVsYXRpdmUgcmV2ZXJ0IGFuZCBhIHBlci1ibG9jayByZXZlcnQuIEEgY3VtdWxhdGl2ZSByZXZlcnQKICAgICAgICAvLyByZXZlcnRzIGNoYW5nZXMgc3RhcnRpbmcgYXQgZGIgdGlwIGFsbCB0aGUgd2F5IHRvIGEgYmxvY2suIEEgcGVyLWJsb2NrIHJldmVydCBvbmx5CiAgICAgICAgLy8gcmV2ZXJ0cyBhIGJsb2NrJ3MgY2hhbmdlcy4KICAgICAgICAvLwogICAgICAgIC8vIFdlIG5lZWQgdG8gY2FsY3VsYXRlIHRoZSBjdW11bGF0aXZlIEhhc2hlZFBvc3RTdGF0ZSByZXZlcnRzIGZvciBldmVyeSBibG9jayBpbiB0aGUKICAgICAgICAvLyB0YXJnZXQgcmFuZ2UuIFRoZSBjdW11bGF0aXZlIEhhc2hlZFBvc3RTdGF0ZSByZXZlcnQgZm9yIGJsb2NrIE4gY2FuIGJlIGNhbGN1bGF0ZWQgYXM6CiAgICAgICAgLy8KICAgICAgICAvLwogICAgICAgIC8vIGBgYAogICAgICAgIC8vIC8vIHdoZXJlIGBleHRlbmRgIG92ZXJ3cml0ZXMgYW55IHNoYXJlZCBrZXlzCiAgICAgICAgLy8gY3VtdWxhdGl2ZV9zdGF0ZV9yZXZlcnQoTikgPSBjdW11bGF0aXZlX3N0YXRlX3JldmVydChOICsgMSkuZXh0ZW5kKGdldF9ibG9ja19zdGF0ZV9yZXZlcnQoTikpCiAgICAgICAgLy8gYGBgCiAgICAgICAgLy8KICAgICAgICAvLyBXZSBuZWVkIHBlci1ibG9jayByZXZlcnRzIHRvIGNhbGN1bGF0ZSB0aGUgcHJlZml4IHNldCBmb3IgZWFjaCBpbmRpdmlkdWFsIGJsb2NrLiBCeQogICAgICAgIC8vIHVzaW5nIHRoZSBwZXItYmxvY2sgcmV2ZXJ0cyB0byBjYWxjdWxhdGUgY3VtdWxhdGl2ZSByZXZlcnRzIG9uLXRoZS1mbHkgd2UgY2FuIHNhdmUgYQogICAgICAgIC8vIGJ1bmNoIG9mIG1lbW9yeS4KICAgICAgICBkZWJ1ZyEoCiAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnN0YWdlczo6bWVya2xlX2NoYW5nZXNldHMiLAogICAgICAgICAgICA/dGFyZ2V0X3JhbmdlLAogICAgICAgICAgICAiQ29tcHV0aW5nIHBlci1ibG9jayBzdGF0ZSByZXZlcnRzIiwKICAgICAgICApOwogICAgICAgIGxldCByYW5nZV9sZW4gPSB0YXJnZXRfZW5kIC0gdGFyZ2V0X3N0YXJ0OwogICAgICAgIGxldCBtdXQgcGVyX2Jsb2NrX3N0YXRlX3JldmVydHMgPSBWZWM6OndpdGhfY2FwYWNpdHkocmFuZ2VfbGVuIGFzIHVzaXplKTsKICAgICAgICBmb3IgYmxvY2tfbnVtYmVyIGluIHRhcmdldF9yYW5nZS5jbG9uZSgpIHsKICAgICAgICAgICAgcGVyX2Jsb2NrX3N0YXRlX3JldmVydHMucHVzaChIYXNoZWRQb3N0U3RhdGVTb3J0ZWQ6OmZyb21fcmV2ZXJ0czo6PEtlY2Nha0tleUhhc2hlcj4oCiAgICAgICAgICAgICAgICBwcm92aWRlciwKICAgICAgICAgICAgICAgIGJsb2NrX251bWJlci4uPWJsb2NrX251bWJlciwKICAgICAgICAgICAgKT8pOwogICAgICAgIH0KCiAgICAgICAgLy8gSGVscGVyIHRvIHJldHJpZXZlIHN0YXRlIHJldmVydCBkYXRhIGZvciBhIHNwZWNpZmljIGJsb2NrIGZyb20gdGhlIHByZS1jb21wdXRlZCBhcnJheQogICAgICAgIGxldCBnZXRfYmxvY2tfc3RhdGVfcmV2ZXJ0ID0gfGJsb2NrX251bWJlcjogQmxvY2tOdW1iZXJ8IC0+ICZIYXNoZWRQb3N0U3RhdGVTb3J0ZWQgewogICAgICAgICAgICBsZXQgaW5kZXggPSAoYmxvY2tfbnVtYmVyIC0gdGFyZ2V0X3N0YXJ0KSBhcyB1c2l6ZTsKICAgICAgICAgICAgJnBlcl9ibG9ja19zdGF0ZV9yZXZlcnRzW2luZGV4XQogICAgICAgIH07CgogICAgICAgIC8vIEhlbHBlciB0byBhY2N1bXVsYXRlIHN0YXRlIHJldmVydHMgZnJvbSBhIGdpdmVuIGJsb2NrIHRvIHRoZSB0YXJnZXQgZW5kCiAgICAgICAgbGV0IGNvbXB1dGVfY3VtdWxhdGl2ZV9zdGF0ZV9yZXZlcnQgPSB8YmxvY2tfbnVtYmVyOiBCbG9ja051bWJlcnwgLT4gSGFzaGVkUG9zdFN0YXRlU29ydGVkIHsKICAgICAgICAgICAgbGV0IG11dCBjdW11bGF0aXZlX3JldmVydCA9IEhhc2hlZFBvc3RTdGF0ZVNvcnRlZDo6ZGVmYXVsdCgpOwogICAgICAgICAgICBmb3IgbiBpbiAoYmxvY2tfbnVtYmVyLi50YXJnZXRfZW5kKS5yZXYoKSB7CiAgICAgICAgICAgICAgICBjdW11bGF0aXZlX3JldmVydC5leHRlbmRfcmVmKGdldF9ibG9ja19zdGF0ZV9yZXZlcnQobikpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VtdWxhdGl2ZV9yZXZlcnQKICAgICAgICB9OwoKICAgICAgICAvLyBUbyBjYWxjdWxhdGUgdGhlIGNoYW5nZXNldCBmb3IgYSBibG9jaywgd2UgZmlyc3QgbmVlZCB0aGUgVHJpZVVwZGF0ZXMgd2hpY2ggYXJlCiAgICAgICAgLy8gZ2VuZXJhdGVkIGFzIGEgcmVzdWx0IG9mIHByb2Nlc3NpbmcgdGhlIGJsb2NrLiBUbyBnZXQgdGhlc2Ugd2UgbmVlZDoKICAgICAgICAvLyAxKSBUaGUgVHJpZVVwZGF0ZXMgd2hpY2ggcmV2ZXJ0IHRoZSBkYidzIHRyaWUgdG8gX3ByaW9yXyB0byB0aGUgYmxvY2sKICAgICAgICAvLyAyKSBUaGUgSGFzaGVkUG9zdFN0YXRlU29ydGVkIHRvIHJldmVydCB0aGUgZGIncyBzdGF0ZSB0byBfYWZ0ZXJfIHRoZSBibG9jawogICAgICAgIC8vCiAgICAgICAgLy8gVG8gZ2V0ICgxKSBmb3IgYHRhcmdldF9zdGFydGAgd2UgbmVlZCB0byBkbyBhIGJpZyBzdGF0ZSByb290IGNhbGN1bGF0aW9uIHdoaWNoIHRha2VzCiAgICAgICAgLy8gaW50byBhY2NvdW50IGFsbCBjaGFuZ2VzIGJldHdlZW4gdGhhdCBibG9jayBhbmQgZGIgdGlwLiBGb3IgZWFjaCBibG9jayBhZnRlciB0aGUKICAgICAgICAvLyBgdGFyZ2V0X3N0YXJ0YCB3ZSBjYW4gdXBkYXRlICgxKSB1c2luZyB0aGUgVHJpZVVwZGF0ZXMgd2hpY2ggd2VyZSBvdXRwdXQgYnkgdGhlIHByZXZpb3VzCiAgICAgICAgLy8gYmxvY2ssIG9ubHkgdGFyZ2V0aW5nIHRoZSBzdGF0ZSBjaGFuZ2VzIG9mIHRoYXQgYmxvY2suCiAgICAgICAgZGVidWchKAogICAgICAgICAgICB0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6Om1lcmtsZV9jaGFuZ2VzZXRzIiwKICAgICAgICAgICAgP3RhcmdldF9zdGFydCwKICAgICAgICAgICAgIkNvbXB1dGluZyB0cmllIHN0YXRlIGF0IHN0YXJ0aW5nIGJsb2NrIiwKICAgICAgICApOwogICAgICAgIGxldCBpbml0aWFsX3N0YXRlID0gY29tcHV0ZV9jdW11bGF0aXZlX3N0YXRlX3JldmVydCh0YXJnZXRfc3RhcnQpOwogICAgICAgIGxldCBpbml0aWFsX3ByZWZpeF9zZXRzID0gaW5pdGlhbF9zdGF0ZS5jb25zdHJ1Y3RfcHJlZml4X3NldHMoKTsKICAgICAgICBsZXQgaW5pdGlhbF9pbnB1dCA9CiAgICAgICAgICAgIFRyaWVJbnB1dFNvcnRlZDo6bmV3KEFyYzo6ZGVmYXVsdCgpLCBBcmM6Om5ldyhpbml0aWFsX3N0YXRlKSwgaW5pdGlhbF9wcmVmaXhfc2V0cyk7CiAgICAgICAgLy8gdGFyZ2V0X3N0YXJ0IHdpbGwgYmUgPj0gMSwgc2VlIGBkZXRlcm1pbmVfdGFyZ2V0X3JhbmdlYC4KICAgICAgICBsZXQgbXV0IG5vZGVzID0gQXJjOjpuZXcoCiAgICAgICAgICAgIFNlbGY6OmNhbGN1bGF0ZV9ibG9ja190cmllX3VwZGF0ZXMocHJvdmlkZXIsIHRhcmdldF9zdGFydCAtIDEsIGluaXRpYWxfaW5wdXQpPwogICAgICAgICAgICAgICAgLmludG9fc29ydGVkKCksCiAgICAgICAgKTsKCiAgICAgICAgZm9yIGJsb2NrX251bWJlciBpbiB0YXJnZXRfcmFuZ2UgewogICAgICAgICAgICBkZWJ1ZyEoCiAgICAgICAgICAgICAgICB0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6Om1lcmtsZV9jaGFuZ2VzZXRzIiwKICAgICAgICAgICAgICAgID9ibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAiQ29tcHV0aW5nIHRyaWUgdXBkYXRlcyBmb3IgYmxvY2siLAogICAgICAgICAgICApOwogICAgICAgICAgICAvLyBSZXZlcnQgdGhlIHN0YXRlIHNvIHRoYXQgdGhpcyBibG9jayBoYXMgYmVlbiBqdXN0IHByb2Nlc3NlZCwgbWVhbmluZyB3ZSB0YWtlIHRoZQogICAgICAgICAgICAvLyBjdW11bGF0aXZlIHJldmVydCBvZiB0aGUgc3Vic2VxdWVudCBibG9jay4KICAgICAgICAgICAgbGV0IHN0YXRlID0gQXJjOjpuZXcoY29tcHV0ZV9jdW11bGF0aXZlX3N0YXRlX3JldmVydChibG9ja19udW1iZXIgKyAxKSk7CgogICAgICAgICAgICAvLyBDb25zdHJ1Y3QgcHJlZml4IHNldHMgZnJvbSBvbmx5IHRoaXMgYmxvY2sncyBgSGFzaGVkUG9zdFN0YXRlU29ydGVkYCwgYmVjYXVzZSB3ZSBvbmx5CiAgICAgICAgICAgIC8vIGNhcmUgYWJvdXQgdHJpZSB1cGRhdGVzIHdoaWNoIG9jY3VycmVkIGFzIGEgcmVzdWx0IG9mIHRoaXMgYmxvY2sgYmVpbmcgcHJvY2Vzc2VkLgogICAgICAgICAgICBsZXQgcHJlZml4X3NldHMgPSBnZXRfYmxvY2tfc3RhdGVfcmV2ZXJ0KGJsb2NrX251bWJlcikuY29uc3RydWN0X3ByZWZpeF9zZXRzKCk7CgogICAgICAgICAgICBsZXQgaW5wdXQgPSBUcmllSW5wdXRTb3J0ZWQ6Om5ldyhBcmM6OmNsb25lKCZub2RlcyksIHN0YXRlLCBwcmVmaXhfc2V0cyk7CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIHRyaWUgdXBkYXRlcyBmb3IgdGhpcyBibG9jaywgdGhlbiBhcHBseSB0aG9zZSB1cGRhdGVzIHRvIHRoZSByZXZlcnRzLgogICAgICAgICAgICAvLyBXZSBjYWxjdWxhdGUgdGhlIG92ZXJsYXkgd2hpY2ggd2lsbCBiZSBwYXNzZWQgaW50byB0aGUgbmV4dCBzdGVwIHVzaW5nIHRoZSB0cmllCiAgICAgICAgICAgIC8vIHJldmVydHMgcHJpb3IgdG8gdGhlbSBiZWluZyB1cGRhdGVkLgogICAgICAgICAgICBsZXQgdGhpc190cmllX3VwZGF0ZXMgPQogICAgICAgICAgICAgICAgU2VsZjo6Y2FsY3VsYXRlX2Jsb2NrX3RyaWVfdXBkYXRlcyhwcm92aWRlciwgYmxvY2tfbnVtYmVyLCBpbnB1dCk/LmludG9fc29ydGVkKCk7CgogICAgICAgICAgICBsZXQgdHJpZV9vdmVybGF5ID0gQXJjOjpjbG9uZSgmbm9kZXMpOwogICAgICAgICAgICBsZXQgbXV0IG5vZGVzX211dCA9IEFyYzo6dW53cmFwX29yX2Nsb25lKG5vZGVzKTsKICAgICAgICAgICAgbm9kZXNfbXV0LmV4dGVuZF9yZWYoJnRoaXNfdHJpZV91cGRhdGVzKTsKICAgICAgICAgICAgbm9kZXMgPSBBcmM6Om5ldyhub2Rlc19tdXQpOwoKICAgICAgICAgICAgLy8gV3JpdGUgdGhlIGNoYW5nZXNldHMgdG8gdGhlIERCIHVzaW5nIHRoZSB0cmllIHVwZGF0ZXMgcHJvZHVjZWQgYnkgdGhlIGJsb2NrLCBhbmQgdGhlCiAgICAgICAgICAgIC8vIHRyaWUgcmV2ZXJ0cyBhcyB0aGUgb3ZlcmxheS4KICAgICAgICAgICAgZGVidWchKAogICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6c3RhZ2VzOjptZXJrbGVfY2hhbmdlc2V0cyIsCiAgICAgICAgICAgICAgICA/YmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgIldyaXRpbmcgdHJpZSBjaGFuZ2VzZXRzIGZvciBibG9jayIsCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHByb3ZpZGVyLndyaXRlX3RyaWVfY2hhbmdlc2V0cygKICAgICAgICAgICAgICAgIGJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgICZ0aGlzX3RyaWVfdXBkYXRlcywKICAgICAgICAgICAgICAgIFNvbWUoJnRyaWVfb3ZlcmxheSksCiAgICAgICAgICAgICk/OwogICAgICAgIH0KCiAgICAgICAgT2soKCkpCiAgICB9Cn0KCmltcGwgRGVmYXVsdCBmb3IgTWVya2xlQ2hhbmdlU2V0cyB7CiAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZjo6bmV3KCkKICAgIH0KfQoKaW1wbDxQcm92aWRlcj4gU3RhZ2U8UHJvdmlkZXI+IGZvciBNZXJrbGVDaGFuZ2VTZXRzCndoZXJlCiAgICBQcm92aWRlcjogU3RhZ2VDaGVja3BvaW50UmVhZGVyCiAgICAgICAgKyBUcmllV3JpdGVyCiAgICAgICAgKyBEQlByb3ZpZGVyCiAgICAgICAgKyBIZWFkZXJQcm92aWRlcgogICAgICAgICsgQ2hhaW5TdGF0ZUJsb2NrUmVhZGVyCiAgICAgICAgKyBTdGFnZUNoZWNrcG9pbnRXcml0ZXIKICAgICAgICArIFBydW5lQ2hlY2twb2ludFJlYWRlcgogICAgICAgICsgUHJ1bmVDaGVja3BvaW50V3JpdGVyCiAgICAgICAgKyBDaGFuZ2VTZXRSZWFkZXIKICAgICAgICArIEJsb2NrTnVtUmVhZGVyLAp7CiAgICBmbiBpZCgmc2VsZikgLT4gU3RhZ2VJZCB7CiAgICAgICAgU3RhZ2VJZDo6TWVya2xlQ2hhbmdlU2V0cwogICAgfQoKICAgIGZuIGV4ZWN1dGUoJm11dCBzZWxmLCBwcm92aWRlcjogJlByb3ZpZGVyLCBpbnB1dDogRXhlY0lucHV0KSAtPiBSZXN1bHQ8RXhlY091dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIC8vIEdldCBtZXJrbGUgY2hlY2twb2ludCBhbmQgYXNzZXJ0IHRoYXQgdGhlIHRhcmdldCBpcyB0aGUgc2FtZS4KICAgICAgICBsZXQgbWVya2xlX2NoZWNrcG9pbnQgPSBwcm92aWRlcgogICAgICAgICAgICAuZ2V0X3N0YWdlX2NoZWNrcG9pbnQoU3RhZ2VJZDo6TWVya2xlRXhlY3V0ZSk/CiAgICAgICAgICAgIC5tYXAofGNoZWNrcG9pbnR8IGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyKQogICAgICAgICAgICAudW53cmFwX29yKDApOwoKICAgICAgICBpZiBpbnB1dC50YXJnZXQuaXNfbm9uZV9vcih8dGFyZ2V0fCBtZXJrbGVfY2hlY2twb2ludCAhPSB0YXJnZXQpIHsKICAgICAgICAgICAgcmV0dXJuIEVycihTdGFnZUVycm9yOjpGYXRhbChleXJlOjpleXJlISgiQ2Fubm90IHN5bmMgc3RhZ2UgdG8gYmxvY2sgezo/fSB3aGVuIE1lcmtsZUV4ZWN1dGUgaXMgYXQgYmxvY2sge21lcmtsZV9jaGVja3BvaW50Oj99IiwgaW5wdXQudGFyZ2V0KS5pbnRvKCkpKQogICAgICAgIH0KCiAgICAgICAgbGV0IG11dCB0YXJnZXRfcmFuZ2UgPSBzZWxmLmRldGVybWluZV90YXJnZXRfcmFuZ2UocHJvdmlkZXIpPzsKCiAgICAgICAgLy8gR2V0IHRoZSBwcmV2aW91c2x5IGNvbXB1dGVkIHJhbmdlLiBUaGlzIHdpbGwgYmUgdXBkYXRlZCB0byByZWZsZWN0IHRoZSBwb3B1bGF0aW5nIG9mIHRoZQogICAgICAgIC8vIHRhcmdldCByYW5nZS4KICAgICAgICBsZXQgbXV0IGNvbXB1dGVkX3JhbmdlID0gU2VsZjo6Y29tcHV0ZWRfcmFuZ2UocHJvdmlkZXIsIGlucHV0LmNoZWNrcG9pbnQpPzsKICAgICAgICBkZWJ1ZyEoCiAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnN0YWdlczo6bWVya2xlX2NoYW5nZXNldHMiLAogICAgICAgICAgICA/Y29tcHV0ZWRfcmFuZ2UsCiAgICAgICAgICAgID90YXJnZXRfcmFuZ2UsCiAgICAgICAgICAgICJHb3QgY29tcHV0ZWQgYW5kIHRhcmdldCByYW5nZXMiLAogICAgICAgICk7CgogICAgICAgIC8vIFdlIHdhbnQgdGhlIHRhcmdldCByYW5nZSB0byBub3QgaW5jbHVkZSBhbnkgZGF0YSBhbHJlYWR5IGNvbXB1dGVkIHByZXZpb3VzbHksIGlmCiAgICAgICAgLy8gcG9zc2libGUsIHNvIHdlIHN0YXJ0IHRoZSB0YXJnZXQgcmFuZ2UgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb21wdXRlZCByYW5nZSBpZiB0aGF0IGlzCiAgICAgICAgLy8gZ3JlYXRlci4KICAgICAgICAvLwogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLT4gQmxvY2sgIwogICAgICAgIC8vICAgIHwtLS0tLS1jb21wdXRlZC0tLS0tfAogICAgICAgIC8vICAgICAgICAgICAgICB8LS0tLS10YXJnZXQtLS0tLXwKICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgIHwtLWFjdHVhbC0tfAogICAgICAgIC8vCiAgICAgICAgLy8gSG93ZXZlciwgaWYgdGhlIHRhcmdldCBzdGFydCBpcyBsZXNzIHRoYW4gdGhlIHByZXZpb3VzbHkgY29tcHV0ZWQgc3RhcnQsIHdlIGRvbid0IHdhbnQgdG8KICAgICAgICAvLyBkbyB0aGlzLCBhcyBpdCB3b3VsZCBsZWF2ZSBhIGdhcCBvZiBkYXRhIGF0IGB0YXJnZXRfcmFuZ2Uuc3RhcnQuLj1jb21wdXRlZF9yYW5nZS5zdGFydGAuCiAgICAgICAgLy8KICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0+IEJsb2NrICMKICAgICAgICAvLyAgICAgICAgIHwtLS1jb21wdXRlZC0tLXwKICAgICAgICAvLyAgICAgIHwtLS0tLS0tdGFyZ2V0LS0tLS0tLXwKICAgICAgICAvLyAgICAgIHwtLS0tLS0tYWN0dWFsLS0tLS0tLXwKICAgICAgICAvLwogICAgICAgIGlmIHRhcmdldF9yYW5nZS5zdGFydCA+PSBjb21wdXRlZF9yYW5nZS5zdGFydCB7CiAgICAgICAgICAgIHRhcmdldF9yYW5nZS5zdGFydCA9IHRhcmdldF9yYW5nZS5zdGFydC5tYXgoY29tcHV0ZWRfcmFuZ2UuZW5kKTsKICAgICAgICB9CgogICAgICAgIC8vIElmIHRhcmdldCByYW5nZSBpcyBlbXB0eSAodGFyZ2V0X3N0YXJ0ID49IHRhcmdldF9lbmQpLCBzdGFnZSBpcyBhbHJlYWR5IHN1Y2Nlc3NmdWxseQogICAgICAgIC8vIGV4ZWN1dGVkLgogICAgICAgIGlmIHRhcmdldF9yYW5nZS5zdGFydCA+PSB0YXJnZXRfcmFuZ2UuZW5kIHsKICAgICAgICAgICAgcmV0dXJuIE9rKEV4ZWNPdXRwdXQ6OmRvbmUoU3RhZ2VDaGVja3BvaW50OjpuZXcodGFyZ2V0X3JhbmdlLmVuZC5zYXR1cmF0aW5nX3N1YigxKSkpKTsKICAgICAgICB9CgogICAgICAgIC8vIElmIG91ciB0YXJnZXQgcmFuZ2UgaXMgYSBjb250aW51YXRpb24gb2YgdGhlIGFscmVhZHkgY29tcHV0ZWQgcmFuZ2UgdGhlbiB3ZSBjYW4ga2VlcCB0aGUKICAgICAgICAvLyBhbHJlYWR5IGNvbXB1dGVkIGRhdGEuCiAgICAgICAgaWYgdGFyZ2V0X3JhbmdlLnN0YXJ0ID09IGNvbXB1dGVkX3JhbmdlLmVuZCB7CiAgICAgICAgICAgIC8vIENsZWFyIGZyb20gdGFyZ2V0X3N0YXJ0IG9ud2FyZHMgdG8gZW5zdXJlIG5vIHN0YWxlIGRhdGEgZXhpc3RzCiAgICAgICAgICAgIHByb3ZpZGVyLmNsZWFyX3RyaWVfY2hhbmdlc2V0c19mcm9tKHRhcmdldF9yYW5nZS5zdGFydCk/OwogICAgICAgICAgICBjb21wdXRlZF9yYW5nZS5lbmQgPSB0YXJnZXRfcmFuZ2UuZW5kOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIElmIG91ciB0YXJnZXQgcmFuZ2UgaXMgbm90IGEgY29udGludWF0aW9uIG9mIHRoZSBhbHJlYWR5IGNvbXB1dGVkIHJhbmdlIHRoZW4gd2UKICAgICAgICAgICAgLy8gc2ltcGx5IGNsZWFyIHRoZSBjb21wdXRlZCBkYXRhLCB0byBtYWtlIHN1cmUgdGhlcmUncyBubyBnYXBzIG9yIGNvbmZsaWN0cy4KICAgICAgICAgICAgcHJvdmlkZXIuY2xlYXJfdHJpZV9jaGFuZ2VzZXRzKCk/OwogICAgICAgICAgICBjb21wdXRlZF9yYW5nZSA9IHRhcmdldF9yYW5nZS5jbG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gUG9wdWxhdGUgdGhlIHRhcmdldCByYW5nZSB3aXRoIGNoYW5nZXNldHMKICAgICAgICBTZWxmOjpwb3B1bGF0ZV9yYW5nZShwcm92aWRlciwgdGFyZ2V0X3JhbmdlKT87CgogICAgICAgIC8vIFVwZGF0ZSB0aGUgcHJ1bmUgY2hlY2twb2ludCB0byByZWZsZWN0IHRoYXQgYWxsIGRhdGEgYmVmb3JlIGBjb21wdXRlZF9yYW5nZS5zdGFydGAKICAgICAgICAvLyBpcyBub3QgYXZhaWxhYmxlLgogICAgICAgIHByb3ZpZGVyLnNhdmVfcHJ1bmVfY2hlY2twb2ludCgKICAgICAgICAgICAgUHJ1bmVTZWdtZW50OjpNZXJrbGVDaGFuZ2VTZXRzLAogICAgICAgICAgICBQcnVuZUNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiBTb21lKGNvbXB1dGVkX3JhbmdlLnN0YXJ0LnNhdHVyYXRpbmdfc3ViKDEpKSwKICAgICAgICAgICAgICAgIHR4X251bWJlcjogTm9uZSwKICAgICAgICAgICAgICAgIHBydW5lX21vZGU6IFBydW5lTW9kZTo6QmVmb3JlKGNvbXB1dGVkX3JhbmdlLnN0YXJ0KSwKICAgICAgICAgICAgfSwKICAgICAgICApPzsKCiAgICAgICAgLy8gYGNvbXB1dGVkX3JhbmdlLmVuZGAgaXMgZXhjbHVzaXZlLgogICAgICAgIGxldCBjaGVja3BvaW50ID0gU3RhZ2VDaGVja3BvaW50OjpuZXcoY29tcHV0ZWRfcmFuZ2UuZW5kLnNhdHVyYXRpbmdfc3ViKDEpKTsKCiAgICAgICAgT2soRXhlY091dHB1dDo6ZG9uZShjaGVja3BvaW50KSkKICAgIH0KCiAgICBmbiB1bndpbmQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICAgICAgaW5wdXQ6IFVud2luZElucHV0LAogICAgKSAtPiBSZXN1bHQ8VW53aW5kT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgLy8gVW53aW5kaW5nIGlzIHRyaXZpYWw7IGp1c3QgY2xlYXIgZXZlcnl0aGluZyBhZnRlciB0aGUgdGFyZ2V0IGJsb2NrLgogICAgICAgIHByb3ZpZGVyLmNsZWFyX3RyaWVfY2hhbmdlc2V0c19mcm9tKGlucHV0LnVud2luZF90byArIDEpPzsKCiAgICAgICAgbGV0IG11dCBjb21wdXRlZF9yYW5nZSA9IFNlbGY6OmNvbXB1dGVkX3JhbmdlKHByb3ZpZGVyLCBTb21lKGlucHV0LmNoZWNrcG9pbnQpKT87CiAgICAgICAgY29tcHV0ZWRfcmFuZ2UuZW5kID0gaW5wdXQudW53aW5kX3RvICsgMTsKICAgICAgICBpZiBjb21wdXRlZF9yYW5nZS5zdGFydCA+IGNvbXB1dGVkX3JhbmdlLmVuZCB7CiAgICAgICAgICAgIGNvbXB1dGVkX3JhbmdlLnN0YXJ0ID0gY29tcHV0ZWRfcmFuZ2UuZW5kOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgd2UndmUgdW53b3VuZCBzbyBmYXIgdGhhdCB0aGVyZSBhcmUgbm8gbG9uZ2VyIGVub3VnaCB0cmllIGNoYW5nZXNldHMgYXZhaWxhYmxlIHRoZW4KICAgICAgICAvLyBzaW1wbHkgY2xlYXIgdGhlbSBhbmQgdGhlIGNoZWNrcG9pbnRzLCBzbyB0aGF0IG9uIG5leHQgcGlwZWxpbmUgc3RhcnR1cCB0aGV5IHdpbGwgYmUKICAgICAgICAvLyByZWdlbmVyYXRlZC4KICAgICAgICAvLwogICAgICAgIC8vIFdlIGRvbid0IGRvIHRoaXMgY2hlY2sgaWYgdGhlIHRhcmdldCBibG9jayBpcyBub3QgZ3JlYXRlciB0aGFuIHRoZSByZXRlbnRpb24gdGhyZXNob2xkCiAgICAgICAgLy8gKHdoaWNoIGhhcHBlbnMgbmVhciBnZW5lc2lzKSwgYXMgaW4gdGhhdCBjYXNlIHdvdWxkIGNvdWxkIHN0aWxsIGhhdmUgYWxsIHBvc3NpYmxlCiAgICAgICAgLy8gY2hhbmdlc2V0cyBldmVuIGlmIHRoZSB0b3RhbCBjb3VudCBkb2Vzbid0IG1lZXQgdGhlIHRocmVzaG9sZC4KICAgICAgICBkZWJ1ZyEoCiAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnN0YWdlczo6bWVya2xlX2NoYW5nZXNldHMiLAogICAgICAgICAgICA/Y29tcHV0ZWRfcmFuZ2UsCiAgICAgICAgICAgIHJldGVudGlvbl9ibG9ja3M9P3NlbGYucmV0ZW50aW9uX2Jsb2NrcywKICAgICAgICAgICAgIkNoZWNraW5nIGlmIGNvbXB1dGVkIHJhbmdlIGlzIG92ZXIgcmV0ZW50aW9uIHRocmVzaG9sZCIsCiAgICAgICAgKTsKICAgICAgICBpZiBpbnB1dC51bndpbmRfdG8gPiBzZWxmLnJldGVudGlvbl9ibG9ja3MgJiYKICAgICAgICAgICAgY29tcHV0ZWRfcmFuZ2UuZW5kIC0gY29tcHV0ZWRfcmFuZ2Uuc3RhcnQgPCBzZWxmLnJldGVudGlvbl9ibG9ja3MKICAgICAgICB7CiAgICAgICAgICAgIGRlYnVnISgKICAgICAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnN0YWdlczo6bWVya2xlX2NoYW5nZXNldHMiLAogICAgICAgICAgICAgICAgP2NvbXB1dGVkX3JhbmdlLAogICAgICAgICAgICAgICAgcmV0ZW50aW9uX2Jsb2Nrcz0/c2VsZi5yZXRlbnRpb25fYmxvY2tzLAogICAgICAgICAgICAgICAgIkNsZWFyaW5nIGNoZWNrcG9pbnRzIGNvbXBsZXRlbHkiLAogICAgICAgICAgICApOwogICAgICAgICAgICBwcm92aWRlci5jbGVhcl90cmllX2NoYW5nZXNldHMoKT87CiAgICAgICAgICAgIHByb3ZpZGVyCiAgICAgICAgICAgICAgICAuc2F2ZV9zdGFnZV9jaGVja3BvaW50KFN0YWdlSWQ6Ok1lcmtsZUNoYW5nZVNldHMsIFN0YWdlQ2hlY2twb2ludDo6ZGVmYXVsdCgpKT87CiAgICAgICAgICAgIHJldHVybiBPayhVbndpbmRPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6OmRlZmF1bHQoKSB9KQogICAgICAgIH0KCiAgICAgICAgLy8gYGNvbXB1dGVkX3JhbmdlLmVuZGAgaXMgZXhjbHVzaXZlCiAgICAgICAgbGV0IGNoZWNrcG9pbnQgPSBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhjb21wdXRlZF9yYW5nZS5lbmQuc2F0dXJhdGluZ19zdWIoMSkpOwoKICAgICAgICBPayhVbndpbmRPdXRwdXQgeyBjaGVja3BvaW50IH0pCiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9zdGFnZXMvc3JjL3N0YWdlcy9tZXJrbGUucnMiPgp1c2UgYWxsb3lfY29uc2Vuc3VzOjp7Y29uc3RhbnRzOjpLRUNDQUtfRU1QVFksIEJsb2NrSGVhZGVyfTsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OntCbG9ja051bWJlciwgU2VhbGFibGUsIEIyNTZ9Owp1c2UgcmV0aF9jb2RlY3M6OkNvbXBhY3Q7CnVzZSByZXRoX2NvbnNlbnN1czo6Q29uc2Vuc3VzRXJyb3I7CnVzZSByZXRoX2RiX2FwaTo6ewogICAgdGFibGVzLAogICAgdHJhbnNhY3Rpb246OntEYlR4LCBEYlR4TXV0fSwKfTsKdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OntHb3RFeHBlY3RlZCwgU2VhbGVkSGVhZGVyfTsKdXNlIHJldGhfcHJvdmlkZXI6OnsKICAgIENoYW5nZVNldFJlYWRlciwgREJQcm92aWRlciwgSGVhZGVyUHJvdmlkZXIsIFByb3ZpZGVyRXJyb3IsIFN0YWdlQ2hlY2twb2ludFJlYWRlciwKICAgIFN0YWdlQ2hlY2twb2ludFdyaXRlciwgU3RhdHNSZWFkZXIsIFRyaWVXcml0ZXIsCn07CnVzZSByZXRoX3N0YWdlc19hcGk6OnsKICAgIEJsb2NrRXJyb3JLaW5kLCBFbnRpdGllc0NoZWNrcG9pbnQsIEV4ZWNJbnB1dCwgRXhlY091dHB1dCwgTWVya2xlQ2hlY2twb2ludCwgU3RhZ2UsCiAgICBTdGFnZUNoZWNrcG9pbnQsIFN0YWdlRXJyb3IsIFN0YWdlSWQsIFN0b3JhZ2VSb290TWVya2xlQ2hlY2twb2ludCwgVW53aW5kSW5wdXQsIFVud2luZE91dHB1dCwKfTsKdXNlIHJldGhfdHJpZTo6e0ludGVybWVkaWF0ZVN0YXRlUm9vdFN0YXRlLCBTdGF0ZVJvb3QsIFN0YXRlUm9vdFByb2dyZXNzLCBTdG9yZWRTdWJOb2RlfTsKdXNlIHJldGhfdHJpZV9kYjo6RGF0YWJhc2VTdGF0ZVJvb3Q7CnVzZSBzdGQ6OmZtdDo6RGVidWc7CnVzZSB0cmFjaW5nOjoqOwoKLy8gVE9ETzogYXV0b21hdGUgdGhlIHByb2Nlc3Mgb3V0bGluZWQgYmVsb3cgc28gdGhlIHVzZXIgY2FuIGp1c3Qgc2VuZCBpbiBhIGRlYnVnZ2luZyBwYWNrYWdlCi8vLyBUaGUgZXJyb3IgbWVzc2FnZSB0aGF0IHdlIGluY2x1ZGUgaW4gaW52YWxpZCBzdGF0ZSByb290IGVycm9ycyB0byB0ZWxsIHVzZXJzIHdoYXQgaW5mb3JtYXRpb24KLy8vIHRoZXkgc2hvdWxkIGluY2x1ZGUgaW4gYSBidWcgcmVwb3J0LCBzaW5jZSB0cnVlIHN0YXRlIHJvb3QgZXJyb3JzIGNhbiBiZSBpbXBvc3NpYmxlIHRvIGRlYnVnCi8vLyB3aXRoIGp1c3QgYmFzaWMgbG9ncy4KcHViIGNvbnN0IElOVkFMSURfU1RBVEVfUk9PVF9FUlJPUl9NRVNTQUdFOiAmc3RyID0gciMiCkludmFsaWQgc3RhdGUgcm9vdCBlcnJvciBvbiBzdGFnZSB2ZXJpZmljYXRpb24hClRoaXMgaXMgYW4gZXJyb3IgdGhhdCBsaWtlbHkgcmVxdWlyZXMgYSByZXBvcnQgdG8gdGhlIHJldGggdGVhbSB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uClBsZWFzZSBpbmNsdWRlIHRoZSBmb2xsb3dpbmcgaW5mb3JtYXRpb24gaW4geW91ciByZXBvcnQ6CiAqIFRoaXMgZXJyb3IgbWVzc2FnZQogKiBUaGUgc3RhdGUgcm9vdCBvZiB0aGUgYmxvY2sgdGhhdCB3YXMgcmVqZWN0ZWQKICogVGhlIG91dHB1dCBvZiBgcmV0aCBkYiBzdGF0cyAtLWNoZWNrc3VtYCBmcm9tIHRoZSBkYXRhYmFzZSB0aGF0IHdhcyBiZWluZyB1c2VkLiBUaGlzIHdpbGwgdGFrZSBhIGxvbmcgdGltZSB0byBydW4hCiAqIDUwLTEwMCBsaW5lcyBvZiBsb2dzIGJlZm9yZSBhbmQgYWZ0ZXIgdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YgdGhlIGxvZyBtZXNzYWdlIHdpdGggdGhlIHN0YXRlIHJvb3Qgb2YgdGhlIGJsb2NrIHRoYXQgd2FzIHJlamVjdGVkLgogKiBUaGUgZGVidWcgbG9ncyBmcm9tIF9fdGhlIHNhbWUgdGltZSBwZXJpb2RfXy4gVG8gZmluZCB0aGUgZGVmYXVsdCBsb2NhdGlvbiBmb3IgdGhlc2UgbG9ncywgcnVuOgogICBgcmV0aCAtLWhlbHAgfCBncmVwIC1BIDQgJ2xvZy5maWxlLmRpcmVjdG9yeSdgCgpPbmNlIHlvdSBoYXZlIHRoaXMgaW5mb3JtYXRpb24sIHBsZWFzZSBzdWJtaXQgYSBnaXRodWIgaXNzdWUgYXQgaHR0cHM6Ly9naXRodWIuY29tL3BhcmFkaWdteHl6L3JldGgvaXNzdWVzL25ldwoiIzsKCi8vLyBUaGUgZGVmYXVsdCB0aHJlc2hvbGQgKGluIG51bWJlciBvZiBibG9ja3MpIGZvciBzd2l0Y2hpbmcgZnJvbSBpbmNyZW1lbnRhbCB0cmllIGJ1aWxkaW5nCi8vLyBvZiBjaGFuZ2VzIHRvIHdob2xlIHJlYnVpbGQuCnB1YiBjb25zdCBNRVJLTEVfU1RBR0VfREVGQVVMVF9SRUJVSUxEX1RIUkVTSE9MRDogdTY0ID0gMTAwXzAwMDsKCi8vLyBUaGUgZGVmYXVsdCB0aHJlc2hvbGQgKGluIG51bWJlciBvZiBibG9ja3MpIHRvIHJ1biB0aGUgc3RhZ2UgaW4gaW5jcmVtZW50YWwgbW9kZS4gVGhlCi8vLyBpbmNyZW1lbnRhbCBtb2RlIHdpbGwgY2FsY3VsYXRlIHRoZSBzdGF0ZSByb290IGZvciBhIGxhcmdlIHJhbmdlIG9mIGJsb2NrcyBieSBjYWxjdWxhdGluZyB0aGUKLy8vIG5ldyBzdGF0ZSByb290IGZvciB0aGlzIG1hbnkgYmxvY2tzLCBpbiBiYXRjaGVzLCByZXBlYXRpbmcgdW50aWwgd2UgcmVhY2ggdGhlIGRlc2lyZWQgYmxvY2sKLy8vIG51bWJlci4KcHViIGNvbnN0IE1FUktMRV9TVEFHRV9ERUZBVUxUX0lOQ1JFTUVOVEFMX1RIUkVTSE9MRDogdTY0ID0gN18wMDA7CgovLy8gVGhlIG1lcmtsZSBoYXNoaW5nIHN0YWdlIHVzZXMgaW5wdXQgZnJvbQovLy8gW2BBY2NvdW50SGFzaGluZ1N0YWdlYF1bY3JhdGU6OnN0YWdlczo6QWNjb3VudEhhc2hpbmdTdGFnZV0gYW5kCi8vLyBbYFN0b3JhZ2VIYXNoaW5nU3RhZ2VgXVtjcmF0ZTo6c3RhZ2VzOjpTdG9yYWdlSGFzaGluZ1N0YWdlXSB0byBjYWxjdWxhdGUgaW50ZXJtZWRpYXRlIGhhc2hlcwovLy8gYW5kIHN0YXRlIHJvb3RzLgovLy8KLy8vIFRoaXMgc3RhZ2Ugc2hvdWxkIGJlIHJ1biB3aXRoIHRoZSBhYm92ZSB0d28gc3RhZ2VzLCBvdGhlcndpc2UgaXQgaXMgYSBuby1vcC4KLy8vCi8vLyBUaGlzIHN0YWdlIGlzIHNwbGl0IGluIHR3bzogb25lIGZvciBjYWxjdWxhdGluZyBoYXNoZXMgYW5kIG9uZSBmb3IgdW53aW5kaW5nLgovLy8KLy8vIFdoZW4gcnVuIGluIGV4ZWN1dGlvbiwgaXQncyBnb2luZyB0byBiZSBleGVjdXRlZCBBRlRFUiB0aGUgaGFzaGluZyBzdGFnZXMsIHRvIGdlbmVyYXRlCi8vLyB0aGUgc3RhdGUgcm9vdC4gV2hlbiBydW4gaW4gdW53aW5kIG1vZGUsIGl0J3MgZ29pbmcgdG8gYmUgZXhlY3V0ZWQgQkVGT1JFIHRoZSBoYXNoaW5nIHN0YWdlcywKLy8vIHNvIHRoYXQgaXQgdW53aW5kcyB0aGUgaW50ZXJtZWRpYXRlIGhhc2hlcyBiYXNlZCBvbiB0aGUgdW53b3VuZCBoYXNoZWQgc3RhdGUgZnJvbSB0aGUgaGFzaGluZwovLy8gc3RhZ2VzLiBUaGUgb3JkZXIgb2YgdGhlc2UgdHdvIHZhcmlhbnRzIGlzIGltcG9ydGFudC4gVGhlIHVud2luZCB2YXJpYW50IHNob3VsZCBiZSBhZGRlZCB0byB0aGUKLy8vIHBpcGVsaW5lIGJlZm9yZSB0aGUgZXhlY3V0aW9uIHZhcmlhbnQuCi8vLwovLy8gQW4gZXhhbXBsZSBwaXBlbGluZSB0byBvbmx5IGhhc2ggc3RhdGUgd291bGQgYmU6Ci8vLwovLy8gLSBbYE1lcmtsZVN0YWdlOjpVbndpbmRgXQovLy8gLSBbYEFjY291bnRIYXNoaW5nU3RhZ2VgXVtjcmF0ZTo6c3RhZ2VzOjpBY2NvdW50SGFzaGluZ1N0YWdlXQovLy8gLSBbYFN0b3JhZ2VIYXNoaW5nU3RhZ2VgXVtjcmF0ZTo6c3RhZ2VzOjpTdG9yYWdlSGFzaGluZ1N0YWdlXQovLy8gLSBbYE1lcmtsZVN0YWdlOjpFeGVjdXRpb25gXQojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUpXQpwdWIgZW51bSBNZXJrbGVTdGFnZSB7CiAgICAvLy8gVGhlIGV4ZWN1dGlvbiBwb3J0aW9uIG9mIHRoZSBtZXJrbGUgc3RhZ2UuCiAgICBFeGVjdXRpb24gewogICAgICAgIC8vIFRPRE86IG1ha2Ugc3RydWN0IGZvciBob2xkaW5nIGluY3JlbWVudGFsIHNldHRpbmdzLCBmb3IgY29kZSByZXVzZSBiZXR3ZWVuIGBFeGVjdXRpb25gCiAgICAgICAgLy8gdmFyaWFudCBhbmQgYEJvdGhgCiAgICAgICAgLy8vIFRoZSB0aHJlc2hvbGQgKGluIG51bWJlciBvZiBibG9ja3MpIGZvciBzd2l0Y2hpbmcgZnJvbSBpbmNyZW1lbnRhbCB0cmllIGJ1aWxkaW5nCiAgICAgICAgLy8vIG9mIGNoYW5nZXMgdG8gd2hvbGUgcmVidWlsZC4KICAgICAgICByZWJ1aWxkX3RocmVzaG9sZDogdTY0LAogICAgICAgIC8vLyBUaGUgdGhyZXNob2xkIChpbiBudW1iZXIgb2YgYmxvY2tzKSB0byBydW4gdGhlIHN0YWdlIGluIGluY3JlbWVudGFsIG1vZGUuIFRoZQogICAgICAgIC8vLyBpbmNyZW1lbnRhbCBtb2RlIHdpbGwgY2FsY3VsYXRlIHRoZSBzdGF0ZSByb290IGJ5IGNhbGN1bGF0aW5nIHRoZSBuZXcgc3RhdGUgcm9vdCBmb3IKICAgICAgICAvLy8gc29tZSBudW1iZXIgb2YgYmxvY2tzLCByZXBlYXRpbmcgdW50aWwgd2UgcmVhY2ggdGhlIGRlc2lyZWQgYmxvY2sgbnVtYmVyLgogICAgICAgIGluY3JlbWVudGFsX3RocmVzaG9sZDogdTY0LAogICAgfSwKICAgIC8vLyBUaGUgdW53aW5kIHBvcnRpb24gb2YgdGhlIG1lcmtsZSBzdGFnZS4KICAgIFVud2luZCwKICAgIC8vLyBBYmxlIHRvIGV4ZWN1dGUgYW5kIHVud2luZC4gVXNlZCBmb3IgdGVzdHMKICAgICNbY2ZnKGFueSh0ZXN0LCBmZWF0dXJlID0gInRlc3QtdXRpbHMiKSldCiAgICBCb3RoIHsKICAgICAgICAvLy8gVGhlIHRocmVzaG9sZCAoaW4gbnVtYmVyIG9mIGJsb2NrcykgZm9yIHN3aXRjaGluZyBmcm9tIGluY3JlbWVudGFsIHRyaWUgYnVpbGRpbmcKICAgICAgICAvLy8gb2YgY2hhbmdlcyB0byB3aG9sZSByZWJ1aWxkLgogICAgICAgIHJlYnVpbGRfdGhyZXNob2xkOiB1NjQsCiAgICAgICAgLy8vIFRoZSB0aHJlc2hvbGQgKGluIG51bWJlciBvZiBibG9ja3MpIHRvIHJ1biB0aGUgc3RhZ2UgaW4gaW5jcmVtZW50YWwgbW9kZS4gVGhlCiAgICAgICAgLy8vIGluY3JlbWVudGFsIG1vZGUgd2lsbCBjYWxjdWxhdGUgdGhlIHN0YXRlIHJvb3QgYnkgY2FsY3VsYXRpbmcgdGhlIG5ldyBzdGF0ZSByb290IGZvcgogICAgICAgIC8vLyBzb21lIG51bWJlciBvZiBibG9ja3MsIHJlcGVhdGluZyB1bnRpbCB3ZSByZWFjaCB0aGUgZGVzaXJlZCBibG9jayBudW1iZXIuCiAgICAgICAgaW5jcmVtZW50YWxfdGhyZXNob2xkOiB1NjQsCiAgICB9LAp9CgppbXBsIE1lcmtsZVN0YWdlIHsKICAgIC8vLyBTdGFnZSBkZWZhdWx0IGZvciB0aGUgW2BNZXJrbGVTdGFnZTo6RXhlY3V0aW9uYF0uCiAgICBwdWIgY29uc3QgZm4gZGVmYXVsdF9leGVjdXRpb24oKSAtPiBTZWxmIHsKICAgICAgICBTZWxmOjpFeGVjdXRpb24gewogICAgICAgICAgICByZWJ1aWxkX3RocmVzaG9sZDogTUVSS0xFX1NUQUdFX0RFRkFVTFRfUkVCVUlMRF9USFJFU0hPTEQsCiAgICAgICAgICAgIGluY3JlbWVudGFsX3RocmVzaG9sZDogTUVSS0xFX1NUQUdFX0RFRkFVTFRfSU5DUkVNRU5UQUxfVEhSRVNIT0xELAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gU3RhZ2UgZGVmYXVsdCBmb3IgdGhlIFtgTWVya2xlU3RhZ2U6OlVud2luZGBdLgogICAgcHViIGNvbnN0IGZuIGRlZmF1bHRfdW53aW5kKCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZjo6VW53aW5kCiAgICB9CgogICAgLy8vIENyZWF0ZSBuZXcgaW5zdGFuY2Ugb2YgW2BNZXJrbGVTdGFnZTo6RXhlY3V0aW9uYF0uCiAgICBwdWIgY29uc3QgZm4gbmV3X2V4ZWN1dGlvbihyZWJ1aWxkX3RocmVzaG9sZDogdTY0LCBpbmNyZW1lbnRhbF90aHJlc2hvbGQ6IHU2NCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZjo6RXhlY3V0aW9uIHsgcmVidWlsZF90aHJlc2hvbGQsIGluY3JlbWVudGFsX3RocmVzaG9sZCB9CiAgICB9CgogICAgLy8vIEdldHMgdGhlIGhhc2hpbmcgcHJvZ3Jlc3MKICAgIHB1YiBmbiBnZXRfZXhlY3V0aW9uX2NoZWNrcG9pbnQoCiAgICAgICAgJnNlbGYsCiAgICAgICAgcHJvdmlkZXI6ICZpbXBsIFN0YWdlQ2hlY2twb2ludFJlYWRlciwKICAgICkgLT4gUmVzdWx0PE9wdGlvbjxNZXJrbGVDaGVja3BvaW50PiwgU3RhZ2VFcnJvcj4gewogICAgICAgIGxldCBidWYgPQogICAgICAgICAgICBwcm92aWRlci5nZXRfc3RhZ2VfY2hlY2twb2ludF9wcm9ncmVzcyhTdGFnZUlkOjpNZXJrbGVFeGVjdXRlKT8udW53cmFwX29yX2RlZmF1bHQoKTsKCiAgICAgICAgaWYgYnVmLmlzX2VtcHR5KCkgewogICAgICAgICAgICByZXR1cm4gT2soTm9uZSkKICAgICAgICB9CgogICAgICAgIGxldCAoY2hlY2twb2ludCwgXykgPSBNZXJrbGVDaGVja3BvaW50Ojpmcm9tX2NvbXBhY3QoJmJ1ZiwgYnVmLmxlbigpKTsKICAgICAgICBPayhTb21lKGNoZWNrcG9pbnQpKQogICAgfQoKICAgIC8vLyBTYXZlcyB0aGUgaGFzaGluZyBwcm9ncmVzcwogICAgcHViIGZuIHNhdmVfZXhlY3V0aW9uX2NoZWNrcG9pbnQoCiAgICAgICAgJnNlbGYsCiAgICAgICAgcHJvdmlkZXI6ICZpbXBsIFN0YWdlQ2hlY2twb2ludFdyaXRlciwKICAgICAgICBjaGVja3BvaW50OiBPcHRpb248TWVya2xlQ2hlY2twb2ludD4sCiAgICApIC0+IFJlc3VsdDwoKSwgU3RhZ2VFcnJvcj4gewogICAgICAgIGxldCBtdXQgYnVmID0gdmVjIVtdOwogICAgICAgIGlmIGxldCBTb21lKGNoZWNrcG9pbnQpID0gY2hlY2twb2ludCB7CiAgICAgICAgICAgIGRlYnVnISgKICAgICAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnN0YWdlczo6bWVya2xlOjpleGVjIiwKICAgICAgICAgICAgICAgIGxhc3RfYWNjb3VudF9rZXkgPSA/Y2hlY2twb2ludC5sYXN0X2FjY291bnRfa2V5LAogICAgICAgICAgICAgICAgIlNhdmluZyBpbm5lciBtZXJrbGUgY2hlY2twb2ludCIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY2hlY2twb2ludC50b19jb21wYWN0KCZtdXQgYnVmKTsKICAgICAgICB9CiAgICAgICAgT2socHJvdmlkZXIuc2F2ZV9zdGFnZV9jaGVja3BvaW50X3Byb2dyZXNzKFN0YWdlSWQ6Ok1lcmtsZUV4ZWN1dGUsIGJ1Zik/KQogICAgfQp9CgppbXBsPFByb3ZpZGVyPiBTdGFnZTxQcm92aWRlcj4gZm9yIE1lcmtsZVN0YWdlCndoZXJlCiAgICBQcm92aWRlcjogREJQcm92aWRlcjxUeDogRGJUeE11dD4KICAgICAgICArIFRyaWVXcml0ZXIKICAgICAgICArIFN0YXRzUmVhZGVyCiAgICAgICAgKyBIZWFkZXJQcm92aWRlcgogICAgICAgICsgQ2hhbmdlU2V0UmVhZGVyCiAgICAgICAgKyBTdGFnZUNoZWNrcG9pbnRSZWFkZXIKICAgICAgICArIFN0YWdlQ2hlY2twb2ludFdyaXRlciwKewogICAgLy8vIFJldHVybiB0aGUgaWQgb2YgdGhlIHN0YWdlCiAgICBmbiBpZCgmc2VsZikgLT4gU3RhZ2VJZCB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkV4ZWN1dGlvbiB7IC4uIH0gPT4gU3RhZ2VJZDo6TWVya2xlRXhlY3V0ZSwKICAgICAgICAgICAgU2VsZjo6VW53aW5kID0+IFN0YWdlSWQ6Ok1lcmtsZVVud2luZCwKICAgICAgICAgICAgI1tjZmcoYW55KHRlc3QsIGZlYXR1cmUgPSAidGVzdC11dGlscyIpKV0KICAgICAgICAgICAgU2VsZjo6Qm90aCB7IC4uIH0gPT4gU3RhZ2VJZDo6T3RoZXIoIk1lcmtsZUJvdGgiKSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIEV4ZWN1dGUgdGhlIHN0YWdlLgogICAgZm4gZXhlY3V0ZSgmbXV0IHNlbGYsIHByb3ZpZGVyOiAmUHJvdmlkZXIsIGlucHV0OiBFeGVjSW5wdXQpIC0+IFJlc3VsdDxFeGVjT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgbGV0ICh0aHJlc2hvbGQsIGluY3JlbWVudGFsX3RocmVzaG9sZCkgPSBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6VW53aW5kID0+IHsKICAgICAgICAgICAgICAgIGluZm8hKHRhcmdldDogInN5bmM6OnN0YWdlczo6bWVya2xlOjp1bndpbmQiLCAiU3RhZ2UgaXMgYWx3YXlzIHNraXBwZWQiKTsKICAgICAgICAgICAgICAgIHJldHVybiBPayhFeGVjT3V0cHV0Ojpkb25lKFN0YWdlQ2hlY2twb2ludDo6bmV3KGlucHV0LnRhcmdldCgpKSkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgU2VsZjo6RXhlY3V0aW9uIHsgcmVidWlsZF90aHJlc2hvbGQsIGluY3JlbWVudGFsX3RocmVzaG9sZCB9ID0+IHsKICAgICAgICAgICAgICAgICgqcmVidWlsZF90aHJlc2hvbGQsICppbmNyZW1lbnRhbF90aHJlc2hvbGQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgI1tjZmcoYW55KHRlc3QsIGZlYXR1cmUgPSAidGVzdC11dGlscyIpKV0KICAgICAgICAgICAgU2VsZjo6Qm90aCB7IHJlYnVpbGRfdGhyZXNob2xkLCBpbmNyZW1lbnRhbF90aHJlc2hvbGQgfSA9PiB7CiAgICAgICAgICAgICAgICAoKnJlYnVpbGRfdGhyZXNob2xkLCAqaW5jcmVtZW50YWxfdGhyZXNob2xkKQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgbGV0IHJhbmdlID0gaW5wdXQubmV4dF9ibG9ja19yYW5nZSgpOwogICAgICAgIGxldCAoZnJvbV9ibG9jaywgdG9fYmxvY2spID0gcmFuZ2UuY2xvbmUoKS5pbnRvX2lubmVyKCk7CiAgICAgICAgbGV0IGN1cnJlbnRfYmxvY2tfbnVtYmVyID0gaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlcjsKCiAgICAgICAgbGV0IHRhcmdldF9ibG9jayA9IHByb3ZpZGVyCiAgICAgICAgICAgIC5oZWFkZXJfYnlfbnVtYmVyKHRvX2Jsb2NrKT8KICAgICAgICAgICAgLm9rX29yX2Vsc2UofHwgUHJvdmlkZXJFcnJvcjo6SGVhZGVyTm90Rm91bmQodG9fYmxvY2suaW50bygpKSk/OwogICAgICAgIGxldCB0YXJnZXRfYmxvY2tfcm9vdCA9IHRhcmdldF9ibG9jay5zdGF0ZV9yb290KCk7CgogICAgICAgIGxldCAodHJpZV9yb290LCBlbnRpdGllc19jaGVja3BvaW50KSA9IGlmIHJhbmdlLmlzX2VtcHR5KCkgewogICAgICAgICAgICAodGFyZ2V0X2Jsb2NrX3Jvb3QsIGlucHV0LmNoZWNrcG9pbnQoKS5lbnRpdGllc19zdGFnZV9jaGVja3BvaW50KCkudW53cmFwX29yX2RlZmF1bHQoKSkKICAgICAgICB9IGVsc2UgaWYgdG9fYmxvY2sgLSBmcm9tX2Jsb2NrID4gdGhyZXNob2xkIHx8IGZyb21fYmxvY2sgPT0gMSB7CiAgICAgICAgICAgIGxldCBtdXQgY2hlY2twb2ludCA9IHNlbGYuZ2V0X2V4ZWN1dGlvbl9jaGVja3BvaW50KHByb3ZpZGVyKT87CgogICAgICAgICAgICAvLyBpZiB0aGVyZSBhcmUgbW9yZSBibG9ja3MgdGhhbiB0aHJlc2hvbGQgaXQgaXMgZmFzdGVyIHRvIHJlYnVpbGQgdGhlIHRyaWUKICAgICAgICAgICAgbGV0IG11dCBlbnRpdGllc19jaGVja3BvaW50ID0gaWYgbGV0IFNvbWUoY2hlY2twb2ludCkgPQogICAgICAgICAgICAgICAgY2hlY2twb2ludC5hc19yZWYoKS5maWx0ZXIofGN8IGMudGFyZ2V0X2Jsb2NrID09IHRvX2Jsb2NrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkZWJ1ZyEoCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6c3RhZ2VzOjptZXJrbGU6OmV4ZWMiLAogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSA/Y3VycmVudF9ibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gP3RvX2Jsb2NrLAogICAgICAgICAgICAgICAgICAgIGxhc3RfYWNjb3VudF9rZXkgPSA/Y2hlY2twb2ludC5sYXN0X2FjY291bnRfa2V5LAogICAgICAgICAgICAgICAgICAgICJDb250aW51aW5nIGlubmVyIG1lcmtsZSBjaGVja3BvaW50IgogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBpbnB1dC5jaGVja3BvaW50KCkuZW50aXRpZXNfc3RhZ2VfY2hlY2twb2ludCgpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWJ1ZyEoCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6c3RhZ2VzOjptZXJrbGU6OmV4ZWMiLAogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSA/Y3VycmVudF9ibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gP3RvX2Jsb2NrLAogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzX2NoZWNrcG9pbnQgPSA/Y2hlY2twb2ludCwKICAgICAgICAgICAgICAgICAgICAiUmVidWlsZGluZyB0cmllIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IHRoZSBjaGVja3BvaW50IGFuZCBjbGVhciB0cmllIHRhYmxlcwogICAgICAgICAgICAgICAgY2hlY2twb2ludCA9IE5vbmU7CiAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZXhlY3V0aW9uX2NoZWNrcG9pbnQocHJvdmlkZXIsIE5vbmUpPzsKICAgICAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmNsZWFyOjo8dGFibGVzOjpBY2NvdW50c1RyaWU+KCk/OwogICAgICAgICAgICAgICAgcHJvdmlkZXIudHhfcmVmKCkuY2xlYXI6Ojx0YWJsZXM6OlN0b3JhZ2VzVHJpZT4oKT87CgogICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICB9CiAgICAgICAgICAgIC51bndyYXBfb3IoRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgIHByb2Nlc3NlZDogMCwKICAgICAgICAgICAgICAgIHRvdGFsOiAocHJvdmlkZXIuY291bnRfZW50cmllczo6PHRhYmxlczo6SGFzaGVkQWNjb3VudHM+KCk/ICsKICAgICAgICAgICAgICAgICAgICBwcm92aWRlci5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpIYXNoZWRTdG9yYWdlcz4oKT8pCiAgICAgICAgICAgICAgICAgICAgYXMgdTY0LAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGxldCB0eCA9IHByb3ZpZGVyLnR4X3JlZigpOwogICAgICAgICAgICBsZXQgcHJvZ3Jlc3MgPSBTdGF0ZVJvb3Q6OmZyb21fdHgodHgpCiAgICAgICAgICAgICAgICAud2l0aF9pbnRlcm1lZGlhdGVfc3RhdGUoY2hlY2twb2ludC5tYXAoSW50ZXJtZWRpYXRlU3RhdGVSb290U3RhdGU6OmZyb20pKQogICAgICAgICAgICAgICAgLnJvb3Rfd2l0aF9wcm9ncmVzcygpCiAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXwgewogICAgICAgICAgICAgICAgICAgIGVycm9yISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6Om1lcmtsZSIsICVlLCA/Y3VycmVudF9ibG9ja19udW1iZXIsID90b19ibG9jaywgIlN0YXRlIHJvb3Qgd2l0aCBwcm9ncmVzcyBmYWlsZWQhIHtJTlZBTElEX1NUQVRFX1JPT1RfRVJST1JfTUVTU0FHRX0iKTsKICAgICAgICAgICAgICAgICAgICBTdGFnZUVycm9yOjpGYXRhbChCb3g6Om5ldyhlKSkKICAgICAgICAgICAgICAgIH0pPzsKICAgICAgICAgICAgbWF0Y2ggcHJvZ3Jlc3MgewogICAgICAgICAgICAgICAgU3RhdGVSb290UHJvZ3Jlc3M6OlByb2dyZXNzKHN0YXRlLCBoYXNoZWRfZW50cmllc193YWxrZWQsIHVwZGF0ZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICBwcm92aWRlci53cml0ZV90cmllX3VwZGF0ZXModXBkYXRlcyk/OwoKICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IGNoZWNrcG9pbnQgPSBNZXJrbGVDaGVja3BvaW50OjpuZXcoCiAgICAgICAgICAgICAgICAgICAgICAgIHRvX2Jsb2NrLAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5hY2NvdW50X3Jvb3Rfc3RhdGUubGFzdF9oYXNoZWRfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFjY291bnRfcm9vdF9zdGF0ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLndhbGtlcl9zdGFjawogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKFN0b3JlZFN1Yk5vZGU6OmZyb20pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY29sbGVjdCgpLAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5hY2NvdW50X3Jvb3Rfc3RhdGUuaGFzaF9idWlsZGVyLmludG8oKSwKICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgICAgICAvLyBTYXZlIHN0b3JhZ2Ugcm9vdCBzdGF0ZSBpZiBwcmVzZW50CiAgICAgICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUoc3RvcmFnZV9zdGF0ZSkgPSBzdGF0ZS5zdG9yYWdlX3Jvb3Rfc3RhdGUgewogICAgICAgICAgICAgICAgICAgICAgICBjaGVja3BvaW50LnN0b3JhZ2Vfcm9vdF9jaGVja3BvaW50ID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNvbWUoU3RvcmFnZVJvb3RNZXJrbGVDaGVja3BvaW50OjpuZXcoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmFnZV9zdGF0ZS5zdGF0ZS5sYXN0X2hhc2hlZF9rZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmFnZV9zdGF0ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc3RhdGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLndhbGtlcl9zdGFjawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuaW50b19pdGVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChTdG9yZWRTdWJOb2RlOjpmcm9tKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY29sbGVjdCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JhZ2Vfc3RhdGUuc3RhdGUuaGFzaF9idWlsZGVyLmludG8oKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9yYWdlX3N0YXRlLmFjY291bnQubm9uY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmFnZV9zdGF0ZS5hY2NvdW50LmJhbGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmFnZV9zdGF0ZS5hY2NvdW50LmJ5dGVjb2RlX2hhc2gudW53cmFwX29yKEtFQ0NBS19FTVBUWSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2V4ZWN1dGlvbl9jaGVja3BvaW50KHByb3ZpZGVyLCBTb21lKGNoZWNrcG9pbnQpKT87CgogICAgICAgICAgICAgICAgICAgIGVudGl0aWVzX2NoZWNrcG9pbnQucHJvY2Vzc2VkICs9IGhhc2hlZF9lbnRyaWVzX3dhbGtlZCBhcyB1NjQ7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBPayhFeGVjT3V0cHV0IHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogaW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jaGVja3BvaW50KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC53aXRoX2VudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQoZW50aXRpZXNfY2hlY2twb2ludCksCiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBTdGF0ZVJvb3RQcm9ncmVzczo6Q29tcGxldGUocm9vdCwgaGFzaGVkX2VudHJpZXNfd2Fsa2VkLCB1cGRhdGVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXIud3JpdGVfdHJpZV91cGRhdGVzKHVwZGF0ZXMpPzsKCiAgICAgICAgICAgICAgICAgICAgZW50aXRpZXNfY2hlY2twb2ludC5wcm9jZXNzZWQgKz0gaGFzaGVkX2VudHJpZXNfd2Fsa2VkIGFzIHU2NDsKCiAgICAgICAgICAgICAgICAgICAgKHJvb3QsIGVudGl0aWVzX2NoZWNrcG9pbnQpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkZWJ1ZyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjptZXJrbGU6OmV4ZWMiLCBjdXJyZW50ID0gP2N1cnJlbnRfYmxvY2tfbnVtYmVyLCB0YXJnZXQgPSA/dG9fYmxvY2ssICJVcGRhdGluZyB0cmllIGluIGNodW5rcyIpOwogICAgICAgICAgICBsZXQgbXV0IGZpbmFsX3Jvb3QgPSBOb25lOwogICAgICAgICAgICBmb3Igc3RhcnRfYmxvY2sgaW4gcmFuZ2Uuc3RlcF9ieShpbmNyZW1lbnRhbF90aHJlc2hvbGQgYXMgdXNpemUpIHsKICAgICAgICAgICAgICAgIGxldCBjaHVua190byA9IHN0ZDo6Y21wOjptaW4oc3RhcnRfYmxvY2sgKyBpbmNyZW1lbnRhbF90aHJlc2hvbGQsIHRvX2Jsb2NrKTsKICAgICAgICAgICAgICAgIGxldCBjaHVua19yYW5nZSA9IHN0YXJ0X2Jsb2NrLi49Y2h1bmtfdG87CiAgICAgICAgICAgICAgICBkZWJ1ZyEoCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6c3RhZ2VzOjptZXJrbGU6OmV4ZWMiLAogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSA/Y3VycmVudF9ibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gP3RvX2Jsb2NrLAogICAgICAgICAgICAgICAgICAgIGluY3JlbWVudGFsX3RocmVzaG9sZCwKICAgICAgICAgICAgICAgICAgICBjaHVua19yYW5nZSA9ID9jaHVua19yYW5nZSwKICAgICAgICAgICAgICAgICAgICAiUHJvY2Vzc2luZyBjaHVuayIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBsZXQgKHJvb3QsIHVwZGF0ZXMpID0KICAgICAgICAgICAgICAgIFN0YXRlUm9vdDo6aW5jcmVtZW50YWxfcm9vdF93aXRoX3VwZGF0ZXMocHJvdmlkZXIsIGNodW5rX3JhbmdlKQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKHxlfCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6Om1lcmtsZSIsICVlLCA/Y3VycmVudF9ibG9ja19udW1iZXIsID90b19ibG9jaywgIkluY3JlbWVudGFsIHN0YXRlIHJvb3QgZmFpbGVkISB7SU5WQUxJRF9TVEFURV9ST09UX0VSUk9SX01FU1NBR0V9Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIFN0YWdlRXJyb3I6OkZhdGFsKEJveDo6bmV3KGUpKQogICAgICAgICAgICAgICAgICAgIH0pPzsKICAgICAgICAgICAgICAgIHByb3ZpZGVyLndyaXRlX3RyaWVfdXBkYXRlcyh1cGRhdGVzKT87CiAgICAgICAgICAgICAgICBmaW5hbF9yb290ID0gU29tZShyb290KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgd2UgaGFkIG5vIGZpbmFsIHJvb3QsIHdlIG11c3QgaGF2ZSBub3QgbG9vcGVkIGFib3ZlLCB3aGljaCBzaG91bGQgbm90IGJlIHBvc3NpYmxlCiAgICAgICAgICAgIGxldCBmaW5hbF9yb290ID0gZmluYWxfcm9vdC5va19vcihTdGFnZUVycm9yOjpGYXRhbCgKICAgICAgICAgICAgICAgICJJbmNyZW1lbnRhbCBtZXJrbGUgaGFzaGluZyBkaWQgbm90IHByb2R1Y2UgYSBmaW5hbCByb290Ii5pbnRvKCksCiAgICAgICAgICAgICkpPzsKCiAgICAgICAgICAgIGxldCB0b3RhbF9oYXNoZWRfZW50cmllcyA9IChwcm92aWRlci5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpIYXNoZWRBY2NvdW50cz4oKT8gKwogICAgICAgICAgICAgICAgcHJvdmlkZXIuY291bnRfZW50cmllczo6PHRhYmxlczo6SGFzaGVkU3RvcmFnZXM+KCk/KQogICAgICAgICAgICAgICAgYXMgdTY0OwoKICAgICAgICAgICAgbGV0IGVudGl0aWVzX2NoZWNrcG9pbnQgPSBFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBmaW5lIGJlY2F1c2UgYHJhbmdlYCBkb2Vzbid0IGhhdmUgYW4gdXBwZXIgYm91bmQsIHNvIGluIHRoaXMgYGVsc2VgCiAgICAgICAgICAgICAgICAvLyBicmFuY2ggd2UncmUganVzdCBoYXNoaW5nIGFsbCByZW1haW5pbmcgYWNjb3VudHMgYW5kIHN0b3JhZ2Ugc2xvdHMgd2UgaGF2ZSBpbiB0aGUKICAgICAgICAgICAgICAgIC8vIGRhdGFiYXNlLgogICAgICAgICAgICAgICAgcHJvY2Vzc2VkOiB0b3RhbF9oYXNoZWRfZW50cmllcywKICAgICAgICAgICAgICAgIHRvdGFsOiB0b3RhbF9oYXNoZWRfZW50cmllcywKICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy8gU2F2ZSB0aGUgY2hlY2twb2ludAogICAgICAgICAgICAoZmluYWxfcm9vdCwgZW50aXRpZXNfY2hlY2twb2ludCkKICAgICAgICB9OwoKICAgICAgICAvLyBSZXNldCB0aGUgY2hlY2twb2ludAogICAgICAgIHNlbGYuc2F2ZV9leGVjdXRpb25fY2hlY2twb2ludChwcm92aWRlciwgTm9uZSk/OwoKICAgICAgICB2YWxpZGF0ZV9zdGF0ZV9yb290KHRyaWVfcm9vdCwgU2VhbGVkSGVhZGVyOjpzZWFsX3Nsb3codGFyZ2V0X2Jsb2NrKSwgdG9fYmxvY2spPzsKCiAgICAgICAgT2soRXhlY091dHB1dCB7CiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KHRvX2Jsb2NrKQogICAgICAgICAgICAgICAgLndpdGhfZW50aXRpZXNfc3RhZ2VfY2hlY2twb2ludChlbnRpdGllc19jaGVja3BvaW50KSwKICAgICAgICAgICAgZG9uZTogdHJ1ZSwKICAgICAgICB9KQogICAgfQoKICAgIC8vLyBVbndpbmQgdGhlIHN0YWdlLgogICAgZm4gdW53aW5kKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBwcm92aWRlcjogJlByb3ZpZGVyLAogICAgICAgIGlucHV0OiBVbndpbmRJbnB1dCwKICAgICkgLT4gUmVzdWx0PFVud2luZE91dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIGxldCB0eCA9IHByb3ZpZGVyLnR4X3JlZigpOwogICAgICAgIGxldCByYW5nZSA9IGlucHV0LnVud2luZF9ibG9ja19yYW5nZSgpOwogICAgICAgIGlmIG1hdGNoZXMhKHNlbGYsIFNlbGY6OkV4ZWN1dGlvbiB7IC4uIH0pIHsKICAgICAgICAgICAgaW5mbyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjptZXJrbGU6OnVud2luZCIsICJTdGFnZSBpcyBhbHdheXMgc2tpcHBlZCIpOwogICAgICAgICAgICByZXR1cm4gT2soVW53aW5kT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoaW5wdXQudW53aW5kX3RvKSB9KQogICAgICAgIH0KCiAgICAgICAgbGV0IG11dCBlbnRpdGllc19jaGVja3BvaW50ID0KICAgICAgICAgICAgaW5wdXQuY2hlY2twb2ludC5lbnRpdGllc19zdGFnZV9jaGVja3BvaW50KCkudW53cmFwX29yKEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICBwcm9jZXNzZWQ6IDAsCiAgICAgICAgICAgICAgICB0b3RhbDogKHR4LmVudHJpZXM6Ojx0YWJsZXM6Okhhc2hlZEFjY291bnRzPigpPyArCiAgICAgICAgICAgICAgICAgICAgdHguZW50cmllczo6PHRhYmxlczo6SGFzaGVkU3RvcmFnZXM+KCk/KSBhcyB1NjQsCiAgICAgICAgICAgIH0pOwoKICAgICAgICBpZiBpbnB1dC51bndpbmRfdG8gPT0gMCB7CiAgICAgICAgICAgIHR4LmNsZWFyOjo8dGFibGVzOjpBY2NvdW50c1RyaWU+KCk/OwogICAgICAgICAgICB0eC5jbGVhcjo6PHRhYmxlczo6U3RvcmFnZXNUcmllPigpPzsKCiAgICAgICAgICAgIGVudGl0aWVzX2NoZWNrcG9pbnQucHJvY2Vzc2VkID0gMDsKCiAgICAgICAgICAgIHJldHVybiBPayhVbndpbmRPdXRwdXQgewogICAgICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoaW5wdXQudW53aW5kX3RvKQogICAgICAgICAgICAgICAgICAgIC53aXRoX2VudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQoZW50aXRpZXNfY2hlY2twb2ludCksCiAgICAgICAgICAgIH0pCiAgICAgICAgfQoKICAgICAgICAvLyBVbndpbmQgdHJpZSBvbmx5IGlmIHRoZXJlIGFyZSB0cmFuc2l0aW9ucwogICAgICAgIGlmIHJhbmdlLmlzX2VtcHR5KCkgewogICAgICAgICAgICBpbmZvISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6Om1lcmtsZTo6dW53aW5kIiwgIk5vdGhpbmcgdG8gdW53aW5kIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGV0IChibG9ja19yb290LCB1cGRhdGVzKSA9IFN0YXRlUm9vdDo6aW5jcmVtZW50YWxfcm9vdF93aXRoX3VwZGF0ZXMocHJvdmlkZXIsIHJhbmdlKQogICAgICAgICAgICAgICAgLm1hcF9lcnIofGV8IFN0YWdlRXJyb3I6OkZhdGFsKEJveDo6bmV3KGUpKSk/OwoKICAgICAgICAgICAgLy8gVmFsaWRhdGUgdGhlIGNhbGN1bGF0ZWQgc3RhdGUgcm9vdAogICAgICAgICAgICBsZXQgdGFyZ2V0ID0gcHJvdmlkZXIKICAgICAgICAgICAgICAgIC5oZWFkZXJfYnlfbnVtYmVyKGlucHV0LnVud2luZF90byk/CiAgICAgICAgICAgICAgICAub2tfb3JfZWxzZSh8fCBQcm92aWRlckVycm9yOjpIZWFkZXJOb3RGb3VuZChpbnB1dC51bndpbmRfdG8uaW50bygpKSk/OwoKICAgICAgICAgICAgdmFsaWRhdGVfc3RhdGVfcm9vdChibG9ja19yb290LCBTZWFsZWRIZWFkZXI6OnNlYWxfc2xvdyh0YXJnZXQpLCBpbnB1dC51bndpbmRfdG8pPzsKCiAgICAgICAgICAgIC8vIFZhbGlkYXRpb24gcGFzc2VkLCBhcHBseSB1bndpbmQgY2hhbmdlcyB0byB0aGUgZGF0YWJhc2UuCiAgICAgICAgICAgIHByb3ZpZGVyLndyaXRlX3RyaWVfdXBkYXRlcyh1cGRhdGVzKT87CgogICAgICAgICAgICAvLyBVcGRhdGUgZW50aXRpZXMgY2hlY2twb2ludCB0byByZWZsZWN0IHRoZSB1bndpbmQgb3BlcmF0aW9uCiAgICAgICAgICAgIC8vIFNpbmNlIHdlJ3JlIHVud2luZGluZywgd2UgbmVlZCB0byByZWNhbGN1bGF0ZSB0aGUgdG90YWwgZW50aXRpZXMgYXQgdGhlIHRhcmdldCBibG9jawogICAgICAgICAgICBsZXQgYWNjb3VudHMgPSB0eC5lbnRyaWVzOjo8dGFibGVzOjpIYXNoZWRBY2NvdW50cz4oKT87CiAgICAgICAgICAgIGxldCBzdG9yYWdlcyA9IHR4LmVudHJpZXM6Ojx0YWJsZXM6Okhhc2hlZFN0b3JhZ2VzPigpPzsKICAgICAgICAgICAgbGV0IHRvdGFsID0gKGFjY291bnRzICsgc3RvcmFnZXMpIGFzIHU2NDsKICAgICAgICAgICAgZW50aXRpZXNfY2hlY2twb2ludC50b3RhbCA9IHRvdGFsOwogICAgICAgICAgICBlbnRpdGllc19jaGVja3BvaW50LnByb2Nlc3NlZCA9IHRvdGFsOwogICAgICAgIH0KCiAgICAgICAgT2soVW53aW5kT3V0cHV0IHsKICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoaW5wdXQudW53aW5kX3RvKQogICAgICAgICAgICAgICAgLndpdGhfZW50aXRpZXNfc3RhZ2VfY2hlY2twb2ludChlbnRpdGllc19jaGVja3BvaW50KSwKICAgICAgICB9KQogICAgfQp9CgovLy8gQ2hlY2sgdGhhdCB0aGUgY29tcHV0ZWQgc3RhdGUgcm9vdCBtYXRjaGVzIHRoZSByb290IGluIHRoZSBleHBlY3RlZCBoZWFkZXIuCiNbaW5saW5lXQpmbiB2YWxpZGF0ZV9zdGF0ZV9yb290PEg6IEJsb2NrSGVhZGVyICsgU2VhbGFibGUgKyBEZWJ1Zz4oCiAgICBnb3Q6IEIyNTYsCiAgICBleHBlY3RlZDogU2VhbGVkSGVhZGVyPEg+LAogICAgdGFyZ2V0X2Jsb2NrOiBCbG9ja051bWJlciwKKSAtPiBSZXN1bHQ8KCksIFN0YWdlRXJyb3I+IHsKICAgIGlmIGdvdCA9PSBleHBlY3RlZC5zdGF0ZV9yb290KCkgewogICAgICAgIE9rKCgpKQogICAgfSBlbHNlIHsKICAgICAgICBlcnJvciEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjptZXJrbGUiLCA/dGFyZ2V0X2Jsb2NrLCA/Z290LCA/ZXhwZWN0ZWQsICJGYWlsZWQgdG8gdmVyaWZ5IGJsb2NrIHN0YXRlIHJvb3QhIHtJTlZBTElEX1NUQVRFX1JPT1RfRVJST1JfTUVTU0FHRX0iKTsKICAgICAgICBFcnIoU3RhZ2VFcnJvcjo6QmxvY2sgewogICAgICAgICAgICBlcnJvcjogQmxvY2tFcnJvcktpbmQ6OlZhbGlkYXRpb24oQ29uc2Vuc3VzRXJyb3I6OkJvZHlTdGF0ZVJvb3REaWZmKAogICAgICAgICAgICAgICAgR290RXhwZWN0ZWQgeyBnb3QsIGV4cGVjdGVkOiBleHBlY3RlZC5zdGF0ZV9yb290KCkgfS5pbnRvKCksCiAgICAgICAgICAgICkpLAogICAgICAgICAgICBibG9jazogQm94OjpuZXcoZXhwZWN0ZWQuYmxvY2tfd2l0aF9wYXJlbnQoKSksCiAgICAgICAgfSkKICAgIH0KfQoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6Oio7CiAgICB1c2UgY3JhdGU6OnRlc3RfdXRpbHM6OnsKICAgICAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCwgRXhlY3V0ZVN0YWdlVGVzdFJ1bm5lciwgU3RhZ2VUZXN0UnVubmVyLCBTdG9yYWdlS2luZCwKICAgICAgICBUZXN0UnVubmVyRXJyb3IsIFRlc3RTdGFnZURCLCBVbndpbmRTdGFnZVRlc3RSdW5uZXIsCiAgICB9OwogICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OntrZWNjYWsyNTYsIFUyNTZ9OwogICAgdXNlIGFzc2VydF9tYXRjaGVzOjphc3NlcnRfbWF0Y2hlczsKICAgIHVzZSByZXRoX2RiX2FwaTo6Y3Vyc29yOjp7RGJDdXJzb3JSTywgRGJDdXJzb3JSVywgRGJEdXBDdXJzb3JST307CiAgICB1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6e1NlYWxlZEJsb2NrLCBTdG9yYWdlRW50cnl9OwogICAgdXNlIHJldGhfcHJvdmlkZXI6Ontwcm92aWRlcnM6OlN0YXRpY0ZpbGVXcml0ZXIsIFN0YXRpY0ZpbGVQcm92aWRlckZhY3Rvcnl9OwogICAgdXNlIHJldGhfc3RhZ2VzX2FwaTo6U3RhZ2VVbml0Q2hlY2twb2ludDsKICAgIHVzZSByZXRoX3N0YXRpY19maWxlX3R5cGVzOjpTdGF0aWNGaWxlU2VnbWVudDsKICAgIHVzZSByZXRoX3Rlc3RpbmdfdXRpbHM6OmdlbmVyYXRvcnM6OnsKICAgICAgICBzZWxmLCByYW5kb21fYmxvY2ssIHJhbmRvbV9ibG9ja19yYW5nZSwgcmFuZG9tX2NoYW5nZXNldF9yYW5nZSwKICAgICAgICByYW5kb21fY29udHJhY3RfYWNjb3VudF9yYW5nZSwgQmxvY2tQYXJhbXMsIEJsb2NrUmFuZ2VQYXJhbXMsCiAgICB9OwogICAgdXNlIHJldGhfdHJpZTo6dGVzdF91dGlsczo6e3N0YXRlX3Jvb3QsIHN0YXRlX3Jvb3RfcHJlaGFzaGVkfTsKICAgIHVzZSBzdGQ6OmNvbGxlY3Rpb25zOjpCVHJlZU1hcDsKCiAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCEoTWVya2xlVGVzdFJ1bm5lciwgbWVya2xlKTsKCiAgICAvLy8gRXhlY3V0ZSBmcm9tIGdlbmVzaXMgc28gYXMgdG8gbWVya2VsaXplIHdob2xlIHN0YXRlCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gZXhlY3V0ZV9jbGVhbl9tZXJrbGUoKSB7CiAgICAgICAgbGV0IChwcmV2aW91c19zdGFnZSwgc3RhZ2VfcHJvZ3Jlc3MpID0gKDUwMCwgMCk7CgogICAgICAgIC8vIFNldCB1cCB0aGUgcnVubmVyCiAgICAgICAgbGV0IG11dCBydW5uZXIgPSBNZXJrbGVUZXN0UnVubmVyOjpkZWZhdWx0KCk7CiAgICAgICAgLy8gc2V0IGxvdyB0aHJlc2hvbGQgc28gd2UgaGFzaCB0aGUgd2hvbGUgc3RvcmFnZQogICAgICAgIGxldCBpbnB1dCA9IEV4ZWNJbnB1dCB7CiAgICAgICAgICAgIHRhcmdldDogU29tZShwcmV2aW91c19zdGFnZSksCiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VDaGVja3BvaW50OjpuZXcoc3RhZ2VfcHJvZ3Jlc3MpKSwKICAgICAgICB9OwoKICAgICAgICBydW5uZXIuc2VlZF9leGVjdXRpb24oaW5wdXQpLmV4cGVjdCgiZmFpbGVkIHRvIHNlZWQgZXhlY3V0aW9uIik7CgogICAgICAgIGxldCByeCA9IHJ1bm5lci5leGVjdXRlKGlucHV0KTsKCiAgICAgICAgLy8gQXNzZXJ0IHRoZSBzdWNjZXNzZnVsIHJlc3VsdAogICAgICAgIGxldCByZXN1bHQgPSByeC5hd2FpdC51bndyYXAoKTsKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoCiAgICAgICAgICAgIHJlc3VsdCwKICAgICAgICAgICAgT2soRXhlY091dHB1dCB7CiAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgIGJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50OiBTb21lKFN0YWdlVW5pdENoZWNrcG9pbnQ6OkVudGl0aWVzKEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZCwKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWwKICAgICAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkb25lOiB0cnVlCiAgICAgICAgICAgIH0pIGlmIGJsb2NrX251bWJlciA9PSBwcmV2aW91c19zdGFnZSAmJiBwcm9jZXNzZWQgPT0gdG90YWwgJiYKICAgICAgICAgICAgICAgIHRvdGFsID09ICgKICAgICAgICAgICAgICAgICAgICBydW5uZXIuZGIuY291bnRfZW50cmllczo6PHRhYmxlczo6SGFzaGVkQWNjb3VudHM+KCkudW53cmFwKCkgKwogICAgICAgICAgICAgICAgICAgIHJ1bm5lci5kYi5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpIYXNoZWRTdG9yYWdlcz4oKS51bndyYXAoKQogICAgICAgICAgICAgICAgKSBhcyB1NjQKICAgICAgICApOwoKICAgICAgICAvLyBWYWxpZGF0ZSB0aGUgc3RhZ2UgZXhlY3V0aW9uCiAgICAgICAgYXNzZXJ0IShydW5uZXIudmFsaWRhdGVfZXhlY3V0aW9uKGlucHV0LCByZXN1bHQub2soKSkuaXNfb2soKSwgImV4ZWN1dGlvbiB2YWxpZGF0aW9uIik7CiAgICB9CgogICAgLy8vIFVwZGF0ZSBzbWFsbCB0cmllCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gZXhlY3V0ZV9zbWFsbF9tZXJrbGUoKSB7CiAgICAgICAgbGV0IChwcmV2aW91c19zdGFnZSwgc3RhZ2VfcHJvZ3Jlc3MpID0gKDIsIDEpOwoKICAgICAgICAvLyBTZXQgdXAgdGhlIHJ1bm5lcgogICAgICAgIGxldCBtdXQgcnVubmVyID0gTWVya2xlVGVzdFJ1bm5lcjo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBpbnB1dCA9IEV4ZWNJbnB1dCB7CiAgICAgICAgICAgIHRhcmdldDogU29tZShwcmV2aW91c19zdGFnZSksCiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VDaGVja3BvaW50OjpuZXcoc3RhZ2VfcHJvZ3Jlc3MpKSwKICAgICAgICB9OwoKICAgICAgICBydW5uZXIuc2VlZF9leGVjdXRpb24oaW5wdXQpLmV4cGVjdCgiZmFpbGVkIHRvIHNlZWQgZXhlY3V0aW9uIik7CgogICAgICAgIGxldCByeCA9IHJ1bm5lci5leGVjdXRlKGlucHV0KTsKCiAgICAgICAgLy8gQXNzZXJ0IHRoZSBzdWNjZXNzZnVsIHJlc3VsdAogICAgICAgIGxldCByZXN1bHQgPSByeC5hd2FpdC51bndyYXAoKTsKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoCiAgICAgICAgICAgIHJlc3VsdCwKICAgICAgICAgICAgT2soRXhlY091dHB1dCB7CiAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgIGJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50OiBTb21lKFN0YWdlVW5pdENoZWNrcG9pbnQ6OkVudGl0aWVzKEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZCwKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWwKICAgICAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkb25lOiB0cnVlCiAgICAgICAgICAgIH0pIGlmIGJsb2NrX251bWJlciA9PSBwcmV2aW91c19zdGFnZSAmJiBwcm9jZXNzZWQgPT0gdG90YWwgJiYKICAgICAgICAgICAgICAgIHRvdGFsID09ICgKICAgICAgICAgICAgICAgICAgICBydW5uZXIuZGIuY291bnRfZW50cmllczo6PHRhYmxlczo6SGFzaGVkQWNjb3VudHM+KCkudW53cmFwKCkgKwogICAgICAgICAgICAgICAgICAgIHJ1bm5lci5kYi5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpIYXNoZWRTdG9yYWdlcz4oKS51bndyYXAoKQogICAgICAgICAgICAgICAgKSBhcyB1NjQKICAgICAgICApOwoKICAgICAgICAvLyBWYWxpZGF0ZSB0aGUgc3RhZ2UgZXhlY3V0aW9uCiAgICAgICAgYXNzZXJ0IShydW5uZXIudmFsaWRhdGVfZXhlY3V0aW9uKGlucHV0LCByZXN1bHQub2soKSkuaXNfb2soKSwgImV4ZWN1dGlvbiB2YWxpZGF0aW9uIik7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGV4ZWN1dGVfY2h1bmtlZF9tZXJrbGUoKSB7CiAgICAgICAgbGV0IChwcmV2aW91c19zdGFnZSwgc3RhZ2VfcHJvZ3Jlc3MpID0gKDIwMCwgMTAwKTsKICAgICAgICBsZXQgY2xlYW5fdGhyZXNob2xkID0gMTAwOwogICAgICAgIGxldCBpbmNyZW1lbnRhbF90aHJlc2hvbGQgPSAxMDsKCiAgICAgICAgLy8gU2V0IHVwIHRoZSBydW5uZXIKICAgICAgICBsZXQgbXV0IHJ1bm5lciA9CiAgICAgICAgICAgIE1lcmtsZVRlc3RSdW5uZXIgeyBkYjogVGVzdFN0YWdlREI6OmRlZmF1bHQoKSwgY2xlYW5fdGhyZXNob2xkLCBpbmNyZW1lbnRhbF90aHJlc2hvbGQgfTsKCiAgICAgICAgbGV0IGlucHV0ID0gRXhlY0lucHV0IHsKICAgICAgICAgICAgdGFyZ2V0OiBTb21lKHByZXZpb3VzX3N0YWdlKSwKICAgICAgICAgICAgY2hlY2twb2ludDogU29tZShTdGFnZUNoZWNrcG9pbnQ6Om5ldyhzdGFnZV9wcm9ncmVzcykpLAogICAgICAgIH07CgogICAgICAgIHJ1bm5lci5zZWVkX2V4ZWN1dGlvbihpbnB1dCkuZXhwZWN0KCJmYWlsZWQgdG8gc2VlZCBleGVjdXRpb24iKTsKICAgICAgICBsZXQgcnggPSBydW5uZXIuZXhlY3V0ZShpbnB1dCk7CgogICAgICAgIC8vIEFzc2VydCB0aGUgc3VjY2Vzc2Z1bCByZXN1bHQKICAgICAgICBsZXQgcmVzdWx0ID0gcnguYXdhaXQudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKAogICAgICAgICAgICByZXN1bHQsCiAgICAgICAgICAgIE9rKEV4ZWNPdXRwdXQgewogICAgICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICBibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfY2hlY2twb2ludDogU29tZShTdGFnZVVuaXRDaGVja3BvaW50OjpFbnRpdGllcyhFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsCiAgICAgICAgICAgICAgICAgICAgfSkpCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZG9uZTogdHJ1ZQogICAgICAgICAgICB9KSBpZiBibG9ja19udW1iZXIgPT0gcHJldmlvdXNfc3RhZ2UgJiYgcHJvY2Vzc2VkID09IHRvdGFsICYmCiAgICAgICAgICAgICAgICB0b3RhbCA9PSAoCiAgICAgICAgICAgICAgICAgICAgcnVubmVyLmRiLmNvdW50X2VudHJpZXM6Ojx0YWJsZXM6Okhhc2hlZEFjY291bnRzPigpLnVud3JhcCgpICsKICAgICAgICAgICAgICAgICAgICBydW5uZXIuZGIuY291bnRfZW50cmllczo6PHRhYmxlczo6SGFzaGVkU3RvcmFnZXM+KCkudW53cmFwKCkKICAgICAgICAgICAgICAgICkgYXMgdTY0CiAgICAgICAgKTsKCiAgICAgICAgLy8gVmFsaWRhdGUgdGhlIHN0YWdlIGV4ZWN1dGlvbgogICAgICAgIGxldCBwcm92aWRlciA9IHJ1bm5lci5kYi5mYWN0b3J5LnByb3ZpZGVyKCkudW53cmFwKCk7CiAgICAgICAgbGV0IGhlYWRlciA9IHByb3ZpZGVyLmhlYWRlcl9ieV9udW1iZXIocHJldmlvdXNfc3RhZ2UpLnVud3JhcCgpLnVud3JhcCgpOwogICAgICAgIGxldCBleHBlY3RlZF9yb290ID0gaGVhZGVyLnN0YXRlX3Jvb3Q7CgogICAgICAgIGxldCBhY3R1YWxfcm9vdCA9IHJ1bm5lcgogICAgICAgICAgICAuZGIKICAgICAgICAgICAgLnF1ZXJ5X3dpdGhfcHJvdmlkZXIofHByb3ZpZGVyfCB7CiAgICAgICAgICAgICAgICBPayhTdGF0ZVJvb3Q6OmluY3JlbWVudGFsX3Jvb3Rfd2l0aF91cGRhdGVzKAogICAgICAgICAgICAgICAgICAgICZwcm92aWRlciwKICAgICAgICAgICAgICAgICAgICBzdGFnZV9wcm9ncmVzcyArIDEuLj1wcmV2aW91c19zdGFnZSwKICAgICAgICAgICAgICAgICkpCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgYWN0dWFsX3Jvb3QudW53cmFwKCkuMCwKICAgICAgICAgICAgZXhwZWN0ZWRfcm9vdCwKICAgICAgICAgICAgIlN0YXRlIHJvb3QgbWlzbWF0Y2ggYWZ0ZXIgY2h1bmtlZCBwcm9jZXNzaW5nIgogICAgICAgICk7CiAgICB9CgogICAgc3RydWN0IE1lcmtsZVRlc3RSdW5uZXIgewogICAgICAgIGRiOiBUZXN0U3RhZ2VEQiwKICAgICAgICBjbGVhbl90aHJlc2hvbGQ6IHU2NCwKICAgICAgICBpbmNyZW1lbnRhbF90aHJlc2hvbGQ6IHU2NCwKICAgIH0KCiAgICBpbXBsIERlZmF1bHQgZm9yIE1lcmtsZVRlc3RSdW5uZXIgewogICAgICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICAgICAgU2VsZiB7CiAgICAgICAgICAgICAgICBkYjogVGVzdFN0YWdlREI6OmRlZmF1bHQoKSwKICAgICAgICAgICAgICAgIGNsZWFuX3RocmVzaG9sZDogMTAwMDAsCiAgICAgICAgICAgICAgICBpbmNyZW1lbnRhbF90aHJlc2hvbGQ6IDEwMDAwLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGltcGwgU3RhZ2VUZXN0UnVubmVyIGZvciBNZXJrbGVUZXN0UnVubmVyIHsKICAgICAgICB0eXBlIFMgPSBNZXJrbGVTdGFnZTsKCiAgICAgICAgZm4gZGIoJnNlbGYpIC0+ICZUZXN0U3RhZ2VEQiB7CiAgICAgICAgICAgICZzZWxmLmRiCiAgICAgICAgfQoKICAgICAgICBmbiBzdGFnZSgmc2VsZikgLT4gU2VsZjo6UyB7CiAgICAgICAgICAgIFNlbGY6OlM6OkJvdGggewogICAgICAgICAgICAgICAgcmVidWlsZF90aHJlc2hvbGQ6IHNlbGYuY2xlYW5fdGhyZXNob2xkLAogICAgICAgICAgICAgICAgaW5jcmVtZW50YWxfdGhyZXNob2xkOiBzZWxmLmluY3JlbWVudGFsX3RocmVzaG9sZCwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpbXBsIEV4ZWN1dGVTdGFnZVRlc3RSdW5uZXIgZm9yIE1lcmtsZVRlc3RSdW5uZXIgewogICAgICAgIHR5cGUgU2VlZCA9IFZlYzxTZWFsZWRCbG9jazxyZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrPj47CgogICAgICAgIGZuIHNlZWRfZXhlY3V0aW9uKCZtdXQgc2VsZiwgaW5wdXQ6IEV4ZWNJbnB1dCkgLT4gUmVzdWx0PFNlbGY6OlNlZWQsIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICBsZXQgc3RhZ2VfcHJvZ3Jlc3MgPSBpbnB1dC5jaGVja3BvaW50KCkuYmxvY2tfbnVtYmVyOwogICAgICAgICAgICBsZXQgc3RhcnQgPSBzdGFnZV9wcm9ncmVzcyArIDE7CiAgICAgICAgICAgIGxldCBlbmQgPSBpbnB1dC50YXJnZXQoKTsKICAgICAgICAgICAgbGV0IG11dCBybmcgPSBnZW5lcmF0b3JzOjpybmcoKTsKCiAgICAgICAgICAgIGxldCBtdXQgcHJlYmxvY2tzID0gdmVjIVtdOwogICAgICAgICAgICBpZiBzdGFnZV9wcm9ncmVzcyA+IDAgewogICAgICAgICAgICAgICAgcHJlYmxvY2tzLmFwcGVuZCgmbXV0IHJhbmRvbV9ibG9ja19yYW5nZSgKICAgICAgICAgICAgICAgICAgICAmbXV0IHJuZywKICAgICAgICAgICAgICAgICAgICAwLi49c3RhZ2VfcHJvZ3Jlc3MgLSAxLAogICAgICAgICAgICAgICAgICAgIEJsb2NrUmFuZ2VQYXJhbXMgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IFNvbWUoQjI1Njo6WkVSTyksCiAgICAgICAgICAgICAgICAgICAgICAgIHR4X2NvdW50OiAwLi4xLAogICAgICAgICAgICAgICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X2Jsb2NrcyhwcmVibG9ja3MuaXRlcigpLCBTdG9yYWdlS2luZDo6U3RhdGljKT87CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBudW1fb2ZfYWNjb3VudHMgPSAzMTsKICAgICAgICAgICAgbGV0IGFjY291bnRzID0gcmFuZG9tX2NvbnRyYWN0X2FjY291bnRfcmFuZ2UoJm11dCBybmcsICZtdXQgKDAuLm51bV9vZl9hY2NvdW50cykpCiAgICAgICAgICAgICAgICAuaW50b19pdGVyKCkKICAgICAgICAgICAgICAgIC5jb2xsZWN0Ojo8QlRyZWVNYXA8XywgXz4+KCk7CgogICAgICAgICAgICBzZWxmLmRiLmluc2VydF9hY2NvdW50c19hbmRfc3RvcmFnZXMoCiAgICAgICAgICAgICAgICBhY2NvdW50cy5pdGVyKCkubWFwKHwoYWRkciwgYWNjKXwgKCphZGRyLCAoKmFjYywgc3RkOjppdGVyOjplbXB0eSgpKSkpLAogICAgICAgICAgICApPzsKCiAgICAgICAgICAgIGxldCAoaGVhZGVyLCBib2R5KSA9IHJhbmRvbV9ibG9jaygKICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgc3RhZ2VfcHJvZ3Jlc3MsCiAgICAgICAgICAgICAgICBCbG9ja1BhcmFtcyB7IHBhcmVudDogcHJlYmxvY2tzLmxhc3QoKS5tYXAofGJ8IGIuaGFzaCgpKSwgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfSwKICAgICAgICAgICAgKQogICAgICAgICAgICAuc3BsaXRfc2VhbGVkX2hlYWRlcl9ib2R5KCk7CiAgICAgICAgICAgIGxldCBtdXQgaGVhZGVyID0gaGVhZGVyLnVuc2VhbCgpOwoKICAgICAgICAgICAgaGVhZGVyLnN0YXRlX3Jvb3QgPSBzdGF0ZV9yb290KAogICAgICAgICAgICAgICAgYWNjb3VudHMKICAgICAgICAgICAgICAgICAgICAuY2xvbmUoKQogICAgICAgICAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAgICAgICAgIC5tYXAofChhZGRyZXNzLCBhY2NvdW50KXwgKGFkZHJlc3MsIChhY2NvdW50LCBzdGQ6Oml0ZXI6OmVtcHR5KCkpKSksCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGxldCBzZWFsZWRfaGVhZCA9IFNlYWxlZEJsb2NrOjo8cmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpCbG9jaz46OmZyb21fc2VhbGVkX3BhcnRzKAogICAgICAgICAgICAgICAgU2VhbGVkSGVhZGVyOjpzZWFsX3Nsb3coaGVhZGVyKSwKICAgICAgICAgICAgICAgIGJvZHksCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBsZXQgaGVhZF9oYXNoID0gc2VhbGVkX2hlYWQuaGFzaCgpOwogICAgICAgICAgICBsZXQgbXV0IGJsb2NrcyA9IHZlYyFbc2VhbGVkX2hlYWRdOwogICAgICAgICAgICBibG9ja3MuZXh0ZW5kKHJhbmRvbV9ibG9ja19yYW5nZSgKICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgc3RhcnQuLj1lbmQsCiAgICAgICAgICAgICAgICBCbG9ja1JhbmdlUGFyYW1zIHsgcGFyZW50OiBTb21lKGhlYWRfaGFzaCksIHR4X2NvdW50OiAwLi4zLCAuLkRlZmF1bHQ6OmRlZmF1bHQoKSB9LAogICAgICAgICAgICApKTsKICAgICAgICAgICAgbGV0IGxhc3RfYmxvY2sgPSBibG9ja3MubGFzdCgpLmNsb25lZCgpLnVud3JhcCgpOwogICAgICAgICAgICBzZWxmLmRiLmluc2VydF9ibG9ja3MoYmxvY2tzLml0ZXIoKSwgU3RvcmFnZUtpbmQ6OlN0YXRpYyk/OwoKICAgICAgICAgICAgbGV0ICh0cmFuc2l0aW9ucywgZmluYWxfc3RhdGUpID0gcmFuZG9tX2NoYW5nZXNldF9yYW5nZSgKICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgYmxvY2tzLml0ZXIoKSwKICAgICAgICAgICAgICAgIGFjY291bnRzLmludG9faXRlcigpLm1hcCh8KGFkZHIsIGFjYyl8IChhZGRyLCAoYWNjLCBWZWM6Om5ldygpKSkpLAogICAgICAgICAgICAgICAgMC4uMywKICAgICAgICAgICAgICAgIDAuLjI1NiwKICAgICAgICAgICAgKTsKICAgICAgICAgICAgLy8gYWRkIGJsb2NrIGNoYW5nZXNldCBmcm9tIGJsb2NrIDEuCiAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X2NoYW5nZXNldHModHJhbnNpdGlvbnMsIFNvbWUoc3RhcnQpKT87CiAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X2FjY291bnRzX2FuZF9zdG9yYWdlcyhmaW5hbF9zdGF0ZSk/OwoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHN0YXRlIHJvb3QKICAgICAgICAgICAgbGV0IHJvb3QgPSBzZWxmLmRiLnF1ZXJ5KHx0eHwgewogICAgICAgICAgICAgICAgbGV0IG11dCBhY2NvdW50cyA9IEJUcmVlTWFwOjpkZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBsZXQgbXV0IGFjY291bnRzX2N1cnNvciA9IHR4LmN1cnNvcl9yZWFkOjo8dGFibGVzOjpIYXNoZWRBY2NvdW50cz4oKT87CiAgICAgICAgICAgICAgICBsZXQgbXV0IHN0b3JhZ2VfY3Vyc29yID0gdHguY3Vyc29yX2R1cF9yZWFkOjo8dGFibGVzOjpIYXNoZWRTdG9yYWdlcz4oKT87CiAgICAgICAgICAgICAgICBmb3IgZW50cnkgaW4gYWNjb3VudHNfY3Vyc29yLndhbGtfcmFuZ2UoLi4pPyB7CiAgICAgICAgICAgICAgICAgICAgbGV0IChrZXksIGFjY291bnQpID0gZW50cnk/OwogICAgICAgICAgICAgICAgICAgIGxldCBtdXQgc3RvcmFnZV9lbnRyaWVzID0gVmVjOjpuZXcoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IGVudHJ5ID0gc3RvcmFnZV9jdXJzb3Iuc2Vla19leGFjdChrZXkpPzsKICAgICAgICAgICAgICAgICAgICB3aGlsZSBsZXQgU29tZSgoXywgc3RvcmFnZSkpID0gZW50cnkgewogICAgICAgICAgICAgICAgICAgICAgICBzdG9yYWdlX2VudHJpZXMucHVzaChzdG9yYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkgPSBzdG9yYWdlX2N1cnNvci5uZXh0X2R1cCgpPzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGV0IHN0b3JhZ2UgPSBzdG9yYWdlX2VudHJpZXMKICAgICAgICAgICAgICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIofHZ8ICF2LnZhbHVlLmlzX3plcm8oKSkKICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCh8dnwgKHYua2V5LCB2LnZhbHVlKSkKICAgICAgICAgICAgICAgICAgICAgICAgLmNvbGxlY3Q6OjxWZWM8Xz4+KCk7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudHMuaW5zZXJ0KGtleSwgKGFjY291bnQsIHN0b3JhZ2UpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBPayhzdGF0ZV9yb290X3ByZWhhc2hlZChhY2NvdW50cy5pbnRvX2l0ZXIoKSkpCiAgICAgICAgICAgIH0pPzsKCiAgICAgICAgICAgIGxldCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IHNlbGYuZGIuZmFjdG9yeS5zdGF0aWNfZmlsZV9wcm92aWRlcigpOwogICAgICAgICAgICBsZXQgbXV0IHdyaXRlciA9CiAgICAgICAgICAgICAgICBzdGF0aWNfZmlsZV9wcm92aWRlci5sYXRlc3Rfd3JpdGVyKFN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKS51bndyYXAoKTsKICAgICAgICAgICAgbGV0IG11dCBsYXN0X2hlYWRlciA9IGxhc3RfYmxvY2suY2xvbmVfc2VhbGVkX2hlYWRlcigpOwogICAgICAgICAgICBsYXN0X2hlYWRlci5zZXRfc3RhdGVfcm9vdChyb290KTsKCiAgICAgICAgICAgIGxldCBoYXNoID0gbGFzdF9oZWFkZXIuaGFzaF9zbG93KCk7CiAgICAgICAgICAgIHdyaXRlci5wcnVuZV9oZWFkZXJzKDEpLnVud3JhcCgpOwogICAgICAgICAgICB3cml0ZXIuY29tbWl0KCkudW53cmFwKCk7CiAgICAgICAgICAgIHdyaXRlci5hcHBlbmRfaGVhZGVyKCZsYXN0X2hlYWRlciwgJmhhc2gpLnVud3JhcCgpOwogICAgICAgICAgICB3cml0ZXIuY29tbWl0KCkudW53cmFwKCk7CgogICAgICAgICAgICBPayhibG9ja3MpCiAgICAgICAgfQoKICAgICAgICBmbiB2YWxpZGF0ZV9leGVjdXRpb24oCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBfaW5wdXQ6IEV4ZWNJbnB1dCwKICAgICAgICAgICAgX291dHB1dDogT3B0aW9uPEV4ZWNPdXRwdXQ+LAogICAgICAgICkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgLy8gVGhlIGV4ZWN1dGlvbiBpcyB2YWxpZGF0ZWQgd2l0aGluIHRoZSBzdGFnZQogICAgICAgICAgICBPaygoKSkKICAgICAgICB9CiAgICB9CgogICAgaW1wbCBVbndpbmRTdGFnZVRlc3RSdW5uZXIgZm9yIE1lcmtsZVRlc3RSdW5uZXIgewogICAgICAgIGZuIHZhbGlkYXRlX3Vud2luZCgmc2VsZiwgX2lucHV0OiBVbndpbmRJbnB1dCkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgLy8gVGhlIHVud2luZCBpcyB2YWxpZGF0ZWQgd2l0aGluIHRoZSBzdGFnZQogICAgICAgICAgICBPaygoKSkKICAgICAgICB9CgogICAgICAgIGZuIGJlZm9yZV91bndpbmQoJnNlbGYsIGlucHV0OiBVbndpbmRJbnB1dCkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgbGV0IHRhcmdldF9ibG9jayA9IGlucHV0LnVud2luZF90byArIDE7CgogICAgICAgICAgICBzZWxmLmRiCiAgICAgICAgICAgICAgICAuY29tbWl0KHx0eHwgewogICAgICAgICAgICAgICAgICAgIGxldCBtdXQgc3RvcmFnZV9jaGFuZ2VzZXRzX2N1cnNvciA9CiAgICAgICAgICAgICAgICAgICAgICAgIHR4LmN1cnNvcl9kdXBfcmVhZDo6PHRhYmxlczo6U3RvcmFnZUNoYW5nZVNldHM+KCkudW53cmFwKCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBzdG9yYWdlX2N1cnNvciA9CiAgICAgICAgICAgICAgICAgICAgICAgIHR4LmN1cnNvcl9kdXBfd3JpdGU6Ojx0YWJsZXM6Okhhc2hlZFN0b3JhZ2VzPigpLnVud3JhcCgpOwoKICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IHRyZWU6IEJUcmVlTWFwPEIyNTYsIEJUcmVlTWFwPEIyNTYsIFUyNTY+PiA9IEJUcmVlTWFwOjpuZXcoKTsKCiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCByZXZfY2hhbmdlc2V0X3dhbGtlciA9CiAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JhZ2VfY2hhbmdlc2V0c19jdXJzb3Iud2Fsa19iYWNrKE5vbmUpLnVud3JhcCgpOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIGxldCBTb21lKChibl9hZGRyZXNzLCBlbnRyeSkpID0KICAgICAgICAgICAgICAgICAgICAgICAgcmV2X2NoYW5nZXNldF93YWxrZXIubmV4dCgpLnRyYW5zcG9zZSgpLnVud3JhcCgpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiBibl9hZGRyZXNzLmJsb2NrX251bWJlcigpIDwgdGFyZ2V0X2Jsb2NrIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHRyZWUuZW50cnkoa2VjY2FrMjU2KGJuX2FkZHJlc3MuYWRkcmVzcygpKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5vcl9kZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5pbnNlcnQoa2VjY2FrMjU2KGVudHJ5LmtleSksIGVudHJ5LnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yIChoYXNoZWRfYWRkcmVzcywgc3RvcmFnZSkgaW4gdHJlZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaGFzaGVkX3Nsb3QsIHZhbHVlKSBpbiBzdG9yYWdlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdG9yYWdlX2VudHJ5ID0gc3RvcmFnZV9jdXJzb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2Vla19ieV9rZXlfc3Via2V5KGhhc2hlZF9hZGRyZXNzLCBoYXNoZWRfc2xvdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudW53cmFwKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzdG9yYWdlX2VudHJ5LmlzX3NvbWVfYW5kKHx2fCB2LmtleSA9PSBoYXNoZWRfc2xvdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JhZ2VfY3Vyc29yLmRlbGV0ZV9jdXJyZW50KCkudW53cmFwKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgIXZhbHVlLmlzX3plcm8oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHN0b3JhZ2VfZW50cnkgPSBTdG9yYWdlRW50cnkgeyBrZXk6IGhhc2hlZF9zbG90LCB2YWx1ZSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JhZ2VfY3Vyc29yLnVwc2VydChoYXNoZWRfYWRkcmVzcywgJnN0b3JhZ2VfZW50cnkpLnVud3JhcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IGNoYW5nZXNldF9jdXJzb3IgPQogICAgICAgICAgICAgICAgICAgICAgICB0eC5jdXJzb3JfZHVwX3dyaXRlOjo8dGFibGVzOjpBY2NvdW50Q2hhbmdlU2V0cz4oKS51bndyYXAoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IHJldl9jaGFuZ2VzZXRfd2Fsa2VyID0gY2hhbmdlc2V0X2N1cnNvci53YWxrX2JhY2soTm9uZSkudW53cmFwKCk7CgogICAgICAgICAgICAgICAgICAgIHdoaWxlIGxldCBTb21lKChibG9ja19udW1iZXIsIGFjY291bnRfYmVmb3JlX3R4KSkgPQogICAgICAgICAgICAgICAgICAgICAgICByZXZfY2hhbmdlc2V0X3dhbGtlci5uZXh0KCkudHJhbnNwb3NlKCkudW53cmFwKCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGJsb2NrX251bWJlciA8IHRhcmdldF9ibG9jayB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiBsZXQgU29tZShhY2MpID0gYWNjb3VudF9iZWZvcmVfdHguaW5mbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eC5wdXQ6Ojx0YWJsZXM6Okhhc2hlZEFjY291bnRzPigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZWNjYWsyNTYoYWNjb3VudF9iZWZvcmVfdHguYWRkcmVzcyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHguZGVsZXRlOjo8dGFibGVzOjpIYXNoZWRBY2NvdW50cz4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2VjY2FrMjU2KGFjY291bnRfYmVmb3JlX3R4LmFkZHJlc3MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudW53cmFwKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgT2soKCkpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgICAgICBPaygoKSkKICAgICAgICB9CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9zdGFnZXMvc3JjL3N0YWdlcy9wcnVuZS5ycyI+CnVzZSByZXRoX2RiX2FwaTo6e3RhYmxlOjpWYWx1ZSwgdHJhbnNhY3Rpb246OkRiVHhNdXR9Owp1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6Tm9kZVByaW1pdGl2ZXM7CnVzZSByZXRoX3Byb3ZpZGVyOjp7CiAgICBCbG9ja1JlYWRlciwgQ2hhaW5TdGF0ZUJsb2NrUmVhZGVyLCBEQlByb3ZpZGVyLCBQcnVuZUNoZWNrcG9pbnRSZWFkZXIsIFBydW5lQ2hlY2twb2ludFdyaXRlciwKICAgIFN0YWdlQ2hlY2twb2ludFJlYWRlciwgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwgU3RvcmFnZVNldHRpbmdzQ2FjaGUsCn07CnVzZSByZXRoX3BydW5lOjp7CiAgICBQcnVuZU1vZGUsIFBydW5lTW9kZXMsIFBydW5lU2VnbWVudCwgUHJ1bmVyQnVpbGRlciwgU2VnbWVudE91dHB1dCwgU2VnbWVudE91dHB1dENoZWNrcG9pbnQsCn07CnVzZSByZXRoX3N0YWdlc19hcGk6OnsKICAgIEV4ZWNJbnB1dCwgRXhlY091dHB1dCwgU3RhZ2UsIFN0YWdlQ2hlY2twb2ludCwgU3RhZ2VFcnJvciwgU3RhZ2VJZCwgVW53aW5kSW5wdXQsIFVud2luZE91dHB1dCwKfTsKdXNlIHRyYWNpbmc6OmluZm87CgovLy8gVGhlIHBydW5lIHN0YWdlIHRoYXQgcnVucyB0aGUgcHJ1bmVyIHdpdGggdGhlIHByb3ZpZGVkIHBydW5lIG1vZGVzLgovLy8KLy8vIFRoZXJlIGFyZSB0d28gbWFpbiByZWFzb25zIHRvIGhhdmUgdGhpcyBzdGFnZSB3aGVuIHJ1bm5pbmcgYSBmdWxsIG5vZGU6Ci8vLyAtIFNlbmRlciBSZWNvdmVyeSBzdGFnZSBpbnNlcnRzIGEgbG90IG9mIGRhdGEgaW50byB0aGUgZGF0YWJhc2UgdGhhdCdzIG9ubHkgbmVlZGVkIGZvciB0aGUKLy8vICAgRXhlY3V0aW9uIHN0YWdlLiBQcnVuZXIgd2lsbCBjbGVhbiB1cCB0aGUgdW5uZWVkZWQgcmVjb3ZlcmVkIHNlbmRlcnMuCi8vLyAtIFBydW5pbmcgZHVyaW5nIHRoZSBsaXZlIHN5bmMgY2FuIHRha2UgYSBzaWduaWZpY2FudCBhbW91bnQgb2YgdGltZSwgZXNwZWNpYWxseSBoaXN0b3J5Ci8vLyAgIHNlZ21lbnRzLiBJZiB3ZSBjYW4gcHJ1bmUgYXMgbXVjaCBkYXRhIGFzIHBvc3NpYmxlIGluIG9uZSBnbyBiZWZvcmUgc3RhcnRpbmcgdGhlIGxpdmUgc3luYywgd2UKLy8vICAgc2hvdWxkIGRvIGl0LgovLy8KLy8vIGBjb21taXRfdGhyZXNob2xkYCBpcyB0aGUgbWF4aW11bSBudW1iZXIgb2YgZW50cmllcyB0byBwcnVuZSBiZWZvcmUgY29tbWl0dGluZwovLy8gcHJvZ3Jlc3MgdG8gdGhlIGRhdGFiYXNlLgojW2Rlcml2ZShEZWJ1ZyldCnB1YiBzdHJ1Y3QgUHJ1bmVTdGFnZSB7CiAgICBwcnVuZV9tb2RlczogUHJ1bmVNb2RlcywKICAgIGNvbW1pdF90aHJlc2hvbGQ6IHVzaXplLAp9CgppbXBsIFBydW5lU3RhZ2UgewogICAgLy8vIENyYXRlIG5ldyBwcnVuZSBzdGFnZSB3aXRoIHRoZSBnaXZlbiBwcnVuZSBtb2RlcyBhbmQgY29tbWl0IHRocmVzaG9sZC4KICAgIHB1YiBjb25zdCBmbiBuZXcocHJ1bmVfbW9kZXM6IFBydW5lTW9kZXMsIGNvbW1pdF90aHJlc2hvbGQ6IHVzaXplKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgcHJ1bmVfbW9kZXMsIGNvbW1pdF90aHJlc2hvbGQgfQogICAgfQp9CgppbXBsPFByb3ZpZGVyPiBTdGFnZTxQcm92aWRlcj4gZm9yIFBydW5lU3RhZ2UKd2hlcmUKICAgIFByb3ZpZGVyOiBEQlByb3ZpZGVyPFR4OiBEYlR4TXV0PgogICAgICAgICsgUHJ1bmVDaGVja3BvaW50UmVhZGVyCiAgICAgICAgKyBQcnVuZUNoZWNrcG9pbnRXcml0ZXIKICAgICAgICArIEJsb2NrUmVhZGVyCiAgICAgICAgKyBDaGFpblN0YXRlQmxvY2tSZWFkZXIKICAgICAgICArIFN0YWdlQ2hlY2twb2ludFJlYWRlcgogICAgICAgICsgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeTwKICAgICAgICAgICAgUHJpbWl0aXZlczogTm9kZVByaW1pdGl2ZXM8U2lnbmVkVHg6IFZhbHVlLCBSZWNlaXB0OiBWYWx1ZSwgQmxvY2tIZWFkZXI6IFZhbHVlPiwKICAgICAgICA+ICsgU3RvcmFnZVNldHRpbmdzQ2FjaGUsCnsKICAgIGZuIGlkKCZzZWxmKSAtPiBTdGFnZUlkIHsKICAgICAgICBTdGFnZUlkOjpQcnVuZQogICAgfQoKICAgIGZuIGV4ZWN1dGUoJm11dCBzZWxmLCBwcm92aWRlcjogJlByb3ZpZGVyLCBpbnB1dDogRXhlY0lucHV0KSAtPiBSZXN1bHQ8RXhlY091dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIGxldCBtdXQgcHJ1bmVyID0gUHJ1bmVyQnVpbGRlcjo6ZGVmYXVsdCgpCiAgICAgICAgICAgIC5zZWdtZW50cyhzZWxmLnBydW5lX21vZGVzLmNsb25lKCkpCiAgICAgICAgICAgIC5kZWxldGVfbGltaXQoc2VsZi5jb21taXRfdGhyZXNob2xkKQogICAgICAgICAgICAuYnVpbGQ6OjxQcm92aWRlcj4ocHJvdmlkZXIuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKSk7CgogICAgICAgIGxldCByZXN1bHQgPSBwcnVuZXIucnVuX3dpdGhfcHJvdmlkZXIocHJvdmlkZXIsIGlucHV0LnRhcmdldCgpKT87CiAgICAgICAgaWYgcmVzdWx0LnByb2dyZXNzLmlzX2ZpbmlzaGVkKCkgewogICAgICAgICAgICBPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoaW5wdXQudGFyZ2V0KCkpLCBkb25lOiB0cnVlIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgbGV0IFNvbWUoKGxhc3Rfc2VnbWVudCwgbGFzdF9zZWdtZW50X291dHB1dCkpID0gcmVzdWx0LnNlZ21lbnRzLmxhc3QoKSB7CiAgICAgICAgICAgICAgICBtYXRjaCBsYXN0X3NlZ21lbnRfb3V0cHV0IHsKICAgICAgICAgICAgICAgICAgICBTZWdtZW50T3V0cHV0IHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgIHBydW5lZCwKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQgQCBTb21lKFNlZ21lbnRPdXRwdXRDaGVja3BvaW50IHsgYmxvY2tfbnVtYmVyOiBTb21lKF8pLCAuLiB9KSwKICAgICAgICAgICAgICAgICAgICB9ID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5mbyEoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OnBydW5lOjpleGVjIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgID9sYXN0X3NlZ21lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/cHJvZ3Jlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/cHJ1bmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgP2NoZWNrcG9pbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiTGFzdCBzZWdtZW50IGhhcyBtb3JlIGRhdGEgdG8gcHJ1bmUiCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgU2VnbWVudE91dHB1dCB7IHByb2dyZXNzLCBwcnVuZWQsIGNoZWNrcG9pbnQ6IF8gfSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZm8hKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpwcnVuZTo6ZXhlYyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/bGFzdF9zZWdtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgP3Byb2dyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgP3BydW5lZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJMYXN0IHNlZ21lbnQgaGFzIG1vcmUgZGF0YSB0byBwcnVuZSIKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBXZSBjYW5ub3Qgc2V0IHRoZSBjaGVja3BvaW50IHlldCwgYmVjYXVzZSBwcnVuZSBzZWdtZW50cyBtYXkgaGF2ZSBkaWZmZXJlbnQgaGlnaGVzdAogICAgICAgICAgICAvLyBwcnVuZWQgYmxvY2sgbnVtYmVycwogICAgICAgICAgICBPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogaW5wdXQuY2hlY2twb2ludCgpLCBkb25lOiBmYWxzZSB9KQogICAgICAgIH0KICAgIH0KCiAgICBmbiB1bndpbmQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICAgICAgaW5wdXQ6IFVud2luZElucHV0LAogICAgKSAtPiBSZXN1bHQ8VW53aW5kT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgLy8gV2UgY2Fubm90IHJlY292ZXIgdGhlIGRhdGEgdGhhdCB3YXMgcHJ1bmVkIGluIGBleGVjdXRlYCwgc28gd2UganVzdCB1cGRhdGUgdGhlCiAgICAgICAgLy8gY2hlY2twb2ludHMuCiAgICAgICAgbGV0IHBydW5lX2NoZWNrcG9pbnRzID0gcHJvdmlkZXIuZ2V0X3BydW5lX2NoZWNrcG9pbnRzKCk/OwogICAgICAgIGxldCB1bndpbmRfdG9fbGFzdF90eCA9CiAgICAgICAgICAgIHByb3ZpZGVyLmJsb2NrX2JvZHlfaW5kaWNlcyhpbnB1dC51bndpbmRfdG8pPy5tYXAofGl8IGkubGFzdF90eF9udW0oKSk7CgogICAgICAgIGZvciAoc2VnbWVudCwgbXV0IGNoZWNrcG9pbnQpIGluIHBydW5lX2NoZWNrcG9pbnRzIHsKICAgICAgICAgICAgLy8gT25seSB1cGRhdGUgdGhlIGNoZWNrcG9pbnQgaWYgdW53aW5kX3RvIGlzIGxvd2VyIHRoYW4gdGhlIGV4aXN0aW5nIGNoZWNrcG9pbnQuCiAgICAgICAgICAgIGlmIGxldCBTb21lKGJsb2NrKSA9IGNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyICYmCiAgICAgICAgICAgICAgICBpbnB1dC51bndpbmRfdG8gPCBibG9jawogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja3BvaW50LmJsb2NrX251bWJlciA9IFNvbWUoaW5wdXQudW53aW5kX3RvKTsKICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQudHhfbnVtYmVyID0gdW53aW5kX3RvX2xhc3RfdHg7CiAgICAgICAgICAgICAgICBwcm92aWRlci5zYXZlX3BydW5lX2NoZWNrcG9pbnQoc2VnbWVudCwgY2hlY2twb2ludCk/OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIE9rKFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KGlucHV0LnVud2luZF90bykgfSkKICAgIH0KfQoKLy8vIFRoZSBwcnVuZSBzZW5kZXIgcmVjb3Zlcnkgc3RhZ2UgdGhhdCBydW5zIHRoZSBwcnVuZXIgd2l0aCB0aGUgcHJvdmlkZWQgYFBydW5lTW9kZWAgZm9yIHRoZQovLy8gYFNlbmRlclJlY292ZXJ5YCBzZWdtZW50LgovLy8KLy8vIFVuZGVyIHRoZSBob29kLCB0aGlzIHN0YWdlIGhhcyB0aGUgc2FtZSBmdW5jdGlvbmFsaXR5IGFzIFtgUHJ1bmVTdGFnZWBdLgovLy8KLy8vIFNob3VsZCBiZSBydW4gcmlnaHQgYWZ0ZXIgYEV4ZWN1dGlvbmAsIHVubGlrZSBbYFBydW5lU3RhZ2VgXSB3aGljaCBydW5zIGF0IHRoZSBlbmQuCi8vLyBUaGlzIGxldHMgc3Vic2VxdWVudCBzdGFnZXMgcmV1c2UgdGhlIGZyZWVkIHBhZ2VzIGluc3RlYWQgb2YgZ3Jvd2luZyB0aGUgZnJlZWxpc3QuCiNbZGVyaXZlKERlYnVnKV0KcHViIHN0cnVjdCBQcnVuZVNlbmRlclJlY292ZXJ5U3RhZ2UoUHJ1bmVTdGFnZSk7CgppbXBsIFBydW5lU2VuZGVyUmVjb3ZlcnlTdGFnZSB7CiAgICAvLy8gQ3JlYXRlIG5ldyBwcnVuZSBzZW5kZXIgcmVjb3Zlcnkgc3RhZ2Ugd2l0aCB0aGUgZ2l2ZW4gcHJ1bmUgbW9kZSBhbmQgY29tbWl0IHRocmVzaG9sZC4KICAgIHB1YiBmbiBuZXcocHJ1bmVfbW9kZTogUHJ1bmVNb2RlLCBjb21taXRfdGhyZXNob2xkOiB1c2l6ZSkgLT4gU2VsZiB7CiAgICAgICAgU2VsZihQcnVuZVN0YWdlOjpuZXcoCiAgICAgICAgICAgIFBydW5lTW9kZXMgeyBzZW5kZXJfcmVjb3Zlcnk6IFNvbWUocHJ1bmVfbW9kZSksIC4uUHJ1bmVNb2Rlczo6ZGVmYXVsdCgpIH0sCiAgICAgICAgICAgIGNvbW1pdF90aHJlc2hvbGQsCiAgICAgICAgKSkKICAgIH0KfQoKaW1wbDxQcm92aWRlcj4gU3RhZ2U8UHJvdmlkZXI+IGZvciBQcnVuZVNlbmRlclJlY292ZXJ5U3RhZ2UKd2hlcmUKICAgIFByb3ZpZGVyOiBEQlByb3ZpZGVyPFR4OiBEYlR4TXV0PgogICAgICAgICsgUHJ1bmVDaGVja3BvaW50UmVhZGVyCiAgICAgICAgKyBQcnVuZUNoZWNrcG9pbnRXcml0ZXIKICAgICAgICArIEJsb2NrUmVhZGVyCiAgICAgICAgKyBDaGFpblN0YXRlQmxvY2tSZWFkZXIKICAgICAgICArIFN0YWdlQ2hlY2twb2ludFJlYWRlcgogICAgICAgICsgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeTwKICAgICAgICAgICAgUHJpbWl0aXZlczogTm9kZVByaW1pdGl2ZXM8U2lnbmVkVHg6IFZhbHVlLCBSZWNlaXB0OiBWYWx1ZSwgQmxvY2tIZWFkZXI6IFZhbHVlPiwKICAgICAgICA+ICsgU3RvcmFnZVNldHRpbmdzQ2FjaGUsCnsKICAgIGZuIGlkKCZzZWxmKSAtPiBTdGFnZUlkIHsKICAgICAgICBTdGFnZUlkOjpQcnVuZVNlbmRlclJlY292ZXJ5CiAgICB9CgogICAgZm4gZXhlY3V0ZSgmbXV0IHNlbGYsIHByb3ZpZGVyOiAmUHJvdmlkZXIsIGlucHV0OiBFeGVjSW5wdXQpIC0+IFJlc3VsdDxFeGVjT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgbGV0IG11dCByZXN1bHQgPSBzZWxmLjAuZXhlY3V0ZShwcm92aWRlciwgaW5wdXQpPzsKCiAgICAgICAgLy8gQWRqdXN0IHRoZSBjaGVja3BvaW50IHRvIHRoZSBoaWdoZXN0IHBydW5lZCBibG9jayBudW1iZXIgb2YgdGhlIFNlbmRlciBSZWNvdmVyeSBzZWdtZW50CiAgICAgICAgaWYgIXJlc3VsdC5kb25lIHsKICAgICAgICAgICAgbGV0IGNoZWNrcG9pbnQgPSBwcm92aWRlcgogICAgICAgICAgICAgICAgLmdldF9wcnVuZV9jaGVja3BvaW50KFBydW5lU2VnbWVudDo6U2VuZGVyUmVjb3ZlcnkpPwogICAgICAgICAgICAgICAgLm9rX29yKFN0YWdlRXJyb3I6Ok1pc3NpbmdQcnVuZUNoZWNrcG9pbnQoUHJ1bmVTZWdtZW50OjpTZW5kZXJSZWNvdmVyeSkpPzsKCiAgICAgICAgICAgIC8vIGB1bndyYXBfb3JfZGVmYXVsdGAgaXMgc2FmZSBiZWNhdXNlIHdlIGtub3cgdGhhdCBnZW5lc2lzIGJsb2NrIGRvZXNuJ3QgaGF2ZSBhbnkKICAgICAgICAgICAgLy8gdHJhbnNhY3Rpb25zIGFuZCBzZW5kZXJzCiAgICAgICAgICAgIHJlc3VsdC5jaGVja3BvaW50ID0gU3RhZ2VDaGVja3BvaW50OjpuZXcoY2hlY2twb2ludC5ibG9ja19udW1iZXIudW53cmFwX29yX2RlZmF1bHQoKSk7CiAgICAgICAgfQoKICAgICAgICBPayhyZXN1bHQpCiAgICB9CgogICAgZm4gdW53aW5kKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBwcm92aWRlcjogJlByb3ZpZGVyLAogICAgICAgIGlucHV0OiBVbndpbmRJbnB1dCwKICAgICkgLT4gUmVzdWx0PFVud2luZE91dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIHNlbGYuMC51bndpbmQocHJvdmlkZXIsIGlucHV0KQogICAgfQp9CgojW2NmZyh0ZXN0KV0KbW9kIHRlc3RzIHsKICAgIHVzZSBzdXBlcjo6KjsKICAgIHVzZSBjcmF0ZTo6dGVzdF91dGlsczo6ewogICAgICAgIHN0YWdlX3Rlc3Rfc3VpdGVfZXh0LCBFeGVjdXRlU3RhZ2VUZXN0UnVubmVyLCBTdGFnZVRlc3RSdW5uZXIsIFN0b3JhZ2VLaW5kLAogICAgICAgIFRlc3RSdW5uZXJFcnJvciwgVGVzdFN0YWdlREIsIFVud2luZFN0YWdlVGVzdFJ1bm5lciwKICAgIH07CiAgICB1c2UgYWxsb3lfcHJpbWl0aXZlczo6QjI1NjsKICAgIHVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrOwogICAgdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OntTZWFsZWRCbG9jaywgU2lnbmVyUmVjb3ZlcmFibGV9OwogICAgdXNlIHJldGhfcHJvdmlkZXI6OnsKICAgICAgICBwcm92aWRlcnM6OlN0YXRpY0ZpbGVXcml0ZXIsIFRyYW5zYWN0aW9uc1Byb3ZpZGVyLCBUcmFuc2FjdGlvbnNQcm92aWRlckV4dCwKICAgIH07CiAgICB1c2UgcmV0aF9wcnVuZTo6UHJ1bmVNb2RlOwogICAgdXNlIHJldGhfdGVzdGluZ191dGlsczo6Z2VuZXJhdG9yczo6e3NlbGYsIHJhbmRvbV9ibG9ja19yYW5nZSwgQmxvY2tSYW5nZVBhcmFtc307CgogICAgc3RhZ2VfdGVzdF9zdWl0ZV9leHQhKFBydW5lVGVzdFJ1bm5lciwgcHJ1bmUpOwoKICAgICNbZGVyaXZlKERlZmF1bHQpXQogICAgc3RydWN0IFBydW5lVGVzdFJ1bm5lciB7CiAgICAgICAgZGI6IFRlc3RTdGFnZURCLAogICAgfQoKICAgIGltcGwgU3RhZ2VUZXN0UnVubmVyIGZvciBQcnVuZVRlc3RSdW5uZXIgewogICAgICAgIHR5cGUgUyA9IFBydW5lU3RhZ2U7CgogICAgICAgIGZuIGRiKCZzZWxmKSAtPiAmVGVzdFN0YWdlREIgewogICAgICAgICAgICAmc2VsZi5kYgogICAgICAgIH0KCiAgICAgICAgZm4gc3RhZ2UoJnNlbGYpIC0+IFNlbGY6OlMgewogICAgICAgICAgICBQcnVuZVN0YWdlIHsKICAgICAgICAgICAgICAgIHBydW5lX21vZGVzOiBQcnVuZU1vZGVzIHsKICAgICAgICAgICAgICAgICAgICBzZW5kZXJfcmVjb3Zlcnk6IFNvbWUoUHJ1bmVNb2RlOjpGdWxsKSwKICAgICAgICAgICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNvbW1pdF90aHJlc2hvbGQ6IHVzaXplOjpNQVgsCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaW1wbCBFeGVjdXRlU3RhZ2VUZXN0UnVubmVyIGZvciBQcnVuZVRlc3RSdW5uZXIgewogICAgICAgIHR5cGUgU2VlZCA9IFZlYzxTZWFsZWRCbG9jazxCbG9jaz4+OwoKICAgICAgICBmbiBzZWVkX2V4ZWN1dGlvbigmbXV0IHNlbGYsIGlucHV0OiBFeGVjSW5wdXQpIC0+IFJlc3VsdDxTZWxmOjpTZWVkLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgbGV0IG11dCBybmcgPSBnZW5lcmF0b3JzOjpybmcoKTsKICAgICAgICAgICAgbGV0IGJsb2NrcyA9IHJhbmRvbV9ibG9ja19yYW5nZSgKICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlci4uPWlucHV0LnRhcmdldCgpLAogICAgICAgICAgICAgICAgQmxvY2tSYW5nZVBhcmFtcyB7IHBhcmVudDogU29tZShCMjU2OjpaRVJPKSwgdHhfY291bnQ6IDEuLjMsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X2Jsb2NrcyhibG9ja3MuaXRlcigpLCBTdG9yYWdlS2luZDo6U3RhdGljKT87CiAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X3RyYW5zYWN0aW9uX3NlbmRlcnMoCiAgICAgICAgICAgICAgICBibG9ja3MuaXRlcigpLmZsYXRfbWFwKHxibG9ja3wgYmxvY2suYm9keSgpLnRyYW5zYWN0aW9ucy5pdGVyKCkpLmVudW1lcmF0ZSgpLm1hcCgKICAgICAgICAgICAgICAgICAgICB8KGksIHR4KXwgKGkgYXMgdTY0LCB0eC5yZWNvdmVyX3NpZ25lcigpLmV4cGVjdCgiZmFpbGVkIHRvIHJlY292ZXIgc2lnbmVyIikpLAogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgKT87CiAgICAgICAgICAgIE9rKGJsb2NrcykKICAgICAgICB9CgogICAgICAgIGZuIHZhbGlkYXRlX2V4ZWN1dGlvbigKICAgICAgICAgICAgJnNlbGYsCiAgICAgICAgICAgIGlucHV0OiBFeGVjSW5wdXQsCiAgICAgICAgICAgIG91dHB1dDogT3B0aW9uPEV4ZWNPdXRwdXQ+LAogICAgICAgICkgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgaWYgbGV0IFNvbWUob3V0cHV0KSA9IG91dHB1dCB7CiAgICAgICAgICAgICAgICBsZXQgc3RhcnRfYmxvY2sgPSBpbnB1dC5uZXh0X2Jsb2NrKCk7CiAgICAgICAgICAgICAgICBsZXQgZW5kX2Jsb2NrID0gb3V0cHV0LmNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyOwoKICAgICAgICAgICAgICAgIGlmIHN0YXJ0X2Jsb2NrID4gZW5kX2Jsb2NrIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2soKCkpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGV0IHByb3ZpZGVyID0gc2VsZi5kYi5mYWN0b3J5LnByb3ZpZGVyKCk/OwoKICAgICAgICAgICAgICAgIGFzc2VydCEob3V0cHV0LmRvbmUpOwogICAgICAgICAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgICAgICAgICBvdXRwdXQuY2hlY2twb2ludC5ibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAgICAgLmdldF9wcnVuZV9jaGVja3BvaW50KFBydW5lU2VnbWVudDo6U2VuZGVyUmVjb3ZlcnkpPwogICAgICAgICAgICAgICAgICAgICAgICAuZXhwZWN0KCJwcnVuZSBjaGVja3BvaW50IG11c3QgZXhpc3QiKQogICAgICAgICAgICAgICAgICAgICAgICAuYmxvY2tfbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgICAgIC51bndyYXBfb3JfZGVmYXVsdCgpCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIC8vIFZlcmlmeSB0aGF0IHRoZSBzZW5kZXJzIGFyZSBwcnVuZWQKICAgICAgICAgICAgICAgIGxldCB0eF9yYW5nZSA9CiAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXIudHJhbnNhY3Rpb25fcmFuZ2VfYnlfYmxvY2tfcmFuZ2Uoc3RhcnRfYmxvY2suLj1lbmRfYmxvY2spPzsKICAgICAgICAgICAgICAgIGxldCBzZW5kZXJzID0gc2VsZi5kYi5mYWN0b3J5LnByb3ZpZGVyKCk/LnNlbmRlcnNfYnlfdHhfcmFuZ2UodHhfcmFuZ2UpPzsKICAgICAgICAgICAgICAgIGFzc2VydCEoc2VuZGVycy5pc19lbXB0eSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBPaygoKSkKICAgICAgICB9CiAgICB9CgogICAgaW1wbCBVbndpbmRTdGFnZVRlc3RSdW5uZXIgZm9yIFBydW5lVGVzdFJ1bm5lciB7CiAgICAgICAgZm4gdmFsaWRhdGVfdW53aW5kKCZzZWxmLCBfaW5wdXQ6IFVud2luZElucHV0KSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICBPaygoKSkKICAgICAgICB9CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9zdGFnZXMvc3JjL3N0YWdlcy90eF9sb29rdXAucnMiPgp1c2UgYWxsb3lfZWlwczo6ZWlwMjcxODo6RW5jb2RhYmxlMjcxODsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OntUeEhhc2gsIFR4TnVtYmVyfTsKdXNlIG51bV90cmFpdHM6Olplcm87CnVzZSByZXRoX2NvbmZpZzo6Y29uZmlnOjp7RXRsQ29uZmlnLCBUcmFuc2FjdGlvbkxvb2t1cENvbmZpZ307CnVzZSByZXRoX2RiX2FwaTo6ewogICAgdGFibGU6OntEZWNvZGUsIERlY29tcHJlc3MsIFZhbHVlfSwKICAgIHRhYmxlcywKICAgIHRyYW5zYWN0aW9uOjpEYlR4TXV0LAp9Owp1c2UgcmV0aF9ldGw6OkNvbGxlY3RvcjsKdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OntOb2RlUHJpbWl0aXZlcywgU2lnbmVkVHJhbnNhY3Rpb259Owp1c2UgcmV0aF9wcm92aWRlcjo6ewogICAgQmxvY2tSZWFkZXIsIERCUHJvdmlkZXIsIEVpdGhlcldyaXRlciwgUHJ1bmVDaGVja3BvaW50UmVhZGVyLCBQcnVuZUNoZWNrcG9pbnRXcml0ZXIsCiAgICBSb2Nrc0RCUHJvdmlkZXJGYWN0b3J5LCBTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5LCBTdGF0c1JlYWRlciwgU3RvcmFnZVNldHRpbmdzQ2FjaGUsCiAgICBUcmFuc2FjdGlvbnNQcm92aWRlciwgVHJhbnNhY3Rpb25zUHJvdmlkZXJFeHQsCn07CnVzZSByZXRoX3BydW5lX3R5cGVzOjp7UHJ1bmVDaGVja3BvaW50LCBQcnVuZU1vZGUsIFBydW5lUHVycG9zZSwgUHJ1bmVTZWdtZW50fTsKdXNlIHJldGhfc3RhZ2VzX2FwaTo6ewogICAgRW50aXRpZXNDaGVja3BvaW50LCBFeGVjSW5wdXQsIEV4ZWNPdXRwdXQsIFN0YWdlLCBTdGFnZUNoZWNrcG9pbnQsIFN0YWdlRXJyb3IsIFN0YWdlSWQsCiAgICBVbndpbmRJbnB1dCwgVW53aW5kT3V0cHV0LAp9Owp1c2UgcmV0aF9zdG9yYWdlX2Vycm9yczo6cHJvdmlkZXI6OlByb3ZpZGVyRXJyb3I7CnVzZSB0cmFjaW5nOjoqOwoKLy8vIFRoZSB0cmFuc2FjdGlvbiBsb29rdXAgc3RhZ2UuCi8vLwovLy8gVGhpcyBzdGFnZSB3YWxrcyBvdmVyIGV4aXN0aW5nIHRyYW5zYWN0aW9ucywgYW5kIHNldHMgdGhlIHRyYW5zYWN0aW9uIGhhc2ggb2YgZWFjaCB0cmFuc2FjdGlvbgovLy8gaW4gYSBibG9jayB0byB0aGUgY29ycmVzcG9uZGluZyBgQmxvY2tOdW1iZXJgIGF0IGVhY2ggYmxvY2suIFRoaXMgaXMgd3JpdHRlbiB0byB0aGUKLy8vIFtgdGFibGVzOjpUcmFuc2FjdGlvbkhhc2hOdW1iZXJzYF0gVGhpcyBpcyB1c2VkIGZvciBsb29raW5nIHVwIGNoYW5nZXNldHMgdmlhIHRoZSB0cmFuc2FjdGlvbgovLy8gaGFzaC4KLy8vCi8vLyBJdCB1c2VzIFtgcmV0aF9ldGw6OkNvbGxlY3RvcmBdIHRvIGNvbGxlY3QgYWxsIGVudHJpZXMgYmVmb3JlIGZpbmFsbHkgd3JpdGluZyB0aGVtIHRvIGRpc2suCiNbZGVyaXZlKERlYnVnLCBDbG9uZSldCnB1YiBzdHJ1Y3QgVHJhbnNhY3Rpb25Mb29rdXBTdGFnZSB7CiAgICAvLy8gVGhlIG1heGltdW0gbnVtYmVyIG9mIGxvb2t1cCBlbnRyaWVzIHRvIGhvbGQgaW4gbWVtb3J5IGJlZm9yZSBwdXNoaW5nIHRoZW0gdG8KICAgIC8vLyBbYHJldGhfZXRsOjpDb2xsZWN0b3JgXS4KICAgIGNodW5rX3NpemU6IHU2NCwKICAgIGV0bF9jb25maWc6IEV0bENvbmZpZywKICAgIHBydW5lX21vZGU6IE9wdGlvbjxQcnVuZU1vZGU+LAp9CgppbXBsIERlZmF1bHQgZm9yIFRyYW5zYWN0aW9uTG9va3VwU3RhZ2UgewogICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBjaHVua19zaXplOiA1XzAwMF8wMDAsIGV0bF9jb25maWc6IEV0bENvbmZpZzo6ZGVmYXVsdCgpLCBwcnVuZV9tb2RlOiBOb25lIH0KICAgIH0KfQoKaW1wbCBUcmFuc2FjdGlvbkxvb2t1cFN0YWdlIHsKICAgIC8vLyBDcmVhdGUgbmV3IGluc3RhbmNlIG9mIFtgVHJhbnNhY3Rpb25Mb29rdXBTdGFnZWBdLgogICAgcHViIGNvbnN0IGZuIG5ldygKICAgICAgICBjb25maWc6IFRyYW5zYWN0aW9uTG9va3VwQ29uZmlnLAogICAgICAgIGV0bF9jb25maWc6IEV0bENvbmZpZywKICAgICAgICBwcnVuZV9tb2RlOiBPcHRpb248UHJ1bmVNb2RlPiwKICAgICkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGNodW5rX3NpemU6IGNvbmZpZy5jaHVua19zaXplLCBldGxfY29uZmlnLCBwcnVuZV9tb2RlIH0KICAgIH0KfQoKaW1wbDxQcm92aWRlcj4gU3RhZ2U8UHJvdmlkZXI+IGZvciBUcmFuc2FjdGlvbkxvb2t1cFN0YWdlCndoZXJlCiAgICBQcm92aWRlcjogREJQcm92aWRlcjxUeDogRGJUeE11dD4KICAgICAgICArIFBydW5lQ2hlY2twb2ludFdyaXRlcgogICAgICAgICsgQmxvY2tSZWFkZXIKICAgICAgICArIFBydW5lQ2hlY2twb2ludFJlYWRlcgogICAgICAgICsgU3RhdHNSZWFkZXIKICAgICAgICArIFN0YXRpY0ZpbGVQcm92aWRlckZhY3Rvcnk8UHJpbWl0aXZlczogTm9kZVByaW1pdGl2ZXM8U2lnbmVkVHg6IFZhbHVlICsgU2lnbmVkVHJhbnNhY3Rpb24+PgogICAgICAgICsgVHJhbnNhY3Rpb25zUHJvdmlkZXJFeHQKICAgICAgICArIFN0b3JhZ2VTZXR0aW5nc0NhY2hlCiAgICAgICAgKyBSb2Nrc0RCUHJvdmlkZXJGYWN0b3J5LAp7CiAgICAvLy8gUmV0dXJuIHRoZSBpZCBvZiB0aGUgc3RhZ2UKICAgIGZuIGlkKCZzZWxmKSAtPiBTdGFnZUlkIHsKICAgICAgICBTdGFnZUlkOjpUcmFuc2FjdGlvbkxvb2t1cAogICAgfQoKICAgIC8vLyBXcml0ZSB0cmFuc2FjdGlvbiBoYXNoIC0+IGlkIGVudHJpZXMKICAgIGZuIGV4ZWN1dGUoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICAgICAgbXV0IGlucHV0OiBFeGVjSW5wdXQsCiAgICApIC0+IFJlc3VsdDxFeGVjT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgaWYgbGV0IFNvbWUoKHRhcmdldF9wcnVuYWJsZV9ibG9jaywgcHJ1bmVfbW9kZSkpID0gc2VsZgogICAgICAgICAgICAucHJ1bmVfbW9kZQogICAgICAgICAgICAubWFwKHxtb2RlfCB7CiAgICAgICAgICAgICAgICBtb2RlLnBydW5lX3RhcmdldF9ibG9jaygKICAgICAgICAgICAgICAgICAgICBpbnB1dC50YXJnZXQoKSwKICAgICAgICAgICAgICAgICAgICBQcnVuZVNlZ21lbnQ6OlRyYW5zYWN0aW9uTG9va3VwLAogICAgICAgICAgICAgICAgICAgIFBydW5lUHVycG9zZTo6VXNlciwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnRyYW5zcG9zZSgpPwogICAgICAgICAgICAuZmxhdHRlbigpICYmCiAgICAgICAgICAgIHRhcmdldF9wcnVuYWJsZV9ibG9jayA+IGlucHV0LmNoZWNrcG9pbnQoKS5ibG9ja19udW1iZXIKICAgICAgICB7CiAgICAgICAgICAgIGlucHV0LmNoZWNrcG9pbnQgPSBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KHRhcmdldF9wcnVuYWJsZV9ibG9jaykpOwoKICAgICAgICAgICAgLy8gU2F2ZSBwcnVuZSBjaGVja3BvaW50IG9ubHkgaWYgd2UgZG9uJ3QgaGF2ZSBvbmUgYWxyZWFkeS4KICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBwcnVuZXIgbWF5IHNraXAgdGhlIHVucHJ1bmVkIHJhbmdlIG9mIGJsb2Nrcy4KICAgICAgICAgICAgaWYgcHJvdmlkZXIuZ2V0X3BydW5lX2NoZWNrcG9pbnQoUHJ1bmVTZWdtZW50OjpUcmFuc2FjdGlvbkxvb2t1cCk/LmlzX25vbmUoKSB7CiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0X3BydW5hYmxlX3R4X251bWJlciA9IHByb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgLmJsb2NrX2JvZHlfaW5kaWNlcyh0YXJnZXRfcHJ1bmFibGVfYmxvY2spPwogICAgICAgICAgICAgICAgICAgIC5va19vcihQcm92aWRlckVycm9yOjpCbG9ja0JvZHlJbmRpY2VzTm90Rm91bmQodGFyZ2V0X3BydW5hYmxlX2Jsb2NrKSk/CiAgICAgICAgICAgICAgICAgICAgLmxhc3RfdHhfbnVtKCk7CgogICAgICAgICAgICAgICAgcHJvdmlkZXIuc2F2ZV9wcnVuZV9jaGVja3BvaW50KAogICAgICAgICAgICAgICAgICAgIFBydW5lU2VnbWVudDo6VHJhbnNhY3Rpb25Mb29rdXAsCiAgICAgICAgICAgICAgICAgICAgUHJ1bmVDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiBTb21lKHRhcmdldF9wcnVuYWJsZV9ibG9jayksCiAgICAgICAgICAgICAgICAgICAgICAgIHR4X251bWJlcjogU29tZSh0YXJnZXRfcHJ1bmFibGVfdHhfbnVtYmVyKSwKICAgICAgICAgICAgICAgICAgICAgICAgcHJ1bmVfbW9kZSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgKT87CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgaW5wdXQudGFyZ2V0X3JlYWNoZWQoKSB7CiAgICAgICAgICAgIHJldHVybiBPayhFeGVjT3V0cHV0Ojpkb25lKGlucHV0LmNoZWNrcG9pbnQoKSkpOwogICAgICAgIH0KCiAgICAgICAgLy8gNTAwTUIgdGVtcG9yYXJ5IGZpbGVzCiAgICAgICAgbGV0IG11dCBoYXNoX2NvbGxlY3RvcjogQ29sbGVjdG9yPFR4SGFzaCwgVHhOdW1iZXI+ID0KICAgICAgICAgICAgQ29sbGVjdG9yOjpuZXcoc2VsZi5ldGxfY29uZmlnLmZpbGVfc2l6ZSwgc2VsZi5ldGxfY29uZmlnLmRpci5jbG9uZSgpKTsKCiAgICAgICAgaW5mbyEoCiAgICAgICAgICAgIHRhcmdldDogInN5bmM6OnN0YWdlczo6dHJhbnNhY3Rpb25fbG9va3VwIiwKICAgICAgICAgICAgdHhfcmFuZ2UgPSA/aW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlci4uPWlucHV0LnRhcmdldCgpLAogICAgICAgICAgICAiVXBkYXRpbmcgdHJhbnNhY3Rpb24gbG9va3VwIgogICAgICAgICk7CgogICAgICAgIGxvb3AgewogICAgICAgICAgICBsZXQgU29tZShyYW5nZV9vdXRwdXQpID0KICAgICAgICAgICAgICAgIGlucHV0Lm5leHRfYmxvY2tfcmFuZ2Vfd2l0aF90cmFuc2FjdGlvbl90aHJlc2hvbGQocHJvdmlkZXIsIHNlbGYuY2h1bmtfc2l6ZSk/CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgaW5wdXQuY2hlY2twb2ludCA9IFNvbWUoCiAgICAgICAgICAgICAgICAgICAgU3RhZ2VDaGVja3BvaW50OjpuZXcoaW5wdXQudGFyZ2V0KCkpCiAgICAgICAgICAgICAgICAgICAgICAgIC53aXRoX2VudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfY2hlY2twb2ludChwcm92aWRlcik/KSwKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGxldCBlbmRfYmxvY2sgPSAqcmFuZ2Vfb3V0cHV0LmJsb2NrX3JhbmdlLmVuZCgpOwoKICAgICAgICAgICAgaW5mbyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjp0cmFuc2FjdGlvbl9sb29rdXAiLCB0eF9yYW5nZSA9ID9yYW5nZV9vdXRwdXQudHhfcmFuZ2UsICJDYWxjdWxhdGluZyB0cmFuc2FjdGlvbiBoYXNoZXMiKTsKCiAgICAgICAgICAgIGZvciAoa2V5LCB2YWx1ZSkgaW4gcHJvdmlkZXIudHJhbnNhY3Rpb25faGFzaGVzX2J5X3JhbmdlKHJhbmdlX291dHB1dC50eF9yYW5nZSk/IHsKICAgICAgICAgICAgICAgIGhhc2hfY29sbGVjdG9yLmluc2VydChrZXksIHZhbHVlKT87CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlucHV0LmNoZWNrcG9pbnQgPSBTb21lKAogICAgICAgICAgICAgICAgU3RhZ2VDaGVja3BvaW50OjpuZXcoZW5kX2Jsb2NrKQogICAgICAgICAgICAgICAgICAgIC53aXRoX2VudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfY2hlY2twb2ludChwcm92aWRlcik/KSwKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGlmIHJhbmdlX291dHB1dC5pc19maW5hbF9yYW5nZSB7CiAgICAgICAgICAgICAgICBsZXQgdG90YWxfaGFzaGVzID0gaGFzaF9jb2xsZWN0b3IubGVuKCk7CiAgICAgICAgICAgICAgICBsZXQgaW50ZXJ2YWwgPSAodG90YWxfaGFzaGVzIC8gMTApLm1heCgxKTsKCiAgICAgICAgICAgICAgICAvLyBVc2UgYXBwZW5kIG1vZGUgd2hlbiB0YWJsZSBpcyBlbXB0eSAoZmlyc3Qgc3luYykgLSBzaWduaWZpY2FudGx5IGZhc3RlcgogICAgICAgICAgICAgICAgbGV0IGFwcGVuZF9vbmx5ID0KICAgICAgICAgICAgICAgICAgICBwcm92aWRlci5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpUcmFuc2FjdGlvbkhhc2hOdW1iZXJzPigpPy5pc196ZXJvKCk7CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFJvY2tzREIgYmF0Y2ggaWYgZmVhdHVyZSBpcyBlbmFibGVkCiAgICAgICAgICAgICAgICAjW2NmZyhhbGwodW5peCwgZmVhdHVyZSA9ICJyb2Nrc2RiIikpXQogICAgICAgICAgICAgICAgbGV0IHJvY2tzZGIgPSBwcm92aWRlci5yb2Nrc2RiX3Byb3ZpZGVyKCk7CiAgICAgICAgICAgICAgICAjW2NmZyhhbGwodW5peCwgZmVhdHVyZSA9ICJyb2Nrc2RiIikpXQogICAgICAgICAgICAgICAgbGV0IHJvY2tzZGJfYmF0Y2ggPSByb2Nrc2RiLmJhdGNoKCk7CiAgICAgICAgICAgICAgICAjW2NmZyhub3QoYWxsKHVuaXgsIGZlYXR1cmUgPSAicm9ja3NkYiIpKSldCiAgICAgICAgICAgICAgICBsZXQgcm9ja3NkYl9iYXRjaCA9ICgpOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSB3cml0ZXIgdGhhdCByb3V0ZXMgdG8gZWl0aGVyIE1EQlggb3IgUm9ja3NEQiBiYXNlZCBvbiBzZXR0aW5ncwogICAgICAgICAgICAgICAgbGV0IG11dCB3cml0ZXIgPQogICAgICAgICAgICAgICAgICAgIEVpdGhlcldyaXRlcjo6bmV3X3RyYW5zYWN0aW9uX2hhc2hfbnVtYmVycyhwcm92aWRlciwgcm9ja3NkYl9iYXRjaCk/OwoKICAgICAgICAgICAgICAgIGZvciAoaW5kZXgsIGhhc2hfdG9fbnVtYmVyKSBpbiBoYXNoX2NvbGxlY3Rvci5pdGVyKCk/LmVudW1lcmF0ZSgpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgKGhhc2hfYnl0ZXMsIG51bWJlcl9ieXRlcykgPSBoYXNoX3RvX251bWJlcj87CiAgICAgICAgICAgICAgICAgICAgaWYgaW5kZXggPiAwICYmIGluZGV4LmlzX211bHRpcGxlX29mKGludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZm8hKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6c3RhZ2VzOjp0cmFuc2FjdGlvbl9sb29rdXAiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgP2FwcGVuZF9vbmx5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MgPSAlZm9ybWF0ISgiezouMn0lIiwgKGluZGV4IGFzIGY2NCAvIHRvdGFsX2hhc2hlcyBhcyBmNjQpICogMTAwLjApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIkluc2VydGluZyBoYXNoZXMiCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBEZWNvZGUgZnJvbSByYXcgRVRMIGJ5dGVzCiAgICAgICAgICAgICAgICAgICAgbGV0IGhhc2ggPSBUeEhhc2g6OmRlY29kZSgmaGFzaF9ieXRlcyk/OwogICAgICAgICAgICAgICAgICAgIGxldCB0eF9udW0gPSBUeE51bWJlcjo6ZGVjb21wcmVzcygmbnVtYmVyX2J5dGVzKT87CiAgICAgICAgICAgICAgICAgICAgd3JpdGVyLnB1dF90cmFuc2FjdGlvbl9oYXNoX251bWJlcihoYXNoLCB0eF9udW0sIGFwcGVuZF9vbmx5KT87CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRXh0cmFjdCBhbmQgcmVnaXN0ZXIgUm9ja3NEQiBiYXRjaCBmb3IgY29tbWl0IGF0IHByb3ZpZGVyIGxldmVsCiAgICAgICAgICAgICAgICAjW2NmZyhhbGwodW5peCwgZmVhdHVyZSA9ICJyb2Nrc2RiIikpXQogICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUoYmF0Y2gpID0gd3JpdGVyLmludG9fcmF3X3JvY2tzZGJfYmF0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXIuc2V0X3BlbmRpbmdfcm9ja3NkYl9iYXRjaChiYXRjaCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogInN5bmM6OnN0YWdlczo6dHJhbnNhY3Rpb25fbG9va3VwIiwKICAgICAgICAgICAgICAgICAgICB0b3RhbF9oYXNoZXMsCiAgICAgICAgICAgICAgICAgICAgIlRyYW5zYWN0aW9uIGhhc2hlcyBpbnNlcnRlZCIKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIE9rKEV4ZWNPdXRwdXQgewogICAgICAgICAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhpbnB1dC50YXJnZXQoKSkKICAgICAgICAgICAgICAgIC53aXRoX2VudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfY2hlY2twb2ludChwcm92aWRlcik/KSwKICAgICAgICAgICAgZG9uZTogdHJ1ZSwKICAgICAgICB9KQogICAgfQoKICAgIC8vLyBVbndpbmQgdGhlIHN0YWdlLgogICAgZm4gdW53aW5kKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBwcm92aWRlcjogJlByb3ZpZGVyLAogICAgICAgIGlucHV0OiBVbndpbmRJbnB1dCwKICAgICkgLT4gUmVzdWx0PFVud2luZE91dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIGxldCAocmFuZ2UsIHVud2luZF90bywgXykgPSBpbnB1dC51bndpbmRfYmxvY2tfcmFuZ2Vfd2l0aF90aHJlc2hvbGQoc2VsZi5jaHVua19zaXplKTsKCiAgICAgICAgLy8gQ3JlYXRlIFJvY2tzREIgYmF0Y2ggaWYgZmVhdHVyZSBpcyBlbmFibGVkCiAgICAgICAgI1tjZmcoYWxsKHVuaXgsIGZlYXR1cmUgPSAicm9ja3NkYiIpKV0KICAgICAgICBsZXQgcm9ja3NkYiA9IHByb3ZpZGVyLnJvY2tzZGJfcHJvdmlkZXIoKTsKICAgICAgICAjW2NmZyhhbGwodW5peCwgZmVhdHVyZSA9ICJyb2Nrc2RiIikpXQogICAgICAgIGxldCByb2Nrc2RiX2JhdGNoID0gcm9ja3NkYi5iYXRjaCgpOwogICAgICAgICNbY2ZnKG5vdChhbGwodW5peCwgZmVhdHVyZSA9ICJyb2Nrc2RiIikpKV0KICAgICAgICBsZXQgcm9ja3NkYl9iYXRjaCA9ICgpOwoKICAgICAgICAvLyBDcmVhdGUgd3JpdGVyIHRoYXQgcm91dGVzIHRvIGVpdGhlciBNREJYIG9yIFJvY2tzREIgYmFzZWQgb24gc2V0dGluZ3MKICAgICAgICBsZXQgbXV0IHdyaXRlciA9IEVpdGhlcldyaXRlcjo6bmV3X3RyYW5zYWN0aW9uX2hhc2hfbnVtYmVycyhwcm92aWRlciwgcm9ja3NkYl9iYXRjaCk/OwoKICAgICAgICBsZXQgc3RhdGljX2ZpbGVfcHJvdmlkZXIgPSBwcm92aWRlci5zdGF0aWNfZmlsZV9wcm92aWRlcigpOwogICAgICAgIGxldCByZXZfd2Fsa2VyID0gcHJvdmlkZXIKICAgICAgICAgICAgLmJsb2NrX2JvZHlfaW5kaWNlc19yYW5nZShyYW5nZS5jbG9uZSgpKT8KICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgIC56aXAocmFuZ2UuY29sbGVjdDo6PFZlYzxfPj4oKSkKICAgICAgICAgICAgLnJldigpOwoKICAgICAgICBmb3IgKGJvZHksIG51bWJlcikgaW4gcmV2X3dhbGtlciB7CiAgICAgICAgICAgIGlmIG51bWJlciA8PSB1bndpbmRfdG8gewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERlbGV0ZSBhbGwgdHJhbnNhY3Rpb25zIHRoYXQgYmVsb25nIHRvIHRoaXMgYmxvY2sKICAgICAgICAgICAgZm9yIHR4X2lkIGluIGJvZHkudHhfbnVtX3JhbmdlKCkgewogICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUodHJhbnNhY3Rpb24pID0gc3RhdGljX2ZpbGVfcHJvdmlkZXIudHJhbnNhY3Rpb25fYnlfaWQodHhfaWQpPyB7CiAgICAgICAgICAgICAgICAgICAgd3JpdGVyLmRlbGV0ZV90cmFuc2FjdGlvbl9oYXNoX251bWJlcih0cmFuc2FjdGlvbi50cmllX2hhc2goKSk/OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBFeHRyYWN0IGFuZCByZWdpc3RlciBSb2Nrc0RCIGJhdGNoIGZvciBjb21taXQgYXQgcHJvdmlkZXIgbGV2ZWwKICAgICAgICAjW2NmZyhhbGwodW5peCwgZmVhdHVyZSA9ICJyb2Nrc2RiIikpXQogICAgICAgIGlmIGxldCBTb21lKGJhdGNoKSA9IHdyaXRlci5pbnRvX3Jhd19yb2Nrc2RiX2JhdGNoKCkgewogICAgICAgICAgICBwcm92aWRlci5zZXRfcGVuZGluZ19yb2Nrc2RiX2JhdGNoKGJhdGNoKTsKICAgICAgICB9CgogICAgICAgIE9rKFVud2luZE91dHB1dCB7CiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KHVud2luZF90bykKICAgICAgICAgICAgICAgIC53aXRoX2VudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfY2hlY2twb2ludChwcm92aWRlcik/KSwKICAgICAgICB9KQogICAgfQp9CgpmbiBzdGFnZV9jaGVja3BvaW50PFByb3ZpZGVyPihwcm92aWRlcjogJlByb3ZpZGVyKSAtPiBSZXN1bHQ8RW50aXRpZXNDaGVja3BvaW50LCBTdGFnZUVycm9yPgp3aGVyZQogICAgUHJvdmlkZXI6IFBydW5lQ2hlY2twb2ludFJlYWRlciArIFN0YXRpY0ZpbGVQcm92aWRlckZhY3RvcnkgKyBTdGF0c1JlYWRlciwKewogICAgbGV0IHBydW5lZF9lbnRyaWVzID0gcHJvdmlkZXIKICAgICAgICAuZ2V0X3BydW5lX2NoZWNrcG9pbnQoUHJ1bmVTZWdtZW50OjpUcmFuc2FjdGlvbkxvb2t1cCk/CiAgICAgICAgLmFuZF90aGVuKHxjaGVja3BvaW50fCBjaGVja3BvaW50LnR4X251bWJlcikKICAgICAgICAvLyBgKzFgIGlzIG5lZWRlZCBiZWNhdXNlIGBUeE51bWJlcmAgaXMgMC1pbmRleGVkCiAgICAgICAgLm1hcCh8dHhfbnVtYmVyfCB0eF9udW1iZXIgKyAxKQogICAgICAgIC51bndyYXBfb3JfZGVmYXVsdCgpOwogICAgT2soRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAvLyBJZiBgVHJhbnNhY3Rpb25IYXNoTnVtYmVyc2AgdGFibGUgd2FzIHBydW5lZCwgd2Ugd2lsbCBoYXZlIGEgbnVtYmVyIG9mIGVudHJpZXMgaW4gaXQgbm90CiAgICAgICAgLy8gbWF0Y2hpbmcgdGhlIGFjdHVhbCBudW1iZXIgb2YgcHJvY2Vzc2VkIHRyYW5zYWN0aW9ucy4gVG8gZml4IHRoYXQsIHdlIGFkZCB0aGUKICAgICAgICAvLyBudW1iZXIgb2YgcHJ1bmVkIGBUcmFuc2FjdGlvbkhhc2hOdW1iZXJzYCBlbnRyaWVzLgogICAgICAgIHByb2Nlc3NlZDogcHJvdmlkZXIuY291bnRfZW50cmllczo6PHRhYmxlczo6VHJhbnNhY3Rpb25IYXNoTnVtYmVycz4oKT8gYXMgdTY0ICsKICAgICAgICAgICAgcHJ1bmVkX2VudHJpZXMsCiAgICAgICAgLy8gQ291bnQgb25seSBzdGF0aWMgZmlsZXMgZW50cmllcy4gSWYgd2UgY291bnQgdGhlIGRhdGFiYXNlIGVudHJpZXMgdG9vLCB3ZSBtYXkgaGF2ZQogICAgICAgIC8vIGR1cGxpY2F0ZXMuIFdlJ3JlIHN1cmUgdGhhdCB0aGUgc3RhdGljIGZpbGVzIGhhdmUgYWxsIGVudHJpZXMgdGhhdCBkYXRhYmFzZSBoYXMsCiAgICAgICAgLy8gYmVjYXVzZSB3ZSBydW4gdGhlIGBTdGF0aWNGaWxlUHJvZHVjZXJgIGJlZm9yZSBzdGFydGluZyB0aGUgcGlwZWxpbmUuCiAgICAgICAgdG90YWw6IHByb3ZpZGVyLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkuY291bnRfZW50cmllczo6PHRhYmxlczo6VHJhbnNhY3Rpb25zPigpPyBhcyB1NjQsCiAgICB9KQp9CgojW2NmZyh0ZXN0KV0KbW9kIHRlc3RzIHsKICAgIHVzZSBzdXBlcjo6KjsKICAgIHVzZSBjcmF0ZTo6dGVzdF91dGlsczo6ewogICAgICAgIHN0YWdlX3Rlc3Rfc3VpdGVfZXh0LCBFeGVjdXRlU3RhZ2VUZXN0UnVubmVyLCBTdGFnZVRlc3RSdW5uZXIsIFN0b3JhZ2VLaW5kLAogICAgICAgIFRlc3RSdW5uZXJFcnJvciwgVGVzdFN0YWdlREIsIFVud2luZFN0YWdlVGVzdFJ1bm5lciwKICAgIH07CiAgICB1c2UgYWxsb3lfcHJpbWl0aXZlczo6e0Jsb2NrTnVtYmVyLCBCMjU2fTsKICAgIHVzZSBhc3NlcnRfbWF0Y2hlczo6YXNzZXJ0X21hdGNoZXM7CiAgICB1c2UgcmV0aF9kYl9hcGk6OntjdXJzb3I6OkRiQ3Vyc29yUk8sIHRyYW5zYWN0aW9uOjpEYlR4fTsKICAgIHVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrOwogICAgdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OlNlYWxlZEJsb2NrOwogICAgdXNlIHJldGhfcHJvdmlkZXI6OnsKICAgICAgICBwcm92aWRlcnM6OlN0YXRpY0ZpbGVXcml0ZXIsIEJsb2NrQm9keUluZGljZXNQcm92aWRlciwgRGF0YWJhc2VQcm92aWRlckZhY3RvcnksCiAgICB9OwogICAgdXNlIHJldGhfc3RhZ2VzX2FwaTo6U3RhZ2VVbml0Q2hlY2twb2ludDsKICAgIHVzZSByZXRoX3Rlc3RpbmdfdXRpbHM6OmdlbmVyYXRvcnM6OnsKICAgICAgICBzZWxmLCByYW5kb21fYmxvY2ssIHJhbmRvbV9ibG9ja19yYW5nZSwgQmxvY2tQYXJhbXMsIEJsb2NrUmFuZ2VQYXJhbXMsCiAgICB9OwogICAgdXNlIHN0ZDo6b3BzOjpTdWI7CgogICAgLy8gSW1wbGVtZW50IHN0YWdlIHRlc3Qgc3VpdGUuCiAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCEoVHJhbnNhY3Rpb25Mb29rdXBUZXN0UnVubmVyLCB0cmFuc2FjdGlvbl9sb29rdXApOwoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBleGVjdXRlX3NpbmdsZV90cmFuc2FjdGlvbl9sb29rdXAoKSB7CiAgICAgICAgbGV0IChwcmV2aW91c19zdGFnZSwgc3RhZ2VfcHJvZ3Jlc3MpID0gKDUwMCwgMTAwKTsKICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwoKICAgICAgICAvLyBTZXQgdXAgdGhlIHJ1bm5lcgogICAgICAgIGxldCBydW5uZXIgPSBUcmFuc2FjdGlvbkxvb2t1cFRlc3RSdW5uZXI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgewogICAgICAgICAgICB0YXJnZXQ6IFNvbWUocHJldmlvdXNfc3RhZ2UpLAogICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KHN0YWdlX3Byb2dyZXNzKSksCiAgICAgICAgfTsKCiAgICAgICAgLy8gSW5zZXJ0IGJsb2NrcyB3aXRoIGEgc2luZ2xlIHRyYW5zYWN0aW9uIGF0IGJsb2NrIGBzdGFnZV9wcm9ncmVzcyArIDEwYAogICAgICAgIGxldCBub25fZW1wdHlfYmxvY2tfbnVtYmVyID0gc3RhZ2VfcHJvZ3Jlc3MgKyAxMDsKICAgICAgICBsZXQgYmxvY2tzID0gKHN0YWdlX3Byb2dyZXNzLi49aW5wdXQudGFyZ2V0KCkpCiAgICAgICAgICAgIC5tYXAofG51bWJlcnwgewogICAgICAgICAgICAgICAgcmFuZG9tX2Jsb2NrKAogICAgICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgICAgIG51bWJlciwKICAgICAgICAgICAgICAgICAgICBCbG9ja1BhcmFtcyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHR4X2NvdW50OiBTb21lKChudW1iZXIgPT0gbm9uX2VtcHR5X2Jsb2NrX251bWJlcikgYXMgdTgpLAogICAgICAgICAgICAgICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5jb2xsZWN0Ojo8VmVjPF8+PigpOwogICAgICAgIHJ1bm5lcgogICAgICAgICAgICAuZGIKICAgICAgICAgICAgLmluc2VydF9ibG9ja3MoYmxvY2tzLml0ZXIoKSwgU3RvcmFnZUtpbmQ6OlN0YXRpYykKICAgICAgICAgICAgLmV4cGVjdCgiZmFpbGVkIHRvIGluc2VydCBibG9ja3MiKTsKCiAgICAgICAgbGV0IHJ4ID0gcnVubmVyLmV4ZWN1dGUoaW5wdXQpOwoKICAgICAgICAvLyBBc3NlcnQgdGhlIHN1Y2Nlc3NmdWwgcmVzdWx0CiAgICAgICAgbGV0IHJlc3VsdCA9IHJ4LmF3YWl0LnVud3JhcCgpOwogICAgICAgIGFzc2VydF9tYXRjaGVzISgKICAgICAgICAgICAgcmVzdWx0LAogICAgICAgICAgICBPayhFeGVjT3V0cHV0IHsKICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICBibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50OiBTb21lKFN0YWdlVW5pdENoZWNrcG9pbnQ6OkVudGl0aWVzKEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkLAogICAgICAgICAgICAgICAgICAgIHRvdGFsCiAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgfSwgZG9uZTogdHJ1ZSB9KSBpZiBibG9ja19udW1iZXIgPT0gcHJldmlvdXNfc3RhZ2UgJiYgcHJvY2Vzc2VkID09IHRvdGFsICYmCiAgICAgICAgICAgICAgICB0b3RhbCA9PSBydW5uZXIuZGIuY291bnRfZW50cmllczo6PHRhYmxlczo6VHJhbnNhY3Rpb25zPigpLnVud3JhcCgpIGFzIHU2NAogICAgICAgICk7CgogICAgICAgIC8vIFZhbGlkYXRlIHRoZSBzdGFnZSBleGVjdXRpb24KICAgICAgICBhc3NlcnQhKHJ1bm5lci52YWxpZGF0ZV9leGVjdXRpb24oaW5wdXQsIHJlc3VsdC5vaygpKS5pc19vaygpLCAiZXhlY3V0aW9uIHZhbGlkYXRpb24iKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gZXhlY3V0ZV9wcnVuZWRfdHJhbnNhY3Rpb25fbG9va3VwKCkgewogICAgICAgIGxldCAocHJldmlvdXNfc3RhZ2UsIHBydW5lX3RhcmdldCwgc3RhZ2VfcHJvZ3Jlc3MpID0gKDUwMCwgNDAwLCAxMDApOwogICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CgogICAgICAgIC8vIFNldCB1cCB0aGUgcnVubmVyCiAgICAgICAgbGV0IG11dCBydW5uZXIgPSBUcmFuc2FjdGlvbkxvb2t1cFRlc3RSdW5uZXI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgewogICAgICAgICAgICB0YXJnZXQ6IFNvbWUocHJldmlvdXNfc3RhZ2UpLAogICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KHN0YWdlX3Byb2dyZXNzKSksCiAgICAgICAgfTsKCiAgICAgICAgLy8gU2VlZCBvbmx5IG9uY2Ugd2l0aCBmdWxsIGlucHV0IHJhbmdlCiAgICAgICAgbGV0IHNlZWQgPSByYW5kb21fYmxvY2tfcmFuZ2UoCiAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICBzdGFnZV9wcm9ncmVzcyArIDEuLj1wcmV2aW91c19zdGFnZSwKICAgICAgICAgICAgQmxvY2tSYW5nZVBhcmFtcyB7IHBhcmVudDogU29tZShCMjU2OjpaRVJPKSwgdHhfY291bnQ6IDAuLjIsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgKTsKICAgICAgICBydW5uZXIKICAgICAgICAgICAgLmRiCiAgICAgICAgICAgIC5pbnNlcnRfYmxvY2tzKHNlZWQuaXRlcigpLCBTdG9yYWdlS2luZDo6U3RhdGljKQogICAgICAgICAgICAuZXhwZWN0KCJmYWlsZWQgdG8gc2VlZCBleGVjdXRpb24iKTsKCiAgICAgICAgcnVubmVyLnNldF9wcnVuZV9tb2RlKFBydW5lTW9kZTo6QmVmb3JlKHBydW5lX3RhcmdldCkpOwoKICAgICAgICBsZXQgcnggPSBydW5uZXIuZXhlY3V0ZShpbnB1dCk7CgogICAgICAgIC8vIEFzc2VydCB0aGUgc3VjY2Vzc2Z1bCByZXN1bHQKICAgICAgICBsZXQgcmVzdWx0ID0gcnguYXdhaXQudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKAogICAgICAgICAgICByZXN1bHQsCiAgICAgICAgICAgIE9rKEV4ZWNPdXRwdXQgewogICAgICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgIGJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgIHN0YWdlX2NoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VVbml0Q2hlY2twb2ludDo6RW50aXRpZXMoRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWQsCiAgICAgICAgICAgICAgICAgICAgdG90YWwKICAgICAgICAgICAgICAgIH0pKQogICAgICAgICAgICB9LCBkb25lOiB0cnVlIH0pIGlmIGJsb2NrX251bWJlciA9PSBwcmV2aW91c19zdGFnZSAmJiBwcm9jZXNzZWQgPT0gdG90YWwgJiYKICAgICAgICAgICAgICAgIHRvdGFsID09IHJ1bm5lci5kYi5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpUcmFuc2FjdGlvbnM+KCkudW53cmFwKCkgYXMgdTY0CiAgICAgICAgKTsKCiAgICAgICAgLy8gVmFsaWRhdGUgdGhlIHN0YWdlIGV4ZWN1dGlvbgogICAgICAgIGFzc2VydCEocnVubmVyLnZhbGlkYXRlX2V4ZWN1dGlvbihpbnB1dCwgcmVzdWx0Lm9rKCkpLmlzX29rKCksICJleGVjdXRpb24gdmFsaWRhdGlvbiIpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHN0YWdlX2NoZWNrcG9pbnRfcHJ1bmVkKCkgewogICAgICAgIGxldCBkYiA9IFRlc3RTdGFnZURCOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IG11dCBybmcgPSBnZW5lcmF0b3JzOjpybmcoKTsKCiAgICAgICAgbGV0IGJsb2NrcyA9IHJhbmRvbV9ibG9ja19yYW5nZSgKICAgICAgICAgICAgJm11dCBybmcsCiAgICAgICAgICAgIDAuLj0xMDAsCiAgICAgICAgICAgIEJsb2NrUmFuZ2VQYXJhbXMgeyBwYXJlbnQ6IFNvbWUoQjI1Njo6WkVSTyksIHR4X2NvdW50OiAwLi4xMCwgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfSwKICAgICAgICApOwogICAgICAgIGRiLmluc2VydF9ibG9ja3MoYmxvY2tzLml0ZXIoKSwgU3RvcmFnZUtpbmQ6OlN0YXRpYykuZXhwZWN0KCJpbnNlcnQgYmxvY2tzIik7CgogICAgICAgIGxldCBtYXhfcHJ1bmVkX2Jsb2NrID0gMzA7CiAgICAgICAgbGV0IG1heF9wcm9jZXNzZWRfYmxvY2sgPSA3MDsKCiAgICAgICAgbGV0IG11dCB0eF9oYXNoX251bWJlcnMgPSBWZWM6Om5ldygpOwogICAgICAgIGxldCBtdXQgdHhfaGFzaF9udW1iZXIgPSAwOwogICAgICAgIGZvciBibG9jayBpbiAmYmxvY2tzWy4uPW1heF9wcm9jZXNzZWRfYmxvY2tdIHsKICAgICAgICAgICAgZm9yIHRyYW5zYWN0aW9uIGluICZibG9jay5ib2R5KCkudHJhbnNhY3Rpb25zIHsKICAgICAgICAgICAgICAgIGlmIGJsb2NrLm51bWJlciA+IG1heF9wcnVuZWRfYmxvY2sgewogICAgICAgICAgICAgICAgICAgIHR4X2hhc2hfbnVtYmVycy5wdXNoKCgqdHJhbnNhY3Rpb24udHhfaGFzaCgpLCB0eF9oYXNoX251bWJlcikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdHhfaGFzaF9udW1iZXIgKz0gMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBkYi5pbnNlcnRfdHhfaGFzaF9udW1iZXJzKHR4X2hhc2hfbnVtYmVycykuZXhwZWN0KCJpbnNlcnQgdHggaGFzaCBudW1iZXJzIik7CgogICAgICAgIGxldCBwcm92aWRlciA9IGRiLmZhY3RvcnkucHJvdmlkZXJfcncoKS51bndyYXAoKTsKICAgICAgICBwcm92aWRlcgogICAgICAgICAgICAuc2F2ZV9wcnVuZV9jaGVja3BvaW50KAogICAgICAgICAgICAgICAgUHJ1bmVTZWdtZW50OjpUcmFuc2FjdGlvbkxvb2t1cCwKICAgICAgICAgICAgICAgIFBydW5lQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiBTb21lKG1heF9wcnVuZWRfYmxvY2spLAogICAgICAgICAgICAgICAgICAgIHR4X251bWJlcjogU29tZSgKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tzWy4uPW1heF9wcnVuZWRfYmxvY2sgYXMgdXNpemVdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuaXRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKHxibG9ja3wgYmxvY2sudHJhbnNhY3Rpb25fY291bnQoKSBhcyB1NjQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc3VtOjo8dTY0PigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc3ViKDEpLCAvLyBgVHhOdW1iZXJgIGlzIDAtaW5kZXhlZAogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgcHJ1bmVfbW9kZTogUHJ1bmVNb2RlOjpGdWxsLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgKQogICAgICAgICAgICAuZXhwZWN0KCJzYXZlIHN0YWdlIGNoZWNrcG9pbnQiKTsKICAgICAgICBwcm92aWRlci5jb21taXQoKS5leHBlY3QoImNvbW1pdCIpOwoKICAgICAgICBsZXQgcHJvdmlkZXIgPSBkYi5mYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgc3RhZ2VfY2hlY2twb2ludCgmcHJvdmlkZXIpLmV4cGVjdCgic3RhZ2UgY2hlY2twb2ludCIpLAogICAgICAgICAgICBFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgcHJvY2Vzc2VkOiBibG9ja3NbLi49bWF4X3Byb2Nlc3NlZF9ibG9ja10KICAgICAgICAgICAgICAgICAgICAuaXRlcigpCiAgICAgICAgICAgICAgICAgICAgLm1hcCh8YmxvY2t8IGJsb2NrLnRyYW5zYWN0aW9uX2NvdW50KCkgYXMgdTY0KQogICAgICAgICAgICAgICAgICAgIC5zdW0oKSwKICAgICAgICAgICAgICAgIHRvdGFsOiBibG9ja3MuaXRlcigpLm1hcCh8YmxvY2t8IGJsb2NrLnRyYW5zYWN0aW9uX2NvdW50KCkgYXMgdTY0KS5zdW0oKQogICAgICAgICAgICB9CiAgICAgICAgKTsKICAgIH0KCiAgICBzdHJ1Y3QgVHJhbnNhY3Rpb25Mb29rdXBUZXN0UnVubmVyIHsKICAgICAgICBkYjogVGVzdFN0YWdlREIsCiAgICAgICAgY2h1bmtfc2l6ZTogdTY0LAogICAgICAgIGV0bF9jb25maWc6IEV0bENvbmZpZywKICAgICAgICBwcnVuZV9tb2RlOiBPcHRpb248UHJ1bmVNb2RlPiwKICAgIH0KCiAgICBpbXBsIERlZmF1bHQgZm9yIFRyYW5zYWN0aW9uTG9va3VwVGVzdFJ1bm5lciB7CiAgICAgICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgICAgICBTZWxmIHsKICAgICAgICAgICAgICAgIGRiOiBUZXN0U3RhZ2VEQjo6ZGVmYXVsdCgpLAogICAgICAgICAgICAgICAgY2h1bmtfc2l6ZTogMTAwMCwKICAgICAgICAgICAgICAgIGV0bF9jb25maWc6IEV0bENvbmZpZzo6ZGVmYXVsdCgpLAogICAgICAgICAgICAgICAgcHJ1bmVfbW9kZTogTm9uZSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpbXBsIFRyYW5zYWN0aW9uTG9va3VwVGVzdFJ1bm5lciB7CiAgICAgICAgZm4gc2V0X3BydW5lX21vZGUoJm11dCBzZWxmLCBwcnVuZV9tb2RlOiBQcnVuZU1vZGUpIHsKICAgICAgICAgICAgc2VsZi5wcnVuZV9tb2RlID0gU29tZShwcnVuZV9tb2RlKTsKICAgICAgICB9CgogICAgICAgIC8vLyAjIFBhbmljcwogICAgICAgIC8vLwogICAgICAgIC8vLyAxLiBJZiB0aGVyZSBhcmUgYW55IGVudHJpZXMgaW4gdGhlIFtgdGFibGVzOjpUcmFuc2FjdGlvbkhhc2hOdW1iZXJzYF0gdGFibGUgYWJvdmUgYQogICAgICAgIC8vLyAgICBnaXZlbiBibG9jayBudW1iZXIuCiAgICAgICAgLy8vIDIuIElmIHRoZXJlIGlzIG5vIHJlcXVlc3RlZCBibG9jayBlbnRyeSBpbiB0aGUgYm9kaWVzIHRhYmxlLCBidXQKICAgICAgICAvLy8gICAgW2B0YWJsZXM6OlRyYW5zYWN0aW9uSGFzaE51bWJlcnNgXSBpcyAgICBub3QgZW1wdHkuCiAgICAgICAgZm4gZW5zdXJlX25vX2hhc2hfYnlfYmxvY2soJnNlbGYsIG51bWJlcjogQmxvY2tOdW1iZXIpIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgIGxldCBib2R5X3Jlc3VsdCA9IHNlbGYKICAgICAgICAgICAgICAgIC5kYgogICAgICAgICAgICAgICAgLmZhY3RvcnkKICAgICAgICAgICAgICAgIC5wcm92aWRlcl9ydygpPwogICAgICAgICAgICAgICAgLmJsb2NrX2JvZHlfaW5kaWNlcyhudW1iZXIpPwogICAgICAgICAgICAgICAgLm9rX29yKFByb3ZpZGVyRXJyb3I6OkJsb2NrQm9keUluZGljZXNOb3RGb3VuZChudW1iZXIpKTsKICAgICAgICAgICAgbWF0Y2ggYm9keV9yZXN1bHQgewogICAgICAgICAgICAgICAgT2soYm9keSkgPT4gewogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuZW5zdXJlX25vX2VudHJ5X2Fib3ZlX2J5X3ZhbHVlOjo8dGFibGVzOjpUcmFuc2FjdGlvbkhhc2hOdW1iZXJzLCBfPigKICAgICAgICAgICAgICAgICAgICAgICAgYm9keS5sYXN0X3R4X251bSgpLAogICAgICAgICAgICAgICAgICAgICAgICB8a2V5fCBrZXksCiAgICAgICAgICAgICAgICAgICAgKT8KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEVycihfKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0IShzZWxmLmRiLnRhYmxlX2lzX2VtcHR5Ojo8dGFibGVzOjpUcmFuc2FjdGlvbkhhc2hOdW1iZXJzPigpPyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBPaygoKSkKICAgICAgICB9CiAgICB9CgogICAgaW1wbCBTdGFnZVRlc3RSdW5uZXIgZm9yIFRyYW5zYWN0aW9uTG9va3VwVGVzdFJ1bm5lciB7CiAgICAgICAgdHlwZSBTID0gVHJhbnNhY3Rpb25Mb29rdXBTdGFnZTsKCiAgICAgICAgZm4gZGIoJnNlbGYpIC0+ICZUZXN0U3RhZ2VEQiB7CiAgICAgICAgICAgICZzZWxmLmRiCiAgICAgICAgfQoKICAgICAgICBmbiBzdGFnZSgmc2VsZikgLT4gU2VsZjo6UyB7CiAgICAgICAgICAgIFRyYW5zYWN0aW9uTG9va3VwU3RhZ2UgewogICAgICAgICAgICAgICAgY2h1bmtfc2l6ZTogc2VsZi5jaHVua19zaXplLAogICAgICAgICAgICAgICAgZXRsX2NvbmZpZzogc2VsZi5ldGxfY29uZmlnLmNsb25lKCksCiAgICAgICAgICAgICAgICBwcnVuZV9tb2RlOiBzZWxmLnBydW5lX21vZGUsCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaW1wbCBFeGVjdXRlU3RhZ2VUZXN0UnVubmVyIGZvciBUcmFuc2FjdGlvbkxvb2t1cFRlc3RSdW5uZXIgewogICAgICAgIHR5cGUgU2VlZCA9IFZlYzxTZWFsZWRCbG9jazxCbG9jaz4+OwoKICAgICAgICBmbiBzZWVkX2V4ZWN1dGlvbigmbXV0IHNlbGYsIGlucHV0OiBFeGVjSW5wdXQpIC0+IFJlc3VsdDxTZWxmOjpTZWVkLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgbGV0IHN0YWdlX3Byb2dyZXNzID0gaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlcjsKICAgICAgICAgICAgbGV0IGVuZCA9IGlucHV0LnRhcmdldCgpOwogICAgICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwoKICAgICAgICAgICAgbGV0IGJsb2NrcyA9IHJhbmRvbV9ibG9ja19yYW5nZSgKICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgc3RhZ2VfcHJvZ3Jlc3MgKyAxLi49ZW5kLAogICAgICAgICAgICAgICAgQmxvY2tSYW5nZVBhcmFtcyB7IHBhcmVudDogU29tZShCMjU2OjpaRVJPKSwgdHhfY291bnQ6IDAuLjIsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHNlbGYuZGIuaW5zZXJ0X2Jsb2NrcyhibG9ja3MuaXRlcigpLCBTdG9yYWdlS2luZDo6U3RhdGljKT87CiAgICAgICAgICAgIE9rKGJsb2NrcykKICAgICAgICB9CgogICAgICAgIGZuIHZhbGlkYXRlX2V4ZWN1dGlvbigKICAgICAgICAgICAgJnNlbGYsCiAgICAgICAgICAgIG11dCBpbnB1dDogRXhlY0lucHV0LAogICAgICAgICAgICBvdXRwdXQ6IE9wdGlvbjxFeGVjT3V0cHV0PiwKICAgICAgICApIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgIG1hdGNoIG91dHB1dCB7CiAgICAgICAgICAgICAgICBTb21lKG91dHB1dCkgPT4gewogICAgICAgICAgICAgICAgICAgIGxldCBwcm92aWRlciA9IHNlbGYuZGIuZmFjdG9yeS5wcm92aWRlcigpPzsKCiAgICAgICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUoKHRhcmdldF9wcnVuYWJsZV9ibG9jaywgXykpID0gc2VsZgogICAgICAgICAgICAgICAgICAgICAgICAucHJ1bmVfbW9kZQogICAgICAgICAgICAgICAgICAgICAgICAubWFwKHxtb2RlfCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlLnBydW5lX3RhcmdldF9ibG9jaygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC50YXJnZXQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQcnVuZVNlZ21lbnQ6OlRyYW5zYWN0aW9uTG9va3VwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBydW5lUHVycG9zZTo6VXNlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLnRyYW5zcG9zZSgpCiAgICAgICAgICAgICAgICAgICAgICAgIC5leHBlY3QoInBydW5lIHRhcmdldCBibG9jayBmb3IgdHJhbnNhY3Rpb24gbG9va3VwIikKICAgICAgICAgICAgICAgICAgICAgICAgLmZsYXR0ZW4oKSAmJgogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRfcHJ1bmFibGVfYmxvY2sgPiBpbnB1dC5jaGVja3BvaW50KCkuYmxvY2tfbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5jaGVja3BvaW50ID0gU29tZShTdGFnZUNoZWNrcG9pbnQ6Om5ldyh0YXJnZXRfcHJ1bmFibGVfYmxvY2spKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXJ0X2Jsb2NrID0gaW5wdXQubmV4dF9ibG9jaygpOwogICAgICAgICAgICAgICAgICAgIGxldCBlbmRfYmxvY2sgPSBvdXRwdXQuY2hlY2twb2ludC5ibG9ja19udW1iZXI7CgogICAgICAgICAgICAgICAgICAgIGlmIHN0YXJ0X2Jsb2NrID4gZW5kX2Jsb2NrIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9rKCgpKQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBib2R5X2N1cnNvciA9CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmN1cnNvcl9yZWFkOjo8dGFibGVzOjpCbG9ja0JvZHlJbmRpY2VzPigpPzsKICAgICAgICAgICAgICAgICAgICBib2R5X2N1cnNvci5zZWVrX2V4YWN0KHN0YXJ0X2Jsb2NrKT87CgogICAgICAgICAgICAgICAgICAgIHdoaWxlIGxldCBTb21lKChfLCBib2R5KSkgPSBib2R5X2N1cnNvci5uZXh0KCk/IHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHR4X2lkIGluIGJvZHkudHhfbnVtX3JhbmdlKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRyYW5zYWN0aW9uID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlci50cmFuc2FjdGlvbl9ieV9pZCh0eF9pZCk/LmV4cGVjdCgibm8gdHJhbnNhY3Rpb24gZW50cnkiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU29tZSh0eF9pZCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXIudHJhbnNhY3Rpb25faWQoKnRyYW5zYWN0aW9uLnR4X2hhc2goKSk/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgTm9uZSA9PiBzZWxmLmVuc3VyZV9ub19oYXNoX2J5X2Jsb2NrKGlucHV0LmNoZWNrcG9pbnQoKS5ibG9ja19udW1iZXIpPywKICAgICAgICAgICAgfTsKICAgICAgICAgICAgT2soKCkpCiAgICAgICAgfQogICAgfQoKICAgIGltcGwgVW53aW5kU3RhZ2VUZXN0UnVubmVyIGZvciBUcmFuc2FjdGlvbkxvb2t1cFRlc3RSdW5uZXIgewogICAgICAgIGZuIHZhbGlkYXRlX3Vud2luZCgmc2VsZiwgaW5wdXQ6IFVud2luZElucHV0KSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICBzZWxmLmVuc3VyZV9ub19oYXNoX2J5X2Jsb2NrKGlucHV0LnVud2luZF90bykKICAgICAgICB9CiAgICB9CgogICAgI1tjZmcoYWxsKHVuaXgsIGZlYXR1cmUgPSAicm9ja3NkYiIpKV0KICAgIG1vZCByb2Nrc2RiX3Rlc3RzIHsKICAgICAgICB1c2Ugc3VwZXI6Oio7CiAgICAgICAgdXNlIHJldGhfcHJvdmlkZXI6OlJvY2tzREJQcm92aWRlckZhY3Rvcnk7CiAgICAgICAgdXNlIHJldGhfc3RvcmFnZV9hcGk6OlN0b3JhZ2VTZXR0aW5nczsKCiAgICAgICAgLy8vIFRlc3QgdGhhdCB3aGVuIGB0cmFuc2FjdGlvbl9oYXNoX251bWJlcnNfaW5fcm9ja3NkYmAgaXMgZW5hYmxlZCwgdGhlIHN0YWdlCiAgICAgICAgLy8vIHdyaXRlcyB0cmFuc2FjdGlvbiBoYXNoIG1hcHBpbmdzIHRvIGBSb2Nrc0RCYCBpbnN0ZWFkIG9mIE1EQlguCiAgICAgICAgI1t0b2tpbzo6dGVzdF0KICAgICAgICBhc3luYyBmbiBleGVjdXRlX3dyaXRlc190b19yb2Nrc2RiX3doZW5fZW5hYmxlZCgpIHsKICAgICAgICAgICAgbGV0IChwcmV2aW91c19zdGFnZSwgc3RhZ2VfcHJvZ3Jlc3MpID0gKDExMCwgMTAwKTsKICAgICAgICAgICAgbGV0IG11dCBybmcgPSBnZW5lcmF0b3JzOjpybmcoKTsKCiAgICAgICAgICAgIC8vIFNldCB1cCB0aGUgcnVubmVyCiAgICAgICAgICAgIGxldCBydW5uZXIgPSBUcmFuc2FjdGlvbkxvb2t1cFRlc3RSdW5uZXI6OmRlZmF1bHQoKTsKCiAgICAgICAgICAgIC8vIEVuYWJsZSBSb2Nrc0RCIGZvciB0cmFuc2FjdGlvbiBoYXNoIG51bWJlcnMKICAgICAgICAgICAgcnVubmVyLmRiLmZhY3Rvcnkuc2V0X3N0b3JhZ2Vfc2V0dGluZ3NfY2FjaGUoCiAgICAgICAgICAgICAgICBTdG9yYWdlU2V0dGluZ3M6OmxlZ2FjeSgpLndpdGhfdHJhbnNhY3Rpb25faGFzaF9udW1iZXJzX2luX3JvY2tzZGIodHJ1ZSksCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgewogICAgICAgICAgICAgICAgdGFyZ2V0OiBTb21lKHByZXZpb3VzX3N0YWdlKSwKICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VDaGVja3BvaW50OjpuZXcoc3RhZ2VfcHJvZ3Jlc3MpKSwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEluc2VydCBibG9ja3Mgd2l0aCB0cmFuc2FjdGlvbnMKICAgICAgICAgICAgbGV0IGJsb2NrcyA9IHJhbmRvbV9ibG9ja19yYW5nZSgKICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgc3RhZ2VfcHJvZ3Jlc3MgKyAxLi49cHJldmlvdXNfc3RhZ2UsCiAgICAgICAgICAgICAgICBCbG9ja1JhbmdlUGFyYW1zIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IFNvbWUoQjI1Njo6WkVSTyksCiAgICAgICAgICAgICAgICAgICAgdHhfY291bnQ6IDEuLjMsIC8vIEVuc3VyZSB3ZSBoYXZlIHRyYW5zYWN0aW9ucwogICAgICAgICAgICAgICAgICAgIC4uRGVmYXVsdDo6ZGVmYXVsdCgpCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICApOwogICAgICAgICAgICBydW5uZXIKICAgICAgICAgICAgICAgIC5kYgogICAgICAgICAgICAgICAgLmluc2VydF9ibG9ja3MoYmxvY2tzLml0ZXIoKSwgU3RvcmFnZUtpbmQ6OlN0YXRpYykKICAgICAgICAgICAgICAgIC5leHBlY3QoImZhaWxlZCB0byBpbnNlcnQgYmxvY2tzIik7CgogICAgICAgICAgICAvLyBDb3VudCBleHBlY3RlZCB0cmFuc2FjdGlvbnMKICAgICAgICAgICAgbGV0IGV4cGVjdGVkX3R4X2NvdW50OiB1c2l6ZSA9IGJsb2Nrcy5pdGVyKCkubWFwKHxifCBiLmJvZHkoKS50cmFuc2FjdGlvbnMubGVuKCkpLnN1bSgpOwogICAgICAgICAgICBhc3NlcnQhKGV4cGVjdGVkX3R4X2NvdW50ID4gMCwgInRlc3QgcmVxdWlyZXMgYXQgbGVhc3Qgb25lIHRyYW5zYWN0aW9uIik7CgogICAgICAgICAgICAvLyBFeGVjdXRlIHRoZSBzdGFnZQogICAgICAgICAgICBsZXQgcnggPSBydW5uZXIuZXhlY3V0ZShpbnB1dCk7CiAgICAgICAgICAgIGxldCByZXN1bHQgPSByeC5hd2FpdC51bndyYXAoKTsKICAgICAgICAgICAgYXNzZXJ0IShyZXN1bHQuaXNfb2soKSwgInN0YWdlIGV4ZWN1dGlvbiBmYWlsZWQ6IHs6P30iLCByZXN1bHQpOwoKICAgICAgICAgICAgLy8gVmVyaWZ5IE1EQlggdGFibGUgaXMgZW1wdHkgKGRhdGEgc2hvdWxkIGJlIGluIFJvY2tzREIpCiAgICAgICAgICAgIGxldCBtZGJ4X2NvdW50ID0gcnVubmVyLmRiLmNvdW50X2VudHJpZXM6Ojx0YWJsZXM6OlRyYW5zYWN0aW9uSGFzaE51bWJlcnM+KCkudW53cmFwKCk7CiAgICAgICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgICAgICBtZGJ4X2NvdW50LCAwLAogICAgICAgICAgICAgICAgIk1EQlggVHJhbnNhY3Rpb25IYXNoTnVtYmVycyBzaG91bGQgYmUgZW1wdHkgd2hlbiBSb2Nrc0RCIGlzIGVuYWJsZWQiCiAgICAgICAgICAgICk7CgogICAgICAgICAgICAvLyBWZXJpZnkgUm9ja3NEQiBoYXMgdGhlIGRhdGEKICAgICAgICAgICAgbGV0IHJvY2tzZGIgPSBydW5uZXIuZGIuZmFjdG9yeS5yb2Nrc2RiX3Byb3ZpZGVyKCk7CiAgICAgICAgICAgIGxldCBtdXQgcm9ja3NkYl9jb3VudCA9IDA7CiAgICAgICAgICAgIGZvciBibG9jayBpbiAmYmxvY2tzIHsKICAgICAgICAgICAgICAgIGZvciB0eCBpbiAmYmxvY2suYm9keSgpLnRyYW5zYWN0aW9ucyB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGhhc2ggPSAqdHgudHhfaGFzaCgpOwogICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSByb2Nrc2RiLmdldDo6PHRhYmxlczo6VHJhbnNhY3Rpb25IYXNoTnVtYmVycz4oaGFzaCkudW53cmFwKCk7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0IShyZXN1bHQuaXNfc29tZSgpLCAiVHJhbnNhY3Rpb24gaGFzaCB7Oj99IG5vdCBmb3VuZCBpbiBSb2Nrc0RCIiwgaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgcm9ja3NkYl9jb3VudCArPSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgICAgICByb2Nrc2RiX2NvdW50LCBleHBlY3RlZF90eF9jb3VudCwKICAgICAgICAgICAgICAgICJSb2Nrc0RCIHNob3VsZCBjb250YWluIGFsbCB0cmFuc2FjdGlvbiBoYXNoZXMiCiAgICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICAvLy8gVGVzdCB0aGF0IHdoZW4gYHRyYW5zYWN0aW9uX2hhc2hfbnVtYmVyc19pbl9yb2Nrc2RiYCBpcyBlbmFibGVkLCB0aGUgc3RhZ2UKICAgICAgICAvLy8gdW53aW5kIGRlbGV0ZXMgdHJhbnNhY3Rpb24gaGFzaCBtYXBwaW5ncyBmcm9tIGBSb2Nrc0RCYCBpbnN0ZWFkIG9mIE1EQlguCiAgICAgICAgI1t0b2tpbzo6dGVzdF0KICAgICAgICBhc3luYyBmbiB1bndpbmRfZGVsZXRlc19mcm9tX3JvY2tzZGJfd2hlbl9lbmFibGVkKCkgewogICAgICAgICAgICBsZXQgKHByZXZpb3VzX3N0YWdlLCBzdGFnZV9wcm9ncmVzcykgPSAoMTEwLCAxMDApOwogICAgICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwoKICAgICAgICAgICAgLy8gU2V0IHVwIHRoZSBydW5uZXIKICAgICAgICAgICAgbGV0IHJ1bm5lciA9IFRyYW5zYWN0aW9uTG9va3VwVGVzdFJ1bm5lcjo6ZGVmYXVsdCgpOwoKICAgICAgICAgICAgLy8gRW5hYmxlIFJvY2tzREIgZm9yIHRyYW5zYWN0aW9uIGhhc2ggbnVtYmVycwogICAgICAgICAgICBydW5uZXIuZGIuZmFjdG9yeS5zZXRfc3RvcmFnZV9zZXR0aW5nc19jYWNoZSgKICAgICAgICAgICAgICAgIFN0b3JhZ2VTZXR0aW5nczo6bGVnYWN5KCkud2l0aF90cmFuc2FjdGlvbl9oYXNoX251bWJlcnNfaW5fcm9ja3NkYih0cnVlKSwKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIC8vIEluc2VydCBibG9ja3Mgd2l0aCB0cmFuc2FjdGlvbnMKICAgICAgICAgICAgbGV0IGJsb2NrcyA9IHJhbmRvbV9ibG9ja19yYW5nZSgKICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgc3RhZ2VfcHJvZ3Jlc3MgKyAxLi49cHJldmlvdXNfc3RhZ2UsCiAgICAgICAgICAgICAgICBCbG9ja1JhbmdlUGFyYW1zIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IFNvbWUoQjI1Njo6WkVSTyksCiAgICAgICAgICAgICAgICAgICAgdHhfY291bnQ6IDEuLjMsIC8vIEVuc3VyZSB3ZSBoYXZlIHRyYW5zYWN0aW9ucwogICAgICAgICAgICAgICAgICAgIC4uRGVmYXVsdDo6ZGVmYXVsdCgpCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICApOwogICAgICAgICAgICBydW5uZXIKICAgICAgICAgICAgICAgIC5kYgogICAgICAgICAgICAgICAgLmluc2VydF9ibG9ja3MoYmxvY2tzLml0ZXIoKSwgU3RvcmFnZUtpbmQ6OlN0YXRpYykKICAgICAgICAgICAgICAgIC5leHBlY3QoImZhaWxlZCB0byBpbnNlcnQgYmxvY2tzIik7CgogICAgICAgICAgICAvLyBDb3VudCBleHBlY3RlZCB0cmFuc2FjdGlvbnMKICAgICAgICAgICAgbGV0IGV4cGVjdGVkX3R4X2NvdW50OiB1c2l6ZSA9IGJsb2Nrcy5pdGVyKCkubWFwKHxifCBiLmJvZHkoKS50cmFuc2FjdGlvbnMubGVuKCkpLnN1bSgpOwogICAgICAgICAgICBhc3NlcnQhKGV4cGVjdGVkX3R4X2NvdW50ID4gMCwgInRlc3QgcmVxdWlyZXMgYXQgbGVhc3Qgb25lIHRyYW5zYWN0aW9uIik7CgogICAgICAgICAgICAvLyBFeGVjdXRlIHRoZSBzdGFnZSBmaXJzdCB0byBwb3B1bGF0ZSBSb2Nrc0RCCiAgICAgICAgICAgIGxldCBleGVjX2lucHV0ID0gRXhlY0lucHV0IHsKICAgICAgICAgICAgICAgIHRhcmdldDogU29tZShwcmV2aW91c19zdGFnZSksCiAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KHN0YWdlX3Byb2dyZXNzKSksCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGxldCByeCA9IHJ1bm5lci5leGVjdXRlKGV4ZWNfaW5wdXQpOwogICAgICAgICAgICBsZXQgcmVzdWx0ID0gcnguYXdhaXQudW53cmFwKCk7CiAgICAgICAgICAgIGFzc2VydCEocmVzdWx0LmlzX29rKCksICJzdGFnZSBleGVjdXRpb24gZmFpbGVkOiB7Oj99IiwgcmVzdWx0KTsKCiAgICAgICAgICAgIC8vIFZlcmlmeSBSb2Nrc0RCIGhhcyB0aGUgZGF0YSBiZWZvcmUgdW53aW5kCiAgICAgICAgICAgIGxldCByb2Nrc2RiID0gcnVubmVyLmRiLmZhY3Rvcnkucm9ja3NkYl9wcm92aWRlcigpOwogICAgICAgICAgICBmb3IgYmxvY2sgaW4gJmJsb2NrcyB7CiAgICAgICAgICAgICAgICBmb3IgdHggaW4gJmJsb2NrLmJvZHkoKS50cmFuc2FjdGlvbnMgewogICAgICAgICAgICAgICAgICAgIGxldCBoYXNoID0gKnR4LnR4X2hhc2goKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gcm9ja3NkYi5nZXQ6Ojx0YWJsZXM6OlRyYW5zYWN0aW9uSGFzaE51bWJlcnM+KGhhc2gpLnVud3JhcCgpOwogICAgICAgICAgICAgICAgICAgIGFzc2VydCEoCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5pc19zb21lKCksCiAgICAgICAgICAgICAgICAgICAgICAgICJUcmFuc2FjdGlvbiBoYXNoIHs6P30gc2hvdWxkIGV4aXN0IGJlZm9yZSB1bndpbmQiLAogICAgICAgICAgICAgICAgICAgICAgICBoYXNoCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTm93IHVud2luZCB0byBzdGFnZV9wcm9ncmVzcyAocmVtb3ZpbmcgYWxsIHRoZSBibG9ja3Mgd2UgYWRkZWQpCiAgICAgICAgICAgIGxldCB1bndpbmRfaW5wdXQgPSBVbndpbmRJbnB1dCB7CiAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhwcmV2aW91c19zdGFnZSksCiAgICAgICAgICAgICAgICB1bndpbmRfdG86IHN0YWdlX3Byb2dyZXNzLAogICAgICAgICAgICAgICAgYmFkX2Jsb2NrOiBOb25lLAogICAgICAgICAgICB9OwogICAgICAgICAgICBsZXQgdW53aW5kX3Jlc3VsdCA9IHJ1bm5lci51bndpbmQodW53aW5kX2lucHV0KS5hd2FpdDsKICAgICAgICAgICAgYXNzZXJ0ISh1bndpbmRfcmVzdWx0LmlzX29rKCksICJzdGFnZSB1bndpbmQgZmFpbGVkOiB7Oj99IiwgdW53aW5kX3Jlc3VsdCk7CgogICAgICAgICAgICAvLyBWZXJpZnkgUm9ja3NEQiBkYXRhIGlzIGRlbGV0ZWQgYWZ0ZXIgdW53aW5kCiAgICAgICAgICAgIGxldCByb2Nrc2RiID0gcnVubmVyLmRiLmZhY3Rvcnkucm9ja3NkYl9wcm92aWRlcigpOwogICAgICAgICAgICBmb3IgYmxvY2sgaW4gJmJsb2NrcyB7CiAgICAgICAgICAgICAgICBmb3IgdHggaW4gJmJsb2NrLmJvZHkoKS50cmFuc2FjdGlvbnMgewogICAgICAgICAgICAgICAgICAgIGxldCBoYXNoID0gKnR4LnR4X2hhc2goKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gcm9ja3NkYi5nZXQ6Ojx0YWJsZXM6OlRyYW5zYWN0aW9uSGFzaE51bWJlcnM+KGhhc2gpLnVud3JhcCgpOwogICAgICAgICAgICAgICAgICAgIGFzc2VydCEoCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5pc19ub25lKCksCiAgICAgICAgICAgICAgICAgICAgICAgICJUcmFuc2FjdGlvbiBoYXNoIHs6P30gc2hvdWxkIGJlIGRlbGV0ZWQgZnJvbSBSb2Nrc0RCIGFmdGVyIHVud2luZCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGhhc2gKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvc3RhZ2VzL3NyYy9zdGFnZXMvdXRpbHMucnMiPgovLyEgVXRpbHMgZm9yIGBzdGFnZXNgLgp1c2UgYWxsb3lfcHJpbWl0aXZlczo6e0FkZHJlc3MsIEJsb2NrTnVtYmVyLCBUeE51bWJlcn07CnVzZSByZXRoX2NvbmZpZzo6Y29uZmlnOjpFdGxDb25maWc7CnVzZSByZXRoX2RiX2FwaTo6ewogICAgY3Vyc29yOjp7RGJDdXJzb3JSTywgRGJDdXJzb3JSV30sCiAgICBtb2RlbHM6OntzaGFyZGVkX2tleTo6TlVNX09GX0lORElDRVNfSU5fU0hBUkQsIEFjY291bnRCZWZvcmVUeCwgU2hhcmRlZEtleX0sCiAgICB0YWJsZTo6e0RlY29tcHJlc3MsIFRhYmxlfSwKICAgIHRyYW5zYWN0aW9uOjp7RGJUeCwgRGJUeE11dH0sCiAgICBCbG9ja051bWJlckxpc3QsIERhdGFiYXNlRXJyb3IsCn07CnVzZSByZXRoX2V0bDo6Q29sbGVjdG9yOwp1c2UgcmV0aF9wcm92aWRlcjo6ewogICAgcHJvdmlkZXJzOjpTdGF0aWNGaWxlUHJvdmlkZXIsIHRvX3JhbmdlLCBCbG9ja1JlYWRlciwgREJQcm92aWRlciwgUHJvdmlkZXJFcnJvciwKICAgIFN0YXRpY0ZpbGVQcm92aWRlckZhY3RvcnksCn07CnVzZSByZXRoX3N0YWdlc19hcGk6OlN0YWdlRXJyb3I7CnVzZSByZXRoX3N0YXRpY19maWxlX3R5cGVzOjpTdGF0aWNGaWxlU2VnbWVudDsKdXNlIHJldGhfc3RvcmFnZV9hcGk6OkNoYW5nZVNldFJlYWRlcjsKdXNlIHN0ZDo6e2NvbGxlY3Rpb25zOjpIYXNoTWFwLCBoYXNoOjpIYXNoLCBvcHM6OlJhbmdlQm91bmRzfTsKdXNlIHRyYWNpbmc6OmluZm87CgovLy8gTnVtYmVyIG9mIGJsb2NrcyBiZWZvcmUgcHVzaGluZyBpbmRpY2VzIGZyb20gY2FjaGUgdG8gW2BDb2xsZWN0b3JgXQpjb25zdCBERUZBVUxUX0NBQ0hFX1RIUkVTSE9MRDogdTY0ID0gMTAwXzAwMDsKCi8vLyBDb2xsZWN0cyBhbGwgaGlzdG9yeSAoYEhgKSBpbmRpY2VzIGZvciBhIHJhbmdlIG9mIGNoYW5nZXNldHMgKGBDU2ApIGFuZCBzdG9yZXMgdGhlbSBpbiBhCi8vLyBbYENvbGxlY3RvcmBdLgovLy8KLy8vICMjIFByb2Nlc3MKLy8vIFRoZSBmdW5jdGlvbiB1dGlsaXplcyBhIGBIYXNoTWFwYCBjYWNoZSB3aXRoIGEgc3RydWN0dXJlIG9mIGBQYXJ0aWFsS2V5YCAoYFBgKSAoQWRkcmVzcyBvcgovLy8gQWRkcmVzcy5TdG9yYWdlS2V5KSB0byBgQmxvY2tOdW1iZXJMaXN0YC4gV2hlbiB0aGUgY2FjaGUgZXhjZWVkcyBpdHMgY2FwYWNpdHksIGl0cyBjb250ZW50cyBhcmUKLy8vIG1vdmVkIHRvIGEgW2BDb2xsZWN0b3JgXS4gSGVyZSwgZWFjaCBlbnRyeSdzIGtleSBpcyBhIGNvbmNhdGVuYXRpb24gb2YgYFBhcnRpYWxLZXlgIGFuZCB0aGUKLy8vIGhpZ2hlc3QgYmxvY2sgbnVtYmVyIGluIGl0cyBsaXN0LgovLy8KLy8vICMjIEV4YW1wbGUKLy8vIDEuIEluaXRpYWwgQ2FjaGUgU3RhdGU6IGB7IEFkZHJlc3MxOiBbMSwyLDNdLCAuLi4gfWAKLy8vIDIuIENhY2hlIGlzIGZsdXNoZWQgdG8gdGhlIGBDb2xsZWN0b3JgLgovLy8gMy4gVXBkYXRlZCBDYWNoZSBTdGF0ZTogYHsgQWRkcmVzczE6IFsxMDAsMzAwXSwgLi4uIH1gCi8vLyA0LiBDYWNoZSBpcyBmbHVzaGVkIGFnYWluLgovLy8KLy8vIEFzIGEgcmVzdWx0LCB0aGUgYENvbGxlY3RvcmAgd2lsbCBjb250YWluIGVudHJpZXMgc3VjaCBhcyBgKEFkZHJlc3MxLjMsIFsxLDIsM10pYCBhbmQKLy8vIGAoQWRkcmVzczEuMzAwLCBbMTAwLDMwMF0pYC4gVGhlIGVudHJpZXMgbWF5IGJlIHN0b3JlZCBhY3Jvc3Mgb25lIG9yIG1vcmUgZmlsZXMuCnB1YihjcmF0ZSkgZm4gY29sbGVjdF9oaXN0b3J5X2luZGljZXM8UHJvdmlkZXIsIENTLCBILCBQPigKICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICByYW5nZTogaW1wbCBSYW5nZUJvdW5kczxDUzo6S2V5PiwKICAgIHNoYXJkZWRfa2V5X2ZhY3Rvcnk6IGltcGwgRm4oUCwgQmxvY2tOdW1iZXIpIC0+IEg6OktleSwKICAgIHBhcnRpYWxfa2V5X2ZhY3Rvcnk6IGltcGwgRm4oKENTOjpLZXksIENTOjpWYWx1ZSkpIC0+ICh1NjQsIFApLAogICAgZXRsX2NvbmZpZzogJkV0bENvbmZpZywKKSAtPiBSZXN1bHQ8Q29sbGVjdG9yPEg6OktleSwgSDo6VmFsdWU+LCBTdGFnZUVycm9yPgp3aGVyZQogICAgUHJvdmlkZXI6IERCUHJvdmlkZXIsCiAgICBDUzogVGFibGUsCiAgICBIOiBUYWJsZTxWYWx1ZSA9IEJsb2NrTnVtYmVyTGlzdD4sCiAgICBQOiBDb3B5ICsgRXEgKyBIYXNoLAp7CiAgICBsZXQgbXV0IGNoYW5nZXNldF9jdXJzb3IgPSBwcm92aWRlci50eF9yZWYoKS5jdXJzb3JfcmVhZDo6PENTPigpPzsKCiAgICBsZXQgbXV0IGNvbGxlY3RvciA9IENvbGxlY3Rvcjo6bmV3KGV0bF9jb25maWcuZmlsZV9zaXplLCBldGxfY29uZmlnLmRpci5jbG9uZSgpKTsKICAgIGxldCBtdXQgY2FjaGU6IEhhc2hNYXA8UCwgVmVjPHU2ND4+ID0gSGFzaE1hcDo6ZGVmYXVsdCgpOwoKICAgIGxldCBtdXQgY29sbGVjdCA9IHxjYWNoZTogJkhhc2hNYXA8UCwgVmVjPHU2ND4+fCB7CiAgICAgICAgZm9yIChrZXksIGluZGljZXMpIGluIGNhY2hlIHsKICAgICAgICAgICAgbGV0IGxhc3QgPSBpbmRpY2VzLmxhc3QoKS5leHBlY3QoInFlZCIpOwogICAgICAgICAgICBjb2xsZWN0b3IuaW5zZXJ0KAogICAgICAgICAgICAgICAgc2hhcmRlZF9rZXlfZmFjdG9yeSgqa2V5LCAqbGFzdCksCiAgICAgICAgICAgICAgICBCbG9ja051bWJlckxpc3Q6Om5ld19wcmVfc29ydGVkKGluZGljZXMuaXRlcigpLmNvcGllZCgpKSwKICAgICAgICAgICAgKT87CiAgICAgICAgfQogICAgICAgIE9rOjo8KCksIFN0YWdlRXJyb3I+KCgpKQogICAgfTsKCiAgICAvLyBvYnNlcnZhYmlsaXR5CiAgICBsZXQgdG90YWxfY2hhbmdlc2V0cyA9IHByb3ZpZGVyLnR4X3JlZigpLmVudHJpZXM6OjxDUz4oKT87CiAgICBsZXQgaW50ZXJ2YWwgPSAodG90YWxfY2hhbmdlc2V0cyAvIDEwMDApLm1heCgxKTsKCiAgICBsZXQgbXV0IGZsdXNoX2NvdW50ZXIgPSAwOwogICAgbGV0IG11dCBjdXJyZW50X2Jsb2NrX251bWJlciA9IHU2NDo6TUFYOwogICAgZm9yIChpZHgsIGVudHJ5KSBpbiBjaGFuZ2VzZXRfY3Vyc29yLndhbGtfcmFuZ2UocmFuZ2UpPy5lbnVtZXJhdGUoKSB7CiAgICAgICAgbGV0IChibG9ja19udW1iZXIsIGtleSkgPSBwYXJ0aWFsX2tleV9mYWN0b3J5KGVudHJ5Pyk7CiAgICAgICAgY2FjaGUuZW50cnkoa2V5KS5vcl9kZWZhdWx0KCkucHVzaChibG9ja19udW1iZXIpOwoKICAgICAgICBpZiBpZHggPiAwICYmIGlkeC5pc19tdWx0aXBsZV9vZihpbnRlcnZhbCkgJiYgdG90YWxfY2hhbmdlc2V0cyA+IDEwMDAgewogICAgICAgICAgICBpbmZvISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OmluZGV4X2hpc3RvcnkiLCBwcm9ncmVzcyA9ICVmb3JtYXQhKCJ7Oi40fSUiLCAoaWR4IGFzIGY2NCAvIHRvdGFsX2NoYW5nZXNldHMgYXMgZjY0KSAqIDEwMC4wKSwgIkNvbGxlY3RpbmcgaW5kaWNlcyIpOwogICAgICAgIH0KCiAgICAgICAgLy8gTWFrZSBzdXJlIHdlIG9ubHkgZmx1c2ggdGhlIGNhY2hlIGV2ZXJ5IERFRkFVTFRfQ0FDSEVfVEhSRVNIT0xEIGJsb2Nrcy4KICAgICAgICBpZiBjdXJyZW50X2Jsb2NrX251bWJlciAhPSBibG9ja19udW1iZXIgewogICAgICAgICAgICBjdXJyZW50X2Jsb2NrX251bWJlciA9IGJsb2NrX251bWJlcjsKICAgICAgICAgICAgZmx1c2hfY291bnRlciArPSAxOwogICAgICAgICAgICBpZiBmbHVzaF9jb3VudGVyID4gREVGQVVMVF9DQUNIRV9USFJFU0hPTEQgewogICAgICAgICAgICAgICAgY29sbGVjdCgmY2FjaGUpPzsKICAgICAgICAgICAgICAgIGNhY2hlLmNsZWFyKCk7CiAgICAgICAgICAgICAgICBmbHVzaF9jb3VudGVyID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGNvbGxlY3QoJmNhY2hlKT87CgogICAgT2soY29sbGVjdG9yKQp9CgovLy8gQWxsb3dzIGNvbGxlY3RpbmcgaW5kaWNlcyBmcm9tIGEgY2FjaGUgd2l0aCBhIGN1c3RvbSBpbnNlcnQgZm4KZm4gY29sbGVjdF9pbmRpY2VzPEY+KAogICAgY2FjaGU6IGltcGwgSXRlcmF0b3I8SXRlbSA9IChBZGRyZXNzLCBWZWM8dTY0Pik+LAogICAgbXV0IGluc2VydF9mbjogRiwKKSAtPiBSZXN1bHQ8KCksIFN0YWdlRXJyb3I+CndoZXJlCiAgICBGOiBGbk11dChBZGRyZXNzLCBWZWM8dTY0PikgLT4gUmVzdWx0PCgpLCBTdGFnZUVycm9yPiwKewogICAgZm9yIChhZGRyZXNzLCBpbmRpY2VzKSBpbiBjYWNoZSB7CiAgICAgICAgaW5zZXJ0X2ZuKGFkZHJlc3MsIGluZGljZXMpPwogICAgfQogICAgT2s6OjwoKSwgU3RhZ2VFcnJvcj4oKCkpCn0KCi8vLyBDb2xsZWN0cyBhY2NvdW50IGhpc3RvcnkgaW5kaWNlcyB1c2luZyBhIHByb3ZpZGVyIHRoYXQgaW1wbGVtZW50cyBgQ2hhbmdlU2V0UmVhZGVyYC4KcHViKGNyYXRlKSBmbiBjb2xsZWN0X2FjY291bnRfaGlzdG9yeV9pbmRpY2VzPFByb3ZpZGVyPigKICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICByYW5nZTogaW1wbCBSYW5nZUJvdW5kczxCbG9ja051bWJlcj4sCiAgICBldGxfY29uZmlnOiAmRXRsQ29uZmlnLAopIC0+IFJlc3VsdDxDb2xsZWN0b3I8U2hhcmRlZEtleTxBZGRyZXNzPiwgQmxvY2tOdW1iZXJMaXN0PiwgU3RhZ2VFcnJvcj4Kd2hlcmUKICAgIFByb3ZpZGVyOiBEQlByb3ZpZGVyICsgQ2hhbmdlU2V0UmVhZGVyICsgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwKewogICAgbGV0IG11dCBjb2xsZWN0b3IgPSBDb2xsZWN0b3I6Om5ldyhldGxfY29uZmlnLmZpbGVfc2l6ZSwgZXRsX2NvbmZpZy5kaXIuY2xvbmUoKSk7CiAgICBsZXQgbXV0IGNhY2hlOiBIYXNoTWFwPEFkZHJlc3MsIFZlYzx1NjQ+PiA9IEhhc2hNYXA6OmRlZmF1bHQoKTsKCiAgICBsZXQgbXV0IGluc2VydF9mbiA9IHxhZGRyZXNzOiBBZGRyZXNzLCBpbmRpY2VzOiBWZWM8dTY0PnwgewogICAgICAgIGxldCBsYXN0ID0gaW5kaWNlcy5sYXN0KCkuZXhwZWN0KCJxZWQiKTsKICAgICAgICBjb2xsZWN0b3IuaW5zZXJ0KAogICAgICAgICAgICBTaGFyZGVkS2V5OjpuZXcoYWRkcmVzcywgKmxhc3QpLAogICAgICAgICAgICBCbG9ja051bWJlckxpc3Q6Om5ld19wcmVfc29ydGVkKGluZGljZXMuaW50b19pdGVyKCkpLAogICAgICAgICk/OwogICAgICAgIE9rOjo8KCksIFN0YWdlRXJyb3I+KCgpKQogICAgfTsKCiAgICAvLyBDb252ZXJ0IHJhbmdlIGJvdW5kcyB0byBjb25jcmV0ZSByYW5nZQogICAgbGV0IHJhbmdlID0gdG9fcmFuZ2UocmFuZ2UpOwoKICAgIC8vIFVzZSB0aGUgbmV3IHdhbGtlciBmb3IgbGF6eSBpdGVyYXRpb24gb3ZlciBzdGF0aWMgZmlsZSBjaGFuZ2VzZXRzCiAgICBsZXQgc3RhdGljX2ZpbGVfcHJvdmlkZXIgPSBwcm92aWRlci5zdGF0aWNfZmlsZV9wcm92aWRlcigpOwoKICAgIC8vIEdldCB0b3RhbCBjb3VudCBmb3IgcHJvZ3Jlc3MgcmVwb3J0aW5nCiAgICBsZXQgdG90YWxfY2hhbmdlc2V0cyA9IHN0YXRpY19maWxlX3Byb3ZpZGVyLmFjY291bnRfY2hhbmdlc2V0X2NvdW50KCk/OwogICAgbGV0IGludGVydmFsID0gKHRvdGFsX2NoYW5nZXNldHMgLyAxMDAwKS5tYXgoMSk7CgogICAgbGV0IHdhbGtlciA9IHN0YXRpY19maWxlX3Byb3ZpZGVyLndhbGtfYWNjb3VudF9jaGFuZ2VzZXRfcmFuZ2UocmFuZ2UpOwoKICAgIGxldCBtdXQgZmx1c2hfY291bnRlciA9IDA7CiAgICBsZXQgbXV0IGN1cnJlbnRfYmxvY2tfbnVtYmVyID0gdTY0OjpNQVg7CgogICAgZm9yIChpZHgsIGNoYW5nZXNldF9yZXN1bHQpIGluIHdhbGtlci5lbnVtZXJhdGUoKSB7CiAgICAgICAgbGV0IChibG9ja19udW1iZXIsIEFjY291bnRCZWZvcmVUeCB7IGFkZHJlc3MsIC4uIH0pID0gY2hhbmdlc2V0X3Jlc3VsdD87CiAgICAgICAgY2FjaGUuZW50cnkoYWRkcmVzcykub3JfZGVmYXVsdCgpLnB1c2goYmxvY2tfbnVtYmVyKTsKCiAgICAgICAgaWYgaWR4ID4gMCAmJiBpZHggJSBpbnRlcnZhbCA9PSAwICYmIHRvdGFsX2NoYW5nZXNldHMgPiAxMDAwIHsKICAgICAgICAgICAgaW5mbyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjppbmRleF9oaXN0b3J5IiwgcHJvZ3Jlc3MgPSAlZm9ybWF0ISgiezouNH0lIiwgKGlkeCBhcyBmNjQgLyB0b3RhbF9jaGFuZ2VzZXRzIGFzIGY2NCkgKiAxMDAuMCksICJDb2xsZWN0aW5nIGluZGljZXMiKTsKICAgICAgICB9CgogICAgICAgIGlmIGJsb2NrX251bWJlciAhPSBjdXJyZW50X2Jsb2NrX251bWJlciB7CiAgICAgICAgICAgIGN1cnJlbnRfYmxvY2tfbnVtYmVyID0gYmxvY2tfbnVtYmVyOwogICAgICAgICAgICBmbHVzaF9jb3VudGVyICs9IDE7CiAgICAgICAgfQoKICAgICAgICBpZiBmbHVzaF9jb3VudGVyID4gREVGQVVMVF9DQUNIRV9USFJFU0hPTEQgewogICAgICAgICAgICBjb2xsZWN0X2luZGljZXMoY2FjaGUuZHJhaW4oKSwgJm11dCBpbnNlcnRfZm4pPzsKICAgICAgICAgICAgZmx1c2hfY291bnRlciA9IDA7CiAgICAgICAgfQogICAgfQogICAgY29sbGVjdF9pbmRpY2VzKGNhY2hlLmludG9faXRlcigpLCBpbnNlcnRfZm4pPzsKCiAgICBPayhjb2xsZWN0b3IpCn0KCi8vLyBHaXZlbiBhIFtgQ29sbGVjdG9yYF0gY3JlYXRlZCBieSBbYGNvbGxlY3RfaGlzdG9yeV9pbmRpY2VzYF0gaXQgaXRlcmF0ZXMgYWxsIGVudHJpZXMsIGxvYWRpbmcKLy8vIHRoZSBpbmRpY2VzIGludG8gdGhlIGRhdGFiYXNlIGluIHNoYXJkcy4KLy8vCi8vLyAgIyMgUHJvY2VzcwovLy8gSXRlcmF0ZXMgb3ZlciBlbGVtZW50cywgZ3JvdXBpbmcgaW5kaWNlcyBieSB0aGVpciBwYXJ0aWFsIGtleXMgKGUuZy4sIGBBZGRyZXNzYCBvcgovLy8gYEFkZHJlc3MuU3RvcmFnZUtleWApLiBJdCBmbHVzaGVzIGluZGljZXMgdG8gZGlzayB3aGVuIHJlYWNoaW5nIGEgc2hhcmQncyBtYXggbGVuZ3RoCi8vLyAoYE5VTV9PRl9JTkRJQ0VTX0lOX1NIQVJEYCkgb3Igd2hlbiB0aGUgcGFydGlhbCBrZXkgY2hhbmdlcywgZW5zdXJpbmcgdGhlIGxhc3QgcHJldmlvdXMgcGFydGlhbAovLy8ga2V5IHNoYXJkIGlzIHN0b3JlZC4KcHViKGNyYXRlKSBmbiBsb2FkX2hpc3RvcnlfaW5kaWNlczxQcm92aWRlciwgSCwgUD4oCiAgICBwcm92aWRlcjogJlByb3ZpZGVyLAogICAgbXV0IGNvbGxlY3RvcjogQ29sbGVjdG9yPEg6OktleSwgSDo6VmFsdWU+LAogICAgYXBwZW5kX29ubHk6IGJvb2wsCiAgICBzaGFyZGVkX2tleV9mYWN0b3J5OiBpbXBsIENsb25lICsgRm4oUCwgdTY0KSAtPiA8SCBhcyBUYWJsZT46OktleSwKICAgIGRlY29kZV9rZXk6IGltcGwgRm4oVmVjPHU4PikgLT4gUmVzdWx0PDxIIGFzIFRhYmxlPjo6S2V5LCBEYXRhYmFzZUVycm9yPiwKICAgIGdldF9wYXJ0aWFsOiBpbXBsIEZuKDxIIGFzIFRhYmxlPjo6S2V5KSAtPiBQLAopIC0+IFJlc3VsdDwoKSwgU3RhZ2VFcnJvcj4Kd2hlcmUKICAgIFByb3ZpZGVyOiBEQlByb3ZpZGVyPFR4OiBEYlR4TXV0PiwKICAgIEg6IFRhYmxlPFZhbHVlID0gQmxvY2tOdW1iZXJMaXN0PiwKICAgIFA6IENvcHkgKyBEZWZhdWx0ICsgRXEsCnsKICAgIGxldCBtdXQgd3JpdGVfY3Vyc29yID0gcHJvdmlkZXIudHhfcmVmKCkuY3Vyc29yX3dyaXRlOjo8SD4oKT87CiAgICBsZXQgbXV0IGN1cnJlbnRfcGFydGlhbCA9IFA6OmRlZmF1bHQoKTsKICAgIGxldCBtdXQgY3VycmVudF9saXN0ID0gVmVjOjo8dTY0Pjo6bmV3KCk7CgogICAgLy8gb2JzZXJ2YWJpbGl0eQogICAgbGV0IHRvdGFsX2VudHJpZXMgPSBjb2xsZWN0b3IubGVuKCk7CiAgICBsZXQgaW50ZXJ2YWwgPSAodG90YWxfZW50cmllcyAvIDEwKS5tYXgoMSk7CgogICAgZm9yIChpbmRleCwgZWxlbWVudCkgaW4gY29sbGVjdG9yLml0ZXIoKT8uZW51bWVyYXRlKCkgewogICAgICAgIGxldCAoaywgdikgPSBlbGVtZW50PzsKICAgICAgICBsZXQgc2hhcmRlZF9rZXkgPSBkZWNvZGVfa2V5KGspPzsKICAgICAgICBsZXQgbmV3X2xpc3QgPSBCbG9ja051bWJlckxpc3Q6OmRlY29tcHJlc3Nfb3duZWQodik/OwoKICAgICAgICBpZiBpbmRleCA+IDAgJiYgaW5kZXguaXNfbXVsdGlwbGVfb2YoaW50ZXJ2YWwpICYmIHRvdGFsX2VudHJpZXMgPiAxMCB7CiAgICAgICAgICAgIGluZm8hKHRhcmdldDogInN5bmM6OnN0YWdlczo6aW5kZXhfaGlzdG9yeSIsIHByb2dyZXNzID0gJWZvcm1hdCEoIns6LjJ9JSIsIChpbmRleCBhcyBmNjQgLyB0b3RhbF9lbnRyaWVzIGFzIGY2NCkgKiAxMDAuMCksICJXcml0aW5nIGluZGljZXMiKTsKICAgICAgICB9CgogICAgICAgIC8vIEFjY291bnRzSGlzdG9yeTogYEFkZHJlc3NgLgogICAgICAgIC8vIFN0b3JhZ2VIaXN0b3J5OiBgQWRkcmVzcy5TdG9yYWdlS2V5YC4KICAgICAgICBsZXQgcGFydGlhbF9rZXkgPSBnZXRfcGFydGlhbChzaGFyZGVkX2tleSk7CgogICAgICAgIGlmIGN1cnJlbnRfcGFydGlhbCAhPSBwYXJ0aWFsX2tleSB7CiAgICAgICAgICAgIC8vIFdlIGhhdmUgcmVhY2hlZCB0aGUgZW5kIG9mIHRoaXMgc3Vic2V0IG9mIGtleXMgc28KICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBmbHVzaCBpdHMgbGFzdCBpbmRpY2Ugc2hhcmQuCiAgICAgICAgICAgIGxvYWRfaW5kaWNlcygKICAgICAgICAgICAgICAgICZtdXQgd3JpdGVfY3Vyc29yLAogICAgICAgICAgICAgICAgY3VycmVudF9wYXJ0aWFsLAogICAgICAgICAgICAgICAgJm11dCBjdXJyZW50X2xpc3QsCiAgICAgICAgICAgICAgICAmc2hhcmRlZF9rZXlfZmFjdG9yeSwKICAgICAgICAgICAgICAgIGFwcGVuZF9vbmx5LAogICAgICAgICAgICAgICAgTG9hZE1vZGU6OkZsdXNoLAogICAgICAgICAgICApPzsKCiAgICAgICAgICAgIGN1cnJlbnRfcGFydGlhbCA9IHBhcnRpYWxfa2V5OwogICAgICAgICAgICBjdXJyZW50X2xpc3QuY2xlYXIoKTsKCiAgICAgICAgICAgIC8vIElmIGl0J3Mgbm90IHRoZSBmaXJzdCBzeW5jLCB0aGVyZSBtaWdodCBhbiBleGlzdGluZyBzaGFyZCBhbHJlYWR5LCBzbyB3ZSBuZWVkIHRvCiAgICAgICAgICAgIC8vIG1lcmdlIGl0IHdpdGggdGhlIG9uZSBjb21pbmcgZnJvbSB0aGUgY29sbGVjdG9yCiAgICAgICAgICAgIGlmICFhcHBlbmRfb25seSAmJgogICAgICAgICAgICAgICAgbGV0IFNvbWUoKF8sIGxhc3RfZGF0YWJhc2Vfc2hhcmQpKSA9CiAgICAgICAgICAgICAgICAgICAgd3JpdGVfY3Vyc29yLnNlZWtfZXhhY3Qoc2hhcmRlZF9rZXlfZmFjdG9yeShjdXJyZW50X3BhcnRpYWwsIHU2NDo6TUFYKSk/CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRfbGlzdC5leHRlbmQobGFzdF9kYXRhYmFzZV9zaGFyZC5pdGVyKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjdXJyZW50X2xpc3QuZXh0ZW5kKG5ld19saXN0Lml0ZXIoKSk7CiAgICAgICAgbG9hZF9pbmRpY2VzKAogICAgICAgICAgICAmbXV0IHdyaXRlX2N1cnNvciwKICAgICAgICAgICAgY3VycmVudF9wYXJ0aWFsLAogICAgICAgICAgICAmbXV0IGN1cnJlbnRfbGlzdCwKICAgICAgICAgICAgJnNoYXJkZWRfa2V5X2ZhY3RvcnksCiAgICAgICAgICAgIGFwcGVuZF9vbmx5LAogICAgICAgICAgICBMb2FkTW9kZTo6S2VlcExhc3QsCiAgICAgICAgKT87CiAgICB9CgogICAgLy8gVGhlcmUgd2lsbCBiZSBvbmUgcmVtYWluaW5nIHNoYXJkIHRoYXQgbmVlZHMgdG8gYmUgZmx1c2hlZCB0byBEQi4KICAgIGxvYWRfaW5kaWNlcygKICAgICAgICAmbXV0IHdyaXRlX2N1cnNvciwKICAgICAgICBjdXJyZW50X3BhcnRpYWwsCiAgICAgICAgJm11dCBjdXJyZW50X2xpc3QsCiAgICAgICAgJnNoYXJkZWRfa2V5X2ZhY3RvcnksCiAgICAgICAgYXBwZW5kX29ubHksCiAgICAgICAgTG9hZE1vZGU6OkZsdXNoLAogICAgKT87CgogICAgT2soKCkpCn0KCi8vLyBTaGFyZCBhbmQgaW5zZXJ0IHRoZSBpbmRpY2VzIGxpc3QgYWNjb3JkaW5nIHRvIFtgTG9hZE1vZGVgXSBhbmQgaXRzIGxlbmd0aC4KcHViKGNyYXRlKSBmbiBsb2FkX2luZGljZXM8SCwgQywgUD4oCiAgICBjdXJzb3I6ICZtdXQgQywKICAgIHBhcnRpYWxfa2V5OiBQLAogICAgbGlzdDogJm11dCBWZWM8QmxvY2tOdW1iZXI+LAogICAgc2hhcmRlZF9rZXlfZmFjdG9yeTogJmltcGwgRm4oUCwgQmxvY2tOdW1iZXIpIC0+IDxIIGFzIFRhYmxlPjo6S2V5LAogICAgYXBwZW5kX29ubHk6IGJvb2wsCiAgICBtb2RlOiBMb2FkTW9kZSwKKSAtPiBSZXN1bHQ8KCksIFN0YWdlRXJyb3I+CndoZXJlCiAgICBDOiBEYkN1cnNvclJPPEg+ICsgRGJDdXJzb3JSVzxIPiwKICAgIEg6IFRhYmxlPFZhbHVlID0gQmxvY2tOdW1iZXJMaXN0PiwKICAgIFA6IENvcHksCnsKICAgIGlmIGxpc3QubGVuKCkgPiBOVU1fT0ZfSU5ESUNFU19JTl9TSEFSRCB8fCBtb2RlLmlzX2ZsdXNoKCkgewogICAgICAgIGxldCBjaHVua3MgPSBsaXN0CiAgICAgICAgICAgIC5jaHVua3MoTlVNX09GX0lORElDRVNfSU5fU0hBUkQpCiAgICAgICAgICAgIC5tYXAofGNodW5rc3wgY2h1bmtzLnRvX3ZlYygpKQogICAgICAgICAgICAuY29sbGVjdDo6PFZlYzxWZWM8dTY0Pj4+KCk7CgogICAgICAgIGxldCBtdXQgaXRlciA9IGNodW5rcy5pbnRvX2l0ZXIoKS5wZWVrYWJsZSgpOwogICAgICAgIHdoaWxlIGxldCBTb21lKGNodW5rKSA9IGl0ZXIubmV4dCgpIHsKICAgICAgICAgICAgbGV0IG11dCBoaWdoZXN0ID0gKmNodW5rLmxhc3QoKS5leHBlY3QoImF0IGxlYXN0IG9uZSBpbmRleCIpOwoKICAgICAgICAgICAgaWYgIW1vZGUuaXNfZmx1c2goKSAmJiBpdGVyLnBlZWsoKS5pc19ub25lKCkgewogICAgICAgICAgICAgICAgKmxpc3QgPSBjaHVuazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIGl0ZXIucGVlaygpLmlzX25vbmUoKSB7CiAgICAgICAgICAgICAgICAgICAgaGlnaGVzdCA9IHU2NDo6TUFYOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IGtleSA9IHNoYXJkZWRfa2V5X2ZhY3RvcnkocGFydGlhbF9rZXksIGhpZ2hlc3QpOwogICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gQmxvY2tOdW1iZXJMaXN0OjpuZXdfcHJlX3NvcnRlZChjaHVuayk7CgogICAgICAgICAgICAgICAgaWYgYXBwZW5kX29ubHkgewogICAgICAgICAgICAgICAgICAgIGN1cnNvci5hcHBlbmQoa2V5LCAmdmFsdWUpPzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3Vyc29yLnVwc2VydChrZXksICZ2YWx1ZSk/OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIE9rKCgpKQp9CgovLy8gTW9kZSBvbiBob3cgdG8gbG9hZCBpbmRleCBzaGFyZHMgaW50byB0aGUgZGF0YWJhc2UuCnB1YihjcmF0ZSkgZW51bSBMb2FkTW9kZSB7CiAgICAvLy8gS2VlcCB0aGUgbGFzdCBzaGFyZCBpbiBtZW1vcnkgYW5kIGRvbid0IGZsdXNoIGl0IHRvIHRoZSBkYXRhYmFzZS4KICAgIEtlZXBMYXN0LAogICAgLy8vIEZsdXNoIGFsbCBzaGFyZHMgaW50byB0aGUgZGF0YWJhc2UuCiAgICBGbHVzaCwKfQoKaW1wbCBMb2FkTW9kZSB7CiAgICBjb25zdCBmbiBpc19mbHVzaCgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgbWF0Y2hlcyEoc2VsZiwgU2VsZjo6Rmx1c2gpCiAgICB9Cn0KCi8vLyBDYWxsZWQgd2hlbiBkYXRhYmFzZSBpcyBhaGVhZCBvZiBzdGF0aWMgZmlsZXMuIEF0dGVtcHRzIHRvIGZpbmQgdGhlIGZpcnN0IGJsb2NrIHdlIGFyZSBtaXNzaW5nCi8vLyB0cmFuc2FjdGlvbnMgZm9yLgpwdWIoY3JhdGUpIGZuIG1pc3Npbmdfc3RhdGljX2RhdGFfZXJyb3I8UHJvdmlkZXI+KAogICAgbGFzdF90eF9udW06IFR4TnVtYmVyLAogICAgc3RhdGljX2ZpbGVfcHJvdmlkZXI6ICZTdGF0aWNGaWxlUHJvdmlkZXI8UHJvdmlkZXI6OlByaW1pdGl2ZXM+LAogICAgcHJvdmlkZXI6ICZQcm92aWRlciwKICAgIHNlZ21lbnQ6IFN0YXRpY0ZpbGVTZWdtZW50LAopIC0+IFJlc3VsdDxTdGFnZUVycm9yLCBQcm92aWRlckVycm9yPgp3aGVyZQogICAgUHJvdmlkZXI6IEJsb2NrUmVhZGVyICsgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwKewogICAgbGV0IG11dCBsYXN0X2Jsb2NrID0KICAgICAgICBzdGF0aWNfZmlsZV9wcm92aWRlci5nZXRfaGlnaGVzdF9zdGF0aWNfZmlsZV9ibG9jayhzZWdtZW50KS51bndyYXBfb3JfZGVmYXVsdCgpOwoKICAgIC8vIFRvIGJlIGV4dHJhIHNhZmUsIHdlIG1ha2Ugc3VyZSB0aGF0IHRoZSBsYXN0IHR4IG51bSBtYXRjaGVzIHRoZSBsYXN0IGJsb2NrIGZyb20gaXRzIGluZGljZXMuCiAgICAvLyBJZiBub3QsIGdldCBpdC4KICAgIGxvb3AgewogICAgICAgIGlmIGxldCBTb21lKGluZGljZXMpID0gcHJvdmlkZXIuYmxvY2tfYm9keV9pbmRpY2VzKGxhc3RfYmxvY2spPyAmJgogICAgICAgICAgICBpbmRpY2VzLmxhc3RfdHhfbnVtKCkgPD0gbGFzdF90eF9udW0KICAgICAgICB7CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICAgIGlmIGxhc3RfYmxvY2sgPT0gMCB7CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICAgIGxhc3RfYmxvY2sgLT0gMTsKICAgIH0KCiAgICBsZXQgbWlzc2luZ19ibG9jayA9IEJveDo6bmV3KHByb3ZpZGVyLnNlYWxlZF9oZWFkZXIobGFzdF9ibG9jayArIDEpPy51bndyYXBfb3JfZGVmYXVsdCgpKTsKCiAgICBPayhTdGFnZUVycm9yOjpNaXNzaW5nU3RhdGljRmlsZURhdGEgewogICAgICAgIGJsb2NrOiBCb3g6Om5ldyhtaXNzaW5nX2Jsb2NrLmJsb2NrX3dpdGhfcGFyZW50KCkpLAogICAgICAgIHNlZ21lbnQsCiAgICB9KQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvc3RhZ2VzL3NyYy9saWIucnMiPgovLyEgU3RhZ2VkIHN5bmNpbmcgcHJpbWl0aXZlcyBmb3IgcmV0aC4KLy8hCi8vISBUaGlzIGNyYXRlIGNvbnRhaW5zIHRoZSBzeW5jaW5nIHByaW1pdGl2ZXMgW2BQaXBlbGluZWBdIGFuZCBbYFN0YWdlYF0sIGFzIHdlbGwgYXMgYWxsIHN0YWdlcwovLyEgdGhhdCByZXRoIHVzZXMgdG8gc3luYy4KLy8hCi8vISBBIHBpcGVsaW5lIGNhbiBiZSBjb25maWd1cmVkIHVzaW5nIFtgUGlwZWxpbmU6OmJ1aWxkZXIoKWBdLgovLyEKLy8hIEZvciBlYXNlIG9mIHVzZSwgdGhpcyBjcmF0ZSBhbHNvIGV4cG9zZXMgYSBzZXQgb2YgW2BTdGFnZVNldGBdcywgd2hpY2ggYXJlIGNvbGxlY3Rpb25zIG9mIHN0YWdlcwovLyEgdGhhdCBwZXJmb3JtIHNwZWNpZmljIGZ1bmN0aW9ucyBkdXJpbmcgc3luYy4gU3RhZ2Ugc2V0cyBjYW4gYmUgY3VzdG9taXplZDsgaXQgaXMgcG9zc2libGUgdG8KLy8hIGFkZCwgZGlzYWJsZSBhbmQgcmVwbGFjZSBzdGFnZXMgaW4gdGhlIHNldC4KLy8hCi8vISAjIEV4YW1wbGVzCi8vIQovLyEgYGBgCi8vISAjIHVzZSBzdGQ6OnN5bmM6OkFyYzsKLy8hICMgdXNlIHJldGhfZG93bmxvYWRlcnM6OmJvZGllczo6Ym9kaWVzOjpCb2RpZXNEb3dubG9hZGVyQnVpbGRlcjsKLy8hICMgdXNlIHJldGhfZG93bmxvYWRlcnM6OmhlYWRlcnM6OnJldmVyc2VfaGVhZGVyczo6UmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyQnVpbGRlcjsKLy8hICMgdXNlIHJldGhfbmV0d29ya19wMnA6OnRlc3RfdXRpbHM6OntUZXN0Qm9kaWVzQ2xpZW50LCBUZXN0SGVhZGVyc0NsaWVudH07Ci8vISAjIHVzZSBhbGxveV9wcmltaXRpdmVzOjpCMjU2OwovLyEgIyB1c2UgcmV0aF9jaGFpbnNwZWM6Ok1BSU5ORVQ7Ci8vISAjIHVzZSByZXRoX3BydW5lX3R5cGVzOjpQcnVuZU1vZGVzOwovLyEgIyB1c2UgcmV0aF9uZXR3b3JrX3BlZXJzOjpQZWVySWQ7Ci8vISAjIHVzZSByZXRoX3N0YWdlczo6UGlwZWxpbmU7Ci8vISAjIHVzZSByZXRoX3N0YWdlczo6c2V0czo6RGVmYXVsdFN0YWdlczsKLy8hICMgdXNlIHRva2lvOjpzeW5jOjp3YXRjaDsKLy8hICMgdXNlIHJldGhfZXZtX2V0aGVyZXVtOjpFdGhFdm1Db25maWc7Ci8vISAjIHVzZSByZXRoX3Byb3ZpZGVyOjpQcm92aWRlckZhY3Rvcnk7Ci8vISAjIHVzZSByZXRoX3Byb3ZpZGVyOjpTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5OwovLyEgIyB1c2UgcmV0aF9wcm92aWRlcjo6dGVzdF91dGlsczo6e2NyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnksIE1vY2tOb2RlVHlwZXNXaXRoREJ9OwovLyEgIyB1c2UgcmV0aF9zdGF0aWNfZmlsZTo6U3RhdGljRmlsZVByb2R1Y2VyOwovLyEgIyB1c2UgcmV0aF9jb25maWc6OmNvbmZpZzo6U3RhZ2VDb25maWc7Ci8vISAjIHVzZSByZXRoX2NvbnNlbnN1czo6Q29uc2Vuc3VzOwovLyEgIyB1c2UgcmV0aF9jb25zZW5zdXM6OnRlc3RfdXRpbHM6OlRlc3RDb25zZW5zdXM7Ci8vISAjIHVzZSByZXRoX2NvbnNlbnN1czo6RnVsbENvbnNlbnN1czsKLy8hICMKLy8hICMgbGV0IGNoYWluX3NwZWMgPSBNQUlOTkVULmNsb25lKCk7Ci8vISAjIGxldCBjb25zZW5zdXM6IEFyYzxkeW4gRnVsbENvbnNlbnN1czxyZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkV0aFByaW1pdGl2ZXM+PiA9IEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSk7Ci8vISAjIGxldCBoZWFkZXJzX2Rvd25sb2FkZXIgPSBSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJCdWlsZGVyOjpkZWZhdWx0KCkuYnVpbGQoCi8vISAjICAgIEFyYzo6bmV3KFRlc3RIZWFkZXJzQ2xpZW50OjpkZWZhdWx0KCkpLAovLyEgIyAgICBjb25zZW5zdXMuY2xvbmUoKQovLyEgIyApOwovLyEgIyBsZXQgcHJvdmlkZXJfZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKLy8hICMgbGV0IGJvZGllc19kb3dubG9hZGVyID0gQm9kaWVzRG93bmxvYWRlckJ1aWxkZXI6OmRlZmF1bHQoKS5idWlsZCgKLy8hICMgICAgQXJjOjpuZXcoVGVzdEJvZGllc0NsaWVudCB7IHJlc3BvbmRlcjogfF98IE9rKChQZWVySWQ6OlpFUk8sIHZlYyFbXSkuaW50bygpKSB9KSwKLy8hICMgICAgY29uc2Vuc3VzLmNsb25lKCksCi8vISAjICAgIHByb3ZpZGVyX2ZhY3RvcnkuY2xvbmUoKQovLyEgIyApOwovLyEgIyBsZXQgKHRpcF90eCwgdGlwX3J4KSA9IHdhdGNoOjpjaGFubmVsKEIyNTY6OmRlZmF1bHQoKSk7Ci8vISAjIGxldCBleGVjdXRvcl9wcm92aWRlciA9IEV0aEV2bUNvbmZpZzo6bWFpbm5ldCgpOwovLyEgIyBsZXQgc3RhdGljX2ZpbGVfcHJvZHVjZXIgPSBTdGF0aWNGaWxlUHJvZHVjZXI6Om5ldygKLy8hICMgICAgcHJvdmlkZXJfZmFjdG9yeS5jbG9uZSgpLAovLyEgIyAgICBQcnVuZU1vZGVzOjpkZWZhdWx0KCkKLy8hICMgKTsKLy8hICMgbGV0IGVyYV9pbXBvcnRfc291cmNlID0gTm9uZTsKLy8hIC8vIENyZWF0ZSBhIHBpcGVsaW5lIHRoYXQgY2FuIGZ1bGx5IHN5bmMKLy8hICMgbGV0IHBpcGVsaW5lID0KLy8hIFBpcGVsaW5lOjo8TW9ja05vZGVUeXBlc1dpdGhEQj46OmJ1aWxkZXIoKQovLyEgICAgIC53aXRoX3RpcF9zZW5kZXIodGlwX3R4KQovLyEgICAgIC5hZGRfc3RhZ2VzKERlZmF1bHRTdGFnZXM6Om5ldygKLy8hICAgICAgICAgcHJvdmlkZXJfZmFjdG9yeS5jbG9uZSgpLAovLyEgICAgICAgICB0aXBfcngsCi8vISAgICAgICAgIGNvbnNlbnN1cywKLy8hICAgICAgICAgaGVhZGVyc19kb3dubG9hZGVyLAovLyEgICAgICAgICBib2RpZXNfZG93bmxvYWRlciwKLy8hICAgICAgICAgZXhlY3V0b3JfcHJvdmlkZXIsCi8vISAgICAgICAgIFN0YWdlQ29uZmlnOjpkZWZhdWx0KCksCi8vISAgICAgICAgIFBydW5lTW9kZXM6OmRlZmF1bHQoKSwKLy8hICAgICAgICAgZXJhX2ltcG9ydF9zb3VyY2UsCi8vISAgICAgKSkKLy8hICAgICAuYnVpbGQocHJvdmlkZXJfZmFjdG9yeSwgc3RhdGljX2ZpbGVfcHJvZHVjZXIpOwovLyEgYGBgCi8vIQovLyEgIyMgRmVhdHVyZSBGbGFncwovLyEKLy8hIC0gYHRlc3QtdXRpbHNgOiBFeHBvcnQgdXRpbGl0aWVzIGZvciB0ZXN0aW5nCgojIVtkb2MoCiAgICBodG1sX2xvZ29fdXJsID0gImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9wYXJhZGlnbXh5ei9yZXRoL21haW4vYXNzZXRzL3JldGgtZG9jcy5wbmciLAogICAgaHRtbF9mYXZpY29uX3VybCA9ICJodHRwczovL2F2YXRhcnMwLmdpdGh1YnVzZXJjb250ZW50LmNvbS91Lzk3MzY5NDY2P3M9MjU2IiwKICAgIGlzc3VlX3RyYWNrZXJfYmFzZV91cmwgPSAiaHR0cHM6Ly9naXRodWIuY29tL3BhcmFkaWdteHl6L3JldGgvaXNzdWVzLyIKKV0KIyFbY2ZnX2F0dHIoZG9jc3JzLCBmZWF0dXJlKGRvY19jZmcpKV0KIyFbY2ZnX2F0dHIobm90KHRlc3QpLCB3YXJuKHVudXNlZF9jcmF0ZV9kZXBlbmRlbmNpZXMpKV0KCiNbZXhwZWN0KG1pc3NpbmdfZG9jcyldCiNbY2ZnKGFueSh0ZXN0LCBmZWF0dXJlID0gInRlc3QtdXRpbHMiKSldCnB1YiBtb2QgdGVzdF91dGlsczsKCi8vLyBBIHJlLWV4cG9ydCBvZiBjb21tb24gc3RydWN0cyBhbmQgdHJhaXRzLgpwdWIgbW9kIHByZWx1ZGU7CgovLy8gSW1wbGVtZW50YXRpb25zIG9mIHN0YWdlcy4KcHViIG1vZCBzdGFnZXM7CgpwdWIgbW9kIHNldHM7CgovLyByZS1leHBvcnQgdGhlIHN0YWdlcyBBUEkKcHViIHVzZSByZXRoX3N0YWdlc19hcGk6Oio7CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvc3RhZ2VzL3NyYy9wcmVsdWRlLnJzIj4KcHViIHVzZSBjcmF0ZTo6c2V0czo6ewogICAgRGVmYXVsdFN0YWdlcywgRXhlY3V0aW9uU3RhZ2VzLCBIYXNoaW5nU3RhZ2VzLCBIaXN0b3J5SW5kZXhpbmdTdGFnZXMsIE9mZmxpbmVTdGFnZXMsCiAgICBPbmxpbmVTdGFnZXMsCn07CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvdHlwZXMvc3JjL2V4ZWN1dGlvbi5ycyI+CnVzZSBjb3JlOjp0aW1lOjpEdXJhdGlvbjsKCi8vLyBUaGUgdGhyZXNob2xkcyBhdCB3aGljaCB0aGUgZXhlY3V0aW9uIHN0YWdlIHdyaXRlcyBzdGF0ZSBjaGFuZ2VzIHRvIHRoZSBkYXRhYmFzZS4KLy8vCi8vLyBJZiBhbnkgb2YgdGhlIHRocmVzaG9sZHMgKGBtYXhfYmxvY2tzYCwgYG1heF9jaGFuZ2VzYCwgYG1heF9jdW11bGF0aXZlX2dhc2AsIG9yIGBtYXhfZHVyYXRpb25gKQovLy8gYXJlIGhpdCwgdGhlbiB0aGUgZXhlY3V0aW9uIHN0YWdlIGNvbW1pdHMgYWxsIHBlbmRpbmcgY2hhbmdlcyB0byB0aGUgZGF0YWJhc2UuCiNbZGVyaXZlKERlYnVnLCBDbG9uZSldCnB1YiBzdHJ1Y3QgRXhlY3V0aW9uU3RhZ2VUaHJlc2hvbGRzIHsKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2YgYmxvY2tzIHRvIGV4ZWN1dGUgYmVmb3JlIHRoZSBleGVjdXRpb24gc3RhZ2UgY29tbWl0cy4KICAgIHB1YiBtYXhfYmxvY2tzOiBPcHRpb248dTY0PiwKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2Ygc3RhdGUgY2hhbmdlcyB0byBrZWVwIGluIG1lbW9yeSBiZWZvcmUgdGhlIGV4ZWN1dGlvbiBzdGFnZSBjb21taXRzLgogICAgcHViIG1heF9jaGFuZ2VzOiBPcHRpb248dTY0PiwKICAgIC8vLyBUaGUgbWF4aW11bSBjdW11bGF0aXZlIGFtb3VudCBvZiBnYXMgdG8gcHJvY2VzcyBiZWZvcmUgdGhlIGV4ZWN1dGlvbiBzdGFnZSBjb21taXRzLgogICAgcHViIG1heF9jdW11bGF0aXZlX2dhczogT3B0aW9uPHU2ND4sCiAgICAvLy8gVGhlIG1heGltdW0gc3BlbnQgb24gYmxvY2tzIHByb2Nlc3NpbmcgYmVmb3JlIHRoZSBleGVjdXRpb24gc3RhZ2UgY29tbWl0cy4KICAgIHB1YiBtYXhfZHVyYXRpb246IE9wdGlvbjxEdXJhdGlvbj4sCn0KCmltcGwgRGVmYXVsdCBmb3IgRXhlY3V0aW9uU3RhZ2VUaHJlc2hvbGRzIHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgbWF4X2Jsb2NrczogU29tZSg1MDBfMDAwKSwKICAgICAgICAgICAgbWF4X2NoYW5nZXM6IFNvbWUoNV8wMDBfMDAwKSwKICAgICAgICAgICAgLy8gNTBrIGZ1bGwgYmxvY2tzIG9mIDMwTSBnYXMKICAgICAgICAgICAgbWF4X2N1bXVsYXRpdmVfZ2FzOiBTb21lKDMwXzAwMF8wMDAgKiA1MF8wMDApLAogICAgICAgICAgICAvLyAxMCBtaW51dGVzCiAgICAgICAgICAgIG1heF9kdXJhdGlvbjogU29tZShEdXJhdGlvbjo6ZnJvbV9zZWNzKDEwICogNjApKSwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgRXhlY3V0aW9uU3RhZ2VUaHJlc2hvbGRzIHsKICAgIC8vLyBDaGVjayBpZiB0aGUgYmF0Y2ggdGhyZXNob2xkcyBoYXZlIGJlZW4gaGl0LgogICAgI1tpbmxpbmVdCiAgICBwdWIgZm4gaXNfZW5kX29mX2JhdGNoKAogICAgICAgICZzZWxmLAogICAgICAgIGJsb2Nrc19wcm9jZXNzZWQ6IHU2NCwKICAgICAgICBjaGFuZ2VzX3Byb2Nlc3NlZDogdTY0LAogICAgICAgIGN1bXVsYXRpdmVfZ2FzX3VzZWQ6IHU2NCwKICAgICAgICBlbGFwc2VkOiBEdXJhdGlvbiwKICAgICkgLT4gYm9vbCB7CiAgICAgICAgYmxvY2tzX3Byb2Nlc3NlZCA+PSBzZWxmLm1heF9ibG9ja3MudW53cmFwX29yKHU2NDo6TUFYKSB8fAogICAgICAgICAgICBjaGFuZ2VzX3Byb2Nlc3NlZCA+PSBzZWxmLm1heF9jaGFuZ2VzLnVud3JhcF9vcih1NjQ6Ok1BWCkgfHwKICAgICAgICAgICAgY3VtdWxhdGl2ZV9nYXNfdXNlZCA+PSBzZWxmLm1heF9jdW11bGF0aXZlX2dhcy51bndyYXBfb3IodTY0OjpNQVgpIHx8CiAgICAgICAgICAgIGVsYXBzZWQgPj0gc2VsZi5tYXhfZHVyYXRpb24udW53cmFwX29yKER1cmF0aW9uOjpNQVgpCiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iZG9jcy9jcmF0ZXMvc3RhZ2VzLm1kIj4KIyBTdGFnZXMKClRoZSBgc3RhZ2VzYCBsaWIgcGxheXMgYSBjZW50cmFsIHJvbGUgaW4gc3luY2luZyB0aGUgbm9kZSwgbWFpbnRhaW5pbmcgc3RhdGUsIHVwZGF0aW5nIHRoZSBkYXRhYmFzZSBhbmQgbW9yZS4gVGhlIHN0YWdlcyBpbnZvbHZlZCBpbiB0aGUgUmV0aCBwaXBlbGluZSBhcmUgcXVldWVkIHVwIGFuZCBzdG9yZWQgd2l0aGluIHRoZSBSZXRoIHBpcGVsaW5lLiBJbiB0aGUgZGVmYXVsdCBjb25maWd1cmF0aW9uLCB0aGUgcGlwZWxpbmUgcnVucyB0aGUgZm9sbG93aW5nIHN0YWdlcyBpbiBvcmRlcjoKCi0gRXJhU3RhZ2UgKG9wdGlvbmFsLCBmb3IgRVJBMSBpbXBvcnQpCi0gSGVhZGVyU3RhZ2UKLSBCb2R5U3RhZ2UKLSBTZW5kZXJSZWNvdmVyeVN0YWdlCi0gRXhlY3V0aW9uU3RhZ2UKLSBQcnVuZVNlbmRlclJlY292ZXJ5U3RhZ2UgKGlmIHBydW5pbmcgZm9yIHNlbmRlciByZWNvdmVyeSBpcyBlbmFibGVkKQotIE1lcmtsZVN0YWdlICh1bndpbmQpCi0gQWNjb3VudEhhc2hpbmdTdGFnZQotIFN0b3JhZ2VIYXNoaW5nU3RhZ2UKLSBNZXJrbGVTdGFnZSAoZXhlY3V0ZSkKLSBNZXJrbGVDaGFuZ2VTZXRzCi0gVHJhbnNhY3Rpb25Mb29rdXBTdGFnZQotIEluZGV4U3RvcmFnZUhpc3RvcnlTdGFnZQotIEluZGV4QWNjb3VudEhpc3RvcnlTdGFnZQotIFBydW5lU3RhZ2UKLSBGaW5pc2hTdGFnZQoKCldoZW4gdGhlIG5vZGUgaXMgZmlyc3Qgc3RhcnRlZCwgYSBuZXcgYFBpcGVsaW5lYCBpcyBpbml0aWFsaXplZCBhbmQgYWxsIG9mIHRoZSBzdGFnZXMgYXJlIGFkZGVkIGludG8gYFBpcGVsaW5lLnN0YWdlc2AuIFRoZW4sIHRoZSBgUGlwZWxpbmU6OnJ1bmAgZnVuY3Rpb24gaXMgY2FsbGVkLCB3aGljaCBzdGFydHMgdGhlIHBpcGVsaW5lLCBleGVjdXRpbmcgYWxsIG9mIHRoZSBzdGFnZXMgY29udGludW91c2x5IGluIGFuIGluZmluaXRlIGxvb3AuIFRoaXMgcHJvY2VzcyBzeW5jcyB0aGUgY2hhaW4sIGtlZXBpbmcgZXZlcnl0aGluZyB1cCB0byBkYXRlIHdpdGggdGhlIGNoYWluIHRpcC4KCkVhY2ggc3RhZ2Ugd2l0aGluIHRoZSBwaXBlbGluZSBpbXBsZW1lbnRzIHRoZSBgU3RhZ2VgIHRyYWl0IHdoaWNoIHByb3ZpZGVzIGZ1bmN0aW9uIGludGVyZmFjZXMgdG8gZ2V0IHRoZSBzdGFnZSBpZCwgZXhlY3V0ZSB0aGUgc3RhZ2UgYW5kIHVud2luZCB0aGUgY2hhbmdlcyB0byB0aGUgZGF0YWJhc2UgaWYgdGhlcmUgd2FzIGFuIGlzc3VlIGR1cmluZyB0aGUgc3RhZ2UgZXhlY3V0aW9uLgoKVG8gZ2V0IGEgYmV0dGVyIGlkZWEgb2Ygd2hhdCBpcyBoYXBwZW5pbmcgYXQgZWFjaCBwYXJ0IG9mIHRoZSBwaXBlbGluZSwgbGV0J3Mgd2FsayB0aHJvdWdoIHdoYXQgaXMgZ29pbmcgb24gdW5kZXIgdGhlIGhvb2Qgd2hlbiBhIHN0YWdlIGlzIGV4ZWN1dGVkLCBzdGFydGluZyB3aXRoIGBFcmFTdGFnZWAuCgo8YnI+CgoKIyMgRXJhU3RhZ2UKClRoZSBgRXJhU3RhZ2VgIGlzIGFuIG9wdGlvbmFsIHN0YWdlIHRoYXQgaW1wb3J0cyBwcmUtbWVyZ2UgaGlzdG9yaWNhbCBibG9jayBkYXRhIGZyb20gW0VSQTEgZmlsZXNdKGh0dHBzOi8vZ2l0aHViLmNvbS9ldGgtY2xpZW50cy9lMnN0b3JlLWZvcm1hdC1zcGVjcy9ibG9iL21haW4vZm9ybWF0cy9lcmExLm1kKS4gRVJBMSBpcyBhIHN0YW5kYXJkaXplZCBmb3JtYXQgZm9yIHN0b3JpbmcgRXRoZXJldW0ncyBoaXN0b3JpY2FsIGNoYWluIGRhdGEsIGFsbG93aW5nIG5vZGVzIHRvIHF1aWNrbHkgYm9vdHN0cmFwIGJ5IGltcG9ydGluZyBwcmUtc3luY2VkIGRhdGEgaW5zdGVhZCBvZiBkb3dubG9hZGluZyBpdCBmcm9tIHBlZXJzLgoKV2hlbiBlbmFibGVkLCB0aGUgYEVyYVN0YWdlYCByZWFkcyBibG9jayBoZWFkZXJzIGFuZCBib2RpZXMgZnJvbSBFUkExIGZpbGVzIChlaXRoZXIgZnJvbSBhIGxvY2FsIGRpcmVjdG9yeSBvciBkb3dubG9hZGVkIGZyb20gYSByZW1vdGUgSFRUUCBob3N0KSBhbmQgd3JpdGVzIHRoZW0gZGlyZWN0bHkgdG8gc3RhdGljIGZpbGVzLiBUaGlzIHByb3ZpZGVzIGEgZmFzdGVyIGFsdGVybmF0aXZlIHRvIGRvd25sb2FkaW5nIGhpc3RvcmljYWwgZGF0YSBvdmVyIFAyUCwgZXNwZWNpYWxseSB1c2VmdWwgZm9yIHN5bmNpbmcgdGhlIHByZS1tZXJnZSBwb3J0aW9uIG9mIHRoZSBjaGFpbi4KClRoZSBzdGFnZSBwcm9jZXNzZXMgRVJBMSBmaWxlcyBzZXF1ZW50aWFsbHksIGV4dHJhY3RpbmcgaGVhZGVycyBhbmQgYm9kaWVzIGZyb20gZ2VuZXNpcyB1cCB0byB0aGUgbGFzdCBwcmUtbWVyZ2UgYmxvY2suIE5vdGUgdGhhdCByZWNlaXB0cyBhcmUgbm90IGluY2x1ZGVkIGluIEVSQTEgZmlsZXMgYW5kIHdpbGwgYmUgZ2VuZXJhdGVkIGxhdGVyIGR1cmluZyB0aGUgYEV4ZWN1dGlvblN0YWdlYC4KCklmIG5vIEVSQTEgc291cmNlIGlzIGNvbmZpZ3VyZWQgb3IgYWxsIEVSQTEgZGF0YSBoYXMgYmVlbiBpbXBvcnRlZCwgdGhlIHN0YWdlIHNpbXBseSBwYXNzZXMgdGhyb3VnaCwgYWxsb3dpbmcgc3Vic2VxdWVudCBzdGFnZXMgdG8gY29udGludWUgd2l0aCBQMlAtYmFzZWQgc3luY2luZy4KCjxicj4KCgojIyBIZWFkZXJTdGFnZQoKVGhlIGBIZWFkZXJTdGFnZWAgaXMgcmVzcG9uc2libGUgZm9yIHN5bmNpbmcgdGhlIGJsb2NrIGhlYWRlcnMsIHZhbGlkYXRpbmcgdGhlIGhlYWRlciBpbnRlZ3JpdHkgYW5kIHdyaXRpbmcgdGhlIGhlYWRlcnMgdG8gc3RvcmFnZS4gV2hlbiB0aGUgc3RhZ2UgcnVucywgaXQgZGV0ZXJtaW5lcyB0aGUgc3luYyBnYXAgYmV0d2VlbiB0aGUgbG9jYWwgaGVhZCBhbmQgdGhlIHRpcCwgdGhlbiBkb3dubG9hZHMgaGVhZGVycyBpbiByZXZlcnNlIChmcm9tIHRpcCBkb3duIHRvIHRoZSBsb2NhbCBoZWFkKSB1c2luZyBhIGBIZWFkZXJEb3dubG9hZGVyYCBzdHJlYW0uIEhlYWRlcnMgYXJlIGJ1ZmZlcmVkIGluIEVUTCBjb2xsZWN0b3JzIGFuZCB0aGVuIHdyaXR0ZW4gdG8gc3RhdGljIGZpbGVzIGFuZCB0byBgSGVhZGVyTnVtYmVyc2AgaW4gdGhlIGRhdGFiYXNlIGluIGEgc2luZ2xlIHN0ZXAuCgpUaGUgYEhlYWRlclN0YWdlYCByZWxpZXMgb24gdGhlIGRvd25sb2FkZXIgc3RyZWFtIHRvIHJldHVybiB0aGUgaGVhZGVycyBpbiBkZXNjZW5kaW5nIG9yZGVyIHN0YXJ0aW5nIGZyb20gdGhlIGNoYWluIHRpcCBkb3duIHRvIHRoZSBsYXRlc3QgYmxvY2sgaW4gdGhlIGRhdGFiYXNlLiBXaGlsZSBvdGhlciBzdGFnZXMgaW4gdGhlIGBQaXBlbGluZWAgc3RhcnQgZnJvbSB0aGUgbW9zdCByZWNlbnQgYmxvY2sgaW4gdGhlIGRhdGFiYXNlIHVwIHRvIHRoZSBjaGFpbiB0aXAsIHRoZSBgSGVhZGVyU3RhZ2VgIHdvcmtzIGluIHJldmVyc2UgdG8gYXZvaWQgW2xvbmctcmFuZ2UgYXR0YWNrc10oaHR0cHM6Ly9tZXNzYXJpLmlvL3JlcG9ydC9sb25nLXJhbmdlLWF0dGFjaykuIFdoZW4gYSBub2RlIGRvd25sb2FkcyBoZWFkZXJzIGluIGFzY2VuZGluZyBvcmRlciwgaXQgd2lsbCBub3Qga25vdyBpZiBpdCBpcyBiZWluZyBzdWJqZWN0ZWQgdG8gYSBsb25nLXJhbmdlIGF0dGFjayB1bnRpbCBpdCByZWFjaGVzIHRoZSBtb3N0IHJlY2VudCBibG9ja3MuIFRvIGNvbWJhdCB0aGlzLCB0aGUgYEhlYWRlclN0YWdlYCBzdGFydHMgYnkgZ2V0dGluZyB0aGUgY2hhaW4gdGlwLCB2ZXJpZmllcyB0aGUgdGlwLCBhbmQgdGhlbiB3YWxrcyBiYWNrd2FyZHMgYnkgdGhlIHBhcmVudCBoYXNoLgoKRWFjaCBoZWFkZXIgaXMgdmFsaWRhdGVkIHRvIGVuc3VyZSBpdCBjb3JyZWN0bHkgYXR0YWNoZXMgdG8gaXRzIHBhcmVudCBhbmQgY29uZm9ybXMgdG8gY29uc2Vuc3VzIGV4cGVjdGF0aW9ucyBieSB0aGUgZG93bmxvYWRlciBiZWZvcmUgaXQgaXMgeWllbGRlZC4gQWZ0ZXIgZG93bmxvYWQsIGhlYWRlcnMgYXJlIHdyaXR0ZW4gdG8gc3RvcmFnZS4gSWYgYSBoZWFkZXIgaXMgbm90IHZhbGlkIG9yIHRoZSBzdHJlYW0gZW5jb3VudGVycyBhbnkgb3RoZXIgZXJyb3IsIHRoZSBlcnJvciBpcyBwcm9wYWdhdGVkIHVwIHRocm91Z2ggdGhlIHN0YWdlIGV4ZWN1dGlvbiwgdGhlIGNoYW5nZXMgdG8gdGhlIGRhdGFiYXNlIGFyZSB1bndvdW5kIGFuZCB0aGUgc3RhZ2UgaXMgcmVzdW1lZCBmcm9tIHRoZSBtb3N0IHJlY2VudCB2YWxpZCBzdGF0ZS4KClRoaXMgcHJvY2VzcyBjb250aW51ZXMgdW50aWwgYWxsIG9mIHRoZSBoZWFkZXJzIGhhdmUgYmVlbiBkb3dubG9hZGVkIGFuZCB3cml0dGVuIHRvIHN0b3JhZ2UuIEZpbmFsbHksIHRoZSBmdW5jdGlvbiByZXR1cm5zLCBmb3IgZXhhbXBsZTogYE9rKEV4ZWNPdXRwdXQgeyBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhsYXN0X2hlYWRlcl9udW1iZXIpLndpdGhfaGVhZGVyc19zdGFnZV9jaGVja3BvaW50KC4uLiksIGRvbmU6IHRydWUgfSlgLCBzaWduYWxpbmcgdGhhdCB0aGUgaGVhZGVyIHN5bmMgaGFzIGJlZW4gY29tcGxldGVkIHN1Y2Nlc3NmdWxseS4KCjxicj4KCiMjIEJvZHlTdGFnZQoKT25jZSB0aGUgYEhlYWRlclN0YWdlYCBjb21wbGV0ZXMgc3VjY2Vzc2Z1bGx5LCB0aGUgYEJvZHlTdGFnZWAgd2lsbCBzdGFydCBleGVjdXRpb24uIFRoZSBib2R5IHN0YWdlIGRvd25sb2FkcyBibG9jayBib2RpZXMgZm9yIGFsbCBvZiB0aGUgbmV3IGJsb2NrIGhlYWRlcnMgdGhhdCB3ZXJlIHN0b3JlZCBsb2NhbGx5IGluIHRoZSBkYXRhYmFzZS4gVGhlIGBCb2R5U3RhZ2VgIGZpcnN0IGRldGVybWluZXMgd2hpY2ggYmxvY2sgYm9kaWVzIHRvIGRvd25sb2FkIGJ5IGNoZWNraW5nIGlmIHRoZSBibG9jayBib2R5IGhhcyBhbiBvbW1lcnMgaGFzaCBhbmQgdHJhbnNhY3Rpb24gcm9vdC4gCgpBbiBvbW1lcnMgaGFzaCBpcyB0aGUgS2VjY2FrIDI1Ni1iaXQgaGFzaCBvZiB0aGUgb21tZXJzIGxpc3QgcG9ydGlvbiBvZiB0aGUgYmxvY2suIElmIHlvdSBhcmUgdW5mYW1pbGlhciB3aXRoIG9tbWVycyBibG9ja3MsIHlvdSBjYW4gW2NsaWNrIGhlcmUgdG8gbGVhcm4gbW9yZV0oaHR0cHM6Ly9ldGhlcmV1bS5vcmcvZW4vZ2xvc3NhcnkvI29tbWVyKS4gTm90ZSB0aGF0IHdoaWxlIG9tbWVycyBibG9ja3Mgd2VyZSBpbXBvcnRhbnQgZm9yIG5ldyBibG9ja3MgY3JlYXRlZCBkdXJpbmcgRXRoZXJldW0ncyBwcm9vZiBvZiB3b3JrIGNoYWluLCBFdGhlcmV1bSdzIHByb29mIG9mIHN0YWtlIGNoYWluIHNlbGVjdHMgZXhhY3RseSBvbmUgYmxvY2sgcHJvcG9zZXIgYXQgYSB0aW1lLCBjYXVzaW5nIG9tbWVycyBibG9ja3Mgbm90IHRvIGJlIG5lZWRlZCBpbiBwb3N0LW1lcmdlIEV0aGVyZXVtLgoKVGhlIHRyYW5zYWN0aW9ucyByb290IGlzIGEgdmFsdWUgdGhhdCBpcyBjYWxjdWxhdGVkIGJhc2VkIG9uIHRoZSB0cmFuc2FjdGlvbnMgaW5jbHVkZWQgaW4gdGhlIGJsb2NrLiBUbyBkZXJpdmUgdGhlIHRyYW5zYWN0aW9ucyByb290LCBhIFttZXJrbGUgdHJlZV0oaHR0cHM6Ly9ibG9nLmV0aGVyZXVtLm9yZy8yMDE1LzExLzE1L21lcmtsaW5nLWluLWV0aGVyZXVtKSBpcyBjcmVhdGVkIGZyb20gdGhlIGJsb2NrJ3MgdHJhbnNhY3Rpb25zIGxpc3QuIFRoZSB0cmFuc2FjdGlvbnMgcm9vdCBpcyB0aGVuIGRlcml2ZWQgYnkgdGFraW5nIHRoZSBLZWNjYWsgMjU2LWJpdCBoYXNoIG9mIHRoZSByb290IG5vZGUgb2YgdGhlIG1lcmtsZSB0cmVlLgoKV2hlbiB0aGUgYEJvZHlTdGFnZWAgaXMgbG9va2luZyBhdCB0aGUgaGVhZGVycyB0byBkZXRlcm1pbmUgd2hpY2ggYmxvY2sgdG8gZG93bmxvYWQsIGl0IHdpbGwgc2tpcCB0aGUgYmxvY2tzIHdoZXJlIHRoZSBgaGVhZGVyLm9tbWVyc19oYXNoYCBhbmQgdGhlIGBoZWFkZXIudHJhbnNhY3Rpb25fcm9vdGAgYXJlIGVtcHR5LCBkZW5vdGluZyB0aGF0IHRoZSBibG9jayBpcyBlbXB0eSBhcyB3ZWxsLgoKT25jZSB0aGUgYEJvZHlTdGFnZWAgZGV0ZXJtaW5lcyB3aGljaCBibG9jayBib2RpZXMgdG8gZmV0Y2gsIGEgbmV3IGBib2RpZXNfc3RyZWFtYCBpcyBjcmVhdGVkIHdoaWNoIGRvd25sb2FkcyBhbGwgb2YgdGhlIGJvZGllcyBmcm9tIHRoZSBgc3RhcnRpbmdfYmxvY2tgLCB1cCB1bnRpbCB0aGUgYHRhcmdldF9ibG9ja2AgaXMgc3BlY2lmaWVkLiBFYWNoIHRpbWUgdGhlIGBib2RpZXNfc3RyZWFtYCB5aWVsZHMgYSB2YWx1ZSwgYSByZXNwb25zZSBpcyByZWNlaXZlZCBpbmRpY2F0aW5nIGVpdGhlciBhbiBlbXB0eSBibG9jayBvciBhIGZ1bGwgYmxvY2sgYm9keSB0byBiZSB3cml0dGVuLgoKVGhlIGBCb2R5U3RhZ2VgIHdyaXRlcyB0aGUgcmVjZWl2ZWQgYmxvY2sgYm9kaWVzIHRvIHN0b3JhZ2UuIFZhbGlkYXRpb24gb2YgYmxvY2sgYm9keSBjb3JyZWN0bmVzcyByZWxhdGl2ZSB0byBoZWFkZXJzIGlzIGVuZm9yY2VkIGJ5IHRoZSBkb3dubG9hZGVyIGFuZCBsYXRlciBieSBleGVjdXRpb24vY29uc2Vuc3VzLiBUaGlzIHByb2Nlc3MgaXMgcmVwZWF0ZWQgZm9yIGV2ZXJ5IGRvd25sb2FkZWQgYmxvY2sgYm9keSwgd2l0aCB0aGUgYEJvZHlTdGFnZWAgcmV0dXJuaW5nIGBPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoaGlnaGVzdF9ibG9jaykud2l0aF9lbnRpdGllc19zdGFnZV9jaGVja3BvaW50KC4uLiksIGRvbmU6IC4uLiB9KWAgc2lnbmFsaW5nIHByb2dyZXNzL2NvbXBsZXRpb24uCgo8YnI+CgojIyBTZW5kZXJSZWNvdmVyeVN0YWdlCgpGb2xsb3dpbmcgYSBzdWNjZXNzZnVsIGBCb2R5U3RhZ2VgLCB0aGUgYFNlbmRlclJlY292ZXJ5U3RhZ2VgIHN0YXJ0cyB0byBleGVjdXRlLiBUaGUgYFNlbmRlclJlY292ZXJ5U3RhZ2VgIGlzIHJlc3BvbnNpYmxlIGZvciByZWNvdmVyaW5nIHRoZSB0cmFuc2FjdGlvbiBzZW5kZXIgZm9yIGVhY2ggb2YgdGhlIG5ld2x5IGFkZGVkIHRyYW5zYWN0aW9ucyB0byB0aGUgZGF0YWJhc2UuIEF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGV4ZWN1dGlvbiBmdW5jdGlvbiwgYWxsIG9mIHRoZSB0cmFuc2FjdGlvbnMgYXJlIGZpcnN0IHJldHJpZXZlZCBmcm9tIHRoZSBkYXRhYmFzZS4gVGhlbiB0aGUgYFNlbmRlclJlY292ZXJ5U3RhZ2VgIGdvZXMgdGhyb3VnaCBlYWNoIHRyYW5zYWN0aW9uIGFuZCByZWNvdmVycyB0aGUgc2lnbmVyIGZyb20gdGhlIHRyYW5zYWN0aW9uIHNpZ25hdHVyZSBhbmQgaGFzaC4gVGhlIHRyYW5zYWN0aW9uIGhhc2ggaXMgZGVyaXZlZCBieSB0YWtpbmcgdGhlIEtlY2NhayAyNTYtYml0IGhhc2ggb2YgdGhlIFJMUCBlbmNvZGVkIHRyYW5zYWN0aW9uIGJ5dGVzLiBUaGlzIGhhc2ggaXMgdGhlbiBwYXNzZWQgaW50byB0aGUgYHJlY292ZXJfc2lnbmVyYCBmdW5jdGlvbi4KCkluIGFuIFtFQ0RTQSAoRWxsaXB0aWMgQ3VydmUgRGlnaXRhbCBTaWduYXR1cmUgQWxnb3JpdGhtKSBzaWduYXR1cmVdKGh0dHBzOi8vd2lraXBlZGlhLm9yZy93aWtpL0VsbGlwdGljX0N1cnZlX0RpZ2l0YWxfU2lnbmF0dXJlX0FsZ29yaXRobSksIHRoZSAiciIsICJzIiwgYW5kICJ2IiB2YWx1ZXMgYXJlIHRocmVlIHBpZWNlcyBvZiBkYXRhIHRoYXQgYXJlIHVzZWQgdG8gbWF0aGVtYXRpY2FsbHkgdmVyaWZ5IHRoZSBhdXRoZW50aWNpdHkgb2YgYSBkaWdpdGFsIHNpZ25hdHVyZS4gRUNEU0EgaXMgYSB3aWRlbHkgdXNlZCBhbGdvcml0aG0gZm9yIGdlbmVyYXRpbmcgYW5kIHZlcmlmeWluZyBkaWdpdGFsIHNpZ25hdHVyZXMsIGFuZCBpdCBpcyBvZnRlbiB1c2VkIGluIGNyeXB0b2N1cnJlbmNpZXMgbGlrZSBFdGhlcmV1bS4KClRoZSAiciIgaXMgdGhlIHgtY29vcmRpbmF0ZSBvZiBhIHBvaW50IG9uIHRoZSBlbGxpcHRpYyBjdXJ2ZSB0aGF0IGlzIGNhbGN1bGF0ZWQgYXMgcGFydCBvZiB0aGUgc2lnbmF0dXJlIHByb2Nlc3MuIFRoZSAicyIgaXMgdGhlIHMtdmFsdWUgdGhhdCBpcyBjYWxjdWxhdGVkIGR1cmluZyB0aGUgc2lnbmF0dXJlIHByb2Nlc3MuIEl0IGlzIGRlcml2ZWQgZnJvbSB0aGUgcHJpdmF0ZSBrZXkgYW5kIHRoZSBtZXNzYWdlIGJlaW5nIHNpZ25lZC4gTGFzdGx5LCB0aGUgInYiIGlzIHRoZSAicmVjb3ZlcnkgdmFsdWUiIHRoYXQgaXMgdXNlZCB0byByZWNvdmVyIHRoZSBwdWJsaWMga2V5IGZyb20gdGhlIHNpZ25hdHVyZSwgd2hpY2ggaXMgZGVyaXZlZCBmcm9tIHRoZSBzaWduYXR1cmUgYW5kIHRoZSBtZXNzYWdlIHRoYXQgd2FzIHNpZ25lZC4gVG9nZXRoZXIsIHRoZSAiciIsICJzIiwgYW5kICJ2IiB2YWx1ZXMgbWFrZSB1cCBhbiBFQ0RTQSBzaWduYXR1cmUsIGFuZCB0aGV5IGFyZSB1c2VkIHRvIHZlcmlmeSB0aGUgYXV0aGVudGljaXR5IG9mIHRoZSBzaWduZWQgdHJhbnNhY3Rpb24uCgpPbmNlIHRoZSB0cmFuc2FjdGlvbiBzaWduZXIgaGFzIGJlZW4gcmVjb3ZlcmVkLCB0aGUgc2lnbmVyIGlzIHRoZW4gYWRkZWQgdG8gdGhlIGRhdGFiYXNlLiBUaGlzIHByb2Nlc3MgaXMgcmVwZWF0ZWQgZm9yIGV2ZXJ5IHRyYW5zYWN0aW9uIHRoYXQgd2FzIHJldHJpZXZlZCwgYW5kIHNpbWlsYXJseSB0byBwcmV2aW91cyBzdGFnZXMsIGBPayhFeGVjT3V0cHV0IHsgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoZW5kX2Jsb2NrKS53aXRoX2VudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQoLi4uKSwgZG9uZTogLi4uIH0pYCBpcyByZXR1cm5lZCB0byBzaWduYWwgYSBzdWNjZXNzZnVsIGNvbXBsZXRpb24gb2YgdGhlIHN0YWdlLgoKPGJyPgoKIyMgRXhlY3V0aW9uU3RhZ2UKCkZpbmFsbHksIGFmdGVyIGFsbCBoZWFkZXJzLCBib2RpZXMgYW5kIHNlbmRlcnMgYXJlIGFkZGVkIHRvIHRoZSBkYXRhYmFzZSwgdGhlIGBFeGVjdXRpb25TdGFnZWAgc3RhcnRzIHRvIGV4ZWN1dGUuIFRoaXMgc3RhZ2UgaXMgcmVzcG9uc2libGUgZm9yIGV4ZWN1dGluZyBhbGwgb2YgdGhlIHRyYW5zYWN0aW9ucyBhbmQgdXBkYXRpbmcgdGhlIHN0YXRlIHN0b3JlZCBpbiB0aGUgZGF0YWJhc2UuCgpBZnRlciBhbGwgaGVhZGVycyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyB0cmFuc2FjdGlvbnMgaGF2ZSBiZWVuIGV4ZWN1dGVkLCBhbGwgb2YgdGhlIHJlc3VsdGluZyBzdGF0ZSBjaGFuZ2VzIGFyZSBhcHBsaWVkIHRvIHRoZSBkYXRhYmFzZSwgdXBkYXRpbmcgYWNjb3VudCBiYWxhbmNlcywgYWNjb3VudCBieXRlY29kZSBhbmQgb3RoZXIgc3RhdGUgY2hhbmdlcy4gSW4gcG9zdC1NZXJnZSBFdGhlcmV1bSwgdGhlcmUgaXMgbm8gaW5mbGF0aW9uYXJ5IGJsb2NrIHJld2FyZCBvbiB0aGUgRXhlY3V0aW9uIExheWVyOyBmZWVzL3ByaW9yaXR5IHRpcHMgYXJlIGhhbmRsZWQgd2l0aGluIHRyYW5zYWN0aW9uIGV4ZWN1dGlvbi4KCkF0IHRoZSBlbmQgb2YgdGhlIGBleGVjdXRlKClgIGZ1bmN0aW9uLCBhIGZhbWlsaWFyIHZhbHVlIGlzIHJldHVybmVkLCBgT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KHN0YWdlX3Byb2dyZXNzKS53aXRoX2V4ZWN1dGlvbl9zdGFnZV9jaGVja3BvaW50KC4uLiksIGRvbmU6IC4uLiB9KWAgc2lnbmFsaW5nIGEgc3VjY2Vzc2Z1bCBjb21wbGV0aW9uIG9mIHRoZSBgRXhlY3V0aW9uU3RhZ2VgLgoKPGJyPgoKIyMgTWVya2xlVW53aW5kU3RhZ2UKClRoZSBgTWVya2xlVW53aW5kU3RhZ2VgIGlzIHJlc3BvbnNpYmxlIGZvciB1bndpbmRpbmcgdGhlIE1lcmtsZSBQYXRyaWNpYSB0cmllIHdoZW4gcmVvcmdzIG9jY3VyIG9yIHdoZW4gdGhlcmUncyBhIG5lZWQgdG8gcm9sbCBiYWNrIHN0YXRlIGNoYW5nZXMuIFRoaXMgZW5zdXJlcyB0aGUgdHJpZSByZW1haW5zIGNvbnNpc3RlbnQgd2l0aCB0aGUgY2hhaW4ncyBjYW5vbmljYWwgaGlzdG9yeSBieSByZXZlcnRpbmcgY2hhbmdlcyBiZXlvbmQgdGhlIHVud2luZCBwb2ludC4gSXQgdHlwaWNhbGx5IHJ1bnMgYmVmb3JlIHRoZSBoYXNoaW5nIHN0YWdlcyB0byB1bndpbmQgdHJpZSBzdGF0ZSBkdXJpbmcgcmVvcmdzIG9yIHJvbGxiYWNrcy4KCiMjIE1lcmtsZUV4ZWN1dGVTdGFnZQoKVGhlIGBNZXJrbGVFeGVjdXRlU3RhZ2VgIHJ1bnMgYWZ0ZXIgYEFjY291bnRIYXNoaW5nU3RhZ2VgIGFuZCBgU3RvcmFnZUhhc2hpbmdTdGFnZWAgYW5kIGlzIHJlc3BvbnNpYmxlIGZvciBjb25zdHJ1Y3Rpbmcgb3IgdXBkYXRpbmcgdGhlIHN0YXRlIHJvb3QgYmFzZWQgb24gdGhlIGxhdGVzdCBoYXNoZWQgYWNjb3VudCBhbmQgc3RvcmFnZSBkYXRhLiBJdCBwcm9jZXNzZXMgc3RhdGUgY2hhbmdlcyBmcm9tIGV4ZWN1dGVkIHRyYW5zYWN0aW9ucyBhbmQgbWFpbnRhaW5zIHRoZSBzdGF0ZSByb290IGluY2x1ZGVkIGluIGJsb2NrIGhlYWRlcnMuCgo8YnI+CgojIyBBY2NvdW50SGFzaGluZ1N0YWdlCgpUaGUgYEFjY291bnRIYXNoaW5nU3RhZ2VgIGhhbmRsZXMgdGhlIGNvbXB1dGF0aW9uIG9mIGFjY291bnQgc3RhdGUgaGFzaGVzLiBJdCBwcm9jZXNzZXMgYWxsIGFjY291bnRzIGluIHRoZSBzdGF0ZSBhbmQgY29tcHV0ZXMgdGhlaXIgY3J5cHRvZ3JhcGhpYyBoYXNoZXMsIHdoaWNoIGFyZSBlc3NlbnRpYWwgZm9yIGJ1aWxkaW5nIHRoZSBzdGF0ZSB0cmllLiBUaGlzIHN0YWdlIGlzIGNydWNpYWwgZm9yIG1haW50YWluaW5nIHRoZSBpbnRlZ3JpdHkgb2YgdGhlIHN0YXRlIGFuZCBlbmFibGluZyBlZmZpY2llbnQgc3RhdGUgcHJvb2YgdmVyaWZpY2F0aW9uLgoKPGJyPgoKIyMgU3RvcmFnZUhhc2hpbmdTdGFnZQoKVGhlIGBTdG9yYWdlSGFzaGluZ1N0YWdlYCBpcyByZXNwb25zaWJsZSBmb3IgY29tcHV0aW5nIGhhc2hlcyBvZiBjb250cmFjdCBzdG9yYWdlLiBTaW1pbGFyIHRvIHRoZSBgQWNjb3VudEhhc2hpbmdTdGFnZWAsIGl0IHByb2Nlc3NlcyBzdG9yYWdlIHNsb3RzIG9mIHNtYXJ0IGNvbnRyYWN0cyBhbmQgZ2VuZXJhdGVzIGNyeXB0b2dyYXBoaWMgaGFzaGVzIHRoYXQgYXJlIHVzZWQgaW4gdGhlIHN0YXRlIHRyaWUuIFRoaXMgc3RhZ2UgZW5zdXJlcyB0aGF0IGNvbnRyYWN0IHN0b3JhZ2UgY2FuIGJlIGVmZmljaWVudGx5IHZlcmlmaWVkIGFuZCBwcm92ZW4uCgo8YnI+CgojIyBNZXJrbGVDaGFuZ2VTZXRzCgpUaGUgYE1lcmtsZUNoYW5nZVNldHNgIHN0YWdlIGNvbnNvbGlkYXRlcyBhbmQgZmluYWxpemVzIE1lcmtsZS1yZWxhdGVkIGNoYW5nZSBzZXRzIGFmdGVyIHRoZSBgTWVya2xlU3RhZ2VgIGV4ZWN1dGlvbiBtb2RlIGhhcyBydW4sIGVuc3VyaW5nIGNvbnNpc3RlbnQgdHJpZSB1cGRhdGVzIGFuZCBjaGVja3BvaW50cy4KCjxicj4KCiMjIFRyYW5zYWN0aW9uTG9va3VwU3RhZ2UKClRoZSBgVHJhbnNhY3Rpb25Mb29rdXBTdGFnZWAgYnVpbGRzIGFuZCBtYWludGFpbnMgdHJhbnNhY3Rpb24gbG9va3VwIGluZGljZXMuIFRoZXNlIGluZGljZXMgZW5hYmxlIGVmZmljaWVudCBxdWVyeWluZyBvZiB0cmFuc2FjdGlvbnMgYnkgaGFzaCBvciBibG9jayBwb3NpdGlvbi4gVGhpcyBzdGFnZSBpcyBjcnVjaWFsIGZvciBSUEMgZnVuY3Rpb25hbGl0eSwgYWxsb3dpbmcgdXNlcnMgdG8gcXVpY2tseSByZXRyaWV2ZSB0cmFuc2FjdGlvbiBpbmZvcm1hdGlvbiB3aXRob3V0IHNjYW5uaW5nIHRoZSBlbnRpcmUgYmxvY2tjaGFpbi4KCjxicj4KCiMjIEluZGV4U3RvcmFnZUhpc3RvcnlTdGFnZQoKVGhlIGBJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2VgIGNyZWF0ZXMgaW5kaWNlcyBmb3IgaGlzdG9yaWNhbCBjb250cmFjdCBzdG9yYWdlIHN0YXRlcy4gSXQgdHJhY2tzIGhvdyBjb250cmFjdCBzdG9yYWdlIHZhbHVlcyBjaGFuZ2Ugb3ZlciB0aW1lLCBlbmFibGluZyBoaXN0b3JpY2FsIHN0YXRlIHF1ZXJpZXMuIFRoaXMgaXMgZXNzZW50aWFsIGZvciBmZWF0dXJlcyBsaWtlIHN0YXRlIGRlYnVnZ2luZywgdHJhbnNhY3Rpb24gdHJhY2luZywgYW5kIGhpc3RvcmljYWwgc3RhdGUgYWNjZXNzLgoKPGJyPgoKIyMgSW5kZXhBY2NvdW50SGlzdG9yeVN0YWdlCgpUaGUgYEluZGV4QWNjb3VudEhpc3RvcnlTdGFnZWAgYnVpbGRzIGluZGljZXMgZm9yIGFjY291bnQgaGlzdG9yeSwgdHJhY2tpbmcgaG93IGFjY291bnQgc3RhdGVzIChiYWxhbmNlLCBub25jZSwgY29kZSkgY2hhbmdlIG92ZXIgdGltZS4gU2ltaWxhciB0byB0aGUgc3RvcmFnZSBoaXN0b3J5IHN0YWdlLCB0aGlzIGVuYWJsZXMgaGlzdG9yaWNhbCBxdWVyaWVzIG9mIGFjY291bnQgc3RhdGVzIGF0IGFueSBibG9jayBoZWlnaHQsIHdoaWNoIGlzIGNydWNpYWwgZm9yIGRlYnVnZ2luZyBhbmQgYW5hbHlzaXMgdG9vbHMuCgo8YnI+CgojIyBQcnVuZVNlbmRlclJlY292ZXJ5U3RhZ2UKClRoZSBgUHJ1bmVTZW5kZXJSZWNvdmVyeVN0YWdlYCByZW1vdmVzIGVudHJpZXMgZnJvbSBgVHJhbnNhY3Rpb25TZW5kZXJzYCBhY2NvcmRpbmcgdG8gY29uZmlndXJlZCBwcnVuZSBtb2Rlcy4gSXQgdHlwaWNhbGx5IHJ1bnMgYWZ0ZXIgYEV4ZWN1dGlvblN0YWdlYCB3aGVuIHBydW5pbmcgZm9yIHNlbmRlciByZWNvdmVyeSBpcyBlbmFibGVkLgoKPGJyPgoKIyMgUHJ1bmVTdGFnZQoKVGhlIGBQcnVuZVN0YWdlYCBwZXJmb3JtcyBwcnVuaW5nIGZvciB0aGUgY29uZmlndXJlZCBzZWdtZW50cyAoc3VjaCBhcyBoaXN0b3J5IHRhYmxlcykgYmFzZWQgb24gYFBydW5lTW9kZXNgLiBJdCBydW5zIGFmdGVyIGhhc2hpbmcvbWVya2xlIGFuZCBoaXN0b3J5IGluZGV4aW5nIHN0YWdlcy4KCjxicj4KCiMjIEZpbmlzaFN0YWdlCgpUaGUgYEZpbmlzaFN0YWdlYCBpcyB0aGUgZmluYWwgc3RhZ2UgaW4gdGhlIHBpcGVsaW5lIHRoYXQgcGVyZm9ybXMgY2xlYW51cCBhbmQgdmVyaWZpY2F0aW9uIHRhc2tzLiBJdCBlbnN1cmVzIHRoYXQgYWxsIHByZXZpb3VzIHN0YWdlcyBoYXZlIGJlZW4gY29tcGxldGVkIHN1Y2Nlc3NmdWxseSBhbmQgdGhhdCB0aGUgbm9kZSdzIHN0YXRlIGlzIGNvbnNpc3RlbnQuIFRoaXMgc3RhZ2UgbWF5IGFsc28gdXBkYXRlIHZhcmlvdXMgbWV0cmljcyBhbmQgc3RhdHVzIGluZGljYXRvcnMgdG8gcmVmbGVjdCB0aGUgY29tcGxldGlvbiBvZiBhIHN5bmMgY3ljbGUuCgo8YnI+CgojIE5leHQgQ2hhcHRlcgoKTm93IHRoYXQgd2UgaGF2ZSBjb3ZlcmVkIGFsbCBvZiB0aGUgc3RhZ2VzIHRoYXQgYXJlIGN1cnJlbnRseSBpbmNsdWRlZCBpbiB0aGUgYFBpcGVsaW5lYCwgeW91IGtub3cgaG93IHRoZSBSZXRoIGNsaWVudCBzdGF5cyBzeW5jZWQgd2l0aCB0aGUgY2hhaW4gdGlwIGFuZCB1cGRhdGVzIHRoZSBkYXRhYmFzZSB3aXRoIGFsbCBvZiB0aGUgbmV3IGhlYWRlcnMsIGJvZGllcywgc2VuZGVycyBhbmQgc3RhdGUgY2hhbmdlcy4gV2hpbGUgdGhpcyBjaGFwdGVyIHByb3ZpZGVzIGFuIG92ZXJ2aWV3IG9uIGhvdyB0aGUgcGlwZWxpbmUgc3RhZ2VzIHdvcmssIHRoZSBmb2xsb3dpbmcgY2hhcHRlcnMgd2lsbCBkaXZlIGRlZXBlciBpbnRvIHRoZSBkYXRhYmFzZSwgdGhlIG5ldHdvcmtpbmcgc3RhY2sgYW5kIG90aGVyIGV4Y2l0aW5nIGNvcm5lcnMgb2YgdGhlIFJldGggY29kZWJhc2UuIEZlZWwgZnJlZSB0byBjaGVjayBvdXQgYW55IHBhcnRzIG9mIHRoZSBjb2RlYmFzZSBtZW50aW9uZWQgaW4gdGhpcyBjaGFwdGVyLCBhbmQgd2hlbiB5b3UgYXJlIHJlYWR5LCB0aGUgbmV4dCBjaGFwdGVyIHdpbGwgZGl2ZSBpbnRvIHRoZSBgZGF0YWJhc2VgLgoKW05leHQgQ2hhcHRlcl0oZGIubWQpCjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9jaGFpbi1zdGF0ZS9zcmMvY2hhaW5faW5mby5ycyI+CnVzZSBhbGxveV9jb25zZW5zdXM6OkJsb2NrSGVhZGVyOwp1c2UgYWxsb3lfZWlwczo6QmxvY2tOdW1IYXNoOwp1c2UgYWxsb3lfcHJpbWl0aXZlczo6QmxvY2tOdW1iZXI7CnVzZSBwYXJraW5nX2xvdDo6UndMb2NrOwp1c2UgcmV0aF9jaGFpbnNwZWM6OkNoYWluSW5mbzsKdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OntOb2RlUHJpbWl0aXZlcywgU2VhbGVkSGVhZGVyfTsKdXNlIHN0ZDo6ewogICAgc3luYzo6ewogICAgICAgIGF0b21pYzo6e0F0b21pY1U2NCwgT3JkZXJpbmd9LAogICAgICAgIEFyYywKICAgIH0sCiAgICB0aW1lOjpJbnN0YW50LAp9Owp1c2UgdG9raW86OnN5bmM6OndhdGNoOwoKLy8vIFRyYWNrcyB0aGUgY2hhaW4gaW5mbzogY2Fub25pY2FsIGhlYWQsIHNhZmUgYmxvY2ssIGZpbmFsaXplZCBibG9jay4KI1tkZXJpdmUoRGVidWcsIENsb25lKV0KcHViIHN0cnVjdCBDaGFpbkluZm9UcmFja2VyPE46IE5vZGVQcmltaXRpdmVzPiB7CiAgICBpbm5lcjogQXJjPENoYWluSW5mb0lubmVyPE4+PiwKfQoKaW1wbDxOPiBDaGFpbkluZm9UcmFja2VyPE4+CndoZXJlCiAgICBOOiBOb2RlUHJpbWl0aXZlcywKICAgIE46OkJsb2NrSGVhZGVyOiBCbG9ja0hlYWRlciwKewogICAgLy8vIENyZWF0ZSBhIG5ldyBjaGFpbiBpbmZvIGNvbnRhaW5lciBmb3IgdGhlIGdpdmVuIGNhbm9uaWNhbCBoZWFkIGFuZCBmaW5hbGl6ZWQgaGVhZGVyIGlmIGl0CiAgICAvLy8gZXhpc3RzLgogICAgcHViIGZuIG5ldygKICAgICAgICBoZWFkOiBTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+LAogICAgICAgIGZpbmFsaXplZDogT3B0aW9uPFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4+LAogICAgICAgIHNhZmU6IE9wdGlvbjxTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+PiwKICAgICkgLT4gU2VsZiB7CiAgICAgICAgbGV0IChmaW5hbGl6ZWRfYmxvY2ssIF8pID0gd2F0Y2g6OmNoYW5uZWwoZmluYWxpemVkKTsKICAgICAgICBsZXQgKHNhZmVfYmxvY2ssIF8pID0gd2F0Y2g6OmNoYW5uZWwoc2FmZSk7CiAgICAgICAgbGV0IChwZXJzaXN0ZWRfYmxvY2ssIF8pID0gd2F0Y2g6OmNoYW5uZWwoTm9uZSk7CgogICAgICAgIFNlbGYgewogICAgICAgICAgICBpbm5lcjogQXJjOjpuZXcoQ2hhaW5JbmZvSW5uZXIgewogICAgICAgICAgICAgICAgbGFzdF9mb3JrY2hvaWNlX3VwZGF0ZTogUndMb2NrOjpuZXcoTm9uZSksCgogICAgICAgICAgICAgICAgY2Fub25pY2FsX2hlYWRfbnVtYmVyOiBBdG9taWNVNjQ6Om5ldyhoZWFkLm51bWJlcigpKSwKICAgICAgICAgICAgICAgIGNhbm9uaWNhbF9oZWFkOiBSd0xvY2s6Om5ldyhoZWFkKSwKICAgICAgICAgICAgICAgIHNhZmVfYmxvY2ssCiAgICAgICAgICAgICAgICBmaW5hbGl6ZWRfYmxvY2ssCiAgICAgICAgICAgICAgICBwZXJzaXN0ZWRfYmxvY2ssCiAgICAgICAgICAgIH0pLAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgW2BDaGFpbkluZm9gXSBmb3IgdGhlIGNhbm9uaWNhbCBoZWFkLgogICAgcHViIGZuIGNoYWluX2luZm8oJnNlbGYpIC0+IENoYWluSW5mbyB7CiAgICAgICAgbGV0IGlubmVyID0gc2VsZi5pbm5lci5jYW5vbmljYWxfaGVhZC5yZWFkKCk7CiAgICAgICAgQ2hhaW5JbmZvIHsgYmVzdF9oYXNoOiBpbm5lci5oYXNoKCksIGJlc3RfbnVtYmVyOiBpbm5lci5udW1iZXIoKSB9CiAgICB9CgogICAgLy8vIFVwZGF0ZSB0aGUgdGltZXN0YW1wIHdoZW4gd2UgcmVjZWl2ZWQgYSBmb3JrY2hvaWNlIHVwZGF0ZS4KICAgIHB1YiBmbiBvbl9mb3JrY2hvaWNlX3VwZGF0ZV9yZWNlaXZlZCgmc2VsZikgewogICAgICAgIHNlbGYuaW5uZXIubGFzdF9mb3JrY2hvaWNlX3VwZGF0ZS53cml0ZSgpLnJlcGxhY2UoSW5zdGFudDo6bm93KCkpOwogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBpbnN0YW50IHdoZW4gd2UgcmVjZWl2ZWQgdGhlIGxhdGVzdCBmb3JrY2hvaWNlIHVwZGF0ZS4KICAgIHB1YiBmbiBsYXN0X2ZvcmtjaG9pY2VfdXBkYXRlX3JlY2VpdmVkX2F0KCZzZWxmKSAtPiBPcHRpb248SW5zdGFudD4gewogICAgICAgICpzZWxmLmlubmVyLmxhc3RfZm9ya2Nob2ljZV91cGRhdGUucmVhZCgpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGNhbm9uaWNhbCBoZWFkIG9mIHRoZSBjaGFpbi4KICAgIHB1YiBmbiBnZXRfY2Fub25pY2FsX2hlYWQoJnNlbGYpIC0+IFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4gewogICAgICAgIHNlbGYuaW5uZXIuY2Fub25pY2FsX2hlYWQucmVhZCgpLmNsb25lKCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgc2FmZSBoZWFkZXIgb2YgdGhlIGNoYWluLgogICAgcHViIGZuIGdldF9zYWZlX2hlYWRlcigmc2VsZikgLT4gT3B0aW9uPFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4+IHsKICAgICAgICBzZWxmLmlubmVyLnNhZmVfYmxvY2suYm9ycm93KCkuY2xvbmUoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBmaW5hbGl6ZWQgaGVhZGVyIG9mIHRoZSBjaGFpbi4KICAgIHB1YiBmbiBnZXRfZmluYWxpemVkX2hlYWRlcigmc2VsZikgLT4gT3B0aW9uPFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4+IHsKICAgICAgICBzZWxmLmlubmVyLmZpbmFsaXplZF9ibG9jay5ib3Jyb3coKS5jbG9uZSgpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGBCbG9ja051bUhhc2hgIG9mIHRoZSBjYW5vbmljYWwgaGVhZC4KICAgIHB1YiBmbiBnZXRfY2Fub25pY2FsX251bV9oYXNoKCZzZWxmKSAtPiBCbG9ja051bUhhc2ggewogICAgICAgIHNlbGYuaW5uZXIuY2Fub25pY2FsX2hlYWQucmVhZCgpLm51bV9oYXNoKCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgYmxvY2sgbnVtYmVyIG9mIHRoZSBjYW5vbmljYWwgaGVhZC4KICAgIHB1YiBmbiBnZXRfY2Fub25pY2FsX2Jsb2NrX251bWJlcigmc2VsZikgLT4gQmxvY2tOdW1iZXIgewogICAgICAgIHNlbGYuaW5uZXIuY2Fub25pY2FsX2hlYWRfbnVtYmVyLmxvYWQoT3JkZXJpbmc6OlJlbGF4ZWQpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGBCbG9ja051bUhhc2hgIG9mIHRoZSBzYWZlIGhlYWRlci4KICAgIHB1YiBmbiBnZXRfc2FmZV9udW1faGFzaCgmc2VsZikgLT4gT3B0aW9uPEJsb2NrTnVtSGFzaD4gewogICAgICAgIHNlbGYuaW5uZXIuc2FmZV9ibG9jay5ib3Jyb3coKS5hc19yZWYoKS5tYXAoU2VhbGVkSGVhZGVyOjpudW1faGFzaCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgYEJsb2NrTnVtSGFzaGAgb2YgdGhlIGZpbmFsaXplZCBoZWFkZXIuCiAgICBwdWIgZm4gZ2V0X2ZpbmFsaXplZF9udW1faGFzaCgmc2VsZikgLT4gT3B0aW9uPEJsb2NrTnVtSGFzaD4gewogICAgICAgIHNlbGYuaW5uZXIuZmluYWxpemVkX2Jsb2NrLmJvcnJvdygpLmFzX3JlZigpLm1hcChTZWFsZWRIZWFkZXI6Om51bV9oYXNoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBgQmxvY2tOdW1IYXNoYCBvZiB0aGUgcGVyc2lzdGVkIGJsb2NrLgogICAgcHViIGZuIGdldF9wZXJzaXN0ZWRfbnVtX2hhc2goJnNlbGYpIC0+IE9wdGlvbjxCbG9ja051bUhhc2g+IHsKICAgICAgICAqc2VsZi5pbm5lci5wZXJzaXN0ZWRfYmxvY2suYm9ycm93KCkKICAgIH0KCiAgICAvLy8gU2V0cyB0aGUgY2Fub25pY2FsIGhlYWQgb2YgdGhlIGNoYWluLgogICAgcHViIGZuIHNldF9jYW5vbmljYWxfaGVhZCgmc2VsZiwgaGVhZGVyOiBTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+KSB7CiAgICAgICAgbGV0IG51bWJlciA9IGhlYWRlci5udW1iZXIoKTsKICAgICAgICAqc2VsZi5pbm5lci5jYW5vbmljYWxfaGVhZC53cml0ZSgpID0gaGVhZGVyOwoKICAgICAgICAvLyBhbHNvIHVwZGF0ZSB0aGUgYXRvbWljIG51bWJlci4KICAgICAgICBzZWxmLmlubmVyLmNhbm9uaWNhbF9oZWFkX251bWJlci5zdG9yZShudW1iZXIsIE9yZGVyaW5nOjpSZWxheGVkKTsKICAgIH0KCiAgICAvLy8gU2V0cyB0aGUgc2FmZSBoZWFkZXIgb2YgdGhlIGNoYWluLgogICAgcHViIGZuIHNldF9zYWZlKCZzZWxmLCBoZWFkZXI6IFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4pIHsKICAgICAgICBzZWxmLmlubmVyLnNhZmVfYmxvY2suc2VuZF9pZl9tb2RpZmllZCh8Y3VycmVudF9oZWFkZXJ8IHsKICAgICAgICAgICAgaWYgY3VycmVudF9oZWFkZXIuYXNfcmVmKCkubWFwKFNlYWxlZEhlYWRlcjo6aGFzaCkgIT0gU29tZShoZWFkZXIuaGFzaCgpKSB7CiAgICAgICAgICAgICAgICBsZXQgXyA9IGN1cnJlbnRfaGVhZGVyLnJlcGxhY2UoaGVhZGVyKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgfSk7CiAgICB9CgogICAgLy8vIFNldHMgdGhlIGZpbmFsaXplZCBoZWFkZXIgb2YgdGhlIGNoYWluLgogICAgcHViIGZuIHNldF9maW5hbGl6ZWQoJnNlbGYsIGhlYWRlcjogU2VhbGVkSGVhZGVyPE46OkJsb2NrSGVhZGVyPikgewogICAgICAgIHNlbGYuaW5uZXIuZmluYWxpemVkX2Jsb2NrLnNlbmRfaWZfbW9kaWZpZWQofGN1cnJlbnRfaGVhZGVyfCB7CiAgICAgICAgICAgIGlmIGN1cnJlbnRfaGVhZGVyLmFzX3JlZigpLm1hcChTZWFsZWRIZWFkZXI6Omhhc2gpICE9IFNvbWUoaGVhZGVyLmhhc2goKSkgewogICAgICAgICAgICAgICAgbGV0IF8gPSBjdXJyZW50X2hlYWRlci5yZXBsYWNlKGhlYWRlcik7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgICAgICB9CgogICAgICAgICAgICBmYWxzZQogICAgICAgIH0pOwogICAgfQoKICAgIC8vLyBTZXRzIHRoZSBwZXJzaXN0ZWQgYmxvY2sgb2YgdGhlIGNoYWluLgogICAgcHViIGZuIHNldF9wZXJzaXN0ZWQoJnNlbGYsIG51bV9oYXNoOiBCbG9ja051bUhhc2gpIHsKICAgICAgICBzZWxmLmlubmVyLnBlcnNpc3RlZF9ibG9jay5zZW5kX2lmX21vZGlmaWVkKHxjdXJyZW50fCB7CiAgICAgICAgICAgIGlmIGN1cnJlbnQubWFwKHxifCBiLmhhc2gpICE9IFNvbWUobnVtX2hhc2guaGFzaCkgewogICAgICAgICAgICAgICAgbGV0IF8gPSBjdXJyZW50LnJlcGxhY2UobnVtX2hhc2gpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZmFsc2UKICAgICAgICB9KTsKICAgIH0KCiAgICAvLy8gU3Vic2NyaWJlIHRvIHRoZSBmaW5hbGl6ZWQgYmxvY2suCiAgICBwdWIgZm4gc3Vic2NyaWJlX2ZpbmFsaXplZF9ibG9jaygKICAgICAgICAmc2VsZiwKICAgICkgLT4gd2F0Y2g6OlJlY2VpdmVyPE9wdGlvbjxTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+Pj4gewogICAgICAgIHNlbGYuaW5uZXIuZmluYWxpemVkX2Jsb2NrLnN1YnNjcmliZSgpCiAgICB9CgogICAgLy8vIFN1YnNjcmliZSB0byB0aGUgc2FmZSBibG9jay4KICAgIHB1YiBmbiBzdWJzY3JpYmVfc2FmZV9ibG9jaygmc2VsZikgLT4gd2F0Y2g6OlJlY2VpdmVyPE9wdGlvbjxTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+Pj4gewogICAgICAgIHNlbGYuaW5uZXIuc2FmZV9ibG9jay5zdWJzY3JpYmUoKQogICAgfQoKICAgIC8vLyBTdWJzY3JpYmUgdG8gdGhlIHBlcnNpc3RlZCBibG9jay4KICAgIHB1YiBmbiBzdWJzY3JpYmVfcGVyc2lzdGVkX2Jsb2NrKCZzZWxmKSAtPiB3YXRjaDo6UmVjZWl2ZXI8T3B0aW9uPEJsb2NrTnVtSGFzaD4+IHsKICAgICAgICBzZWxmLmlubmVyLnBlcnNpc3RlZF9ibG9jay5zdWJzY3JpYmUoKQogICAgfQp9CgovLy8gQ29udGFpbmVyIHR5cGUgZm9yIGFsbCBjaGFpbiBpbmZvIGZpZWxkcwojW2Rlcml2ZShEZWJ1ZyldCnN0cnVjdCBDaGFpbkluZm9Jbm5lcjxOOiBOb2RlUHJpbWl0aXZlcyA9IHJldGhfZXRoZXJldW1fcHJpbWl0aXZlczo6RXRoUHJpbWl0aXZlcz4gewogICAgLy8vIFRpbWVzdGFtcCB3aGVuIHdlIHJlY2VpdmVkIHRoZSBsYXN0IGZvcmsgY2hvaWNlIHVwZGF0ZS4KICAgIC8vLwogICAgLy8vIFRoaXMgaXMgbWFpbmx5IHVzZWQgdG8gdHJhY2sgaWYgd2UncmUgY29ubmVjdGVkIHRvIGEgYmVhY29uIG5vZGUuCiAgICBsYXN0X2ZvcmtjaG9pY2VfdXBkYXRlOiBSd0xvY2s8T3B0aW9uPEluc3RhbnQ+PiwKCiAgICAvLy8gVHJhY2tzIHRoZSBudW1iZXIgb2YgdGhlIGBjYW5vbmljYWxfaGVhZGAuCiAgICBjYW5vbmljYWxfaGVhZF9udW1iZXI6IEF0b21pY1U2NCwKICAgIC8vLyBUaGUgY2Fub25pY2FsIGhlYWQgb2YgdGhlIGNoYWluLgogICAgY2Fub25pY2FsX2hlYWQ6IFJ3TG9jazxTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+PiwKICAgIC8vLyBUaGUgYmxvY2sgdGhhdCB0aGUgYmVhY29uIG5vZGUgY29uc2lkZXJzIHNhZmUuCiAgICBzYWZlX2Jsb2NrOiB3YXRjaDo6U2VuZGVyPE9wdGlvbjxTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+Pj4sCiAgICAvLy8gVGhlIGJsb2NrIHRoYXQgdGhlIGJlYWNvbiBub2RlIGNvbnNpZGVycyBmaW5hbGl6ZWQuCiAgICBmaW5hbGl6ZWRfYmxvY2s6IHdhdGNoOjpTZW5kZXI8T3B0aW9uPFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4+PiwKICAgIC8vLyBUaGUgbGFzdCBibG9jayB0aGF0IHdhcyBwZXJzaXN0ZWQgdG8gZGlzay4KICAgIHBlcnNpc3RlZF9ibG9jazogd2F0Y2g6OlNlbmRlcjxPcHRpb248QmxvY2tOdW1IYXNoPj4sCn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdHMgewogICAgdXNlIHN1cGVyOjoqOwogICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkIyNTY7CiAgICB1c2UgcmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpFdGhQcmltaXRpdmVzOwogICAgdXNlIHJldGhfdGVzdGluZ191dGlsczo6e2dlbmVyYXRvcnMsIGdlbmVyYXRvcnM6OnJhbmRvbV9oZWFkZXJ9OwoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfY2hhaW5faW5mbygpIHsKICAgICAgICAvLyBDcmVhdGUgYSByYW5kb20gaGVhZGVyCiAgICAgICAgbGV0IG11dCBybmcgPSBnZW5lcmF0b3JzOjpybmcoKTsKICAgICAgICBsZXQgaGVhZGVyID0gcmFuZG9tX2hlYWRlcigmbXV0IHJuZywgMTAsIE5vbmUpOwoKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgY2hhaW4gaW5mbyB0cmFja2VyIHdpdGggdGhlIGhlYWRlcgogICAgICAgIGxldCB0cmFja2VyOiBDaGFpbkluZm9UcmFja2VyPEV0aFByaW1pdGl2ZXM+ID0KICAgICAgICAgICAgQ2hhaW5JbmZvVHJhY2tlcjo6bmV3KGhlYWRlci5jbG9uZSgpLCBOb25lLCBOb25lKTsKCiAgICAgICAgLy8gRmV0Y2ggdGhlIGNoYWluIGluZm9ybWF0aW9uIGZyb20gdGhlIHRyYWNrZXIKICAgICAgICBsZXQgY2hhaW5faW5mbyA9IHRyYWNrZXIuY2hhaW5faW5mbygpOwoKICAgICAgICAvLyBWZXJpZnkgdGhhdCB0aGUgY2hhaW4gaW5mb3JtYXRpb24gbWF0Y2hlcyB0aGUgaGVhZGVyCiAgICAgICAgYXNzZXJ0X2VxIShjaGFpbl9pbmZvLmJlc3RfbnVtYmVyLCBoZWFkZXIubnVtYmVyKTsKICAgICAgICBhc3NlcnRfZXEhKGNoYWluX2luZm8uYmVzdF9oYXNoLCBoZWFkZXIuaGFzaCgpKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X29uX2ZvcmtjaG9pY2VfdXBkYXRlX3JlY2VpdmVkKCkgewogICAgICAgIC8vIENyZWF0ZSBhIHJhbmRvbSBibG9jayBoZWFkZXIKICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwogICAgICAgIGxldCBoZWFkZXIgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAxMCwgTm9uZSk7CgogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBjaGFpbiBpbmZvIHRyYWNrZXIgd2l0aCB0aGUgaGVhZGVyCiAgICAgICAgbGV0IHRyYWNrZXI6IENoYWluSW5mb1RyYWNrZXI8RXRoUHJpbWl0aXZlcz4gPSBDaGFpbkluZm9UcmFja2VyOjpuZXcoaGVhZGVyLCBOb25lLCBOb25lKTsKCiAgICAgICAgLy8gQXNzZXJ0IHRoYXQgdGhlcmUgaGFzIGJlZW4gbm8gZm9ya2Nob2ljZSB1cGRhdGUgeWV0ICh0aGUgdGltZXN0YW1wIGlzIE5vbmUpCiAgICAgICAgYXNzZXJ0ISh0cmFja2VyLmxhc3RfZm9ya2Nob2ljZV91cGRhdGVfcmVjZWl2ZWRfYXQoKS5pc19ub25lKCkpOwoKICAgICAgICAvLyBDYWxsIHRoZSBtZXRob2QgdG8gcmVjb3JkIHRoZSByZWNlaXB0IG9mIGEgZm9ya2Nob2ljZSB1cGRhdGUKICAgICAgICB0cmFja2VyLm9uX2ZvcmtjaG9pY2VfdXBkYXRlX3JlY2VpdmVkKCk7CgogICAgICAgIC8vIEFzc2VydCB0aGF0IHRoZXJlIGlzIG5vdyBhIHRpbWVzdGFtcCBpbmRpY2F0aW5nIHdoZW4gdGhlIGZvcmtjaG9pY2UgdXBkYXRlIHdhcyByZWNlaXZlZAogICAgICAgIGFzc2VydCEodHJhY2tlci5sYXN0X2ZvcmtjaG9pY2VfdXBkYXRlX3JlY2VpdmVkX2F0KCkuaXNfc29tZSgpKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3NldF9jYW5vbmljYWxfaGVhZCgpIHsKICAgICAgICAvLyBDcmVhdGUgYSByYW5kb20gbnVtYmVyIGdlbmVyYXRvcgogICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CiAgICAgICAgLy8gR2VuZXJhdGUgdHdvIHJhbmRvbSBoZWFkZXJzIGZvciB0ZXN0aW5nCiAgICAgICAgbGV0IGhlYWRlcjEgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAxMCwgTm9uZSk7CiAgICAgICAgbGV0IGhlYWRlcjIgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAyMCwgTm9uZSk7CgogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBjaGFpbiBpbmZvIHRyYWNrZXIgd2l0aCB0aGUgZmlyc3QgaGVhZGVyCiAgICAgICAgbGV0IHRyYWNrZXI6IENoYWluSW5mb1RyYWNrZXI8RXRoUHJpbWl0aXZlcz4gPSBDaGFpbkluZm9UcmFja2VyOjpuZXcoaGVhZGVyMSwgTm9uZSwgTm9uZSk7CgogICAgICAgIC8vIFNldCB0aGUgc2Vjb25kIGhlYWRlciBhcyB0aGUgY2Fub25pY2FsIGhlYWQgb2YgdGhlIHRyYWNrZXIKICAgICAgICB0cmFja2VyLnNldF9jYW5vbmljYWxfaGVhZChoZWFkZXIyLmNsb25lKCkpOwoKICAgICAgICAvLyBBc3NlcnQgdGhhdCB0aGUgdHJhY2tlciBub3cgdXNlcyB0aGUgc2Vjb25kIGhlYWRlciBhcyBpdHMgY2Fub25pY2FsIGhlYWQKICAgICAgICBsZXQgY2Fub25pY2FsX2hlYWQgPSB0cmFja2VyLmdldF9jYW5vbmljYWxfaGVhZCgpOwogICAgICAgIGFzc2VydF9lcSEoY2Fub25pY2FsX2hlYWQsIGhlYWRlcjIpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3Rfc2V0X3NhZmUoKSB7CiAgICAgICAgLy8gQ3JlYXRlIGEgcmFuZG9tIG51bWJlciBnZW5lcmF0b3IKICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwoKICAgICAgICAvLyBDYXNlIDE6IGJhc2ljIHRlc3QKICAgICAgICAvLyBHZW5lcmF0ZSB0d28gcmFuZG9tIGhlYWRlcnMgZm9yIHRoZSB0ZXN0CiAgICAgICAgbGV0IGhlYWRlcjEgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAxMCwgTm9uZSk7CiAgICAgICAgbGV0IGhlYWRlcjIgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAyMCwgTm9uZSk7CgogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBjaGFpbiBpbmZvIHRyYWNrZXIgd2l0aCB0aGUgZmlyc3QgaGVhZGVyIChoZWFkZXIxKQogICAgICAgIGxldCB0cmFja2VyOiBDaGFpbkluZm9UcmFja2VyPEV0aFByaW1pdGl2ZXM+ID0gQ2hhaW5JbmZvVHJhY2tlcjo6bmV3KGhlYWRlcjEsIE5vbmUsIE5vbmUpOwoKICAgICAgICAvLyBDYWxsIHRoZSBzZXRfc2FmZSBtZXRob2Qgd2l0aCB0aGUgc2Vjb25kIGhlYWRlciAoaGVhZGVyMikKICAgICAgICB0cmFja2VyLnNldF9zYWZlKGhlYWRlcjIuY2xvbmUoKSk7CgogICAgICAgIC8vIFZlcmlmeSB0aGF0IHRoZSB0cmFja2VyIG5vdyBoYXMgaGVhZGVyMiBhcyB0aGUgc2FmZSBibG9jawogICAgICAgIGxldCBzYWZlX2hlYWRlciA9IHRyYWNrZXIuZ2V0X3NhZmVfaGVhZGVyKCk7CiAgICAgICAgYXNzZXJ0IShzYWZlX2hlYWRlci5pc19zb21lKCkpOyAvLyBFbnN1cmUgYSBzYWZlIGhlYWRlciBpcyBwcmVzZW50CiAgICAgICAgbGV0IHNhZmVfaGVhZGVyID0gc2FmZV9oZWFkZXIudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShzYWZlX2hlYWRlciwgaGVhZGVyMik7CgogICAgICAgIC8vIENhc2UgMjogY2FsbCB3aXRoIHRoZSBzYW1lIGhlYWRlciBhcyB0aGUgY3VycmVudCBzYWZlIGJsb2NrCiAgICAgICAgLy8gQ2FsbCBzZXRfc2FmZSBhZ2FpbiB3aXRoIHRoZSBzYW1lIGhlYWRlciAoaGVhZGVyMikKICAgICAgICB0cmFja2VyLnNldF9zYWZlKGhlYWRlcjIuY2xvbmUoKSk7CgogICAgICAgIC8vIFZlcmlmeSB0aGF0IG5vdGhpbmcgY2hhbmdlcyBhbmQgdGhlIHNhZmUgaGVhZGVyIHJlbWFpbnMgdGhlIHNhbWUKICAgICAgICBsZXQgc2FtZV9zYWZlX2hlYWRlciA9IHRyYWNrZXIuZ2V0X3NhZmVfaGVhZGVyKCk7CiAgICAgICAgYXNzZXJ0IShzYW1lX3NhZmVfaGVhZGVyLmlzX3NvbWUoKSk7CiAgICAgICAgbGV0IHNhbWVfc2FmZV9oZWFkZXIgPSBzYW1lX3NhZmVfaGVhZGVyLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEoc2FtZV9zYWZlX2hlYWRlciwgaGVhZGVyMik7CgogICAgICAgIC8vIENhc2UgMzogY2FsbCB3aXRoIGEgZGlmZmVyZW50IChuZXcpIGhlYWRlcgogICAgICAgIC8vIEdlbmVyYXRlIGEgdGhpcmQgaGVhZGVyIHdpdGggYSBoaWdoZXIgYmxvY2sgbnVtYmVyCiAgICAgICAgbGV0IGhlYWRlcjMgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAzMCwgTm9uZSk7CgogICAgICAgIC8vIENhbGwgc2V0X3NhZmUgd2l0aCB0aGlzIG5ldyBoZWFkZXIgKGhlYWRlcjMpCiAgICAgICAgdHJhY2tlci5zZXRfc2FmZShoZWFkZXIzLmNsb25lKCkpOwoKICAgICAgICAvLyBWZXJpZnkgdGhhdCB0aGUgc2FmZSBoZWFkZXIgaXMgdXBkYXRlZCB3aXRoIHRoZSBuZXcgaGVhZGVyCiAgICAgICAgbGV0IHVwZGF0ZWRfc2FmZV9oZWFkZXIgPSB0cmFja2VyLmdldF9zYWZlX2hlYWRlcigpOwogICAgICAgIGFzc2VydCEodXBkYXRlZF9zYWZlX2hlYWRlci5pc19zb21lKCkpOwogICAgICAgIGxldCB1cGRhdGVkX3NhZmVfaGVhZGVyID0gdXBkYXRlZF9zYWZlX2hlYWRlci51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKHVwZGF0ZWRfc2FmZV9oZWFkZXIsIGhlYWRlcjMpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3Rfc2V0X2ZpbmFsaXplZCgpIHsKICAgICAgICAvLyBDcmVhdGUgYSByYW5kb20gbnVtYmVyIGdlbmVyYXRvcgogICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CgogICAgICAgIC8vIEdlbmVyYXRlIHJhbmRvbSBoZWFkZXJzIGZvciB0ZXN0aW5nCiAgICAgICAgbGV0IGhlYWRlcjEgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAxMCwgTm9uZSk7CiAgICAgICAgbGV0IGhlYWRlcjIgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAyMCwgTm9uZSk7CiAgICAgICAgbGV0IGhlYWRlcjMgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAzMCwgTm9uZSk7CgogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBjaGFpbiBpbmZvIHRyYWNrZXIgd2l0aCB0aGUgZmlyc3QgaGVhZGVyCiAgICAgICAgbGV0IHRyYWNrZXI6IENoYWluSW5mb1RyYWNrZXI8RXRoUHJpbWl0aXZlcz4gPSBDaGFpbkluZm9UcmFja2VyOjpuZXcoaGVhZGVyMSwgTm9uZSwgTm9uZSk7CgogICAgICAgIC8vIEluaXRpYWwgc3RhdGU6IGZpbmFsaXplIGhlYWRlciBzaG91bGQgYmUgTm9uZQogICAgICAgIGFzc2VydCEodHJhY2tlci5nZXRfZmluYWxpemVkX2hlYWRlcigpLmlzX25vbmUoKSk7CgogICAgICAgIC8vIFNldCB0aGUgc2Vjb25kIGhlYWRlciBhcyB0aGUgZmluYWxpemVkIGhlYWRlcgogICAgICAgIHRyYWNrZXIuc2V0X2ZpbmFsaXplZChoZWFkZXIyLmNsb25lKCkpOwoKICAgICAgICAvLyBBc3NlcnQgdGhhdCB0aGUgdHJhY2tlciBub3cgdXNlcyB0aGUgc2Vjb25kIGhlYWRlciBhcyBpdHMgZmluYWxpemVkIGJsb2NrCiAgICAgICAgbGV0IGZpbmFsaXplZF9oZWFkZXIgPSB0cmFja2VyLmdldF9maW5hbGl6ZWRfaGVhZGVyKCk7CiAgICAgICAgYXNzZXJ0IShmaW5hbGl6ZWRfaGVhZGVyLmlzX3NvbWUoKSk7CiAgICAgICAgbGV0IGZpbmFsaXplZF9oZWFkZXIgPSBmaW5hbGl6ZWRfaGVhZGVyLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEoZmluYWxpemVkX2hlYWRlciwgaGVhZGVyMik7CgogICAgICAgIC8vIENhc2UgMjogYXR0ZW1wdCB0byBzZXQgdGhlIHNhbWUgZmluYWxpemVkIGhlYWRlciBhZ2FpbgogICAgICAgIHRyYWNrZXIuc2V0X2ZpbmFsaXplZChoZWFkZXIyLmNsb25lKCkpOwoKICAgICAgICAvLyBUaGUgZmluYWxpemVkIGhlYWRlciBzaG91bGQgcmVtYWluIHVuY2hhbmdlZAogICAgICAgIGxldCB1bmNoYW5nZWRfZmluYWxpemVkX2hlYWRlciA9IHRyYWNrZXIuZ2V0X2ZpbmFsaXplZF9oZWFkZXIoKTsKICAgICAgICBhc3NlcnRfZXEhKHVuY2hhbmdlZF9maW5hbGl6ZWRfaGVhZGVyLnVud3JhcCgpLCBoZWFkZXIyKTsgLy8gU2hvdWxkIHN0aWxsIGJlIGhlYWRlcjIKCiAgICAgICAgLy8gQ2FzZSAzOiBzZXQgYSBoaWdoZXIgYmxvY2sgbnVtYmVyIGFzIGZpbmFsaXplZAogICAgICAgIHRyYWNrZXIuc2V0X2ZpbmFsaXplZChoZWFkZXIzLmNsb25lKCkpOwoKICAgICAgICAvLyBUaGUgZmluYWxpemVkIGhlYWRlciBzaG91bGQgbm93IGJlIHVwZGF0ZWQgdG8gaGVhZGVyMwogICAgICAgIGxldCB1cGRhdGVkX2ZpbmFsaXplZF9oZWFkZXIgPSB0cmFja2VyLmdldF9maW5hbGl6ZWRfaGVhZGVyKCk7CiAgICAgICAgYXNzZXJ0ISh1cGRhdGVkX2ZpbmFsaXplZF9oZWFkZXIuaXNfc29tZSgpKTsKICAgICAgICBhc3NlcnRfZXEhKHVwZGF0ZWRfZmluYWxpemVkX2hlYWRlci51bndyYXAoKSwgaGVhZGVyMyk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9nZXRfZmluYWxpemVkX251bV9oYXNoKCkgewogICAgICAgIC8vIENyZWF0ZSBhIHJhbmRvbSBoZWFkZXIKICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwogICAgICAgIGxldCBmaW5hbGl6ZWRfaGVhZGVyID0gcmFuZG9tX2hlYWRlcigmbXV0IHJuZywgMTAsIE5vbmUpOwoKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgY2hhaW4gaW5mbyB0cmFja2VyIHdpdGggdGhlIGZpbmFsaXplZCBoZWFkZXIKICAgICAgICBsZXQgdHJhY2tlcjogQ2hhaW5JbmZvVHJhY2tlcjxFdGhQcmltaXRpdmVzPiA9CiAgICAgICAgICAgIENoYWluSW5mb1RyYWNrZXI6Om5ldyhmaW5hbGl6ZWRfaGVhZGVyLmNsb25lKCksIFNvbWUoZmluYWxpemVkX2hlYWRlci5jbG9uZSgpKSwgTm9uZSk7CgogICAgICAgIC8vIEFzc2VydCB0aGF0IHRoZSBCbG9ja051bUhhc2ggcmV0dXJuZWQgbWF0Y2hlcyB0aGUgZmluYWxpemVkIGhlYWRlcgogICAgICAgIGFzc2VydF9lcSEodHJhY2tlci5nZXRfZmluYWxpemVkX251bV9oYXNoKCksIFNvbWUoZmluYWxpemVkX2hlYWRlci5udW1faGFzaCgpKSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9nZXRfc2FmZV9udW1faGFzaCgpIHsKICAgICAgICAvLyBDcmVhdGUgYSByYW5kb20gaGVhZGVyCiAgICAgICAgbGV0IG11dCBybmcgPSBnZW5lcmF0b3JzOjpybmcoKTsKICAgICAgICBsZXQgc2FmZV9oZWFkZXIgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAxMCwgTm9uZSk7CgogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBjaGFpbiBpbmZvIHRyYWNrZXIgd2l0aCB0aGUgc2FmZSBoZWFkZXIKICAgICAgICBsZXQgdHJhY2tlcjogQ2hhaW5JbmZvVHJhY2tlcjxFdGhQcmltaXRpdmVzPiA9CiAgICAgICAgICAgIENoYWluSW5mb1RyYWNrZXI6Om5ldyhzYWZlX2hlYWRlci5jbG9uZSgpLCBOb25lLCBOb25lKTsKICAgICAgICB0cmFja2VyLnNldF9zYWZlKHNhZmVfaGVhZGVyLmNsb25lKCkpOwoKICAgICAgICAvLyBBc3NlcnQgdGhhdCB0aGUgQmxvY2tOdW1IYXNoIHJldHVybmVkIG1hdGNoZXMgdGhlIHNhZmUgaGVhZGVyCiAgICAgICAgYXNzZXJ0X2VxISh0cmFja2VyLmdldF9zYWZlX251bV9oYXNoKCksIFNvbWUoc2FmZV9oZWFkZXIubnVtX2hhc2goKSkpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3Rfc2V0X3BlcnNpc3RlZCgpIHsKICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwogICAgICAgIGxldCBoZWFkZXIgPSByYW5kb21faGVhZGVyKCZtdXQgcm5nLCAxMCwgTm9uZSk7CiAgICAgICAgbGV0IHRyYWNrZXI6IENoYWluSW5mb1RyYWNrZXI8RXRoUHJpbWl0aXZlcz4gPSBDaGFpbkluZm9UcmFja2VyOjpuZXcoaGVhZGVyLCBOb25lLCBOb25lKTsKCiAgICAgICAgLy8gSW5pdGlhbCBzdGF0ZTogcGVyc2lzdGVkIGJsb2NrIHNob3VsZCBiZSBOb25lCiAgICAgICAgYXNzZXJ0ISh0cmFja2VyLmdldF9wZXJzaXN0ZWRfbnVtX2hhc2goKS5pc19ub25lKCkpOwoKICAgICAgICAvLyBTZXQgYSBwZXJzaXN0ZWQgYmxvY2sKICAgICAgICBsZXQgbnVtX2hhc2gxID0gQmxvY2tOdW1IYXNoOjpuZXcoMTAsIEIyNTY6OnJhbmRvbSgpKTsKICAgICAgICB0cmFja2VyLnNldF9wZXJzaXN0ZWQobnVtX2hhc2gxKTsKICAgICAgICBhc3NlcnRfZXEhKHRyYWNrZXIuZ2V0X3BlcnNpc3RlZF9udW1faGFzaCgpLCBTb21lKG51bV9oYXNoMSkpOwoKICAgICAgICAvLyBTZXR0aW5nIHRoZSBzYW1lIGJsb2NrIGFnYWluIHNob3VsZCBub3QgY2hhbmdlIGFueXRoaW5nCiAgICAgICAgdHJhY2tlci5zZXRfcGVyc2lzdGVkKG51bV9oYXNoMSk7CiAgICAgICAgYXNzZXJ0X2VxISh0cmFja2VyLmdldF9wZXJzaXN0ZWRfbnVtX2hhc2goKSwgU29tZShudW1faGFzaDEpKTsKCiAgICAgICAgLy8gU2V0IGEgZGlmZmVyZW50IGJsb2NrCiAgICAgICAgbGV0IG51bV9oYXNoMiA9IEJsb2NrTnVtSGFzaDo6bmV3KDIwLCBCMjU2OjpyYW5kb20oKSk7CiAgICAgICAgdHJhY2tlci5zZXRfcGVyc2lzdGVkKG51bV9oYXNoMik7CiAgICAgICAgYXNzZXJ0X2VxISh0cmFja2VyLmdldF9wZXJzaXN0ZWRfbnVtX2hhc2goKSwgU29tZShudW1faGFzaDIpKTsKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvY2hhaW4tc3RhdGUvc3JjL2RlZmVycmVkX3RyaWUucnMiPgp1c2UgYWxsb3lfcHJpbWl0aXZlczo6QjI1NjsKdXNlIHBhcmtpbmdfbG90OjpNdXRleDsKdXNlIHJldGhfbWV0cmljczo6e21ldHJpY3M6OkNvdW50ZXIsIE1ldHJpY3N9Owp1c2UgcmV0aF90cmllOjp7CiAgICB1cGRhdGVzOjp7VHJpZVVwZGF0ZXMsIFRyaWVVcGRhdGVzU29ydGVkfSwKICAgIEhhc2hlZFBvc3RTdGF0ZSwgSGFzaGVkUG9zdFN0YXRlU29ydGVkLCBUcmllSW5wdXRTb3J0ZWQsCn07CnVzZSBzdGQ6OnsKICAgIGZtdCwKICAgIHN5bmM6OntBcmMsIExhenlMb2NrfSwKfTsKdXNlIHRyYWNpbmc6Omluc3RydW1lbnQ7CgovLy8gU2hhcmVkIGhhbmRsZSB0byBhc3luY2hyb25vdXNseSBwb3B1bGF0ZWQgdHJpZSBkYXRhLgovLy8KLy8vIFVzZXMgYSB0cnktbG9jayArIGZhbGxiYWNrIGNvbXB1dGF0aW9uIGFwcHJvYWNoIGZvciBkZWFkbG9jay1mcmVlIGFjY2Vzcy4KLy8vIElmIHRoZSBkZWZlcnJlZCB0YXNrIGhhc24ndCBjb21wbGV0ZWQsIGNvbXB1dGVzIHRyaWUgZGF0YSBzeW5jaHJvbm91c2x5Ci8vLyBmcm9tIHN0b3JlZCB1bnNvcnRlZCBpbnB1dHMgcmF0aGVyIHRoYW4gYmxvY2tpbmcuCiNbZGVyaXZlKENsb25lKV0KcHViIHN0cnVjdCBEZWZlcnJlZFRyaWVEYXRhIHsKICAgIC8vLyBTaGFyZWQgZGVmZXJyZWQgc3RhdGUgaG9sZGluZyBlaXRoZXIgcmF3IGlucHV0cyAocGVuZGluZykgb3IgY29tcHV0ZWQgcmVzdWx0IChyZWFkeSkuCiAgICBzdGF0ZTogQXJjPE11dGV4PERlZmVycmVkU3RhdGU+PiwKfQoKLy8vIFNvcnRlZCB0cmllIGRhdGEgY29tcHV0ZWQgZm9yIGFuIGV4ZWN1dGVkIGJsb2NrLgovLy8gVGhlc2UgcmVwcmVzZW50IHRoZSBjb21wbGV0ZSBzZXQgb2Ygc29ydGVkIHRyaWUgZGF0YSByZXF1aXJlZCB0byBwZXJzaXN0Ci8vLyBibG9jayBzdGF0ZSBmb3IsIGFuZCBnZW5lcmF0ZSBwcm9vZnMgb24gdG9wIG9mLCBhIGJsb2NrLgojW2Rlcml2ZShDbG9uZSwgRGVidWcsIERlZmF1bHQpXQpwdWIgc3RydWN0IENvbXB1dGVkVHJpZURhdGEgewogICAgLy8vIFNvcnRlZCBoYXNoZWQgcG9zdC1zdGF0ZSBwcm9kdWNlZCBieSBleGVjdXRpb24uCiAgICBwdWIgaGFzaGVkX3N0YXRlOiBBcmM8SGFzaGVkUG9zdFN0YXRlU29ydGVkPiwKICAgIC8vLyBTb3J0ZWQgdHJpZSB1cGRhdGVzIHByb2R1Y2VkIGJ5IHN0YXRlIHJvb3QgY29tcHV0YXRpb24uCiAgICBwdWIgdHJpZV91cGRhdGVzOiBBcmM8VHJpZVVwZGF0ZXNTb3J0ZWQ+LAogICAgLy8vIFRyaWUgaW5wdXQgYnVuZGxlZCB3aXRoIGl0cyBhbmNob3IgaGFzaCwgaWYgYXZhaWxhYmxlLgogICAgcHViIGFuY2hvcmVkX3RyaWVfaW5wdXQ6IE9wdGlvbjxBbmNob3JlZFRyaWVJbnB1dD4sCn0KCi8vLyBUcmllIGlucHV0IGJ1bmRsZWQgd2l0aCBpdHMgYW5jaG9yIGhhc2guCi8vLwovLy8gVGhlIGB0cmllX2lucHV0YCBjb250YWlucyB0aGUgKipjdW11bGF0aXZlKiogb3ZlcmxheSBvZiBhbGwgaW4tbWVtb3J5IGFuY2VzdG9yIGJsb2NrcywKLy8vIG5vdCBqdXN0IHRoaXMgYmxvY2sncyBjaGFuZ2VzLiBDaGlsZCBibG9ja3MgcmV1c2UgdGhlIHBhcmVudCdzIG92ZXJsYXkgaW4gTygxKSBieQovLy8gY2xvbmluZyB0aGUgQXJjLXdyYXBwZWQgZGF0YS4KLy8vCi8vLyBUaGUgYGFuY2hvcl9oYXNoYCBpcyBtZXRhZGF0YSBpbmRpY2F0aW5nIHdoaWNoIHBlcnNpc3RlZCBiYXNlIHN0YXRlIHRoaXMgb3ZlcmxheQovLy8gc2l0cyBvbiB0b3Agb2YuIEl0IGlzIENSSVRJQ0FMIGZvciBvdmVybGF5IHJldXNlIGRlY2lzaW9uczogYW4gb3ZlcmxheSBidWlsdCBvbiB0b3AKLy8vIG9mIEFuY2hvciBBIGNhbm5vdCBiZSByZXVzZWQgZm9yIGEgYmxvY2sgYW5jaG9yZWQgdG8gQW5jaG9yIEIsIGFzIGl0IHdvdWxkIHJlc3VsdAovLy8gaW4gYW4gaW5jb3JyZWN0IHN0YXRlLgojW2Rlcml2ZShDbG9uZSwgRGVidWcpXQpwdWIgc3RydWN0IEFuY2hvcmVkVHJpZUlucHV0IHsKICAgIC8vLyBUaGUgcGVyc2lzdGVkIGFuY2VzdG9yIGhhc2ggdGhpcyB0cmllIGlucHV0IGlzIGFuY2hvcmVkIHRvLgogICAgcHViIGFuY2hvcl9oYXNoOiBCMjU2LAogICAgLy8vIEN1bXVsYXRpdmUgdHJpZSBpbnB1dCBvdmVybGF5IGZyb20gYWxsIGluLW1lbW9yeSBhbmNlc3RvcnMuCiAgICBwdWIgdHJpZV9pbnB1dDogQXJjPFRyaWVJbnB1dFNvcnRlZD4sCn0KCi8vLyBNZXRyaWNzIGZvciBkZWZlcnJlZCB0cmllIGNvbXB1dGF0aW9uLgojW2Rlcml2ZShNZXRyaWNzKV0KI1ttZXRyaWNzKHNjb3BlID0gInN5bmMuYmxvY2tfdmFsaWRhdGlvbiIpXQpzdHJ1Y3QgRGVmZXJyZWRUcmllTWV0cmljcyB7CiAgICAvLy8gTnVtYmVyIG9mIHRpbWVzIGRlZmVycmVkIHRyaWUgZGF0YSB3YXMgcmVhZHkgKGFzeW5jIHRhc2sgY29tcGxldGVkIGZpcnN0KS4KICAgIGRlZmVycmVkX3RyaWVfYXN5bmNfcmVhZHk6IENvdW50ZXIsCiAgICAvLy8gTnVtYmVyIG9mIHRpbWVzIGRlZmVycmVkIHRyaWUgZGF0YSByZXF1aXJlZCBzeW5jaHJvbm91cyBjb21wdXRhdGlvbiAoZmFsbGJhY2sgcGF0aCkuCiAgICBkZWZlcnJlZF90cmllX3N5bmNfZmFsbGJhY2s6IENvdW50ZXIsCn0KCnN0YXRpYyBERUZFUlJFRF9UUklFX01FVFJJQ1M6IExhenlMb2NrPERlZmVycmVkVHJpZU1ldHJpY3M+ID0KICAgIExhenlMb2NrOjpuZXcoRGVmZXJyZWRUcmllTWV0cmljczo6ZGVmYXVsdCk7CgovLy8gSW50ZXJuYWwgc3RhdGUgZm9yIGRlZmVycmVkIHRyaWUgZGF0YS4KZW51bSBEZWZlcnJlZFN0YXRlIHsKICAgIC8vLyBEYXRhIGlzIG5vdCB5ZXQgYXZhaWxhYmxlOyByYXcgaW5wdXRzIHN0b3JlZCBmb3IgZmFsbGJhY2sgY29tcHV0YXRpb24uCiAgICAvLy8gV3JhcHBlZCBpbiBgT3B0aW9uYCB0byBhbGxvdyB0YWtpbmcgb3duZXJzaGlwIGR1cmluZyBjb21wdXRhdGlvbi4KICAgIFBlbmRpbmcoT3B0aW9uPFBlbmRpbmdJbnB1dHM+KSwKICAgIC8vLyBEYXRhIGhhcyBiZWVuIGNvbXB1dGVkIGFuZCBpcyByZWFkeS4KICAgIFJlYWR5KENvbXB1dGVkVHJpZURhdGEpLAp9CgovLy8gSW5wdXRzIGtlcHQgd2hpbGUgYSBkZWZlcnJlZCB0cmllIGNvbXB1dGF0aW9uIGlzIHBlbmRpbmcuCiNbZGVyaXZlKENsb25lLCBEZWJ1ZyldCnN0cnVjdCBQZW5kaW5nSW5wdXRzIHsKICAgIC8vLyBVbnNvcnRlZCBoYXNoZWQgcG9zdC1zdGF0ZSBmcm9tIGV4ZWN1dGlvbi4KICAgIGhhc2hlZF9zdGF0ZTogQXJjPEhhc2hlZFBvc3RTdGF0ZT4sCiAgICAvLy8gVW5zb3J0ZWQgdHJpZSB1cGRhdGVzIGZyb20gc3RhdGUgcm9vdCBjb21wdXRhdGlvbi4KICAgIHRyaWVfdXBkYXRlczogQXJjPFRyaWVVcGRhdGVzPiwKICAgIC8vLyBUaGUgcGVyc2lzdGVkIGFuY2VzdG9yIGhhc2ggdGhpcyB0cmllIGlucHV0IGlzIGFuY2hvcmVkIHRvLgogICAgYW5jaG9yX2hhc2g6IEIyNTYsCiAgICAvLy8gRGVmZXJyZWQgdHJpZSBkYXRhIGZyb20gYW5jZXN0b3IgYmxvY2tzIGZvciBtZXJnaW5nLgogICAgYW5jZXN0b3JzOiBWZWM8RGVmZXJyZWRUcmllRGF0YT4sCn0KCmltcGwgZm10OjpEZWJ1ZyBmb3IgRGVmZXJyZWRUcmllRGF0YSB7CiAgICBmbiBmbXQoJnNlbGYsIGY6ICZtdXQgZm10OjpGb3JtYXR0ZXI8J18+KSAtPiBmbXQ6OlJlc3VsdCB7CiAgICAgICAgbGV0IHN0YXRlID0gc2VsZi5zdGF0ZS5sb2NrKCk7CiAgICAgICAgbWF0Y2ggJipzdGF0ZSB7CiAgICAgICAgICAgIERlZmVycmVkU3RhdGU6OlBlbmRpbmcoXykgPT4gewogICAgICAgICAgICAgICAgZi5kZWJ1Z19zdHJ1Y3QoIkRlZmVycmVkVHJpZURhdGEiKS5maWVsZCgic3RhdGUiLCAmInBlbmRpbmciKS5maW5pc2goKQogICAgICAgICAgICB9CiAgICAgICAgICAgIERlZmVycmVkU3RhdGU6OlJlYWR5KF8pID0+IHsKICAgICAgICAgICAgICAgIGYuZGVidWdfc3RydWN0KCJEZWZlcnJlZFRyaWVEYXRhIikuZmllbGQoInN0YXRlIiwgJiJyZWFkeSIpLmZpbmlzaCgpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmltcGwgRGVmZXJyZWRUcmllRGF0YSB7CiAgICAvLy8gQ3JlYXRlIGEgbmV3IHBlbmRpbmcgaGFuZGxlIHdpdGggZmFsbGJhY2sgaW5wdXRzIGZvciBzeW5jaHJvbm91cyBjb21wdXRhdGlvbi4KICAgIC8vLwogICAgLy8vIElmIHRoZSBhc3luYyB0YXNrIGhhc24ndCBjb21wbGV0ZWQgd2hlbiBgd2FpdF9jbG9uZWRgIGlzIGNhbGxlZCwgdGhlIHRyaWUgZGF0YQogICAgLy8vIHdpbGwgYmUgY29tcHV0ZWQgc3luY2hyb25vdXNseSBmcm9tIHRoZXNlIGlucHV0cy4gVGhpcyBlbGltaW5hdGVzIGRlYWRsb2NrIHJpc2suCiAgICAvLy8KICAgIC8vLyAjIEFyZ3VtZW50cwogICAgLy8vICogYGhhc2hlZF9zdGF0ZWAgLSBVbnNvcnRlZCBoYXNoZWQgcG9zdC1zdGF0ZSBmcm9tIGV4ZWN1dGlvbgogICAgLy8vICogYHRyaWVfdXBkYXRlc2AgLSBVbnNvcnRlZCB0cmllIHVwZGF0ZXMgZnJvbSBzdGF0ZSByb290IGNvbXB1dGF0aW9uCiAgICAvLy8gKiBgYW5jaG9yX2hhc2hgIC0gVGhlIHBlcnNpc3RlZCBhbmNlc3RvciBoYXNoIHRoaXMgdHJpZSBpbnB1dCBpcyBhbmNob3JlZCB0bwogICAgLy8vICogYGFuY2VzdG9yc2AgLSBEZWZlcnJlZCB0cmllIGRhdGEgZnJvbSBhbmNlc3RvciBibG9ja3MgZm9yIG1lcmdpbmcKICAgIHB1YiBmbiBwZW5kaW5nKAogICAgICAgIGhhc2hlZF9zdGF0ZTogQXJjPEhhc2hlZFBvc3RTdGF0ZT4sCiAgICAgICAgdHJpZV91cGRhdGVzOiBBcmM8VHJpZVVwZGF0ZXM+LAogICAgICAgIGFuY2hvcl9oYXNoOiBCMjU2LAogICAgICAgIGFuY2VzdG9yczogVmVjPFNlbGY+LAogICAgKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgc3RhdGU6IEFyYzo6bmV3KE11dGV4OjpuZXcoRGVmZXJyZWRTdGF0ZTo6UGVuZGluZyhTb21lKFBlbmRpbmdJbnB1dHMgewogICAgICAgICAgICAgICAgaGFzaGVkX3N0YXRlLAogICAgICAgICAgICAgICAgdHJpZV91cGRhdGVzLAogICAgICAgICAgICAgICAgYW5jaG9yX2hhc2gsCiAgICAgICAgICAgICAgICBhbmNlc3RvcnMsCiAgICAgICAgICAgIH0pKSkpLAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQ3JlYXRlIGEgaGFuZGxlIHRoYXQgaXMgYWxyZWFkeSBwb3B1bGF0ZWQgd2l0aCB0aGUgZ2l2ZW4gW2BDb21wdXRlZFRyaWVEYXRhYF0uCiAgICAvLy8KICAgIC8vLyBVc2VmdWwgd2hlbiB0cmllIGRhdGEgaXMgYXZhaWxhYmxlIGltbWVkaWF0ZWx5LgogICAgLy8vIFtgU2VsZjo6d2FpdF9jbG9uZWRgXSB3aWxsIHJldHVybiB3aXRob3V0IGFueSBjb21wdXRhdGlvbi4KICAgIHB1YiBmbiByZWFkeShidW5kbGU6IENvbXB1dGVkVHJpZURhdGEpIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBzdGF0ZTogQXJjOjpuZXcoTXV0ZXg6Om5ldyhEZWZlcnJlZFN0YXRlOjpSZWFkeShidW5kbGUpKSkgfQogICAgfQoKICAgIC8vLyBTb3J0IGJsb2NrIGV4ZWN1dGlvbiBvdXRwdXRzIGFuZCBidWlsZCBhIFtgVHJpZUlucHV0U29ydGVkYF0gb3ZlcmxheS4KICAgIC8vLwogICAgLy8vIFRoZSB0cmllIGlucHV0IG92ZXJsYXkgYWNjdW11bGF0ZXMgc29ydGVkIGhhc2hlZCBzdGF0ZSAoYWNjb3VudC9zdG9yYWdlIGNoYW5nZXMpIGFuZAogICAgLy8vIHRyaWUgbm9kZSB1cGRhdGVzIGZyb20gYWxsIGluLW1lbW9yeSBhbmNlc3RvciBibG9ja3MuIFRoaXMgb3ZlcmxheSBpcyByZXF1aXJlZCBmb3I6CiAgICAvLy8gLSBDb21wdXRpbmcgc3RhdGUgcm9vdHMgb24gdG9wIG9mIGluLW1lbW9yeSBibG9ja3MKICAgIC8vLyAtIEdlbmVyYXRpbmcgc3RvcmFnZS9hY2NvdW50IHByb29mcyBmb3IgdW5wZXJzaXN0ZWQgc3RhdGUKICAgIC8vLwogICAgLy8vICMgUHJvY2VzcwogICAgLy8vIDEuIFNvcnQgdGhlIGN1cnJlbnQgYmxvY2sncyBoYXNoZWQgc3RhdGUgYW5kIHRyaWUgdXBkYXRlcwogICAgLy8vIDIuIFJldXNlIHBhcmVudCdzIGNhY2hlZCBvdmVybGF5IGlmIGF2YWlsYWJsZSAoTygxKSAtIHRoZSBjb21tb24gY2FzZSkKICAgIC8vLyAzLiBPdGhlcndpc2UsIHJlYnVpbGQgb3ZlcmxheSBmcm9tIGFuY2VzdG9ycyAocmFyZSBmYWxsYmFjaykKICAgIC8vLyA0LiBFeHRlbmQgdGhlIG92ZXJsYXkgd2l0aCB0aGlzIGJsb2NrJ3Mgc29ydGVkIGRhdGEKICAgIC8vLwogICAgLy8vIFVzZWQgYnkgYm90aCB0aGUgYXN5bmMgYmFja2dyb3VuZCB0YXNrIGFuZCB0aGUgc3luY2hyb25vdXMgZmFsbGJhY2sgcGF0aC4KICAgIC8vLwogICAgLy8vICMgQXJndW1lbnRzCiAgICAvLy8gKiBgaGFzaGVkX3N0YXRlYCAtIFVuc29ydGVkIGhhc2hlZCBwb3N0LXN0YXRlIChhY2NvdW50L3N0b3JhZ2UgY2hhbmdlcykgZnJvbSBleGVjdXRpb24KICAgIC8vLyAqIGB0cmllX3VwZGF0ZXNgIC0gVW5zb3J0ZWQgdHJpZSBub2RlIHVwZGF0ZXMgZnJvbSBzdGF0ZSByb290IGNvbXB1dGF0aW9uCiAgICAvLy8gKiBgYW5jaG9yX2hhc2hgIC0gVGhlIHBlcnNpc3RlZCBhbmNlc3RvciBoYXNoIHRoaXMgdHJpZSBpbnB1dCBpcyBhbmNob3JlZCB0bwogICAgLy8vICogYGFuY2VzdG9yc2AgLSBEZWZlcnJlZCB0cmllIGRhdGEgZnJvbSBhbmNlc3RvciBibG9ja3MgZm9yIG1lcmdpbmcgKG9sZGVzdCAtPiBuZXdlc3QpCiAgICBwdWIgZm4gc29ydF9hbmRfYnVpbGRfdHJpZV9pbnB1dCgKICAgICAgICBoYXNoZWRfc3RhdGU6IEFyYzxIYXNoZWRQb3N0U3RhdGU+LAogICAgICAgIHRyaWVfdXBkYXRlczogQXJjPFRyaWVVcGRhdGVzPiwKICAgICAgICBhbmNob3JfaGFzaDogQjI1NiwKICAgICAgICBhbmNlc3RvcnM6ICZbU2VsZl0sCiAgICApIC0+IENvbXB1dGVkVHJpZURhdGEgewogICAgICAgIGxldCBzb3J0ZWRfaGFzaGVkX3N0YXRlID0gbWF0Y2ggQXJjOjp0cnlfdW53cmFwKGhhc2hlZF9zdGF0ZSkgewogICAgICAgICAgICBPayhzdGF0ZSkgPT4gc3RhdGUuaW50b19zb3J0ZWQoKSwKICAgICAgICAgICAgRXJyKGFyYykgPT4gYXJjLmNsb25lX2ludG9fc29ydGVkKCksCiAgICAgICAgfTsKICAgICAgICBsZXQgc29ydGVkX3RyaWVfdXBkYXRlcyA9IG1hdGNoIEFyYzo6dHJ5X3Vud3JhcCh0cmllX3VwZGF0ZXMpIHsKICAgICAgICAgICAgT2sodXBkYXRlcykgPT4gdXBkYXRlcy5pbnRvX3NvcnRlZCgpLAogICAgICAgICAgICBFcnIoYXJjKSA9PiBhcmMuY2xvbmVfaW50b19zb3J0ZWQoKSwKICAgICAgICB9OwoKICAgICAgICAvLyBSZXVzZSBwYXJlbnQncyBvdmVybGF5IGlmIGF2YWlsYWJsZSBhbmQgYW5jaG9ycyBtYXRjaC4KICAgICAgICAvLyBXZSBjYW4gb25seSByZXVzZSB0aGUgcGFyZW50J3Mgb3ZlcmxheSBpZiBpdCB3YXMgYnVpbHQgb24gdG9wIG9mIHRoZSBzYW1lCiAgICAgICAgLy8gcGVyc2lzdGVkIGFuY2hvci4gSWYgdGhlIGFuY2hvciBoYXMgY2hhbmdlZCAoZS5nLiwgZHVlIHRvIHBlcnNpc3RlbmNlKSwKICAgICAgICAvLyB0aGUgcGFyZW50J3Mgb3ZlcmxheSBpcyByZWxhdGl2ZSB0byBhbiBvbGQgc3RhdGUgYW5kIGNhbm5vdCBiZSB1c2VkLgogICAgICAgIGxldCBvdmVybGF5ID0gaWYgbGV0IFNvbWUocGFyZW50KSA9IGFuY2VzdG9ycy5sYXN0KCkgewogICAgICAgICAgICBsZXQgcGFyZW50X2RhdGEgPSBwYXJlbnQud2FpdF9jbG9uZWQoKTsKCiAgICAgICAgICAgIG1hdGNoICZwYXJlbnRfZGF0YS5hbmNob3JlZF90cmllX2lucHV0IHsKICAgICAgICAgICAgICAgIC8vIENhc2UgMTogUGFyZW50IGhhcyBjYWNoZWQgb3ZlcmxheSBBTkQgYW5jaG9ycyBtYXRjaC4KICAgICAgICAgICAgICAgIFNvbWUoQW5jaG9yZWRUcmllSW5wdXQgeyBhbmNob3JfaGFzaDogcGFyZW50X2FuY2hvciwgdHJpZV9pbnB1dCB9KQogICAgICAgICAgICAgICAgICAgIGlmICpwYXJlbnRfYW5jaG9yID09IGFuY2hvcl9oYXNoID0+CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gTygxKTogUmV1c2UgcGFyZW50J3Mgb3ZlcmxheSwgZXh0ZW5kIHdpdGggY3VycmVudCBibG9jaydzIGRhdGEuCiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBvdmVybGF5ID0gVHJpZUlucHV0U29ydGVkOjpuZXcoCiAgICAgICAgICAgICAgICAgICAgICAgIEFyYzo6Y2xvbmUoJnRyaWVfaW5wdXQubm9kZXMpLAogICAgICAgICAgICAgICAgICAgICAgICBBcmM6OmNsb25lKCZ0cmllX2lucHV0LnN0YXRlKSwKICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdDo6ZGVmYXVsdCgpLCAvLyBwcmVmaXhfc2V0cyBhcmUgcGVyLWJsb2NrLCBub3QgY3VtdWxhdGl2ZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgLy8gT25seSB0cmlnZ2VyIENPVyBjbG9uZSBpZiB0aGVyZSdzIGFjdHVhbGx5IGRhdGEgdG8gYWRkLgogICAgICAgICAgICAgICAgICAgIGlmICFzb3J0ZWRfaGFzaGVkX3N0YXRlLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgICAgICAgICBBcmM6Om1ha2VfbXV0KCZtdXQgb3ZlcmxheS5zdGF0ZSkuZXh0ZW5kX3JlZigmc29ydGVkX2hhc2hlZF9zdGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICFzb3J0ZWRfdHJpZV91cGRhdGVzLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgICAgICAgICBBcmM6Om1ha2VfbXV0KCZtdXQgb3ZlcmxheS5ub2RlcykuZXh0ZW5kX3JlZigmc29ydGVkX3RyaWVfdXBkYXRlcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG92ZXJsYXkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIENhc2UgMjogUGFyZW50IGV4aXN0cyBidXQgYW5jaG9yIG1pc21hdGNoIG9yIG5vIGNhY2hlZCBvdmVybGF5LgogICAgICAgICAgICAgICAgLy8gV2UgbXVzdCByZWJ1aWxkIGZyb20gdGhlIGFuY2VzdG9ycyBsaXN0ICh3aGljaCBvbmx5IGNvbnRhaW5zIHVucGVyc2lzdGVkIGJsb2NrcykuCiAgICAgICAgICAgICAgICBfID0+IFNlbGY6Om1lcmdlX2FuY2VzdG9yc19pbnRvX292ZXJsYXkoCiAgICAgICAgICAgICAgICAgICAgYW5jZXN0b3JzLAogICAgICAgICAgICAgICAgICAgICZzb3J0ZWRfaGFzaGVkX3N0YXRlLAogICAgICAgICAgICAgICAgICAgICZzb3J0ZWRfdHJpZV91cGRhdGVzLAogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIENhc2UgMzogTm8gaW4tbWVtb3J5IGFuY2VzdG9ycyAoZmlyc3QgYmxvY2sgYWZ0ZXIgcGVyc2lzdGVkIGFuY2hvcikuCiAgICAgICAgICAgIC8vIEJ1aWxkIG92ZXJsYXkgd2l0aCBqdXN0IHRoaXMgYmxvY2sncyBkYXRhLgogICAgICAgICAgICBTZWxmOjptZXJnZV9hbmNlc3RvcnNfaW50b19vdmVybGF5KCZbXSwgJnNvcnRlZF9oYXNoZWRfc3RhdGUsICZzb3J0ZWRfdHJpZV91cGRhdGVzKQogICAgICAgIH07CgogICAgICAgIENvbXB1dGVkVHJpZURhdGE6OndpdGhfdHJpZV9pbnB1dCgKICAgICAgICAgICAgQXJjOjpuZXcoc29ydGVkX2hhc2hlZF9zdGF0ZSksCiAgICAgICAgICAgIEFyYzo6bmV3KHNvcnRlZF90cmllX3VwZGF0ZXMpLAogICAgICAgICAgICBhbmNob3JfaGFzaCwKICAgICAgICAgICAgQXJjOjpuZXcob3ZlcmxheSksCiAgICAgICAgKQogICAgfQoKICAgIC8vLyBNZXJnZSBhbGwgYW5jZXN0b3JzIGFuZCBjdXJyZW50IGJsb2NrJ3MgZGF0YSBpbnRvIGEgc2luZ2xlIG92ZXJsYXkuCiAgICAvLy8KICAgIC8vLyBUaGlzIGlzIGEgcmFyZSBmYWxsYmFjayBwYXRoLCBvbmx5IHVzZWQgd2hlbiBubyBhbmNlc3RvciBoYXMgYSBjYWNoZWQKICAgIC8vLyBgYW5jaG9yZWRfdHJpZV9pbnB1dGAgKGUuZy4sIGJsb2NrcyBjcmVhdGVkIHZpYSBhbHRlcm5hdGl2ZSBjb25zdHJ1Y3RvcnMpLgogICAgLy8vIEluIG5vcm1hbCBvcGVyYXRpb24sIHRoZSBwYXJlbnQgYWx3YXlzIGhhcyBhIGNhY2hlZCBvdmVybGF5IGFuZCB0aGlzCiAgICAvLy8gZnVuY3Rpb24gaXMgbmV2ZXIgY2FsbGVkLgogICAgLy8vCiAgICAvLy8gSXRlcmF0ZXMgYW5jZXN0b3JzIG9sZGVzdCAtPiBuZXdlc3QsIHRoZW4gZXh0ZW5kcyB3aXRoIGN1cnJlbnQgYmxvY2sncyBkYXRhLAogICAgLy8vIHNvIGxhdGVyIHN0YXRlIHRha2VzIHByZWNlZGVuY2UuCiAgICBmbiBtZXJnZV9hbmNlc3RvcnNfaW50b19vdmVybGF5KAogICAgICAgIGFuY2VzdG9yczogJltTZWxmXSwKICAgICAgICBzb3J0ZWRfaGFzaGVkX3N0YXRlOiAmSGFzaGVkUG9zdFN0YXRlU29ydGVkLAogICAgICAgIHNvcnRlZF90cmllX3VwZGF0ZXM6ICZUcmllVXBkYXRlc1NvcnRlZCwKICAgICkgLT4gVHJpZUlucHV0U29ydGVkIHsKICAgICAgICBsZXQgbXV0IG92ZXJsYXkgPSBUcmllSW5wdXRTb3J0ZWQ6OmRlZmF1bHQoKTsKCiAgICAgICAgbGV0IHN0YXRlX211dCA9IEFyYzo6bWFrZV9tdXQoJm11dCBvdmVybGF5LnN0YXRlKTsKICAgICAgICBsZXQgbm9kZXNfbXV0ID0gQXJjOjptYWtlX211dCgmbXV0IG92ZXJsYXkubm9kZXMpOwoKICAgICAgICBmb3IgYW5jZXN0b3IgaW4gYW5jZXN0b3JzIHsKICAgICAgICAgICAgbGV0IGFuY2VzdG9yX2RhdGEgPSBhbmNlc3Rvci53YWl0X2Nsb25lZCgpOwogICAgICAgICAgICBzdGF0ZV9tdXQuZXh0ZW5kX3JlZihhbmNlc3Rvcl9kYXRhLmhhc2hlZF9zdGF0ZS5hc19yZWYoKSk7CiAgICAgICAgICAgIG5vZGVzX211dC5leHRlbmRfcmVmKGFuY2VzdG9yX2RhdGEudHJpZV91cGRhdGVzLmFzX3JlZigpKTsKICAgICAgICB9CgogICAgICAgIC8vIEV4dGVuZCB3aXRoIGN1cnJlbnQgYmxvY2sncyBzb3J0ZWQgZGF0YSBsYXN0ICh0YWtlcyBwcmVjZWRlbmNlKQogICAgICAgIHN0YXRlX211dC5leHRlbmRfcmVmKHNvcnRlZF9oYXNoZWRfc3RhdGUpOwogICAgICAgIG5vZGVzX211dC5leHRlbmRfcmVmKHNvcnRlZF90cmllX3VwZGF0ZXMpOwoKICAgICAgICBvdmVybGF5CiAgICB9CgogICAgLy8vIFJldHVybnMgdHJpZSBkYXRhLCBjb21wdXRpbmcgc3luY2hyb25vdXNseSBpZiB0aGUgYXN5bmMgdGFzayBoYXNuJ3QgY29tcGxldGVkLgogICAgLy8vCiAgICAvLy8gLSBJZiB0aGUgYXN5bmMgdGFzayBoYXMgY29tcGxldGVkIChgUmVhZHlgKSwgcmV0dXJucyB0aGUgY2FjaGVkIHJlc3VsdC4KICAgIC8vLyAtIElmIHBlbmRpbmcsIGNvbXB1dGVzIHN5bmNocm9ub3VzbHkgZnJvbSBzdG9yZWQgaW5wdXRzLgogICAgLy8vCiAgICAvLy8gRGVhZGxvY2sgaXMgYXZvaWRlZCBhcyBsb25nIGFzIHRoZSBwcm92aWRlZCBhbmNlc3RvcnMgZm9ybSBhIHRydWUgYW5jZXN0b3IgY2hhaW4gKGEgREFHKToKICAgIC8vLyAtIEVhY2ggYmxvY2sgb25seSB3YWl0cyBvbiBpdHMgYW5jZXN0b3JzIChibG9ja3Mgb24gdGhlIHBhdGggdG8gdGhlIHBlcnNpc3RlZCByb290KQogICAgLy8vIC0gU2libGluZyBibG9ja3MgKGZvcmtzKSBhcmUgbmV2ZXIgaW4gZWFjaCBvdGhlcidzIGFuY2VzdG9yIGxpc3RzCiAgICAvLy8gLSBBIGJsb2NrIG5ldmVyIHdhaXRzIG9uIGl0cyBkZXNjZW5kYW50cwogICAgLy8vCiAgICAvLy8gR2l2ZW4gdGhhdCBpbnZhcmlhbnQsIGNpcmN1bGFyIHdhaXQgZGVwZW5kZW5jaWVzIGFyZSBpbXBvc3NpYmxlLgogICAgI1tpbnN0cnVtZW50KGxldmVsID0gImRlYnVnIiwgdGFyZ2V0ID0gImVuZ2luZTo6dHJlZTo6ZGVmZXJyZWRfdHJpZSIsIHNraXBfYWxsKV0KICAgIHB1YiBmbiB3YWl0X2Nsb25lZCgmc2VsZikgLT4gQ29tcHV0ZWRUcmllRGF0YSB7CiAgICAgICAgbGV0IG11dCBzdGF0ZSA9IHNlbGYuc3RhdGUubG9jaygpOwogICAgICAgIG1hdGNoICZtdXQgKnN0YXRlIHsKICAgICAgICAgICAgLy8gSWYgdGhlIGRlZmVycmVkIHRyaWUgZGF0YSBpcyByZWFkeSwgcmV0dXJuIHRoZSBjYWNoZWQgcmVzdWx0LgogICAgICAgICAgICBEZWZlcnJlZFN0YXRlOjpSZWFkeShidW5kbGUpID0+IHsKICAgICAgICAgICAgICAgIERFRkVSUkVEX1RSSUVfTUVUUklDUy5kZWZlcnJlZF90cmllX2FzeW5jX3JlYWR5LmluY3JlbWVudCgxKTsKICAgICAgICAgICAgICAgIGJ1bmRsZS5jbG9uZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gSWYgdGhlIGRlZmVycmVkIHRyaWUgZGF0YSBpcyBwZW5kaW5nLCBjb21wdXRlIHRoZSB0cmllIGRhdGEgc3luY2hyb25vdXNseSBhbmQgcmV0dXJuCiAgICAgICAgICAgIC8vIHRoZSByZXN1bHQuIFRoaXMgaXMgdGhlIGZhbGxiYWNrIHBhdGggaWYgdGhlIGFzeW5jIHRhc2sgaGFzbid0IGNvbXBsZXRlZC4KICAgICAgICAgICAgRGVmZXJyZWRTdGF0ZTo6UGVuZGluZyhtYXliZV9pbnB1dHMpID0+IHsKICAgICAgICAgICAgICAgIERFRkVSUkVEX1RSSUVfTUVUUklDUy5kZWZlcnJlZF90cmllX3N5bmNfZmFsbGJhY2suaW5jcmVtZW50KDEpOwoKICAgICAgICAgICAgICAgIGxldCBpbnB1dHMgPSBtYXliZV9pbnB1dHMudGFrZSgpLmV4cGVjdCgiaW5wdXRzIG11c3QgYmUgcHJlc2VudCBpbiBQZW5kaW5nIHN0YXRlIik7CgogICAgICAgICAgICAgICAgbGV0IGNvbXB1dGVkID0gU2VsZjo6c29ydF9hbmRfYnVpbGRfdHJpZV9pbnB1dCgKICAgICAgICAgICAgICAgICAgICBpbnB1dHMuaGFzaGVkX3N0YXRlLAogICAgICAgICAgICAgICAgICAgIGlucHV0cy50cmllX3VwZGF0ZXMsCiAgICAgICAgICAgICAgICAgICAgaW5wdXRzLmFuY2hvcl9oYXNoLAogICAgICAgICAgICAgICAgICAgICZpbnB1dHMuYW5jZXN0b3JzLAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICpzdGF0ZSA9IERlZmVycmVkU3RhdGU6OlJlYWR5KGNvbXB1dGVkLmNsb25lKCkpOwogICAgICAgICAgICAgICAgY29tcHV0ZWQKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKaW1wbCBDb21wdXRlZFRyaWVEYXRhIHsKICAgIC8vLyBDb25zdHJ1Y3QgYSBidW5kbGUgdGhhdCBpbmNsdWRlcyB0cmllIGlucHV0IGFuY2hvcmVkIHRvIGEgcGVyc2lzdGVkIGFuY2VzdG9yLgogICAgcHViIGNvbnN0IGZuIHdpdGhfdHJpZV9pbnB1dCgKICAgICAgICBoYXNoZWRfc3RhdGU6IEFyYzxIYXNoZWRQb3N0U3RhdGVTb3J0ZWQ+LAogICAgICAgIHRyaWVfdXBkYXRlczogQXJjPFRyaWVVcGRhdGVzU29ydGVkPiwKICAgICAgICBhbmNob3JfaGFzaDogQjI1NiwKICAgICAgICB0cmllX2lucHV0OiBBcmM8VHJpZUlucHV0U29ydGVkPiwKICAgICkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIGhhc2hlZF9zdGF0ZSwKICAgICAgICAgICAgdHJpZV91cGRhdGVzLAogICAgICAgICAgICBhbmNob3JlZF90cmllX2lucHV0OiBTb21lKEFuY2hvcmVkVHJpZUlucHV0IHsgYW5jaG9yX2hhc2gsIHRyaWVfaW5wdXQgfSksCiAgICAgICAgfQogICAgfQoKICAgIC8vLyBDb25zdHJ1Y3QgYSBidW5kbGUgd2l0aG91dCB0cmllIGlucHV0IG9yIGFuY2hvciBpbmZvcm1hdGlvbi4KICAgIC8vLwogICAgLy8vIFVubGlrZSBbYFNlbGY6OndpdGhfdHJpZV9pbnB1dGBdLCB0aGlzIGNvbnN0cnVjdG9yIG9taXRzIHRoZSBhY2N1bXVsYXRlZCB0cmllIGlucHV0IG92ZXJsYXkKICAgIC8vLyBhbmQgaXRzIGFuY2hvciBoYXNoLiBVc2UgdGhpcyB3aGVuIHRoZSB0cmllIGlucHV0IGlzIG5vdCBuZWVkZWQsIHN1Y2ggYXMgaW4gYmxvY2sgYnVpbGRlcnMKICAgIC8vLyBvciBzZXF1ZW5jZXJzIHRoYXQgZG9uJ3QgcmVxdWlyZSBwcm9vZiBnZW5lcmF0aW9uIG9uIHRvcCBvZiBpbi1tZW1vcnkgc3RhdGUuCiAgICAvLy8KICAgIC8vLyBUaGUgdHJpZSBpbnB1dCBhbmNob3IgaWRlbnRpZmllcyB0aGUgcGVyc2lzdGVkIGJsb2NrIGhhc2ggZnJvbSB3aGljaCB0aGUgaW4tbWVtb3J5IG92ZXJsYXkKICAgIC8vLyB3YXMgYnVpbHQuIFdpdGhvdXQgaXQsIGNvbnN1bWVycyBjYW5ub3QgZGV0ZXJtaW5lIHdoaWNoIG9uLWRpc2sgc3RhdGUgdG8gY29tYmluZSB3aXRoLgogICAgcHViIGNvbnN0IGZuIHdpdGhvdXRfdHJpZV9pbnB1dCgKICAgICAgICBoYXNoZWRfc3RhdGU6IEFyYzxIYXNoZWRQb3N0U3RhdGVTb3J0ZWQ+LAogICAgICAgIHRyaWVfdXBkYXRlczogQXJjPFRyaWVVcGRhdGVzU29ydGVkPiwKICAgICkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGhhc2hlZF9zdGF0ZSwgdHJpZV91cGRhdGVzLCBhbmNob3JlZF90cmllX2lucHV0OiBOb25lIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgYW5jaG9yIGhhc2gsIGlmIHByZXNlbnQuCiAgICBwdWIgZm4gYW5jaG9yX2hhc2goJnNlbGYpIC0+IE9wdGlvbjxCMjU2PiB7CiAgICAgICAgc2VsZi5hbmNob3JlZF90cmllX2lucHV0LmFzX3JlZigpLm1hcCh8YW5jaG9yZWR8IGFuY2hvcmVkLmFuY2hvcl9oYXNoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSB0cmllIGlucHV0LCBpZiBwcmVzZW50LgogICAgcHViIGZuIHRyaWVfaW5wdXQoJnNlbGYpIC0+IE9wdGlvbjwmQXJjPFRyaWVJbnB1dFNvcnRlZD4+IHsKICAgICAgICBzZWxmLmFuY2hvcmVkX3RyaWVfaW5wdXQuYXNfcmVmKCkubWFwKHxhbmNob3JlZHwgJmFuY2hvcmVkLnRyaWVfaW5wdXQpCiAgICB9Cn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdHMgewogICAgdXNlIHN1cGVyOjoqOwogICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OnttYXA6OkIyNTZNYXAsIFUyNTZ9OwogICAgdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OkFjY291bnQ7CiAgICB1c2UgcmV0aF90cmllOjp1cGRhdGVzOjpUcmllVXBkYXRlczsKICAgIHVzZSBzdGQ6OnsKICAgICAgICBzeW5jOjpBcmMsCiAgICAgICAgdGhyZWFkLAogICAgICAgIHRpbWU6OntEdXJhdGlvbiwgSW5zdGFudH0sCiAgICB9OwoKICAgIGZuIGVtcHR5X2J1bmRsZSgpIC0+IENvbXB1dGVkVHJpZURhdGEgewogICAgICAgIENvbXB1dGVkVHJpZURhdGEgewogICAgICAgICAgICBoYXNoZWRfc3RhdGU6IEFyYzo6ZGVmYXVsdCgpLAogICAgICAgICAgICB0cmllX3VwZGF0ZXM6IEFyYzo6ZGVmYXVsdCgpLAogICAgICAgICAgICBhbmNob3JlZF90cmllX2lucHV0OiBOb25lLAogICAgICAgIH0KICAgIH0KCiAgICBmbiBlbXB0eV9wZW5kaW5nKCkgLT4gRGVmZXJyZWRUcmllRGF0YSB7CiAgICAgICAgZW1wdHlfcGVuZGluZ193aXRoX2FuY2hvcihCMjU2OjpaRVJPKQogICAgfQoKICAgIGZuIGVtcHR5X3BlbmRpbmdfd2l0aF9hbmNob3IoYW5jaG9yOiBCMjU2KSAtPiBEZWZlcnJlZFRyaWVEYXRhIHsKICAgICAgICBEZWZlcnJlZFRyaWVEYXRhOjpwZW5kaW5nKAogICAgICAgICAgICBBcmM6Om5ldyhIYXNoZWRQb3N0U3RhdGU6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIEFyYzo6bmV3KFRyaWVVcGRhdGVzOjpkZWZhdWx0KCkpLAogICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgIFZlYzo6bmV3KCksCiAgICAgICAgKQogICAgfQoKICAgIC8vLyBWZXJpZmllcyB0aGF0IGEgcmVhZHkgaGFuZGxlIHJldHVybnMgaW1tZWRpYXRlbHkgd2l0aG91dCBjb21wdXRhdGlvbi4KICAgICNbdGVzdF0KICAgIGZuIHJlYWR5X3JldHVybnNfaW1tZWRpYXRlbHkoKSB7CiAgICAgICAgbGV0IGJ1bmRsZSA9IGVtcHR5X2J1bmRsZSgpOwogICAgICAgIGxldCBkZWZlcnJlZCA9IERlZmVycmVkVHJpZURhdGE6OnJlYWR5KGJ1bmRsZS5jbG9uZSgpKTsKCiAgICAgICAgbGV0IHN0YXJ0ID0gSW5zdGFudDo6bm93KCk7CiAgICAgICAgbGV0IHJlc3VsdCA9IGRlZmVycmVkLndhaXRfY2xvbmVkKCk7CiAgICAgICAgbGV0IGVsYXBzZWQgPSBzdGFydC5lbGFwc2VkKCk7CgogICAgICAgIGFzc2VydF9lcSEocmVzdWx0Lmhhc2hlZF9zdGF0ZSwgYnVuZGxlLmhhc2hlZF9zdGF0ZSk7CiAgICAgICAgYXNzZXJ0X2VxIShyZXN1bHQudHJpZV91cGRhdGVzLCBidW5kbGUudHJpZV91cGRhdGVzKTsKICAgICAgICBhc3NlcnRfZXEhKHJlc3VsdC5hbmNob3JfaGFzaCgpLCBidW5kbGUuYW5jaG9yX2hhc2goKSk7CiAgICAgICAgYXNzZXJ0IShlbGFwc2VkIDwgRHVyYXRpb246OmZyb21fbWlsbGlzKDIwKSk7CiAgICB9CgogICAgLy8vIFZlcmlmaWVzIHRoYXQgYSBwZW5kaW5nIGhhbmRsZSBjb21wdXRlcyB0cmllIGRhdGEgc3luY2hyb25vdXNseSB2aWEgZmFsbGJhY2suCiAgICAjW3Rlc3RdCiAgICBmbiBwZW5kaW5nX2NvbXB1dGVzX2ZhbGxiYWNrKCkgewogICAgICAgIGxldCBkZWZlcnJlZCA9IGVtcHR5X3BlbmRpbmcoKTsKCiAgICAgICAgLy8gd2FpdF9jbG9uZWQgc2hvdWxkIGNvbXB1dGUgZnJvbSBpbnB1dHMgd2l0aG91dCBibG9ja2luZwogICAgICAgIGxldCBzdGFydCA9IEluc3RhbnQ6Om5vdygpOwogICAgICAgIGxldCByZXN1bHQgPSBkZWZlcnJlZC53YWl0X2Nsb25lZCgpOwogICAgICAgIGxldCBlbGFwc2VkID0gc3RhcnQuZWxhcHNlZCgpOwoKICAgICAgICAvLyBTaG91bGQgcmV0dXJuIHF1aWNrbHkgKGZhbGxiYWNrIGNvbXB1dGF0aW9uKQogICAgICAgIGFzc2VydCEoZWxhcHNlZCA8IER1cmF0aW9uOjpmcm9tX21pbGxpcygxMDApKTsKICAgICAgICBhc3NlcnQhKHJlc3VsdC5oYXNoZWRfc3RhdGUuaXNfZW1wdHkoKSk7CiAgICB9CgogICAgLy8vIFZlcmlmaWVzIHRoYXQgZmFsbGJhY2sgY29tcHV0YXRpb24gcmVzdWx0IGlzIGNhY2hlZCBmb3Igc3Vic2VxdWVudCBjYWxscy4KICAgICNbdGVzdF0KICAgIGZuIGZhbGxiYWNrX3Jlc3VsdF9pc19jYWNoZWQoKSB7CiAgICAgICAgbGV0IGRlZmVycmVkID0gZW1wdHlfcGVuZGluZygpOwoKICAgICAgICAvLyBGaXJzdCBjYWxsIGNvbXB1dGVzIGFuZCBzaG91bGQgc3Rhc2ggdGhlIHJlc3VsdAogICAgICAgIGxldCBmaXJzdCA9IGRlZmVycmVkLndhaXRfY2xvbmVkKCk7CiAgICAgICAgLy8gU2Vjb25kIGNhbGwgc2hvdWxkIHJldXNlIHRoZSBjYWNoZWQgcmVzdWx0IChzYW1lIEFyYyBwb2ludGVyKQogICAgICAgIGxldCBzZWNvbmQgPSBkZWZlcnJlZC53YWl0X2Nsb25lZCgpOwoKICAgICAgICBhc3NlcnQhKEFyYzo6cHRyX2VxKCZmaXJzdC5oYXNoZWRfc3RhdGUsICZzZWNvbmQuaGFzaGVkX3N0YXRlKSk7CiAgICAgICAgYXNzZXJ0IShBcmM6OnB0cl9lcSgmZmlyc3QudHJpZV91cGRhdGVzLCAmc2Vjb25kLnRyaWVfdXBkYXRlcykpOwogICAgICAgIGFzc2VydF9lcSEoZmlyc3QuYW5jaG9yX2hhc2goKSwgc2Vjb25kLmFuY2hvcl9oYXNoKCkpOwogICAgfQoKICAgIC8vLyBWZXJpZmllcyB0aGF0IGNvbmN1cnJlbnQgYHdhaXRfY2xvbmVkYCBjYWxscyByZXN1bHQgaW4gb25seSBvbmUgY29tcHV0YXRpb24sCiAgICAvLy8gd2l0aCBhbGwgY2FsbGVycyByZWNlaXZpbmcgdGhlIHNhbWUgY2FjaGVkIHJlc3VsdC4KICAgICNbdGVzdF0KICAgIGZuIGNvbmN1cnJlbnRfd2FpdF9jbG9uZWRfY29tcHV0ZXNfb25jZSgpIHsKICAgICAgICBsZXQgZGVmZXJyZWQgPSBlbXB0eV9wZW5kaW5nKCk7CgogICAgICAgIC8vIFNwYXduIG11bHRpcGxlIHRocmVhZHMgdGhhdCBhbGwgY2FsbCB3YWl0X2Nsb25lZCBjb25jdXJyZW50bHkKICAgICAgICBsZXQgaGFuZGxlczogVmVjPF8+ID0gKDAuLjEwKQogICAgICAgICAgICAubWFwKHxffCB7CiAgICAgICAgICAgICAgICBsZXQgZCA9IGRlZmVycmVkLmNsb25lKCk7CiAgICAgICAgICAgICAgICB0aHJlYWQ6OnNwYXduKG1vdmUgfHwgZC53YWl0X2Nsb25lZCgpKQogICAgICAgICAgICB9KQogICAgICAgICAgICAuY29sbGVjdCgpOwoKICAgICAgICAvLyBDb2xsZWN0IGFsbCByZXN1bHRzCiAgICAgICAgbGV0IHJlc3VsdHM6IFZlYzxfPiA9IGhhbmRsZXMuaW50b19pdGVyKCkubWFwKHxofCBoLmpvaW4oKS51bndyYXAoKSkuY29sbGVjdCgpOwoKICAgICAgICAvLyBBbGwgcmVzdWx0cyBzaG91bGQgc2hhcmUgdGhlIHNhbWUgQXJjIHBvaW50ZXJzIChzYW1lIGNvbXB1dGVkIHJlc3VsdCkKICAgICAgICBsZXQgZmlyc3QgPSAmcmVzdWx0c1swXTsKICAgICAgICBmb3IgcmVzdWx0IGluICZyZXN1bHRzWzEuLl0gewogICAgICAgICAgICBhc3NlcnQhKEFyYzo6cHRyX2VxKCZmaXJzdC5oYXNoZWRfc3RhdGUsICZyZXN1bHQuaGFzaGVkX3N0YXRlKSk7CiAgICAgICAgICAgIGFzc2VydCEoQXJjOjpwdHJfZXEoJmZpcnN0LnRyaWVfdXBkYXRlcywgJnJlc3VsdC50cmllX3VwZGF0ZXMpKTsKICAgICAgICB9CiAgICB9CgogICAgLy8vIFRlc3RzIHRoYXQgYW5jZXN0b3IgdHJpZSBkYXRhIGlzIG1lcmdlZCBkdXJpbmcgZmFsbGJhY2sgY29tcHV0YXRpb24gYW5kIHRoYXQgdGhlCiAgICAvLy8gcmVzdWx0aW5nIGBDb21wdXRlZFRyaWVEYXRhYCB1c2VzIHRoZSBjdXJyZW50IGJsb2NrJ3MgYW5jaG9yIGhhc2gsIG5vdCB0aGUgYW5jZXN0b3Incy4KICAgICNbdGVzdF0KICAgIGZuIGFuY2VzdG9yc19hcmVfbWVyZ2VkKCkgewogICAgICAgIC8vIENyZWF0ZSBhbmNlc3RvciB3aXRoIHNvbWUgZGF0YQogICAgICAgIGxldCBhbmNlc3Rvcl9idW5kbGUgPSBDb21wdXRlZFRyaWVEYXRhIHsKICAgICAgICAgICAgaGFzaGVkX3N0YXRlOiBBcmM6OmRlZmF1bHQoKSwKICAgICAgICAgICAgdHJpZV91cGRhdGVzOiBBcmM6OmRlZmF1bHQoKSwKICAgICAgICAgICAgYW5jaG9yZWRfdHJpZV9pbnB1dDogU29tZShBbmNob3JlZFRyaWVJbnB1dCB7CiAgICAgICAgICAgICAgICBhbmNob3JfaGFzaDogQjI1Njo6d2l0aF9sYXN0X2J5dGUoMSksCiAgICAgICAgICAgICAgICB0cmllX2lucHV0OiBBcmM6Om5ldyhUcmllSW5wdXRTb3J0ZWQ6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIH0pLAogICAgICAgIH07CiAgICAgICAgbGV0IGFuY2VzdG9yID0gRGVmZXJyZWRUcmllRGF0YTo6cmVhZHkoYW5jZXN0b3JfYnVuZGxlKTsKCiAgICAgICAgLy8gQ3JlYXRlIHBlbmRpbmcgd2l0aCBhbmNlc3RvcgogICAgICAgIGxldCBkZWZlcnJlZCA9IERlZmVycmVkVHJpZURhdGE6OnBlbmRpbmcoCiAgICAgICAgICAgIEFyYzo6bmV3KEhhc2hlZFBvc3RTdGF0ZTo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgQXJjOjpuZXcoVHJpZVVwZGF0ZXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIEIyNTY6OndpdGhfbGFzdF9ieXRlKDIpLAogICAgICAgICAgICB2ZWMhW2FuY2VzdG9yXSwKICAgICAgICApOwoKICAgICAgICBsZXQgcmVzdWx0ID0gZGVmZXJyZWQud2FpdF9jbG9uZWQoKTsKICAgICAgICAvLyBTaG91bGQgaGF2ZSB0aGUgY3VycmVudCBibG9jaydzIGFuY2hvciwgbm90IHRoZSBhbmNlc3RvcidzCiAgICAgICAgYXNzZXJ0X2VxIShyZXN1bHQuYW5jaG9yX2hhc2goKSwgU29tZShCMjU2Ojp3aXRoX2xhc3RfYnl0ZSgyKSkpOwogICAgfQoKICAgIC8vLyBFbnN1cmVzIGFuY2VzdG9yIG92ZXJsYXlzIGFyZSBtZXJnZWQgb2xkZXN0IC0+IG5ld2VzdCBzbyBsYXRlc3Qgc3RhdGUgd2lucyAobm8gb3ZlcndyaXRlIGJ5CiAgICAvLy8gb2xkZXIgYW5jZXN0b3JzKS4KICAgICNbdGVzdF0KICAgIGZuIGFuY2VzdG9yc19tZXJnZV9pbl9jaHJvbm9sb2dpY2FsX29yZGVyKCkgewogICAgICAgIGxldCBrZXkgPSBCMjU2Ojp3aXRoX2xhc3RfYnl0ZSgxKTsKICAgICAgICAvLyBPbGRlc3QgYW5jZXN0b3Igc2V0cyBub25jZSB0byAxCiAgICAgICAgbGV0IG9sZGVzdF9zdGF0ZSA9IEhhc2hlZFBvc3RTdGF0ZVNvcnRlZDo6bmV3KAogICAgICAgICAgICB2ZWMhWyhrZXksIFNvbWUoQWNjb3VudCB7IG5vbmNlOiAxLCBiYWxhbmNlOiBVMjU2OjpaRVJPLCBieXRlY29kZV9oYXNoOiBOb25lIH0pKV0sCiAgICAgICAgICAgIEIyNTZNYXA6OmRlZmF1bHQoKSwKICAgICAgICApOwogICAgICAgIC8vIE5ld2VzdCBhbmNlc3RvciBvdmVyd3JpdGVzIG5vbmNlIHRvIDIKICAgICAgICBsZXQgbmV3ZXN0X3N0YXRlID0gSGFzaGVkUG9zdFN0YXRlU29ydGVkOjpuZXcoCiAgICAgICAgICAgIHZlYyFbKGtleSwgU29tZShBY2NvdW50IHsgbm9uY2U6IDIsIGJhbGFuY2U6IFUyNTY6OlpFUk8sIGJ5dGVjb2RlX2hhc2g6IE5vbmUgfSkpXSwKICAgICAgICAgICAgQjI1Nk1hcDo6ZGVmYXVsdCgpLAogICAgICAgICk7CgogICAgICAgIGxldCBvbGRlc3QgPSBDb21wdXRlZFRyaWVEYXRhIHsKICAgICAgICAgICAgaGFzaGVkX3N0YXRlOiBBcmM6Om5ldyhvbGRlc3Rfc3RhdGUpLAogICAgICAgICAgICB0cmllX3VwZGF0ZXM6IEFyYzo6ZGVmYXVsdCgpLAogICAgICAgICAgICBhbmNob3JlZF90cmllX2lucHV0OiBOb25lLAogICAgICAgIH07CiAgICAgICAgbGV0IG5ld2VzdCA9IENvbXB1dGVkVHJpZURhdGEgewogICAgICAgICAgICBoYXNoZWRfc3RhdGU6IEFyYzo6bmV3KG5ld2VzdF9zdGF0ZSksCiAgICAgICAgICAgIHRyaWVfdXBkYXRlczogQXJjOjpkZWZhdWx0KCksCiAgICAgICAgICAgIGFuY2hvcmVkX3RyaWVfaW5wdXQ6IE5vbmUsCiAgICAgICAgfTsKCiAgICAgICAgLy8gUGFzcyBhbmNlc3RvcnMgb2xkZXN0IC0+IG5ld2VzdDsgbmV3ZXN0IHNob3VsZCB0YWtlIHByZWNlZGVuY2UKICAgICAgICBsZXQgZGVmZXJyZWQgPSBEZWZlcnJlZFRyaWVEYXRhOjpwZW5kaW5nKAogICAgICAgICAgICBBcmM6Om5ldyhIYXNoZWRQb3N0U3RhdGU6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIEFyYzo6bmV3KFRyaWVVcGRhdGVzOjpkZWZhdWx0KCkpLAogICAgICAgICAgICBCMjU2OjpaRVJPLAogICAgICAgICAgICB2ZWMhW0RlZmVycmVkVHJpZURhdGE6OnJlYWR5KG9sZGVzdCksIERlZmVycmVkVHJpZURhdGE6OnJlYWR5KG5ld2VzdCldLAogICAgICAgICk7CgogICAgICAgIGxldCByZXN1bHQgPSBkZWZlcnJlZC53YWl0X2Nsb25lZCgpOwogICAgICAgIGxldCBvdmVybGF5X3N0YXRlID0gJnJlc3VsdC5hbmNob3JlZF90cmllX2lucHV0LmFzX3JlZigpLnVud3JhcCgpLnRyaWVfaW5wdXQuc3RhdGUuYWNjb3VudHM7CiAgICAgICAgYXNzZXJ0X2VxIShvdmVybGF5X3N0YXRlLmxlbigpLCAxKTsKICAgICAgICBsZXQgKF8sIGFjY291bnQpID0gJm92ZXJsYXlfc3RhdGVbMF07CiAgICAgICAgYXNzZXJ0X2VxIShhY2NvdW50LnVud3JhcCgpLm5vbmNlLCAyKTsKICAgIH0KCiAgICAvLy8gSGVscGVyIHRvIGNyZWF0ZSBhIHJlYWR5IGJsb2NrIHdpdGggYW5jaG9yZWQgdHJpZSBpbnB1dCBjb250YWluaW5nIHNwZWNpZmljIHN0YXRlLgogICAgZm4gcmVhZHlfYmxvY2tfd2l0aF9zdGF0ZSgKICAgICAgICBhbmNob3JfaGFzaDogQjI1NiwKICAgICAgICBhY2NvdW50czogVmVjPChCMjU2LCBPcHRpb248QWNjb3VudD4pPiwKICAgICkgLT4gRGVmZXJyZWRUcmllRGF0YSB7CiAgICAgICAgbGV0IGhhc2hlZF9zdGF0ZSA9IEFyYzo6bmV3KEhhc2hlZFBvc3RTdGF0ZVNvcnRlZDo6bmV3KGFjY291bnRzLCBCMjU2TWFwOjpkZWZhdWx0KCkpKTsKICAgICAgICBsZXQgdHJpZV91cGRhdGVzID0gQXJjOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IG11dCBvdmVybGF5ID0gVHJpZUlucHV0U29ydGVkOjpkZWZhdWx0KCk7CiAgICAgICAgQXJjOjptYWtlX211dCgmbXV0IG92ZXJsYXkuc3RhdGUpLmV4dGVuZF9yZWYoaGFzaGVkX3N0YXRlLmFzX3JlZigpKTsKCiAgICAgICAgRGVmZXJyZWRUcmllRGF0YTo6cmVhZHkoQ29tcHV0ZWRUcmllRGF0YSB7CiAgICAgICAgICAgIGhhc2hlZF9zdGF0ZSwKICAgICAgICAgICAgdHJpZV91cGRhdGVzLAogICAgICAgICAgICBhbmNob3JlZF90cmllX2lucHV0OiBTb21lKEFuY2hvcmVkVHJpZUlucHV0IHsKICAgICAgICAgICAgICAgIGFuY2hvcl9oYXNoLAogICAgICAgICAgICAgICAgdHJpZV9pbnB1dDogQXJjOjpuZXcob3ZlcmxheSksCiAgICAgICAgICAgIH0pLAogICAgICAgIH0pCiAgICB9CgogICAgLy8vIFZlcmlmaWVzIHRoYXQgZmlyc3QgYmxvY2sgYWZ0ZXIgYW5jaG9yIChubyBhbmNlc3RvcnMpIGNyZWF0ZXMgZW1wdHkgYmFzZSBvdmVybGF5LgogICAgI1t0ZXN0XQogICAgZm4gZmlyc3RfYmxvY2tfYWZ0ZXJfYW5jaG9yX2NyZWF0ZXNfZW1wdHlfYmFzZSgpIHsKICAgICAgICBsZXQgYW5jaG9yID0gQjI1Njo6d2l0aF9sYXN0X2J5dGUoMSk7CiAgICAgICAgbGV0IGtleSA9IEIyNTY6OndpdGhfbGFzdF9ieXRlKDQyKTsKICAgICAgICBsZXQgYWNjb3VudCA9IEFjY291bnQgeyBub25jZTogMSwgYmFsYW5jZTogVTI1Njo6WkVSTywgYnl0ZWNvZGVfaGFzaDogTm9uZSB9OwoKICAgICAgICAvLyBGaXJzdCBibG9jayBhZnRlciBhbmNob3IgLSBubyBhbmNlc3RvcnMKICAgICAgICBsZXQgZmlyc3RfYmxvY2sgPSBEZWZlcnJlZFRyaWVEYXRhOjpwZW5kaW5nKAogICAgICAgICAgICBBcmM6Om5ldyhIYXNoZWRQb3N0U3RhdGU6OmRlZmF1bHQoKS53aXRoX2FjY291bnRzKFsoa2V5LCBTb21lKGFjY291bnQpKV0pKSwKICAgICAgICAgICAgQXJjOjpuZXcoVHJpZVVwZGF0ZXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIGFuY2hvciwKICAgICAgICAgICAgdmVjIVtdLCAvLyBObyBhbmNlc3RvcnMKICAgICAgICApOwoKICAgICAgICBsZXQgcmVzdWx0ID0gZmlyc3RfYmxvY2sud2FpdF9jbG9uZWQoKTsKCiAgICAgICAgLy8gU2hvdWxkIGhhdmUgb3ZlcmxheSB3aXRoIGp1c3QgdGhpcyBibG9jaydzIGRhdGEKICAgICAgICBsZXQgb3ZlcmxheSA9IHJlc3VsdC5hbmNob3JlZF90cmllX2lucHV0LmFzX3JlZigpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEob3ZlcmxheS5hbmNob3JfaGFzaCwgYW5jaG9yKTsKICAgICAgICBhc3NlcnRfZXEhKG92ZXJsYXkudHJpZV9pbnB1dC5zdGF0ZS5hY2NvdW50cy5sZW4oKSwgMSk7CiAgICAgICAgbGV0IChmb3VuZF9rZXksIGZvdW5kX2FjY291bnQpID0gJm92ZXJsYXkudHJpZV9pbnB1dC5zdGF0ZS5hY2NvdW50c1swXTsKICAgICAgICBhc3NlcnRfZXEhKCpmb3VuZF9rZXksIGtleSk7CiAgICAgICAgYXNzZXJ0X2VxIShmb3VuZF9hY2NvdW50LnVud3JhcCgpLm5vbmNlLCAxKTsKICAgIH0KCiAgICAvLy8gVmVyaWZpZXMgdGhhdCBwYXJlbnQncyBvdmVybGF5IGlzIHJldXNlZCByZWdhcmRsZXNzIG9mIGFuY2hvci4KICAgICNbdGVzdF0KICAgIGZuIHJldXNlc19wYXJlbnRfb3ZlcmxheSgpIHsKICAgICAgICBsZXQgYW5jaG9yID0gQjI1Njo6d2l0aF9sYXN0X2J5dGUoMSk7CiAgICAgICAgbGV0IGtleSA9IEIyNTY6OndpdGhfbGFzdF9ieXRlKDQyKTsKICAgICAgICBsZXQgYWNjb3VudCA9IEFjY291bnQgeyBub25jZTogMTAwLCBiYWxhbmNlOiBVMjU2OjpaRVJPLCBieXRlY29kZV9oYXNoOiBOb25lIH07CgogICAgICAgIC8vIENyZWF0ZSBwYXJlbnQgd2l0aCBhbmNob3JlZCB0cmllIGlucHV0CiAgICAgICAgbGV0IHBhcmVudCA9IHJlYWR5X2Jsb2NrX3dpdGhfc3RhdGUoYW5jaG9yLCB2ZWMhWyhrZXksIFNvbWUoYWNjb3VudCkpXSk7CgogICAgICAgIC8vIENyZWF0ZSBjaGlsZCAtIHNob3VsZCByZXVzZSBwYXJlbnQncyBvdmVybGF5CiAgICAgICAgbGV0IGNoaWxkID0gRGVmZXJyZWRUcmllRGF0YTo6cGVuZGluZygKICAgICAgICAgICAgQXJjOjpuZXcoSGFzaGVkUG9zdFN0YXRlOjpkZWZhdWx0KCkpLAogICAgICAgICAgICBBcmM6Om5ldyhUcmllVXBkYXRlczo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgYW5jaG9yLAogICAgICAgICAgICB2ZWMhW3BhcmVudF0sCiAgICAgICAgKTsKCiAgICAgICAgbGV0IHJlc3VsdCA9IGNoaWxkLndhaXRfY2xvbmVkKCk7CgogICAgICAgIC8vIFZlcmlmeSBwYXJlbnQncyBhY2NvdW50IGlzIGluIHRoZSBvdmVybGF5CiAgICAgICAgbGV0IG92ZXJsYXkgPSByZXN1bHQuYW5jaG9yZWRfdHJpZV9pbnB1dC5hc19yZWYoKS51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKG92ZXJsYXkuYW5jaG9yX2hhc2gsIGFuY2hvcik7CiAgICAgICAgYXNzZXJ0X2VxIShvdmVybGF5LnRyaWVfaW5wdXQuc3RhdGUuYWNjb3VudHMubGVuKCksIDEpOwogICAgICAgIGxldCAoZm91bmRfa2V5LCBmb3VuZF9hY2NvdW50KSA9ICZvdmVybGF5LnRyaWVfaW5wdXQuc3RhdGUuYWNjb3VudHNbMF07CiAgICAgICAgYXNzZXJ0X2VxISgqZm91bmRfa2V5LCBrZXkpOwogICAgICAgIGFzc2VydF9lcSEoZm91bmRfYWNjb3VudC51bndyYXAoKS5ub25jZSwgMTAwKTsKICAgIH0KCiAgICAvLy8gVmVyaWZpZXMgdGhhdCBwYXJlbnQncyBvdmVybGF5IGlzIE5PVCByZXVzZWQgd2hlbiBhbmNob3IgY2hhbmdlcyAoYWZ0ZXIgcGVyc2lzdCkuCiAgICAvLy8gVGhlIG92ZXJsYXkgZGF0YSBpcyBkZXBlbmRlbnQgb24gdGhlIGFuY2hvciwgc28gaXQgbXVzdCBiZSByZWJ1aWx0IGZyb20gdGhlCiAgICAvLy8gcmVtYWluaW5nIGFuY2VzdG9ycy4KICAgICNbdGVzdF0KICAgIGZuIHJlYnVpbGRzX292ZXJsYXlfd2hlbl9hbmNob3JfY2hhbmdlcygpIHsKICAgICAgICBsZXQgb2xkX2FuY2hvciA9IEIyNTY6OndpdGhfbGFzdF9ieXRlKDEpOwogICAgICAgIGxldCBuZXdfYW5jaG9yID0gQjI1Njo6d2l0aF9sYXN0X2J5dGUoMik7CiAgICAgICAgbGV0IGtleSA9IEIyNTY6OndpdGhfbGFzdF9ieXRlKDQyKTsKICAgICAgICBsZXQgYWNjb3VudCA9IEFjY291bnQgeyBub25jZTogNTAsIGJhbGFuY2U6IFUyNTY6OlpFUk8sIGJ5dGVjb2RlX2hhc2g6IE5vbmUgfTsKCiAgICAgICAgLy8gQ3JlYXRlIHBhcmVudCB3aXRoIE9MRCBhbmNob3IKICAgICAgICBsZXQgcGFyZW50ID0gcmVhZHlfYmxvY2tfd2l0aF9zdGF0ZShvbGRfYW5jaG9yLCB2ZWMhWyhrZXksIFNvbWUoYWNjb3VudCkpXSk7CgogICAgICAgIC8vIENyZWF0ZSBjaGlsZCB3aXRoIE5FVyBhbmNob3IgKHNpbXVsYXRlcyBhZnRlciBwZXJzaXN0KQogICAgICAgIC8vIFNob3VsZCBOT1QgcmV1c2UgcGFyZW50J3Mgb3ZlcmxheSBiZWNhdXNlIGFuY2hvciBjaGFuZ2VkCiAgICAgICAgbGV0IGNoaWxkID0gRGVmZXJyZWRUcmllRGF0YTo6cGVuZGluZygKICAgICAgICAgICAgQXJjOjpuZXcoSGFzaGVkUG9zdFN0YXRlOjpkZWZhdWx0KCkpLAogICAgICAgICAgICBBcmM6Om5ldyhUcmllVXBkYXRlczo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgbmV3X2FuY2hvciwKICAgICAgICAgICAgdmVjIVtwYXJlbnRdLAogICAgICAgICk7CgogICAgICAgIGxldCByZXN1bHQgPSBjaGlsZC53YWl0X2Nsb25lZCgpOwoKICAgICAgICAvLyBWZXJpZnkgcmVzdWx0IHVzZXMgbmV3IGFuY2hvcgogICAgICAgIGxldCBvdmVybGF5ID0gcmVzdWx0LmFuY2hvcmVkX3RyaWVfaW5wdXQuYXNfcmVmKCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShvdmVybGF5LmFuY2hvcl9oYXNoLCBuZXdfYW5jaG9yKTsKCiAgICAgICAgLy8gQ3J1Y2lhbGx5LCBzaW5jZSB3ZSBwcm92aWRlZCBgcGFyZW50YCBpbiBhbmNlc3RvcnMgYnV0IGl0IGhhcyBhIGRpZmZlcmVudCBhbmNob3IsCiAgICAgICAgLy8gdGhlIGNvZGUgZmFsbHMgYmFjayB0byBgbWVyZ2VfYW5jZXN0b3JzX2ludG9fb3ZlcmxheWAuCiAgICAgICAgLy8gYG1lcmdlX2FuY2VzdG9yc19pbnRvX292ZXJsYXlgIHJlYWRzIGBwYXJlbnQuaGFzaGVkX3N0YXRlYCAod2hpY2ggaGFzIHRoZSBhY2NvdW50KS4KICAgICAgICAvLyBTbyB0aGUgYWNjb3VudCBJUyBwcmVzZW50LCBidXQgaXQgd2FzIG9idGFpbmVkIHZpYSBSRUJVSUxELCBub3QgUkVVU0UuCiAgICAgICAgLy8gV2UgY2FuIGNoZWNrIGBERUZFUlJFRF9UUklFX01FVFJJQ1NgIGlmIHdlIHdhbnQgdG8gYmUgc3VyZSwgYnV0IGZ1bmN0aW9uYWxseToKICAgICAgICBhc3NlcnRfZXEhKG92ZXJsYXkudHJpZV9pbnB1dC5zdGF0ZS5hY2NvdW50cy5sZW4oKSwgMSk7CiAgICAgICAgbGV0IChmb3VuZF9rZXksIGZvdW5kX2FjY291bnQpID0gJm92ZXJsYXkudHJpZV9pbnB1dC5zdGF0ZS5hY2NvdW50c1swXTsKICAgICAgICBhc3NlcnRfZXEhKCpmb3VuZF9rZXksIGtleSk7CiAgICAgICAgYXNzZXJ0X2VxIShmb3VuZF9hY2NvdW50LnVud3JhcCgpLm5vbmNlLCA1MCk7CiAgICB9CgogICAgLy8vIFZlcmlmaWVzIHRoYXQgcGFyZW50IHdpdGhvdXQgYGFuY2hvcmVkX3RyaWVfaW5wdXRgIHRyaWdnZXJzIHJlYnVpbGQgcGF0aC4KICAgICNbdGVzdF0KICAgIGZuIHJlYnVpbGRzX3doZW5fcGFyZW50X2hhc19ub19hbmNob3JlZF9pbnB1dCgpIHsKICAgICAgICBsZXQgYW5jaG9yID0gQjI1Njo6d2l0aF9sYXN0X2J5dGUoMSk7CiAgICAgICAgbGV0IGtleSA9IEIyNTY6OndpdGhfbGFzdF9ieXRlKDQyKTsKICAgICAgICBsZXQgYWNjb3VudCA9IEFjY291bnQgeyBub25jZTogMjUsIGJhbGFuY2U6IFUyNTY6OlpFUk8sIGJ5dGVjb2RlX2hhc2g6IE5vbmUgfTsKCiAgICAgICAgLy8gQ3JlYXRlIHBhcmVudCBXSVRIT1VUIGFuY2hvcmVkIHRyaWUgaW5wdXQgKGUuZy4sIGZyb20gd2l0aG91dF90cmllX2lucHV0IGNvbnN0cnVjdG9yKQogICAgICAgIGxldCBwYXJlbnRfc3RhdGUgPQogICAgICAgICAgICBIYXNoZWRQb3N0U3RhdGVTb3J0ZWQ6Om5ldyh2ZWMhWyhrZXksIFNvbWUoYWNjb3VudCkpXSwgQjI1Nk1hcDo6ZGVmYXVsdCgpKTsKICAgICAgICBsZXQgcGFyZW50ID0gRGVmZXJyZWRUcmllRGF0YTo6cmVhZHkoQ29tcHV0ZWRUcmllRGF0YSB7CiAgICAgICAgICAgIGhhc2hlZF9zdGF0ZTogQXJjOjpuZXcocGFyZW50X3N0YXRlKSwKICAgICAgICAgICAgdHJpZV91cGRhdGVzOiBBcmM6OmRlZmF1bHQoKSwKICAgICAgICAgICAgYW5jaG9yZWRfdHJpZV9pbnB1dDogTm9uZSwgLy8gTm8gYW5jaG9yZWQgaW5wdXQKICAgICAgICB9KTsKCiAgICAgICAgLy8gQ3JlYXRlIGNoaWxkIC0gc2hvdWxkIHJlYnVpbGQgZnJvbSBwYXJlbnQncyBoYXNoZWRfc3RhdGUKICAgICAgICBsZXQgY2hpbGQgPSBEZWZlcnJlZFRyaWVEYXRhOjpwZW5kaW5nKAogICAgICAgICAgICBBcmM6Om5ldyhIYXNoZWRQb3N0U3RhdGU6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIEFyYzo6bmV3KFRyaWVVcGRhdGVzOjpkZWZhdWx0KCkpLAogICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgIHZlYyFbcGFyZW50XSwKICAgICAgICApOwoKICAgICAgICBsZXQgcmVzdWx0ID0gY2hpbGQud2FpdF9jbG9uZWQoKTsKCiAgICAgICAgLy8gVmVyaWZ5IG92ZXJsYXkgaXMgYnVpbHQgYW5kIGNvbnRhaW5zIHBhcmVudCdzIGRhdGEKICAgICAgICBsZXQgb3ZlcmxheSA9IHJlc3VsdC5hbmNob3JlZF90cmllX2lucHV0LmFzX3JlZigpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEob3ZlcmxheS5hbmNob3JfaGFzaCwgYW5jaG9yKTsKICAgICAgICBhc3NlcnRfZXEhKG92ZXJsYXkudHJpZV9pbnB1dC5zdGF0ZS5hY2NvdW50cy5sZW4oKSwgMSk7CiAgICB9CgogICAgLy8vIFZlcmlmaWVzIHRoYXQgYSBjaGFpbiBvZiBibG9ja3Mgd2l0aCBtYXRjaGluZyBhbmNob3JzIGJ1aWxkcyBjb3JyZWN0IGN1bXVsYXRpdmUgb3ZlcmxheS4KICAgICNbdGVzdF0KICAgIGZuIGNoYWluX29mX2Jsb2Nrc19idWlsZHNfY3VtdWxhdGl2ZV9vdmVybGF5KCkgewogICAgICAgIGxldCBhbmNob3IgPSBCMjU2Ojp3aXRoX2xhc3RfYnl0ZSgxKTsKICAgICAgICBsZXQga2V5MSA9IEIyNTY6OndpdGhfbGFzdF9ieXRlKDEpOwogICAgICAgIGxldCBrZXkyID0gQjI1Njo6d2l0aF9sYXN0X2J5dGUoMik7CiAgICAgICAgbGV0IGtleTMgPSBCMjU2Ojp3aXRoX2xhc3RfYnl0ZSgzKTsKCiAgICAgICAgLy8gQmxvY2sgMTogc2V0cyBhY2NvdW50IGF0IGtleTEKICAgICAgICBsZXQgYmxvY2sxID0gcmVhZHlfYmxvY2tfd2l0aF9zdGF0ZSgKICAgICAgICAgICAgYW5jaG9yLAogICAgICAgICAgICB2ZWMhWyhrZXkxLCBTb21lKEFjY291bnQgeyBub25jZTogMSwgYmFsYW5jZTogVTI1Njo6WkVSTywgYnl0ZWNvZGVfaGFzaDogTm9uZSB9KSldLAogICAgICAgICk7CgogICAgICAgIC8vIEJsb2NrIDI6IGFkZHMgYWNjb3VudCBhdCBrZXkyLCBhbmNlc3RvciBpcyBibG9jazEKICAgICAgICBsZXQgYmxvY2syX2hhc2hlZCA9IEhhc2hlZFBvc3RTdGF0ZTo6ZGVmYXVsdCgpLndpdGhfYWNjb3VudHMoWygKICAgICAgICAgICAga2V5MiwKICAgICAgICAgICAgU29tZShBY2NvdW50IHsgbm9uY2U6IDIsIGJhbGFuY2U6IFUyNTY6OlpFUk8sIGJ5dGVjb2RlX2hhc2g6IE5vbmUgfSksCiAgICAgICAgKV0pOwogICAgICAgIGxldCBibG9jazIgPSBEZWZlcnJlZFRyaWVEYXRhOjpwZW5kaW5nKAogICAgICAgICAgICBBcmM6Om5ldyhibG9jazJfaGFzaGVkKSwKICAgICAgICAgICAgQXJjOjpuZXcoVHJpZVVwZGF0ZXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIGFuY2hvciwKICAgICAgICAgICAgdmVjIVtibG9jazEuY2xvbmUoKV0sCiAgICAgICAgKTsKICAgICAgICAvLyBDb21wdXRlIGJsb2NrMidzIHRyaWUgZGF0YQogICAgICAgIGxldCBibG9jazJfY29tcHV0ZWQgPSBibG9jazIud2FpdF9jbG9uZWQoKTsKICAgICAgICBsZXQgYmxvY2syX3JlYWR5ID0gRGVmZXJyZWRUcmllRGF0YTo6cmVhZHkoYmxvY2syX2NvbXB1dGVkKTsKCiAgICAgICAgLy8gQmxvY2sgMzogYWRkcyBhY2NvdW50IGF0IGtleTMsIGFuY2VzdG9yIGlzIGJsb2NrMiAod2hpY2ggaW5jbHVkZXMgYmxvY2sxKQogICAgICAgIGxldCBibG9jazNfaGFzaGVkID0gSGFzaGVkUG9zdFN0YXRlOjpkZWZhdWx0KCkud2l0aF9hY2NvdW50cyhbKAogICAgICAgICAgICBrZXkzLAogICAgICAgICAgICBTb21lKEFjY291bnQgeyBub25jZTogMywgYmFsYW5jZTogVTI1Njo6WkVSTywgYnl0ZWNvZGVfaGFzaDogTm9uZSB9KSwKICAgICAgICApXSk7CiAgICAgICAgbGV0IGJsb2NrMyA9IERlZmVycmVkVHJpZURhdGE6OnBlbmRpbmcoCiAgICAgICAgICAgIEFyYzo6bmV3KGJsb2NrM19oYXNoZWQpLAogICAgICAgICAgICBBcmM6Om5ldyhUcmllVXBkYXRlczo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgYW5jaG9yLAogICAgICAgICAgICB2ZWMhW2Jsb2NrMSwgYmxvY2syX3JlYWR5XSwKICAgICAgICApOwoKICAgICAgICBsZXQgcmVzdWx0ID0gYmxvY2szLndhaXRfY2xvbmVkKCk7CgogICAgICAgIC8vIFZlcmlmeSBhbGwgdGhyZWUgYWNjb3VudHMgYXJlIGluIHRoZSBjdW11bGF0aXZlIG92ZXJsYXkKICAgICAgICBsZXQgb3ZlcmxheSA9IHJlc3VsdC5hbmNob3JlZF90cmllX2lucHV0LmFzX3JlZigpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEob3ZlcmxheS50cmllX2lucHV0LnN0YXRlLmFjY291bnRzLmxlbigpLCAzKTsKCiAgICAgICAgLy8gQWNjb3VudHMgc2hvdWxkIGJlIHNvcnRlZCBieSBrZXkgKEIyNTYgb3JkZXJpbmcpCiAgICAgICAgbGV0IGFjY291bnRzID0gJm92ZXJsYXkudHJpZV9pbnB1dC5zdGF0ZS5hY2NvdW50czsKICAgICAgICBhc3NlcnQhKGFjY291bnRzLml0ZXIoKS5hbnkofChrLCBhKXwgKmsgPT0ga2V5MSAmJiBhLnVud3JhcCgpLm5vbmNlID09IDEpKTsKICAgICAgICBhc3NlcnQhKGFjY291bnRzLml0ZXIoKS5hbnkofChrLCBhKXwgKmsgPT0ga2V5MiAmJiBhLnVud3JhcCgpLm5vbmNlID09IDIpKTsKICAgICAgICBhc3NlcnQhKGFjY291bnRzLml0ZXIoKS5hbnkofChrLCBhKXwgKmsgPT0ga2V5MyAmJiBhLnVud3JhcCgpLm5vbmNlID09IDMpKTsKICAgIH0KCiAgICAvLy8gVmVyaWZpZXMgdGhhdCBjaGlsZCBibG9jaydzIHN0YXRlIG92ZXJ3cml0ZXMgcGFyZW50J3Mgc3RhdGUgZm9yIHRoZSBzYW1lIGtleS4KICAgICNbdGVzdF0KICAgIGZuIGNoaWxkX3N0YXRlX292ZXJ3cml0ZXNfcGFyZW50KCkgewogICAgICAgIGxldCBhbmNob3IgPSBCMjU2Ojp3aXRoX2xhc3RfYnl0ZSgxKTsKICAgICAgICBsZXQga2V5ID0gQjI1Njo6d2l0aF9sYXN0X2J5dGUoNDIpOwoKICAgICAgICAvLyBQYXJlbnQgc2V0cyBub25jZSB0byAxMAogICAgICAgIGxldCBwYXJlbnQgPSByZWFkeV9ibG9ja193aXRoX3N0YXRlKAogICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgIHZlYyFbKGtleSwgU29tZShBY2NvdW50IHsgbm9uY2U6IDEwLCBiYWxhbmNlOiBVMjU2OjpaRVJPLCBieXRlY29kZV9oYXNoOiBOb25lIH0pKV0sCiAgICAgICAgKTsKCiAgICAgICAgLy8gQ2hpbGQgb3ZlcndyaXRlcyBub25jZSB0byA5OQogICAgICAgIGxldCBjaGlsZF9oYXNoZWQgPSBIYXNoZWRQb3N0U3RhdGU6OmRlZmF1bHQoKS53aXRoX2FjY291bnRzKFsoCiAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgU29tZShBY2NvdW50IHsgbm9uY2U6IDk5LCBiYWxhbmNlOiBVMjU2OjpaRVJPLCBieXRlY29kZV9oYXNoOiBOb25lIH0pLAogICAgICAgICldKTsKICAgICAgICBsZXQgY2hpbGQgPSBEZWZlcnJlZFRyaWVEYXRhOjpwZW5kaW5nKAogICAgICAgICAgICBBcmM6Om5ldyhjaGlsZF9oYXNoZWQpLAogICAgICAgICAgICBBcmM6Om5ldyhUcmllVXBkYXRlczo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgYW5jaG9yLAogICAgICAgICAgICB2ZWMhW3BhcmVudF0sCiAgICAgICAgKTsKCiAgICAgICAgbGV0IHJlc3VsdCA9IGNoaWxkLndhaXRfY2xvbmVkKCk7CgogICAgICAgIC8vIFZlcmlmeSBjaGlsZCdzIHZhbHVlIHdpbnMgKGV4dGVuZF9yZWYgdXNlcyBsYXRlciB2YWx1ZSkKICAgICAgICBsZXQgb3ZlcmxheSA9IHJlc3VsdC5hbmNob3JlZF90cmllX2lucHV0LmFzX3JlZigpLnVud3JhcCgpOwogICAgICAgIC8vIE5vdGU6IGV4dGVuZF9yZWYgbWF5IHJlc3VsdCBpbiBkdXBsaWNhdGUga2V5czsgY2hlY2sgdGhlIGxhc3Qgb2NjdXJyZW5jZQogICAgICAgIGxldCBhY2NvdW50cyA9ICZvdmVybGF5LnRyaWVfaW5wdXQuc3RhdGUuYWNjb3VudHM7CiAgICAgICAgbGV0IGxhc3RfYWNjb3VudCA9IGFjY291bnRzLml0ZXIoKS5yZmluZCh8KGssIF8pfCAqayA9PSBrZXkpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEobGFzdF9hY2NvdW50LjEudW53cmFwKCkubm9uY2UsIDk5KTsKICAgIH0KCiAgICAvLy8gU3RyZXNzIHRlc3Q6IHZlcmlmeSBPKE4pIGJlaGF2aW9yIGJ5IGJ1aWxkaW5nIGEgY2hhaW4gb2YgbWFueSBibG9ja3MuCiAgICAvLy8gVGhpcyB0ZXN0IGVuc3VyZXMgdGhlIGZpeCBkb2Vzbid0IHJlZ3Jlc3MgLSBwcmV2aW91c2x5IHRoaXMgd291bGQgYmUgTyhOwrIpLgogICAgI1t0ZXN0XQogICAgZm4gbG9uZ19jaGFpbl9idWlsZHNfaW5fbGluZWFyX3RpbWUoKSB7CiAgICAgICAgbGV0IGFuY2hvciA9IEIyNTY6OndpdGhfbGFzdF9ieXRlKDEpOwogICAgICAgIGxldCBudW1fYmxvY2tzID0gNTA7IC8vIEVub3VnaCB0byBub3RpY2UgTyhOwrIpIHZzIE8oTikgZGlmZmVyZW5jZQoKICAgICAgICBsZXQgbXV0IGFuY2VzdG9yczogVmVjPERlZmVycmVkVHJpZURhdGE+ID0gVmVjOjpuZXcoKTsKCiAgICAgICAgbGV0IHN0YXJ0ID0gSW5zdGFudDo6bm93KCk7CgogICAgICAgIGZvciBpIGluIDAuLm51bV9ibG9ja3MgewogICAgICAgICAgICBsZXQga2V5ID0gQjI1Njo6d2l0aF9sYXN0X2J5dGUoaSBhcyB1OCk7CiAgICAgICAgICAgIGxldCBhY2NvdW50ID0gQWNjb3VudCB7IG5vbmNlOiBpIGFzIHU2NCwgYmFsYW5jZTogVTI1Njo6WkVSTywgYnl0ZWNvZGVfaGFzaDogTm9uZSB9OwogICAgICAgICAgICBsZXQgaGFzaGVkID0gSGFzaGVkUG9zdFN0YXRlOjpkZWZhdWx0KCkud2l0aF9hY2NvdW50cyhbKGtleSwgU29tZShhY2NvdW50KSldKTsKCiAgICAgICAgICAgIGxldCBibG9jayA9IERlZmVycmVkVHJpZURhdGE6OnBlbmRpbmcoCiAgICAgICAgICAgICAgICBBcmM6Om5ldyhoYXNoZWQpLAogICAgICAgICAgICAgICAgQXJjOjpuZXcoVHJpZVVwZGF0ZXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgICAgICBhbmNlc3RvcnMuY2xvbmUoKSwKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIC8vIENvbXB1dGUgYW5kIGFkZCB0byBhbmNlc3RvcnMgZm9yIG5leHQgaXRlcmF0aW9uCiAgICAgICAgICAgIGxldCBjb21wdXRlZCA9IGJsb2NrLndhaXRfY2xvbmVkKCk7CiAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKERlZmVycmVkVHJpZURhdGE6OnJlYWR5KGNvbXB1dGVkKSk7CiAgICAgICAgfQoKICAgICAgICBsZXQgZWxhcHNlZCA9IHN0YXJ0LmVsYXBzZWQoKTsKCiAgICAgICAgLy8gV2l0aCBPKE4pIGZpeCwgNTAgYmxvY2tzIHNob3VsZCBjb21wbGV0ZSBxdWlja2x5ICg8IDEgc2Vjb25kKQogICAgICAgIC8vIFdpdGggTyhOwrIpLCB0aGlzIHdvdWxkIHRha2Ugc2lnbmlmaWNhbnRseSBsb25nZXIKICAgICAgICBhc3NlcnQhKAogICAgICAgICAgICBlbGFwc2VkIDwgRHVyYXRpb246OmZyb21fc2VjcygyKSwKICAgICAgICAgICAgIkNoYWluIG9mIHtudW1fYmxvY2tzfSBibG9ja3MgdG9vayB7Oj99LCBwb3NzaWJsZSBPKE7CsikgcmVncmVzc2lvbiIsCiAgICAgICAgICAgIGVsYXBzZWQKICAgICAgICApOwoKICAgICAgICAvLyBWZXJpZnkgZmluYWwgb3ZlcmxheSBoYXMgYWxsIGFjY291bnRzCiAgICAgICAgbGV0IGZpbmFsX3Jlc3VsdCA9IGFuY2VzdG9ycy5sYXN0KCkudW53cmFwKCkud2FpdF9jbG9uZWQoKTsKICAgICAgICBsZXQgb3ZlcmxheSA9IGZpbmFsX3Jlc3VsdC5hbmNob3JlZF90cmllX2lucHV0LmFzX3JlZigpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEob3ZlcmxheS50cmllX2lucHV0LnN0YXRlLmFjY291bnRzLmxlbigpLCBudW1fYmxvY2tzKTsKICAgIH0KCiAgICAvLy8gVmVyaWZpZXMgdGhhdCBhIG11bHRpLWFuY2VzdG9yIG92ZXJsYXkgaXMgcmVidWlsdCB3aGVuIGFuY2hvciBjaGFuZ2VzLgogICAgLy8vIFRoaXMgc2ltdWxhdGVzIHRoZSAicGVyc2lzdCBwcmVmaXggdGhlbiBrZWVwIGJ1aWxkaW5nIiBzY2VuYXJpbyB3aGVyZToKICAgIC8vLyAxLiBBIGNoYWluIG9mIGJsb2NrcyBpcyBidWlsdCB3aXRoIGFuY2hvciBBCiAgICAvLy8gMi4gU29tZSBibG9ja3MgYXJlIHBlcnNpc3RlZCwgY2hhbmdpbmcgYW5jaG9yIHRvIEIKICAgIC8vLyAzLiBOZXcgYmxvY2tzIG11c3QgcmVidWlsZCB0aGUgb3ZlcmxheSBmcm9tIHRoZSByZW1haW5pbmcgYW5jZXN0b3JzCiAgICAjW3Rlc3RdCiAgICBmbiBtdWx0aV9hbmNlc3Rvcl9vdmVybGF5X3JlYnVpbHRfYWZ0ZXJfYW5jaG9yX2NoYW5nZSgpIHsKICAgICAgICBsZXQgb2xkX2FuY2hvciA9IEIyNTY6OndpdGhfbGFzdF9ieXRlKDEpOwogICAgICAgIGxldCBuZXdfYW5jaG9yID0gQjI1Njo6d2l0aF9sYXN0X2J5dGUoMik7CiAgICAgICAgbGV0IGtleTEgPSBCMjU2Ojp3aXRoX2xhc3RfYnl0ZSgxKTsKICAgICAgICBsZXQga2V5MiA9IEIyNTY6OndpdGhfbGFzdF9ieXRlKDIpOwogICAgICAgIGxldCBrZXkzID0gQjI1Njo6d2l0aF9sYXN0X2J5dGUoMyk7CiAgICAgICAgbGV0IGtleTQgPSBCMjU2Ojp3aXRoX2xhc3RfYnl0ZSg0KTsKCiAgICAgICAgLy8gQnVpbGQgYSBjaGFpbiBvZiAzIGJsb2NrcyB3aXRoIG9sZF9hbmNob3IKICAgICAgICBsZXQgYmxvY2sxID0gcmVhZHlfYmxvY2tfd2l0aF9zdGF0ZSgKICAgICAgICAgICAgb2xkX2FuY2hvciwKICAgICAgICAgICAgdmVjIVsoa2V5MSwgU29tZShBY2NvdW50IHsgbm9uY2U6IDEsIGJhbGFuY2U6IFUyNTY6OlpFUk8sIGJ5dGVjb2RlX2hhc2g6IE5vbmUgfSkpXSwKICAgICAgICApOwoKICAgICAgICBsZXQgYmxvY2syX2hhc2hlZCA9IEhhc2hlZFBvc3RTdGF0ZTo6ZGVmYXVsdCgpLndpdGhfYWNjb3VudHMoWygKICAgICAgICAgICAga2V5MiwKICAgICAgICAgICAgU29tZShBY2NvdW50IHsgbm9uY2U6IDIsIGJhbGFuY2U6IFUyNTY6OlpFUk8sIGJ5dGVjb2RlX2hhc2g6IE5vbmUgfSksCiAgICAgICAgKV0pOwogICAgICAgIGxldCBibG9jazIgPSBEZWZlcnJlZFRyaWVEYXRhOjpwZW5kaW5nKAogICAgICAgICAgICBBcmM6Om5ldyhibG9jazJfaGFzaGVkKSwKICAgICAgICAgICAgQXJjOjpuZXcoVHJpZVVwZGF0ZXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIG9sZF9hbmNob3IsCiAgICAgICAgICAgIHZlYyFbYmxvY2sxLmNsb25lKCldLAogICAgICAgICk7CiAgICAgICAgbGV0IGJsb2NrMl9yZWFkeSA9IERlZmVycmVkVHJpZURhdGE6OnJlYWR5KGJsb2NrMi53YWl0X2Nsb25lZCgpKTsKCiAgICAgICAgbGV0IGJsb2NrM19oYXNoZWQgPSBIYXNoZWRQb3N0U3RhdGU6OmRlZmF1bHQoKS53aXRoX2FjY291bnRzKFsoCiAgICAgICAgICAgIGtleTMsCiAgICAgICAgICAgIFNvbWUoQWNjb3VudCB7IG5vbmNlOiAzLCBiYWxhbmNlOiBVMjU2OjpaRVJPLCBieXRlY29kZV9oYXNoOiBOb25lIH0pLAogICAgICAgICldKTsKICAgICAgICBsZXQgYmxvY2szID0gRGVmZXJyZWRUcmllRGF0YTo6cGVuZGluZygKICAgICAgICAgICAgQXJjOjpuZXcoYmxvY2szX2hhc2hlZCksCiAgICAgICAgICAgIEFyYzo6bmV3KFRyaWVVcGRhdGVzOjpkZWZhdWx0KCkpLAogICAgICAgICAgICBvbGRfYW5jaG9yLAogICAgICAgICAgICB2ZWMhW2Jsb2NrMS5jbG9uZSgpLCBibG9jazJfcmVhZHkuY2xvbmUoKV0sCiAgICAgICAgKTsKICAgICAgICBsZXQgYmxvY2szX3JlYWR5ID0gRGVmZXJyZWRUcmllRGF0YTo6cmVhZHkoYmxvY2szLndhaXRfY2xvbmVkKCkpOwoKICAgICAgICAvLyBWZXJpZnkgYmxvY2szJ3Mgb3ZlcmxheSBoYXMgYWxsIDMgYWNjb3VudHMgd2l0aCBvbGRfYW5jaG9yCiAgICAgICAgbGV0IGJsb2NrM19vdmVybGF5ID0gYmxvY2szX3JlYWR5LndhaXRfY2xvbmVkKCkuYW5jaG9yZWRfdHJpZV9pbnB1dC51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKGJsb2NrM19vdmVybGF5LmFuY2hvcl9oYXNoLCBvbGRfYW5jaG9yKTsKICAgICAgICBhc3NlcnRfZXEhKGJsb2NrM19vdmVybGF5LnRyaWVfaW5wdXQuc3RhdGUuYWNjb3VudHMubGVuKCksIDMpOwoKICAgICAgICAvLyBOb3cgc2ltdWxhdGUgcGVyc2lzdDogY3JlYXRlIGJsb2NrNCB3aXRoIE5FVyBhbmNob3IgYnV0IHNhbWUgYW5jZXN0b3JzLgogICAgICAgIC8vIFRvIHZlcmlmeSBjb3JyZWN0IHJlYnVpbGRpbmcsIHdlIG11c3QgcHJvdmlkZSBBTEwgdW5wZXJzaXN0ZWQgYW5jZXN0b3JzLgogICAgICAgIC8vIElmIHdlIG9ubHkgcHJvdmlkZWQgYmxvY2szLCB0aGUgcmVidWlsZCB3b3VsZCBvbmx5IHNlZSBibG9jazMncyBzdGF0ZS4KICAgICAgICAvLyBXZSBwYXNzIGJsb2NrMSwgYmxvY2syLCBibG9jazMgdG8gc2ltdWxhdGUgdGhhdCB0aGV5IGFyZSBhbGwgc3RpbGwgaW4gbWVtb3J5CiAgICAgICAgLy8gYnV0IHRoZSBhbmNob3IgY2hlY2sgZm9yY2VzIGEgcmVidWlsZCAoZS5nLiBhcnRpZmljaWFsIGFuY2hvciBjaGFuZ2UpLgogICAgICAgIGxldCBibG9jazRfaGFzaGVkID0gSGFzaGVkUG9zdFN0YXRlOjpkZWZhdWx0KCkud2l0aF9hY2NvdW50cyhbKAogICAgICAgICAgICBrZXk0LAogICAgICAgICAgICBTb21lKEFjY291bnQgeyBub25jZTogNCwgYmFsYW5jZTogVTI1Njo6WkVSTywgYnl0ZWNvZGVfaGFzaDogTm9uZSB9KSwKICAgICAgICApXSk7CiAgICAgICAgbGV0IGJsb2NrNCA9IERlZmVycmVkVHJpZURhdGE6OnBlbmRpbmcoCiAgICAgICAgICAgIEFyYzo6bmV3KGJsb2NrNF9oYXNoZWQpLAogICAgICAgICAgICBBcmM6Om5ldyhUcmllVXBkYXRlczo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgbmV3X2FuY2hvciwgLy8gRGlmZmVyZW50IGFuY2hvciAtIHNpbXVsYXRlcyBwb3N0LXBlcnNpc3QKICAgICAgICAgICAgdmVjIVtibG9jazEsIGJsb2NrMl9yZWFkeSwgYmxvY2szX3JlYWR5XSwKICAgICAgICApOwoKICAgICAgICBsZXQgcmVzdWx0ID0gYmxvY2s0LndhaXRfY2xvbmVkKCk7CgogICAgICAgIC8vIFZlcmlmeToKICAgICAgICAvLyAxLiBOZXcgYW5jaG9yIGlzIHVzZWQgaW4gcmVzdWx0CiAgICAgICAgYXNzZXJ0X2VxIShyZXN1bHQuYW5jaG9yX2hhc2goKSwgU29tZShuZXdfYW5jaG9yKSk7CgogICAgICAgIC8vIDIuIEFsbCA0IGFjY291bnRzIGFyZSBpbiB0aGUgb3ZlcmxheSAocmVidWlsdCBmcm9tIGFuY2VzdG9ycyArIGV4dGVuZGVkKQogICAgICAgIGxldCBvdmVybGF5ID0gcmVzdWx0LmFuY2hvcmVkX3RyaWVfaW5wdXQuYXNfcmVmKCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShvdmVybGF5LnRyaWVfaW5wdXQuc3RhdGUuYWNjb3VudHMubGVuKCksIDQpOwoKICAgICAgICAvLyAzLiBBbGwgYWNjb3VudHMgaGF2ZSBjb3JyZWN0IHZhbHVlcwogICAgICAgIGxldCBhY2NvdW50cyA9ICZvdmVybGF5LnRyaWVfaW5wdXQuc3RhdGUuYWNjb3VudHM7CiAgICAgICAgYXNzZXJ0IShhY2NvdW50cy5pdGVyKCkuYW55KHwoaywgYSl8ICprID09IGtleTEgJiYgYS51bndyYXAoKS5ub25jZSA9PSAxKSk7CiAgICAgICAgYXNzZXJ0IShhY2NvdW50cy5pdGVyKCkuYW55KHwoaywgYSl8ICprID09IGtleTIgJiYgYS51bndyYXAoKS5ub25jZSA9PSAyKSk7CiAgICAgICAgYXNzZXJ0IShhY2NvdW50cy5pdGVyKCkuYW55KHwoaywgYSl8ICprID09IGtleTMgJiYgYS51bndyYXAoKS5ub25jZSA9PSAzKSk7CiAgICAgICAgYXNzZXJ0IShhY2NvdW50cy5pdGVyKCkuYW55KHwoaywgYSl8ICprID09IGtleTQgJiYgYS51bndyYXAoKS5ub25jZSA9PSA0KSk7CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL2NoYWluLXN0YXRlL3NyYy9saWIucnMiPgovLyEgUmV0aCBzdGF0ZSByZWxhdGVkIHR5cGVzIGFuZCBmdW5jdGlvbmFsaXR5LgoKIyFbZG9jKAogICAgaHRtbF9sb2dvX3VybCA9ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vcGFyYWRpZ214eXovcmV0aC9tYWluL2Fzc2V0cy9yZXRoLWRvY3MucG5nIiwKICAgIGh0bWxfZmF2aWNvbl91cmwgPSAiaHR0cHM6Ly9hdmF0YXJzMC5naXRodWJ1c2VyY29udGVudC5jb20vdS85NzM2OTQ2Nj9zPTI1NiIsCiAgICBpc3N1ZV90cmFja2VyX2Jhc2VfdXJsID0gImh0dHBzOi8vZ2l0aHViLmNvbS9wYXJhZGlnbXh5ei9yZXRoL2lzc3Vlcy8iCildCiMhW2NmZ19hdHRyKG5vdCh0ZXN0KSwgd2Fybih1bnVzZWRfY3JhdGVfZGVwZW5kZW5jaWVzKSldCiMhW2NmZ19hdHRyKGRvY3NycywgZmVhdHVyZShkb2NfY2ZnKSldCgptb2QgaW5fbWVtb3J5OwpwdWIgdXNlIGluX21lbW9yeTo6KjsKCm1vZCBkZWZlcnJlZF90cmllOwpwdWIgdXNlIGRlZmVycmVkX3RyaWU6Oio7Cgptb2Qgbm9vcDsKCm1vZCBjaGFpbl9pbmZvOwpwdWIgdXNlIGNoYWluX2luZm86OkNoYWluSW5mb1RyYWNrZXI7Cgptb2Qgbm90aWZpY2F0aW9uczsKcHViIHVzZSBub3RpZmljYXRpb25zOjp7CiAgICBDYW5vblN0YXRlTm90aWZpY2F0aW9uLCBDYW5vblN0YXRlTm90aWZpY2F0aW9uU2VuZGVyLCBDYW5vblN0YXRlTm90aWZpY2F0aW9uU3RyZWFtLAogICAgQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbnMsIENhbm9uU3RhdGVTdWJzY3JpcHRpb25zLCBGb3JrQ2hvaWNlTm90aWZpY2F0aW9ucywgRm9ya0Nob2ljZVN0cmVhbSwKICAgIEZvcmtDaG9pY2VTdWJzY3JpcHRpb25zLCBQZXJzaXN0ZWRCbG9ja05vdGlmaWNhdGlvbnMsIFBlcnNpc3RlZEJsb2NrU3Vic2NyaXB0aW9ucywKICAgIFdhdGNoVmFsdWVTdHJlYW0sCn07Cgptb2QgbWVtb3J5X292ZXJsYXk7CnB1YiB1c2UgbWVtb3J5X292ZXJsYXk6OntNZW1vcnlPdmVybGF5U3RhdGVQcm92aWRlciwgTWVtb3J5T3ZlcmxheVN0YXRlUHJvdmlkZXJSZWZ9OwoKI1tjZmcoYW55KHRlc3QsIGZlYXR1cmUgPSAidGVzdC11dGlscyIpKV0KLy8vIENvbW1vbiB0ZXN0IGhlbHBlcnMKcHViIG1vZCB0ZXN0X3V0aWxzOwoKLy8gdG9kbzogcmVtb3ZlIHdoZW4gZ2VuZXJpYyBkYXRhIHByaW0gaW50ZWdyYXRpb24gY29tcGxldGUKcHViIHVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkV0aFByaW1pdGl2ZXM7CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9jaGFpbi1zdGF0ZS9zcmMvbm9vcC5ycyI+Ci8vISBOb29wIGltcGxzIGZvciB0ZXN0aW5nLgoKdXNlIGNyYXRlOjp7CiAgICBDYW5vblN0YXRlTm90aWZpY2F0aW9ucywgQ2Fub25TdGF0ZVN1YnNjcmlwdGlvbnMsIEZvcmtDaG9pY2VOb3RpZmljYXRpb25zLAogICAgRm9ya0Nob2ljZVN1YnNjcmlwdGlvbnMsIFBlcnNpc3RlZEJsb2NrTm90aWZpY2F0aW9ucywgUGVyc2lzdGVkQmxvY2tTdWJzY3JpcHRpb25zLAp9Owp1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6Tm9kZVByaW1pdGl2ZXM7CnVzZSByZXRoX3N0b3JhZ2VfYXBpOjpub29wOjpOb29wUHJvdmlkZXI7CnVzZSB0b2tpbzo6c3luYzo6e2Jyb2FkY2FzdCwgd2F0Y2h9OwoKaW1wbDxDOiBTZW5kICsgU3luYywgTjogTm9kZVByaW1pdGl2ZXM+IENhbm9uU3RhdGVTdWJzY3JpcHRpb25zIGZvciBOb29wUHJvdmlkZXI8QywgTj4gewogICAgZm4gc3Vic2NyaWJlX3RvX2Nhbm9uaWNhbF9zdGF0ZSgmc2VsZikgLT4gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbnM8Tj4gewogICAgICAgIGJyb2FkY2FzdDo6Y2hhbm5lbCgxKS4xCiAgICB9Cn0KCmltcGw8QzogU2VuZCArIFN5bmMsIE46IE5vZGVQcmltaXRpdmVzPiBGb3JrQ2hvaWNlU3Vic2NyaXB0aW9ucyBmb3IgTm9vcFByb3ZpZGVyPEMsIE4+IHsKICAgIHR5cGUgSGVhZGVyID0gTjo6QmxvY2tIZWFkZXI7CgogICAgZm4gc3Vic2NyaWJlX3NhZmVfYmxvY2soJnNlbGYpIC0+IEZvcmtDaG9pY2VOb3RpZmljYXRpb25zPE46OkJsb2NrSGVhZGVyPiB7CiAgICAgICAgbGV0IChfLCByeCkgPSB3YXRjaDo6Y2hhbm5lbChOb25lKTsKICAgICAgICBGb3JrQ2hvaWNlTm90aWZpY2F0aW9ucyhyeCkKICAgIH0KCiAgICBmbiBzdWJzY3JpYmVfZmluYWxpemVkX2Jsb2NrKCZzZWxmKSAtPiBGb3JrQ2hvaWNlTm90aWZpY2F0aW9uczxOOjpCbG9ja0hlYWRlcj4gewogICAgICAgIGxldCAoXywgcngpID0gd2F0Y2g6OmNoYW5uZWwoTm9uZSk7CiAgICAgICAgRm9ya0Nob2ljZU5vdGlmaWNhdGlvbnMocngpCiAgICB9Cn0KCmltcGw8QzogU2VuZCArIFN5bmMsIE46IE5vZGVQcmltaXRpdmVzPiBQZXJzaXN0ZWRCbG9ja1N1YnNjcmlwdGlvbnMgZm9yIE5vb3BQcm92aWRlcjxDLCBOPiB7CiAgICBmbiBzdWJzY3JpYmVfcGVyc2lzdGVkX2Jsb2NrKCZzZWxmKSAtPiBQZXJzaXN0ZWRCbG9ja05vdGlmaWNhdGlvbnMgewogICAgICAgIGxldCAoXywgcngpID0gd2F0Y2g6OmNoYW5uZWwoTm9uZSk7CiAgICAgICAgUGVyc2lzdGVkQmxvY2tOb3RpZmljYXRpb25zKHJ4KQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9uZXQvZG93bmxvYWRlcnMvc3JjL2JvZGllcy9ib2RpZXMucnMiPgp1c2Ugc3VwZXI6OnF1ZXVlOjpCb2RpZXNSZXF1ZXN0UXVldWU7CnVzZSBjcmF0ZTo6e2JvZGllczo6dGFzazo6VGFza0Rvd25sb2FkZXIsIG1ldHJpY3M6OkJvZHlEb3dubG9hZGVyTWV0cmljc307CnVzZSBhbGxveV9jb25zZW5zdXM6OkJsb2NrSGVhZGVyOwp1c2UgYWxsb3lfcHJpbWl0aXZlczo6QmxvY2tOdW1iZXI7CnVzZSBmdXR1cmVzOjpTdHJlYW07CnVzZSBmdXR1cmVzX3V0aWw6OlN0cmVhbUV4dDsKdXNlIHJldGhfY29uZmlnOjpCb2RpZXNDb25maWc7CnVzZSByZXRoX2NvbnNlbnN1czo6Q29uc2Vuc3VzOwp1c2UgcmV0aF9uZXR3b3JrX3AycDo6ewogICAgYm9kaWVzOjp7CiAgICAgICAgY2xpZW50OjpCb2RpZXNDbGllbnQsCiAgICAgICAgZG93bmxvYWRlcjo6e0JvZHlEb3dubG9hZGVyLCBCb2R5RG93bmxvYWRlclJlc3VsdH0sCiAgICAgICAgcmVzcG9uc2U6OkJsb2NrUmVzcG9uc2UsCiAgICB9LAogICAgZXJyb3I6OntEb3dubG9hZEVycm9yLCBEb3dubG9hZFJlc3VsdH0sCn07CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjp7c2l6ZTo6SW5NZW1vcnlTaXplLCBCbG9jaywgU2VhbGVkSGVhZGVyfTsKdXNlIHJldGhfc3RvcmFnZV9hcGk6OkhlYWRlclByb3ZpZGVyOwp1c2UgcmV0aF90YXNrczo6e1Rhc2tTcGF3bmVyLCBUb2tpb1Rhc2tFeGVjdXRvcn07CnVzZSBzdGQ6OnsKICAgIGNtcDo6T3JkZXJpbmcsCiAgICBjb2xsZWN0aW9uczo6QmluYXJ5SGVhcCwKICAgIGZtdDo6RGVidWcsCiAgICBvcHM6OlJhbmdlSW5jbHVzaXZlLAogICAgcGluOjpQaW4sCiAgICBzeW5jOjpBcmMsCiAgICB0YXNrOjp7Q29udGV4dCwgUG9sbH0sCn07CnVzZSB0cmFjaW5nOjppbmZvOwoKLy8vIERvd25sb2FkcyBib2RpZXMgaW4gYmF0Y2hlcy4KLy8vCi8vLyBBbGwgYmxvY2tzIGluIGEgYmF0Y2ggYXJlIGZldGNoZWQgYXQgdGhlIHNhbWUgdGltZS4KI1ttdXN0X3VzZSA9ICJTdHJlYW0gZG9lcyBub3RoaW5nIHVubGVzcyBwb2xsZWQiXQojW2Rlcml2ZShEZWJ1ZyldCnB1YiBzdHJ1Y3QgQm9kaWVzRG93bmxvYWRlcjwKICAgIEI6IEJsb2NrLAogICAgQzogQm9kaWVzQ2xpZW50PEJvZHkgPSBCOjpCb2R5PiwKICAgIFByb3ZpZGVyOiBIZWFkZXJQcm92aWRlcjxIZWFkZXIgPSBCOjpIZWFkZXI+LAo+IHsKICAgIC8vLyBUaGUgYm9kaWVzIGNsaWVudAogICAgY2xpZW50OiBBcmM8Qz4sCiAgICAvLy8gVGhlIGNvbnNlbnN1cyBjbGllbnQKICAgIGNvbnNlbnN1czogQXJjPGR5biBDb25zZW5zdXM8Qj4+LAogICAgLy8vIFRoZSBkYXRhYmFzZSBoYW5kbGUKICAgIHByb3ZpZGVyOiBQcm92aWRlciwKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2Ygbm9uLWVtcHR5IGJsb2NrcyBwZXIgb25lIHJlcXVlc3QKICAgIHJlcXVlc3RfbGltaXQ6IHU2NCwKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2YgYmxvY2sgYm9kaWVzIHJldHVybmVkIGF0IG9uY2UgZnJvbSB0aGUgc3RyZWFtCiAgICBzdHJlYW1fYmF0Y2hfc2l6ZTogdXNpemUsCiAgICAvLy8gVGhlIGFsbG93ZWQgcmFuZ2UgZm9yIG51bWJlciBvZiBjb25jdXJyZW50IHJlcXVlc3RzLgogICAgY29uY3VycmVudF9yZXF1ZXN0c19yYW5nZTogUmFuZ2VJbmNsdXNpdmU8dXNpemU+LAogICAgLy8vIE1heGltdW0gbnVtYmVyIG9mIGJ5dGVzIG9mIHJlY2VpdmVkIGJsb2NrcyB0byBidWZmZXIgaW50ZXJuYWxseS4KICAgIG1heF9idWZmZXJlZF9ibG9ja3Nfc2l6ZV9ieXRlczogdXNpemUsCiAgICAvLy8gQ3VycmVudCBlc3RpbWF0ZWQgc2l6ZSBvZiBidWZmZXJlZCBibG9ja3MgaW4gYnl0ZXMuCiAgICBidWZmZXJlZF9ibG9ja3Nfc2l6ZV9ieXRlczogdXNpemUsCiAgICAvLy8gVGhlIHJhbmdlIG9mIGJsb2NrIG51bWJlcnMgZm9yIGJvZHkgZG93bmxvYWQuCiAgICBkb3dubG9hZF9yYW5nZTogUmFuZ2VJbmNsdXNpdmU8QmxvY2tOdW1iZXI+LAogICAgLy8vIFRoZSBsYXRlc3QgYmxvY2sgbnVtYmVyIHJldHVybmVkLgogICAgbGF0ZXN0X3F1ZXVlZF9ibG9ja19udW1iZXI6IE9wdGlvbjxCbG9ja051bWJlcj4sCiAgICAvLy8gUmVxdWVzdHMgaW4gcHJvZ3Jlc3MKICAgIGluX3Byb2dyZXNzX3F1ZXVlOiBCb2RpZXNSZXF1ZXN0UXVldWU8QiwgQz4sCiAgICAvLy8gQnVmZmVyZWQgcmVzcG9uc2VzCiAgICBidWZmZXJlZF9yZXNwb25zZXM6IEJpbmFyeUhlYXA8T3JkZXJlZEJvZGllc1Jlc3BvbnNlPEI+PiwKICAgIC8vLyBRdWV1ZWQgYm9keSByZXNwb25zZXMgdGhhdCBjYW4gYmUgcmV0dXJuZWQgZm9yIGluc2VydGlvbiBpbnRvIHRoZSBkYXRhYmFzZS4KICAgIHF1ZXVlZF9ib2RpZXM6IFZlYzxCbG9ja1Jlc3BvbnNlPEI+PiwKICAgIC8vLyBUaGUgYm9kaWVzIGRvd25sb2FkZXIgbWV0cmljcy4KICAgIG1ldHJpY3M6IEJvZHlEb3dubG9hZGVyTWV0cmljcywKfQoKaW1wbDxCLCBDLCBQcm92aWRlcj4gQm9kaWVzRG93bmxvYWRlcjxCLCBDLCBQcm92aWRlcj4Kd2hlcmUKICAgIEI6IEJsb2NrLAogICAgQzogQm9kaWVzQ2xpZW50PEJvZHkgPSBCOjpCb2R5PiArICdzdGF0aWMsCiAgICBQcm92aWRlcjogSGVhZGVyUHJvdmlkZXI8SGVhZGVyID0gQjo6SGVhZGVyPiArIFVucGluICsgJ3N0YXRpYywKewogICAgLy8vIFJldHVybnMgdGhlIG5leHQgY29udGlndW91cyByZXF1ZXN0LgogICAgZm4gbmV4dF9oZWFkZXJzX3JlcXVlc3QoJnNlbGYpIC0+IERvd25sb2FkUmVzdWx0PE9wdGlvbjxWZWM8U2VhbGVkSGVhZGVyPFByb3ZpZGVyOjpIZWFkZXI+Pj4+IHsKICAgICAgICBsZXQgc3RhcnRfYXQgPSBtYXRjaCBzZWxmLmluX3Byb2dyZXNzX3F1ZXVlLmxhc3RfcmVxdWVzdGVkX2Jsb2NrX251bWJlciB7CiAgICAgICAgICAgIFNvbWUobnVtKSA9PiBudW0gKyAxLAogICAgICAgICAgICBOb25lID0+ICpzZWxmLmRvd25sb2FkX3JhbmdlLnN0YXJ0KCksCiAgICAgICAgfTsKICAgICAgICAvLyBhcyB0aGUgcmFuZ2UgaXMgaW5jbHVzaXZlLCB3ZSBuZWVkIHRvIGFkZCAxIHRvIHRoZSBlbmQuCiAgICAgICAgbGV0IGl0ZW1zX2xlZnQgPSAoc2VsZi5kb3dubG9hZF9yYW5nZS5lbmQoKSArIDEpLnNhdHVyYXRpbmdfc3ViKHN0YXJ0X2F0KTsKICAgICAgICBsZXQgbGltaXQgPSBpdGVtc19sZWZ0Lm1pbihzZWxmLnJlcXVlc3RfbGltaXQpOwogICAgICAgIHNlbGYucXVlcnlfaGVhZGVycyhzdGFydF9hdC4uPSpzZWxmLmRvd25sb2FkX3JhbmdlLmVuZCgpLCBsaW1pdCkKICAgIH0KCiAgICAvLy8gUmV0cmlldmUgYSBiYXRjaCBvZiBoZWFkZXJzIGZyb20gdGhlIGRhdGFiYXNlIHN0YXJ0aW5nIGZyb20gdGhlIHByb3ZpZGVkIGJsb2NrIG51bWJlci4KICAgIC8vLwogICAgLy8vIFRoaXMgbWV0aG9kIGlzIGdvaW5nIHRvIHJldHVybiB0aGUgYmF0Y2ggYXMgc29vbiBhcyBvbmUgb2YgdGhlIGNvbmRpdGlvbnMgYmVsb3cKICAgIC8vLyBpcyBmdWxmaWxsZWQ6CiAgICAvLy8gICAgIDEuIFRoZSBudW1iZXIgb2Ygbm9uLWVtcHR5IGhlYWRlcnMgaW4gdGhlIGJhdGNoIGVxdWFscyByZXF1ZXN0ZWQuCiAgICAvLy8gICAgIDIuIFRoZSB0b3RhbCBudW1iZXIgb2YgaGVhZGVycyBpbiB0aGUgYmF0Y2ggKGJvdGggZW1wdHkgYW5kIG5vbi1lbXB0eSkgaXMgZ3JlYXRlciB0aGFuCiAgICAvLy8gICAgICAgIG9yIGVxdWFsIHRvIHRoZSBzdHJlYW0gYmF0Y2ggc2l6ZS4KICAgIC8vLyAgICAgMy4gRG93bmxvYWRlciByZWFjaGVkIHRoZSBlbmQgb2YgdGhlIHJhbmdlCiAgICAvLy8KICAgIC8vLyBOT1RFOiBUaGUgYmF0Y2hlcyByZXR1cm5lZCBoYXZlIGEgdmFyaWFibGUgbGVuZ3RoLgogICAgZm4gcXVlcnlfaGVhZGVycygKICAgICAgICAmc2VsZiwKICAgICAgICByYW5nZTogUmFuZ2VJbmNsdXNpdmU8QmxvY2tOdW1iZXI+LAogICAgICAgIG1heF9ub25fZW1wdHk6IHU2NCwKICAgICkgLT4gRG93bmxvYWRSZXN1bHQ8T3B0aW9uPFZlYzxTZWFsZWRIZWFkZXI8Qjo6SGVhZGVyPj4+PiB7CiAgICAgICAgaWYgcmFuZ2UuaXNfZW1wdHkoKSB8fCBtYXhfbm9uX2VtcHR5ID09IDAgewogICAgICAgICAgICByZXR1cm4gT2soTm9uZSkKICAgICAgICB9CgogICAgICAgIC8vIENvbGxlY3QgaGVhZGVycyB3aGlsZQogICAgICAgIC8vICAgICAgMS4gQ3VycmVudCBibG9jayBudW1iZXIgaXMgaW4gcmFuZ2UKICAgICAgICAvLyAgICAgIDIuIFRoZSBudW1iZXIgb2Ygbm9uIGVtcHR5IGhlYWRlcnMgaXMgbGVzcyB0aGFuIG1heGltdW0KICAgICAgICAvLyAgICAgIDMuIFRoZSB0b3RhbCBudW1iZXIgb2YgaGVhZGVycyBpcyBsZXNzIHRoYW4gdGhlIHN0cmVhbSBiYXRjaCBzaXplICh0aGlzIGlzIG9ubHkKICAgICAgICAvLyAgICAgICAgIHJlbGV2YW50IGlmIHRoZSByYW5nZSBjb25zaXN0cyBlbnRpcmVseSBvZiBlbXB0eSBoZWFkZXJzKQogICAgICAgIGxldCBtdXQgY29sbGVjdGVkID0gMDsKICAgICAgICBsZXQgbXV0IG5vbl9lbXB0eV9oZWFkZXJzID0gMDsKICAgICAgICBsZXQgaGVhZGVycyA9IHNlbGYucHJvdmlkZXIuc2VhbGVkX2hlYWRlcnNfd2hpbGUocmFuZ2UuY2xvbmUoKSwgfGhlYWRlcnwgewogICAgICAgICAgICBsZXQgc2hvdWxkX3Rha2UgPSByYW5nZS5jb250YWlucygmaGVhZGVyLm51bWJlcigpKSAmJgogICAgICAgICAgICAgICAgbm9uX2VtcHR5X2hlYWRlcnMgPCBtYXhfbm9uX2VtcHR5ICYmCiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPCBzZWxmLnN0cmVhbV9iYXRjaF9zaXplOwoKICAgICAgICAgICAgaWYgc2hvdWxkX3Rha2UgewogICAgICAgICAgICAgICAgY29sbGVjdGVkICs9IDE7CiAgICAgICAgICAgICAgICBpZiAhaGVhZGVyLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgICAgIG5vbl9lbXB0eV9oZWFkZXJzICs9IDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmYWxzZQogICAgICAgICAgICB9CiAgICAgICAgfSk/OwoKICAgICAgICBPayhTb21lKGhlYWRlcnMpLmZpbHRlcih8aHwgIWguaXNfZW1wdHkoKSkpCiAgICB9CgogICAgLy8vIEdldCB0aGUgbmV4dCBleHBlY3RlZCBibG9jayBudW1iZXIgZm9yIHF1ZXVlaW5nLgogICAgY29uc3QgZm4gbmV4dF9leHBlY3RlZF9ibG9ja19udW1iZXIoJnNlbGYpIC0+IEJsb2NrTnVtYmVyIHsKICAgICAgICBtYXRjaCBzZWxmLmxhdGVzdF9xdWV1ZWRfYmxvY2tfbnVtYmVyIHsKICAgICAgICAgICAgU29tZShudW0pID0+IG51bSArIDEsCiAgICAgICAgICAgIE5vbmUgPT4gKnNlbGYuZG93bmxvYWRfcmFuZ2Uuc3RhcnQoKSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIE1heCByZXF1ZXN0cyB0byBoYW5kbGUgYXQgdGhlIHNhbWUgdGltZQogICAgLy8vCiAgICAvLy8gVGhpcyBkZXBlbmRzIG9uIHRoZSBudW1iZXIgb2YgYWN0aXZlIHBlZXJzIGJ1dCB3aWxsIGFsd2F5cyBiZQogICAgLy8vIGBtaW5fY29uY3VycmVudF9yZXF1ZXN0cy4ubWF4X2NvbmN1cnJlbnRfcmVxdWVzdHNgCiAgICAjW2lubGluZV0KICAgIGZuIGNvbmN1cnJlbnRfcmVxdWVzdF9saW1pdCgmc2VsZikgLT4gdXNpemUgewogICAgICAgIGxldCBudW1fcGVlcnMgPSBzZWxmLmNsaWVudC5udW1fY29ubmVjdGVkX3BlZXJzKCk7CgogICAgICAgIGxldCBtYXhfcmVxdWVzdHMgPSBudW1fcGVlcnMubWF4KCpzZWxmLmNvbmN1cnJlbnRfcmVxdWVzdHNfcmFuZ2Uuc3RhcnQoKSk7CgogICAgICAgIC8vIGlmIHdlJ3JlIG9ubHkgY29ubmVjdGVkIHRvIGEgZmV3IHBlZXJzLCB3ZSBrZWVwIGl0IGxvdwogICAgICAgIGlmIG51bV9wZWVycyA8ICpzZWxmLmNvbmN1cnJlbnRfcmVxdWVzdHNfcmFuZ2Uuc3RhcnQoKSB7CiAgICAgICAgICAgIHJldHVybiBtYXhfcmVxdWVzdHMKICAgICAgICB9CgogICAgICAgIG1heF9yZXF1ZXN0cy5taW4oKnNlbGYuY29uY3VycmVudF9yZXF1ZXN0c19yYW5nZS5lbmQoKSkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0cnVlIGlmIHRoZSBzaXplIG9mIGJ1ZmZlcmVkIGJsb2NrcyBpcyBsb3dlciB0aGFuIHRoZSBjb25maWd1cmVkIG1heGltdW0KICAgIGNvbnN0IGZuIGhhc19idWZmZXJfY2FwYWNpdHkoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIHNlbGYuYnVmZmVyZWRfYmxvY2tzX3NpemVfYnl0ZXMgPCBzZWxmLm1heF9idWZmZXJlZF9ibG9ja3Nfc2l6ZV9ieXRlcwogICAgfQoKICAgIC8vIENoZWNrIGlmIHRoZSBzdHJlYW0gaXMgdGVybWluYXRlZAogICAgZm4gaXNfdGVybWluYXRlZCgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgLy8gVGhlcmUgaXMgbm90aGluZyB0byByZXF1ZXN0IGlmIHRoZSByYW5nZSBpcyBlbXB0eQogICAgICAgIGxldCBub3RoaW5nX3RvX3JlcXVlc3QgPSBzZWxmLmRvd25sb2FkX3JhbmdlLmlzX2VtcHR5KCkgfHwKICAgICAgICAgICAgLy8gb3IgYWxsIGJsb2NrcyBoYXZlIGFscmVhZHkgYmVlbiByZXF1ZXN0ZWQuCiAgICAgICAgICAgIHNlbGYuaW5fcHJvZ3Jlc3NfcXVldWUKICAgICAgICAgICAgICAgIC5sYXN0X3JlcXVlc3RlZF9ibG9ja19udW1iZXIuaXNfc29tZV9hbmQofGxhc3R8IGxhc3QgPT0gKnNlbGYuZG93bmxvYWRfcmFuZ2UuZW5kKCkpOwoKICAgICAgICBub3RoaW5nX3RvX3JlcXVlc3QgJiYKICAgICAgICAgICAgc2VsZi5pbl9wcm9ncmVzc19xdWV1ZS5pc19lbXB0eSgpICYmCiAgICAgICAgICAgIHNlbGYuYnVmZmVyZWRfcmVzcG9uc2VzLmlzX2VtcHR5KCkgJiYKICAgICAgICAgICAgc2VsZi5xdWV1ZWRfYm9kaWVzLmlzX2VtcHR5KCkKICAgIH0KCiAgICAvLy8gQ2xlYXIgYWxsIGRvd25sb2FkIHJlbGF0ZWQgZGF0YS4KICAgIC8vLwogICAgLy8vIFNob3VsZCBiZSBpbnZva2VkIHVwb24gZW5jb3VudGVyaW5nIGZhdGFsIGVycm9yLgogICAgZm4gY2xlYXIoJm11dCBzZWxmKSB7CiAgICAgICAgc2VsZi5kb3dubG9hZF9yYW5nZSA9IFJhbmdlSW5jbHVzaXZlOjpuZXcoMSwgMCk7CiAgICAgICAgc2VsZi5sYXRlc3RfcXVldWVkX2Jsb2NrX251bWJlci50YWtlKCk7CiAgICAgICAgc2VsZi5pbl9wcm9ncmVzc19xdWV1ZS5jbGVhcigpOwogICAgICAgIHNlbGYucXVldWVkX2JvZGllcyA9IFZlYzo6bmV3KCk7CiAgICAgICAgc2VsZi5idWZmZXJlZF9yZXNwb25zZXMgPSBCaW5hcnlIZWFwOjpuZXcoKTsKICAgICAgICBzZWxmLmJ1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzID0gMDsKCiAgICAgICAgLy8gcmVzZXQgbWV0cmljcwogICAgICAgIHNlbGYubWV0cmljcy5pbl9mbGlnaHRfcmVxdWVzdHMuc2V0KDAuKTsKICAgICAgICBzZWxmLm1ldHJpY3MuYnVmZmVyZWRfcmVzcG9uc2VzLnNldCgwLik7CiAgICAgICAgc2VsZi5tZXRyaWNzLmJ1ZmZlcmVkX2Jsb2Nrcy5zZXQoMC4pOwogICAgICAgIHNlbGYubWV0cmljcy5idWZmZXJlZF9ibG9ja3Nfc2l6ZV9ieXRlcy5zZXQoMC4pOwogICAgICAgIHNlbGYubWV0cmljcy5xdWV1ZWRfYmxvY2tzLnNldCgwLik7CiAgICB9CgogICAgLy8vIFF1ZXVlcyBib2RpZXMgYW5kIHNldHMgdGhlIGxhdGVzdCBxdWV1ZWQgYmxvY2sgbnVtYmVyCiAgICBmbiBxdWV1ZV9ib2RpZXMoJm11dCBzZWxmLCBib2RpZXM6IFZlYzxCbG9ja1Jlc3BvbnNlPEI+PikgewogICAgICAgIHNlbGYubGF0ZXN0X3F1ZXVlZF9ibG9ja19udW1iZXIgPSBTb21lKGJvZGllcy5sYXN0KCkuZXhwZWN0KCJpcyBub3QgZW1wdHkiKS5ibG9ja19udW1iZXIoKSk7CiAgICAgICAgc2VsZi5xdWV1ZWRfYm9kaWVzLmV4dGVuZChib2RpZXMpOwogICAgICAgIHNlbGYubWV0cmljcy5xdWV1ZWRfYmxvY2tzLnNldChzZWxmLnF1ZXVlZF9ib2RpZXMubGVuKCkgYXMgZjY0KTsKICAgIH0KCiAgICAvLy8gUmVtb3ZlcyB0aGUgbmV4dCByZXNwb25zZSBmcm9tIHRoZSBidWZmZXIuCiAgICBmbiBwb3BfYnVmZmVyZWRfcmVzcG9uc2UoJm11dCBzZWxmKSAtPiBPcHRpb248T3JkZXJlZEJvZGllc1Jlc3BvbnNlPEI+PiB7CiAgICAgICAgbGV0IHJlc3AgPSBzZWxmLmJ1ZmZlcmVkX3Jlc3BvbnNlcy5wb3AoKT87CiAgICAgICAgc2VsZi5tZXRyaWNzLmJ1ZmZlcmVkX3Jlc3BvbnNlcy5kZWNyZW1lbnQoMS4pOwogICAgICAgIHNlbGYuYnVmZmVyZWRfYmxvY2tzX3NpemVfYnl0ZXMgLT0gcmVzcC5zaXplKCk7CiAgICAgICAgc2VsZi5tZXRyaWNzLmJ1ZmZlcmVkX2Jsb2Nrcy5kZWNyZW1lbnQocmVzcC5sZW4oKSBhcyBmNjQpOwogICAgICAgIHNlbGYubWV0cmljcy5idWZmZXJlZF9ibG9ja3Nfc2l6ZV9ieXRlcy5zZXQoc2VsZi5idWZmZXJlZF9ibG9ja3Nfc2l6ZV9ieXRlcyBhcyBmNjQpOwogICAgICAgIFNvbWUocmVzcCkKICAgIH0KCiAgICAvLy8gQWRkcyBhIG5ldyByZXNwb25zZSB0byB0aGUgaW50ZXJuYWwgYnVmZmVyCiAgICBmbiBidWZmZXJfYm9kaWVzX3Jlc3BvbnNlKCZtdXQgc2VsZiwgcmVzcG9uc2U6IFZlYzxCbG9ja1Jlc3BvbnNlPEI+PikgewogICAgICAgIGxldCBzaXplID0gcmVzcG9uc2UuaXRlcigpLm1hcChCbG9ja1Jlc3BvbnNlOjpzaXplKS5zdW06Ojx1c2l6ZT4oKTsKCiAgICAgICAgbGV0IHJlc3BvbnNlID0gT3JkZXJlZEJvZGllc1Jlc3BvbnNlIHsgcmVzcDogcmVzcG9uc2UsIHNpemUgfTsKICAgICAgICBsZXQgcmVzcG9uc2VfbGVuID0gcmVzcG9uc2UubGVuKCk7CgogICAgICAgIHNlbGYuYnVmZmVyZWRfYmxvY2tzX3NpemVfYnl0ZXMgKz0gc2l6ZTsKICAgICAgICBzZWxmLmJ1ZmZlcmVkX3Jlc3BvbnNlcy5wdXNoKHJlc3BvbnNlKTsKCiAgICAgICAgc2VsZi5tZXRyaWNzLmJ1ZmZlcmVkX2Jsb2Nrcy5pbmNyZW1lbnQocmVzcG9uc2VfbGVuIGFzIGY2NCk7CiAgICAgICAgc2VsZi5tZXRyaWNzLmJ1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzLnNldChzZWxmLmJ1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzIGFzIGY2NCk7CiAgICAgICAgc2VsZi5tZXRyaWNzLmJ1ZmZlcmVkX3Jlc3BvbnNlcy5zZXQoc2VsZi5idWZmZXJlZF9yZXNwb25zZXMubGVuKCkgYXMgZjY0KTsKICAgIH0KCiAgICAvLy8gUmV0dXJucyBhIHJlc3BvbnNlIGlmIGl0cyBmaXJzdCBibG9jayBudW1iZXIgbWF0Y2hlcyB0aGUgbmV4dCBleHBlY3RlZC4KICAgIGZuIHRyeV9uZXh0X2J1ZmZlcmVkKCZtdXQgc2VsZikgLT4gT3B0aW9uPFZlYzxCbG9ja1Jlc3BvbnNlPEI+Pj4gewogICAgICAgIGlmIGxldCBTb21lKG5leHQpID0gc2VsZi5idWZmZXJlZF9yZXNwb25zZXMucGVlaygpIHsKICAgICAgICAgICAgbGV0IGV4cGVjdGVkID0gc2VsZi5uZXh0X2V4cGVjdGVkX2Jsb2NrX251bWJlcigpOwogICAgICAgICAgICBsZXQgbmV4dF9ibG9ja19yYW5nZSA9IG5leHQuYmxvY2tfcmFuZ2UoKTsKCiAgICAgICAgICAgIGlmIG5leHRfYmxvY2tfcmFuZ2UuY29udGFpbnMoJmV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5wb3BfYnVmZmVyZWRfcmVzcG9uc2UoKS5tYXAofGJ1ZmZlcmVkfCB7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyZWQKICAgICAgICAgICAgICAgICAgICAgICAgLnJlc3AKICAgICAgICAgICAgICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgIC5za2lwX3doaWxlKHxifCBiLmJsb2NrX251bWJlcigpIDwgZXhwZWN0ZWQpCiAgICAgICAgICAgICAgICAgICAgICAgIC50YWtlX3doaWxlKHxifCBzZWxmLmRvd25sb2FkX3JhbmdlLmNvbnRhaW5zKCZiLmJsb2NrX251bWJlcigpKSkKICAgICAgICAgICAgICAgICAgICAgICAgLmNvbGxlY3QoKQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJvcCBidWZmZXJlZCByZXNwb25zZSBzaW5jZSB3ZSBwYXNzZWQgdGhhdCByYW5nZQogICAgICAgICAgICBpZiAqbmV4dF9ibG9ja19yYW5nZS5lbmQoKSA8IGV4cGVjdGVkIHsKICAgICAgICAgICAgICAgIHNlbGYucG9wX2J1ZmZlcmVkX3Jlc3BvbnNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgTm9uZQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBuZXh0IGJhdGNoIG9mIGJsb2NrIGJvZGllcyB0aGF0IGNhbiBiZSByZXR1cm5lZCBpZiB3ZSBoYXZlIGVub3VnaCBidWZmZXJlZAogICAgLy8vIGJvZGllcwogICAgZm4gdHJ5X3NwbGl0X25leHRfYmF0Y2goJm11dCBzZWxmKSAtPiBPcHRpb248VmVjPEJsb2NrUmVzcG9uc2U8Qj4+PiB7CiAgICAgICAgaWYgc2VsZi5xdWV1ZWRfYm9kaWVzLmxlbigpID49IHNlbGYuc3RyZWFtX2JhdGNoX3NpemUgewogICAgICAgICAgICBsZXQgbmV4dF9iYXRjaCA9IHNlbGYucXVldWVkX2JvZGllcy5kcmFpbiguLnNlbGYuc3RyZWFtX2JhdGNoX3NpemUpLmNvbGxlY3Q6OjxWZWM8Xz4+KCk7CiAgICAgICAgICAgIHNlbGYucXVldWVkX2JvZGllcy5zaHJpbmtfdG9fZml0KCk7CiAgICAgICAgICAgIHNlbGYubWV0cmljcy50b3RhbF9mbHVzaGVkLmluY3JlbWVudChuZXh0X2JhdGNoLmxlbigpIGFzIHU2NCk7CiAgICAgICAgICAgIHNlbGYubWV0cmljcy5xdWV1ZWRfYmxvY2tzLnNldChzZWxmLnF1ZXVlZF9ib2RpZXMubGVuKCkgYXMgZjY0KTsKICAgICAgICAgICAgcmV0dXJuIFNvbWUobmV4dF9iYXRjaCkKICAgICAgICB9CiAgICAgICAgTm9uZQogICAgfQoKICAgIC8vLyBDaGVjayBpZiBhIG5ldyByZXF1ZXN0IGNhbiBiZSBzdWJtaXR0ZWQsIGl0IGltcGxlbWVudHMgYmFjayBwcmVzc3VyZSB0byBwcmV2ZW50IG92ZXJ3aGVsbWluZwogICAgLy8vIHRoZSBzeXN0ZW0gYW5kIGNhdXNpbmcgbWVtb3J5IG92ZXJsb2FkLgogICAgLy8vCiAgICAvLy8gUmV0dXJucyB0cnVlIGlmIGEgbmV3IHJlcXVlc3QgY2FuIGJlIHN1Ym1pdHRlZAogICAgZm4gY2FuX3N1Ym1pdF9uZXdfcmVxdWVzdCgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgLy8gcmVxdWVzdHMgYXJlIGlzc3VlZCBpbiBvcmRlciBidXQgbm90IG5lY2Vzc2FyaWx5IGZpbmlzaGVkIGluIG9yZGVyLCBzbyB0aGUgcXVldWVkIGJvZGllcwogICAgICAgIC8vIGNhbiBncm93IGxhcmdlIGlmIGEgY2VydGFpbiByZXF1ZXN0IGlzIHNsb3csIHNvIHdlIGxpbWl0IHRoZSBmb2xsb3d1cCByZXF1ZXN0cyBpZiB0aGUKICAgICAgICAvLyBxdWV1ZWQgYm9kaWVzIGdyZXcgdG9vIGxhcmdlCiAgICAgICAgc2VsZi5xdWV1ZWRfYm9kaWVzLmxlbigpIDwgNCAqIHNlbGYuc3RyZWFtX2JhdGNoX3NpemUgJiYKICAgICAgICAgICAgc2VsZi5oYXNfYnVmZmVyX2NhcGFjaXR5KCkgJiYKICAgICAgICAgICAgc2VsZi5pbl9wcm9ncmVzc19xdWV1ZS5sZW4oKSA8IHNlbGYuY29uY3VycmVudF9yZXF1ZXN0X2xpbWl0KCkKICAgIH0KfQoKaW1wbDxCLCBDLCBQcm92aWRlcj4gQm9kaWVzRG93bmxvYWRlcjxCLCBDLCBQcm92aWRlcj4Kd2hlcmUKICAgIEI6IEJsb2NrICsgJ3N0YXRpYywKICAgIEM6IEJvZGllc0NsaWVudDxCb2R5ID0gQjo6Qm9keT4gKyAnc3RhdGljLAogICAgUHJvdmlkZXI6IEhlYWRlclByb3ZpZGVyPEhlYWRlciA9IEI6OkhlYWRlcj4gKyBVbnBpbiArICdzdGF0aWMsCnsKICAgIC8vLyBTcGF3bnMgdGhlIGRvd25sb2FkZXIgdGFzayB2aWEgW2B0b2tpbzo6dGFzazo6c3Bhd25gXQogICAgcHViIGZuIGludG9fdGFzayhzZWxmKSAtPiBUYXNrRG93bmxvYWRlcjxCPiB7CiAgICAgICAgc2VsZi5pbnRvX3Rhc2tfd2l0aCgmVG9raW9UYXNrRXhlY3V0b3I6OmRlZmF1bHQoKSkKICAgIH0KCiAgICAvLy8gQ29udmVydCB0aGUgZG93bmxvYWRlciBpbnRvIGEgW2BUYXNrRG93bmxvYWRlcmBdIGJ5IHNwYXduaW5nIGl0IHZpYSB0aGUgZ2l2ZW4gc3Bhd25lci4KICAgIHB1YiBmbiBpbnRvX3Rhc2tfd2l0aDxTPihzZWxmLCBzcGF3bmVyOiAmUykgLT4gVGFza0Rvd25sb2FkZXI8Qj4KICAgIHdoZXJlCiAgICAgICAgUzogVGFza1NwYXduZXIsCiAgICB7CiAgICAgICAgVGFza0Rvd25sb2FkZXI6OnNwYXduX3dpdGgoc2VsZiwgc3Bhd25lcikKICAgIH0KfQoKaW1wbDxCLCBDLCBQcm92aWRlcj4gQm9keURvd25sb2FkZXIgZm9yIEJvZGllc0Rvd25sb2FkZXI8QiwgQywgUHJvdmlkZXI+CndoZXJlCiAgICBCOiBCbG9jayArICdzdGF0aWMsCiAgICBDOiBCb2RpZXNDbGllbnQ8Qm9keSA9IEI6OkJvZHk+ICsgJ3N0YXRpYywKICAgIFByb3ZpZGVyOiBIZWFkZXJQcm92aWRlcjxIZWFkZXIgPSBCOjpIZWFkZXI+ICsgVW5waW4gKyAnc3RhdGljLAp7CiAgICB0eXBlIEJsb2NrID0gQjsKCiAgICAvLy8gU2V0IGEgbmV3IGRvd25sb2FkIHJhbmdlIChpbmNsdXNpdmUpLgogICAgLy8vCiAgICAvLy8gSWYgdGhlIHByb3ZpZGVkIHJhbmdlIGlzIGEgc3VmZml4IG9mIHRoZSBjdXJyZW50IHJhbmdlIHdpdGggdGhlIHNhbWUgZW5kIGJsb2NrLCB0aGUKICAgIC8vLyBleGlzdGluZyBkb3dubG9hZCBhbHJlYWR5IGNvdmVycyBpdCBhbmQgdGhlIGNhbGwgaXMgYSBuby1vcC4KICAgIC8vLyBJZiB0aGUgcmFuZ2Ugc3RhcnRzIGltbWVkaWF0ZWx5IGFmdGVyIHRoZSBjdXJyZW50IHJhbmdlLCBpdCBpcyB0cmVhdGVkIGFzIHRoZSBuZXh0CiAgICAvLy8gY29uc2VjdXRpdmUgcmFuZ2UgYW5kIGFwcGVuZGVkIHdpdGhvdXQgcmVzZXR0aW5nIHRoZSBpbi1mbGlnaHQgc3RhdGUuCiAgICAvLy8gRm9yIGFsbCBvdGhlciByYW5nZXMsIHRoZSBkb3dubG9hZGVyIHN0YXRlIGlzIGNsZWFyZWQgYW5kIHRoZSBuZXcgcmFuZ2UgcmVwbGFjZXMgdGhlIG9sZAogICAgLy8vIG9uZS4KICAgIGZuIHNldF9kb3dubG9hZF9yYW5nZSgmbXV0IHNlbGYsIHJhbmdlOiBSYW5nZUluY2x1c2l2ZTxCbG9ja051bWJlcj4pIC0+IERvd25sb2FkUmVzdWx0PCgpPiB7CiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHJhbmdlIGlzIHZhbGlkLgogICAgICAgIGlmIHJhbmdlLmlzX2VtcHR5KCkgewogICAgICAgICAgICB0cmFjaW5nOjplcnJvciEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmJvZGllcyIsID9yYW5nZSwgIkJvZGllcyBkb3dubG9hZCByYW5nZSBpcyBpbnZhbGlkIChlbXB0eSkiKTsKICAgICAgICAgICAgcmV0dXJuIEVycihEb3dubG9hZEVycm9yOjpJbnZhbGlkQm9keVJhbmdlIHsgcmFuZ2UgfSkKICAgICAgICB9CgogICAgICAgIC8vIENoZWNrIGlmIHRoZSBwcm92aWRlZCByYW5nZSBpcyB0aGUgc3Vic2V0IG9mIHRoZSBleGlzdGluZyByYW5nZS4KICAgICAgICBsZXQgaXNfY3VycmVudF9yYW5nZV9zdWJzZXQgPSBzZWxmLmRvd25sb2FkX3JhbmdlLmNvbnRhaW5zKHJhbmdlLnN0YXJ0KCkpICYmCiAgICAgICAgICAgICpyYW5nZS5lbmQoKSA9PSAqc2VsZi5kb3dubG9hZF9yYW5nZS5lbmQoKTsKICAgICAgICBpZiBpc19jdXJyZW50X3JhbmdlX3N1YnNldCB7CiAgICAgICAgICAgIHRyYWNpbmc6OnRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6Ym9kaWVzIiwgP3JhbmdlLCAiRG93bmxvYWQgcmFuZ2UgYWxyZWFkeSBpbiBwcm9ncmVzcyIpOwogICAgICAgICAgICAvLyBUaGUgY3VycmVudCByYW5nZSBhbHJlYWR5IGluY2x1ZGVzIHJlcXVlc3RlZC4KICAgICAgICAgICAgcmV0dXJuIE9rKCgpKQogICAgICAgIH0KCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHByb3ZpZGVkIHJhbmdlIGlzIHRoZSBuZXh0IGV4cGVjdGVkIHJhbmdlLgogICAgICAgIGxldCBjb3VudCA9ICpyYW5nZS5lbmQoKSAtICpyYW5nZS5zdGFydCgpICsgMTsgLy8gcmFuZ2UgaXMgaW5jbHVzaXZlCiAgICAgICAgbGV0IGlzX25leHRfY29uc2VjdXRpdmVfcmFuZ2UgPSAqcmFuZ2Uuc3RhcnQoKSA9PSAqc2VsZi5kb3dubG9hZF9yYW5nZS5lbmQoKSArIDE7CiAgICAgICAgaWYgaXNfbmV4dF9jb25zZWN1dGl2ZV9yYW5nZSB7CiAgICAgICAgICAgIC8vIE5ldyByYW5nZSByZWNlaXZlZC4KICAgICAgICAgICAgdHJhY2luZzo6dHJhY2UhKHRhcmdldDogImRvd25sb2FkZXJzOjpib2RpZXMiLCA/cmFuZ2UsICJOZXcgZG93bmxvYWQgcmFuZ2Ugc2V0Iik7CiAgICAgICAgICAgIGluZm8hKHRhcmdldDogImRvd25sb2FkZXJzOjpib2RpZXMiLCBjb3VudCwgP3JhbmdlLCAiRG93bmxvYWRpbmcgYm9kaWVzIik7CiAgICAgICAgICAgIHNlbGYuZG93bmxvYWRfcmFuZ2UgPSByYW5nZTsKICAgICAgICAgICAgcmV0dXJuIE9rKCgpKQogICAgICAgIH0KCiAgICAgICAgLy8gVGhlIGJsb2NrIHJhbmdlIGlzIHJlc2V0LiBUaGlzIGNhbiBoYXBwZW4gZWl0aGVyIGFmdGVyIHVud2luZCBvciBhZnRlciB0aGUgYm9kaWVzIHdlcmUKICAgICAgICAvLyB3cml0dGVuIGJ5IGV4dGVybmFsIHNlcnZpY2VzIChlLmcuIEJsb2NrY2hhaW5UcmVlKS4KICAgICAgICB0cmFjaW5nOjp0cmFjZSEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmJvZGllcyIsID9yYW5nZSwgcHJldl9yYW5nZSA9ID9zZWxmLmRvd25sb2FkX3JhbmdlLCAiRG93bmxvYWQgcmFuZ2UgcmVzZXQiKTsKICAgICAgICBpbmZvISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6Ym9kaWVzIiwgY291bnQsID9yYW5nZSwgIkRvd25sb2FkaW5nIGJvZGllcyIpOwogICAgICAgIC8vIEluY3JlbWVudCBvdXQtb2Ytb3JkZXIgcmVxdWVzdHMgbWV0cmljIGlmIHRoZSBuZXcgc3RhcnQgaXMgYmVsb3cgdGhlIGxhc3QgcmV0dXJuZWQgYmxvY2sKICAgICAgICBpZiBsZXQgU29tZShsYXN0X3JldHVybmVkKSA9IHNlbGYubGF0ZXN0X3F1ZXVlZF9ibG9ja19udW1iZXIgJiYKICAgICAgICAgICAgKnJhbmdlLnN0YXJ0KCkgPCBsYXN0X3JldHVybmVkCiAgICAgICAgewogICAgICAgICAgICBzZWxmLm1ldHJpY3Mub3V0X29mX29yZGVyX3JlcXVlc3RzLmluY3JlbWVudCgxKTsKICAgICAgICB9CiAgICAgICAgc2VsZi5jbGVhcigpOwogICAgICAgIHNlbGYuZG93bmxvYWRfcmFuZ2UgPSByYW5nZTsKICAgICAgICBPaygoKSkKICAgIH0KfQoKaW1wbDxCLCBDLCBQcm92aWRlcj4gU3RyZWFtIGZvciBCb2RpZXNEb3dubG9hZGVyPEIsIEMsIFByb3ZpZGVyPgp3aGVyZQogICAgQjogQmxvY2sgKyAnc3RhdGljLAogICAgQzogQm9kaWVzQ2xpZW50PEJvZHkgPSBCOjpCb2R5PiArICdzdGF0aWMsCiAgICBQcm92aWRlcjogSGVhZGVyUHJvdmlkZXI8SGVhZGVyID0gQjo6SGVhZGVyPiArIFVucGluICsgJ3N0YXRpYywKewogICAgdHlwZSBJdGVtID0gQm9keURvd25sb2FkZXJSZXN1bHQ8Qj47CgogICAgZm4gcG9sbF9uZXh0KHNlbGY6IFBpbjwmbXV0IFNlbGY+LCBjeDogJm11dCBDb250ZXh0PCdfPikgLT4gUG9sbDxPcHRpb248U2VsZjo6SXRlbT4+IHsKICAgICAgICBsZXQgdGhpcyA9IHNlbGYuZ2V0X211dCgpOwogICAgICAgIGlmIHRoaXMuaXNfdGVybWluYXRlZCgpIHsKICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KE5vbmUpCiAgICAgICAgfQogICAgICAgIC8vIFN1Ym1pdCBuZXcgcmVxdWVzdHMgYW5kIHBvbGwgYW55IGluIHByb2dyZXNzCiAgICAgICAgbG9vcCB7CiAgICAgICAgICAgIC8vIFlpZWxkIG5leHQgYmF0Y2ggaWYgcmVhZHkKICAgICAgICAgICAgaWYgbGV0IFNvbWUobmV4dF9iYXRjaCkgPSB0aGlzLnRyeV9zcGxpdF9uZXh0X2JhdGNoKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KFNvbWUoT2sobmV4dF9iYXRjaCkpKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQb2xsIHJlcXVlc3RzCiAgICAgICAgICAgIHdoaWxlIGxldCBQb2xsOjpSZWFkeShTb21lKHJlc3BvbnNlKSkgPSB0aGlzLmluX3Byb2dyZXNzX3F1ZXVlLnBvbGxfbmV4dF91bnBpbihjeCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXRyaWNzLmluX2ZsaWdodF9yZXF1ZXN0cy5kZWNyZW1lbnQoMS4pOwogICAgICAgICAgICAgICAgbWF0Y2ggcmVzcG9uc2UgewogICAgICAgICAgICAgICAgICAgIE9rKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYnVmZmVyX2JvZGllc19yZXNwb25zZShyZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0cmFjaW5nOjpkZWJ1ZyEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmJvZGllcyIsICVlcnJvciwgIlJlcXVlc3QgZmFpbGVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KFNvbWUoRXJyKGVycm9yKSkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTG9vcCBleGl0IGNvbmRpdGlvbgogICAgICAgICAgICBsZXQgbXV0IG5ld19yZXF1ZXN0X3N1Ym1pdHRlZCA9IGZhbHNlOwogICAgICAgICAgICAvLyBTdWJtaXQgbmV3IHJlcXVlc3RzCiAgICAgICAgICAgICdpbm5lcjogd2hpbGUgdGhpcy5jYW5fc3VibWl0X25ld19yZXF1ZXN0KCkgewogICAgICAgICAgICAgICAgbWF0Y2ggdGhpcy5uZXh0X2hlYWRlcnNfcmVxdWVzdCgpIHsKICAgICAgICAgICAgICAgICAgICBPayhTb21lKHJlcXVlc3QpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWV0cmljcy5pbl9mbGlnaHRfcmVxdWVzdHMuaW5jcmVtZW50KDEuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbl9wcm9ncmVzc19xdWV1ZS5wdXNoX25ld19yZXF1ZXN0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgQXJjOjpjbG9uZSgmdGhpcy5jbGllbnQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgQXJjOjpjbG9uZSgmdGhpcy5jb25zZW5zdXMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X3JlcXVlc3Rfc3VibWl0dGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgT2soTm9uZSkgPT4gYnJlYWsgJ2lubmVyLAogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0cmFjaW5nOjplcnJvciEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmJvZGllcyIsICVlcnJvciwgIkZhaWxlZCB0byBkb3dubG9hZCBmcm9tIG5leHQgcmVxdWVzdCIpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBQb2xsOjpSZWFkeShTb21lKEVycihlcnJvcikpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIGxldCBTb21lKGJ1Zl9yZXNwb25zZSkgPSB0aGlzLnRyeV9uZXh0X2J1ZmZlcmVkKCkgewogICAgICAgICAgICAgICAgdGhpcy5xdWV1ZV9ib2RpZXMoYnVmX3Jlc3BvbnNlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gc2hyaW5rIHRoZSBidWZmZXIgc28gdGhhdCBpdCBkb2Vzbid0IGdyb3cgaW5kZWZpbml0ZWx5CiAgICAgICAgICAgIHRoaXMuYnVmZmVyZWRfcmVzcG9uc2VzLnNocmlua190b19maXQoKTsKCiAgICAgICAgICAgIGlmICFuZXdfcmVxdWVzdF9zdWJtaXR0ZWQgewogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQWxsIHJlcXVlc3RzIGFyZSBoYW5kbGVkLCBzdHJlYW0gaXMgZmluaXNoZWQKICAgICAgICBpZiB0aGlzLmluX3Byb2dyZXNzX3F1ZXVlLmlzX2VtcHR5KCkgewogICAgICAgICAgICBpZiB0aGlzLnF1ZXVlZF9ib2RpZXMuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoTm9uZSkKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgYmF0Y2hfc2l6ZSA9IHRoaXMuc3RyZWFtX2JhdGNoX3NpemUubWluKHRoaXMucXVldWVkX2JvZGllcy5sZW4oKSk7CiAgICAgICAgICAgIGxldCBuZXh0X2JhdGNoID0gdGhpcy5xdWV1ZWRfYm9kaWVzLmRyYWluKC4uYmF0Y2hfc2l6ZSkuY29sbGVjdDo6PFZlYzxfPj4oKTsKICAgICAgICAgICAgdGhpcy5xdWV1ZWRfYm9kaWVzLnNocmlua190b19maXQoKTsKICAgICAgICAgICAgdGhpcy5tZXRyaWNzLnRvdGFsX2ZsdXNoZWQuaW5jcmVtZW50KG5leHRfYmF0Y2gubGVuKCkgYXMgdTY0KTsKICAgICAgICAgICAgdGhpcy5tZXRyaWNzLnF1ZXVlZF9ibG9ja3Muc2V0KHRoaXMucXVldWVkX2JvZGllcy5sZW4oKSBhcyBmNjQpOwogICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoU29tZShPayhuZXh0X2JhdGNoKSkpCiAgICAgICAgfQoKICAgICAgICBQb2xsOjpQZW5kaW5nCiAgICB9Cn0KCiNbZGVyaXZlKERlYnVnKV0Kc3RydWN0IE9yZGVyZWRCb2RpZXNSZXNwb25zZTxCOiBCbG9jaz4gewogICAgcmVzcDogVmVjPEJsb2NrUmVzcG9uc2U8Qj4+LAogICAgLy8vIFRoZSB0b3RhbCBzaXplIG9mIHRoZSByZXNwb25zZSBpbiBieXRlcwogICAgc2l6ZTogdXNpemUsCn0KCmltcGw8QjogQmxvY2s+IE9yZGVyZWRCb2RpZXNSZXNwb25zZTxCPiB7CiAgICAjW2lubGluZV0KICAgIGNvbnN0IGZuIGxlbigmc2VsZikgLT4gdXNpemUgewogICAgICAgIHNlbGYucmVzcC5sZW4oKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBzaXplIG9mIHRoZSByZXNwb25zZSBpbiBieXRlcwogICAgLy8vCiAgICAvLy8gU2VlIFtgQmxvY2tSZXNwb25zZTo6c2l6ZWBdCiAgICAjW2lubGluZV0KICAgIGNvbnN0IGZuIHNpemUoJnNlbGYpIC0+IHVzaXplIHsKICAgICAgICBzZWxmLnNpemUKICAgIH0KfQoKaW1wbDxCOiBCbG9jaz4gT3JkZXJlZEJvZGllc1Jlc3BvbnNlPEI+IHsKICAgIC8vLyBSZXR1cm5zIHRoZSBibG9jayBudW1iZXIgb2YgdGhlIGZpcnN0IGVsZW1lbnQKICAgIC8vLwogICAgLy8vICMgUGFuaWNzCiAgICAvLy8gSWYgdGhlIHJlc3BvbnNlIHZlYyBpcyBlbXB0eS4KICAgIGZuIGZpcnN0X2Jsb2NrX251bWJlcigmc2VsZikgLT4gdTY0IHsKICAgICAgICBzZWxmLnJlc3AuZmlyc3QoKS5leHBlY3QoImlzIG5vdCBlbXB0eSIpLmJsb2NrX251bWJlcigpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIHJhbmdlIG9mIHRoZSBibG9jayBudW1iZXJzIGluIHRoZSByZXNwb25zZQogICAgLy8vCiAgICAvLy8gIyBQYW5pY3MKICAgIC8vLyBJZiB0aGUgcmVzcG9uc2UgdmVjIGlzIGVtcHR5LgogICAgZm4gYmxvY2tfcmFuZ2UoJnNlbGYpIC0+IFJhbmdlSW5jbHVzaXZlPHU2ND4gewogICAgICAgIHNlbGYuZmlyc3RfYmxvY2tfbnVtYmVyKCkuLj1zZWxmLnJlc3AubGFzdCgpLmV4cGVjdCgiaXMgbm90IGVtcHR5IikuYmxvY2tfbnVtYmVyKCkKICAgIH0KfQoKaW1wbDxCOiBCbG9jaz4gUGFydGlhbEVxIGZvciBPcmRlcmVkQm9kaWVzUmVzcG9uc2U8Qj4gewogICAgZm4gZXEoJnNlbGYsIG90aGVyOiAmU2VsZikgLT4gYm9vbCB7CiAgICAgICAgc2VsZi5maXJzdF9ibG9ja19udW1iZXIoKSA9PSBvdGhlci5maXJzdF9ibG9ja19udW1iZXIoKQogICAgfQp9CgppbXBsPEI6IEJsb2NrPiBFcSBmb3IgT3JkZXJlZEJvZGllc1Jlc3BvbnNlPEI+IHt9CgppbXBsPEI6IEJsb2NrPiBQYXJ0aWFsT3JkIGZvciBPcmRlcmVkQm9kaWVzUmVzcG9uc2U8Qj4gewogICAgZm4gcGFydGlhbF9jbXAoJnNlbGYsIG90aGVyOiAmU2VsZikgLT4gT3B0aW9uPE9yZGVyaW5nPiB7CiAgICAgICAgU29tZShzZWxmLmNtcChvdGhlcikpCiAgICB9Cn0KCmltcGw8QjogQmxvY2s+IE9yZCBmb3IgT3JkZXJlZEJvZGllc1Jlc3BvbnNlPEI+IHsKICAgIGZuIGNtcCgmc2VsZiwgb3RoZXI6ICZTZWxmKSAtPiBPcmRlcmluZyB7CiAgICAgICAgc2VsZi5maXJzdF9ibG9ja19udW1iZXIoKS5jbXAoJm90aGVyLmZpcnN0X2Jsb2NrX251bWJlcigpKS5yZXZlcnNlKCkKICAgIH0KfQoKLy8vIEJ1aWxkZXIgZm9yIFtgQm9kaWVzRG93bmxvYWRlcmBdLgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUpXQpwdWIgc3RydWN0IEJvZGllc0Rvd25sb2FkZXJCdWlsZGVyIHsKICAgIC8vLyBUaGUgYmF0Y2ggc2l6ZSBvZiBub24tZW1wdHkgYmxvY2tzIHBlciBvbmUgcmVxdWVzdAogICAgcHViIHJlcXVlc3RfbGltaXQ6IHU2NCwKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2YgYmxvY2sgYm9kaWVzIHJldHVybmVkIGF0IG9uY2UgZnJvbSB0aGUgc3RyZWFtCiAgICBwdWIgc3RyZWFtX2JhdGNoX3NpemU6IHVzaXplLAogICAgLy8vIE1heGltdW0gbnVtYmVyIG9mIGJ5dGVzIG9mIHJlY2VpdmVkIGJvZGllcyB0byBidWZmZXIgaW50ZXJuYWxseS4KICAgIHB1YiBtYXhfYnVmZmVyZWRfYmxvY2tzX3NpemVfYnl0ZXM6IHVzaXplLAogICAgLy8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiByZXF1ZXN0cyB0byBzZW5kIGNvbmN1cnJlbnRseS4KICAgIHB1YiBjb25jdXJyZW50X3JlcXVlc3RzX3JhbmdlOiBSYW5nZUluY2x1c2l2ZTx1c2l6ZT4sCn0KCmltcGwgQm9kaWVzRG93bmxvYWRlckJ1aWxkZXIgewogICAgLy8vIENyZWF0ZXMgYSBuZXcgW2BCb2RpZXNEb3dubG9hZGVyQnVpbGRlcmBdIHdpdGggY29uZmlndXJhdGlvbnMgYmFzZWQgb24gdGhlIHByb3ZpZGVkCiAgICAvLy8gW2BCb2RpZXNDb25maWdgXS4KICAgIHB1YiBmbiBuZXcoY29uZmlnOiBCb2RpZXNDb25maWcpIC0+IFNlbGYgewogICAgICAgIFNlbGY6OmRlZmF1bHQoKQogICAgICAgICAgICAud2l0aF9zdHJlYW1fYmF0Y2hfc2l6ZShjb25maWcuZG93bmxvYWRlcl9zdHJlYW1fYmF0Y2hfc2l6ZSkKICAgICAgICAgICAgLndpdGhfcmVxdWVzdF9saW1pdChjb25maWcuZG93bmxvYWRlcl9yZXF1ZXN0X2xpbWl0KQogICAgICAgICAgICAud2l0aF9tYXhfYnVmZmVyZWRfYmxvY2tzX3NpemVfYnl0ZXMoY29uZmlnLmRvd25sb2FkZXJfbWF4X2J1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzKQogICAgICAgICAgICAud2l0aF9jb25jdXJyZW50X3JlcXVlc3RzX3JhbmdlKAogICAgICAgICAgICAgICAgY29uZmlnLmRvd25sb2FkZXJfbWluX2NvbmN1cnJlbnRfcmVxdWVzdHMuLj0KICAgICAgICAgICAgICAgICAgICBjb25maWcuZG93bmxvYWRlcl9tYXhfY29uY3VycmVudF9yZXF1ZXN0cywKICAgICAgICAgICAgKQogICAgfQp9CgppbXBsIERlZmF1bHQgZm9yIEJvZGllc0Rvd25sb2FkZXJCdWlsZGVyIHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgcmVxdWVzdF9saW1pdDogMjAwLAogICAgICAgICAgICBzdHJlYW1fYmF0Y2hfc2l6ZTogMV8wMDAsCiAgICAgICAgICAgIG1heF9idWZmZXJlZF9ibG9ja3Nfc2l6ZV9ieXRlczogMiAqIDEwMjQgKiAxMDI0ICogMTAyNCwgLy8gfjJHQgogICAgICAgICAgICBjb25jdXJyZW50X3JlcXVlc3RzX3JhbmdlOiA1Li49MTAwLAogICAgICAgIH0KICAgIH0KfQoKaW1wbCBCb2RpZXNEb3dubG9hZGVyQnVpbGRlciB7CiAgICAvLy8gU2V0IHJlcXVlc3QgYmF0Y2ggc2l6ZSBvbiB0aGUgZG93bmxvYWRlci4KICAgIHB1YiBjb25zdCBmbiB3aXRoX3JlcXVlc3RfbGltaXQobXV0IHNlbGYsIHJlcXVlc3RfbGltaXQ6IHU2NCkgLT4gU2VsZiB7CiAgICAgICAgc2VsZi5yZXF1ZXN0X2xpbWl0ID0gcmVxdWVzdF9saW1pdDsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIFNldCBzdHJlYW0gYmF0Y2ggc2l6ZSBvbiB0aGUgZG93bmxvYWRlci4KICAgIHB1YiBjb25zdCBmbiB3aXRoX3N0cmVhbV9iYXRjaF9zaXplKG11dCBzZWxmLCBzdHJlYW1fYmF0Y2hfc2l6ZTogdXNpemUpIC0+IFNlbGYgewogICAgICAgIHNlbGYuc3RyZWFtX2JhdGNoX3NpemUgPSBzdHJlYW1fYmF0Y2hfc2l6ZTsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIFNldCBjb25jdXJyZW50IHJlcXVlc3RzIHJhbmdlIG9uIHRoZSBkb3dubG9hZGVyLgogICAgcHViIGNvbnN0IGZuIHdpdGhfY29uY3VycmVudF9yZXF1ZXN0c19yYW5nZSgKICAgICAgICBtdXQgc2VsZiwKICAgICAgICBjb25jdXJyZW50X3JlcXVlc3RzX3JhbmdlOiBSYW5nZUluY2x1c2l2ZTx1c2l6ZT4sCiAgICApIC0+IFNlbGYgewogICAgICAgIHNlbGYuY29uY3VycmVudF9yZXF1ZXN0c19yYW5nZSA9IGNvbmN1cnJlbnRfcmVxdWVzdHNfcmFuZ2U7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBTZXQgbWF4IGJ1ZmZlcmVkIGJsb2NrIGJ5dGVzIG9uIHRoZSBkb3dubG9hZGVyLgogICAgcHViIGNvbnN0IGZuIHdpdGhfbWF4X2J1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzKAogICAgICAgIG11dCBzZWxmLAogICAgICAgIG1heF9idWZmZXJlZF9ibG9ja3Nfc2l6ZV9ieXRlczogdXNpemUsCiAgICApIC0+IFNlbGYgewogICAgICAgIHNlbGYubWF4X2J1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzID0gbWF4X2J1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzOwogICAgICAgIHNlbGYKICAgIH0KCiAgICAvLy8gQ29uc3VtZSBzZWxmIGFuZCByZXR1cm4gdGhlIGNvbmN1cnJlbnQgZG93bmxvYWRlci4KICAgIHB1YiBmbiBidWlsZDxCLCBDLCBQcm92aWRlcj4oCiAgICAgICAgc2VsZiwKICAgICAgICBjbGllbnQ6IEMsCiAgICAgICAgY29uc2Vuc3VzOiBBcmM8ZHluIENvbnNlbnN1czxCPj4sCiAgICAgICAgcHJvdmlkZXI6IFByb3ZpZGVyLAogICAgKSAtPiBCb2RpZXNEb3dubG9hZGVyPEIsIEMsIFByb3ZpZGVyPgogICAgd2hlcmUKICAgICAgICBCOiBCbG9jaywKICAgICAgICBDOiBCb2RpZXNDbGllbnQ8Qm9keSA9IEI6OkJvZHk+ICsgJ3N0YXRpYywKICAgICAgICBQcm92aWRlcjogSGVhZGVyUHJvdmlkZXI8SGVhZGVyID0gQjo6SGVhZGVyPiwKICAgIHsKICAgICAgICBsZXQgU2VsZiB7CiAgICAgICAgICAgIHJlcXVlc3RfbGltaXQsCiAgICAgICAgICAgIHN0cmVhbV9iYXRjaF9zaXplLAogICAgICAgICAgICBjb25jdXJyZW50X3JlcXVlc3RzX3JhbmdlLAogICAgICAgICAgICBtYXhfYnVmZmVyZWRfYmxvY2tzX3NpemVfYnl0ZXMsCiAgICAgICAgfSA9IHNlbGY7CiAgICAgICAgbGV0IG1ldHJpY3MgPSBCb2R5RG93bmxvYWRlck1ldHJpY3M6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgaW5fcHJvZ3Jlc3NfcXVldWUgPSBCb2RpZXNSZXF1ZXN0UXVldWU6Om5ldyhtZXRyaWNzLmNsb25lKCkpOwogICAgICAgIEJvZGllc0Rvd25sb2FkZXIgewogICAgICAgICAgICBjbGllbnQ6IEFyYzo6bmV3KGNsaWVudCksCiAgICAgICAgICAgIGNvbnNlbnN1cywKICAgICAgICAgICAgcHJvdmlkZXIsCiAgICAgICAgICAgIHJlcXVlc3RfbGltaXQsCiAgICAgICAgICAgIHN0cmVhbV9iYXRjaF9zaXplLAogICAgICAgICAgICBtYXhfYnVmZmVyZWRfYmxvY2tzX3NpemVfYnl0ZXMsCiAgICAgICAgICAgIGNvbmN1cnJlbnRfcmVxdWVzdHNfcmFuZ2UsCiAgICAgICAgICAgIGluX3Byb2dyZXNzX3F1ZXVlLAogICAgICAgICAgICBtZXRyaWNzLAogICAgICAgICAgICBkb3dubG9hZF9yYW5nZTogUmFuZ2VJbmNsdXNpdmU6Om5ldygxLCAwKSwKICAgICAgICAgICAgbGF0ZXN0X3F1ZXVlZF9ibG9ja19udW1iZXI6IE5vbmUsCiAgICAgICAgICAgIGJ1ZmZlcmVkX3Jlc3BvbnNlczogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICBxdWV1ZWRfYm9kaWVzOiBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIGJ1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzOiAwLAogICAgICAgIH0KICAgIH0KfQoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6Oio7CiAgICB1c2UgY3JhdGU6OnsKICAgICAgICBib2RpZXM6OnRlc3RfdXRpbHM6OntpbnNlcnRfaGVhZGVycywgemlwX2Jsb2Nrc30sCiAgICAgICAgdGVzdF91dGlsczo6e2dlbmVyYXRlX2JvZGllcywgVGVzdEJvZGllc0NsaWVudH0sCiAgICB9OwogICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkIyNTY7CiAgICB1c2UgYXNzZXJ0X21hdGNoZXM6OmFzc2VydF9tYXRjaGVzOwogICAgdXNlIHJldGhfY29uc2Vuc3VzOjp0ZXN0X3V0aWxzOjpUZXN0Q29uc2Vuc3VzOwogICAgdXNlIHJldGhfcHJvdmlkZXI6OnRlc3RfdXRpbHM6OmNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3Rvcnk7CiAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjpnZW5lcmF0b3JzOjp7c2VsZiwgcmFuZG9tX2Jsb2NrX3JhbmdlLCBCbG9ja1JhbmdlUGFyYW1zfTsKICAgIHVzZSBzdGQ6OmNvbGxlY3Rpb25zOjpIYXNoTWFwOwoKICAgIC8vIENoZWNrIHRoYXQgdGhlIGJsb2NrcyBhcmUgZW1pdHRlZCBpbiBvcmRlciBvZiBibG9jayBudW1iZXIsIG5vdCBpbiBvcmRlciBvZgogICAgLy8gZmlyc3QtZG93bmxvYWRlZAogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHN0cmVhbXNfYm9kaWVzX2luX29yZGVyKCkgewogICAgICAgIC8vIEdlbmVyYXRlIHNvbWUgcmFuZG9tIGJsb2NrcwogICAgICAgIGxldCBmYWN0b3J5ID0gY3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeSgpOwogICAgICAgIGxldCAoaGVhZGVycywgbXV0IGJvZGllcykgPSBnZW5lcmF0ZV9ib2RpZXMoMC4uPTE5KTsKCiAgICAgICAgaW5zZXJ0X2hlYWRlcnMoJmZhY3RvcnksICZoZWFkZXJzKTsKCiAgICAgICAgbGV0IGNsaWVudCA9IEFyYzo6bmV3KAogICAgICAgICAgICBUZXN0Qm9kaWVzQ2xpZW50OjpkZWZhdWx0KCkud2l0aF9ib2RpZXMoYm9kaWVzLmNsb25lKCkpLndpdGhfc2hvdWxkX2RlbGF5KHRydWUpLAogICAgICAgICk7CgogICAgICAgIGxldCBtdXQgZG93bmxvYWRlciA9IEJvZGllc0Rvd25sb2FkZXJCdWlsZGVyOjpkZWZhdWx0KCkKICAgICAgICAgICAgLmJ1aWxkOjo8cmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpCbG9jaywgXywgXz4oCiAgICAgICAgICAgICAgICBjbGllbnQuY2xvbmUoKSwKICAgICAgICAgICAgICAgIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgICAgICBmYWN0b3J5LAogICAgICAgICAgICApOwogICAgICAgIGRvd25sb2FkZXIuc2V0X2Rvd25sb2FkX3JhbmdlKDAuLj0xOSkuZXhwZWN0KCJmYWlsZWQgdG8gc2V0IGRvd25sb2FkIHJhbmdlIik7CgogICAgICAgIGFzc2VydF9tYXRjaGVzISgKICAgICAgICAgICAgZG93bmxvYWRlci5uZXh0KCkuYXdhaXQsCiAgICAgICAgICAgIFNvbWUoT2socmVzKSkgPT4gYXNzZXJ0X2VxIShyZXMsIHppcF9ibG9ja3MoaGVhZGVycy5pdGVyKCksICZtdXQgYm9kaWVzKSkKICAgICAgICApOwogICAgICAgIGFzc2VydF9lcSEoY2xpZW50LnRpbWVzX3JlcXVlc3RlZCgpLCAxKTsKICAgIH0KCiAgICAvLyBDaGVjayB0aGF0IHRoZSBudW1iZXIgb2YgdGltZXMgcmVxdWVzdGVkIGVxdWFscyB0byB0aGUgbnVtYmVyIG9mIGhlYWRlcnMgZGl2aWRlZCBieSByZXF1ZXN0CiAgICAvLyBsaW1pdC4KICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiByZXF1ZXN0c19jb3JyZWN0X251bWJlcl9vZl90aW1lcygpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBzb21lIHJhbmRvbSBibG9ja3MKICAgICAgICBsZXQgZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwogICAgICAgIGxldCBibG9ja3MgPSByYW5kb21fYmxvY2tfcmFuZ2UoCiAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAwLi49MTk5LAogICAgICAgICAgICBCbG9ja1JhbmdlUGFyYW1zIHsgcGFyZW50OiBTb21lKEIyNTY6OlpFUk8pLCB0eF9jb3VudDogMS4uMiwgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfSwKICAgICAgICApOwoKICAgICAgICBsZXQgaGVhZGVycyA9IGJsb2Nrcy5pdGVyKCkubWFwKHxibG9ja3wgYmxvY2suY2xvbmVfc2VhbGVkX2hlYWRlcigpKS5jb2xsZWN0Ojo8VmVjPF8+PigpOwogICAgICAgIGxldCBib2RpZXMgPSBibG9ja3MKICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgIC5tYXAofGJsb2NrfCAoYmxvY2suaGFzaCgpLCBibG9jay5pbnRvX2JvZHkoKSkpCiAgICAgICAgICAgIC5jb2xsZWN0Ojo8SGFzaE1hcDxfLCBfPj4oKTsKCiAgICAgICAgaW5zZXJ0X2hlYWRlcnMoJmZhY3RvcnksICZoZWFkZXJzKTsKCiAgICAgICAgbGV0IHJlcXVlc3RfbGltaXQgPSAxMDsKICAgICAgICBsZXQgY2xpZW50ID0gQXJjOjpuZXcoVGVzdEJvZGllc0NsaWVudDo6ZGVmYXVsdCgpLndpdGhfYm9kaWVzKGJvZGllcy5jbG9uZSgpKSk7CgogICAgICAgIGxldCBtdXQgZG93bmxvYWRlciA9IEJvZGllc0Rvd25sb2FkZXJCdWlsZGVyOjpkZWZhdWx0KCkKICAgICAgICAgICAgLndpdGhfcmVxdWVzdF9saW1pdChyZXF1ZXN0X2xpbWl0KQogICAgICAgICAgICAuYnVpbGQ6OjxyZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrLCBfLCBfPigKICAgICAgICAgICAgY2xpZW50LmNsb25lKCksCiAgICAgICAgICAgIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIGZhY3RvcnksCiAgICAgICAgKTsKICAgICAgICBkb3dubG9hZGVyLnNldF9kb3dubG9hZF9yYW5nZSgwLi49MTk5KS5leHBlY3QoImZhaWxlZCB0byBzZXQgZG93bmxvYWQgcmFuZ2UiKTsKCiAgICAgICAgbGV0IF8gPSBkb3dubG9hZGVyLmNvbGxlY3Q6OjxWZWM8Xz4+KCkuYXdhaXQ7CiAgICAgICAgYXNzZXJ0X2VxIShjbGllbnQudGltZXNfcmVxdWVzdGVkKCksIDIwKTsKICAgIH0KCiAgICAvLyBDaGVjayB0aGF0IGJvZGllcyBhcmUgcmV0dXJuZWQgaW4gY29ycmVjdCBvcmRlcgogICAgLy8gYWZ0ZXIgcmVzZXR0aW5nIHRoZSBkb3dubG9hZCByYW5nZSBtdWx0aXBsZSB0aW1lcy4KICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBzdHJlYW1zX2JvZGllc19pbl9vcmRlcl9hZnRlcl9yYW5nZV9yZXNldCgpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBzb21lIHJhbmRvbSBibG9ja3MKICAgICAgICBsZXQgZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKICAgICAgICBsZXQgKGhlYWRlcnMsIG11dCBib2RpZXMpID0gZ2VuZXJhdGVfYm9kaWVzKDAuLj05OSk7CgogICAgICAgIGluc2VydF9oZWFkZXJzKCZmYWN0b3J5LCAmaGVhZGVycyk7CgogICAgICAgIGxldCBzdHJlYW1fYmF0Y2hfc2l6ZSA9IDIwOwogICAgICAgIGxldCByZXF1ZXN0X2xpbWl0ID0gMTA7CiAgICAgICAgbGV0IGNsaWVudCA9IEFyYzo6bmV3KAogICAgICAgICAgICBUZXN0Qm9kaWVzQ2xpZW50OjpkZWZhdWx0KCkud2l0aF9ib2RpZXMoYm9kaWVzLmNsb25lKCkpLndpdGhfc2hvdWxkX2RlbGF5KHRydWUpLAogICAgICAgICk7CiAgICAgICAgbGV0IG11dCBkb3dubG9hZGVyID0gQm9kaWVzRG93bmxvYWRlckJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAud2l0aF9zdHJlYW1fYmF0Y2hfc2l6ZShzdHJlYW1fYmF0Y2hfc2l6ZSkKICAgICAgICAgICAgLndpdGhfcmVxdWVzdF9saW1pdChyZXF1ZXN0X2xpbWl0KQogICAgICAgICAgICAuYnVpbGQ6OjxyZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrLCBfLCBfPigKICAgICAgICAgICAgICAgIGNsaWVudC5jbG9uZSgpLAogICAgICAgICAgICAgICAgQXJjOjpuZXcoVGVzdENvbnNlbnN1czo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgICAgIGZhY3RvcnksCiAgICAgICAgICAgICk7CgogICAgICAgIGxldCBtdXQgcmFuZ2Vfc3RhcnQgPSAwOwogICAgICAgIHdoaWxlIHJhbmdlX3N0YXJ0IDwgMTAwIHsKICAgICAgICAgICAgZG93bmxvYWRlci5zZXRfZG93bmxvYWRfcmFuZ2UocmFuZ2Vfc3RhcnQuLj05OSkuZXhwZWN0KCJmYWlsZWQgdG8gc2V0IGRvd25sb2FkIHJhbmdlIik7CgogICAgICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoCiAgICAgICAgICAgICAgICBkb3dubG9hZGVyLm5leHQoKS5hd2FpdCwKICAgICAgICAgICAgICAgIFNvbWUoT2socmVzKSkgPT4gYXNzZXJ0X2VxIShyZXMsIHppcF9ibG9ja3MoaGVhZGVycy5pdGVyKCkuc2tpcChyYW5nZV9zdGFydCBhcyB1c2l6ZSkudGFrZShzdHJlYW1fYmF0Y2hfc2l6ZSksICZtdXQgYm9kaWVzKSkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgYXNzZXJ0IShkb3dubG9hZGVyLmxhdGVzdF9xdWV1ZWRfYmxvY2tfbnVtYmVyID49IFNvbWUocmFuZ2Vfc3RhcnQpKTsKICAgICAgICAgICAgcmFuZ2Vfc3RhcnQgKz0gc3RyZWFtX2JhdGNoX3NpemUgYXMgdTY0OwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDaGVjayB0aGF0IHRoZSBkb3dubG9hZGVyIHBpY2tzIHVwIHRoZSBuZXcgcmFuZ2UgYW5kIGRvd25sb2FkcyBib2RpZXMgYWZ0ZXIgcHJldmlvdXMgcmFuZ2UKICAgIC8vIHdhcyBjb21wbGV0ZWQuCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gY2FuX2Rvd25sb2FkX25ld19yYW5nZV9hZnRlcl90ZXJtaW5hdGlvbigpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBzb21lIHJhbmRvbSBibG9ja3MKICAgICAgICBsZXQgZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKICAgICAgICBsZXQgKGhlYWRlcnMsIG11dCBib2RpZXMpID0gZ2VuZXJhdGVfYm9kaWVzKDAuLj0xOTkpOwoKICAgICAgICBpbnNlcnRfaGVhZGVycygmZmFjdG9yeSwgJmhlYWRlcnMpOwoKICAgICAgICBsZXQgY2xpZW50ID0gQXJjOjpuZXcoVGVzdEJvZGllc0NsaWVudDo6ZGVmYXVsdCgpLndpdGhfYm9kaWVzKGJvZGllcy5jbG9uZSgpKSk7CgogICAgICAgIGxldCBtdXQgZG93bmxvYWRlciA9IEJvZGllc0Rvd25sb2FkZXJCdWlsZGVyOjpkZWZhdWx0KCkKICAgICAgICAgICAgLndpdGhfc3RyZWFtX2JhdGNoX3NpemUoMTAwKQogICAgICAgICAgICAuYnVpbGQ6OjxyZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrLCBfLCBfPigKICAgICAgICAgICAgY2xpZW50LmNsb25lKCksCiAgICAgICAgICAgIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIGZhY3RvcnksCiAgICAgICAgKTsKCiAgICAgICAgLy8gU2V0IGFuZCBkb3dubG9hZCB0aGUgZmlyc3QgcmFuZ2UKICAgICAgICBkb3dubG9hZGVyLnNldF9kb3dubG9hZF9yYW5nZSgwLi49OTkpLmV4cGVjdCgiZmFpbGVkIHRvIHNldCBkb3dubG9hZCByYW5nZSIpOwogICAgICAgIGFzc2VydF9tYXRjaGVzISgKICAgICAgICAgICAgZG93bmxvYWRlci5uZXh0KCkuYXdhaXQsCiAgICAgICAgICAgIFNvbWUoT2socmVzKSkgPT4gYXNzZXJ0X2VxIShyZXMsIHppcF9ibG9ja3MoaGVhZGVycy5pdGVyKCkudGFrZSgxMDApLCAmbXV0IGJvZGllcykpCiAgICAgICAgKTsKCiAgICAgICAgLy8gQ2hlY2sgdGhhdCB0aGUgc3RyZWFtIGlzIHRlcm1pbmF0ZWQKICAgICAgICBhc3NlcnQhKGRvd25sb2FkZXIubmV4dCgpLmF3YWl0LmlzX25vbmUoKSk7CgogICAgICAgIC8vIFNldCBhbmQgZG93bmxvYWQgdGhlIHNlY29uZCByYW5nZQogICAgICAgIGRvd25sb2FkZXIuc2V0X2Rvd25sb2FkX3JhbmdlKDEwMC4uPTE5OSkuZXhwZWN0KCJmYWlsZWQgdG8gc2V0IGRvd25sb2FkIHJhbmdlIik7CiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKAogICAgICAgICAgICBkb3dubG9hZGVyLm5leHQoKS5hd2FpdCwKICAgICAgICAgICAgU29tZShPayhyZXMpKSA9PiBhc3NlcnRfZXEhKHJlcywgemlwX2Jsb2NrcyhoZWFkZXJzLml0ZXIoKS5za2lwKDEwMCksICZtdXQgYm9kaWVzKSkKICAgICAgICApOwogICAgfQoKICAgIC8vIENoZWNrIHRoYXQgdGhlIGRvd25sb2FkZXIgY29udGludWVzIGFmdGVyIHRoZSBzaXplIGxpbWl0IGlzIHJlYWNoZWQuCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gY2FuX2Rvd25sb2FkX2FmdGVyX2V4Y2VlZGluZ19saW1pdCgpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBzb21lIHJhbmRvbSBibG9ja3MKICAgICAgICBsZXQgZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKICAgICAgICBsZXQgKGhlYWRlcnMsIG11dCBib2RpZXMpID0gZ2VuZXJhdGVfYm9kaWVzKDAuLj0xOTkpOwoKICAgICAgICBpbnNlcnRfaGVhZGVycygmZmFjdG9yeSwgJmhlYWRlcnMpOwoKICAgICAgICBsZXQgY2xpZW50ID0gQXJjOjpuZXcoVGVzdEJvZGllc0NsaWVudDo6ZGVmYXVsdCgpLndpdGhfYm9kaWVzKGJvZGllcy5jbG9uZSgpKSk7CgogICAgICAgIC8vIFNldCB0aGUgbWF4IGJ1ZmZlcmVkIGJsb2NrIHNpemUgdG8gMSBieXRlLCB0byBtYWtlIHN1cmUgdGhhdCBldmVyeSByZXNwb25zZSBleGNlZWRzIHRoZQogICAgICAgIC8vIGxpbWl0CiAgICAgICAgbGV0IG11dCBkb3dubG9hZGVyID0gQm9kaWVzRG93bmxvYWRlckJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAud2l0aF9zdHJlYW1fYmF0Y2hfc2l6ZSgxMCkKICAgICAgICAgICAgLndpdGhfcmVxdWVzdF9saW1pdCgxKQogICAgICAgICAgICAud2l0aF9tYXhfYnVmZmVyZWRfYmxvY2tzX3NpemVfYnl0ZXMoMSkKICAgICAgICAgICAgLmJ1aWxkOjo8cmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpCbG9jaywgXywgXz4oCiAgICAgICAgICAgICAgICBjbGllbnQuY2xvbmUoKSwKICAgICAgICAgICAgICAgIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSksCiAgICAgICAgICAgICAgICBmYWN0b3J5LAogICAgICAgICAgICApOwoKICAgICAgICAvLyBTZXQgYW5kIGRvd25sb2FkIHRoZSBlbnRpcmUgcmFuZ2UKICAgICAgICBkb3dubG9hZGVyLnNldF9kb3dubG9hZF9yYW5nZSgwLi49MTk5KS5leHBlY3QoImZhaWxlZCB0byBzZXQgZG93bmxvYWQgcmFuZ2UiKTsKICAgICAgICBsZXQgbXV0IGhlYWRlciA9IDA7CiAgICAgICAgd2hpbGUgbGV0IFNvbWUoT2socmVzcCkpID0gZG93bmxvYWRlci5uZXh0KCkuYXdhaXQgewogICAgICAgICAgICBhc3NlcnRfZXEhKHJlc3AsIHppcF9ibG9ja3MoaGVhZGVycy5pdGVyKCkuc2tpcChoZWFkZXIpLnRha2UocmVzcC5sZW4oKSksICZtdXQgYm9kaWVzKSk7CiAgICAgICAgICAgIGhlYWRlciArPSByZXNwLmxlbigpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDaGVjayB0aGF0IHRoZSBkb3dubG9hZGVyIGNhbiB0b2xlcmF0ZSBhIGZldyBjb21wbGV0ZWx5IGVtcHR5IHJlc3BvbnNlcwogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGNhbl90b2xlcmF0ZV9lbXB0eV9yZXNwb25zZXMoKSB7CiAgICAgICAgLy8gR2VuZXJhdGUgc29tZSByYW5kb20gYmxvY2tzCiAgICAgICAgbGV0IGZhY3RvcnkgPSBjcmVhdGVfdGVzdF9wcm92aWRlcl9mYWN0b3J5KCk7CiAgICAgICAgbGV0IChoZWFkZXJzLCBtdXQgYm9kaWVzKSA9IGdlbmVyYXRlX2JvZGllcygwLi49OTkpOwoKICAgICAgICBpbnNlcnRfaGVhZGVycygmZmFjdG9yeSwgJmhlYWRlcnMpOwoKICAgICAgICAvLyByZXNwb25kIHdpdGggZW1wdHkgYm9kaWVzIGZvciBldmVyeSBvdGhlciByZXF1ZXN0LgogICAgICAgIGxldCBjbGllbnQgPSBBcmM6Om5ldygKICAgICAgICAgICAgVGVzdEJvZGllc0NsaWVudDo6ZGVmYXVsdCgpLndpdGhfYm9kaWVzKGJvZGllcy5jbG9uZSgpKS53aXRoX2VtcHR5X3Jlc3BvbnNlcygyKSwKICAgICAgICApOwoKICAgICAgICBsZXQgbXV0IGRvd25sb2FkZXIgPSBCb2RpZXNEb3dubG9hZGVyQnVpbGRlcjo6ZGVmYXVsdCgpCiAgICAgICAgICAgIC53aXRoX3JlcXVlc3RfbGltaXQoMykKICAgICAgICAgICAgLndpdGhfc3RyZWFtX2JhdGNoX3NpemUoMTAwKQogICAgICAgICAgICAuYnVpbGQ6OjxyZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrLCBfLCBfPigKICAgICAgICAgICAgICAgIGNsaWVudC5jbG9uZSgpLAogICAgICAgICAgICAgICAgQXJjOjpuZXcoVGVzdENvbnNlbnN1czo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgICAgIGZhY3RvcnksCiAgICAgICAgICAgICk7CgogICAgICAgIC8vIERvd25sb2FkIHRoZSByZXF1ZXN0ZWQgcmFuZ2UKICAgICAgICBkb3dubG9hZGVyLnNldF9kb3dubG9hZF9yYW5nZSgwLi49OTkpLmV4cGVjdCgiZmFpbGVkIHRvIHNldCBkb3dubG9hZCByYW5nZSIpOwogICAgICAgIGFzc2VydF9tYXRjaGVzISgKICAgICAgICAgICAgZG93bmxvYWRlci5uZXh0KCkuYXdhaXQsCiAgICAgICAgICAgIFNvbWUoT2socmVzKSkgPT4gYXNzZXJ0X2VxIShyZXMsIHppcF9ibG9ja3MoaGVhZGVycy5pdGVyKCkudGFrZSgxMDApLCAmbXV0IGJvZGllcykpCiAgICAgICAgKTsKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L2Rvd25sb2FkZXJzL3NyYy9oZWFkZXJzL3JldmVyc2VfaGVhZGVycy5ycyI+Ci8vISBBIGhlYWRlcnMgZG93bmxvYWRlciB0aGF0IGNhbiBoYW5kbGUgbXVsdGlwbGUgcmVxdWVzdHMgY29uY3VycmVudGx5LgoKdXNlIHN1cGVyOjp0YXNrOjpUYXNrRG93bmxvYWRlcjsKdXNlIGNyYXRlOjptZXRyaWNzOjpIZWFkZXJEb3dubG9hZGVyTWV0cmljczsKdXNlIGFsbG95X2NvbnNlbnN1czo6QmxvY2tIZWFkZXI7CnVzZSBhbGxveV9laXBzOjpCbG9ja0hhc2hPck51bWJlcjsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OntCbG9ja051bWJlciwgU2VhbGFibGUsIEIyNTZ9Owp1c2UgZnV0dXJlczo6e3N0cmVhbTo6U3RyZWFtLCBGdXR1cmVFeHR9Owp1c2UgZnV0dXJlc191dGlsOjp7c3RyZWFtOjpGdXR1cmVzVW5vcmRlcmVkLCBTdHJlYW1FeHR9Owp1c2UgcmF5b246OnByZWx1ZGU6Oio7CnVzZSByZXRoX2NvbmZpZzo6Y29uZmlnOjpIZWFkZXJzQ29uZmlnOwp1c2UgcmV0aF9jb25zZW5zdXM6OkhlYWRlclZhbGlkYXRvcjsKdXNlIHJldGhfbmV0d29ya19wMnA6OnsKICAgIGVycm9yOjp7RG93bmxvYWRFcnJvciwgRG93bmxvYWRSZXN1bHQsIFBlZXJSZXF1ZXN0UmVzdWx0fSwKICAgIGhlYWRlcnM6OnsKICAgICAgICBjbGllbnQ6OntIZWFkZXJzQ2xpZW50LCBIZWFkZXJzUmVxdWVzdH0sCiAgICAgICAgZG93bmxvYWRlcjo6e3ZhbGlkYXRlX2hlYWRlcl9kb3dubG9hZCwgSGVhZGVyRG93bmxvYWRlciwgU3luY1RhcmdldH0sCiAgICAgICAgZXJyb3I6OntIZWFkZXJzRG93bmxvYWRlckVycm9yLCBIZWFkZXJzRG93bmxvYWRlclJlc3VsdH0sCiAgICB9LAogICAgcHJpb3JpdHk6OlByaW9yaXR5LAp9Owp1c2UgcmV0aF9uZXR3b3JrX3BlZXJzOjpQZWVySWQ7CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjp7R290RXhwZWN0ZWQsIFNlYWxlZEhlYWRlcn07CnVzZSByZXRoX3Rhc2tzOjp7VGFza1NwYXduZXIsIFRva2lvVGFza0V4ZWN1dG9yfTsKdXNlIHN0ZDo6ewogICAgY21wOjp7T3JkZXJpbmcsIFJldmVyc2V9LAogICAgY29sbGVjdGlvbnM6OntiaW5hcnlfaGVhcDo6UGVla011dCwgQmluYXJ5SGVhcH0sCiAgICBmdXR1cmU6OkZ1dHVyZSwKICAgIHBpbjo6UGluLAogICAgc3luYzo6QXJjLAogICAgdGFzazo6e3JlYWR5LCBDb250ZXh0LCBQb2xsfSwKfTsKdXNlIHRoaXNlcnJvcjo6RXJyb3I7CnVzZSB0cmFjaW5nOjp7ZGVidWcsIGVycm9yLCB0cmFjZX07CgovLy8gQSBoZXVyaXN0aWMgdGhhdCBpcyB1c2VkIHRvIGRldGVybWluZSB0aGUgbnVtYmVyIG9mIHJlcXVlc3RzIHRoYXQgc2hvdWxkIGJlIHByZXBhcmVkIGZvciBhIHBlZXIuCi8vLyBUaGlzIHNob3VsZCBlbnN1cmUgdGhhdCB0aGVyZSBhcmUgYWx3YXlzIHJlcXVlc3RzIGxpbmVkIHVwIGZvciBwZWVycyB0byBoYW5kbGUgd2hpbGUgdGhlCi8vLyBkb3dubG9hZGVyIGlzIHlpZWxkaW5nIGEgbmV4dCBiYXRjaCBvZiBoZWFkZXJzIHRoYXQgaXMgYmVpbmcgY29tbWl0dGVkIHRvIHRoZSBkYXRhYmFzZS4KY29uc3QgUkVRVUVTVFNfUEVSX1BFRVJfTVVMVElQTElFUjogdXNpemUgPSA1OwoKLy8vIFdyYXBwZXIgZm9yIGludGVybmFsIGRvd25sb2FkZXIgZXJyb3JzLgojW2Rlcml2ZShFcnJvciwgRGVidWcpXQplbnVtIFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckVycm9yPEg6IFNlYWxhYmxlPiB7CiAgICAjW2Vycm9yKHRyYW5zcGFyZW50KV0KICAgIERvd25sb2FkZXIoI1tmcm9tXSBIZWFkZXJzRG93bmxvYWRlckVycm9yPEg+KSwKICAgICNbZXJyb3IodHJhbnNwYXJlbnQpXQogICAgUmVzcG9uc2UoI1tmcm9tXSBCb3g8SGVhZGVyc1Jlc3BvbnNlRXJyb3I+KSwKfQoKaW1wbDxIOiBTZWFsYWJsZT4gRnJvbTxIZWFkZXJzUmVzcG9uc2VFcnJvcj4gZm9yIFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckVycm9yPEg+IHsKICAgIGZuIGZyb20odmFsdWU6IEhlYWRlcnNSZXNwb25zZUVycm9yKSAtPiBTZWxmIHsKICAgICAgICBTZWxmOjpSZXNwb25zZShCb3g6Om5ldyh2YWx1ZSkpCiAgICB9Cn0KCi8vLyBEb3dubG9hZHMgaGVhZGVycyBjb25jdXJyZW50bHkuCi8vLwovLy8gVGhpcyBbYEhlYWRlckRvd25sb2FkZXJgXSBkb3dubG9hZHMgaGVhZGVycyB1c2luZyB0aGUgY29uZmlndXJlZCBbYEhlYWRlcnNDbGllbnRgXS4KLy8vIEhlYWRlcnMgY2FuIGJlIHJlcXVlc3RlZCBieSBoYXNoIG9yIGJsb2NrIG51bWJlciBhbmQgdGFrZSBhIGBsaW1pdGAgcGFyYW1ldGVyLiBUaGlzIGRvd25sb2FkZXIKLy8vIHRyaWVzIHRvIGZpbGwgdGhlIGdhcCBiZXR3ZWVuIHRoZSBsb2NhbCBoZWFkIG9mIHRoZSBub2RlIGFuZCB0aGUgY2hhaW4gdGlwIGJ5IGlzc3VpbmcgbXVsdGlwbGUKLy8vIHJlcXVlc3RzIGF0IGEgdGltZSBidXQgeWllbGRpbmcgdGhlbSBpbiBiYXRjaGVzIG9uIFtgU3RyZWFtOjpwb2xsX25leHRgXS4KLy8vCi8vLyAqKk5vdGU6KiogVGhpcyBkb3dubG9hZGVyIGRvd25sb2FkcyBpbiByZXZlcnNlLCBzZWUgYWxzbwovLy8gW2ByZXRoX25ldHdvcmtfcDJwOjpoZWFkZXJzOjpjbGllbnQ6OkhlYWRlcnNEaXJlY3Rpb25gXSwgdGhpcyBtZWFucyB0aGUgYmF0Y2hlcyBvZiBoZWFkZXJzIHRoYXQKLy8vIHRoaXMgZG93bmxvYWRlciB5aWVsZHMgd2lsbCBzdGFydCBhdCB0aGUgY2hhaW4gdGlwIGFuZCBtb3ZlIHRvd2FyZHMgdGhlIGxvY2FsIGhlYWQ6IGZhbGxpbmcKLy8vIGJsb2NrIG51bWJlcnMuCiNbbXVzdF91c2UgPSAiU3RyZWFtIGRvZXMgbm90aGluZyB1bmxlc3MgcG9sbGVkIl0KI1tkZXJpdmUoRGVidWcpXQpwdWIgc3RydWN0IFJldmVyc2VIZWFkZXJzRG93bmxvYWRlcjxIOiBIZWFkZXJzQ2xpZW50PiB7CiAgICAvLy8gQ29uc2Vuc3VzIGNsaWVudCB1c2VkIHRvIHZhbGlkYXRlIGhlYWRlcnMKICAgIGNvbnNlbnN1czogQXJjPGR5biBIZWFkZXJWYWxpZGF0b3I8SDo6SGVhZGVyPj4sCiAgICAvLy8gQ2xpZW50IHVzZWQgdG8gZG93bmxvYWQgaGVhZGVycy4KICAgIGNsaWVudDogQXJjPEg+LAogICAgLy8vIFRoZSBsb2NhbCBoZWFkIG9mIHRoZSBjaGFpbi4KICAgIGxvY2FsX2hlYWQ6IE9wdGlvbjxTZWFsZWRIZWFkZXI8SDo6SGVhZGVyPj4sCiAgICAvLy8gQmxvY2sgd2Ugd2FudCB0byBjbG9zZSB0aGUgZ2FwIHRvLgogICAgc3luY190YXJnZXQ6IE9wdGlvbjxTeW5jVGFyZ2V0QmxvY2s+LAogICAgLy8vIFRoZSBibG9jayBudW1iZXIgdG8gdXNlIGZvciByZXF1ZXN0cy4KICAgIG5leHRfcmVxdWVzdF9ibG9ja19udW1iZXI6IHU2NCwKICAgIC8vLyBLZWVwcyB0cmFjayBvZiB0aGUgYmxvY2sgd2UgbmVlZCB0byB2YWxpZGF0ZSBuZXh0LgogICAgbG93ZXN0X3ZhbGlkYXRlZF9oZWFkZXI6IE9wdGlvbjxTZWFsZWRIZWFkZXI8SDo6SGVhZGVyPj4sCiAgICAvLy8gVGlwIGJsb2NrIG51bWJlciB0byBzdGFydCB2YWxpZGF0aW5nIGZyb20gKGluIHJldmVyc2UpCiAgICBuZXh0X2NoYWluX3RpcF9ibG9ja19udW1iZXI6IHU2NCwKICAgIC8vLyBUaGUgYmF0Y2ggc2l6ZSBwZXIgb25lIHJlcXVlc3QKICAgIHJlcXVlc3RfbGltaXQ6IHU2NCwKICAgIC8vLyBNaW5pbXVtIGFtb3VudCBvZiByZXF1ZXN0cyB0byBoYW5kbGUgY29uY3VycmVudGx5LgogICAgbWluX2NvbmN1cnJlbnRfcmVxdWVzdHM6IHVzaXplLAogICAgLy8vIE1heGltdW0gYW1vdW50IG9mIHJlcXVlc3RzIHRvIGhhbmRsZSBjb25jdXJyZW50bHkuCiAgICBtYXhfY29uY3VycmVudF9yZXF1ZXN0czogdXNpemUsCiAgICAvLy8gVGhlIG51bWJlciBvZiBibG9jayBoZWFkZXJzIHRvIHJldHVybiBhdCBvbmNlCiAgICBzdHJlYW1fYmF0Y2hfc2l6ZTogdXNpemUsCiAgICAvLy8gTWF4aW11bSBhbW91bnQgb2YgcmVjZWl2ZWQgaGVhZGVycyB0byBidWZmZXIgaW50ZXJuYWxseS4KICAgIG1heF9idWZmZXJlZF9yZXNwb25zZXM6IHVzaXplLAogICAgLy8vIENvbnRhaW5zIHRoZSByZXF1ZXN0IHRvIHJldHJpZXZlIHRoZSBoZWFkZXJzIGZvciB0aGUgc3luYyB0YXJnZXQKICAgIC8vLwogICAgLy8vIFRoaXMgd2lsbCBnaXZlIHVzIHRoZSBibG9jayBudW1iZXIgb2YgdGhlIGBzeW5jX3RhcmdldGAsIGFmdGVyIHdoaWNoIHdlIGNhbiBzZW5kIG11bHRpcGxlCiAgICAvLy8gcmVxdWVzdHMgYXQgYSB0aW1lLgogICAgc3luY190YXJnZXRfcmVxdWVzdDogT3B0aW9uPEhlYWRlcnNSZXF1ZXN0RnV0dXJlPEg6Ok91dHB1dD4+LAogICAgLy8vIHJlcXVlc3RzIGluIHByb2dyZXNzCiAgICBpbl9wcm9ncmVzc19xdWV1ZTogRnV0dXJlc1Vub3JkZXJlZDxIZWFkZXJzUmVxdWVzdEZ1dHVyZTxIOjpPdXRwdXQ+PiwKICAgIC8vLyBCdWZmZXJlZCwgdW52YWxpZGF0ZWQgcmVzcG9uc2VzCiAgICBidWZmZXJlZF9yZXNwb25zZXM6IEJpbmFyeUhlYXA8T3JkZXJlZEhlYWRlcnNSZXNwb25zZTxIOjpIZWFkZXI+PiwKICAgIC8vLyBCdWZmZXJlZCwgX3NvcnRlZF8gYW5kIHZhbGlkYXRlZCBoZWFkZXJzIHJlYWR5IHRvIGJlIHJldHVybmVkLgogICAgLy8vCiAgICAvLy8gTm90ZTogaGVhZGVycyBhcmUgc29ydGVkIGZyb20gaGlnaCB0byBsb3cKICAgIHF1ZXVlZF92YWxpZGF0ZWRfaGVhZGVyczogVmVjPFNlYWxlZEhlYWRlcjxIOjpIZWFkZXI+PiwKICAgIC8vLyBIZWFkZXIgZG93bmxvYWRlciBtZXRyaWNzLgogICAgbWV0cmljczogSGVhZGVyRG93bmxvYWRlck1ldHJpY3MsCn0KCi8vID09PSBpbXBsIFJldmVyc2VIZWFkZXJzRG93bmxvYWRlciA9PT0KCmltcGw8SD4gUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyPEg+CndoZXJlCiAgICBIOiBIZWFkZXJzQ2xpZW50PEhlYWRlcjogcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6QmxvY2tIZWFkZXI+ICsgJ3N0YXRpYywKewogICAgLy8vIENvbnZlbmllbmNlIG1ldGhvZCB0byBjcmVhdGUgYSBbYFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckJ1aWxkZXJgXSB3aXRob3V0IGltcG9ydGluZyBpdAogICAgcHViIGZuIGJ1aWxkZXIoKSAtPiBSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJCdWlsZGVyIHsKICAgICAgICBSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJCdWlsZGVyOjpkZWZhdWx0KCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgYmxvY2sgbnVtYmVyIHRoZSBsb2NhbCBub2RlIGlzIGF0LgogICAgI1tpbmxpbmVdCiAgICBmbiBsb2NhbF9ibG9ja19udW1iZXIoJnNlbGYpIC0+IE9wdGlvbjxCbG9ja051bWJlcj4gewogICAgICAgIHNlbGYubG9jYWxfaGVhZC5hc19yZWYoKS5tYXAofGh8IGgubnVtYmVyKCkpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGV4aXN0aW5nIGxvY2FsIGhlYWQgYmxvY2sgbnVtYmVyCiAgICAvLy8KICAgIC8vLyAjIFBhbmljcwogICAgLy8vCiAgICAvLy8gSWYgdGhlIGxvY2FsIGhlYWQgaGFzIG5vdCBiZWVuIHNldC4KICAgICNbaW5saW5lXQogICAgZm4gZXhpc3RpbmdfbG9jYWxfYmxvY2tfbnVtYmVyKCZzZWxmKSAtPiBCbG9ja051bWJlciB7CiAgICAgICAgc2VsZi5sb2NhbF9oZWFkLmFzX3JlZigpLmV4cGVjdCgiaXMgaW5pdGlhbGl6ZWQiKS5udW1iZXIoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBleGlzdGluZyBzeW5jIHRhcmdldC4KICAgIC8vLwogICAgLy8vICMgUGFuaWNzCiAgICAvLy8KICAgIC8vLyBJZiB0aGUgc3luYyB0YXJnZXQgaGFzIG5ldmVyIGJlZW4gc2V0LgogICAgI1tpbmxpbmVdCiAgICBmbiBleGlzdGluZ19zeW5jX3RhcmdldCgmc2VsZikgLT4gU3luY1RhcmdldEJsb2NrIHsKICAgICAgICBzZWxmLnN5bmNfdGFyZ2V0LmFzX3JlZigpLmV4cGVjdCgiaXMgaW5pdGlhbGl6ZWQiKS5jbG9uZSgpCiAgICB9CgogICAgLy8vIE1heCByZXF1ZXN0cyB0byBoYW5kbGUgYXQgdGhlIHNhbWUgdGltZQogICAgLy8vCiAgICAvLy8gVGhpcyBkZXBlbmRzIG9uIHRoZSBudW1iZXIgb2YgYWN0aXZlIHBlZXJzIGJ1dCB3aWxsIGFsd2F5cyBiZQogICAgLy8vIGBtaW5fY29uY3VycmVudF9yZXF1ZXN0cy4ubWF4X2NvbmN1cnJlbnRfcmVxdWVzdHNgCiAgICAjW2lubGluZV0KICAgIGZuIGNvbmN1cnJlbnRfcmVxdWVzdF9saW1pdCgmc2VsZikgLT4gdXNpemUgewogICAgICAgIGxldCBudW1fcGVlcnMgPSBzZWxmLmNsaWVudC5udW1fY29ubmVjdGVkX3BlZXJzKCk7CgogICAgICAgIC8vIHdlIHRyeSB0byBrZWVwIG1vcmUgcmVxdWVzdHMgdGhhbiBhdmFpbGFibGUgcGVlcnMgYWN0aXZlIHNvIHRoYXQgdGhlcmUncyBhbHdheXMgYQogICAgICAgIC8vIGZvbGxvd3VwIHJlcXVlc3QgYXZhaWxhYmxlIGZvciBhIHBlZXIKICAgICAgICBsZXQgZHluYW1pY190YXJnZXQgPSBudW1fcGVlcnMgKiBSRVFVRVNUU19QRVJfUEVFUl9NVUxUSVBMSUVSOwogICAgICAgIGxldCBtYXhfZHluYW1pYyA9IGR5bmFtaWNfdGFyZ2V0Lm1heChzZWxmLm1pbl9jb25jdXJyZW50X3JlcXVlc3RzKTsKCiAgICAgICAgLy8gSWYgb25seSBhIGZldyBwZWVycyBhcmUgY29ubmVjdGVkIHdlIGtlZXAgaXQgbG93CiAgICAgICAgaWYgbnVtX3BlZXJzIDwgc2VsZi5taW5fY29uY3VycmVudF9yZXF1ZXN0cyB7CiAgICAgICAgICAgIHJldHVybiBtYXhfZHluYW1pYwogICAgICAgIH0KCiAgICAgICAgbWF4X2R5bmFtaWMubWluKHNlbGYubWF4X2NvbmN1cnJlbnRfcmVxdWVzdHMpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIG5leHQgaGVhZGVyIHJlcXVlc3QKICAgIC8vLwogICAgLy8vIFRoaXMgd2lsbCBhZHZhbmNlIHRoZSBjdXJyZW50IGJsb2NrIHRvd2FyZHMgdGhlIGxvY2FsIGhlYWQuCiAgICAvLy8KICAgIC8vLyBSZXR1cm5zIGBOb25lYCBpZiBubyBtb3JlIHJlcXVlc3RzIGFyZSByZXF1aXJlZC4KICAgIGZuIG5leHRfcmVxdWVzdCgmbXV0IHNlbGYpIC0+IE9wdGlvbjxIZWFkZXJzUmVxdWVzdD4gewogICAgICAgIGlmIGxldCBTb21lKGxvY2FsX2hlYWQpID0gc2VsZi5sb2NhbF9ibG9ja19udW1iZXIoKSAmJgogICAgICAgICAgICBzZWxmLm5leHRfcmVxdWVzdF9ibG9ja19udW1iZXIgPiBsb2NhbF9oZWFkCiAgICAgICAgewogICAgICAgICAgICBsZXQgcmVxdWVzdCA9CiAgICAgICAgICAgICAgICBjYWxjX25leHRfcmVxdWVzdChsb2NhbF9oZWFkLCBzZWxmLm5leHRfcmVxdWVzdF9ibG9ja19udW1iZXIsIHNlbGYucmVxdWVzdF9saW1pdCk7CiAgICAgICAgICAgIC8vIG5lZWQgdG8gc2hpZnQgdGhlIHRyYWNrZWQgcmVxdWVzdCBibG9jayBudW1iZXIgYmFzZWQgb24gdGhlIG51bWJlciBvZiByZXF1ZXN0ZWQKICAgICAgICAgICAgLy8gaGVhZGVycyBzbyBmb2xsb3ctdXAgcmVxdWVzdHMgd2lsbCB1c2UgdGhhdCBhcyBzdGFydC4KICAgICAgICAgICAgc2VsZi5uZXh0X3JlcXVlc3RfYmxvY2tfbnVtYmVyIC09IHJlcXVlc3QubGltaXQ7CgogICAgICAgICAgICByZXR1cm4gU29tZShyZXF1ZXN0KQogICAgICAgIH0KCiAgICAgICAgTm9uZQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBuZXh0IGhlYWRlciB0byB1c2UgZm9yIHZhbGlkYXRpb24uCiAgICAvLy8KICAgIC8vLyBTaW5jZSB0aGlzIGRvd25sb2FkZXIgZG93bmxvYWRzIGJsb2NrcyB3aXRoIGZhbGxpbmcgYmxvY2sgbnVtYmVyLCB0aGlzIHdpbGwgcmV0dXJuIHRoZQogICAgLy8vIGxvd2VzdCAoaW4gdGVybXMgb2YgYmxvY2sgbnVtYmVyKSB2YWxpZGF0ZWQgaGVhZGVyLgogICAgLy8vCiAgICAvLy8gVGhpcyBpcyBlaXRoZXIgdGhlIGxhc3QgYHF1ZXVlZF92YWxpZGF0ZWRfaGVhZGVyc2AsIG9yIGlmIGhhcyBiZWVuIGRyYWluZWQgZW50aXJlbHkgdGhlCiAgICAvLy8gYGxvd2VzdF92YWxpZGF0ZWRfaGVhZGVyYC4KICAgIC8vLwogICAgLy8vIFRoaXMgb25seSByZXR1cm5zIGBOb25lYCBpZiB3ZSBoYXZlbid0IGZldGNoZWQgdGhlIGluaXRpYWwgY2hhaW4gdGlwIHlldC4KICAgIGZuIGxvd2VzdF92YWxpZGF0ZWRfaGVhZGVyKCZzZWxmKSAtPiBPcHRpb248JlNlYWxlZEhlYWRlcjxIOjpIZWFkZXI+PiB7CiAgICAgICAgc2VsZi5xdWV1ZWRfdmFsaWRhdGVkX2hlYWRlcnMubGFzdCgpLm9yKHNlbGYubG93ZXN0X3ZhbGlkYXRlZF9oZWFkZXIuYXNfcmVmKCkpCiAgICB9CgogICAgLy8vIFJlc2V0cyB0aGUgcmVxdWVzdCB0cmFja2VycyBhbmQgY2xlYXJzIHRoZSBzeW5jIHRhcmdldC4KICAgIC8vLwogICAgLy8vIFRoaXMgZW5zdXJlcyB0aGUgZG93bmxvYWRlciB3aWxsIHJlc3RhcnQgYWZ0ZXIgYSBuZXcgc3luYyB0YXJnZXQgaGFzIGJlZW4gc2V0LgogICAgZm4gcmVzZXQoJm11dCBzZWxmKSB7CiAgICAgICAgZGVidWchKHRhcmdldDogImRvd25sb2FkZXJzOjpoZWFkZXJzIiwgIlJlc2V0dGluZyBoZWFkZXJzIGRvd25sb2FkZXIiKTsKICAgICAgICBzZWxmLm5leHRfcmVxdWVzdF9ibG9ja19udW1iZXIgPSAwOwogICAgICAgIHNlbGYubmV4dF9jaGFpbl90aXBfYmxvY2tfbnVtYmVyID0gMDsKICAgICAgICBzZWxmLnN5bmNfdGFyZ2V0LnRha2UoKTsKICAgIH0KCiAgICAvLy8gVmFsaWRhdGUgdGhhdCB0aGUgcmVjZWl2ZWQgaGVhZGVyIG1hdGNoZXMgdGhlIGV4cGVjdGVkIHN5bmMgdGFyZ2V0LgogICAgZm4gdmFsaWRhdGVfc3luY190YXJnZXQoCiAgICAgICAgJnNlbGYsCiAgICAgICAgaGVhZGVyOiAmU2VhbGVkSGVhZGVyPEg6OkhlYWRlcj4sCiAgICAgICAgcmVxdWVzdDogSGVhZGVyc1JlcXVlc3QsCiAgICAgICAgcGVlcl9pZDogUGVlcklkLAogICAgKSAtPiBSZXN1bHQ8KCksIEJveDxIZWFkZXJzUmVzcG9uc2VFcnJvcj4+IHsKICAgICAgICBtYXRjaCBzZWxmLmV4aXN0aW5nX3N5bmNfdGFyZ2V0KCkgewogICAgICAgICAgICBTeW5jVGFyZ2V0QmxvY2s6Okhhc2goaGFzaCkgfCBTeW5jVGFyZ2V0QmxvY2s6Okhhc2hBbmROdW1iZXIgeyBoYXNoLCAuLiB9CiAgICAgICAgICAgICAgICBpZiBoZWFkZXIuaGFzaCgpICE9IGhhc2ggPT4KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgRXJyKEJveDo6bmV3KEhlYWRlcnNSZXNwb25zZUVycm9yIHsKICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LAogICAgICAgICAgICAgICAgICAgIHBlZXJfaWQ6IFNvbWUocGVlcl9pZCksCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IERvd25sb2FkRXJyb3I6OkludmFsaWRUaXAoCiAgICAgICAgICAgICAgICAgICAgICAgIEdvdEV4cGVjdGVkIHsgZ290OiBoZWFkZXIuaGFzaCgpLCBleHBlY3RlZDogaGFzaCB9LmludG8oKSwKICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgfSkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgU3luY1RhcmdldEJsb2NrOjpOdW1iZXIobnVtYmVyKSBpZiBoZWFkZXIubnVtYmVyKCkgIT0gbnVtYmVyID0+IHsKICAgICAgICAgICAgICAgIEVycihCb3g6Om5ldyhIZWFkZXJzUmVzcG9uc2VFcnJvciB7CiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICBwZWVyX2lkOiBTb21lKHBlZXJfaWQpLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBEb3dubG9hZEVycm9yOjpJbnZhbGlkVGlwTnVtYmVyKEdvdEV4cGVjdGVkIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ290OiBoZWFkZXIubnVtYmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkOiBudW1iZXIsCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IE9rKCgpKSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIFByb2Nlc3NlcyB0aGUgbmV4dCBoZWFkZXJzIGluIGxpbmUuCiAgICAvLy8KICAgIC8vLyBUaGlzIHdpbGwgdmFsaWRhdGUgYWxsIGhlYWRlcnMgYW5kIGluc2VydCB0aGVtIGludG8gdGhlIHZhbGlkYXRlZCBidWZmZXIuCiAgICAvLy8KICAgIC8vLyBSZXR1cm5zIGFuIGVycm9yIGlmIHRoZSBnaXZlbiBoZWFkZXJzIGFyZSBpbnZhbGlkLgogICAgLy8vCiAgICAvLy8gQ2F1dGlvbjogdGhpcyBleHBlY3RzIHRoZSBgaGVhZGVyc2AgdG8gYmUgc29ydGVkIHdpdGggX2ZhbGxpbmdfIGJsb2NrIG51bWJlcnMKICAgIGZuIHByb2Nlc3NfbmV4dF9oZWFkZXJzKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICByZXF1ZXN0OiBIZWFkZXJzUmVxdWVzdCwKICAgICAgICBoZWFkZXJzOiBWZWM8SDo6SGVhZGVyPiwKICAgICAgICBwZWVyX2lkOiBQZWVySWQsCiAgICApIC0+IFJlc3VsdDwoKSwgUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyRXJyb3I8SDo6SGVhZGVyPj4gewogICAgICAgIGxldCBtdXQgdmFsaWRhdGVkID0gVmVjOjp3aXRoX2NhcGFjaXR5KGhlYWRlcnMubGVuKCkpOwoKICAgICAgICBsZXQgc2VhbGVkX2hlYWRlcnMgPQogICAgICAgICAgICBoZWFkZXJzLmludG9fcGFyX2l0ZXIoKS5tYXAoU2VhbGVkSGVhZGVyOjpzZWFsX3Nsb3cpLmNvbGxlY3Q6OjxWZWM8Xz4+KCk7CiAgICAgICAgZm9yIHBhcmVudCBpbiBzZWFsZWRfaGVhZGVycyB7CiAgICAgICAgICAgIC8vIFZhbGlkYXRlIHRoYXQgdGhlIGhlYWRlciBpcyB0aGUgcGFyZW50IGhlYWRlciBvZiB0aGUgbGFzdCB2YWxpZGF0ZWQgaGVhZGVyLgogICAgICAgICAgICBpZiBsZXQgU29tZSh2YWxpZGF0ZWRfaGVhZGVyKSA9CiAgICAgICAgICAgICAgICB2YWxpZGF0ZWQubGFzdCgpLm9yX2Vsc2UofHwgc2VsZi5sb3dlc3RfdmFsaWRhdGVkX2hlYWRlcigpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiBsZXQgRXJyKGVycm9yKSA9IHNlbGYudmFsaWRhdGUodmFsaWRhdGVkX2hlYWRlciwgJnBhcmVudCkgewogICAgICAgICAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6aGVhZGVycyIsICVlcnJvciAsIkZhaWxlZCB0byB2YWxpZGF0ZSBoZWFkZXIiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRXJyKAogICAgICAgICAgICAgICAgICAgICAgICBIZWFkZXJzUmVzcG9uc2VFcnJvciB7IHJlcXVlc3QsIHBlZXJfaWQ6IFNvbWUocGVlcl9pZCksIGVycm9yIH0uaW50bygpCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VsZi52YWxpZGF0ZV9zeW5jX3RhcmdldCgmcGFyZW50LCByZXF1ZXN0LmNsb25lKCksIHBlZXJfaWQpPzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFsaWRhdGVkLnB1c2gocGFyZW50KTsKICAgICAgICB9CgogICAgICAgIC8vIElmIHRoZSBsYXN0IChzbWFsbGVzdCkgdmFsaWRhdGVkIGhlYWRlciBhdHRhY2hlcyB0byB0aGUgbG9jYWwgaGVhZCwgdmFsaWRhdGUgaXQuCiAgICAgICAgaWYgbGV0IFNvbWUoKGxhc3RfaGVhZGVyLCBoZWFkKSkgPSB2YWxpZGF0ZWQKICAgICAgICAgICAgLmxhc3RfbXV0KCkKICAgICAgICAgICAgLnppcChzZWxmLmxvY2FsX2hlYWQuYXNfcmVmKCkpCiAgICAgICAgICAgIC5maWx0ZXIofChsYXN0LCBoZWFkKXwgbGFzdC5udW1iZXIoKSA9PSBoZWFkLm51bWJlcigpICsgMSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIEV2ZXJ5IGhlYWRlciBtdXN0IGJlIHZhbGlkIG9uIGl0cyBvd24KICAgICAgICAgICAgaWYgbGV0IEVycihlcnJvcikgPSBzZWxmLmNvbnNlbnN1cy52YWxpZGF0ZV9oZWFkZXIoJipsYXN0X2hlYWRlcikgewogICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogImRvd25sb2FkZXJzOjpoZWFkZXJzIiwgJWVycm9yLCAiRmFpbGVkIHRvIHZhbGlkYXRlIGhlYWRlciIpOwogICAgICAgICAgICAgICAgcmV0dXJuIEVycihIZWFkZXJzUmVzcG9uc2VFcnJvciB7CiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICBwZWVyX2lkOiBTb21lKHBlZXJfaWQpLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBEb3dubG9hZEVycm9yOjpIZWFkZXJWYWxpZGF0aW9uIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGFzaDogaGVhZC5oYXNoKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogaGVhZC5udW1iZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IEJveDo6bmV3KGVycm9yKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLmludG8oKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgdGhlIGhlYWRlciBpcyB2YWxpZCBvbiBpdHMgb3duLCBidXQgbm90IGFnYWluc3QgaXRzIHBhcmVudCwgd2UgcmV0dXJuIGl0IGFzCiAgICAgICAgICAgIC8vIGRldGFjaGVkIGhlYWQgZXJyb3IuCiAgICAgICAgICAgIC8vIEluIHN0YWdlIHN5bmMgdGhpcyB3aWxsIHRyaWdnZXIgYW4gdW53aW5kIGJlY2F1c2UgdGhpcyBtZWFucyB0aGF0IHRoZSBsb2NhbCBoZWFkCiAgICAgICAgICAgIC8vIGlzIG5vdCBwYXJ0IG9mIHRoZSBjaGFpbiB0aGUgc3luYyB0YXJnZXQgaXMgb24uIEluIG90aGVyIHdvcmRzLCB0aGUgZG93bmxvYWRlciB3YXMKICAgICAgICAgICAgLy8gdW5hYmxlIHRvIGNvbm5lY3QgdGhlIHN5bmMgdGFyZ2V0IHdpdGggdGhlIGxvY2FsIGhlYWQgYmVjYXVzZSB0aGUgc3luYyB0YXJnZXQgYW5kCiAgICAgICAgICAgIC8vIHRoZSBsb2NhbCBoZWFkIG9yIG9uIGRpZmZlcmVudCBjaGFpbnMuCiAgICAgICAgICAgIGlmIGxldCBFcnIoZXJyb3IpID0gc2VsZi5jb25zZW5zdXMudmFsaWRhdGVfaGVhZGVyX2FnYWluc3RfcGFyZW50KCYqbGFzdF9oZWFkZXIsIGhlYWQpIHsKICAgICAgICAgICAgICAgIGxldCBsb2NhbF9oZWFkID0gaGVhZC5jbG9uZSgpOwogICAgICAgICAgICAgICAgLy8gUmVwbGFjZSB0aGUgbGFzdCBoZWFkZXIgd2l0aCBhIGRldGFjaGVkIHZhcmlhbnQKICAgICAgICAgICAgICAgIGVycm9yISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6aGVhZGVycyIsICVlcnJvciwgbnVtYmVyID0gbGFzdF9oZWFkZXIubnVtYmVyKCksIGhhc2ggPSA/bGFzdF9oZWFkZXIuaGFzaCgpLCAiSGVhZGVyIGNhbm5vdCBiZSBhdHRhY2hlZCB0byBrbm93biBjYW5vbmljYWwgY2hhaW4iKTsKCiAgICAgICAgICAgICAgICAvLyBSZXNldCB0cmFja2VycyBzbyB0aGF0IHdlIGNhbiBzdGFydCBvdmVyIHRoZSBuZXh0IHRpbWUgdGhlIHN5bmMgdGFyZ2V0IGlzCiAgICAgICAgICAgICAgICAvLyB1cGRhdGVkLgogICAgICAgICAgICAgICAgLy8gVGhlIGV4cGVjdGVkIGV2ZW50IGZsb3cgd2hlbiB0aGF0IGhhcHBlbnMgaXMgdGhhdCB0aGUgbm9kZSB3aWxsIHVud2luZCB0aGUgbG9jYWwKICAgICAgICAgICAgICAgIC8vIGNoYWluIGFuZCByZXN0YXJ0IHRoZSBkb3dubG9hZGVyLgogICAgICAgICAgICAgICAgc2VsZi5yZXNldCgpOwoKICAgICAgICAgICAgICAgIHJldHVybiBFcnIoSGVhZGVyc0Rvd25sb2FkZXJFcnJvcjo6RGV0YWNoZWRIZWFkIHsKICAgICAgICAgICAgICAgICAgICBsb2NhbF9oZWFkOiBCb3g6Om5ldyhsb2NhbF9oZWFkKSwKICAgICAgICAgICAgICAgICAgICBoZWFkZXI6IEJveDo6bmV3KGxhc3RfaGVhZGVyLmNsb25lKCkpLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBCb3g6Om5ldyhlcnJvciksCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAuaW50bygpKQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyB1cGRhdGUgdHJhY2tlZCBibG9jayBpbmZvIChmYWxsaW5nIGJsb2NrIG51bWJlcikKICAgICAgICBzZWxmLm5leHRfY2hhaW5fdGlwX2Jsb2NrX251bWJlciA9CiAgICAgICAgICAgIHZhbGlkYXRlZC5sYXN0KCkuZXhwZWN0KCJleGlzdHMiKS5udW1iZXIoKS5zYXR1cmF0aW5nX3N1YigxKTsKICAgICAgICBzZWxmLnF1ZXVlZF92YWxpZGF0ZWRfaGVhZGVycy5leHRlbmQodmFsaWRhdGVkKTsKCiAgICAgICAgT2soKCkpCiAgICB9CgogICAgLy8vIFVwZGF0ZXMgdGhlIHN0YXRlIGJhc2VkIG9uIHRoZSBnaXZlbiBgdGFyZ2V0X2Jsb2NrX251bWJlcmAKICAgIC8vLwogICAgLy8vIFRoZXJlIGFyZSB0aHJlZSBkaWZmZXJlbnQgb3V0Y29tZXM6CiAgICAvLy8gICogVGhpcyBpcyB0aGUgZmlyc3QgdGltZSB0aGlzIGlzIGNhbGxlZDogY3VycmVudCBgc3luY190YXJnZXRgIGJsb2NrIGlzIHN0aWxsIGBOb25lYC4gSW4KICAgIC8vLyAgICB3aGljaCBjYXNlIHdlJ3JlIGluaXRpYWxpemluZyB0aGUgcmVxdWVzdCB0cmFja2VycyB0byBgbmV4dF9ibG9ja2AKICAgIC8vLyAgKiBUaGUgYHRhcmdldF9ibG9ja19udW1iZXJgIGlzIF9oaWdoZXJfIHRoYW4gdGhlIGN1cnJlbnQgdGFyZ2V0LiBJbiB3aGljaCBjYXNlIHdlIHN0YXJ0CiAgICAvLy8gICAgb3ZlciB3aXRoIGEgbmV3IHJhbmdlCiAgICAvLy8gICogVGhlIGB0YXJnZXRfYmxvY2tfbnVtYmVyYCBpcyBfbG93ZXJfIHRoYW4gdGhlIGN1cnJlbnQgdGFyZ2V0IG9yIHRoZSBfc2FtZV8uIEluIHdoaWNoIGNhc2UKICAgIC8vLyAgICB3ZSBkb24ndCBuZWVkIHRvIHVwZGF0ZSB0aGUgcmVxdWVzdCB0cmFja2VycyBidXQgbmVlZCB0byBlbnN1cmUgYWxyZWFkeSBidWZmZXJlZCBoZWFkZXJzCiAgICAvLy8gICAgYXJlIF9ub3RfIGhpZ2hlciB0aGFuIHRoZSBuZXcgYHRhcmdldF9ibG9ja19udW1iZXJgLgogICAgZm4gb25fYmxvY2tfbnVtYmVyX3VwZGF0ZSgmbXV0IHNlbGYsIHRhcmdldF9ibG9ja19udW1iZXI6IHU2NCwgbmV4dF9ibG9jazogdTY0KSB7CiAgICAgICAgLy8gVXBkYXRlIHRoZSB0cmFja2VycwogICAgICAgIGlmIGxldCBTb21lKG9sZF90YXJnZXQpID0KICAgICAgICAgICAgc2VsZi5zeW5jX3RhcmdldC5hc19tdXQoKS5hbmRfdGhlbih8dHwgdC5yZXBsYWNlX251bWJlcih0YXJnZXRfYmxvY2tfbnVtYmVyKSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIHRhcmdldF9ibG9ja19udW1iZXIgPiBvbGRfdGFyZ2V0IHsKICAgICAgICAgICAgICAgIC8vIHRoZSBuZXcgdGFyZ2V0IGlzIGhpZ2hlciB0aGFuIHRoZSBvbGQgdGFyZ2V0IHdlIG5lZWQgdG8gdXBkYXRlIHRoZQogICAgICAgICAgICAgICAgLy8gcmVxdWVzdCB0cmFja2VyIGFuZCByZXNldCBldmVyeXRoaW5nCiAgICAgICAgICAgICAgICBzZWxmLm5leHRfcmVxdWVzdF9ibG9ja19udW1iZXIgPSBuZXh0X2Jsb2NrOwogICAgICAgICAgICAgICAgc2VsZi5uZXh0X2NoYWluX3RpcF9ibG9ja19udW1iZXIgPSBuZXh0X2Jsb2NrOwogICAgICAgICAgICAgICAgc2VsZi5jbGVhcigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gZW5zdXJlIGFscmVhZHkgdmFsaWRhdGVkIGhlYWRlcnMgYXJlIGluIHJhbmdlCiAgICAgICAgICAgICAgICBsZXQgc2tpcCA9IHNlbGYKICAgICAgICAgICAgICAgICAgICAucXVldWVkX3ZhbGlkYXRlZF9oZWFkZXJzCiAgICAgICAgICAgICAgICAgICAgLml0ZXIoKQogICAgICAgICAgICAgICAgICAgIC50YWtlX3doaWxlKHxsYXN0fCBsYXN0Lm51bWJlcigpID4gdGFyZ2V0X2Jsb2NrX251bWJlcikKICAgICAgICAgICAgICAgICAgICAuY291bnQoKTsKICAgICAgICAgICAgICAgIC8vIHJlbW92ZXMgYWxsIGhlYWRlcnMgdGhhdCBhcmUgaGlnaGVyIHRoYW4gY3VycmVudCB0YXJnZXQKICAgICAgICAgICAgICAgIHNlbGYucXVldWVkX3ZhbGlkYXRlZF9oZWFkZXJzLmRyYWluKC4uc2tpcCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyB0aGlzIG9jY3VycyBvbiB0aGUgaW5pdGlhbCBzeW5jIHRhcmdldCByZXF1ZXN0CiAgICAgICAgICAgIHNlbGYubmV4dF9yZXF1ZXN0X2Jsb2NrX251bWJlciA9IG5leHRfYmxvY2s7CiAgICAgICAgICAgIHNlbGYubmV4dF9jaGFpbl90aXBfYmxvY2tfbnVtYmVyID0gbmV4dF9ibG9jazsKICAgICAgICB9CiAgICB9CgogICAgLy8vIEhhbmRsZXMgdGhlIHJlc3BvbnNlIGZvciB0aGUgcmVxdWVzdCBmb3IgdGhlIHN5bmMgdGFyZ2V0CiAgICBmbiBvbl9zeW5jX3RhcmdldF9vdXRjb21lKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICByZXNwb25zZTogSGVhZGVyc1JlcXVlc3RPdXRjb21lPEg6OkhlYWRlcj4sCiAgICApIC0+IFJlc3VsdDwoKSwgUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyRXJyb3I8SDo6SGVhZGVyPj4gewogICAgICAgIGxldCBzeW5jX3RhcmdldCA9IHNlbGYuZXhpc3Rpbmdfc3luY190YXJnZXQoKTsKICAgICAgICBsZXQgSGVhZGVyc1JlcXVlc3RPdXRjb21lIHsgcmVxdWVzdCwgb3V0Y29tZSB9ID0gcmVzcG9uc2U7CiAgICAgICAgbWF0Y2ggb3V0Y29tZSB7CiAgICAgICAgICAgIE9rKHJlcykgPT4gewogICAgICAgICAgICAgICAgbGV0IChwZWVyX2lkLCBtdXQgaGVhZGVycykgPSByZXMuc3BsaXQoKTsKCiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgdG90YWwgZG93bmxvYWRlZCBtZXRyaWMKICAgICAgICAgICAgICAgIHNlbGYubWV0cmljcy50b3RhbF9kb3dubG9hZGVkLmluY3JlbWVudChoZWFkZXJzLmxlbigpIGFzIHU2NCk7CgogICAgICAgICAgICAgICAgLy8gc29ydCBoZWFkZXJzIGZyb20gaGlnaGVzdCB0byBsb3dlc3QgYmxvY2sgbnVtYmVyCiAgICAgICAgICAgICAgICBoZWFkZXJzLnNvcnRfdW5zdGFibGVfYnlfa2V5KHxofCBSZXZlcnNlKGgubnVtYmVyKCkpKTsKCiAgICAgICAgICAgICAgICBpZiBoZWFkZXJzLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBFcnIoSGVhZGVyc1Jlc3BvbnNlRXJyb3IgewogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LAogICAgICAgICAgICAgICAgICAgICAgICBwZWVyX2lkOiBTb21lKHBlZXJfaWQpLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogRG93bmxvYWRFcnJvcjo6RW1wdHlSZXNwb25zZSwKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLmludG8oKSkKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBsZXQgaGVhZGVyID0gaGVhZGVycy5zd2FwX3JlbW92ZSgwKTsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXQgPSBTZWFsZWRIZWFkZXI6OnNlYWxfc2xvdyhoZWFkZXIpOwoKICAgICAgICAgICAgICAgIG1hdGNoIHN5bmNfdGFyZ2V0IHsKICAgICAgICAgICAgICAgICAgICBTeW5jVGFyZ2V0QmxvY2s6Okhhc2goaGFzaCkgfCBTeW5jVGFyZ2V0QmxvY2s6Okhhc2hBbmROdW1iZXIgeyBoYXNoLCAuLiB9ID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdGFyZ2V0Lmhhc2goKSAhPSBoYXNoIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBFcnIoSGVhZGVyc1Jlc3BvbnNlRXJyb3IgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVlcl9pZDogU29tZShwZWVyX2lkKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogRG93bmxvYWRFcnJvcjo6SW52YWxpZFRpcCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgR290RXhwZWN0ZWQgeyBnb3Q6IHRhcmdldC5oYXNoKCksIGV4cGVjdGVkOiBoYXNoIH0uaW50bygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuaW50bygpKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIFN5bmNUYXJnZXRCbG9jazo6TnVtYmVyKG51bWJlcikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiB0YXJnZXQubnVtYmVyKCkgIT0gbnVtYmVyIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBFcnIoSGVhZGVyc1Jlc3BvbnNlRXJyb3IgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVlcl9pZDogU29tZShwZWVyX2lkKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogRG93bmxvYWRFcnJvcjo6SW52YWxpZFRpcE51bWJlcihHb3RFeHBlY3RlZCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdvdDogdGFyZ2V0Lm51bWJlcigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3RlZDogbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmludG8oKSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmhlYWRlcnMiLCBoZWFkPT9zZWxmLmxvY2FsX2Jsb2NrX251bWJlcigpLCBoYXNoPT90YXJnZXQuaGFzaCgpLCBudW1iZXI9JXRhcmdldC5udW1iZXIoKSwgIlJlY2VpdmVkIHN5bmMgdGFyZ2V0Iik7CgogICAgICAgICAgICAgICAgLy8gVGhpcyBpcyB0aGUgbmV4dCBibG9jayB3ZSBuZWVkIHRvIHN0YXJ0IGlzc3VpbmcgcmVxdWVzdHMgZnJvbQogICAgICAgICAgICAgICAgbGV0IHBhcmVudF9ibG9ja19udW1iZXIgPSB0YXJnZXQubnVtYmVyKCkuc2F0dXJhdGluZ19zdWIoMSk7CiAgICAgICAgICAgICAgICBzZWxmLm9uX2Jsb2NrX251bWJlcl91cGRhdGUodGFyZ2V0Lm51bWJlcigpLCBwYXJlbnRfYmxvY2tfbnVtYmVyKTsKCiAgICAgICAgICAgICAgICBzZWxmLnF1ZXVlZF92YWxpZGF0ZWRfaGVhZGVycy5wdXNoKHRhcmdldCk7CgogICAgICAgICAgICAgICAgLy8gdHJ5IHRvIHZhbGlkYXRlIGFsbCBidWZmZXJlZCByZXNwb25zZXMgYmxvY2tlZCBieSB0aGlzIHN1Y2Nlc3NmdWwgcmVzcG9uc2UKICAgICAgICAgICAgICAgIHNlbGYudHJ5X3ZhbGlkYXRlX2J1ZmZlcmVkKCkKICAgICAgICAgICAgICAgICAgICAubWFwKEVycjo6PCgpLCBSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJFcnJvcjxIOjpIZWFkZXI+PikKICAgICAgICAgICAgICAgICAgICAudHJhbnNwb3NlKCk/OwoKICAgICAgICAgICAgICAgIE9rKCgpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycihlcnIpID0+IHsKICAgICAgICAgICAgICAgIEVycihIZWFkZXJzUmVzcG9uc2VFcnJvciB7IHJlcXVlc3QsIHBlZXJfaWQ6IE5vbmUsIGVycm9yOiBlcnIuaW50bygpIH0uaW50bygpKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBJbnZva2VkIHdoZW4gd2UgcmVjZWl2ZWQgYSByZXNwb25zZQogICAgZm4gb25faGVhZGVyc19vdXRjb21lKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICByZXNwb25zZTogSGVhZGVyc1JlcXVlc3RPdXRjb21lPEg6OkhlYWRlcj4sCiAgICApIC0+IFJlc3VsdDwoKSwgUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyRXJyb3I8SDo6SGVhZGVyPj4gewogICAgICAgIGxldCByZXF1ZXN0ZWRfYmxvY2tfbnVtYmVyID0gcmVzcG9uc2UuYmxvY2tfbnVtYmVyKCk7CiAgICAgICAgbGV0IEhlYWRlcnNSZXF1ZXN0T3V0Y29tZSB7IHJlcXVlc3QsIG91dGNvbWUgfSA9IHJlc3BvbnNlOwoKICAgICAgICBtYXRjaCBvdXRjb21lIHsKICAgICAgICAgICAgT2socmVzKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgKHBlZXJfaWQsIG11dCBoZWFkZXJzKSA9IHJlcy5zcGxpdCgpOwoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSB0b3RhbCBkb3dubG9hZGVkIG1ldHJpYwogICAgICAgICAgICAgICAgc2VsZi5tZXRyaWNzLnRvdGFsX2Rvd25sb2FkZWQuaW5jcmVtZW50KGhlYWRlcnMubGVuKCkgYXMgdTY0KTsKCiAgICAgICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmhlYWRlcnMiLCBsZW49JWhlYWRlcnMubGVuKCksICJSZWNlaXZlZCBoZWFkZXJzIHJlc3BvbnNlIik7CgogICAgICAgICAgICAgICAgaWYgaGVhZGVycy5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRXJyKEhlYWRlcnNSZXNwb25zZUVycm9yIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgcGVlcl9pZDogU29tZShwZWVyX2lkKSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IERvd25sb2FkRXJyb3I6OkVtcHR5UmVzcG9uc2UsCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC5pbnRvKCkpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGhlYWRlcnMubGVuKCkgYXMgdTY0KSAhPSByZXF1ZXN0LmxpbWl0IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRXJyKEhlYWRlcnNSZXNwb25zZUVycm9yIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGVlcl9pZDogU29tZShwZWVyX2lkKSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IERvd25sb2FkRXJyb3I6OkhlYWRlcnNSZXNwb25zZVRvb1Nob3J0KEdvdEV4cGVjdGVkIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdvdDogaGVhZGVycy5sZW4oKSBhcyB1NjQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3RlZDogcmVxdWVzdC5saW1pdCwKICAgICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QsCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC5pbnRvKCkpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc29ydCBoZWFkZXJzIGZyb20gaGlnaGVzdCB0byBsb3dlc3QgYmxvY2sgbnVtYmVyCiAgICAgICAgICAgICAgICBoZWFkZXJzLnNvcnRfdW5zdGFibGVfYnlfa2V5KHxofCBSZXZlcnNlKGgubnVtYmVyKCkpKTsKCiAgICAgICAgICAgICAgICAvLyB2YWxpZGF0ZSB0aGUgcmVzcG9uc2UKICAgICAgICAgICAgICAgIGxldCBoaWdoZXN0ID0gJmhlYWRlcnNbMF07CgogICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogImRvd25sb2FkZXJzOjpoZWFkZXJzIiwgcmVxdWVzdGVkX2Jsb2NrX251bWJlciwgaGlnaGVzdD0/aGlnaGVzdC5udW1iZXIoKSwgIlZhbGlkYXRpbmcgbm9uLWVtcHR5IGhlYWRlcnMgcmVzcG9uc2UiKTsKCiAgICAgICAgICAgICAgICBpZiBoaWdoZXN0Lm51bWJlcigpICE9IHJlcXVlc3RlZF9ibG9ja19udW1iZXIgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBFcnIoSGVhZGVyc1Jlc3BvbnNlRXJyb3IgewogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LAogICAgICAgICAgICAgICAgICAgICAgICBwZWVyX2lkOiBTb21lKHBlZXJfaWQpLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogRG93bmxvYWRFcnJvcjo6SGVhZGVyc1Jlc3BvbnNlU3RhcnRCbG9ja01pc21hdGNoKEdvdEV4cGVjdGVkIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdvdDogaGlnaGVzdC5udW1iZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkOiByZXF1ZXN0ZWRfYmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLmludG8oKSkKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiB0aGUgcmVzcG9uc2UgaXMgdGhlIG5leHQgZXhwZWN0ZWQKICAgICAgICAgICAgICAgIGlmIGhpZ2hlc3QubnVtYmVyKCkgPT0gc2VsZi5uZXh0X2NoYWluX3RpcF9ibG9ja19udW1iZXIgewogICAgICAgICAgICAgICAgICAgIC8vIGlzIG5leHQgcmVzcG9uc2UsIHZhbGlkYXRlIGl0CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm9jZXNzX25leHRfaGVhZGVycyhyZXF1ZXN0LCBoZWFkZXJzLCBwZWVyX2lkKT87CiAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IHRvIHZhbGlkYXRlIGFsbCBidWZmZXJlZCByZXNwb25zZXMgYmxvY2tlZCBieSB0aGlzIHN1Y2Nlc3NmdWwgcmVzcG9uc2UKICAgICAgICAgICAgICAgICAgICBzZWxmLnRyeV92YWxpZGF0ZV9idWZmZXJlZCgpCiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoRXJyOjo8KCksIFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckVycm9yPEg6OkhlYWRlcj4+KQogICAgICAgICAgICAgICAgICAgICAgICAudHJhbnNwb3NlKCk/OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIGhpZ2hlc3QubnVtYmVyKCkgPiBzZWxmLmV4aXN0aW5nX2xvY2FsX2Jsb2NrX251bWJlcigpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLm1ldHJpY3MuYnVmZmVyZWRfcmVzcG9uc2VzLmluY3JlbWVudCgxLik7CiAgICAgICAgICAgICAgICAgICAgLy8gY2FuJ3QgdmFsaWRhdGUgeWV0CiAgICAgICAgICAgICAgICAgICAgc2VsZi5idWZmZXJlZF9yZXNwb25zZXMucHVzaChPcmRlcmVkSGVhZGVyc1Jlc3BvbnNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgcGVlcl9pZCwKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIE9rKCgpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG1vc3QgbGlrZWx5IGEgbm9vcCwgYmVjYXVzZSB0aGlzIGVycm9yCiAgICAgICAgICAgIC8vIHdvdWxkJ3ZlIGJlZW4gaGFuZGxlZCBieSB0aGUgZmV0Y2hlciBpbnRlcm5hbGx5CiAgICAgICAgICAgIEVycihlcnIpID0+IHsKICAgICAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6aGVhZGVycyIsICVlcnIsICJSZXNwb25zZSBlcnJvciIpOwogICAgICAgICAgICAgICAgRXJyKEhlYWRlcnNSZXNwb25zZUVycm9yIHsgcmVxdWVzdCwgcGVlcl9pZDogTm9uZSwgZXJyb3I6IGVyci5pbnRvKCkgfS5pbnRvKCkpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZm4gcGVuYWxpemVfcGVlcigmc2VsZiwgcGVlcl9pZDogT3B0aW9uPFBlZXJJZD4sIGVycm9yOiAmRG93bmxvYWRFcnJvcikgewogICAgICAgIC8vIFBlbmFsaXplIHRoZSBwZWVyIGZvciBiYWQgcmVzcG9uc2UKICAgICAgICBpZiBsZXQgU29tZShwZWVyX2lkKSA9IHBlZXJfaWQgewogICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmhlYWRlcnMiLCA/cGVlcl9pZCwgJWVycm9yLCAiUGVuYWxpemluZyBwZWVyIik7CiAgICAgICAgICAgIHNlbGYuY2xpZW50LnJlcG9ydF9iYWRfbWVzc2FnZShwZWVyX2lkKTsKICAgICAgICB9CiAgICB9CgogICAgLy8vIEhhbmRsZXMgdGhlIGVycm9yIG9mIGEgYmFkIHJlc3BvbnNlCiAgICAvLy8KICAgIC8vLyBUaGlzIHdpbGwgcmUtc3VibWl0IHRoZSByZXF1ZXN0LgogICAgZm4gb25faGVhZGVyc19lcnJvcigmc2VsZiwgZXJyOiBCb3g8SGVhZGVyc1Jlc3BvbnNlRXJyb3I+KSB7CiAgICAgICAgbGV0IEhlYWRlcnNSZXNwb25zZUVycm9yIHsgcmVxdWVzdCwgcGVlcl9pZCwgZXJyb3IgfSA9ICplcnI7CgogICAgICAgIHNlbGYucGVuYWxpemVfcGVlcihwZWVyX2lkLCAmZXJyb3IpOwoKICAgICAgICAvLyBVcGRhdGUgZXJyb3IgbWV0cmljCiAgICAgICAgc2VsZi5tZXRyaWNzLmluY3JlbWVudF9lcnJvcnMoJmVycm9yKTsKCiAgICAgICAgLy8gUmUtc3VibWl0IHRoZSByZXF1ZXN0CiAgICAgICAgc2VsZi5zdWJtaXRfcmVxdWVzdChyZXF1ZXN0LCBQcmlvcml0eTo6SGlnaCk7CiAgICB9CgogICAgLy8vIEF0dGVtcHRzIHRvIHZhbGlkYXRlIHRoZSBidWZmZXJlZCByZXNwb25zZXMKICAgIC8vLwogICAgLy8vIFJldHVybnMgYW4gZXJyb3IgaWYgdGhlIG5leHQgZXhwZWN0ZWQgcmVzcG9uc2Ugd2FzIHBvcHBlZCwgYnV0IGZhaWxlZCB2YWxpZGF0aW9uLgogICAgZm4gdHJ5X3ZhbGlkYXRlX2J1ZmZlcmVkKCZtdXQgc2VsZikgLT4gT3B0aW9uPFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckVycm9yPEg6OkhlYWRlcj4+IHsKICAgICAgICBsb29wIHsKICAgICAgICAgICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHdlJ3ZlIGFscmVhZHkgcmVjZWl2ZWQgdGhlIG5leHQgdmFsdWUKICAgICAgICAgICAgbGV0IG5leHRfcmVzcG9uc2UgPSBzZWxmLmJ1ZmZlcmVkX3Jlc3BvbnNlcy5wZWVrX211dCgpPzsKICAgICAgICAgICAgbGV0IG5leHRfYmxvY2tfbnVtYmVyID0gbmV4dF9yZXNwb25zZS5ibG9ja19udW1iZXIoKTsKICAgICAgICAgICAgbWF0Y2ggbmV4dF9ibG9ja19udW1iZXIuY21wKCZzZWxmLm5leHRfY2hhaW5fdGlwX2Jsb2NrX251bWJlcikgewogICAgICAgICAgICAgICAgT3JkZXJpbmc6Okxlc3MgPT4gcmV0dXJuIE5vbmUsCiAgICAgICAgICAgICAgICBPcmRlcmluZzo6RXF1YWwgPT4gewogICAgICAgICAgICAgICAgICAgIGxldCBPcmRlcmVkSGVhZGVyc1Jlc3BvbnNlIHsgaGVhZGVycywgcmVxdWVzdCwgcGVlcl9pZCB9ID0KICAgICAgICAgICAgICAgICAgICAgICAgUGVla011dDo6cG9wKG5leHRfcmVzcG9uc2UpOwogICAgICAgICAgICAgICAgICAgIHNlbGYubWV0cmljcy5idWZmZXJlZF9yZXNwb25zZXMuZGVjcmVtZW50KDEuKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgbGV0IEVycihlcnIpID0gc2VsZi5wcm9jZXNzX25leHRfaGVhZGVycyhyZXF1ZXN0LCBoZWFkZXJzLCBwZWVyX2lkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBTb21lKGVycikKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBPcmRlcmluZzo6R3JlYXRlciA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5tZXRyaWNzLmJ1ZmZlcmVkX3Jlc3BvbnNlcy5kZWNyZW1lbnQoMS4pOwogICAgICAgICAgICAgICAgICAgIFBlZWtNdXQ6OnBvcChuZXh0X3Jlc3BvbnNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgcmVxdWVzdCBmb3IgdGhlIGBzeW5jX3RhcmdldGAgaGVhZGVyLgogICAgY29uc3QgZm4gZ2V0X3N5bmNfdGFyZ2V0X3JlcXVlc3QoJnNlbGYsIHN0YXJ0OiBCbG9ja0hhc2hPck51bWJlcikgLT4gSGVhZGVyc1JlcXVlc3QgewogICAgICAgIEhlYWRlcnNSZXF1ZXN0OjpmYWxsaW5nKHN0YXJ0LCAxKQogICAgfQoKICAgIC8vLyBTdGFydHMgYSByZXF1ZXN0IGZ1dHVyZQogICAgZm4gc3VibWl0X3JlcXVlc3QoJnNlbGYsIHJlcXVlc3Q6IEhlYWRlcnNSZXF1ZXN0LCBwcmlvcml0eTogUHJpb3JpdHkpIHsKICAgICAgICB0cmFjZSEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmhlYWRlcnMiLCA/cmVxdWVzdCwgIlN1Ym1pdHRpbmcgaGVhZGVycyByZXF1ZXN0Iik7CiAgICAgICAgc2VsZi5pbl9wcm9ncmVzc19xdWV1ZS5wdXNoKHNlbGYucmVxdWVzdF9mdXQocmVxdWVzdCwgcHJpb3JpdHkpKTsKICAgICAgICBzZWxmLm1ldHJpY3MuaW5fZmxpZ2h0X3JlcXVlc3RzLmluY3JlbWVudCgxLik7CiAgICB9CgogICAgZm4gcmVxdWVzdF9mdXQoCiAgICAgICAgJnNlbGYsCiAgICAgICAgcmVxdWVzdDogSGVhZGVyc1JlcXVlc3QsCiAgICAgICAgcHJpb3JpdHk6IFByaW9yaXR5LAogICAgKSAtPiBIZWFkZXJzUmVxdWVzdEZ1dHVyZTxIOjpPdXRwdXQ+IHsKICAgICAgICBsZXQgY2xpZW50ID0gQXJjOjpjbG9uZSgmc2VsZi5jbGllbnQpOwogICAgICAgIEhlYWRlcnNSZXF1ZXN0RnV0dXJlIHsKICAgICAgICAgICAgcmVxdWVzdDogU29tZShyZXF1ZXN0LmNsb25lKCkpLAogICAgICAgICAgICBmdXQ6IGNsaWVudC5nZXRfaGVhZGVyc193aXRoX3ByaW9yaXR5KHJlcXVlc3QsIHByaW9yaXR5KSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIFZhbGlkYXRlIHdoZXRoZXIgdGhlIGhlYWRlciBpcyB2YWxpZCBpbiByZWxhdGlvbiB0byBpdCdzIHBhcmVudAogICAgZm4gdmFsaWRhdGUoCiAgICAgICAgJnNlbGYsCiAgICAgICAgaGVhZGVyOiAmU2VhbGVkSGVhZGVyPEg6OkhlYWRlcj4sCiAgICAgICAgcGFyZW50OiAmU2VhbGVkSGVhZGVyPEg6OkhlYWRlcj4sCiAgICApIC0+IERvd25sb2FkUmVzdWx0PCgpPiB7CiAgICAgICAgdmFsaWRhdGVfaGVhZGVyX2Rvd25sb2FkKCZzZWxmLmNvbnNlbnN1cywgaGVhZGVyLCBwYXJlbnQpCiAgICB9CgogICAgLy8vIENsZWFycyBhbGwgcmVxdWVzdHMvcmVzcG9uc2VzLgogICAgZm4gY2xlYXIoJm11dCBzZWxmKSB7CiAgICAgICAgc2VsZi5sb3dlc3RfdmFsaWRhdGVkX2hlYWRlci50YWtlKCk7CiAgICAgICAgc2VsZi5xdWV1ZWRfdmFsaWRhdGVkX2hlYWRlcnMgPSBWZWM6Om5ldygpOwogICAgICAgIHNlbGYuYnVmZmVyZWRfcmVzcG9uc2VzID0gQmluYXJ5SGVhcDo6bmV3KCk7CiAgICAgICAgc2VsZi5pbl9wcm9ncmVzc19xdWV1ZS5jbGVhcigpOwoKICAgICAgICBzZWxmLm1ldHJpY3MuaW5fZmxpZ2h0X3JlcXVlc3RzLnNldCgwLik7CiAgICAgICAgc2VsZi5tZXRyaWNzLmJ1ZmZlcmVkX3Jlc3BvbnNlcy5zZXQoMC4pOwogICAgfQoKICAgIC8vLyBTcGxpdHMgb2ZmIHRoZSBuZXh0IGJhdGNoIG9mIGhlYWRlcnMKICAgIGZuIHNwbGl0X25leHRfYmF0Y2goJm11dCBzZWxmKSAtPiBWZWM8U2VhbGVkSGVhZGVyPEg6OkhlYWRlcj4+IHsKICAgICAgICBsZXQgYmF0Y2hfc2l6ZSA9IHNlbGYuc3RyZWFtX2JhdGNoX3NpemUubWluKHNlbGYucXVldWVkX3ZhbGlkYXRlZF9oZWFkZXJzLmxlbigpKTsKICAgICAgICBsZXQgbXV0IHJlbSA9IHNlbGYucXVldWVkX3ZhbGlkYXRlZF9oZWFkZXJzLnNwbGl0X29mZihiYXRjaF9zaXplKTsKICAgICAgICBzdGQ6Om1lbTo6c3dhcCgmbXV0IHJlbSwgJm11dCBzZWxmLnF1ZXVlZF92YWxpZGF0ZWRfaGVhZGVycyk7CiAgICAgICAgLy8gSWYgdGhlIGRvd25sb2FkZXIgY29uc3VtZXIgZG9lcyBub3QgZmx1c2ggaGVhZGVycyBhdCB0aGUgc2FtZSByYXRlIHRoYXQgdGhlIGRvd25sb2FkZXIKICAgICAgICAvLyBxdWV1ZXMgdGhlbSwgdGhlbiB0aGUgYHF1ZXVlZF92YWxpZGF0ZWRfaGVhZGVyc2AgYnVmZmVyIGNhbiBncm93IHVuYm91bmRlZC4KICAgICAgICAvLwogICAgICAgIC8vIFRoZSBzZW1hbnRpY3Mgb2YgYHNwbGl0X29mZmAgc3RhdGUgdGhhdCB0aGUgY2FwYWNpdHkgb2YgdGhlIG9yaWdpbmFsIGJ1ZmZlciBpcwogICAgICAgIC8vIHVuY2hhbmdlZCwgc28gcXVldWVkX3ZhbGlkYXRlZF9oZWFkZXJzIHdpbGwgdGhlbiBoYXZlIG9ubHkgYGJhdGNoX3NpemVgIGVsZW1lbnRzLCBhbmQKICAgICAgICAvLyBpdHMgb3JpZ2luYWwgY2FwYWNpdHkuIEJlY2F1c2UgYHJlbWAgaXMgaW5pdGlhbGx5IHBvcHVsYXRlZCB3aXRoIGVsZW1lbnRzIGBbYmF0Y2hfc2l6ZSwKICAgICAgICAvLyBsZW4pYCBvZiBgcXVldWVkX3ZhbGlkYXRlZF9oZWFkZXJzYCwgaXQgd2lsbCBoYXZlIGEgY2FwYWNpdHkgb2YgYXQgbGVhc3QgYGxlbiAtCiAgICAgICAgLy8gYmF0Y2hfc2l6ZWAsIGFuZCB0aGUgdG90YWwgbWVtb3J5IGFsbG9jYXRlZCBieSB0aGUgdHdvIGJ1ZmZlcnMgd2lsbCBiZSBhcm91bmQgZG91YmxlIHRoZQogICAgICAgIC8vIG9yaWdpbmFsIHNpemUgb2YgYHF1ZXVlZF92YWxpZGF0ZWRfaGVhZGVyc2AuCiAgICAgICAgLy8KICAgICAgICAvLyBUaGVzZSBhcmUgdGhlbiBtZW06OnN3YXBwZWQsIGxlYXZpbmcgYHJlbWAgd2l0aCBhIGxhcmdlIGNhcGFjaXR5LCBidXQgc21hbGwgbGVuZ3RoLgogICAgICAgIC8vCiAgICAgICAgLy8gVG8gcHJldmVudCB0aGVzZSBhbGxvY2F0aW9ucyBmcm9tIGxlYWtpbmcgdG8gdGhlIGNvbnN1bWVyLCB3ZSBzaHJpbmsgdGhlIGNhcGFjaXR5IG9mIHRoZQogICAgICAgIC8vIG5ldyBidWZmZXIuIFRoZSB0b3RhbCBtZW1vcnkgYWxsb2NhdGVkIHNob3VsZCB0aGVuIGJlIG5vdCBtdWNoIG1vcmUgdGhhbiB0aGUgb3JpZ2luYWwKICAgICAgICAvLyBzaXplIG9mIGBxdWV1ZWRfdmFsaWRhdGVkX2hlYWRlcnNgLgogICAgICAgIHJlbS5zaHJpbmtfdG9fZml0KCk7CiAgICAgICAgcmVtCiAgICB9Cn0KCmltcGw8SD4gUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyPEg+CndoZXJlCiAgICBIOiBIZWFkZXJzQ2xpZW50LAogICAgU2VsZjogSGVhZGVyRG93bmxvYWRlciArICdzdGF0aWMsCnsKICAgIC8vLyBTcGF3bnMgdGhlIGRvd25sb2FkZXIgdGFzayB2aWEgW2B0b2tpbzo6dGFzazo6c3Bhd25gXQogICAgcHViIGZuIGludG9fdGFzayhzZWxmKSAtPiBUYXNrRG93bmxvYWRlcjw8U2VsZiBhcyBIZWFkZXJEb3dubG9hZGVyPjo6SGVhZGVyPiB7CiAgICAgICAgc2VsZi5pbnRvX3Rhc2tfd2l0aCgmVG9raW9UYXNrRXhlY3V0b3I6OmRlZmF1bHQoKSkKICAgIH0KCiAgICAvLy8gQ29udmVydCB0aGUgZG93bmxvYWRlciBpbnRvIGEgW2BUYXNrRG93bmxvYWRlcmBdIGJ5IHNwYXduaW5nIGl0IHZpYSB0aGUgZ2l2ZW4gYHNwYXduZXJgLgogICAgcHViIGZuIGludG9fdGFza193aXRoPFM+KAogICAgICAgIHNlbGYsCiAgICAgICAgc3Bhd25lcjogJlMsCiAgICApIC0+IFRhc2tEb3dubG9hZGVyPDxTZWxmIGFzIEhlYWRlckRvd25sb2FkZXI+OjpIZWFkZXI+CiAgICB3aGVyZQogICAgICAgIFM6IFRhc2tTcGF3bmVyLAogICAgewogICAgICAgIFRhc2tEb3dubG9hZGVyOjpzcGF3bl93aXRoKHNlbGYsIHNwYXduZXIpCiAgICB9Cn0KCmltcGw8SD4gSGVhZGVyRG93bmxvYWRlciBmb3IgUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyPEg+CndoZXJlCiAgICBIOiBIZWFkZXJzQ2xpZW50PEhlYWRlcjogcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6QmxvY2tIZWFkZXI+ICsgJ3N0YXRpYywKewogICAgdHlwZSBIZWFkZXIgPSBIOjpIZWFkZXI7CgogICAgZm4gdXBkYXRlX2xvY2FsX2hlYWQoJm11dCBzZWxmLCBoZWFkOiBTZWFsZWRIZWFkZXI8SDo6SGVhZGVyPikgewogICAgICAgIC8vIGVuc3VyZSB3ZSdyZSBvbmx5IHlpZWxkaW5nIGhlYWRlcnMgdGhhdCBhcmUgaW4gcmFuZ2UgYW5kIGZvbGxvdyB0aGUgY3VycmVudCBsb2NhbCBoZWFkLgogICAgICAgIHdoaWxlIHNlbGYKICAgICAgICAgICAgLnF1ZXVlZF92YWxpZGF0ZWRfaGVhZGVycwogICAgICAgICAgICAubGFzdCgpCiAgICAgICAgICAgIC5pc19zb21lX2FuZCh8bGFzdHwgbGFzdC5udW1iZXIoKSA8PSBoZWFkLm51bWJlcigpKQogICAgICAgIHsKICAgICAgICAgICAgLy8gaGVhZGVycyBhcmUgc29ydGVkIGhpZ2ggdG8gbG93CiAgICAgICAgICAgIHNlbGYucXVldWVkX3ZhbGlkYXRlZF9oZWFkZXJzLnBvcCgpOwogICAgICAgIH0KICAgICAgICB0cmFjZSEoCiAgICAgICAgICAgIHRhcmdldDogImRvd25sb2FkZXJzOjpoZWFkZXJzIiwKICAgICAgICAgICAgaGVhZD0/aGVhZC5udW1faGFzaCgpLAogICAgICAgICAgICAiVXBkYXRpbmcgbG9jYWwgaGVhZCIKICAgICAgICApOwogICAgICAgIC8vIHVwZGF0ZSB0aGUgbG9jYWwgaGVhZAogICAgICAgIHNlbGYubG9jYWxfaGVhZCA9IFNvbWUoaGVhZCk7CiAgICB9CgogICAgLy8vIElmIHRoZSBnaXZlbiB0YXJnZXQgaXMgZGlmZmVyZW50IGZyb20gdGhlIGN1cnJlbnQgdGFyZ2V0LCB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgc3luYyB0YXJnZXQKICAgIGZuIHVwZGF0ZV9zeW5jX3RhcmdldCgmbXV0IHNlbGYsIHRhcmdldDogU3luY1RhcmdldCkgewogICAgICAgIGxldCBjdXJyZW50X3RpcCA9IHNlbGYuc3luY190YXJnZXQuYXNfcmVmKCkuYW5kX3RoZW4ofHR8IHQuaGFzaCgpKTsKICAgICAgICB0cmFjZSEoCiAgICAgICAgICAgIHRhcmdldDogImRvd25sb2FkZXJzOjpoZWFkZXJzIiwKICAgICAgICAgICAgc3luY190YXJnZXQ9P3RhcmdldCwKICAgICAgICAgICAgY3VycmVudF90aXA9P2N1cnJlbnRfdGlwLAogICAgICAgICAgICAiVXBkYXRpbmcgc3luYyB0YXJnZXQiCiAgICAgICAgKTsKICAgICAgICBtYXRjaCB0YXJnZXQgewogICAgICAgICAgICBTeW5jVGFyZ2V0OjpUaXAodGlwKSA9PiB7CiAgICAgICAgICAgICAgICBpZiBTb21lKHRpcCkgIT0gY3VycmVudF90aXAgewogICAgICAgICAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6aGVhZGVycyIsIGN1cnJlbnQ9P2N1cnJlbnRfdGlwLCBuZXc9P3RpcCwgIlVwZGF0ZSBzeW5jIHRhcmdldCIpOwogICAgICAgICAgICAgICAgICAgIGxldCBuZXdfc3luY190YXJnZXQgPSBTeW5jVGFyZ2V0QmxvY2s6OmZyb21faGFzaCh0aXApOwoKICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgbmV3IHN5bmMgdGFyZ2V0IGlzIHRoZSBuZXh0IHF1ZXVlZCByZXF1ZXN0IHdlIGRvbid0IG5lZWQgdG8gcmUtc3RhcnQKICAgICAgICAgICAgICAgICAgICAvLyB0aGUgdGFyZ2V0IHVwZGF0ZQogICAgICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKHRhcmdldF9udW1iZXIpID0gc2VsZgogICAgICAgICAgICAgICAgICAgICAgICAucXVldWVkX3ZhbGlkYXRlZF9oZWFkZXJzCiAgICAgICAgICAgICAgICAgICAgICAgIC5maXJzdCgpCiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIofGh8IGguaGFzaCgpID09IHRpcCkKICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCh8aHwgaC5udW1iZXIoKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc3luY190YXJnZXQgPSBTb21lKG5ld19zeW5jX3RhcmdldC53aXRoX251bWJlcih0YXJnZXRfbnVtYmVyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogImRvd25sb2FkZXJzOjpoZWFkZXJzIiwgbmV3PT90YXJnZXQsICJSZXF1ZXN0IG5ldyBzeW5jIHRhcmdldCIpOwogICAgICAgICAgICAgICAgICAgIHNlbGYubWV0cmljcy5vdXRfb2Zfb3JkZXJfcmVxdWVzdHMuaW5jcmVtZW50KDEpOwogICAgICAgICAgICAgICAgICAgIHNlbGYuc3luY190YXJnZXQgPSBTb21lKG5ld19zeW5jX3RhcmdldCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zeW5jX3RhcmdldF9yZXF1ZXN0ID0gU29tZSgKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZXF1ZXN0X2Z1dChzZWxmLmdldF9zeW5jX3RhcmdldF9yZXF1ZXN0KHRpcC5pbnRvKCkpLCBQcmlvcml0eTo6SGlnaCksCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBTeW5jVGFyZ2V0OjpHYXAoZXhpc3RpbmcpID0+IHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXQgPSBleGlzdGluZy5wYXJlbnQ7CiAgICAgICAgICAgICAgICBpZiBTb21lKHRhcmdldCkgIT0gY3VycmVudF90aXAgewogICAgICAgICAgICAgICAgICAgIC8vIHRoZXJlIGNvdWxkIGJlIGEgc3luYyB0YXJnZXQgcmVxdWVzdCBpbiBwcm9ncmVzcwogICAgICAgICAgICAgICAgICAgIHNlbGYuc3luY190YXJnZXRfcmVxdWVzdC50YWtlKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHRhcmdldCBoYXMgY2hhbmdlZCwgdXBkYXRlIHRoZSByZXF1ZXN0IHBvaW50ZXJzIGJhc2VkIG9uIHRoZSBuZXcKICAgICAgICAgICAgICAgICAgICAvLyB0YXJnZXRlZCBibG9jayBudW1iZXIKICAgICAgICAgICAgICAgICAgICBsZXQgcGFyZW50X2Jsb2NrX251bWJlciA9IGV4aXN0aW5nLmJsb2NrLm51bWJlci5zYXR1cmF0aW5nX3N1YigxKTsKCiAgICAgICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogImRvd25sb2FkZXJzOjpoZWFkZXJzIiwgY3VycmVudD0/Y3VycmVudF90aXAsIG5ldz0/dGFyZ2V0LCAlcGFyZW50X2Jsb2NrX251bWJlciwgIlVwZGF0ZWQgc3luYyB0YXJnZXQiKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBzeW5jIHRhcmdldCBoYXNoCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zeW5jX3RhcmdldCA9IG1hdGNoIHNlbGYuc3luY190YXJnZXQudGFrZSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgU29tZShzeW5jX3RhcmdldCkgPT4gU29tZShzeW5jX3RhcmdldC53aXRoX2hhc2godGFyZ2V0KSksCiAgICAgICAgICAgICAgICAgICAgICAgIE5vbmUgPT4gU29tZShTeW5jVGFyZ2V0QmxvY2s6OmZyb21faGFzaCh0YXJnZXQpKSwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHNlbGYub25fYmxvY2tfbnVtYmVyX3VwZGF0ZShwYXJlbnRfYmxvY2tfbnVtYmVyLCBwYXJlbnRfYmxvY2tfbnVtYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBTeW5jVGFyZ2V0OjpUaXBOdW0obnVtKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgY3VycmVudF90aXBfbnVtID0gc2VsZi5zeW5jX3RhcmdldC5hc19yZWYoKS5hbmRfdGhlbih8dHwgdC5udW1iZXIoKSk7CiAgICAgICAgICAgICAgICBpZiBTb21lKG51bSkgIT0gY3VycmVudF90aXBfbnVtIHsKICAgICAgICAgICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmhlYWRlcnMiLCAlbnVtLCAiVXBkYXRpbmcgc3luYyB0YXJnZXQgYmFzZWQgb24gbnVtIik7CiAgICAgICAgICAgICAgICAgICAgLy8ganVzdCB1cGRhdGUgdGhlIHN5bmMgdGFyZ2V0CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zeW5jX3RhcmdldCA9IFNvbWUoU3luY1RhcmdldEJsb2NrOjpmcm9tX251bWJlcihudW0pKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnN5bmNfdGFyZ2V0X3JlcXVlc3QgPSBTb21lKAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJlcXVlc3RfZnV0KHNlbGYuZ2V0X3N5bmNfdGFyZ2V0X3JlcXVlc3QobnVtLmludG8oKSksIFByaW9yaXR5OjpIaWdoKSwKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZuIHNldF9iYXRjaF9zaXplKCZtdXQgc2VsZiwgYmF0Y2hfc2l6ZTogdXNpemUpIHsKICAgICAgICBzZWxmLnN0cmVhbV9iYXRjaF9zaXplID0gYmF0Y2hfc2l6ZTsKICAgIH0KfQoKaW1wbDxIPiBTdHJlYW0gZm9yIFJldmVyc2VIZWFkZXJzRG93bmxvYWRlcjxIPgp3aGVyZQogICAgSDogSGVhZGVyc0NsaWVudDxIZWFkZXI6IHJldGhfcHJpbWl0aXZlc190cmFpdHM6OkJsb2NrSGVhZGVyPiArICdzdGF0aWMsCnsKICAgIHR5cGUgSXRlbSA9IEhlYWRlcnNEb3dubG9hZGVyUmVzdWx0PFZlYzxTZWFsZWRIZWFkZXI8SDo6SGVhZGVyPj4sIEg6OkhlYWRlcj47CgogICAgZm4gcG9sbF9uZXh0KHNlbGY6IFBpbjwmbXV0IFNlbGY+LCBjeDogJm11dCBDb250ZXh0PCdfPikgLT4gUG9sbDxPcHRpb248U2VsZjo6SXRlbT4+IHsKICAgICAgICBsZXQgdGhpcyA9IHNlbGYuZ2V0X211dCgpOwoKICAgICAgICAvLyBUaGUgZG93bmxvYWRlciBib3VuZGFyaWVzIChsb2NhbCBoZWFkIGFuZCBzeW5jIHRhcmdldCkgaGF2ZSB0byBiZSBzZXQgaW4gb3JkZXIKICAgICAgICAvLyB0byBzdGFydCBkb3dubG9hZGluZyBkYXRhLgogICAgICAgIGlmIHRoaXMubG9jYWxfaGVhZC5pc19ub25lKCkgfHwgdGhpcy5zeW5jX3RhcmdldC5pc19ub25lKCkgewogICAgICAgICAgICB0cmFjZSEoCiAgICAgICAgICAgICAgICB0YXJnZXQ6ICJkb3dubG9hZGVyczo6aGVhZGVycyIsCiAgICAgICAgICAgICAgICBoZWFkPT90aGlzLmxvY2FsX2Jsb2NrX251bWJlcigpLAogICAgICAgICAgICAgICAgc3luY190YXJnZXQ9P3RoaXMuc3luY190YXJnZXQsCiAgICAgICAgICAgICAgICAiVGhlIGRvd25sb2FkZXIgc3luYyBib3VuZGFyaWVzIGhhdmUgbm90IGJlZW4gc2V0IgogICAgICAgICAgICApOwogICAgICAgICAgICByZXR1cm4gUG9sbDo6UGVuZGluZwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgd2UgaGF2ZSBhIG5ldyB0aXAgcmVxdWVzdCB3ZSBuZWVkIHRvIGNvbXBsZXRlIHRoYXQgZmlyc3QgYmVmb3JlIHdlIHNlbmQgYmF0Y2hlZAogICAgICAgIC8vIHJlcXVlc3RzCiAgICAgICAgd2hpbGUgbGV0IFNvbWUobXV0IHJlcSkgPSB0aGlzLnN5bmNfdGFyZ2V0X3JlcXVlc3QudGFrZSgpIHsKICAgICAgICAgICAgbWF0Y2ggcmVxLnBvbGxfdW5waW4oY3gpIHsKICAgICAgICAgICAgICAgIFBvbGw6OlJlYWR5KG91dGNvbWUpID0+IHsKICAgICAgICAgICAgICAgICAgICBtYXRjaCB0aGlzLm9uX3N5bmNfdGFyZ2V0X291dGNvbWUob3V0Y29tZSkgewogICAgICAgICAgICAgICAgICAgICAgICBPaygoKSkgPT4gYnJlYWssCiAgICAgICAgICAgICAgICAgICAgICAgIEVycihSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJFcnJvcjo6UmVzcG9uc2UoZXJyb3IpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmhlYWRlcnMiLCAlZXJyb3IsICJpbnZhbGlkIHN5bmMgdGFyZ2V0IHJlc3BvbnNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBlcnJvci5pc19jaGFubmVsX2Nsb3NlZCgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkb3dubG9hZCBjaGFubmVsIGNsb3NlZCB3aGljaCBtZWFucyB0aGUgbmV0d29yayB3YXMgZHJvcHBlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBQb2xsOjpSZWFkeShOb25lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGVuYWxpemVfcGVlcihlcnJvci5wZWVyX2lkLCAmZXJyb3IuZXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXRyaWNzLmluY3JlbWVudF9lcnJvcnMoJmVycm9yLmVycm9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3luY190YXJnZXRfcmVxdWVzdCA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU29tZSh0aGlzLnJlcXVlc3RfZnV0KGVycm9yLnJlcXVlc3QsIFByaW9yaXR5OjpIaWdoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgRXJyKFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckVycm9yOjpEb3dubG9hZGVyKGVycm9yKSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KFNvbWUoRXJyKGVycm9yKSkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgUG9sbDo6UGVuZGluZyA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zeW5jX3RhcmdldF9yZXF1ZXN0ID0gU29tZShyZXEpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBQb2xsOjpQZW5kaW5nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIHNocmluayB0aGUgYnVmZmVyIGFmdGVyIGhhbmRsaW5nIHN5bmMgdGFyZ2V0IG91dGNvbWVzCiAgICAgICAgdGhpcy5idWZmZXJlZF9yZXNwb25zZXMuc2hyaW5rX3RvX2ZpdCgpOwoKICAgICAgICAvLyB0aGlzIGxvb3Agd2lsbCBzdWJtaXQgbmV3IHJlcXVlc3RzIGFuZCBwb2xsIHRoZW0sIGlmIGEgbmV3IGJhdGNoIGlzIHJlYWR5IGl0IGlzIHJldHVybmVkCiAgICAgICAgLy8gVGhlIGFjdHVhbCB3b3JrIGlzIGRvbmUgYnkgdGhlIHJlY2VpdmVyIG9mIHRoZSByZXF1ZXN0IGNoYW5uZWwsIHRoaXMgbWVhbnMsIHBvbGxpbmcgdGhlCiAgICAgICAgLy8gcmVxdWVzdCBmdXR1cmUgaXMganVzdCByZWFkaW5nIGZyb20gYSBgb25lc2hvdDo6UmVjZWl2ZXJgLiBIZW5jZSwgdGhpcyBsb29wIHRyaWVzIHRvIGtlZXAKICAgICAgICAvLyB0aGUgZG93bmxvYWRlciBhdCBjYXBhY2l0eSBhdCBhbGwgdGltZXMgVGhlIG9yZGVyIG9mIGxvb3BzIGlzIGFzIGZvbGxvd3M6CiAgICAgICAgLy8gMS4gcG9sbCBmdXR1cmVzIHRvIG1ha2Ugcm9vbSBmb3IgZm9sbG93dXAgcmVxdWVzdHMgKHRoaXMgd2lsbCBhbHNvIHByZXBhcmUgdmFsaWRhdGVkCiAgICAgICAgLy8gaGVhZGVycyBmb3IgMy4pIDIuIGV4aGF1c3QgYWxsIGNhcGFjaXR5IGJ5IHNlbmRpbmcgcmVxdWVzdHMKICAgICAgICAvLyAzLiByZXR1cm4gYmF0Y2gsIGlmIGVub3VnaCB2YWxpZGF0ZWQKICAgICAgICAvLyA0LiByZXR1cm4gUGVuZGluZyBpZiAyLikgZGlkIG5vdCBzdWJtaXQgYSBuZXcgcmVxdWVzdCwgZWxzZSBjb250aW51ZQogICAgICAgIGxvb3AgewogICAgICAgICAgICAvLyBwb2xsIHJlcXVlc3RzCiAgICAgICAgICAgIHdoaWxlIGxldCBQb2xsOjpSZWFkeShTb21lKG91dGNvbWUpKSA9IHRoaXMuaW5fcHJvZ3Jlc3NfcXVldWUucG9sbF9uZXh0X3VucGluKGN4KSB7CiAgICAgICAgICAgICAgICB0aGlzLm1ldHJpY3MuaW5fZmxpZ2h0X3JlcXVlc3RzLmRlY3JlbWVudCgxLik7CiAgICAgICAgICAgICAgICAvLyBoYW5kbGUgcmVzcG9uc2UKICAgICAgICAgICAgICAgIG1hdGNoIHRoaXMub25faGVhZGVyc19vdXRjb21lKG91dGNvbWUpIHsKICAgICAgICAgICAgICAgICAgICBPaygoKSkgPT4gKCksCiAgICAgICAgICAgICAgICAgICAgRXJyKFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckVycm9yOjpSZXNwb25zZShlcnJvcikpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZXJyb3IuaXNfY2hhbm5lbF9jbG9zZWQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkb3dubG9hZCBjaGFubmVsIGNsb3NlZCB3aGljaCBtZWFucyB0aGUgbmV0d29yayB3YXMgZHJvcHBlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KE5vbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbl9oZWFkZXJzX2Vycm9yKGVycm9yKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgRXJyKFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckVycm9yOjpEb3dubG9hZGVyKGVycm9yKSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBQb2xsOjpSZWFkeShTb21lKEVycihlcnJvcikpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNocmluayB0aGUgYnVmZmVyIGFmdGVyIGhhbmRsaW5nIGhlYWRlcnMgb3V0Y29tZXMKICAgICAgICAgICAgdGhpcy5idWZmZXJlZF9yZXNwb25zZXMuc2hyaW5rX3RvX2ZpdCgpOwoKICAgICAgICAgICAgLy8gbWFya3MgdGhlIGxvb3AncyBleGl0IGNvbmRpdGlvbjogZXhpdCBpZiBubyByZXF1ZXN0cyBzdWJtaXR0ZWQKICAgICAgICAgICAgbGV0IG11dCBwcm9ncmVzcyA9IGZhbHNlOwoKICAgICAgICAgICAgbGV0IGNvbmN1cnJlbnRfcmVxdWVzdF9saW1pdCA9IHRoaXMuY29uY3VycmVudF9yZXF1ZXN0X2xpbWl0KCk7CiAgICAgICAgICAgIC8vIHBvcHVsYXRlIHJlcXVlc3RzCiAgICAgICAgICAgIHdoaWxlIHRoaXMuaW5fcHJvZ3Jlc3NfcXVldWUubGVuKCkgPCBjb25jdXJyZW50X3JlcXVlc3RfbGltaXQgJiYKICAgICAgICAgICAgICAgIHRoaXMuYnVmZmVyZWRfcmVzcG9uc2VzLmxlbigpIDwgdGhpcy5tYXhfYnVmZmVyZWRfcmVzcG9uc2VzCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKHJlcXVlc3QpID0gdGhpcy5uZXh0X3JlcXVlc3QoKSB7CiAgICAgICAgICAgICAgICAgICAgdHJhY2UhKAogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6ICJkb3dubG9hZGVyczo6aGVhZGVycyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJSZXF1ZXN0aW5nIGhlYWRlcnMge3JlcXVlc3Q6P30iCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBwcm9ncmVzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWJtaXRfcmVxdWVzdChyZXF1ZXN0LCBQcmlvcml0eTo6Tm9ybWFsKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gbm8gbW9yZSByZXF1ZXN0cwogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHlpZWxkIG5leHQgYmF0Y2gKICAgICAgICAgICAgaWYgdGhpcy5xdWV1ZWRfdmFsaWRhdGVkX2hlYWRlcnMubGVuKCkgPj0gdGhpcy5zdHJlYW1fYmF0Y2hfc2l6ZSB7CiAgICAgICAgICAgICAgICBsZXQgbmV4dF9iYXRjaCA9IHRoaXMuc3BsaXRfbmV4dF9iYXRjaCgpOwoKICAgICAgICAgICAgICAgIC8vIE5vdGU6IGlmIHRoaXMgd291bGQgZHJhaW4gYWxsIGhlYWRlcnMsIHdlIG5lZWQgdG8ga2VlcCB0aGUgbG93ZXN0IChsYXN0IGluZGV4KQogICAgICAgICAgICAgICAgLy8gYXJvdW5kIHNvIHdlIGNhbiBjb250aW51ZSB2YWxpZGF0aW5nIGhlYWRlcnMgcmVzcG9uc2VzLgogICAgICAgICAgICAgICAgaWYgdGhpcy5xdWV1ZWRfdmFsaWRhdGVkX2hlYWRlcnMuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb3dlc3RfdmFsaWRhdGVkX2hlYWRlciA9IG5leHRfYmF0Y2gubGFzdCgpLmNsb25lZCgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6aGVhZGVycyIsIGJhdGNoPSVuZXh0X2JhdGNoLmxlbigpLCAiUmV0dXJuaW5nIHZhbGlkYXRlZCBiYXRjaCIpOwoKICAgICAgICAgICAgICAgIHRoaXMubWV0cmljcy50b3RhbF9mbHVzaGVkLmluY3JlbWVudChuZXh0X2JhdGNoLmxlbigpIGFzIHU2NCk7CiAgICAgICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoU29tZShPayhuZXh0X2JhdGNoKSkpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICFwcm9ncmVzcyB7CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBhbGwgcmVxdWVzdHMgYXJlIGhhbmRsZWQsIHN0cmVhbSBpcyBmaW5pc2hlZAogICAgICAgIGlmIHRoaXMuaW5fcHJvZ3Jlc3NfcXVldWUuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgIGxldCBuZXh0X2JhdGNoID0gdGhpcy5zcGxpdF9uZXh0X2JhdGNoKCk7CiAgICAgICAgICAgIGlmIG5leHRfYmF0Y2guaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoTm9uZSkKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1ldHJpY3MudG90YWxfZmx1c2hlZC5pbmNyZW1lbnQobmV4dF9iYXRjaC5sZW4oKSBhcyB1NjQpOwogICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoU29tZShPayhuZXh0X2JhdGNoKSkpCiAgICAgICAgfQoKICAgICAgICBQb2xsOjpQZW5kaW5nCiAgICB9Cn0KCi8vLyBBIGZ1dHVyZSB0aGF0IHJldHVybnMgYSBsaXN0IG9mIGhlYWRlcnMgb24gc3VjY2Vzcy4KI1tkZXJpdmUoRGVidWcpXQpzdHJ1Y3QgSGVhZGVyc1JlcXVlc3RGdXR1cmU8Rj4gewogICAgcmVxdWVzdDogT3B0aW9uPEhlYWRlcnNSZXF1ZXN0PiwKICAgIGZ1dDogRiwKfQoKaW1wbDxGLCBIPiBGdXR1cmUgZm9yIEhlYWRlcnNSZXF1ZXN0RnV0dXJlPEY+CndoZXJlCiAgICBGOiBGdXR1cmU8T3V0cHV0ID0gUGVlclJlcXVlc3RSZXN1bHQ8VmVjPEg+Pj4gKyBTeW5jICsgU2VuZCArIFVucGluLAp7CiAgICB0eXBlIE91dHB1dCA9IEhlYWRlcnNSZXF1ZXN0T3V0Y29tZTxIPjsKCiAgICBmbiBwb2xsKHNlbGY6IFBpbjwmbXV0IFNlbGY+LCBjeDogJm11dCBDb250ZXh0PCdfPikgLT4gUG9sbDxTZWxmOjpPdXRwdXQ+IHsKICAgICAgICBsZXQgdGhpcyA9IHNlbGYuZ2V0X211dCgpOwogICAgICAgIGxldCBvdXRjb21lID0gcmVhZHkhKHRoaXMuZnV0LnBvbGxfdW5waW4oY3gpKTsKICAgICAgICBsZXQgcmVxdWVzdCA9IHRoaXMucmVxdWVzdC50YWtlKCkudW53cmFwKCk7CgogICAgICAgIFBvbGw6OlJlYWR5KEhlYWRlcnNSZXF1ZXN0T3V0Y29tZSB7IHJlcXVlc3QsIG91dGNvbWUgfSkKICAgIH0KfQoKLy8vIFRoZSBvdXRjb21lIG9mIHRoZSBbYEhlYWRlcnNSZXF1ZXN0RnV0dXJlYF0Kc3RydWN0IEhlYWRlcnNSZXF1ZXN0T3V0Y29tZTxIPiB7CiAgICByZXF1ZXN0OiBIZWFkZXJzUmVxdWVzdCwKICAgIG91dGNvbWU6IFBlZXJSZXF1ZXN0UmVzdWx0PFZlYzxIPj4sCn0KCi8vID09PSBpbXBsIE9yZGVyZWRIZWFkZXJzUmVzcG9uc2UgPT09CgppbXBsPEg+IEhlYWRlcnNSZXF1ZXN0T3V0Y29tZTxIPiB7CiAgICBjb25zdCBmbiBibG9ja19udW1iZXIoJnNlbGYpIC0+IHU2NCB7CiAgICAgICAgc2VsZi5yZXF1ZXN0LnN0YXJ0LmFzX251bWJlcigpLmV4cGVjdCgiaXMgbnVtYmVyIikKICAgIH0KfQoKLy8vIFdyYXBwZXIgdHlwZSB0byBvcmRlciByZXNwb25zZXMKI1tkZXJpdmUoRGVidWcpXQpzdHJ1Y3QgT3JkZXJlZEhlYWRlcnNSZXNwb25zZTxIPiB7CiAgICBoZWFkZXJzOiBWZWM8SD4sCiAgICByZXF1ZXN0OiBIZWFkZXJzUmVxdWVzdCwKICAgIHBlZXJfaWQ6IFBlZXJJZCwKfQoKLy8gPT09IGltcGwgT3JkZXJlZEhlYWRlcnNSZXNwb25zZSA9PT0KCmltcGw8SD4gT3JkZXJlZEhlYWRlcnNSZXNwb25zZTxIPiB7CiAgICBjb25zdCBmbiBibG9ja19udW1iZXIoJnNlbGYpIC0+IHU2NCB7CiAgICAgICAgc2VsZi5yZXF1ZXN0LnN0YXJ0LmFzX251bWJlcigpLmV4cGVjdCgiaXMgbnVtYmVyIikKICAgIH0KfQoKaW1wbDxIPiBQYXJ0aWFsRXEgZm9yIE9yZGVyZWRIZWFkZXJzUmVzcG9uc2U8SD4gewogICAgZm4gZXEoJnNlbGYsIG90aGVyOiAmU2VsZikgLT4gYm9vbCB7CiAgICAgICAgc2VsZi5ibG9ja19udW1iZXIoKSA9PSBvdGhlci5ibG9ja19udW1iZXIoKQogICAgfQp9CgppbXBsPEg+IEVxIGZvciBPcmRlcmVkSGVhZGVyc1Jlc3BvbnNlPEg+IHt9CgppbXBsPEg+IFBhcnRpYWxPcmQgZm9yIE9yZGVyZWRIZWFkZXJzUmVzcG9uc2U8SD4gewogICAgZm4gcGFydGlhbF9jbXAoJnNlbGYsIG90aGVyOiAmU2VsZikgLT4gT3B0aW9uPE9yZGVyaW5nPiB7CiAgICAgICAgU29tZShzZWxmLmNtcChvdGhlcikpCiAgICB9Cn0KCmltcGw8SD4gT3JkIGZvciBPcmRlcmVkSGVhZGVyc1Jlc3BvbnNlPEg+IHsKICAgIGZuIGNtcCgmc2VsZiwgb3RoZXI6ICZTZWxmKSAtPiBPcmRlcmluZyB7CiAgICAgICAgc2VsZi5ibG9ja19udW1iZXIoKS5jbXAoJm90aGVyLmJsb2NrX251bWJlcigpKQogICAgfQp9CgovLy8gVHlwZSByZXR1cm5lZCBpZiBhIGJhZCByZXNwb25zZSB3YXMgcHJvY2Vzc2VkCiNbZGVyaXZlKERlYnVnLCBFcnJvcildCiNbZXJyb3IoImVycm9yIHJlcXVlc3RpbmcgaGVhZGVycyBmcm9tIHBlZXIge3BlZXJfaWQ6P306IHtlcnJvcn07IHJlcXVlc3Q6IHtyZXF1ZXN0Oj99IildCnN0cnVjdCBIZWFkZXJzUmVzcG9uc2VFcnJvciB7CiAgICByZXF1ZXN0OiBIZWFkZXJzUmVxdWVzdCwKICAgIHBlZXJfaWQ6IE9wdGlvbjxQZWVySWQ+LAogICAgI1tzb3VyY2VdCiAgICBlcnJvcjogRG93bmxvYWRFcnJvciwKfQoKaW1wbCBIZWFkZXJzUmVzcG9uc2VFcnJvciB7CiAgICAvLy8gUmV0dXJucyB0cnVlIGlmIHRoZSBlcnJvciB3YXMgY2F1c2VkIGJ5IGEgY2xvc2VkIGNoYW5uZWwgdG8gdGhlIG5ldHdvcmsuCiAgICBjb25zdCBmbiBpc19jaGFubmVsX2Nsb3NlZCgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgaWYgbGV0IERvd25sb2FkRXJyb3I6OlJlcXVlc3RFcnJvcihyZWYgZXJyKSA9IHNlbGYuZXJyb3IgewogICAgICAgICAgICByZXR1cm4gZXJyLmlzX2NoYW5uZWxfY2xvc2VkKCkKICAgICAgICB9CiAgICAgICAgZmFsc2UKICAgIH0KfQoKLy8vIFRoZSBibG9jayB0byB3aGljaCB3ZSB3YW50IHRvIGNsb3NlIHRoZSBnYXA6IChsb2NhbCBoZWFkLi4uc3luYyB0YXJnZXRdCi8vLyBUaGlzIHRyYWNrcyB0aGUgc3luYyB0YXJnZXQgYmxvY2ssIHNvIHRoaXMgY291bGQgYmUgZWl0aGVyIGEgYmxvY2sgbnVtYmVyIG9yIGhhc2guCiNbZGVyaXZlKENsb25lLCBEZWJ1ZyldCnB1YiBlbnVtIFN5bmNUYXJnZXRCbG9jayB7CiAgICAvLy8gQmxvY2sgaGFzaCBvZiB0aGUgdGFyZ2V0ZWQgYmxvY2sKICAgIEhhc2goQjI1NiksCiAgICAvLy8gQmxvY2sgbnVtYmVyIG9mIHRoZSB0YXJnZXRlZCBibG9jawogICAgTnVtYmVyKHU2NCksCiAgICAvLy8gQm90aCB0aGUgYmxvY2sgaGFzaCBhbmQgbnVtYmVyIG9mIHRoZSB0YXJnZXRlZCBibG9jawogICAgSGFzaEFuZE51bWJlciB7CiAgICAgICAgLy8vIEJsb2NrIGhhc2ggb2YgdGhlIHRhcmdldGVkIGJsb2NrCiAgICAgICAgaGFzaDogQjI1NiwKICAgICAgICAvLy8gQmxvY2sgbnVtYmVyIG9mIHRoZSB0YXJnZXRlZCBibG9jawogICAgICAgIG51bWJlcjogdTY0LAogICAgfSwKfQoKaW1wbCBTeW5jVGFyZ2V0QmxvY2sgewogICAgLy8vIENyZWF0ZSBuZXcgaW5zdGFuY2UgZnJvbSBoYXNoLgogICAgY29uc3QgZm4gZnJvbV9oYXNoKGhhc2g6IEIyNTYpIC0+IFNlbGYgewogICAgICAgIFNlbGY6Okhhc2goaGFzaCkKICAgIH0KCiAgICAvLy8gQ3JlYXRlIG5ldyBpbnN0YW5jZSBmcm9tIG51bWJlci4KICAgIGNvbnN0IGZuIGZyb21fbnVtYmVyKG51bTogdTY0KSAtPiBTZWxmIHsKICAgICAgICBTZWxmOjpOdW1iZXIobnVtKQogICAgfQoKICAgIC8vLyBTZXQgdGhlIGhhc2ggZm9yIHRoZSBzeW5jIHRhcmdldC4KICAgIGNvbnN0IGZuIHdpdGhfaGFzaChzZWxmLCBoYXNoOiBCMjU2KSAtPiBTZWxmIHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6SGFzaChfKSA9PiBTZWxmOjpIYXNoKGhhc2gpLAogICAgICAgICAgICBTZWxmOjpOdW1iZXIobnVtYmVyKSB8IFNlbGY6Okhhc2hBbmROdW1iZXIgeyBudW1iZXIsIC4uIH0gPT4gewogICAgICAgICAgICAgICAgU2VsZjo6SGFzaEFuZE51bWJlciB7IGhhc2gsIG51bWJlciB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8vIFNldCBhIG51bWJlciBvbiB0aGUgaW5zdGFuY2UuCiAgICBjb25zdCBmbiB3aXRoX251bWJlcihzZWxmLCBudW1iZXI6IHU2NCkgLT4gU2VsZiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6Okhhc2goaGFzaCkgfCBTZWxmOjpIYXNoQW5kTnVtYmVyIHsgaGFzaCwgLi4gfSA9PiB7CiAgICAgICAgICAgICAgICBTZWxmOjpIYXNoQW5kTnVtYmVyIHsgaGFzaCwgbnVtYmVyIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBTZWxmOjpOdW1iZXIoXykgPT4gU2VsZjo6TnVtYmVyKG51bWJlciksCiAgICAgICAgfQogICAgfQoKICAgIC8vLyBSZXBsYWNlIHRoZSB0YXJnZXQgYmxvY2sgbnVtYmVyLCBhbmQgcmV0dXJuIHRoZSBvbGQgYmxvY2sgbnVtYmVyLCBpZiBpdCB3YXMgc2V0LgogICAgLy8vCiAgICAvLy8gSWYgdGhlIHRhcmdldCBibG9jayBpcyBhIGhhc2gsIHRoaXMgYmUgY29udmVydGVkIGludG8gYSBgSGFzaEFuZE51bWJlcmAsIGJ1dCByZXR1cm4gYE5vbmVgLgogICAgLy8vIFRoZSBzZW1hbnRpY3Mgc2hvdWxkIGJlIGVxdWl2YWxlbnQgdG8gdGhhdCBvZiBgT3B0aW9uOjpyZXBsYWNlYC4KICAgIGNvbnN0IGZuIHJlcGxhY2VfbnVtYmVyKCZtdXQgc2VsZiwgbnVtYmVyOiB1NjQpIC0+IE9wdGlvbjx1NjQ+IHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6SGFzaChoYXNoKSA9PiB7CiAgICAgICAgICAgICAgICAqc2VsZiA9IFNlbGY6Okhhc2hBbmROdW1iZXIgeyBoYXNoOiAqaGFzaCwgbnVtYmVyIH07CiAgICAgICAgICAgICAgICBOb25lCiAgICAgICAgICAgIH0KICAgICAgICAgICAgU2VsZjo6TnVtYmVyKG9sZF9udW1iZXIpID0+IHsKICAgICAgICAgICAgICAgIGxldCByZXMgPSBTb21lKCpvbGRfbnVtYmVyKTsKICAgICAgICAgICAgICAgICpzZWxmID0gU2VsZjo6TnVtYmVyKG51bWJlcik7CiAgICAgICAgICAgICAgICByZXMKICAgICAgICAgICAgfQogICAgICAgICAgICBTZWxmOjpIYXNoQW5kTnVtYmVyIHsgbnVtYmVyOiBvbGRfbnVtYmVyLCBoYXNoIH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHJlcyA9IFNvbWUoKm9sZF9udW1iZXIpOwogICAgICAgICAgICAgICAgKnNlbGYgPSBTZWxmOjpIYXNoQW5kTnVtYmVyIHsgaGFzaDogKmhhc2gsIG51bWJlciB9OwogICAgICAgICAgICAgICAgcmVzCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8vIFJldHVybiB0aGUgaGFzaCBvZiB0aGUgdGFyZ2V0IGJsb2NrLCBpZiBpdCBpcyBzZXQuCiAgICBjb25zdCBmbiBoYXNoKCZzZWxmKSAtPiBPcHRpb248QjI1Nj4gewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpIYXNoKGhhc2gpIHwgU2VsZjo6SGFzaEFuZE51bWJlciB7IGhhc2gsIC4uIH0gPT4gU29tZSgqaGFzaCksCiAgICAgICAgICAgIFNlbGY6Ok51bWJlcihfKSA9PiBOb25lLAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmV0dXJuIHRoZSBibG9jayBudW1iZXIgb2YgdGhlIHN5bmMgdGFyZ2V0LCBpZiBpdCBpcyBzZXQuCiAgICBjb25zdCBmbiBudW1iZXIoJnNlbGYpIC0+IE9wdGlvbjx1NjQ+IHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6SGFzaChfKSA9PiBOb25lLAogICAgICAgICAgICBTZWxmOjpOdW1iZXIobnVtYmVyKSB8IFNlbGY6Okhhc2hBbmROdW1iZXIgeyBudW1iZXIsIC4uIH0gPT4gU29tZSgqbnVtYmVyKSwKICAgICAgICB9CiAgICB9Cn0KCi8vLyBUaGUgYnVpbGRlciBmb3IgW2BSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJgXSB3aXRoCi8vLyBzb21lIGRlZmF1bHQgc2V0dGluZ3MKI1tkZXJpdmUoRGVidWcpXQpwdWIgc3RydWN0IFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckJ1aWxkZXIgewogICAgLy8vIFRoZSBiYXRjaCBzaXplIHBlciBvbmUgcmVxdWVzdAogICAgcmVxdWVzdF9saW1pdDogdTY0LAogICAgLy8vIEJhdGNoIHNpemUgZm9yIGhlYWRlcnMKICAgIHN0cmVhbV9iYXRjaF9zaXplOiB1c2l6ZSwKICAgIC8vLyBCYXRjaCBzaXplIGZvciBoZWFkZXJzCiAgICBtaW5fY29uY3VycmVudF9yZXF1ZXN0czogdXNpemUsCiAgICAvLy8gQmF0Y2ggc2l6ZSBmb3IgaGVhZGVycwogICAgbWF4X2NvbmN1cnJlbnRfcmVxdWVzdHM6IHVzaXplLAogICAgLy8vIEhvdyBtYW55IHJlc3BvbnNlcyB0byBidWZmZXIKICAgIG1heF9idWZmZXJlZF9yZXNwb25zZXM6IHVzaXplLAp9CgppbXBsIFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckJ1aWxkZXIgewogICAgLy8vIENyZWF0ZXMgYSBuZXcgW2BSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJCdWlsZGVyYF0gd2l0aCBjb25maWd1cmF0aW9ucyBiYXNlZCBvbiB0aGUgcHJvdmlkZWQKICAgIC8vLyBbYEhlYWRlcnNDb25maWdgXS4KICAgIHB1YiBmbiBuZXcoY29uZmlnOiBIZWFkZXJzQ29uZmlnKSAtPiBTZWxmIHsKICAgICAgICBTZWxmOjpkZWZhdWx0KCkKICAgICAgICAgICAgLnJlcXVlc3RfbGltaXQoY29uZmlnLmRvd25sb2FkZXJfcmVxdWVzdF9saW1pdCkKICAgICAgICAgICAgLm1pbl9jb25jdXJyZW50X3JlcXVlc3RzKGNvbmZpZy5kb3dubG9hZGVyX21pbl9jb25jdXJyZW50X3JlcXVlc3RzKQogICAgICAgICAgICAubWF4X2NvbmN1cnJlbnRfcmVxdWVzdHMoY29uZmlnLmRvd25sb2FkZXJfbWF4X2NvbmN1cnJlbnRfcmVxdWVzdHMpCiAgICAgICAgICAgIC5tYXhfYnVmZmVyZWRfcmVzcG9uc2VzKGNvbmZpZy5kb3dubG9hZGVyX21heF9idWZmZXJlZF9yZXNwb25zZXMpCiAgICAgICAgICAgIC5zdHJlYW1fYmF0Y2hfc2l6ZShjb25maWcuY29tbWl0X3RocmVzaG9sZCBhcyB1c2l6ZSkKICAgIH0KfQoKaW1wbCBEZWZhdWx0IGZvciBSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJCdWlsZGVyIHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgc3RyZWFtX2JhdGNoX3NpemU6IDEwXzAwMCwKICAgICAgICAgICAgLy8gVGhpcyBpcyBqdXN0IGJlbG93IHRoZSBtYXggbnVtYmVyIG9mIGhlYWRlcnMgY29tbW9ubHkgaW4gYSBoZWFkZXJzIHJlc3BvbnNlICgxMDI0KSwgc2VlIGFsc28gPGh0dHBzOi8vZ2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9ibG9iL2IwZDQ0MzM4YmJjZWZlZTA0NGYxZjYzNWE4NDQ4N2NiYmQ4ZjA1MzgvZXRoL3Byb3RvY29scy9ldGgvaGFuZGxlci5nbyNMMzgtTDQwPgogICAgICAgICAgICAvLyB3aXRoIH41MDBieXRlcyBwZXIgaGVhZGVyIHRoaXMgYXJvdW5kIDAuNU1CIHBlciByZXF1ZXN0IG1heAogICAgICAgICAgICByZXF1ZXN0X2xpbWl0OiAxXzAwMCwKICAgICAgICAgICAgbWF4X2NvbmN1cnJlbnRfcmVxdWVzdHM6IDEwMCwKICAgICAgICAgICAgbWluX2NvbmN1cnJlbnRfcmVxdWVzdHM6IDUsCiAgICAgICAgICAgIG1heF9idWZmZXJlZF9yZXNwb25zZXM6IDEwMCwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyQnVpbGRlciB7CiAgICAvLy8gU2V0IHRoZSByZXF1ZXN0IGJhdGNoIHNpemUuCiAgICAvLy8KICAgIC8vLyBUaGlzIGRldGVybWluZXMgdGhlIGBsaW1pdGAgZm9yIGEgYEdldEJsb2NrSGVhZGVyc2AgcmVxdWVzdHMsIHRoZSBudW1iZXIgb2YgaGVhZGVycyB3ZSBhc2sKICAgIC8vLyBmb3IuCiAgICBwdWIgY29uc3QgZm4gcmVxdWVzdF9saW1pdChtdXQgc2VsZiwgbGltaXQ6IHU2NCkgLT4gU2VsZiB7CiAgICAgICAgc2VsZi5yZXF1ZXN0X2xpbWl0ID0gbGltaXQ7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBTZXQgdGhlIHN0cmVhbSBiYXRjaCBzaXplCiAgICAvLy8KICAgIC8vLyBUaGlzIGRldGVybWluZXMgdGhlIG51bWJlciBvZiBoZWFkZXJzIHRoZSBbYFJldmVyc2VIZWFkZXJzRG93bmxvYWRlcmBdIHdpbGwgeWllbGQgb24KICAgIC8vLyBgU3RyZWFtOjpuZXh0YC4gVGhpcyB3aWxsIGJlIHRoZSBhbW91bnQgb2YgaGVhZGVycyB0aGUgaGVhZGVycyBzdGFnZSB3aWxsIGNvbW1pdCBhdCBhCiAgICAvLy8gdGltZS4KICAgIHB1YiBjb25zdCBmbiBzdHJlYW1fYmF0Y2hfc2l6ZShtdXQgc2VsZiwgc2l6ZTogdXNpemUpIC0+IFNlbGYgewogICAgICAgIHNlbGYuc3RyZWFtX2JhdGNoX3NpemUgPSBzaXplOwogICAgICAgIHNlbGYKICAgIH0KCiAgICAvLy8gU2V0IHRoZSBtaW4gYW1vdW50IG9mIGNvbmN1cnJlbnQgcmVxdWVzdHMuCiAgICAvLy8KICAgIC8vLyBJZiB0aGVyZSdzIGNhcGFjaXR5IHRoZSBbYFJldmVyc2VIZWFkZXJzRG93bmxvYWRlcmBdIHdpbGwga2VlcCBhdCBsZWFzdCB0aGlzIG1hbnkgcmVxdWVzdHMKICAgIC8vLyBhY3RpdmUgYXQgYSB0aW1lLgogICAgcHViIGNvbnN0IGZuIG1pbl9jb25jdXJyZW50X3JlcXVlc3RzKG11dCBzZWxmLCBtaW5fY29uY3VycmVudF9yZXF1ZXN0czogdXNpemUpIC0+IFNlbGYgewogICAgICAgIHNlbGYubWluX2NvbmN1cnJlbnRfcmVxdWVzdHMgPSBtaW5fY29uY3VycmVudF9yZXF1ZXN0czsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIFNldCB0aGUgbWF4IGFtb3VudCBvZiBjb25jdXJyZW50IHJlcXVlc3RzLgogICAgLy8vCiAgICAvLy8gVGhlIGRvd25sb2FkZXIncyBjb25jdXJyZW50IHJlcXVlc3RzIHdvbid0IGV4Y2VlZCB0aGUgZ2l2ZW4gYW1vdW50LgogICAgcHViIGNvbnN0IGZuIG1heF9jb25jdXJyZW50X3JlcXVlc3RzKG11dCBzZWxmLCBtYXhfY29uY3VycmVudF9yZXF1ZXN0czogdXNpemUpIC0+IFNlbGYgewogICAgICAgIHNlbGYubWF4X2NvbmN1cnJlbnRfcmVxdWVzdHMgPSBtYXhfY29uY3VycmVudF9yZXF1ZXN0czsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIEhvdyBtYW55IHJlc3BvbnNlcyB0byBidWZmZXIgaW50ZXJuYWxseS4KICAgIC8vLwogICAgLy8vIFRoaXMgZXNzZW50aWFsbHkgZGV0ZXJtaW5lcyBob3cgbXVjaCBtZW1vcnkgdGhlIGRvd25sb2FkZXIgY2FuIHVzZSBmb3IgYnVmZmVyaW5nIHJlc3BvbnNlcwogICAgLy8vIHRoYXQgYXJyaXZlIG91dCBvZiBvcmRlci4gVGhlIHRvdGFsIG51bWJlciBvZiBidWZmZXJlZCBoZWFkZXJzIGlzIGByZXF1ZXN0X2xpbWl0ICoKICAgIC8vLyBtYXhfYnVmZmVyZWRfcmVzcG9uc2VzYC4gSWYgdGhlIFtgUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyYF0ncyBidWZmZXJlZCByZXNwb25zZXMgZXhjZWVkcwogICAgLy8vIHRoaXMgdGhyZXNob2xkIGl0IHdhaXRzIHVudGlsIHRoZXJlJ3MgY2FwYWNpdHkgYWdhaW4gYmVmb3JlIHNlbmRpbmcgbmV3IHJlcXVlc3RzLgogICAgcHViIGNvbnN0IGZuIG1heF9idWZmZXJlZF9yZXNwb25zZXMobXV0IHNlbGYsIG1heF9idWZmZXJlZF9yZXNwb25zZXM6IHVzaXplKSAtPiBTZWxmIHsKICAgICAgICBzZWxmLm1heF9idWZmZXJlZF9yZXNwb25zZXMgPSBtYXhfYnVmZmVyZWRfcmVzcG9uc2VzOwogICAgICAgIHNlbGYKICAgIH0KCiAgICAvLy8gQnVpbGQgW2BSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJgXSB3aXRoIHByb3ZpZGVkIGNvbnNlbnN1cwogICAgLy8vIGFuZCBoZWFkZXIgY2xpZW50IGltcGxlbWVudGF0aW9ucwogICAgcHViIGZuIGJ1aWxkPEg+KAogICAgICAgIHNlbGYsCiAgICAgICAgY2xpZW50OiBILAogICAgICAgIGNvbnNlbnN1czogQXJjPGR5biBIZWFkZXJWYWxpZGF0b3I8SDo6SGVhZGVyPj4sCiAgICApIC0+IFJldmVyc2VIZWFkZXJzRG93bmxvYWRlcjxIPgogICAgd2hlcmUKICAgICAgICBIOiBIZWFkZXJzQ2xpZW50ICsgJ3N0YXRpYywKICAgIHsKICAgICAgICBsZXQgU2VsZiB7CiAgICAgICAgICAgIHJlcXVlc3RfbGltaXQsCiAgICAgICAgICAgIHN0cmVhbV9iYXRjaF9zaXplLAogICAgICAgICAgICBtaW5fY29uY3VycmVudF9yZXF1ZXN0cywKICAgICAgICAgICAgbWF4X2NvbmN1cnJlbnRfcmVxdWVzdHMsCiAgICAgICAgICAgIG1heF9idWZmZXJlZF9yZXNwb25zZXMsCiAgICAgICAgfSA9IHNlbGY7CiAgICAgICAgUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyIHsKICAgICAgICAgICAgY29uc2Vuc3VzLAogICAgICAgICAgICBjbGllbnQ6IEFyYzo6bmV3KGNsaWVudCksCiAgICAgICAgICAgIGxvY2FsX2hlYWQ6IE5vbmUsCiAgICAgICAgICAgIHN5bmNfdGFyZ2V0OiBOb25lLAogICAgICAgICAgICAvLyBOb3RlOiB3ZSBzZXQgdGhlc2UgdG8gYDBgIGZpcnN0LCB0aGV5J2xsIGJlIHVwZGF0ZWQgb25jZSB0aGUgc3luYyB0YXJnZXQgcmVzcG9uc2UgaXMKICAgICAgICAgICAgLy8gaGFuZGxlZCBhbmQgb25seSB1c2VkIGFmdGVyd2FyZHMKICAgICAgICAgICAgbmV4dF9yZXF1ZXN0X2Jsb2NrX251bWJlcjogMCwKICAgICAgICAgICAgbmV4dF9jaGFpbl90aXBfYmxvY2tfbnVtYmVyOiAwLAogICAgICAgICAgICBsb3dlc3RfdmFsaWRhdGVkX2hlYWRlcjogTm9uZSwKICAgICAgICAgICAgcmVxdWVzdF9saW1pdCwKICAgICAgICAgICAgbWluX2NvbmN1cnJlbnRfcmVxdWVzdHMsCiAgICAgICAgICAgIG1heF9jb25jdXJyZW50X3JlcXVlc3RzLAogICAgICAgICAgICBzdHJlYW1fYmF0Y2hfc2l6ZSwKICAgICAgICAgICAgbWF4X2J1ZmZlcmVkX3Jlc3BvbnNlcywKICAgICAgICAgICAgc3luY190YXJnZXRfcmVxdWVzdDogTm9uZSwKICAgICAgICAgICAgaW5fcHJvZ3Jlc3NfcXVldWU6IERlZmF1bHQ6OmRlZmF1bHQoKSwKICAgICAgICAgICAgYnVmZmVyZWRfcmVzcG9uc2VzOiBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIHF1ZXVlZF92YWxpZGF0ZWRfaGVhZGVyczogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgICAgICBtZXRyaWNzOiBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgfQogICAgfQp9CgovLy8gQ29uZmlndXJlcyBhbmQgcmV0dXJucyB0aGUgbmV4dCBbYEhlYWRlcnNSZXF1ZXN0YF0gYmFzZWQgb24gdGhlIGdpdmVuIHBhcmFtZXRlcnMKLy8vCi8vLyBUaGUgcmVxdWVzdCB3aWxsIHN0YXJ0IGF0IHRoZSBnaXZlbiBgbmV4dF9yZXF1ZXN0X2Jsb2NrX251bWJlcmAgYmxvY2suCi8vLyBUaGUgYGxpbWl0YCBvZiB0aGUgcmVxdWVzdCB3aWxsIGVpdGhlciBiZSB0aGUgdGFyZ2V0ZWQgYHJlcXVlc3RfbGltaXRgIG9yIHRoZSBkaWZmZXJlbmNlIG9mCi8vLyBgbmV4dF9yZXF1ZXN0X2Jsb2NrX251bWJlcmAgYW5kIHRoZSBgbG9jYWxfaGVhZGAgaW4gY2FzZSB0aGlzIGlzIHNtYWxsZXIgdGhhbiB0aGUgdGFyZ2V0ZWQKLy8vIGByZXF1ZXN0X2xpbWl0YC4KI1tpbmxpbmVdCmZuIGNhbGNfbmV4dF9yZXF1ZXN0KAogICAgbG9jYWxfaGVhZDogdTY0LAogICAgbmV4dF9yZXF1ZXN0X2Jsb2NrX251bWJlcjogdTY0LAogICAgcmVxdWVzdF9saW1pdDogdTY0LAopIC0+IEhlYWRlcnNSZXF1ZXN0IHsKICAgIC8vIGRvd25sb2FkaW5nIGlzIGluIHJldmVyc2UKICAgIGxldCBkaWZmID0gbmV4dF9yZXF1ZXN0X2Jsb2NrX251bWJlciAtIGxvY2FsX2hlYWQ7CiAgICBsZXQgbGltaXQgPSBkaWZmLm1pbihyZXF1ZXN0X2xpbWl0KTsKICAgIGxldCBzdGFydCA9IG5leHRfcmVxdWVzdF9ibG9ja19udW1iZXI7CiAgICBIZWFkZXJzUmVxdWVzdDo6ZmFsbGluZyhzdGFydC5pbnRvKCksIGxpbWl0KQp9CgojW2NmZyh0ZXN0KV0KbW9kIHRlc3RzIHsKICAgIHVzZSBzdXBlcjo6KjsKICAgIHVzZSBjcmF0ZTo6aGVhZGVyczo6dGVzdF91dGlsczo6Y2hpbGRfaGVhZGVyOwogICAgdXNlIGFsbG95X2NvbnNlbnN1czo6SGVhZGVyOwogICAgdXNlIGFsbG95X2VpcHM6OntlaXAxODk4OjpCbG9ja1dpdGhQYXJlbnQsIEJsb2NrTnVtSGFzaH07CiAgICB1c2UgYXNzZXJ0X21hdGNoZXM6OmFzc2VydF9tYXRjaGVzOwogICAgdXNlIHJldGhfY29uc2Vuc3VzOjp0ZXN0X3V0aWxzOjpUZXN0Q29uc2Vuc3VzOwogICAgdXNlIHJldGhfbmV0d29ya19wMnA6OnRlc3RfdXRpbHM6OlRlc3RIZWFkZXJzQ2xpZW50OwoKICAgIC8vLyBUZXN0cyB0aGF0IGByZXBsYWNlX251bWJlcmAgd29ya3MgdGhlIHNhbWUgd2F5IGFzIGBPcHRpb246OnJlcGxhY2VgCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3JlcGxhY2VfbnVtYmVyX3NlbWFudGljcygpIHsKICAgICAgICBzdHJ1Y3QgRml4dHVyZSB7CiAgICAgICAgICAgIC8vIGlucHV0IGZpZWxkcyAoYm90aCBTeW5jVGFyZ2V0QmxvY2sgYW5kIE9wdGlvbjx1NjQ+KQogICAgICAgICAgICBzeW5jX3RhcmdldF9ibG9jazogU3luY1RhcmdldEJsb2NrLAogICAgICAgICAgICBzeW5jX3RhcmdldF9vcHRpb246IE9wdGlvbjx1NjQ+LAoKICAgICAgICAgICAgLy8gb3B0aW9uIHRvIHJlcGxhY2UKICAgICAgICAgICAgcmVwbGFjZV9udW1iZXI6IHU2NCwKCiAgICAgICAgICAgIC8vIGV4cGVjdGVkIG1ldGhvZCByZXN1bHQKICAgICAgICAgICAgZXhwZWN0ZWRfcmVzdWx0OiBPcHRpb248dTY0PiwKCiAgICAgICAgICAgIC8vIG91dHB1dCBzdGF0ZQogICAgICAgICAgICBuZXdfbnVtYmVyOiB1NjQsCiAgICAgICAgfQoKICAgICAgICBsZXQgZml4dHVyZXMgPSB2ZWMhWwogICAgICAgICAgICBGaXh0dXJlIHsKICAgICAgICAgICAgICAgIHN5bmNfdGFyZ2V0X2Jsb2NrOiBTeW5jVGFyZ2V0QmxvY2s6Okhhc2goQjI1Njo6cmFuZG9tKCkpLAogICAgICAgICAgICAgICAgLy8gSGFzaCBtYXBzIHRvIE5vbmUgaGVyZSwgYWxsIG90aGVyIHZhcmlhbnRzIG1hcCB0byBTb21lCiAgICAgICAgICAgICAgICBzeW5jX3RhcmdldF9vcHRpb246IE5vbmUsCiAgICAgICAgICAgICAgICByZXBsYWNlX251bWJlcjogMSwKICAgICAgICAgICAgICAgIGV4cGVjdGVkX3Jlc3VsdDogTm9uZSwKICAgICAgICAgICAgICAgIG5ld19udW1iZXI6IDEsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEZpeHR1cmUgewogICAgICAgICAgICAgICAgc3luY190YXJnZXRfYmxvY2s6IFN5bmNUYXJnZXRCbG9jazo6TnVtYmVyKDEpLAogICAgICAgICAgICAgICAgc3luY190YXJnZXRfb3B0aW9uOiBTb21lKDEpLAogICAgICAgICAgICAgICAgcmVwbGFjZV9udW1iZXI6IDIsCiAgICAgICAgICAgICAgICBleHBlY3RlZF9yZXN1bHQ6IFNvbWUoMSksCiAgICAgICAgICAgICAgICBuZXdfbnVtYmVyOiAyLAogICAgICAgICAgICB9LAogICAgICAgICAgICBGaXh0dXJlIHsKICAgICAgICAgICAgICAgIHN5bmNfdGFyZ2V0X2Jsb2NrOiBTeW5jVGFyZ2V0QmxvY2s6Okhhc2hBbmROdW1iZXIgewogICAgICAgICAgICAgICAgICAgIGhhc2g6IEIyNTY6OnJhbmRvbSgpLAogICAgICAgICAgICAgICAgICAgIG51bWJlcjogMSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzeW5jX3RhcmdldF9vcHRpb246IFNvbWUoMSksCiAgICAgICAgICAgICAgICByZXBsYWNlX251bWJlcjogMiwKICAgICAgICAgICAgICAgIGV4cGVjdGVkX3Jlc3VsdDogU29tZSgxKSwKICAgICAgICAgICAgICAgIG5ld19udW1iZXI6IDIsCiAgICAgICAgICAgIH0sCiAgICAgICAgXTsKCiAgICAgICAgZm9yIGZpeHR1cmUgaW4gZml4dHVyZXMgewogICAgICAgICAgICBsZXQgbXV0IHN5bmNfdGFyZ2V0X2Jsb2NrID0gZml4dHVyZS5zeW5jX3RhcmdldF9ibG9jazsKICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHN5bmNfdGFyZ2V0X2Jsb2NrLnJlcGxhY2VfbnVtYmVyKGZpeHR1cmUucmVwbGFjZV9udW1iZXIpOwogICAgICAgICAgICBhc3NlcnRfZXEhKHJlc3VsdCwgZml4dHVyZS5leHBlY3RlZF9yZXN1bHQpOwogICAgICAgICAgICBhc3NlcnRfZXEhKHN5bmNfdGFyZ2V0X2Jsb2NrLm51bWJlcigpLCBTb21lKGZpeHR1cmUubmV3X251bWJlcikpOwoKICAgICAgICAgICAgbGV0IG11dCBzeW5jX3RhcmdldF9vcHRpb24gPSBmaXh0dXJlLnN5bmNfdGFyZ2V0X29wdGlvbjsKICAgICAgICAgICAgbGV0IG9wdGlvbl9yZXN1bHQgPSBzeW5jX3RhcmdldF9vcHRpb24ucmVwbGFjZShmaXh0dXJlLnJlcGxhY2VfbnVtYmVyKTsKICAgICAgICAgICAgYXNzZXJ0X2VxIShvcHRpb25fcmVzdWx0LCBmaXh0dXJlLmV4cGVjdGVkX3Jlc3VsdCk7CiAgICAgICAgICAgIGFzc2VydF9lcSEoc3luY190YXJnZXRfb3B0aW9uLCBTb21lKGZpeHR1cmUubmV3X251bWJlcikpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gVGVzdHMgdGhhdCByZXF1ZXN0IGNhbGMgd29ya3MKICAgICNbdGVzdF0KICAgIGZuIHRlc3Rfc3luY190YXJnZXRfdXBkYXRlKCkgewogICAgICAgIGxldCBjbGllbnQgPSBBcmM6Om5ldyhUZXN0SGVhZGVyc0NsaWVudDo6ZGVmYXVsdCgpKTsKCiAgICAgICAgbGV0IGdlbmVzaXMgPSBTZWFsZWRIZWFkZXI6OmRlZmF1bHQoKTsKCiAgICAgICAgbGV0IG11dCBkb3dubG9hZGVyID0gUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyQnVpbGRlcjo6ZGVmYXVsdCgpCiAgICAgICAgICAgIC5idWlsZChBcmM6OmNsb25lKCZjbGllbnQpLCBBcmM6Om5ldyhUZXN0Q29uc2Vuc3VzOjpkZWZhdWx0KCkpKTsKICAgICAgICBkb3dubG9hZGVyLnVwZGF0ZV9sb2NhbF9oZWFkKGdlbmVzaXMpOwogICAgICAgIGRvd25sb2FkZXIudXBkYXRlX3N5bmNfdGFyZ2V0KFN5bmNUYXJnZXQ6OlRpcChCMjU2OjpyYW5kb20oKSkpOwoKICAgICAgICBkb3dubG9hZGVyLnN5bmNfdGFyZ2V0X3JlcXVlc3QudGFrZSgpOwoKICAgICAgICBsZXQgdGFyZ2V0ID0gU3luY1RhcmdldDo6VGlwKEIyNTY6OnJhbmRvbSgpKTsKICAgICAgICBkb3dubG9hZGVyLnVwZGF0ZV9zeW5jX3RhcmdldCh0YXJnZXQpOwogICAgICAgIGFzc2VydCEoZG93bmxvYWRlci5zeW5jX3RhcmdldF9yZXF1ZXN0LmlzX3NvbWUoKSk7CgogICAgICAgIGRvd25sb2FkZXIuc3luY190YXJnZXRfcmVxdWVzdC50YWtlKCk7CiAgICAgICAgbGV0IHRhcmdldCA9IFN5bmNUYXJnZXQ6OkdhcChCbG9ja1dpdGhQYXJlbnQgewogICAgICAgICAgICBibG9jazogQmxvY2tOdW1IYXNoOjpuZXcoMCwgQjI1Njo6cmFuZG9tKCkpLAogICAgICAgICAgICBwYXJlbnQ6IERlZmF1bHQ6OmRlZmF1bHQoKSwKICAgICAgICB9KTsKICAgICAgICBkb3dubG9hZGVyLnVwZGF0ZV9zeW5jX3RhcmdldCh0YXJnZXQpOwogICAgICAgIGFzc2VydCEoZG93bmxvYWRlci5zeW5jX3RhcmdldF9yZXF1ZXN0LmlzX25vbmUoKSk7CiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKAogICAgICAgICAgICBkb3dubG9hZGVyLnN5bmNfdGFyZ2V0LAogICAgICAgICAgICBTb21lKHRhcmdldCkgPT4gdGFyZ2V0Lm51bWJlcigpLmlzX3NvbWUoKQogICAgICAgICk7CiAgICB9CgogICAgLy8vIFRlc3RzIHRoYXQgcmVxdWVzdCBjYWxjIHdvcmtzCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2hlYWRfdXBkYXRlKCkgewogICAgICAgIGxldCBjbGllbnQgPSBBcmM6Om5ldyhUZXN0SGVhZGVyc0NsaWVudDo6ZGVmYXVsdCgpKTsKCiAgICAgICAgbGV0IGhlYWRlcjogU2VhbGVkSGVhZGVyID0gU2VhbGVkSGVhZGVyOjpkZWZhdWx0KCk7CgogICAgICAgIGxldCBtdXQgZG93bmxvYWRlciA9IFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAuYnVpbGQoQXJjOjpjbG9uZSgmY2xpZW50KSwgQXJjOjpuZXcoVGVzdENvbnNlbnN1czo6ZGVmYXVsdCgpKSk7CiAgICAgICAgZG93bmxvYWRlci51cGRhdGVfbG9jYWxfaGVhZChoZWFkZXIuY2xvbmUoKSk7CiAgICAgICAgZG93bmxvYWRlci51cGRhdGVfc3luY190YXJnZXQoU3luY1RhcmdldDo6VGlwKEIyNTY6OnJhbmRvbSgpKSk7CgogICAgICAgIGRvd25sb2FkZXIucXVldWVkX3ZhbGlkYXRlZF9oZWFkZXJzLnB1c2goaGVhZGVyLmNsb25lKCkpOwogICAgICAgIGxldCBtdXQgbmV4dCA9IGhlYWRlci5hc19yZWYoKS5jbG9uZSgpOwogICAgICAgIG5leHQubnVtYmVyICs9IDE7CiAgICAgICAgZG93bmxvYWRlci51cGRhdGVfbG9jYWxfaGVhZChTZWFsZWRIZWFkZXI6Om5ldyhuZXh0LCBCMjU2OjpyYW5kb20oKSkpOwogICAgICAgIGFzc2VydCEoZG93bmxvYWRlci5xdWV1ZWRfdmFsaWRhdGVkX2hlYWRlcnMuaXNfZW1wdHkoKSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9yZXF1ZXN0X2NhbGMoKSB7CiAgICAgICAgLy8gcmVxdWVzdCBhbiBlbnRpcmUgYmF0Y2gKICAgICAgICBsZXQgbG9jYWwgPSAwOwogICAgICAgIGxldCBuZXh0ID0gMTAwMDsKICAgICAgICBsZXQgYmF0Y2hfc2l6ZSA9IDI7CiAgICAgICAgbGV0IHJlcXVlc3QgPSBjYWxjX25leHRfcmVxdWVzdChsb2NhbCwgbmV4dCwgYmF0Y2hfc2l6ZSk7CiAgICAgICAgYXNzZXJ0X2VxIShyZXF1ZXN0LnN0YXJ0LCBuZXh0LmludG8oKSk7CiAgICAgICAgYXNzZXJ0X2VxIShyZXF1ZXN0LmxpbWl0LCBiYXRjaF9zaXplKTsKCiAgICAgICAgLy8gb25seSByZXF1ZXN0IDEKICAgICAgICBsZXQgbG9jYWwgPSA5OTk7CiAgICAgICAgbGV0IG5leHQgPSAxMDAwOwogICAgICAgIGxldCBiYXRjaF9zaXplID0gMjsKICAgICAgICBsZXQgcmVxdWVzdCA9IGNhbGNfbmV4dF9yZXF1ZXN0KGxvY2FsLCBuZXh0LCBiYXRjaF9zaXplKTsKICAgICAgICBhc3NlcnRfZXEhKHJlcXVlc3Quc3RhcnQsIG5leHQuaW50bygpKTsKICAgICAgICBhc3NlcnRfZXEhKHJlcXVlc3QubGltaXQsIDEpOwogICAgfQoKICAgIC8vLyBUZXN0cyB0aGF0IHJlcXVlc3QgY2FsYyB3b3JrcwogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9uZXh0X3JlcXVlc3QoKSB7CiAgICAgICAgbGV0IGNsaWVudCA9IEFyYzo6bmV3KFRlc3RIZWFkZXJzQ2xpZW50OjpkZWZhdWx0KCkpOwoKICAgICAgICBsZXQgZ2VuZXNpcyA9IFNlYWxlZEhlYWRlcjo6ZGVmYXVsdCgpOwoKICAgICAgICBsZXQgYmF0Y2hfc2l6ZSA9IDk5OwogICAgICAgIGxldCBzdGFydCA9IDEwMDA7CiAgICAgICAgbGV0IG11dCBkb3dubG9hZGVyID0gUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyQnVpbGRlcjo6ZGVmYXVsdCgpCiAgICAgICAgICAgIC5yZXF1ZXN0X2xpbWl0KGJhdGNoX3NpemUpCiAgICAgICAgICAgIC5idWlsZChBcmM6OmNsb25lKCZjbGllbnQpLCBBcmM6Om5ldyhUZXN0Q29uc2Vuc3VzOjpkZWZhdWx0KCkpKTsKICAgICAgICBkb3dubG9hZGVyLnVwZGF0ZV9sb2NhbF9oZWFkKGdlbmVzaXMpOwogICAgICAgIGRvd25sb2FkZXIudXBkYXRlX3N5bmNfdGFyZ2V0KFN5bmNUYXJnZXQ6OlRpcChCMjU2OjpyYW5kb20oKSkpOwoKICAgICAgICBkb3dubG9hZGVyLm5leHRfcmVxdWVzdF9ibG9ja19udW1iZXIgPSBzdGFydDsKCiAgICAgICAgbGV0IG11dCB0b3RhbCA9IDA7CiAgICAgICAgd2hpbGUgbGV0IFNvbWUocmVxKSA9IGRvd25sb2FkZXIubmV4dF9yZXF1ZXN0KCkgewogICAgICAgICAgICBhc3NlcnRfZXEhKHJlcS5zdGFydCwgKHN0YXJ0IC0gdG90YWwpLmludG8oKSk7CiAgICAgICAgICAgIHRvdGFsICs9IHJlcS5saW1pdDsKICAgICAgICB9CiAgICAgICAgYXNzZXJ0X2VxISh0b3RhbCwgc3RhcnQpOwogICAgICAgIGFzc2VydF9lcSEoU29tZShkb3dubG9hZGVyLm5leHRfcmVxdWVzdF9ibG9ja19udW1iZXIpLCBkb3dubG9hZGVyLmxvY2FsX2Jsb2NrX251bWJlcigpKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3Jlc3Bfb3JkZXIoKSB7CiAgICAgICAgbGV0IG11dCBoZWFwID0gQmluYXJ5SGVhcDo6bmV3KCk7CiAgICAgICAgbGV0IGhpID0gMXU2NDsKICAgICAgICBoZWFwLnB1c2goT3JkZXJlZEhlYWRlcnNSZXNwb25zZTo6PEhlYWRlcj4gewogICAgICAgICAgICBoZWFkZXJzOiB2ZWMhW10sCiAgICAgICAgICAgIHJlcXVlc3Q6IEhlYWRlcnNSZXF1ZXN0IHsgc3RhcnQ6IGhpLmludG8oKSwgbGltaXQ6IDAsIGRpcmVjdGlvbjogRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgICAgIHBlZXJfaWQ6IERlZmF1bHQ6OmRlZmF1bHQoKSwKICAgICAgICB9KTsKCiAgICAgICAgbGV0IGxvID0gMHU2NDsKICAgICAgICBoZWFwLnB1c2goT3JkZXJlZEhlYWRlcnNSZXNwb25zZSB7CiAgICAgICAgICAgIGhlYWRlcnM6IHZlYyFbXSwKICAgICAgICAgICAgcmVxdWVzdDogSGVhZGVyc1JlcXVlc3QgeyBzdGFydDogbG8uaW50bygpLCBsaW1pdDogMCwgZGlyZWN0aW9uOiBEZWZhdWx0OjpkZWZhdWx0KCkgfSwKICAgICAgICAgICAgcGVlcl9pZDogRGVmYXVsdDo6ZGVmYXVsdCgpLAogICAgICAgIH0pOwoKICAgICAgICBhc3NlcnRfZXEhKGhlYXAucG9wKCkudW53cmFwKCkuYmxvY2tfbnVtYmVyKCksIGhpKTsKICAgICAgICBhc3NlcnRfZXEhKGhlYXAucG9wKCkudW53cmFwKCkuYmxvY2tfbnVtYmVyKCksIGxvKTsKICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gZG93bmxvYWRfYXRfZm9ya19oZWFkKCkgewogICAgICAgIHJldGhfdHJhY2luZzo6aW5pdF90ZXN0X3RyYWNpbmcoKTsKCiAgICAgICAgbGV0IGNsaWVudCA9IEFyYzo6bmV3KFRlc3RIZWFkZXJzQ2xpZW50OjpkZWZhdWx0KCkpOwoKICAgICAgICBsZXQgcDMgPSBTZWFsZWRIZWFkZXI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgcDIgPSBjaGlsZF9oZWFkZXIoJnAzKTsKICAgICAgICBsZXQgcDEgPSBjaGlsZF9oZWFkZXIoJnAyKTsKICAgICAgICBsZXQgcDAgPSBjaGlsZF9oZWFkZXIoJnAxKTsKCiAgICAgICAgbGV0IG11dCBkb3dubG9hZGVyID0gUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyQnVpbGRlcjo6ZGVmYXVsdCgpCiAgICAgICAgICAgIC5zdHJlYW1fYmF0Y2hfc2l6ZSgzKQogICAgICAgICAgICAucmVxdWVzdF9saW1pdCgzKQogICAgICAgICAgICAuYnVpbGQoQXJjOjpjbG9uZSgmY2xpZW50KSwgQXJjOjpuZXcoVGVzdENvbnNlbnN1czo6ZGVmYXVsdCgpKSk7CiAgICAgICAgZG93bmxvYWRlci51cGRhdGVfbG9jYWxfaGVhZChwMy5jbG9uZSgpKTsKICAgICAgICBkb3dubG9hZGVyLnVwZGF0ZV9zeW5jX3RhcmdldChTeW5jVGFyZ2V0OjpUaXAocDAuaGFzaCgpKSk7CgogICAgICAgIGNsaWVudAogICAgICAgICAgICAuZXh0ZW5kKHZlYyFbCiAgICAgICAgICAgICAgICBwMC5hc19yZWYoKS5jbG9uZSgpLAogICAgICAgICAgICAgICAgcDEuYXNfcmVmKCkuY2xvbmUoKSwKICAgICAgICAgICAgICAgIHAyLmFzX3JlZigpLmNsb25lKCksCiAgICAgICAgICAgICAgICBwMy5hc19yZWYoKS5jbG9uZSgpLAogICAgICAgICAgICBdKQogICAgICAgICAgICAuYXdhaXQ7CgogICAgICAgIGxldCBoZWFkZXJzID0gZG93bmxvYWRlci5uZXh0KCkuYXdhaXQudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShoZWFkZXJzLnVud3JhcCgpLCB2ZWMhW3AwLCBwMSwgcDIsXSk7CiAgICAgICAgYXNzZXJ0IShkb3dubG9hZGVyLmJ1ZmZlcmVkX3Jlc3BvbnNlcy5pc19lbXB0eSgpKTsKICAgICAgICBhc3NlcnQhKGRvd25sb2FkZXIubmV4dCgpLmF3YWl0LmlzX25vbmUoKSk7CiAgICAgICAgYXNzZXJ0IShkb3dubG9hZGVyLm5leHQoKS5hd2FpdC5pc19ub25lKCkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBkb3dubG9hZF9vbmVfYnlfb25lKCkgewogICAgICAgIHJldGhfdHJhY2luZzo6aW5pdF90ZXN0X3RyYWNpbmcoKTsKICAgICAgICBsZXQgcDMgPSBTZWFsZWRIZWFkZXI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgcDIgPSBjaGlsZF9oZWFkZXIoJnAzKTsKICAgICAgICBsZXQgcDEgPSBjaGlsZF9oZWFkZXIoJnAyKTsKICAgICAgICBsZXQgcDAgPSBjaGlsZF9oZWFkZXIoJnAxKTsKCiAgICAgICAgbGV0IGNsaWVudCA9IEFyYzo6bmV3KFRlc3RIZWFkZXJzQ2xpZW50OjpkZWZhdWx0KCkpOwogICAgICAgIGxldCBtdXQgZG93bmxvYWRlciA9IFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAuc3RyZWFtX2JhdGNoX3NpemUoMSkKICAgICAgICAgICAgLnJlcXVlc3RfbGltaXQoMSkKICAgICAgICAgICAgLmJ1aWxkKEFyYzo6Y2xvbmUoJmNsaWVudCksIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSkpOwogICAgICAgIGRvd25sb2FkZXIudXBkYXRlX2xvY2FsX2hlYWQocDMuY2xvbmUoKSk7CiAgICAgICAgZG93bmxvYWRlci51cGRhdGVfc3luY190YXJnZXQoU3luY1RhcmdldDo6VGlwKHAwLmhhc2goKSkpOwoKICAgICAgICBjbGllbnQKICAgICAgICAgICAgLmV4dGVuZCh2ZWMhWwogICAgICAgICAgICAgICAgcDAuYXNfcmVmKCkuY2xvbmUoKSwKICAgICAgICAgICAgICAgIHAxLmFzX3JlZigpLmNsb25lKCksCiAgICAgICAgICAgICAgICBwMi5hc19yZWYoKS5jbG9uZSgpLAogICAgICAgICAgICAgICAgcDMuYXNfcmVmKCkuY2xvbmUoKSwKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLmF3YWl0OwoKICAgICAgICBsZXQgaGVhZGVycyA9IGRvd25sb2FkZXIubmV4dCgpLmF3YWl0LnVud3JhcCgpOwogICAgICAgIGxldCBoZWFkZXJzID0gaGVhZGVycy51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKGhlYWRlcnMsIHZlYyFbcDBdKTsKICAgICAgICBhc3NlcnRfZXEhKGhlYWRlcnMuY2FwYWNpdHkoKSwgaGVhZGVycy5sZW4oKSk7CgogICAgICAgIGxldCBoZWFkZXJzID0gZG93bmxvYWRlci5uZXh0KCkuYXdhaXQudW53cmFwKCk7CiAgICAgICAgbGV0IGhlYWRlcnMgPSBoZWFkZXJzLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEoaGVhZGVycywgdmVjIVtwMV0pOwogICAgICAgIGFzc2VydF9lcSEoaGVhZGVycy5jYXBhY2l0eSgpLCBoZWFkZXJzLmxlbigpKTsKCiAgICAgICAgbGV0IGhlYWRlcnMgPSBkb3dubG9hZGVyLm5leHQoKS5hd2FpdC51bndyYXAoKTsKICAgICAgICBsZXQgaGVhZGVycyA9IGhlYWRlcnMudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShoZWFkZXJzLCB2ZWMhW3AyXSk7CiAgICAgICAgYXNzZXJ0X2VxIShoZWFkZXJzLmNhcGFjaXR5KCksIGhlYWRlcnMubGVuKCkpOwoKICAgICAgICBhc3NlcnQhKGRvd25sb2FkZXIubmV4dCgpLmF3YWl0LmlzX25vbmUoKSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGRvd25sb2FkX29uZV9ieV9vbmVfbGFyZ2VyX3JlcXVlc3RfbGltaXQoKSB7CiAgICAgICAgcmV0aF90cmFjaW5nOjppbml0X3Rlc3RfdHJhY2luZygpOwogICAgICAgIGxldCBwMyA9IFNlYWxlZEhlYWRlcjo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBwMiA9IGNoaWxkX2hlYWRlcigmcDMpOwogICAgICAgIGxldCBwMSA9IGNoaWxkX2hlYWRlcigmcDIpOwogICAgICAgIGxldCBwMCA9IGNoaWxkX2hlYWRlcigmcDEpOwoKICAgICAgICBsZXQgY2xpZW50ID0gQXJjOjpuZXcoVGVzdEhlYWRlcnNDbGllbnQ6OmRlZmF1bHQoKSk7CiAgICAgICAgbGV0IG11dCBkb3dubG9hZGVyID0gUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyQnVpbGRlcjo6ZGVmYXVsdCgpCiAgICAgICAgICAgIC5zdHJlYW1fYmF0Y2hfc2l6ZSgxKQogICAgICAgICAgICAucmVxdWVzdF9saW1pdCgzKQogICAgICAgICAgICAuYnVpbGQoQXJjOjpjbG9uZSgmY2xpZW50KSwgQXJjOjpuZXcoVGVzdENvbnNlbnN1czo6ZGVmYXVsdCgpKSk7CiAgICAgICAgZG93bmxvYWRlci51cGRhdGVfbG9jYWxfaGVhZChwMy5jbG9uZSgpKTsKICAgICAgICBkb3dubG9hZGVyLnVwZGF0ZV9zeW5jX3RhcmdldChTeW5jVGFyZ2V0OjpUaXAocDAuaGFzaCgpKSk7CgogICAgICAgIGNsaWVudAogICAgICAgICAgICAuZXh0ZW5kKHZlYyFbCiAgICAgICAgICAgICAgICBwMC5hc19yZWYoKS5jbG9uZSgpLAogICAgICAgICAgICAgICAgcDEuYXNfcmVmKCkuY2xvbmUoKSwKICAgICAgICAgICAgICAgIHAyLmFzX3JlZigpLmNsb25lKCksCiAgICAgICAgICAgICAgICBwMy5hc19yZWYoKS5jbG9uZSgpLAogICAgICAgICAgICBdKQogICAgICAgICAgICAuYXdhaXQ7CgogICAgICAgIGxldCBoZWFkZXJzID0gZG93bmxvYWRlci5uZXh0KCkuYXdhaXQudW53cmFwKCk7CiAgICAgICAgbGV0IGhlYWRlcnMgPSBoZWFkZXJzLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEoaGVhZGVycywgdmVjIVtwMF0pOwogICAgICAgIGFzc2VydF9lcSEoaGVhZGVycy5jYXBhY2l0eSgpLCBoZWFkZXJzLmxlbigpKTsKCiAgICAgICAgbGV0IGhlYWRlcnMgPSBkb3dubG9hZGVyLm5leHQoKS5hd2FpdC51bndyYXAoKTsKICAgICAgICBsZXQgaGVhZGVycyA9IGhlYWRlcnMudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShoZWFkZXJzLCB2ZWMhW3AxXSk7CiAgICAgICAgYXNzZXJ0X2VxIShoZWFkZXJzLmNhcGFjaXR5KCksIGhlYWRlcnMubGVuKCkpOwoKICAgICAgICBsZXQgaGVhZGVycyA9IGRvd25sb2FkZXIubmV4dCgpLmF3YWl0LnVud3JhcCgpOwogICAgICAgIGxldCBoZWFkZXJzID0gaGVhZGVycy51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKGhlYWRlcnMsIHZlYyFbcDJdKTsKICAgICAgICBhc3NlcnRfZXEhKGhlYWRlcnMuY2FwYWNpdHkoKSwgaGVhZGVycy5sZW4oKSk7CgogICAgICAgIGFzc2VydCEoZG93bmxvYWRlci5uZXh0KCkuYXdhaXQuaXNfbm9uZSgpKTsKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L2Rvd25sb2FkZXJzL3NyYy9oZWFkZXJzL3Rhc2sucnMiPgp1c2UgYWxsb3lfcHJpbWl0aXZlczo6U2VhbGFibGU7CnVzZSBmdXR1cmVzOjp7RnV0dXJlRXh0LCBTdHJlYW19Owp1c2UgZnV0dXJlc191dGlsOjpTdHJlYW1FeHQ7CnVzZSBwaW5fcHJvamVjdDo6cGluX3Byb2plY3Q7CnVzZSByZXRoX25ldHdvcmtfcDJwOjpoZWFkZXJzOjp7CiAgICBkb3dubG9hZGVyOjp7SGVhZGVyRG93bmxvYWRlciwgU3luY1RhcmdldH0sCiAgICBlcnJvcjo6SGVhZGVyc0Rvd25sb2FkZXJSZXN1bHQsCn07CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjpTZWFsZWRIZWFkZXI7CnVzZSByZXRoX3Rhc2tzOjp7VGFza1NwYXduZXIsIFRva2lvVGFza0V4ZWN1dG9yfTsKdXNlIHN0ZDo6ewogICAgZm10OjpEZWJ1ZywKICAgIGZ1dHVyZTo6RnV0dXJlLAogICAgcGluOjpQaW4sCiAgICB0YXNrOjp7cmVhZHksIENvbnRleHQsIFBvbGx9LAp9Owp1c2UgdG9raW86OnN5bmM6OnttcHNjLCBtcHNjOjpVbmJvdW5kZWRTZW5kZXJ9Owp1c2UgdG9raW9fc3RyZWFtOjp3cmFwcGVyczo6e1JlY2VpdmVyU3RyZWFtLCBVbmJvdW5kZWRSZWNlaXZlclN0cmVhbX07CnVzZSB0b2tpb191dGlsOjpzeW5jOjpQb2xsU2VuZGVyOwoKLy8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiBoZWFkZXIgcmVzdWx0cyB0byBob2xkIGluIHRoZSBidWZmZXIuCnB1YiBjb25zdCBIRUFERVJTX1RBU0tfQlVGRkVSX1NJWkU6IHVzaXplID0gODsKCi8vLyBBIFtIZWFkZXJEb3dubG9hZGVyXSB0aGF0IGRyaXZlcyBhIHNwYXduZWQgW0hlYWRlckRvd25sb2FkZXJdIG9uIGEgc3Bhd25lZCB0YXNrLgojW2Rlcml2ZShEZWJ1ZyldCiNbcGluX3Byb2plY3RdCnB1YiBzdHJ1Y3QgVGFza0Rvd25sb2FkZXI8SDogU2VhbGFibGU+IHsKICAgICNbcGluXQogICAgZnJvbV9kb3dubG9hZGVyOiBSZWNlaXZlclN0cmVhbTxIZWFkZXJzRG93bmxvYWRlclJlc3VsdDxWZWM8U2VhbGVkSGVhZGVyPEg+PiwgSD4+LAogICAgdG9fZG93bmxvYWRlcjogVW5ib3VuZGVkU2VuZGVyPERvd25sb2FkZXJVcGRhdGVzPEg+PiwKfQoKLy8gPT09IGltcGwgVGFza0Rvd25sb2FkZXIgPT09CgppbXBsPEg6IFNlYWxhYmxlICsgU2VuZCArIFN5bmMgKyBVbnBpbiArICdzdGF0aWM+IFRhc2tEb3dubG9hZGVyPEg+IHsKICAgIC8vLyBTcGF3bnMgdGhlIGdpdmVuIGBkb3dubG9hZGVyYCB2aWEgW2B0b2tpbzo6dGFzazo6c3Bhd25gXSBhbmQgcmV0dXJucyBhIFtgVGFza0Rvd25sb2FkZXJgXQogICAgLy8vIHRoYXQncyBjb25uZWN0ZWQgdG8gdGhhdCB0YXNrLgogICAgLy8vCiAgICAvLy8gIyBQYW5pY3MKICAgIC8vLwogICAgLy8vIFRoaXMgbWV0aG9kIHBhbmljcyBpZiBjYWxsZWQgb3V0c2lkZSBvZiBhIFRva2lvIHJ1bnRpbWUKICAgIC8vLwogICAgLy8vICMgRXhhbXBsZQogICAgLy8vCiAgICAvLy8gYGBgCiAgICAvLy8gIyB1c2Ugc3RkOjpzeW5jOjpBcmM7CiAgICAvLy8gIyB1c2UgcmV0aF9kb3dubG9hZGVyczo6aGVhZGVyczo6cmV2ZXJzZV9oZWFkZXJzOjpSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXI7CiAgICAvLy8gIyB1c2UgcmV0aF9kb3dubG9hZGVyczo6aGVhZGVyczo6dGFzazo6VGFza0Rvd25sb2FkZXI7CiAgICAvLy8gIyB1c2UgcmV0aF9jb25zZW5zdXM6OkhlYWRlclZhbGlkYXRvcjsKICAgIC8vLyAjIHVzZSByZXRoX25ldHdvcmtfcDJwOjpoZWFkZXJzOjpjbGllbnQ6OkhlYWRlcnNDbGllbnQ7CiAgICAvLy8gIyB1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6QmxvY2tIZWFkZXI7CiAgICAvLy8gIyBmbiB0PEg6IEhlYWRlcnNDbGllbnQ8SGVhZGVyOiBCbG9ja0hlYWRlcj4gKyAnc3RhdGljPihjb25zZW5zdXM6QXJjPGR5biBIZWFkZXJWYWxpZGF0b3I8SDo6SGVhZGVyPj4sIGNsaWVudDogQXJjPEg+KSB7CiAgICAvLy8gICAgbGV0IGRvd25sb2FkZXIgPSBSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXI6OjxIPjo6YnVpbGRlcigpLmJ1aWxkKAogICAgLy8vICAgICAgICBjbGllbnQsCiAgICAvLy8gICAgICAgIGNvbnNlbnN1cwogICAgLy8vICAgICApOwogICAgLy8vICAgbGV0IGRvd25sb2FkZXIgPSBUYXNrRG93bmxvYWRlcjo6c3Bhd24oZG93bmxvYWRlcik7CiAgICAvLy8gIyB9CiAgICBwdWIgZm4gc3Bhd248VD4oZG93bmxvYWRlcjogVCkgLT4gU2VsZgogICAgd2hlcmUKICAgICAgICBUOiBIZWFkZXJEb3dubG9hZGVyPEhlYWRlciA9IEg+ICsgJ3N0YXRpYywKICAgIHsKICAgICAgICBTZWxmOjpzcGF3bl93aXRoKGRvd25sb2FkZXIsICZUb2tpb1Rhc2tFeGVjdXRvcjo6ZGVmYXVsdCgpKQogICAgfQoKICAgIC8vLyBTcGF3bnMgdGhlIGdpdmVuIGBkb3dubG9hZGVyYCB2aWEgdGhlIGdpdmVuIFtgVGFza1NwYXduZXJgXSByZXR1cm5zIGEgW2BUYXNrRG93bmxvYWRlcmBdCiAgICAvLy8gdGhhdCdzIGNvbm5lY3RlZCB0byB0aGF0IHRhc2suCiAgICBwdWIgZm4gc3Bhd25fd2l0aDxULCBTPihkb3dubG9hZGVyOiBULCBzcGF3bmVyOiAmUykgLT4gU2VsZgogICAgd2hlcmUKICAgICAgICBUOiBIZWFkZXJEb3dubG9hZGVyPEhlYWRlciA9IEg+ICsgJ3N0YXRpYywKICAgICAgICBTOiBUYXNrU3Bhd25lciwKICAgIHsKICAgICAgICBsZXQgKGhlYWRlcnNfdHgsIGhlYWRlcnNfcngpID0gbXBzYzo6Y2hhbm5lbChIRUFERVJTX1RBU0tfQlVGRkVSX1NJWkUpOwogICAgICAgIGxldCAodG9fZG93bmxvYWRlciwgdXBkYXRlc19yeCkgPSBtcHNjOjp1bmJvdW5kZWRfY2hhbm5lbCgpOwoKICAgICAgICBsZXQgZG93bmxvYWRlciA9IFNwYXduZWREb3dubG9hZGVyIHsKICAgICAgICAgICAgaGVhZGVyc190eDogUG9sbFNlbmRlcjo6bmV3KGhlYWRlcnNfdHgpLAogICAgICAgICAgICB1cGRhdGVzOiBVbmJvdW5kZWRSZWNlaXZlclN0cmVhbTo6bmV3KHVwZGF0ZXNfcngpLAogICAgICAgICAgICBkb3dubG9hZGVyLAogICAgICAgIH07CiAgICAgICAgc3Bhd25lci5zcGF3bihkb3dubG9hZGVyLmJveGVkKCkpOwoKICAgICAgICBTZWxmIHsgZnJvbV9kb3dubG9hZGVyOiBSZWNlaXZlclN0cmVhbTo6bmV3KGhlYWRlcnNfcngpLCB0b19kb3dubG9hZGVyIH0KICAgIH0KfQoKaW1wbDxIOiBTZWFsYWJsZSArIERlYnVnICsgU2VuZCArIFN5bmMgKyBVbnBpbiArICdzdGF0aWM+IEhlYWRlckRvd25sb2FkZXIgZm9yIFRhc2tEb3dubG9hZGVyPEg+IHsKICAgIHR5cGUgSGVhZGVyID0gSDsKCiAgICBmbiB1cGRhdGVfc3luY19nYXAoJm11dCBzZWxmLCBoZWFkOiBTZWFsZWRIZWFkZXI8SD4sIHRhcmdldDogU3luY1RhcmdldCkgewogICAgICAgIGxldCBfID0gc2VsZi50b19kb3dubG9hZGVyLnNlbmQoRG93bmxvYWRlclVwZGF0ZXM6OlVwZGF0ZVN5bmNHYXAoaGVhZCwgdGFyZ2V0KSk7CiAgICB9CgogICAgZm4gdXBkYXRlX2xvY2FsX2hlYWQoJm11dCBzZWxmLCBoZWFkOiBTZWFsZWRIZWFkZXI8SD4pIHsKICAgICAgICBsZXQgXyA9IHNlbGYudG9fZG93bmxvYWRlci5zZW5kKERvd25sb2FkZXJVcGRhdGVzOjpVcGRhdGVMb2NhbEhlYWQoaGVhZCkpOwogICAgfQoKICAgIGZuIHVwZGF0ZV9zeW5jX3RhcmdldCgmbXV0IHNlbGYsIHRhcmdldDogU3luY1RhcmdldCkgewogICAgICAgIGxldCBfID0gc2VsZi50b19kb3dubG9hZGVyLnNlbmQoRG93bmxvYWRlclVwZGF0ZXM6OlVwZGF0ZVN5bmNUYXJnZXQodGFyZ2V0KSk7CiAgICB9CgogICAgZm4gc2V0X2JhdGNoX3NpemUoJm11dCBzZWxmLCBsaW1pdDogdXNpemUpIHsKICAgICAgICBsZXQgXyA9IHNlbGYudG9fZG93bmxvYWRlci5zZW5kKERvd25sb2FkZXJVcGRhdGVzOjpTZXRCYXRjaFNpemUobGltaXQpKTsKICAgIH0KfQoKaW1wbDxIOiBTZWFsYWJsZT4gU3RyZWFtIGZvciBUYXNrRG93bmxvYWRlcjxIPiB7CiAgICB0eXBlIEl0ZW0gPSBIZWFkZXJzRG93bmxvYWRlclJlc3VsdDxWZWM8U2VhbGVkSGVhZGVyPEg+PiwgSD47CgogICAgZm4gcG9sbF9uZXh0KHNlbGY6IFBpbjwmbXV0IFNlbGY+LCBjeDogJm11dCBDb250ZXh0PCdfPikgLT4gUG9sbDxPcHRpb248U2VsZjo6SXRlbT4+IHsKICAgICAgICBzZWxmLnByb2plY3QoKS5mcm9tX2Rvd25sb2FkZXIucG9sbF9uZXh0KGN4KQogICAgfQp9CgovLy8gQSBbYEhlYWRlckRvd25sb2FkZXJgXSB0aGF0IHJ1bnMgb24gaXRzIG93biB0YXNrCiNbZXhwZWN0KGNsaXBweTo6Y29tcGxleGl0eSldCnN0cnVjdCBTcGF3bmVkRG93bmxvYWRlcjxUOiBIZWFkZXJEb3dubG9hZGVyPiB7CiAgICB1cGRhdGVzOiBVbmJvdW5kZWRSZWNlaXZlclN0cmVhbTxEb3dubG9hZGVyVXBkYXRlczxUOjpIZWFkZXI+PiwKICAgIGhlYWRlcnNfdHg6IFBvbGxTZW5kZXI8SGVhZGVyc0Rvd25sb2FkZXJSZXN1bHQ8VmVjPFNlYWxlZEhlYWRlcjxUOjpIZWFkZXI+PiwgVDo6SGVhZGVyPj4sCiAgICBkb3dubG9hZGVyOiBULAp9CgppbXBsPFQ6IEhlYWRlckRvd25sb2FkZXI+IEZ1dHVyZSBmb3IgU3Bhd25lZERvd25sb2FkZXI8VD4gewogICAgdHlwZSBPdXRwdXQgPSAoKTsKCiAgICBmbiBwb2xsKHNlbGY6IFBpbjwmbXV0IFNlbGY+LCBjeDogJm11dCBDb250ZXh0PCdfPikgLT4gUG9sbDxTZWxmOjpPdXRwdXQ+IHsKICAgICAgICBsZXQgdGhpcyA9IHNlbGYuZ2V0X211dCgpOwoKICAgICAgICBsb29wIHsKICAgICAgICAgICAgbG9vcCB7CiAgICAgICAgICAgICAgICBtYXRjaCB0aGlzLnVwZGF0ZXMucG9sbF9uZXh0X3VucGluKGN4KSB7CiAgICAgICAgICAgICAgICAgICAgUG9sbDo6UGVuZGluZyA9PiBicmVhaywKICAgICAgICAgICAgICAgICAgICBQb2xsOjpSZWFkeShOb25lKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNoYW5uZWwgY2xvc2VkLCB0aGlzIG1lYW5zIFtUYXNrRG93bmxvYWRlcl0gd2FzIGRyb3BwZWQsIHNvIHdlIGNhbiBhbHNvCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGV4aXQKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KCgpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBQb2xsOjpSZWFkeShTb21lKHVwZGF0ZSkpID0+IG1hdGNoIHVwZGF0ZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIERvd25sb2FkZXJVcGRhdGVzOjpVcGRhdGVTeW5jR2FwKGhlYWQsIHRhcmdldCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3dubG9hZGVyLnVwZGF0ZV9zeW5jX2dhcChoZWFkLCB0YXJnZXQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIERvd25sb2FkZXJVcGRhdGVzOjpVcGRhdGVMb2NhbEhlYWQoaGVhZCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3dubG9hZGVyLnVwZGF0ZV9sb2NhbF9oZWFkKGhlYWQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIERvd25sb2FkZXJVcGRhdGVzOjpVcGRhdGVTeW5jVGFyZ2V0KHRhcmdldCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3dubG9hZGVyLnVwZGF0ZV9zeW5jX3RhcmdldCh0YXJnZXQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIERvd25sb2FkZXJVcGRhdGVzOjpTZXRCYXRjaFNpemUobGltaXQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZG93bmxvYWRlci5zZXRfYmF0Y2hfc2l6ZShsaW1pdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXRjaCByZWFkeSEodGhpcy5oZWFkZXJzX3R4LnBvbGxfcmVzZXJ2ZShjeCkpIHsKICAgICAgICAgICAgICAgIE9rKCgpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggcmVhZHkhKHRoaXMuZG93bmxvYWRlci5wb2xsX25leHRfdW5waW4oY3gpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIFNvbWUoaGVhZGVycykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdGhpcy5oZWFkZXJzX3R4LnNlbmRfaXRlbShoZWFkZXJzKS5pc19lcnIoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hhbm5lbCBjbG9zZWQsIHRoaXMgbWVhbnMgW1Rhc2tEb3dubG9hZGVyXSB3YXMgZHJvcHBlZCwgc28gd2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjYW4gYWxzbyBleGl0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFBvbGw6OlJlYWR5KCgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIE5vbmUgPT4gcmV0dXJuIFBvbGw6OlBlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgRXJyKF8pID0+IHsKICAgICAgICAgICAgICAgICAgICAvLyBjaGFubmVsIGNsb3NlZCwgdGhpcyBtZWFucyBbVGFza0Rvd25sb2FkZXJdIHdhcyBkcm9wcGVkLCBzbwogICAgICAgICAgICAgICAgICAgIC8vIHdlIGNhbiBhbHNvIGV4aXQKICAgICAgICAgICAgICAgICAgICByZXR1cm4gUG9sbDo6UmVhZHkoKCkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8vLyBDb21tYW5kcyBkZWxlZ2F0ZWQgdG8gdGhlIHNwYXduZWQgW2BIZWFkZXJEb3dubG9hZGVyYF0KI1tkZXJpdmUoRGVidWcpXQplbnVtIERvd25sb2FkZXJVcGRhdGVzPEg+IHsKICAgIFVwZGF0ZVN5bmNHYXAoU2VhbGVkSGVhZGVyPEg+LCBTeW5jVGFyZ2V0KSwKICAgIFVwZGF0ZUxvY2FsSGVhZChTZWFsZWRIZWFkZXI8SD4pLAogICAgVXBkYXRlU3luY1RhcmdldChTeW5jVGFyZ2V0KSwKICAgIFNldEJhdGNoU2l6ZSh1c2l6ZSksCn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdHMgewogICAgdXNlIHN1cGVyOjoqOwogICAgdXNlIGNyYXRlOjpoZWFkZXJzOjp7CiAgICAgICAgcmV2ZXJzZV9oZWFkZXJzOjpSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJCdWlsZGVyLCB0ZXN0X3V0aWxzOjpjaGlsZF9oZWFkZXIsCiAgICB9OwogICAgdXNlIHJldGhfY29uc2Vuc3VzOjp0ZXN0X3V0aWxzOjpUZXN0Q29uc2Vuc3VzOwogICAgdXNlIHJldGhfbmV0d29ya19wMnA6OnRlc3RfdXRpbHM6OlRlc3RIZWFkZXJzQ2xpZW50OwogICAgdXNlIHN0ZDo6c3luYzo6QXJjOwoKICAgICNbdG9raW86OnRlc3QoZmxhdm9yID0gIm11bHRpX3RocmVhZCIpXQogICAgYXN5bmMgZm4gZG93bmxvYWRfb25lX2J5X29uZV9vbl90YXNrKCkgewogICAgICAgIHJldGhfdHJhY2luZzo6aW5pdF90ZXN0X3RyYWNpbmcoKTsKCiAgICAgICAgbGV0IHAzID0gU2VhbGVkSGVhZGVyOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IHAyID0gY2hpbGRfaGVhZGVyKCZwMyk7CiAgICAgICAgbGV0IHAxID0gY2hpbGRfaGVhZGVyKCZwMik7CiAgICAgICAgbGV0IHAwID0gY2hpbGRfaGVhZGVyKCZwMSk7CgogICAgICAgIGxldCBjbGllbnQgPSBBcmM6Om5ldyhUZXN0SGVhZGVyc0NsaWVudDo6ZGVmYXVsdCgpKTsKICAgICAgICBsZXQgZG93bmxvYWRlciA9IFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAuc3RyZWFtX2JhdGNoX3NpemUoMSkKICAgICAgICAgICAgLnJlcXVlc3RfbGltaXQoMSkKICAgICAgICAgICAgLmJ1aWxkKEFyYzo6Y2xvbmUoJmNsaWVudCksIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSkpOwoKICAgICAgICBsZXQgbXV0IGRvd25sb2FkZXIgPSBUYXNrRG93bmxvYWRlcjo6c3Bhd24oZG93bmxvYWRlcik7CiAgICAgICAgZG93bmxvYWRlci51cGRhdGVfbG9jYWxfaGVhZChwMy5jbG9uZSgpKTsKICAgICAgICBkb3dubG9hZGVyLnVwZGF0ZV9zeW5jX3RhcmdldChTeW5jVGFyZ2V0OjpUaXAocDAuaGFzaCgpKSk7CgogICAgICAgIGNsaWVudAogICAgICAgICAgICAuZXh0ZW5kKHZlYyFbCiAgICAgICAgICAgICAgICBwMC5hc19yZWYoKS5jbG9uZSgpLAogICAgICAgICAgICAgICAgcDEuYXNfcmVmKCkuY2xvbmUoKSwKICAgICAgICAgICAgICAgIHAyLmFzX3JlZigpLmNsb25lKCksCiAgICAgICAgICAgICAgICBwMy5hc19yZWYoKS5jbG9uZSgpLAogICAgICAgICAgICBdKQogICAgICAgICAgICAuYXdhaXQ7CgogICAgICAgIGxldCBoZWFkZXJzID0gZG93bmxvYWRlci5uZXh0KCkuYXdhaXQudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShoZWFkZXJzLnVud3JhcCgpLCB2ZWMhW3AwXSk7CgogICAgICAgIGxldCBoZWFkZXJzID0gZG93bmxvYWRlci5uZXh0KCkuYXdhaXQudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShoZWFkZXJzLnVud3JhcCgpLCB2ZWMhW3AxXSk7CiAgICAgICAgbGV0IGhlYWRlcnMgPSBkb3dubG9hZGVyLm5leHQoKS5hd2FpdC51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKGhlYWRlcnMudW53cmFwKCksIHZlYyFbcDJdKTsKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvbmV0L2Rvd25sb2FkZXJzL3NyYy9maWxlX2NsaWVudC5ycyI+CnVzZSBhbGxveV9jb25zZW5zdXM6OkJsb2NrSGVhZGVyOwp1c2UgYWxsb3lfZWlwczo6QmxvY2tIYXNoT3JOdW1iZXI7CnVzZSBhbGxveV9wcmltaXRpdmVzOjp7QmxvY2tIYXNoLCBCbG9ja051bWJlciwgU2VhbGFibGUsIEIyNTZ9Owp1c2UgYXN5bmNfY29tcHJlc3Npb246OnRva2lvOjpidWZyZWFkOjpHemlwRGVjb2RlcjsKdXNlIGZ1dHVyZXM6OkZ1dHVyZTsKdXNlIGl0ZXJ0b29sczo6RWl0aGVyOwp1c2UgcmV0aF9jb25zZW5zdXM6OntDb25zZW5zdXMsIENvbnNlbnN1c0Vycm9yfTsKdXNlIHJldGhfbmV0d29ya19wMnA6OnsKICAgIGJvZGllczo6Y2xpZW50Ojp7Qm9kaWVzQ2xpZW50LCBCb2RpZXNGdXR9LAogICAgZG93bmxvYWQ6OkRvd25sb2FkQ2xpZW50LAogICAgZXJyb3I6OlJlcXVlc3RFcnJvciwKICAgIGhlYWRlcnM6OmNsaWVudDo6e0hlYWRlcnNDbGllbnQsIEhlYWRlcnNEaXJlY3Rpb24sIEhlYWRlcnNGdXQsIEhlYWRlcnNSZXF1ZXN0fSwKICAgIHByaW9yaXR5OjpQcmlvcml0eSwKICAgIEJsb2NrQ2xpZW50LAp9Owp1c2UgcmV0aF9uZXR3b3JrX3BlZXJzOjpQZWVySWQ7CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjp7QmxvY2ssIEJsb2NrQm9keSwgRnVsbEJsb2NrLCBTZWFsZWRCbG9jaywgU2VhbGVkSGVhZGVyfTsKdXNlIHN0ZDo6e2NvbGxlY3Rpb25zOjpIYXNoTWFwLCBpbywgb3BzOjpSYW5nZUluY2x1c2l2ZSwgcGF0aDo6UGF0aCwgc3luYzo6QXJjfTsKdXNlIHRoaXNlcnJvcjo6RXJyb3I7CnVzZSB0b2tpbzo6ewogICAgZnM6OkZpbGUsCiAgICBpbzo6e0FzeW5jUmVhZEV4dCwgQnVmUmVhZGVyfSwKfTsKdXNlIHRva2lvX3N0cmVhbTo6U3RyZWFtRXh0Owp1c2UgdG9raW9fdXRpbDo6Y29kZWM6OkZyYW1lZFJlYWQ7CnVzZSB0cmFjaW5nOjp7ZGVidWcsIHRyYWNlLCB3YXJufTsKCnVzZSBzdXBlcjo6ZmlsZV9jb2RlYzo6QmxvY2tGaWxlQ29kZWM7CnVzZSBjcmF0ZTo6cmVjZWlwdF9maWxlX2NsaWVudDo6RnJvbVJlY2VpcHRSZWFkZXI7CgovLy8gRGVmYXVsdCBieXRlIGxlbmd0aCBvZiBjaHVuayB0byByZWFkIGZyb20gY2hhaW4gZmlsZS4KLy8vCi8vLyBEZWZhdWx0IGlzIDEgR0IuCnB1YiBjb25zdCBERUZBVUxUX0JZVEVfTEVOX0NIVU5LX0NIQUlOX0ZJTEU6IHU2NCA9IDFfMDAwXzAwMF8wMDA7CgovLy8gRnJvbnQtZW5kIEFQSSBmb3IgZmV0Y2hpbmcgY2hhaW4gZGF0YSBmcm9tIGEgZmlsZS4KLy8vCi8vLyBCbG9ja3MgYXJlIGFzc3VtZWQgdG8gYmUgd3JpdHRlbiBvbmUgYWZ0ZXIgYW5vdGhlciBpbiBhIGZpbGUsIGFzIHJscCBieXRlcy4KLy8vCi8vLyBGb3IgZXhhbXBsZSwgaWYgdGhlIGZpbGUgY29udGFpbnMgMyBibG9ja3MsIHRoZSBmaWxlIGlzIGFzc3VtZWQgdG8gYmUgZW5jb2RlZCBhcyBmb2xsb3dzOgovLy8gcmxwKGJsb2NrMSkgfHwgcmxwKGJsb2NrMikgfHwgcmxwKGJsb2NrMykKLy8vCi8vLyBCbG9ja3MgYXJlIGFzc3VtZWQgdG8gaGF2ZSBwb3B1bGF0ZWQgdHJhbnNhY3Rpb25zLCBzbyByZWFkaW5nIGhlYWRlcnMgd2lsbCBhbHNvIGJ1ZmZlcgovLy8gdHJhbnNhY3Rpb25zIGluIG1lbW9yeSBmb3IgdXNlIGluIHRoZSBib2RpZXMgc3RhZ2UuCi8vLwovLy8gVGhpcyByZWFkcyB0aGUgZW50aXJlIGZpbGUgaW50byBtZW1vcnksIHNvIGl0IGlzIG5vdCBzdWl0YWJsZSBmb3IgbGFyZ2UgZmlsZXMuCiNbZGVyaXZlKERlYnVnLCBDbG9uZSldCnB1YiBzdHJ1Y3QgRmlsZUNsaWVudDxCOiBCbG9jaz4gewogICAgLy8vIFRoZSBidWZmZXJlZCBoZWFkZXJzIHJldHJpZXZlZCB3aGVuIGZldGNoaW5nIG5ldyBib2RpZXMuCiAgICBoZWFkZXJzOiBIYXNoTWFwPEJsb2NrTnVtYmVyLCBCOjpIZWFkZXI+LAoKICAgIC8vLyBBIG1hcHBpbmcgYmV0d2VlbiBibG9jayBoYXNoIGFuZCBudW1iZXIuCiAgICBoYXNoX3RvX251bWJlcjogSGFzaE1hcDxCbG9ja0hhc2gsIEJsb2NrTnVtYmVyPiwKCiAgICAvLy8gVGhlIGJ1ZmZlcmVkIGJvZGllcyByZXRyaWV2ZWQgd2hlbiBmZXRjaGluZyBuZXcgaGVhZGVycy4KICAgIGJvZGllczogSGFzaE1hcDxCbG9ja0hhc2gsIEI6OkJvZHk+LAp9CgovLy8gQW4gZXJyb3IgdGhhdCBjYW4gb2NjdXIgd2hlbiBjb25zdHJ1Y3RpbmcgYW5kIHVzaW5nIGEgW2BGaWxlQ2xpZW50YF0uCiNbZGVyaXZlKERlYnVnLCBFcnJvcildCnB1YiBlbnVtIEZpbGVDbGllbnRFcnJvciB7CiAgICAvLy8gQW4gZXJyb3Igb2NjdXJyZWQgd2hlbiB2YWxpZGF0aW5nIGEgaGVhZGVyIGZyb20gZmlsZS4KICAgICNbZXJyb3IodHJhbnNwYXJlbnQpXQogICAgQ29uc2Vuc3VzKCNbZnJvbV0gQ29uc2Vuc3VzRXJyb3IpLAoKICAgIC8vLyBBbiBlcnJvciBvY2N1cnJlZCB3aGVuIG9wZW5pbmcgb3IgcmVhZGluZyB0aGUgZmlsZS4KICAgICNbZXJyb3IodHJhbnNwYXJlbnQpXQogICAgSW8oI1tmcm9tXSBzdGQ6OmlvOjpFcnJvciksCgogICAgLy8vIEFuIGVycm9yIG9jY3VycmVkIHdoZW4gZGVjb2RpbmcgYmxvY2tzLCBoZWFkZXJzLCBvciBybHAgaGVhZGVycyBmcm9tIHRoZSBmaWxlLgogICAgI1tlcnJvcigiezB9IildCiAgICBSbHAoYWxsb3lfcmxwOjpFcnJvciwgVmVjPHU4PiksCgogICAgLy8vIEN1c3RvbSBlcnJvciBtZXNzYWdlLgogICAgI1tlcnJvcigiezB9IildCiAgICBDdXN0b20oJidzdGF0aWMgc3RyKSwKfQoKaW1wbCBGcm9tPCYnc3RhdGljIHN0cj4gZm9yIEZpbGVDbGllbnRFcnJvciB7CiAgICBmbiBmcm9tKHZhbHVlOiAmJ3N0YXRpYyBzdHIpIC0+IFNlbGYgewogICAgICAgIFNlbGY6OkN1c3RvbSh2YWx1ZSkKICAgIH0KfQoKaW1wbDxCOiBGdWxsQmxvY2s+IEZpbGVDbGllbnQ8Qj4gewogICAgLy8vIENyZWF0ZSBhIG5ldyBmaWxlIGNsaWVudCBmcm9tIGEgZmlsZSBwYXRoLgogICAgcHViIGFzeW5jIGZuIG5ldzxQOiBBc1JlZjxQYXRoPj4oCiAgICAgICAgcGF0aDogUCwKICAgICAgICBjb25zZW5zdXM6IEFyYzxkeW4gQ29uc2Vuc3VzPEI+PiwKICAgICkgLT4gUmVzdWx0PFNlbGYsIEZpbGVDbGllbnRFcnJvcj4gewogICAgICAgIGxldCBmaWxlID0gRmlsZTo6b3BlbihwYXRoKS5hd2FpdD87CiAgICAgICAgU2VsZjo6ZnJvbV9maWxlKGZpbGUsIGNvbnNlbnN1cykuYXdhaXQKICAgIH0KCiAgICAvLy8gSW5pdGlhbGl6ZSB0aGUgW2BGaWxlQ2xpZW50YF0gd2l0aCBhIGZpbGUgZGlyZWN0bHkuCiAgICBwdWIoY3JhdGUpIGFzeW5jIGZuIGZyb21fZmlsZSgKICAgICAgICBtdXQgZmlsZTogRmlsZSwKICAgICAgICBjb25zZW5zdXM6IEFyYzxkeW4gQ29uc2Vuc3VzPEI+PiwKICAgICkgLT4gUmVzdWx0PFNlbGYsIEZpbGVDbGllbnRFcnJvcj4gewogICAgICAgIC8vIGdldCBmaWxlIGxlbiBmcm9tIG1ldGFkYXRhIGJlZm9yZSByZWFkaW5nCiAgICAgICAgbGV0IG1ldGFkYXRhID0gZmlsZS5tZXRhZGF0YSgpLmF3YWl0PzsKICAgICAgICBsZXQgZmlsZV9sZW4gPSBtZXRhZGF0YS5sZW4oKTsKCiAgICAgICAgbGV0IG11dCByZWFkZXIgPSB2ZWMhW107CiAgICAgICAgZmlsZS5yZWFkX3RvX2VuZCgmbXV0IHJlYWRlcikuYXdhaXQ/OwoKICAgICAgICBPayhGaWxlQ2xpZW50QnVpbGRlciB7IGNvbnNlbnN1cywgcGFyZW50X2hlYWRlcjogTm9uZSB9CiAgICAgICAgICAgIC5idWlsZCgmcmVhZGVyWy4uXSwgZmlsZV9sZW4pCiAgICAgICAgICAgIC5hd2FpdD8KICAgICAgICAgICAgLmZpbGVfY2xpZW50KQogICAgfQoKICAgIC8vLyBHZXQgdGhlIHRpcCBoYXNoIG9mIHRoZSBjaGFpbi4KICAgIHB1YiBmbiB0aXAoJnNlbGYpIC0+IE9wdGlvbjxCMjU2PiB7CiAgICAgICAgc2VsZi5oZWFkZXJzLmdldCgmc2VsZi5tYXhfYmxvY2soKT8pLm1hcCh8aHwgaC5oYXNoX3Nsb3coKSkKICAgIH0KCiAgICAvLy8gR2V0IHRoZSBzdGFydCBoYXNoIG9mIHRoZSBjaGFpbi4KICAgIHB1YiBmbiBzdGFydCgmc2VsZikgLT4gT3B0aW9uPEIyNTY+IHsKICAgICAgICBzZWxmLmhlYWRlcnMuZ2V0KCZzZWxmLm1pbl9ibG9jaygpPykubWFwKHxofCBoLmhhc2hfc2xvdygpKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBoaWdoZXN0IGJsb2NrIG51bWJlciBvZiB0aGlzIGNsaWVudCBoYXMgb3IgYE5vbmVgIGlmIGVtcHR5CiAgICBwdWIgZm4gbWF4X2Jsb2NrKCZzZWxmKSAtPiBPcHRpb248dTY0PiB7CiAgICAgICAgc2VsZi5oZWFkZXJzLmtleXMoKS5tYXgoKS5jb3BpZWQoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBsb3dlc3QgYmxvY2sgbnVtYmVyIG9mIHRoaXMgY2xpZW50IGhhcyBvciBgTm9uZWAgaWYgZW1wdHkKICAgIHB1YiBmbiBtaW5fYmxvY2soJnNlbGYpIC0+IE9wdGlvbjx1NjQ+IHsKICAgICAgICBzZWxmLmhlYWRlcnMua2V5cygpLm1pbigpLmNvcGllZCgpCiAgICB9CgogICAgLy8vIENsb25lcyBhbmQgcmV0dXJucyB0aGUgaGlnaGVzdCBoZWFkZXIgb2YgdGhpcyBjbGllbnQgaGFzIG9yIGBOb25lYCBpZiBlbXB0eS4gU2VhbHMgaGVhZGVyCiAgICAvLy8gYmVmb3JlIHJldHVybmluZy4KICAgIHB1YiBmbiB0aXBfaGVhZGVyKCZzZWxmKSAtPiBPcHRpb248U2VhbGVkSGVhZGVyPEI6OkhlYWRlcj4+IHsKICAgICAgICBzZWxmLmhlYWRlcnMuZ2V0KCZzZWxmLm1heF9ibG9jaygpPykubWFwKHxofCBTZWFsZWRIZWFkZXI6OnNlYWxfc2xvdyhoLmNsb25lKCkpKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRydWUgaWYgYWxsIGJsb2NrcyBhcmUgY2Fub25pY2FsIChubyBnYXBzKQogICAgcHViIGZuIGhhc19jYW5vbmljYWxfYmxvY2tzKCZzZWxmKSAtPiBib29sIHsKICAgICAgICBpZiBzZWxmLmhlYWRlcnMuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICAgIGxldCBtdXQgbnVtcyA9IHNlbGYuaGVhZGVycy5rZXlzKCkuY29waWVkKCkuY29sbGVjdDo6PFZlYzxfPj4oKTsKICAgICAgICBudW1zLnNvcnRfdW5zdGFibGUoKTsKICAgICAgICBsZXQgbXV0IGl0ZXIgPSBudW1zLmludG9faXRlcigpOwogICAgICAgIGxldCBtdXQgbG93ZXN0ID0gaXRlci5uZXh0KCkuZXhwZWN0KCJub3QgZW1wdHkiKTsKICAgICAgICBmb3IgbmV4dCBpbiBpdGVyIHsKICAgICAgICAgICAgaWYgbmV4dCAhPSBsb3dlc3QgKyAxIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvd2VzdCA9IG5leHQ7CiAgICAgICAgfQogICAgICAgIHRydWUKICAgIH0KCiAgICAvLy8gVXNlIHRoZSBwcm92aWRlZCBib2RpZXMgYXMgdGhlIGZpbGUgY2xpZW50J3MgYmxvY2sgYm9keSBidWZmZXIuCiAgICBwdWIgZm4gd2l0aF9ib2RpZXMobXV0IHNlbGYsIGJvZGllczogSGFzaE1hcDxCbG9ja0hhc2gsIEI6OkJvZHk+KSAtPiBTZWxmIHsKICAgICAgICBzZWxmLmJvZGllcyA9IGJvZGllczsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIFVzZSB0aGUgcHJvdmlkZWQgaGVhZGVycyBhcyB0aGUgZmlsZSBjbGllbnQncyBibG9jayBib2R5IGJ1ZmZlci4KICAgIHB1YiBmbiB3aXRoX2hlYWRlcnMobXV0IHNlbGYsIGhlYWRlcnM6IEhhc2hNYXA8QmxvY2tOdW1iZXIsIEI6OkhlYWRlcj4pIC0+IFNlbGYgewogICAgICAgIHNlbGYuaGVhZGVycyA9IGhlYWRlcnM7CiAgICAgICAgZm9yIChudW1iZXIsIGhlYWRlcikgaW4gJnNlbGYuaGVhZGVycyB7CiAgICAgICAgICAgIHNlbGYuaGFzaF90b19udW1iZXIuaW5zZXJ0KGhlYWRlci5oYXNoX3Nsb3coKSwgKm51bWJlcik7CiAgICAgICAgfQogICAgICAgIHNlbGYKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgY3VycmVudCBudW1iZXIgb2YgaGVhZGVycyBpbiB0aGUgY2xpZW50LgogICAgcHViIGZuIGhlYWRlcnNfbGVuKCZzZWxmKSAtPiB1c2l6ZSB7CiAgICAgICAgc2VsZi5oZWFkZXJzLmxlbigpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGN1cnJlbnQgbnVtYmVyIG9mIGJvZGllcyBpbiB0aGUgY2xpZW50LgogICAgcHViIGZuIGJvZGllc19sZW4oJnNlbGYpIC0+IHVzaXplIHsKICAgICAgICBzZWxmLmJvZGllcy5sZW4oKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGFuIGl0ZXJhdG9yIG92ZXIgaGVhZGVycyBpbiB0aGUgY2xpZW50LgogICAgcHViIGZuIGhlYWRlcnNfaXRlcigmc2VsZikgLT4gaW1wbCBJdGVyYXRvcjxJdGVtID0gJkI6OkhlYWRlcj4gewogICAgICAgIHNlbGYuaGVhZGVycy52YWx1ZXMoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgbXV0YWJsZSBpdGVyYXRvciBvdmVyIGJvZGllcyBpbiB0aGUgY2xpZW50LgogICAgLy8vCiAgICAvLy8gUGFuaWNzLCBpZiBmaWxlIGNsaWVudCBoZWFkZXJzIGFuZCBib2RpZXMgYXJlIG5vdCBtYXBwaW5nIDEtMS4KICAgIHB1YiBmbiBib2RpZXNfaXRlcl9tdXQoJm11dCBzZWxmKSAtPiBpbXBsIEl0ZXJhdG9yPEl0ZW0gPSAodTY0LCAmbXV0IEI6OkJvZHkpPiB7CiAgICAgICAgbGV0IGJvZGllcyA9ICZtdXQgc2VsZi5ib2RpZXM7CiAgICAgICAgbGV0IG51bWJlcnMgPSAmc2VsZi5oYXNoX3RvX251bWJlcjsKICAgICAgICBib2RpZXMuaXRlcl9tdXQoKS5tYXAofChoYXNoLCBib2R5KXwgKG51bWJlcnNbaGFzaF0sIGJvZHkpKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBjdXJyZW50IG51bWJlciBvZiB0cmFuc2FjdGlvbnMgaW4gdGhlIGNsaWVudC4KICAgIHB1YiBmbiB0b3RhbF90cmFuc2FjdGlvbnMoJnNlbGYpIC0+IHVzaXplIHsKICAgICAgICBzZWxmLmJvZGllcy5pdGVyKCkuZm9sZCgwLCB8YWNjLCAoXywgYm9keSl8IGFjYyArIGJvZHkudHJhbnNhY3Rpb25zKCkubGVuKCkpCiAgICB9Cn0KCnN0cnVjdCBGaWxlQ2xpZW50QnVpbGRlcjxCOiBCbG9jaz4gewogICAgcHViIGNvbnNlbnN1czogQXJjPGR5biBDb25zZW5zdXM8Qj4+LAogICAgcHViIHBhcmVudF9oZWFkZXI6IE9wdGlvbjxTZWFsZWRIZWFkZXI8Qjo6SGVhZGVyPj4sCn0KCmltcGw8QjogRnVsbEJsb2NrPEhlYWRlcjogcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6QmxvY2tIZWFkZXI+PiBGcm9tUmVhZGVyCiAgICBmb3IgRmlsZUNsaWVudEJ1aWxkZXI8Qj4KewogICAgdHlwZSBFcnJvciA9IEZpbGVDbGllbnRFcnJvcjsKICAgIHR5cGUgT3V0cHV0ID0gRmlsZUNsaWVudDxCPjsKCiAgICAvLy8gSW5pdGlhbGl6ZSB0aGUgW2BGaWxlQ2xpZW50YF0gZnJvbSBieXRlcyB0aGF0IGhhdmUgYmVlbiByZWFkIGZyb20gZmlsZS4KICAgIGZuIGJ1aWxkPFI+KAogICAgICAgICZzZWxmLAogICAgICAgIHJlYWRlcjogUiwKICAgICAgICBudW1fYnl0ZXM6IHU2NCwKICAgICkgLT4gaW1wbCBGdXR1cmU8T3V0cHV0ID0gUmVzdWx0PERlY29kZWRGaWxlQ2h1bms8U2VsZjo6T3V0cHV0PiwgU2VsZjo6RXJyb3I+PgogICAgd2hlcmUKICAgICAgICBSOiBBc3luY1JlYWRFeHQgKyBVbnBpbiwKICAgIHsKICAgICAgICBsZXQgbXV0IGhlYWRlcnMgPSBIYXNoTWFwOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IG11dCBoYXNoX3RvX251bWJlciA9IEhhc2hNYXA6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgbXV0IGJvZGllcyA9IEhhc2hNYXA6OmRlZmF1bHQoKTsKCiAgICAgICAgLy8gdXNlIHdpdGhfY2FwYWNpdHkgdG8gbWFrZSBzdXJlIHRoZSBpbnRlcm5hbCBidWZmZXIgY29udGFpbnMgdGhlIGVudGlyZSBjaHVuawogICAgICAgIGxldCBtdXQgc3RyZWFtID0KICAgICAgICAgICAgRnJhbWVkUmVhZDo6d2l0aF9jYXBhY2l0eShyZWFkZXIsIEJsb2NrRmlsZUNvZGVjOjo8Qj46OmRlZmF1bHQoKSwgbnVtX2J5dGVzIGFzIHVzaXplKTsKCiAgICAgICAgdHJhY2UhKHRhcmdldDogImRvd25sb2FkZXJzOjpmaWxlIiwKICAgICAgICAgICAgdGFyZ2V0X251bV9ieXRlcz1udW1fYnl0ZXMsCiAgICAgICAgICAgIGNhcGFjaXR5PXN0cmVhbS5yZWFkX2J1ZmZlcigpLmNhcGFjaXR5KCksCiAgICAgICAgICAgICJpbml0IGRlY29kZSBzdHJlYW0iCiAgICAgICAgKTsKCiAgICAgICAgbGV0IG11dCByZW1haW5pbmdfYnl0ZXMgPSB2ZWMhW107CgogICAgICAgIGxldCBtdXQgbG9nX2ludGVydmFsID0gMDsKICAgICAgICBsZXQgbXV0IGxvZ19pbnRlcnZhbF9zdGFydF9ibG9jayA9IDA7CgogICAgICAgIGxldCBtdXQgcGFyZW50X2hlYWRlciA9IHNlbGYucGFyZW50X2hlYWRlci5jbG9uZSgpOwoKICAgICAgICBhc3luYyBtb3ZlIHsKICAgICAgICAgICAgd2hpbGUgbGV0IFNvbWUoYmxvY2tfcmVzKSA9IHN0cmVhbS5uZXh0KCkuYXdhaXQgewogICAgICAgICAgICAgICAgbGV0IGJsb2NrID0gbWF0Y2ggYmxvY2tfcmVzIHsKICAgICAgICAgICAgICAgICAgICBPayhibG9jaykgPT4gYmxvY2ssCiAgICAgICAgICAgICAgICAgICAgRXJyKEZpbGVDbGllbnRFcnJvcjo6UmxwKGVyciwgYnl0ZXMpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6ZmlsZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAlZXJyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnl0ZXNfbGVuPWJ5dGVzLmxlbigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInBhcnRpYWwgYmxvY2sgcmV0dXJuZWQgZnJvbSBkZWNvZGluZyBjaHVuayIKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nX2J5dGVzID0gYnl0ZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIEVycihlcnIpID0+IHJldHVybiBFcnIoZXJyKSwKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgbGV0IGJsb2NrID0gU2VhbGVkQmxvY2s6OnNlYWxfc2xvdyhibG9jayk7CgogICAgICAgICAgICAgICAgLy8gVmFsaWRhdGUgc3RhbmRhbG9uZSBoZWFkZXIKICAgICAgICAgICAgICAgIHNlbGYuY29uc2Vuc3VzLnZhbGlkYXRlX2hlYWRlcihibG9jay5zZWFsZWRfaGVhZGVyKCkpPzsKICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKHBhcmVudCkgPSAmcGFyZW50X2hlYWRlciB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jb25zZW5zdXMudmFsaWRhdGVfaGVhZGVyX2FnYWluc3RfcGFyZW50KGJsb2NrLnNlYWxlZF9oZWFkZXIoKSwgcGFyZW50KT87CiAgICAgICAgICAgICAgICAgICAgcGFyZW50X2hlYWRlciA9IFNvbWUoYmxvY2suc2VhbGVkX2hlYWRlcigpLmNsb25lKCkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFZhbGlkYXRlIGJsb2NrIGFnYWluc3QgaGVhZGVyCiAgICAgICAgICAgICAgICBzZWxmLmNvbnNlbnN1cy52YWxpZGF0ZV9ibG9ja19wcmVfZXhlY3V0aW9uKCZibG9jayk/OwoKICAgICAgICAgICAgICAgIC8vIGFkZCB0byB0aGUgaW50ZXJuYWwgbWFwcwogICAgICAgICAgICAgICAgbGV0IGJsb2NrX2hhc2ggPSBibG9jay5oYXNoKCk7CiAgICAgICAgICAgICAgICBsZXQgYmxvY2tfbnVtYmVyID0gYmxvY2subnVtYmVyKCk7CiAgICAgICAgICAgICAgICBsZXQgKGhlYWRlciwgYm9keSkgPSBibG9jay5zcGxpdF9zZWFsZWRfaGVhZGVyX2JvZHkoKTsKICAgICAgICAgICAgICAgIGhlYWRlcnMuaW5zZXJ0KGJsb2NrX251bWJlciwgaGVhZGVyLnVuc2VhbCgpKTsKICAgICAgICAgICAgICAgIGhhc2hfdG9fbnVtYmVyLmluc2VydChibG9ja19oYXNoLCBibG9ja19udW1iZXIpOwogICAgICAgICAgICAgICAgYm9kaWVzLmluc2VydChibG9ja19oYXNoLCBib2R5KTsKCiAgICAgICAgICAgICAgICBpZiBsb2dfaW50ZXJ2YWwgPT0gMCB7CiAgICAgICAgICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogImRvd25sb2FkZXJzOjpmaWxlIiwKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZCBmaXJzdCBibG9jayIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIGxvZ19pbnRlcnZhbF9zdGFydF9ibG9jayA9IGJsb2NrX251bWJlcjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiBsb2dfaW50ZXJ2YWwgJSAxMDBfMDAwID09IDAgewogICAgICAgICAgICAgICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6ZmlsZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2Nrcz0/bG9nX2ludGVydmFsX3N0YXJ0X2Jsb2NrLi49YmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZCBibG9ja3MgZnJvbSBmaWxlIgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgbG9nX2ludGVydmFsX3N0YXJ0X2Jsb2NrID0gYmxvY2tfbnVtYmVyICsgMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxvZ19pbnRlcnZhbCArPSAxOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0cmFjZSEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmZpbGUiLCBibG9ja3MgPSBoZWFkZXJzLmxlbigpLCAiSW5pdGlhbGl6ZWQgZmlsZSBjbGllbnQiKTsKCiAgICAgICAgICAgIE9rKERlY29kZWRGaWxlQ2h1bmsgewogICAgICAgICAgICAgICAgZmlsZV9jbGllbnQ6IEZpbGVDbGllbnQgeyBoZWFkZXJzLCBoYXNoX3RvX251bWJlciwgYm9kaWVzIH0sCiAgICAgICAgICAgICAgICByZW1haW5pbmdfYnl0ZXMsCiAgICAgICAgICAgICAgICBoaWdoZXN0X2Jsb2NrOiBOb25lLAogICAgICAgICAgICB9KQogICAgICAgIH0KICAgIH0KfQoKaW1wbDxCOiBGdWxsQmxvY2s+IEhlYWRlcnNDbGllbnQgZm9yIEZpbGVDbGllbnQ8Qj4gewogICAgdHlwZSBIZWFkZXIgPSBCOjpIZWFkZXI7CiAgICB0eXBlIE91dHB1dCA9IEhlYWRlcnNGdXQ8Qjo6SGVhZGVyPjsKCiAgICBmbiBnZXRfaGVhZGVyc193aXRoX3ByaW9yaXR5KAogICAgICAgICZzZWxmLAogICAgICAgIHJlcXVlc3Q6IEhlYWRlcnNSZXF1ZXN0LAogICAgICAgIF9wcmlvcml0eTogUHJpb3JpdHksCiAgICApIC0+IFNlbGY6Ok91dHB1dCB7CiAgICAgICAgLy8gdGhpcyBqdXN0IHNlYXJjaGVzIHRoZSBidWZmZXIsIGFuZCBmYWlscyBpZiBpdCBjYW4ndCBmaW5kIHRoZSBoZWFkZXIKICAgICAgICBsZXQgbXV0IGhlYWRlcnMgPSBWZWM6Om5ldygpOwogICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6ZmlsZSIsIHJlcXVlc3Q9P3JlcXVlc3QsICJHZXR0aW5nIGhlYWRlcnMiKTsKCiAgICAgICAgbGV0IHN0YXJ0X251bSA9IG1hdGNoIHJlcXVlc3Quc3RhcnQgewogICAgICAgICAgICBCbG9ja0hhc2hPck51bWJlcjo6SGFzaChoYXNoKSA9PiBtYXRjaCBzZWxmLmhhc2hfdG9fbnVtYmVyLmdldCgmaGFzaCkgewogICAgICAgICAgICAgICAgU29tZShudW0pID0+ICpudW0sCiAgICAgICAgICAgICAgICBOb25lID0+IHsKICAgICAgICAgICAgICAgICAgICB3YXJuISglaGFzaCwgIkNvdWxkIG5vdCBmaW5kIHN0YXJ0aW5nIGJsb2NrIG51bWJlciBmb3IgcmVxdWVzdGVkIGhlYWRlciBoYXNoIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEJveDo6cGluKGFzeW5jIG1vdmUgeyBFcnIoUmVxdWVzdEVycm9yOjpCYWRSZXNwb25zZSkgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgQmxvY2tIYXNoT3JOdW1iZXI6Ok51bWJlcihudW0pID0+IG51bSwKICAgICAgICB9OwoKICAgICAgICBsZXQgcmFuZ2UgPSBpZiByZXF1ZXN0LmxpbWl0ID09IDEgewogICAgICAgICAgICBFaXRoZXI6OkxlZnQoc3RhcnRfbnVtLi5zdGFydF9udW0gKyAxKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1hdGNoIHJlcXVlc3QuZGlyZWN0aW9uIHsKICAgICAgICAgICAgICAgIEhlYWRlcnNEaXJlY3Rpb246OlJpc2luZyA9PiBFaXRoZXI6OkxlZnQoc3RhcnRfbnVtLi5zdGFydF9udW0gKyByZXF1ZXN0LmxpbWl0KSwKICAgICAgICAgICAgICAgIEhlYWRlcnNEaXJlY3Rpb246OkZhbGxpbmcgPT4gewogICAgICAgICAgICAgICAgICAgIEVpdGhlcjo6UmlnaHQoKHN0YXJ0X251bSAtIHJlcXVlc3QubGltaXQgKyAxLi49c3RhcnRfbnVtKS5yZXYoKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6ZmlsZSIsIHJhbmdlPT9yYW5nZSwgIkdldHRpbmcgaGVhZGVycyB3aXRoIHJhbmdlIik7CgogICAgICAgIGZvciBibG9ja19udW1iZXIgaW4gcmFuZ2UgewogICAgICAgICAgICBtYXRjaCBzZWxmLmhlYWRlcnMuZ2V0KCZibG9ja19udW1iZXIpLmNsb25lZCgpIHsKICAgICAgICAgICAgICAgIFNvbWUoaGVhZGVyKSA9PiBoZWFkZXJzLnB1c2goaGVhZGVyKSwKICAgICAgICAgICAgICAgIE5vbmUgPT4gewogICAgICAgICAgICAgICAgICAgIHdhcm4hKG51bWJlcj0lYmxvY2tfbnVtYmVyLCAiQ291bGQgbm90IGZpbmQgaGVhZGVyIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEJveDo6cGluKGFzeW5jIG1vdmUgeyBFcnIoUmVxdWVzdEVycm9yOjpCYWRSZXNwb25zZSkgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgQm94OjpwaW4oYXN5bmMgbW92ZSB7IE9rKChQZWVySWQ6OmRlZmF1bHQoKSwgaGVhZGVycykuaW50bygpKSB9KQogICAgfQp9CgppbXBsPEI6IEZ1bGxCbG9jaz4gQm9kaWVzQ2xpZW50IGZvciBGaWxlQ2xpZW50PEI+IHsKICAgIHR5cGUgQm9keSA9IEI6OkJvZHk7CiAgICB0eXBlIE91dHB1dCA9IEJvZGllc0Z1dDxCOjpCb2R5PjsKCiAgICBmbiBnZXRfYmxvY2tfYm9kaWVzX3dpdGhfcHJpb3JpdHlfYW5kX3JhbmdlX2hpbnQoCiAgICAgICAgJnNlbGYsCiAgICAgICAgaGFzaGVzOiBWZWM8QjI1Nj4sCiAgICAgICAgX3ByaW9yaXR5OiBQcmlvcml0eSwKICAgICAgICBfcmFuZ2VfaGludDogT3B0aW9uPFJhbmdlSW5jbHVzaXZlPHU2ND4+LAogICAgKSAtPiBTZWxmOjpPdXRwdXQgewogICAgICAgIC8vIHRoaXMganVzdCBzZWFyY2hlcyB0aGUgYnVmZmVyLCBhbmQgZmFpbHMgaWYgaXQgY2FuJ3QgZmluZCB0aGUgYmxvY2sKICAgICAgICBsZXQgbXV0IGJvZGllcyA9IFZlYzo6bmV3KCk7CgogICAgICAgIC8vIGNoZWNrIGlmIGFueSBhcmUgYW4gZXJyb3IKICAgICAgICAvLyBjb3VsZCB1bndyYXAgaGVyZQogICAgICAgIGZvciBoYXNoIGluIGhhc2hlcyB7CiAgICAgICAgICAgIG1hdGNoIHNlbGYuYm9kaWVzLmdldCgmaGFzaCkuY2xvbmVkKCkgewogICAgICAgICAgICAgICAgU29tZShib2R5KSA9PiBib2RpZXMucHVzaChib2R5KSwKICAgICAgICAgICAgICAgIE5vbmUgPT4gcmV0dXJuIEJveDo6cGluKGFzeW5jIG1vdmUgeyBFcnIoUmVxdWVzdEVycm9yOjpCYWRSZXNwb25zZSkgfSksCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIEJveDo6cGluKGFzeW5jIG1vdmUgeyBPaygoUGVlcklkOjpkZWZhdWx0KCksIGJvZGllcykuaW50bygpKSB9KQogICAgfQp9CgppbXBsPEI6IEZ1bGxCbG9jaz4gRG93bmxvYWRDbGllbnQgZm9yIEZpbGVDbGllbnQ8Qj4gewogICAgZm4gcmVwb3J0X2JhZF9tZXNzYWdlKCZzZWxmLCBfcGVlcl9pZDogUGVlcklkKSB7CiAgICAgICAgdHJhY2UhKCJSZXBvcnRlZCBhIGJhZCBtZXNzYWdlIG9uIGEgZmlsZSBjbGllbnQsIHRoZSBmaWxlIG1heSBiZSBjb3JydXB0ZWQgb3IgaW52YWxpZCIpOwogICAgICAgIC8vIG5vb3AKICAgIH0KCiAgICBmbiBudW1fY29ubmVjdGVkX3BlZXJzKCZzZWxmKSAtPiB1c2l6ZSB7CiAgICAgICAgLy8gbm8gc3VjaCB0aGluZyBhcyBjb25uZWN0ZWQgcGVlcnMgd2hlbiB3ZSBhcmUganVzdCB1c2luZyBhIGZpbGUKICAgICAgICAxCiAgICB9Cn0KCmltcGw8QjogRnVsbEJsb2NrPiBCbG9ja0NsaWVudCBmb3IgRmlsZUNsaWVudDxCPiB7CiAgICB0eXBlIEJsb2NrID0gQjsKfQoKLy8vIEZpbGUgcmVhZGVyIHR5cGUgZm9yIGhhbmRsaW5nIGRpZmZlcmVudCBjb21wcmVzc2lvbiBmb3JtYXRzLgojW2Rlcml2ZShEZWJ1ZyldCmVudW0gRmlsZVJlYWRlciB7CiAgICAvLy8gUmVndWxhciB1bmNvbXByZXNzZWQgZmlsZSB3aXRoIHJlbWFpbmluZyBieXRlIHRyYWNraW5nLgogICAgUGxhaW4geyBmaWxlOiBGaWxlLCByZW1haW5pbmdfYnl0ZXM6IHU2NCB9LAogICAgLy8vIEd6aXAgY29tcHJlc3NlZCBmaWxlLgogICAgR3ppcChHemlwRGVjb2RlcjxCdWZSZWFkZXI8RmlsZT4+KSwKfQoKaW1wbCBGaWxlUmVhZGVyIHsKICAgIC8vLyBSZWFkIHNvbWUgZGF0YSBpbnRvIHRoZSBwcm92aWRlZCBidWZmZXIsIHJldHVybmluZyB0aGUgbnVtYmVyIG9mIGJ5dGVzIHJlYWQuCiAgICBhc3luYyBmbiByZWFkKCZtdXQgc2VsZiwgYnVmOiAmbXV0IFt1OF0pIC0+IFJlc3VsdDx1c2l6ZSwgaW86OkVycm9yPiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OlBsYWluIHsgZmlsZSwgLi4gfSA9PiBmaWxlLnJlYWQoYnVmKS5hd2FpdCwKICAgICAgICAgICAgU2VsZjo6R3ppcChkZWNvZGVyKSA9PiBkZWNvZGVyLnJlYWQoYnVmKS5hd2FpdCwKICAgICAgICB9CiAgICB9CgogICAgLy8vIFJlYWQgbmV4dCBjaHVuayBmcm9tIGZpbGUuIFJldHVybnMgdGhlIG51bWJlciBvZiBieXRlcyByZWFkIGZvciBwbGFpbiBmaWxlcywKICAgIC8vLyBvciBhIGJvb2xlYW4gaW5kaWNhdGluZyBpZiBkYXRhIGlzIGF2YWlsYWJsZSBmb3IgZ3ppcCBmaWxlcy4KICAgIGFzeW5jIGZuIHJlYWRfbmV4dF9jaHVuaygKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgY2h1bms6ICZtdXQgVmVjPHU4PiwKICAgICAgICBjaHVua19ieXRlX2xlbjogdTY0LAogICAgKSAtPiBSZXN1bHQ8T3B0aW9uPHU2ND4sIEZpbGVDbGllbnRFcnJvcj4gewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpQbGFpbiB7IC4uIH0gPT4gc2VsZi5yZWFkX3BsYWluX2NodW5rKGNodW5rLCBjaHVua19ieXRlX2xlbikuYXdhaXQsCiAgICAgICAgICAgIFNlbGY6Okd6aXAoXykgPT4gewogICAgICAgICAgICAgICAgT2soKHNlbGYucmVhZF9nemlwX2NodW5rKGNodW5rLCBjaHVua19ieXRlX2xlbikuYXdhaXQ/KQogICAgICAgICAgICAgICAgICAgIC50aGVuX3NvbWUoY2h1bmsubGVuKCkgYXMgdTY0KSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiByZWFkX3BsYWluX2NodW5rKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBjaHVuazogJm11dCBWZWM8dTg+LAogICAgICAgIGNodW5rX2J5dGVfbGVuOiB1NjQsCiAgICApIC0+IFJlc3VsdDxPcHRpb248dTY0PiwgRmlsZUNsaWVudEVycm9yPiB7CiAgICAgICAgbGV0IFNlbGY6OlBsYWluIHsgZmlsZSwgcmVtYWluaW5nX2J5dGVzIH0gPSBzZWxmIGVsc2UgewogICAgICAgICAgICB1bnJlYWNoYWJsZSEoInJlYWRfcGxhaW5fY2h1bmsgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIFBsYWluIHZhcmlhbnQiKQogICAgICAgIH07CgogICAgICAgIGlmICpyZW1haW5pbmdfYnl0ZXMgPT0gMCAmJiBjaHVuay5pc19lbXB0eSgpIHsKICAgICAgICAgICAgLy8gZW9mCiAgICAgICAgICAgIHJldHVybiBPayhOb25lKQogICAgICAgIH0KCiAgICAgICAgbGV0IGNodW5rX3RhcmdldF9sZW4gPSBjaHVua19ieXRlX2xlbi5taW4oKnJlbWFpbmluZ19ieXRlcyArIGNodW5rLmxlbigpIGFzIHU2NCk7CiAgICAgICAgbGV0IG9sZF9ieXRlc19sZW4gPSBjaHVuay5sZW4oKSBhcyB1NjQ7CgogICAgICAgIC8vIGNhbGN1bGF0ZSByZXNlcnZlZCBzcGFjZSBpbiBjaHVuawogICAgICAgIGxldCBuZXdfcmVhZF9ieXRlc190YXJnZXRfbGVuID0gY2h1bmtfdGFyZ2V0X2xlbiAtIG9sZF9ieXRlc19sZW47CgogICAgICAgIC8vIHJlYWQgbmV3IGJ5dGVzIGZyb20gZmlsZQogICAgICAgIGxldCBwcmV2X3JlYWRfYnl0ZXNfbGVuID0gY2h1bmsubGVuKCk7CiAgICAgICAgY2h1bmsuZXh0ZW5kKHN0ZDo6aXRlcjo6cmVwZWF0X24oMCwgbmV3X3JlYWRfYnl0ZXNfdGFyZ2V0X2xlbiBhcyB1c2l6ZSkpOwogICAgICAgIGxldCByZWFkZXIgPSAmbXV0IGNodW5rW3ByZXZfcmVhZF9ieXRlc19sZW4uLl07CgogICAgICAgIC8vIGFjdHVhbCBieXRlcyB0aGF0IGhhdmUgYmVlbiByZWFkCiAgICAgICAgbGV0IG5ld19yZWFkX2J5dGVzX2xlbiA9IGZpbGUucmVhZF9leGFjdChyZWFkZXIpLmF3YWl0PyBhcyB1NjQ7CiAgICAgICAgbGV0IG5leHRfY2h1bmtfYnl0ZV9sZW4gPSBjaHVuay5sZW4oKTsKCiAgICAgICAgLy8gdXBkYXRlIHJlbWFpbmluZyBmaWxlIGxlbmd0aAogICAgICAgICpyZW1haW5pbmdfYnl0ZXMgLT0gbmV3X3JlYWRfYnl0ZXNfbGVuOwoKICAgICAgICBkZWJ1ZyEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmZpbGUiLAogICAgICAgICAgICBtYXhfY2h1bmtfYnl0ZV9sZW49Y2h1bmtfYnl0ZV9sZW4sCiAgICAgICAgICAgIHByZXZfcmVhZF9ieXRlc19sZW4sCiAgICAgICAgICAgIG5ld19yZWFkX2J5dGVzX3RhcmdldF9sZW4sCiAgICAgICAgICAgIG5ld19yZWFkX2J5dGVzX2xlbiwKICAgICAgICAgICAgbmV4dF9jaHVua19ieXRlX2xlbiwKICAgICAgICAgICAgcmVtYWluaW5nX2ZpbGVfYnl0ZV9sZW49KnJlbWFpbmluZ19ieXRlcywKICAgICAgICAgICAgIm5ldyBieXRlcyB3ZXJlIHJlYWQgZnJvbSBmaWxlIgogICAgICAgICk7CgogICAgICAgIE9rKFNvbWUobmV4dF9jaHVua19ieXRlX2xlbiBhcyB1NjQpKQogICAgfQoKICAgIC8vLyBSZWFkIG5leHQgY2h1bmsgZnJvbSBnemlwcGVkIGZpbGUuCiAgICBhc3luYyBmbiByZWFkX2d6aXBfY2h1bmsoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIGNodW5rOiAmbXV0IFZlYzx1OD4sCiAgICAgICAgY2h1bmtfYnl0ZV9sZW46IHU2NCwKICAgICkgLT4gUmVzdWx0PGJvb2wsIEZpbGVDbGllbnRFcnJvcj4gewogICAgICAgIGxldCBtdXQgYnVmZmVyID0gdmVjIVswdTg7IDY0ICogMTAyNF07CiAgICAgICAgbG9vcCB7CiAgICAgICAgICAgIGlmIGNodW5rLmxlbigpID49IGNodW5rX2J5dGVfbGVuIGFzIHVzaXplIHsKICAgICAgICAgICAgICAgIHJldHVybiBPayh0cnVlKQogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXRjaCBzZWxmLnJlYWQoJm11dCBidWZmZXIpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKDApID0+IHJldHVybiBPayghY2h1bmsuaXNfZW1wdHkoKSksCiAgICAgICAgICAgICAgICBPayhuKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY2h1bmsuZXh0ZW5kX2Zyb21fc2xpY2UoJmJ1ZmZlclsuLm5dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEVycihlKSA9PiByZXR1cm4gRXJyKGUuaW50bygpKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8vIENodW5rcyBmaWxlIGludG8gc2V2ZXJhbCBbYEZpbGVDbGllbnRgXXMuCiNbZGVyaXZlKERlYnVnKV0KcHViIHN0cnVjdCBDaHVua2VkRmlsZVJlYWRlciB7CiAgICAvLy8gRmlsZSByZWFkZXIgKGVpdGhlciBwbGFpbiBvciBnemlwKS4KICAgIGZpbGU6IEZpbGVSZWFkZXIsCiAgICAvLy8gQnl0ZXMgdGhhdCBoYXZlIGJlZW4gcmVhZC4KICAgIGNodW5rOiBWZWM8dTg+LAogICAgLy8vIE1heCBieXRlcyBwZXIgY2h1bmsuCiAgICBjaHVua19ieXRlX2xlbjogdTY0LAogICAgLy8vIE9wdGlvbmFsbHksIHRyYWNrcyBoaWdoZXN0IGRlY29kZWQgYmxvY2sgbnVtYmVyLiBOZWVkZWQgd2hlbiBkZWNvZGluZyBkYXRhIHRoYXQgbWFwcyAqIHRvIDEKICAgIC8vLyB3aXRoIGJsb2NrIG51bWJlcgogICAgaGlnaGVzdF9ibG9jazogT3B0aW9uPHU2ND4sCn0KCmltcGwgQ2h1bmtlZEZpbGVSZWFkZXIgewogICAgLy8vIE9wZW5zIHRoZSBmaWxlIHRvIGltcG9ydCBmcm9tIGdpdmVuIHBhdGguIFJldHVybnMgYSBuZXcgaW5zdGFuY2UuIElmIG5vIGNodW5rIGJ5dGUgbGVuZ3RoCiAgICAvLy8gaXMgcGFzc2VkLCBjaHVua3MgaGF2ZSBbYERFRkFVTFRfQllURV9MRU5fQ0hVTktfQ0hBSU5fRklMRWBdIChvbmUgc3RhdGljIGZpbGUpLgogICAgLy8vIEF1dG9tYXRpY2FsbHkgZGV0ZWN0cyBnemlwIGZpbGVzIGJ5IGV4dGVuc2lvbiAoLmd6LCAuZ3ppcCkuCiAgICBwdWIgYXN5bmMgZm4gbmV3PFA6IEFzUmVmPFBhdGg+PigKICAgICAgICBwYXRoOiBQLAogICAgICAgIGNodW5rX2J5dGVfbGVuOiBPcHRpb248dTY0PiwKICAgICkgLT4gUmVzdWx0PFNlbGYsIEZpbGVDbGllbnRFcnJvcj4gewogICAgICAgIGxldCBwYXRoID0gcGF0aC5hc19yZWYoKTsKICAgICAgICBsZXQgZmlsZSA9IEZpbGU6Om9wZW4ocGF0aCkuYXdhaXQ/OwogICAgICAgIGxldCBjaHVua19ieXRlX2xlbiA9IGNodW5rX2J5dGVfbGVuLnVud3JhcF9vcihERUZBVUxUX0JZVEVfTEVOX0NIVU5LX0NIQUlOX0ZJTEUpOwoKICAgICAgICBTZWxmOjpmcm9tX2ZpbGUoCiAgICAgICAgICAgIGZpbGUsCiAgICAgICAgICAgIGNodW5rX2J5dGVfbGVuLAogICAgICAgICAgICBwYXRoLmV4dGVuc2lvbigpCiAgICAgICAgICAgICAgICAuYW5kX3RoZW4ofGV4dHwgZXh0LnRvX3N0cigpKQogICAgICAgICAgICAgICAgLmlzX3NvbWVfYW5kKHxleHR8IFsiZ3oiLCAiZ3ppcCJdLmNvbnRhaW5zKCZleHQpKSwKICAgICAgICApCiAgICAgICAgLmF3YWl0CiAgICB9CgogICAgLy8vIE9wZW5zIHRoZSBmaWxlIHRvIGltcG9ydCBmcm9tIGdpdmVuIHBhdGguIFJldHVybnMgYSBuZXcgaW5zdGFuY2UuCiAgICBwdWIgYXN5bmMgZm4gZnJvbV9maWxlKAogICAgICAgIGZpbGU6IEZpbGUsCiAgICAgICAgY2h1bmtfYnl0ZV9sZW46IHU2NCwKICAgICAgICBpc19nemlwOiBib29sLAogICAgKSAtPiBSZXN1bHQ8U2VsZiwgRmlsZUNsaWVudEVycm9yPiB7CiAgICAgICAgbGV0IGZpbGVfcmVhZGVyID0gaWYgaXNfZ3ppcCB7CiAgICAgICAgICAgIEZpbGVSZWFkZXI6Okd6aXAoR3ppcERlY29kZXI6Om5ldyhCdWZSZWFkZXI6Om5ldyhmaWxlKSkpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGV0IHJlbWFpbmluZ19ieXRlcyA9IGZpbGUubWV0YWRhdGEoKS5hd2FpdD8ubGVuKCk7CiAgICAgICAgICAgIEZpbGVSZWFkZXI6OlBsYWluIHsgZmlsZSwgcmVtYWluaW5nX2J5dGVzIH0KICAgICAgICB9OwoKICAgICAgICBPayhTZWxmIHsgZmlsZTogZmlsZV9yZWFkZXIsIGNodW5rOiB2ZWMhW10sIGNodW5rX2J5dGVfbGVuLCBoaWdoZXN0X2Jsb2NrOiBOb25lIH0pCiAgICB9CgogICAgLy8vIFJlYWRzIGJ5dGVzIGZyb20gZmlsZSBhbmQgYnVmZmVycyBhcyBuZXh0IGNodW5rIHRvIGRlY29kZS4gUmV0dXJucyBieXRlIGxlbmd0aCBvZiBuZXh0CiAgICAvLy8gY2h1bmsgdG8gcmVhZC4KICAgIGFzeW5jIGZuIHJlYWRfbmV4dF9jaHVuaygmbXV0IHNlbGYpIC0+IFJlc3VsdDxPcHRpb248dTY0PiwgRmlsZUNsaWVudEVycm9yPiB7CiAgICAgICAgc2VsZi5maWxlLnJlYWRfbmV4dF9jaHVuaygmbXV0IHNlbGYuY2h1bmssIHNlbGYuY2h1bmtfYnl0ZV9sZW4pLmF3YWl0CiAgICB9CgogICAgLy8vIFJlYWQgbmV4dCBjaHVuayBmcm9tIGZpbGUuIFJldHVybnMgW2BGaWxlQ2xpZW50YF0gY29udGFpbmluZyBkZWNvZGVkIGNodW5rLgogICAgLy8vCiAgICAvLy8gRm9yIGd6aXBwZWQgZmlsZXMsIHRoaXMgbWV0aG9kIGFjY3VtdWxhdGVzIGRhdGEgdW50aWwgYXQgbGVhc3QgYGNodW5rX2J5dGVfbGVuYCBieXRlcwogICAgLy8vIGFyZSBhdmFpbGFibGUgYmVmb3JlIHByb2Nlc3NpbmcuIEZvciBwbGFpbiBmaWxlcywgaXQgdXNlcyB0aGUgb3JpZ2luYWwgY2h1bmtpbmcgbG9naWMuCiAgICBwdWIgYXN5bmMgZm4gbmV4dF9jaHVuazxCOiBGdWxsQmxvY2s+KAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBjb25zZW5zdXM6IEFyYzxkeW4gQ29uc2Vuc3VzPEI+PiwKICAgICAgICBwYXJlbnRfaGVhZGVyOiBPcHRpb248U2VhbGVkSGVhZGVyPEI6OkhlYWRlcj4+LAogICAgKSAtPiBSZXN1bHQ8T3B0aW9uPEZpbGVDbGllbnQ8Qj4+LCBGaWxlQ2xpZW50RXJyb3I+IHsKICAgICAgICBsZXQgU29tZShjaHVua19sZW4pID0gc2VsZi5yZWFkX25leHRfY2h1bmsoKS5hd2FpdD8gZWxzZSB7IHJldHVybiBPayhOb25lKSB9OwoKICAgICAgICAvLyBtYWtlIG5ldyBmaWxlIGNsaWVudCBmcm9tIGNodW5rCiAgICAgICAgbGV0IERlY29kZWRGaWxlQ2h1bmsgeyBmaWxlX2NsaWVudCwgcmVtYWluaW5nX2J5dGVzLCAuLiB9ID0KICAgICAgICAgICAgRmlsZUNsaWVudEJ1aWxkZXIgeyBjb25zZW5zdXMsIHBhcmVudF9oZWFkZXIgfQogICAgICAgICAgICAgICAgLmJ1aWxkKCZzZWxmLmNodW5rWy4uXSwgY2h1bmtfbGVuKQogICAgICAgICAgICAgICAgLmF3YWl0PzsKCiAgICAgICAgLy8gc2F2ZSBsZWZ0IG92ZXIgYnl0ZXMKICAgICAgICBzZWxmLmNodW5rID0gcmVtYWluaW5nX2J5dGVzOwoKICAgICAgICBPayhTb21lKGZpbGVfY2xpZW50KSkKICAgIH0KCiAgICAvLy8gUmVhZCBuZXh0IGNodW5rIGZyb20gZmlsZS4gUmV0dXJucyBbYEZpbGVDbGllbnRgXSBjb250YWluaW5nIGRlY29kZWQgY2h1bmsuCiAgICBwdWIgYXN5bmMgZm4gbmV4dF9yZWNlaXB0c19jaHVuazxUPigmbXV0IHNlbGYpIC0+IFJlc3VsdDxPcHRpb248VD4sIFQ6OkVycm9yPgogICAgd2hlcmUKICAgICAgICBUOiBGcm9tUmVjZWlwdFJlYWRlciwKICAgIHsKICAgICAgICBsZXQgU29tZShuZXh0X2NodW5rX2J5dGVfbGVuKSA9IHNlbGYucmVhZF9uZXh0X2NodW5rKCkuYXdhaXQubWFwX2Vycih8ZXwgewogICAgICAgICAgICBUOjpFcnJvcjo6ZnJvbShtYXRjaCBlIHsKICAgICAgICAgICAgICAgIEZpbGVDbGllbnRFcnJvcjo6SW8oaW9fZXJyKSA9PiBpb19lcnIsCiAgICAgICAgICAgICAgICBfID0+IGlvOjpFcnJvcjo6b3RoZXIoZS50b19zdHJpbmcoKSksCiAgICAgICAgICAgIH0pCiAgICAgICAgfSk/CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBPayhOb25lKQogICAgICAgIH07CgogICAgICAgIC8vIG1ha2UgbmV3IGZpbGUgY2xpZW50IGZyb20gY2h1bmsKICAgICAgICBsZXQgRGVjb2RlZEZpbGVDaHVuayB7IGZpbGVfY2xpZW50LCByZW1haW5pbmdfYnl0ZXMsIGhpZ2hlc3RfYmxvY2sgfSA9CiAgICAgICAgICAgIFQ6OmZyb21fcmVjZWlwdF9yZWFkZXIoJnNlbGYuY2h1bmtbLi5dLCBuZXh0X2NodW5rX2J5dGVfbGVuLCBzZWxmLmhpZ2hlc3RfYmxvY2spCiAgICAgICAgICAgICAgICAuYXdhaXQ/OwoKICAgICAgICAvLyBzYXZlIGxlZnQgb3ZlciBieXRlcwogICAgICAgIHNlbGYuY2h1bmsgPSByZW1haW5pbmdfYnl0ZXM7CiAgICAgICAgLy8gdXBkYXRlIGhpZ2hlc3QgYmxvY2sKICAgICAgICBzZWxmLmhpZ2hlc3RfYmxvY2sgPSBoaWdoZXN0X2Jsb2NrOwoKICAgICAgICBPayhTb21lKGZpbGVfY2xpZW50KSkKICAgIH0KfQoKLy8vIENvbnN0cnVjdHMgYSBmaWxlIGNsaWVudCBmcm9tIGEgcmVhZGVyLgpwdWIgdHJhaXQgRnJvbVJlYWRlciB7CiAgICAvLy8gRXJyb3IgcmV0dXJuZWQgYnkgZmlsZSBjbGllbnQgdHlwZS4KICAgIHR5cGUgRXJyb3I6IEZyb208aW86OkVycm9yPjsKCiAgICAvLy8gT3V0cHV0IHJldHVybmVkIGJ5IGZpbGUgY2xpZW50IHR5cGUuCiAgICB0eXBlIE91dHB1dDsKCiAgICAvLy8gUmV0dXJucyBhIGZpbGUgY2xpZW50CiAgICBmbiBidWlsZDxSPigKICAgICAgICAmc2VsZiwKICAgICAgICByZWFkZXI6IFIsCiAgICAgICAgbnVtX2J5dGVzOiB1NjQsCiAgICApIC0+IGltcGwgRnV0dXJlPE91dHB1dCA9IFJlc3VsdDxEZWNvZGVkRmlsZUNodW5rPFNlbGY6Ok91dHB1dD4sIFNlbGY6OkVycm9yPj4KICAgIHdoZXJlCiAgICAgICAgU2VsZjogU2l6ZWQsCiAgICAgICAgUjogQXN5bmNSZWFkRXh0ICsgVW5waW47Cn0KCi8vLyBPdXRwdXQgZnJvbSBkZWNvZGluZyBhIGZpbGUgY2h1bmsgd2l0aCBbYEZyb21SZWFkZXI6OmJ1aWxkYF0uCiNbZGVyaXZlKERlYnVnKV0KcHViIHN0cnVjdCBEZWNvZGVkRmlsZUNodW5rPFQ+IHsKICAgIC8vLyBGaWxlIGNsaWVudCwgaS5lLiB0aGUgZGVjb2RlZCBwYXJ0IG9mIGNodW5rLgogICAgcHViIGZpbGVfY2xpZW50OiBULAogICAgLy8vIFJlbWFpbmluZyBieXRlcyB0aGF0IGhhdmUgbm90IGJlZW4gZGVjb2RlZCwgZS5nLiBhIHBhcnRpYWwgYmxvY2sgb3IgYSBwYXJ0aWFsIHJlY2VpcHQuCiAgICBwdWIgcmVtYWluaW5nX2J5dGVzOiBWZWM8dTg+LAogICAgLy8vIEhpZ2hlc3QgYmxvY2sgb2YgZGVjb2RlZCBjaHVuay4gVGhpcyBpcyBuZWVkZWQgd2hlbiBkZWNvZGluZyBkYXRhIHRoYXQgbWFwcyAqIHRvIDEgd2l0aAogICAgLy8vIGJsb2NrIG51bWJlciwgbGlrZSByZWNlaXB0cy4KICAgIHB1YiBoaWdoZXN0X2Jsb2NrOiBPcHRpb248dTY0PiwKfQoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6Oio7CiAgICB1c2UgY3JhdGU6OnsKICAgICAgICBib2RpZXM6OnsKICAgICAgICAgICAgYm9kaWVzOjpCb2RpZXNEb3dubG9hZGVyQnVpbGRlciwKICAgICAgICAgICAgdGVzdF91dGlsczo6e2luc2VydF9oZWFkZXJzLCB6aXBfYmxvY2tzfSwKICAgICAgICB9LAogICAgICAgIGhlYWRlcnM6OntyZXZlcnNlX2hlYWRlcnM6OlJldmVyc2VIZWFkZXJzRG93bmxvYWRlckJ1aWxkZXIsIHRlc3RfdXRpbHM6OmNoaWxkX2hlYWRlcn0sCiAgICAgICAgdGVzdF91dGlsczo6e2dlbmVyYXRlX2JvZGllcywgZ2VuZXJhdGVfYm9kaWVzX2ZpbGV9LAogICAgfTsKICAgIHVzZSBhc3NlcnRfbWF0Y2hlczo6YXNzZXJ0X21hdGNoZXM7CiAgICB1c2UgYXN5bmNfY29tcHJlc3Npb246OnRva2lvOjp3cml0ZTo6R3ppcEVuY29kZXI7CiAgICB1c2UgZnV0dXJlc191dGlsOjpzdHJlYW06OlN0cmVhbUV4dDsKICAgIHVzZSByYW5kOjpSbmc7CiAgICB1c2UgcmV0aF9jb25zZW5zdXM6Ontub29wOjpOb29wQ29uc2Vuc3VzLCB0ZXN0X3V0aWxzOjpUZXN0Q29uc2Vuc3VzfTsKICAgIHVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrOwogICAgdXNlIHJldGhfbmV0d29ya19wMnA6OnsKICAgICAgICBib2RpZXM6OmRvd25sb2FkZXI6OkJvZHlEb3dubG9hZGVyLAogICAgICAgIGhlYWRlcnM6OmRvd25sb2FkZXI6OntIZWFkZXJEb3dubG9hZGVyLCBTeW5jVGFyZ2V0fSwKICAgIH07CiAgICB1c2UgcmV0aF9wcm92aWRlcjo6dGVzdF91dGlsczo6Y3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeTsKICAgIHVzZSBzdGQ6OnN5bmM6OkFyYzsKICAgIHVzZSB0b2tpbzo6ewogICAgICAgIGZzOjpGaWxlLAogICAgICAgIGlvOjp7QXN5bmNSZWFkRXh0LCBBc3luY1NlZWtFeHQsIEFzeW5jV3JpdGVFeHQsIFNlZWtGcm9tfSwKICAgIH07CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHN0cmVhbXNfYm9kaWVzX2Zyb21fYnVmZmVyKCkgewogICAgICAgIC8vIEdlbmVyYXRlIHNvbWUgcmFuZG9tIGJsb2NrcwogICAgICAgIGxldCBmYWN0b3J5ID0gY3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeSgpOwogICAgICAgIGxldCAoaGVhZGVycywgbXV0IGJvZGllcykgPSBnZW5lcmF0ZV9ib2RpZXMoMC4uPTE5KTsKCiAgICAgICAgaW5zZXJ0X2hlYWRlcnMoJmZhY3RvcnksICZoZWFkZXJzKTsKCiAgICAgICAgLy8gY3JlYXRlIGFuIGVtcHR5IGZpbGUKICAgICAgICBsZXQgZmlsZSA9IHRlbXBmaWxlOjp0ZW1wZmlsZSgpLnVud3JhcCgpOwoKICAgICAgICBsZXQgY2xpZW50OiBBcmM8RmlsZUNsaWVudDxCbG9jaz4+ID0gQXJjOjpuZXcoCiAgICAgICAgICAgIEZpbGVDbGllbnQ6OmZyb21fZmlsZShmaWxlLmludG8oKSwgTm9vcENvbnNlbnN1czo6YXJjKCkpCiAgICAgICAgICAgICAgICAuYXdhaXQKICAgICAgICAgICAgICAgIC51bndyYXAoKQogICAgICAgICAgICAgICAgLndpdGhfYm9kaWVzKGJvZGllcy5jbG9uZSgpKSwKICAgICAgICApOwogICAgICAgIGxldCBtdXQgZG93bmxvYWRlciA9IEJvZGllc0Rvd25sb2FkZXJCdWlsZGVyOjpkZWZhdWx0KCkuYnVpbGQ6OjxCbG9jaywgXywgXz4oCiAgICAgICAgICAgIGNsaWVudC5jbG9uZSgpLAogICAgICAgICAgICBBcmM6Om5ldyhUZXN0Q29uc2Vuc3VzOjpkZWZhdWx0KCkpLAogICAgICAgICAgICBmYWN0b3J5LAogICAgICAgICk7CiAgICAgICAgZG93bmxvYWRlci5zZXRfZG93bmxvYWRfcmFuZ2UoMC4uPTE5KS5leHBlY3QoImZhaWxlZCB0byBzZXQgZG93bmxvYWQgcmFuZ2UiKTsKCiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKAogICAgICAgICAgICBkb3dubG9hZGVyLm5leHQoKS5hd2FpdCwKICAgICAgICAgICAgU29tZShPayhyZXMpKSA9PiBhc3NlcnRfZXEhKHJlcywgemlwX2Jsb2NrcyhoZWFkZXJzLml0ZXIoKSwgJm11dCBib2RpZXMpKQogICAgICAgICk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGRvd25sb2FkX2hlYWRlcnNfYXRfZm9ya19oZWFkKCkgewogICAgICAgIHJldGhfdHJhY2luZzo6aW5pdF90ZXN0X3RyYWNpbmcoKTsKCiAgICAgICAgbGV0IHAzID0gU2VhbGVkSGVhZGVyOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IHAyID0gY2hpbGRfaGVhZGVyKCZwMyk7CiAgICAgICAgbGV0IHAxID0gY2hpbGRfaGVhZGVyKCZwMik7CiAgICAgICAgbGV0IHAwID0gY2hpbGRfaGVhZGVyKCZwMSk7CgogICAgICAgIGxldCBmaWxlID0gdGVtcGZpbGU6OnRlbXBmaWxlKCkudW53cmFwKCk7CiAgICAgICAgbGV0IGNsaWVudDogQXJjPEZpbGVDbGllbnQ8QmxvY2s+PiA9IEFyYzo6bmV3KAogICAgICAgICAgICBGaWxlQ2xpZW50Ojpmcm9tX2ZpbGUoZmlsZS5pbnRvKCksIE5vb3BDb25zZW5zdXM6OmFyYygpKS5hd2FpdC51bndyYXAoKS53aXRoX2hlYWRlcnMoCiAgICAgICAgICAgICAgICBIYXNoTWFwOjpmcm9tKFsKICAgICAgICAgICAgICAgICAgICAoMHU2NCwgcDAuY2xvbmVfaGVhZGVyKCkpLAogICAgICAgICAgICAgICAgICAgICgxLCBwMS5jbG9uZV9oZWFkZXIoKSksCiAgICAgICAgICAgICAgICAgICAgKDIsIHAyLmNsb25lX2hlYWRlcigpKSwKICAgICAgICAgICAgICAgICAgICAoMywgcDMuY2xvbmVfaGVhZGVyKCkpLAogICAgICAgICAgICAgICAgXSksCiAgICAgICAgICAgICksCiAgICAgICAgKTsKCiAgICAgICAgbGV0IG11dCBkb3dubG9hZGVyID0gUmV2ZXJzZUhlYWRlcnNEb3dubG9hZGVyQnVpbGRlcjo6ZGVmYXVsdCgpCiAgICAgICAgICAgIC5zdHJlYW1fYmF0Y2hfc2l6ZSgzKQogICAgICAgICAgICAucmVxdWVzdF9saW1pdCgzKQogICAgICAgICAgICAuYnVpbGQoQXJjOjpjbG9uZSgmY2xpZW50KSwgQXJjOjpuZXcoVGVzdENvbnNlbnN1czo6ZGVmYXVsdCgpKSk7CiAgICAgICAgZG93bmxvYWRlci51cGRhdGVfbG9jYWxfaGVhZChwMy5jbG9uZSgpKTsKICAgICAgICBkb3dubG9hZGVyLnVwZGF0ZV9zeW5jX3RhcmdldChTeW5jVGFyZ2V0OjpUaXAocDAuaGFzaCgpKSk7CgogICAgICAgIGxldCBoZWFkZXJzID0gZG93bmxvYWRlci5uZXh0KCkuYXdhaXQudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShoZWFkZXJzLnVud3JhcCgpLCB2ZWMhW3AwLCBwMSwgcDJdKTsKICAgICAgICBhc3NlcnQhKGRvd25sb2FkZXIubmV4dCgpLmF3YWl0LmlzX25vbmUoKSk7CiAgICAgICAgYXNzZXJ0IShkb3dubG9hZGVyLm5leHQoKS5hd2FpdC5pc19ub25lKCkpOwogICAgfQoKICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiB0ZXN0X2Rvd25sb2FkX2hlYWRlcnNfZnJvbV9maWxlKCkgewogICAgICAgIHJldGhfdHJhY2luZzo6aW5pdF90ZXN0X3RyYWNpbmcoKTsKCiAgICAgICAgLy8gR2VuZXJhdGUgc29tZSByYW5kb20gYmxvY2tzCiAgICAgICAgbGV0IChmaWxlLCBoZWFkZXJzLCBfKSA9IGdlbmVyYXRlX2JvZGllc19maWxlKDAuLj0xOSkuYXdhaXQ7CiAgICAgICAgLy8gbm93IHRyeSB0byByZWFkIHRoZW0gYmFjawogICAgICAgIGxldCBjbGllbnQ6IEFyYzxGaWxlQ2xpZW50PEJsb2NrPj4gPQogICAgICAgICAgICBBcmM6Om5ldyhGaWxlQ2xpZW50Ojpmcm9tX2ZpbGUoZmlsZSwgTm9vcENvbnNlbnN1czo6YXJjKCkpLmF3YWl0LnVud3JhcCgpKTsKCiAgICAgICAgLy8gY29uc3RydWN0IGhlYWRlcnMgZG93bmxvYWRlciBhbmQgdXNlIGZpcnN0IGhlYWRlcgogICAgICAgIGxldCBtdXQgaGVhZGVyX2Rvd25sb2FkZXIgPSBSZXZlcnNlSGVhZGVyc0Rvd25sb2FkZXJCdWlsZGVyOjpkZWZhdWx0KCkKICAgICAgICAgICAgLmJ1aWxkKEFyYzo6Y2xvbmUoJmNsaWVudCksIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSkpOwogICAgICAgIGhlYWRlcl9kb3dubG9hZGVyLnVwZGF0ZV9sb2NhbF9oZWFkKGhlYWRlcnMuZmlyc3QoKS51bndyYXAoKS5jbG9uZSgpKTsKICAgICAgICBoZWFkZXJfZG93bmxvYWRlci51cGRhdGVfc3luY190YXJnZXQoU3luY1RhcmdldDo6VGlwKGhlYWRlcnMubGFzdCgpLnVud3JhcCgpLmhhc2goKSkpOwoKICAgICAgICAvLyBnZXQgaGVhZGVycyBmaXJzdAogICAgICAgIGxldCBtdXQgZG93bmxvYWRlZF9oZWFkZXJzID0gaGVhZGVyX2Rvd25sb2FkZXIubmV4dCgpLmF3YWl0LnVud3JhcCgpLnVud3JhcCgpOwoKICAgICAgICAvLyByZXZlcnNlIHRvIG1ha2Ugc3VyZSBpdCdzIGluIHRoZSByaWdodCBvcmRlciBiZWZvcmUgY29tcGFyaW5nCiAgICAgICAgZG93bmxvYWRlZF9oZWFkZXJzLnJldmVyc2UoKTsKCiAgICAgICAgLy8gdGhlIGZpcnN0IGhlYWRlciBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHJlc3BvbnNlCiAgICAgICAgYXNzZXJ0X2VxIShkb3dubG9hZGVkX2hlYWRlcnMsIGhlYWRlcnNbMS4uXSk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfZG93bmxvYWRfYm9kaWVzX2Zyb21fZmlsZSgpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBzb21lIHJhbmRvbSBibG9ja3MKICAgICAgICBsZXQgZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKICAgICAgICBsZXQgKGZpbGUsIGhlYWRlcnMsIG11dCBib2RpZXMpID0gZ2VuZXJhdGVfYm9kaWVzX2ZpbGUoMC4uPTE5KS5hd2FpdDsKCiAgICAgICAgLy8gbm93IHRyeSB0byByZWFkIHRoZW0gYmFjawogICAgICAgIGxldCBjbGllbnQ6IEFyYzxGaWxlQ2xpZW50PEJsb2NrPj4gPQogICAgICAgICAgICBBcmM6Om5ldyhGaWxlQ2xpZW50Ojpmcm9tX2ZpbGUoZmlsZSwgTm9vcENvbnNlbnN1czo6YXJjKCkpLmF3YWl0LnVud3JhcCgpKTsKCiAgICAgICAgLy8gaW5zZXJ0IGhlYWRlcnMgaW4gZGIgZm9yIHRoZSBib2RpZXMgZG93bmxvYWRlcgogICAgICAgIGluc2VydF9oZWFkZXJzKCZmYWN0b3J5LCAmaGVhZGVycyk7CgogICAgICAgIGxldCBtdXQgZG93bmxvYWRlciA9IEJvZGllc0Rvd25sb2FkZXJCdWlsZGVyOjpkZWZhdWx0KCkuYnVpbGQ6OjxCbG9jaywgXywgXz4oCiAgICAgICAgICAgIGNsaWVudC5jbG9uZSgpLAogICAgICAgICAgICBBcmM6Om5ldyhUZXN0Q29uc2Vuc3VzOjpkZWZhdWx0KCkpLAogICAgICAgICAgICBmYWN0b3J5LAogICAgICAgICk7CiAgICAgICAgZG93bmxvYWRlci5zZXRfZG93bmxvYWRfcmFuZ2UoMC4uPTE5KS5leHBlY3QoImZhaWxlZCB0byBzZXQgZG93bmxvYWQgcmFuZ2UiKTsKCiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKAogICAgICAgICAgICBkb3dubG9hZGVyLm5leHQoKS5hd2FpdCwKICAgICAgICAgICAgU29tZShPayhyZXMpKSA9PiBhc3NlcnRfZXEhKHJlcywgemlwX2Jsb2NrcyhoZWFkZXJzLml0ZXIoKSwgJm11dCBib2RpZXMpKQogICAgICAgICk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfY2h1bmtfZG93bmxvYWRfaGVhZGVyc19mcm9tX2ZpbGUoKSB7CiAgICAgICAgcmV0aF90cmFjaW5nOjppbml0X3Rlc3RfdHJhY2luZygpOwoKICAgICAgICAvLyBHZW5lcmF0ZSBzb21lIHJhbmRvbSBibG9ja3MKICAgICAgICBsZXQgKGZpbGUsIGhlYWRlcnMsIF8pID0gZ2VuZXJhdGVfYm9kaWVzX2ZpbGUoMC4uPTE0KS5hd2FpdDsKCiAgICAgICAgLy8gY2FsY3VsYXRlIG1pbiBmb3IgY2h1bmsgYnl0ZSBsZW5ndGggcmFuZ2UsIHBpY2sgYSBsb3dlciBib3VuZCB0aGF0IGd1YXJhbnRlZXMgYXQgbGVhc3QKICAgICAgICAvLyBvbmUgYmxvY2sgd2lsbCBiZSByZWFkCiAgICAgICAgbGV0IGNodW5rX2J5dGVfbGVuID0gcmFuZDo6cm5nKCkucmFuZG9tX3JhbmdlKDIwMDAuLj0xMF8wMDApOwogICAgICAgIHRyYWNlISh0YXJnZXQ6ICJkb3dubG9hZGVyczo6ZmlsZTo6dGVzdCIsIGNodW5rX2J5dGVfbGVuKTsKCiAgICAgICAgLy8gaW5pdCByZWFkZXIKICAgICAgICBsZXQgbXV0IHJlYWRlciA9CiAgICAgICAgICAgIENodW5rZWRGaWxlUmVhZGVyOjpmcm9tX2ZpbGUoZmlsZSwgY2h1bmtfYnl0ZV9sZW4gYXMgdTY0LCBmYWxzZSkuYXdhaXQudW53cmFwKCk7CgogICAgICAgIGxldCBtdXQgZG93bmxvYWRlZF9oZWFkZXJzOiBWZWM8U2VhbGVkSGVhZGVyPiA9IHZlYyFbXTsKCiAgICAgICAgbGV0IG11dCBsb2NhbF9oZWFkZXIgPSBoZWFkZXJzLmZpcnN0KCkudW53cmFwKCkuY2xvbmUoKTsKCiAgICAgICAgLy8gdGVzdAogICAgICAgIHdoaWxlIGxldCBTb21lKGNsaWVudCkgPQogICAgICAgICAgICByZWFkZXIubmV4dF9jaHVuazo6PEJsb2NrPihOb29wQ29uc2Vuc3VzOjphcmMoKSwgTm9uZSkuYXdhaXQudW53cmFwKCkKICAgICAgICB7CiAgICAgICAgICAgIGxldCBzeW5jX3RhcmdldCA9IGNsaWVudC50aXBfaGVhZGVyKCkudW53cmFwKCk7CgogICAgICAgICAgICBsZXQgc3luY190YXJnZXRfaGFzaCA9IHN5bmNfdGFyZ2V0Lmhhc2goKTsKCiAgICAgICAgICAgIC8vIGNvbnN0cnVjdCBoZWFkZXJzIGRvd25sb2FkZXIgYW5kIHVzZSBmaXJzdCBoZWFkZXIKICAgICAgICAgICAgbGV0IG11dCBoZWFkZXJfZG93bmxvYWRlciA9IFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAgICAgLmJ1aWxkKEFyYzo6bmV3KGNsaWVudCksIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSkpOwogICAgICAgICAgICBoZWFkZXJfZG93bmxvYWRlci51cGRhdGVfbG9jYWxfaGVhZChsb2NhbF9oZWFkZXIuY2xvbmUoKSk7CiAgICAgICAgICAgIGhlYWRlcl9kb3dubG9hZGVyLnVwZGF0ZV9zeW5jX3RhcmdldChTeW5jVGFyZ2V0OjpUaXAoc3luY190YXJnZXRfaGFzaCkpOwoKICAgICAgICAgICAgLy8gZ2V0IGhlYWRlcnMgZmlyc3QKICAgICAgICAgICAgbGV0IG11dCBkb3dubG9hZGVkX2hlYWRlcnNfY2h1bmsgPSBoZWFkZXJfZG93bmxvYWRlci5uZXh0KCkuYXdhaXQudW53cmFwKCkudW53cmFwKCk7CgogICAgICAgICAgICAvLyBleHBvcnQgbmV3IGxvY2FsIGhlYWRlciB0byBvdXRlciBzY29wZQogICAgICAgICAgICBsb2NhbF9oZWFkZXIgPSBzeW5jX3RhcmdldDsKCiAgICAgICAgICAgIC8vIHJldmVyc2UgdG8gbWFrZSBzdXJlIGl0J3MgaW4gdGhlIHJpZ2h0IG9yZGVyIGJlZm9yZSBjb21wYXJpbmcKICAgICAgICAgICAgZG93bmxvYWRlZF9oZWFkZXJzX2NodW5rLnJldmVyc2UoKTsKICAgICAgICAgICAgZG93bmxvYWRlZF9oZWFkZXJzLmV4dGVuZF9mcm9tX3NsaWNlKCZkb3dubG9hZGVkX2hlYWRlcnNfY2h1bmspOwogICAgICAgIH0KCiAgICAgICAgLy8gdGhlIGZpcnN0IGhlYWRlciBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHJlc3BvbnNlCiAgICAgICAgYXNzZXJ0X2VxIShoZWFkZXJzWzEuLl0sIGRvd25sb2FkZWRfaGVhZGVycyk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHRlc3RfY2h1bmtfZG93bmxvYWRfaGVhZGVyc19mcm9tX2d6aXBfZmlsZSgpIHsKICAgICAgICByZXRoX3RyYWNpbmc6OmluaXRfdGVzdF90cmFjaW5nKCk7CgogICAgICAgIC8vIEdlbmVyYXRlIHNvbWUgcmFuZG9tIGJsb2NrcwogICAgICAgIGxldCAoZmlsZSwgaGVhZGVycywgXykgPSBnZW5lcmF0ZV9ib2RpZXNfZmlsZSgwLi49MTQpLmF3YWl0OwoKICAgICAgICAvLyBDcmVhdGUgYSBnemlwcGVkIHZlcnNpb24gb2YgdGhlIGZpbGUKICAgICAgICBsZXQgZ3ppcF90ZW1wX2ZpbGUgPSB0ZW1wZmlsZTo6TmFtZWRUZW1wRmlsZTo6bmV3KCkudW53cmFwKCk7CiAgICAgICAgbGV0IGd6aXBfcGF0aCA9IGd6aXBfdGVtcF9maWxlLnBhdGgoKS50b19vd25lZCgpOwogICAgICAgIGRyb3AoZ3ppcF90ZW1wX2ZpbGUpOyAvLyBDbG9zZSB0aGUgZmlsZSBzbyB3ZSBjYW4gd3JpdGUgdG8gaXQKCiAgICAgICAgLy8gUmVhZCBvcmlnaW5hbCBmaWxlIGNvbnRlbnQgZmlyc3QKICAgICAgICBsZXQgbXV0IG9yaWdpbmFsX2ZpbGUgPSBmaWxlOwogICAgICAgIG9yaWdpbmFsX2ZpbGUuc2VlayhTZWVrRnJvbTo6U3RhcnQoMCkpLmF3YWl0LnVud3JhcCgpOwogICAgICAgIGxldCBtdXQgb3JpZ2luYWxfY29udGVudCA9IFZlYzo6bmV3KCk7CiAgICAgICAgb3JpZ2luYWxfZmlsZS5yZWFkX3RvX2VuZCgmbXV0IG9yaWdpbmFsX2NvbnRlbnQpLmF3YWl0LnVud3JhcCgpOwoKICAgICAgICBsZXQgbXV0IGd6aXBfZmlsZSA9IEZpbGU6OmNyZWF0ZSgmZ3ppcF9wYXRoKS5hd2FpdC51bndyYXAoKTsKICAgICAgICBsZXQgbXV0IGVuY29kZXIgPSBHemlwRW5jb2Rlcjo6bmV3KCZtdXQgZ3ppcF9maWxlKTsKCiAgICAgICAgLy8gV3JpdGUgdGhlIG9yaWdpbmFsIGNvbnRlbnQgdGhyb3VnaCB0aGUgZ3ppcCBlbmNvZGVyCiAgICAgICAgZW5jb2Rlci53cml0ZV9hbGwoJm9yaWdpbmFsX2NvbnRlbnQpLmF3YWl0LnVud3JhcCgpOwogICAgICAgIGVuY29kZXIuc2h1dGRvd24oKS5hd2FpdC51bndyYXAoKTsKICAgICAgICBkcm9wKGd6aXBfZmlsZSk7CgogICAgICAgIC8vIFJlb3BlbiB0aGUgZ3ppcHBlZCBmaWxlIGZvciByZWFkaW5nCiAgICAgICAgbGV0IGd6aXBfZmlsZSA9IEZpbGU6Om9wZW4oJmd6aXBfcGF0aCkuYXdhaXQudW53cmFwKCk7CgogICAgICAgIC8vIGNhbGN1bGF0ZSBtaW4gZm9yIGNodW5rIGJ5dGUgbGVuZ3RoIHJhbmdlLCBwaWNrIGEgbG93ZXIgYm91bmQgdGhhdCBndWFyYW50ZWVzIGF0IGxlYXN0CiAgICAgICAgLy8gb25lIGJsb2NrIHdpbGwgYmUgcmVhZAogICAgICAgIGxldCBjaHVua19ieXRlX2xlbiA9IHJhbmQ6OnJuZygpLnJhbmRvbV9yYW5nZSgyMDAwLi49MTBfMDAwKTsKICAgICAgICB0cmFjZSEodGFyZ2V0OiAiZG93bmxvYWRlcnM6OmZpbGU6OnRlc3QiLCBjaHVua19ieXRlX2xlbik7CgogICAgICAgIC8vIGluaXQgcmVhZGVyIHdpdGggZ3ppcD10cnVlCiAgICAgICAgbGV0IG11dCByZWFkZXIgPQogICAgICAgICAgICBDaHVua2VkRmlsZVJlYWRlcjo6ZnJvbV9maWxlKGd6aXBfZmlsZSwgY2h1bmtfYnl0ZV9sZW4gYXMgdTY0LCB0cnVlKS5hd2FpdC51bndyYXAoKTsKCiAgICAgICAgbGV0IG11dCBkb3dubG9hZGVkX2hlYWRlcnM6IFZlYzxTZWFsZWRIZWFkZXI+ID0gdmVjIVtdOwoKICAgICAgICBsZXQgbXV0IGxvY2FsX2hlYWRlciA9IGhlYWRlcnMuZmlyc3QoKS51bndyYXAoKS5jbG9uZSgpOwoKICAgICAgICAvLyB0ZXN0CiAgICAgICAgd2hpbGUgbGV0IFNvbWUoY2xpZW50KSA9CiAgICAgICAgICAgIHJlYWRlci5uZXh0X2NodW5rOjo8QmxvY2s+KE5vb3BDb25zZW5zdXM6OmFyYygpLCBOb25lKS5hd2FpdC51bndyYXAoKQogICAgICAgIHsKICAgICAgICAgICAgaWYgY2xpZW50LmhlYWRlcnNfbGVuKCkgPT0gMCB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IHN5bmNfdGFyZ2V0ID0gY2xpZW50LnRpcF9oZWFkZXIoKS5leHBlY3QoInRpcF9oZWFkZXIgc2hvdWxkIG5vdCBiZSBOb25lIik7CgogICAgICAgICAgICBsZXQgc3luY190YXJnZXRfaGFzaCA9IHN5bmNfdGFyZ2V0Lmhhc2goKTsKCiAgICAgICAgICAgIC8vIGNvbnN0cnVjdCBoZWFkZXJzIGRvd25sb2FkZXIgYW5kIHVzZSBmaXJzdCBoZWFkZXIKICAgICAgICAgICAgbGV0IG11dCBoZWFkZXJfZG93bmxvYWRlciA9IFJldmVyc2VIZWFkZXJzRG93bmxvYWRlckJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAgICAgLmJ1aWxkKEFyYzo6bmV3KGNsaWVudCksIEFyYzo6bmV3KFRlc3RDb25zZW5zdXM6OmRlZmF1bHQoKSkpOwogICAgICAgICAgICBoZWFkZXJfZG93bmxvYWRlci51cGRhdGVfbG9jYWxfaGVhZChsb2NhbF9oZWFkZXIuY2xvbmUoKSk7CiAgICAgICAgICAgIGhlYWRlcl9kb3dubG9hZGVyLnVwZGF0ZV9zeW5jX3RhcmdldChTeW5jVGFyZ2V0OjpUaXAoc3luY190YXJnZXRfaGFzaCkpOwoKICAgICAgICAgICAgLy8gZ2V0IGhlYWRlcnMgZmlyc3QKICAgICAgICAgICAgbGV0IG11dCBkb3dubG9hZGVkX2hlYWRlcnNfY2h1bmsgPSBoZWFkZXJfZG93bmxvYWRlci5uZXh0KCkuYXdhaXQudW53cmFwKCkudW53cmFwKCk7CgogICAgICAgICAgICAvLyBleHBvcnQgbmV3IGxvY2FsIGhlYWRlciB0byBvdXRlciBzY29wZQogICAgICAgICAgICBsb2NhbF9oZWFkZXIgPSBzeW5jX3RhcmdldDsKCiAgICAgICAgICAgIC8vIHJldmVyc2UgdG8gbWFrZSBzdXJlIGl0J3MgaW4gdGhlIHJpZ2h0IG9yZGVyIGJlZm9yZSBjb21wYXJpbmcKICAgICAgICAgICAgZG93bmxvYWRlZF9oZWFkZXJzX2NodW5rLnJldmVyc2UoKTsKICAgICAgICAgICAgZG93bmxvYWRlZF9oZWFkZXJzLmV4dGVuZF9mcm9tX3NsaWNlKCZkb3dubG9hZGVkX2hlYWRlcnNfY2h1bmspOwogICAgICAgIH0KCiAgICAgICAgLy8gdGhlIGZpcnN0IGhlYWRlciBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHJlc3BvbnNlCiAgICAgICAgYXNzZXJ0X2VxIShoZWFkZXJzWzEuLl0sIGRvd25sb2FkZWRfaGVhZGVycyk7CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9hcGkvc3JjL2Vycm9yLnJzIj4KdXNlIGNyYXRlOjpQaXBlbGluZUV2ZW50Owp1c2UgYWxsb3lfZWlwczo6ZWlwMTg5ODo6QmxvY2tXaXRoUGFyZW50Owp1c2UgcmV0aF9jb25zZW5zdXM6OkNvbnNlbnN1c0Vycm9yOwp1c2UgcmV0aF9lcnJvcnM6OntCbG9ja0V4ZWN1dGlvbkVycm9yLCBEYXRhYmFzZUVycm9yLCBSZXRoRXJyb3J9Owp1c2UgcmV0aF9uZXR3b3JrX3AycDo6ZXJyb3I6OkRvd25sb2FkRXJyb3I7CnVzZSByZXRoX3Byb3ZpZGVyOjpQcm92aWRlckVycm9yOwp1c2UgcmV0aF9wcnVuZTo6e1BydW5lU2VnbWVudCwgUHJ1bmVTZWdtZW50RXJyb3IsIFBydW5lckVycm9yLCBVbndpbmRUYXJnZXRQcnVuZWRFcnJvcn07CnVzZSByZXRoX3N0YXRpY19maWxlX3R5cGVzOjpTdGF0aWNGaWxlU2VnbWVudDsKdXNlIHRoaXNlcnJvcjo6RXJyb3I7CnVzZSB0b2tpbzo6c3luYzo6YnJvYWRjYXN0OjplcnJvcjo6U2VuZEVycm9yOwoKLy8vIFJlcHJlc2VudHMgdGhlIHNwZWNpZmljIGVycm9yIHR5cGUgd2l0aGluIGEgYmxvY2sgZXJyb3IuCiNbZGVyaXZlKEVycm9yLCBEZWJ1ZyldCnB1YiBlbnVtIEJsb2NrRXJyb3JLaW5kIHsKICAgIC8vLyBUaGUgYmxvY2sgZW5jb3VudGVyZWQgYSB2YWxpZGF0aW9uIGVycm9yLgogICAgI1tlcnJvcigidmFsaWRhdGlvbiBlcnJvcjogezB9IildCiAgICBWYWxpZGF0aW9uKCNbZnJvbV0gQ29uc2Vuc3VzRXJyb3IpLAogICAgLy8vIFRoZSBibG9jayBlbmNvdW50ZXJlZCBhbiBleGVjdXRpb24gZXJyb3IuCiAgICAjW2Vycm9yKCJleGVjdXRpb24gZXJyb3I6IHswfSIpXQogICAgRXhlY3V0aW9uKCNbZnJvbV0gQmxvY2tFeGVjdXRpb25FcnJvciksCn0KCmltcGwgQmxvY2tFcnJvcktpbmQgewogICAgLy8vIFJldHVybnMgYHRydWVgIGlmIHRoZSBlcnJvciBpcyBhIHN0YXRlIHJvb3QgZXJyb3IuCiAgICBwdWIgY29uc3QgZm4gaXNfc3RhdGVfcm9vdF9lcnJvcigmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgbWF0Y2hlcyEoc2VsZiwgU2VsZjo6VmFsaWRhdGlvbihlcnIpIGlmIGVyci5pc19zdGF0ZV9yb290X2Vycm9yKCkpCiAgICB9Cn0KCi8vLyBBIHN0YWdlIGV4ZWN1dGlvbiBlcnJvci4KI1tkZXJpdmUoRXJyb3IsIERlYnVnKV0KcHViIGVudW0gU3RhZ2VFcnJvciB7CiAgICAvLy8gVGhlIHN0YWdlIGVuY291bnRlcmVkIGFuIGVycm9yIHJlbGF0ZWQgdG8gYSBibG9jay4KICAgICNbZXJyb3IoInN0YWdlIGVuY291bnRlcmVkIGFuIGVycm9yIGluIGJsb2NrICN7bnVtYmVyfToge2Vycm9yfSIsIG51bWJlciA9IGJsb2NrLmJsb2NrLm51bWJlcildCiAgICBCbG9jayB7CiAgICAgICAgLy8vIFRoZSBibG9jayB0aGF0IGNhdXNlZCB0aGUgZXJyb3IuCiAgICAgICAgYmxvY2s6IEJveDxCbG9ja1dpdGhQYXJlbnQ+LAogICAgICAgIC8vLyBUaGUgc3BlY2lmaWMgZXJyb3IgdHlwZSwgZWl0aGVyIGNvbnNlbnN1cyBvciBleGVjdXRpb24gZXJyb3IuCiAgICAgICAgI1tzb3VyY2VdCiAgICAgICAgZXJyb3I6IEJsb2NrRXJyb3JLaW5kLAogICAgfSwKICAgIC8vLyBUaGUgc3RhZ2UgZW5jb3VudGVyZWQgYSBkb3dubG9hZGVyIGVycm9yIHdoZXJlIHRoZSByZXNwb25zZXMgY2Fubm90IGJlIGF0dGFjaGVkIHRvIHRoZQogICAgLy8vIGN1cnJlbnQgaGVhZC4KICAgICNbZXJyb3IoCiAgICAgICAgInN0YWdlIGVuY291bnRlcmVkIGluY29uc2lzdGVudCBjaGFpbjogXAogICAgICAgICBkb3dubG9hZGVkIGhlYWRlciAje2hlYWRlcl9udW1iZXJ9ICh7aGVhZGVyX2hhc2h9KSBpcyBkZXRhY2hlZCBmcm9tIFwKICAgICAgICAgbG9jYWwgaGVhZCAje2hlYWRfbnVtYmVyfSAoe2hlYWRfaGFzaH0pOiB7ZXJyb3J9IiwKICAgICAgICBoZWFkZXJfbnVtYmVyID0gaGVhZGVyLmJsb2NrLm51bWJlciwKICAgICAgICBoZWFkZXJfaGFzaCA9IGhlYWRlci5ibG9jay5oYXNoLAogICAgICAgIGhlYWRfbnVtYmVyID0gbG9jYWxfaGVhZC5ibG9jay5udW1iZXIsCiAgICAgICAgaGVhZF9oYXNoID0gbG9jYWxfaGVhZC5ibG9jay5oYXNoLAogICAgKV0KICAgIERldGFjaGVkSGVhZCB7CiAgICAgICAgLy8vIFRoZSBsb2NhbCBoZWFkIHdlIGF0dGVtcHRlZCB0byBhdHRhY2ggdG8uCiAgICAgICAgbG9jYWxfaGVhZDogQm94PEJsb2NrV2l0aFBhcmVudD4sCiAgICAgICAgLy8vIFRoZSBoZWFkZXIgd2UgYXR0ZW1wdGVkIHRvIGF0dGFjaC4KICAgICAgICBoZWFkZXI6IEJveDxCbG9ja1dpdGhQYXJlbnQ+LAogICAgICAgIC8vLyBUaGUgZXJyb3IgdGhhdCBvY2N1cnJlZCB3aGVuIGF0dGVtcHRpbmcgdG8gYXR0YWNoIHRoZSBoZWFkZXIuCiAgICAgICAgI1tzb3VyY2VdCiAgICAgICAgZXJyb3I6IEJveDxDb25zZW5zdXNFcnJvcj4sCiAgICB9LAogICAgLy8vIFRoZSBoZWFkZXJzIHN0YWdlIGlzIG1pc3Npbmcgc3luYyBnYXAuCiAgICAjW2Vycm9yKCJtaXNzaW5nIHN5bmMgZ2FwIildCiAgICBNaXNzaW5nU3luY0dhcCwKICAgIC8vLyBUaGUgc3RhZ2UgZW5jb3VudGVyZWQgYSBkYXRhYmFzZSBlcnJvci4KICAgICNbZXJyb3IoImludGVybmFsIGRhdGFiYXNlIGVycm9yIG9jY3VycmVkOiB7MH0iKV0KICAgIERhdGFiYXNlKCNbZnJvbV0gRGF0YWJhc2VFcnJvciksCiAgICAvLy8gSW52YWxpZCBwcnVuaW5nIGNvbmZpZ3VyYXRpb24KICAgICNbZXJyb3IodHJhbnNwYXJlbnQpXQogICAgUHJ1bmluZ0NvbmZpZ3VyYXRpb24oI1tmcm9tXSBQcnVuZVNlZ21lbnRFcnJvciksCiAgICAvLy8gUHJ1bmVyIGVycm9yCiAgICAjW2Vycm9yKHRyYW5zcGFyZW50KV0KICAgIFBydW5lcigjW2Zyb21dIFBydW5lckVycm9yKSwKICAgIC8vLyBJbnZhbGlkIGNoZWNrcG9pbnQgcGFzc2VkIHRvIHRoZSBzdGFnZQogICAgI1tlcnJvcigiaW52YWxpZCBzdGFnZSBjaGVja3BvaW50OiB7MH0iKV0KICAgIFN0YWdlQ2hlY2twb2ludCh1NjQpLAogICAgLy8vIE1pc3NpbmcgZG93bmxvYWQgYnVmZmVyIG9uIHN0YWdlIGV4ZWN1dGlvbi4KICAgIC8vLyBSZXR1cm5lZCBpZiBzdGFnZSBleGVjdXRpb24gd2FzIGNhbGxlZCB3aXRob3V0IHBvbGxpbmcgZm9yIHJlYWRpbmVzcy4KICAgICNbZXJyb3IoIm1pc3NpbmcgZG93bmxvYWQgYnVmZmVyIildCiAgICBNaXNzaW5nRG93bmxvYWRCdWZmZXIsCiAgICAvLy8gRG93bmxvYWQgY2hhbm5lbCBjbG9zZWQKICAgICNbZXJyb3IoImRvd25sb2FkIGNoYW5uZWwgY2xvc2VkIildCiAgICBDaGFubmVsQ2xvc2VkLAogICAgLy8vIFRoZSBzdGFnZSBlbmNvdW50ZXJlZCBhIGRhdGFiYXNlIGludGVncml0eSBlcnJvci4KICAgICNbZXJyb3IoImRhdGFiYXNlIGludGVncml0eSBlcnJvciBvY2N1cnJlZDogezB9IildCiAgICBEYXRhYmFzZUludGVncml0eSgjW2Zyb21dIFByb3ZpZGVyRXJyb3IpLAogICAgLy8vIEludmFsaWQgZG93bmxvYWQgcmVzcG9uc2UuIEFwcGxpY2FibGUgZm9yIHN0YWdlcyB3aGljaAogICAgLy8vIHJlbHkgb24gZXh0ZXJuYWwgZG93bmxvYWRlcnMKICAgICNbZXJyb3IoImludmFsaWQgZG93bmxvYWQgcmVzcG9uc2U6IHswfSIpXQogICAgRG93bmxvYWQoI1tmcm9tXSBEb3dubG9hZEVycm9yKSwKICAgIC8vLyBEYXRhYmFzZSBpcyBhaGVhZCBvZiBzdGF0aWMgZmlsZSBkYXRhLgogICAgI1tlcnJvcigibWlzc2luZyBzdGF0aWMgZmlsZSBkYXRhIGZvciBibG9jayBudW1iZXI6IHtudW1iZXJ9IiwgbnVtYmVyID0gYmxvY2suYmxvY2subnVtYmVyKV0KICAgIE1pc3NpbmdTdGF0aWNGaWxlRGF0YSB7CiAgICAgICAgLy8vIFN0YXJ0aW5nIGJsb2NrIHdpdGggbWlzc2luZyBkYXRhLgogICAgICAgIGJsb2NrOiBCb3g8QmxvY2tXaXRoUGFyZW50PiwKICAgICAgICAvLy8gU3RhdGljIEZpbGUgc2VnbWVudAogICAgICAgIHNlZ21lbnQ6IFN0YXRpY0ZpbGVTZWdtZW50LAogICAgfSwKICAgIC8vLyBUaGUgcHJ1bmUgY2hlY2twb2ludCBmb3IgdGhlIGdpdmVuIHNlZ21lbnQgaXMgbWlzc2luZy4KICAgICNbZXJyb3IoIm1pc3NpbmcgcHJ1bmUgY2hlY2twb2ludCBmb3IgezB9IildCiAgICBNaXNzaW5nUHJ1bmVDaGVja3BvaW50KFBydW5lU2VnbWVudCksCiAgICAvLy8gUG9zdCBFeGVjdXRlIENvbW1pdCBlcnJvcgogICAgI1tlcnJvcigicG9zdCBleGVjdXRlIGNvbW1pdCBlcnJvciBvY2N1cnJlZDoge18wfSIpXQogICAgUG9zdEV4ZWN1dGVDb21taXQoJidzdGF0aWMgc3RyKSwKICAgIC8vLyBJbnRlcm5hbCBlcnJvcgogICAgI1tlcnJvcih0cmFuc3BhcmVudCldCiAgICBJbnRlcm5hbCgjW2Zyb21dIFJldGhFcnJvciksCiAgICAvLy8gVGhlIHN0YWdlIGVuY291bnRlcmVkIGEgcmVjb3ZlcmFibGUgZXJyb3IuCiAgICAvLy8KICAgIC8vLyBUaGVzZSB0eXBlcyBvZiBlcnJvcnMgYXJlIGNhdWdodCBieSB0aGUgW1BpcGVsaW5lXVtjcmF0ZTo6UGlwZWxpbmVdIGFuZCB0cmlnZ2VyIGEgcmVzdGFydAogICAgLy8vIG9mIHRoZSBzdGFnZS4KICAgICNbZXJyb3IodHJhbnNwYXJlbnQpXQogICAgUmVjb3ZlcmFibGUoQm94PGR5biBjb3JlOjplcnJvcjo6RXJyb3IgKyBTZW5kICsgU3luYz4pLAogICAgLy8vIFRoZSBzdGFnZSBlbmNvdW50ZXJlZCBhIGZhdGFsIGVycm9yLgogICAgLy8vCiAgICAvLy8gVGhlc2UgdHlwZXMgb2YgZXJyb3JzIHN0b3AgdGhlIHBpcGVsaW5lLgogICAgI1tlcnJvcih0cmFuc3BhcmVudCldCiAgICBGYXRhbChCb3g8ZHluIGNvcmU6OmVycm9yOjpFcnJvciArIFNlbmQgKyBTeW5jPiksCn0KCmltcGwgU3RhZ2VFcnJvciB7CiAgICAvLy8gSWYgdGhlIGVycm9yIGlzIGZhdGFsIHRoZSBwaXBlbGluZSB3aWxsIHN0b3AuCiAgICBwdWIgY29uc3QgZm4gaXNfZmF0YWwoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIG1hdGNoZXMhKAogICAgICAgICAgICBzZWxmLAogICAgICAgICAgICBTZWxmOjpEYXRhYmFzZShfKSB8CiAgICAgICAgICAgICAgICBTZWxmOjpEb3dubG9hZChfKSB8CiAgICAgICAgICAgICAgICBTZWxmOjpEYXRhYmFzZUludGVncml0eShfKSB8CiAgICAgICAgICAgICAgICBTZWxmOjpTdGFnZUNoZWNrcG9pbnQoXykgfAogICAgICAgICAgICAgICAgU2VsZjo6TWlzc2luZ0Rvd25sb2FkQnVmZmVyIHwKICAgICAgICAgICAgICAgIFNlbGY6Ok1pc3NpbmdTeW5jR2FwIHwKICAgICAgICAgICAgICAgIFNlbGY6OkNoYW5uZWxDbG9zZWQgfAogICAgICAgICAgICAgICAgU2VsZjo6SW50ZXJuYWwoXykgfAogICAgICAgICAgICAgICAgU2VsZjo6RmF0YWwoXykKICAgICAgICApCiAgICB9Cn0KCmltcGwgRnJvbTxzdGQ6OmlvOjpFcnJvcj4gZm9yIFN0YWdlRXJyb3IgewogICAgZm4gZnJvbShzb3VyY2U6IHN0ZDo6aW86OkVycm9yKSAtPiBTZWxmIHsKICAgICAgICBTZWxmOjpGYXRhbChCb3g6Om5ldyhzb3VyY2UpKQogICAgfQp9CgovLy8gQSBwaXBlbGluZSBleGVjdXRpb24gZXJyb3IuCiNbZGVyaXZlKEVycm9yLCBEZWJ1ZyldCnB1YiBlbnVtIFBpcGVsaW5lRXJyb3IgewogICAgLy8vIFRoZSBwaXBlbGluZSBlbmNvdW50ZXJlZCBhbiBpcnJlY292ZXJhYmxlIGVycm9yIGluIG9uZSBvZiB0aGUgc3RhZ2VzLgogICAgI1tlcnJvcih0cmFuc3BhcmVudCldCiAgICBTdGFnZSgjW2Zyb21dIFN0YWdlRXJyb3IpLAogICAgLy8vIFRoZSBwaXBlbGluZSBlbmNvdW50ZXJlZCBhIGRhdGFiYXNlIGVycm9yLgogICAgI1tlcnJvcih0cmFuc3BhcmVudCldCiAgICBEYXRhYmFzZSgjW2Zyb21dIERhdGFiYXNlRXJyb3IpLAogICAgLy8vIFByb3ZpZGVyIGVycm9yLgogICAgI1tlcnJvcih0cmFuc3BhcmVudCldCiAgICBQcm92aWRlcigjW2Zyb21dIFByb3ZpZGVyRXJyb3IpLAogICAgLy8vIFRoZSBwaXBlbGluZSBlbmNvdW50ZXJlZCBhbiBlcnJvciB3aGlsZSB0cnlpbmcgdG8gc2VuZCBhbiBldmVudC4KICAgICNbZXJyb3IoInBpcGVsaW5lIGVuY291bnRlcmVkIGFuIGVycm9yIHdoaWxlIHRyeWluZyB0byBzZW5kIGFuIGV2ZW50IildCiAgICBDaGFubmVsKCNbZnJvbV0gQm94PFNlbmRFcnJvcjxQaXBlbGluZUV2ZW50Pj4pLAogICAgLy8vIEludGVybmFsIGVycm9yCiAgICAjW2Vycm9yKHRyYW5zcGFyZW50KV0KICAgIEludGVybmFsKCNbZnJvbV0gUmV0aEVycm9yKSwKICAgIC8vLyBUaGUgcGlwZWxpbmUgZW5jb3VudGVyZWQgYW4gdW53aW5kIHdoZW4gYGZhaWxfb25fdW53aW5kYCB3YXMgc2V0IHRvIGB0cnVlYC4KICAgICNbZXJyb3IoInVuZXhwZWN0ZWQgdW53aW5kIildCiAgICBVbmV4cGVjdGVkVW53aW5kLAogICAgLy8vIFVud2luZCB0YXJnZXQgcHJ1bmVkIGVycm9yLgogICAgI1tlcnJvcih0cmFuc3BhcmVudCldCiAgICBVbndpbmRUYXJnZXRQcnVuZWQoI1tmcm9tXSBVbndpbmRUYXJnZXRQcnVuZWRFcnJvciksCn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9zdGFnZXMvc3JjL3N0YWdlcy9tb2QucnMiPgovLy8gVGhlIGJvZGllcyBzdGFnZS4KbW9kIGJvZGllczsKLy8vIFRoZSBleGVjdXRpb24gc3RhZ2UgdGhhdCBnZW5lcmF0ZXMgc3RhdGUgZGlmZi4KbW9kIGV4ZWN1dGlvbjsKLy8vIFRoZSBmaW5pc2ggc3RhZ2UKbW9kIGZpbmlzaDsKLy8vIEFjY291bnQgaGFzaGluZyBzdGFnZS4KbW9kIGhhc2hpbmdfYWNjb3VudDsKLy8vIFN0b3JhZ2UgaGFzaGluZyBzdGFnZS4KbW9kIGhhc2hpbmdfc3RvcmFnZTsKLy8vIFRoZSBoZWFkZXJzIHN0YWdlLgptb2QgaGVhZGVyczsKLy8vIEluZGV4IGhpc3Rvcnkgb2YgYWNjb3VudCBjaGFuZ2VzCm1vZCBpbmRleF9hY2NvdW50X2hpc3Rvcnk7Ci8vLyBJbmRleCBoaXN0b3J5IG9mIHN0b3JhZ2UgY2hhbmdlcwptb2QgaW5kZXhfc3RvcmFnZV9oaXN0b3J5OwovLy8gU3RhZ2UgZm9yIGNvbXB1dGluZyBzdGF0ZSByb290Lgptb2QgbWVya2xlOwptb2QgcHJ1bmU7Ci8vLyBUaGUgc2VuZGVyIHJlY292ZXJ5IHN0YWdlLgptb2Qgc2VuZGVyX3JlY292ZXJ5OwovLy8gVGhlIHRyYW5zYWN0aW9uIGxvb2t1cCBzdGFnZQptb2QgdHhfbG9va3VwOwoKcHViIHVzZSBib2RpZXM6Oio7CnB1YiB1c2UgZXJhOjoqOwpwdWIgdXNlIGV4ZWN1dGlvbjo6KjsKcHViIHVzZSBmaW5pc2g6Oio7CnB1YiB1c2UgaGFzaGluZ19hY2NvdW50OjoqOwpwdWIgdXNlIGhhc2hpbmdfc3RvcmFnZTo6KjsKcHViIHVzZSBoZWFkZXJzOjoqOwpwdWIgdXNlIGluZGV4X2FjY291bnRfaGlzdG9yeTo6KjsKcHViIHVzZSBpbmRleF9zdG9yYWdlX2hpc3Rvcnk6Oio7CnB1YiB1c2UgbWVya2xlOjoqOwpwdWIgdXNlIHBydW5lOjoqOwpwdWIgdXNlIHNlbmRlcl9yZWNvdmVyeTo6KjsKcHViIHVzZSB0eF9sb29rdXA6Oio7Cgptb2QgZXJhOwptb2QgdXRpbHM7Cgp1c2UgdXRpbHM6Oio7CgojW2NmZyh0ZXN0KV0KbW9kIHRlc3RzIHsKICAgIHVzZSBzdXBlcjo6KjsKICAgIHVzZSBjcmF0ZTo6dGVzdF91dGlsczo6e1N0b3JhZ2VLaW5kLCBUZXN0U3RhZ2VEQn07CiAgICB1c2UgYWxsb3lfY29uc2Vuc3VzOjp7U2lnbmFibGVUcmFuc2FjdGlvbiwgVHhMZWdhY3l9OwogICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OnsKICAgICAgICBhZGRyZXNzLCBoZXhfbGl0ZXJhbDo6aGV4LCBrZWNjYWsyNTYsIEJsb2NrTnVtYmVyLCBTaWduYXR1cmUsIEIyNTYsIFUyNTYsCiAgICB9OwogICAgdXNlIGFsbG95X3JscDo6RGVjb2RhYmxlOwogICAgdXNlIHJldGhfY2hhaW5zcGVjOjpDaGFpblNwZWNCdWlsZGVyOwogICAgdXNlIHJldGhfZGI6Om1kYng6OntjdXJzb3I6OkN1cnNvciwgUld9OwogICAgdXNlIHJldGhfZGJfYXBpOjp7CiAgICAgICAgY3Vyc29yOjp7RGJDdXJzb3JSTywgRGJDdXJzb3JSV30sCiAgICAgICAgdGFibGU6OlRhYmxlLAogICAgICAgIHRhYmxlcywKICAgICAgICB0cmFuc2FjdGlvbjo6e0RiVHgsIERiVHhNdXR9LAogICAgICAgIEFjY291bnRzSGlzdG9yeSwKICAgIH07CiAgICB1c2UgcmV0aF9ldGhlcmV1bV9jb25zZW5zdXM6OkV0aEJlYWNvbkNvbnNlbnN1czsKICAgIHVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrOwogICAgdXNlIHJldGhfZXZtX2V0aGVyZXVtOjpFdGhFdm1Db25maWc7CiAgICB1c2UgcmV0aF9leGV4OjpFeEV4TWFuYWdlckhhbmRsZTsKICAgIHVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjp7QWNjb3VudCwgQnl0ZWNvZGUsIFNlYWxlZEJsb2NrfTsKICAgIHVzZSByZXRoX3Byb3ZpZGVyOjp7CiAgICAgICAgcHJvdmlkZXJzOjp7U3RhdGljRmlsZVByb3ZpZGVyLCBTdGF0aWNGaWxlV3JpdGVyfSwKICAgICAgICB0ZXN0X3V0aWxzOjpNb2NrTm9kZVR5cGVzV2l0aERCLAogICAgICAgIEFjY291bnRFeHRSZWFkZXIsIEJsb2NrQm9keUluZGljZXNQcm92aWRlciwgQmxvY2tXcml0ZXIsIERhdGFiYXNlUHJvdmlkZXJGYWN0b3J5LAogICAgICAgIFByb3ZpZGVyRmFjdG9yeSwgUHJvdmlkZXJSZXN1bHQsIFJlY2VpcHRQcm92aWRlciwgU3RhZ2VDaGVja3BvaW50V3JpdGVyLAogICAgICAgIFN0YXRpY0ZpbGVQcm92aWRlckZhY3RvcnksIFN0b3JhZ2VSZWFkZXIsCiAgICB9OwogICAgdXNlIHJldGhfcHJ1bmVfdHlwZXM6OntQcnVuZU1vZGUsIFBydW5lTW9kZXN9OwogICAgdXNlIHJldGhfc3RhZ2VzX2FwaTo6ewogICAgICAgIEV4ZWNJbnB1dCwgRXhlY3V0aW9uU3RhZ2VUaHJlc2hvbGRzLCBQaXBlbGluZVRhcmdldCwgU3RhZ2UsIFN0YWdlQ2hlY2twb2ludCwgU3RhZ2VJZCwKICAgIH07CiAgICB1c2UgcmV0aF9zdGF0aWNfZmlsZV90eXBlczo6U3RhdGljRmlsZVNlZ21lbnQ7CiAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjpnZW5lcmF0b3JzOjp7CiAgICAgICAgc2VsZiwgcmFuZG9tX2Jsb2NrLCByYW5kb21fYmxvY2tfcmFuZ2UsIHJhbmRvbV9yZWNlaXB0LCBCbG9ja1JhbmdlUGFyYW1zLAogICAgfTsKICAgIHVzZSBzdGQ6Ontpbzo6V3JpdGUsIHN5bmM6OkFyY307CgogICAgI1t0b2tpbzo6dGVzdF0KICAgICNbaWdub3JlXQogICAgYXN5bmMgZm4gdGVzdF9wcnVuZSgpIHsKICAgICAgICBsZXQgdGVzdF9kYiA9IFRlc3RTdGFnZURCOjpkZWZhdWx0KCk7CgogICAgICAgIGxldCBwcm92aWRlcl9ydyA9IHRlc3RfZGIuZmFjdG9yeS5wcm92aWRlcl9ydygpLnVud3JhcCgpOwogICAgICAgIGxldCB0aXAgPSA2NjsKICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgeyB0YXJnZXQ6IFNvbWUodGlwKSwgY2hlY2twb2ludDogTm9uZSB9OwogICAgICAgIGxldCBtdXQgZ2VuZXNpc19ybHAgPSBoZXghKCJmOTAxZmFmOTAxZjVhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDBhMDFkY2M0ZGU4ZGVjNzVkN2FhYjg1YjU2N2I2Y2NkNDFhZDMxMjQ1MWI5NDhhNzQxM2YwYTE0MmZkNDBkNDkzNDc5NDJhZGMyNTY2NTAxOGFhMWZlMGU2YmM2NjZkYWM4ZmMyNjk3ZmY5YmFhMDQ1NTcxYjQwYWU2NmNhNzQ4MDc5MWJiYjI4ODcyODZlNGU0YzRiMWIyOThiMTkxYzg4OWQ2OTU5MDIzYTMyZWRhMDU2ZTgxZjE3MWJjYzU1YTZmZjgzNDVlNjkyYzBmODZlNWI0OGUwMWI5OTZjYWRjMDAxNjIyZmI1ZTM2M2I0MjFhMDU2ZTgxZjE3MWJjYzU1YTZmZjgzNDVlNjkyYzBmODZlNWI0OGUwMWI5OTZjYWRjMDAxNjIyZmI1ZTM2M2I0MjFiOTAxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDgzMDIwMDAwODA4NTAyNTQwYmU0MDA4MDgwMDBhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4ODAwMDAwMDAwMDAwMDAwMDBjMGMwIikuYXNfc2xpY2UoKTsKICAgICAgICBsZXQgZ2VuZXNpcyA9IFNlYWxlZEJsb2NrOjo8QmxvY2s+OjpkZWNvZGUoJm11dCBnZW5lc2lzX3JscCkudW53cmFwKCk7CiAgICAgICAgbGV0IG11dCBibG9ja19ybHAgPSBoZXghKCJmOTAyNjJmOTAxZjlhMDc1YzM3MWJhNDU5OTlkODdmNDU0MjMyNjkxMGExMWFmNTE1ODk3YWViY2U1MjY1ZDNmNmFjZDFmMTE2MWY4MmZhMDFkY2M0ZGU4ZGVjNzVkN2FhYjg1YjU2N2I2Y2NkNDFhZDMxMjQ1MWI5NDhhNzQxM2YwYTE0MmZkNDBkNDkzNDc5NDJhZGMyNTY2NTAxOGFhMWZlMGU2YmM2NjZkYWM4ZmMyNjk3ZmY5YmFhMDk4ZjJkY2Q4N2M4YWU0MDgzZTcwMTdhMDU0NTZjMTRlZWE0YjFkYjIwMzIxMjZlMjdiM2IxNTYzZDU3ZDdjYzBhMDgxNTFkNTQ4MjczZjY2ODMxNjk1MjRiNjZjYTlmZTMzOGI5Y2U0MmJjMzU0MDA0NmM4MjhmZDkzOWFlMjNiY2JhMDNmNGU1YzJlYzViMjE3MGI3MTFkOTdlZTc1NWMxNjA0NTdiYjU4ZDhkYWEzMzhlODM1ZWMwMmFlNjg2MGJiYWJiOTAxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDgzMDIwMDAwMDE4NTAyNTQwYmU0MDA4MmE4Nzk4MjAzZTgwMGEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDg4MDAwMDAwMDAwMDAwMDAwMGY4NjNmODYxODAwYTg0MDVmNWUxMDA5NDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4MDgwMWJhMDdlMDllMjY2NzhlZDRmYWMwOGEyNDllYmU4ZWQ2ODBiZjkwNTFhNWUxNGFkMjIzZTRiMmI5ZDI2ZTAyMDhmMzdhMDVmNmUzZjE4OGUzZTZlYWI3ZDdkM2I2NTY4ZjVlYWM3ZDY4N2IwOGQzMDdkMzE1NGNjZDhjODdiNDYzMDUwOWJjMCIpLmFzX3NsaWNlKCk7CiAgICAgICAgbGV0IGJsb2NrID0gU2VhbGVkQmxvY2s6OjxCbG9jaz46OmRlY29kZSgmbXV0IGJsb2NrX3JscCkudW53cmFwKCk7CiAgICAgICAgbGV0IG11dCBoZWFkID0gYmxvY2suaGFzaCgpOwogICAgICAgIHByb3ZpZGVyX3J3Lmluc2VydF9ibG9jaygmZ2VuZXNpcy50cnlfcmVjb3ZlcigpLnVud3JhcCgpKS51bndyYXAoKTsKICAgICAgICBwcm92aWRlcl9ydy5pbnNlcnRfYmxvY2soJmJsb2NrLnRyeV9yZWNvdmVyKCkudW53cmFwKCkpLnVud3JhcCgpOwoKICAgICAgICAvLyBGaWxsIHdpdGggYm9ndXMgYmxvY2tzIHRvIHJlc3BlY3QgUHJ1bmVNb2RlIGRpc3RhbmNlLgogICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CiAgICAgICAgZm9yIGJsb2NrX251bWJlciBpbiAyLi49dGlwIHsKICAgICAgICAgICAgbGV0IG5ibG9jayA9IHJhbmRvbV9ibG9jaygKICAgICAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgZ2VuZXJhdG9yczo6QmxvY2tQYXJhbXMgeyBwYXJlbnQ6IFNvbWUoaGVhZCksIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGhlYWQgPSBuYmxvY2suaGFzaCgpOwogICAgICAgICAgICBwcm92aWRlcl9ydy5pbnNlcnRfYmxvY2soJm5ibG9jay50cnlfcmVjb3ZlcigpLnVud3JhcCgpKS51bndyYXAoKTsKICAgICAgICB9CiAgICAgICAgcHJvdmlkZXJfcncKICAgICAgICAgICAgLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkKICAgICAgICAgICAgLmxhdGVzdF93cml0ZXIoU3RhdGljRmlsZVNlZ21lbnQ6OkhlYWRlcnMpCiAgICAgICAgICAgIC51bndyYXAoKQogICAgICAgICAgICAuY29tbWl0KCkKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyX3J3LmNvbW1pdCgpLnVud3JhcCgpOwoKICAgICAgICAvLyBpbnNlcnQgcHJlIHN0YXRlCiAgICAgICAgbGV0IHByb3ZpZGVyX3J3ID0gdGVzdF9kYi5mYWN0b3J5LnByb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgbGV0IGNvZGUgPSBoZXghKCI1YTQ2NWE5MDUwOTAwMzYwMDI5MDAzNjAwMTU1MDAiKTsKICAgICAgICBsZXQgY29kZV9oYXNoID0ga2VjY2FrMjU2KGhleCEoIjVhNDY1YTkwNTA5MDAzNjAwMjkwMDM2MDAxNTUwMCIpKTsKICAgICAgICBwcm92aWRlcl9ydwogICAgICAgICAgICAudHhfcmVmKCkKICAgICAgICAgICAgLnB1dDo6PHRhYmxlczo6UGxhaW5BY2NvdW50U3RhdGU+KAogICAgICAgICAgICAgICAgYWRkcmVzcyEoIjB4MTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCIpLAogICAgICAgICAgICAgICAgQWNjb3VudCB7IG5vbmNlOiAwLCBiYWxhbmNlOiBVMjU2OjpaRVJPLCBieXRlY29kZV9oYXNoOiBTb21lKGNvZGVfaGFzaCkgfSwKICAgICAgICAgICAgKQogICAgICAgICAgICAudW53cmFwKCk7CiAgICAgICAgcHJvdmlkZXJfcncKICAgICAgICAgICAgLnR4X3JlZigpCiAgICAgICAgICAgIC5wdXQ6Ojx0YWJsZXM6OlBsYWluQWNjb3VudFN0YXRlPigKICAgICAgICAgICAgICAgIGFkZHJlc3MhKCIweGE5NGY1Mzc0ZmNlNWVkYmM4ZTJhODY5N2MxNTMzMTY3N2U2ZWJmMGIiKSwKICAgICAgICAgICAgICAgIEFjY291bnQgewogICAgICAgICAgICAgICAgICAgIG5vbmNlOiAwLAogICAgICAgICAgICAgICAgICAgIGJhbGFuY2U6IFUyNTY6OmZyb20oMHgzNjM1YzlhZGM1ZGVhMDAwMDB1MTI4KSwKICAgICAgICAgICAgICAgICAgICBieXRlY29kZV9oYXNoOiBOb25lLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgKQogICAgICAgICAgICAudW53cmFwKCk7CiAgICAgICAgcHJvdmlkZXJfcncKICAgICAgICAgICAgLnR4X3JlZigpCiAgICAgICAgICAgIC5wdXQ6Ojx0YWJsZXM6OkJ5dGVjb2Rlcz4oY29kZV9oYXNoLCBCeXRlY29kZTo6bmV3X3Jhdyhjb2RlLnRvX3ZlYygpLmludG8oKSkpCiAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICBwcm92aWRlcl9ydy5jb21taXQoKS51bndyYXAoKTsKCiAgICAgICAgbGV0IGNoZWNrX3BydW5pbmcgPSB8ZmFjdG9yeTogUHJvdmlkZXJGYWN0b3J5PE1vY2tOb2RlVHlwZXNXaXRoREI+LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBydW5lX21vZGVzOiBQcnVuZU1vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdF9udW1fcmVjZWlwdHM6IHVzaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdF9udW1fYWNjX2NoYW5nZXNldHM6IHVzaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdF9udW1fc3RvcmFnZV9jaGFuZ2VzZXRzOiB1c2l6ZXwgYXN5bmMgbW92ZSB7CiAgICAgICAgICAgIGxldCBwcm92aWRlciA9IGZhY3RvcnkuZGF0YWJhc2VfcHJvdmlkZXJfcncoKS51bndyYXAoKTsKCiAgICAgICAgICAgIC8vIENoZWNrIGV4ZWN1dGlvbiBhbmQgY3JlYXRlIHJlY2VpcHRzIGFuZCBjaGFuZ2VzZXRzIGFjY29yZGluZyB0byB0aGUgcHJ1bmluZwogICAgICAgICAgICAvLyBjb25maWd1cmF0aW9uCiAgICAgICAgICAgIGxldCBtdXQgZXhlY3V0aW9uX3N0YWdlID0gRXhlY3V0aW9uU3RhZ2U6Om5ldygKICAgICAgICAgICAgICAgIEV0aEV2bUNvbmZpZzo6ZXRoZXJldW0oQXJjOjpuZXcoCiAgICAgICAgICAgICAgICAgICAgQ2hhaW5TcGVjQnVpbGRlcjo6bWFpbm5ldCgpLmJlcmxpbl9hY3RpdmF0ZWQoKS5idWlsZCgpLAogICAgICAgICAgICAgICAgKSksCiAgICAgICAgICAgICAgICBBcmM6Om5ldyhFdGhCZWFjb25Db25zZW5zdXM6Om5ldyhBcmM6Om5ldygKICAgICAgICAgICAgICAgICAgICBDaGFpblNwZWNCdWlsZGVyOjptYWlubmV0KCkuYmVybGluX2FjdGl2YXRlZCgpLmJ1aWxkKCksCiAgICAgICAgICAgICAgICApKSksCiAgICAgICAgICAgICAgICBFeGVjdXRpb25TdGFnZVRocmVzaG9sZHMgewogICAgICAgICAgICAgICAgICAgIG1heF9ibG9ja3M6IFNvbWUoMTAwKSwKICAgICAgICAgICAgICAgICAgICBtYXhfY2hhbmdlczogTm9uZSwKICAgICAgICAgICAgICAgICAgICBtYXhfY3VtdWxhdGl2ZV9nYXM6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgbWF4X2R1cmF0aW9uOiBOb25lLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIE1FUktMRV9TVEFHRV9ERUZBVUxUX1JFQlVJTERfVEhSRVNIT0xELAogICAgICAgICAgICAgICAgRXhFeE1hbmFnZXJIYW5kbGU6OmVtcHR5KCksCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBleGVjdXRpb25fc3RhZ2UuZXhlY3V0ZSgmcHJvdmlkZXIsIGlucHV0KS51bndyYXAoKTsKICAgICAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgICAgIHByb3ZpZGVyLnJlY2VpcHRzX2J5X2Jsb2NrKDEuaW50bygpKS51bndyYXAoKS51bndyYXAoKS5sZW4oKSwKICAgICAgICAgICAgICAgIGV4cGVjdF9udW1fcmVjZWlwdHMKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgICAgICBwcm92aWRlci5jaGFuZ2VkX3N0b3JhZ2VzX2FuZF9ibG9ja3Nfd2l0aF9yYW5nZSgwLi49MTAwMCkudW53cmFwKCkubGVuKCksCiAgICAgICAgICAgICAgICBleHBlY3RfbnVtX3N0b3JhZ2VfY2hhbmdlc2V0cwogICAgICAgICAgICApOwoKICAgICAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgICAgIHByb3ZpZGVyLmNoYW5nZWRfYWNjb3VudHNfYW5kX2Jsb2Nrc193aXRoX3JhbmdlKDAuLj0xMDAwKS51bndyYXAoKS5sZW4oKSwKICAgICAgICAgICAgICAgIGV4cGVjdF9udW1fYWNjX2NoYW5nZXNldHMKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIC8vIENoZWNrIEFjY291bnRIaXN0b3J5CiAgICAgICAgICAgIGxldCBtdXQgYWNjX2luZGV4aW5nX3N0YWdlID0gSW5kZXhBY2NvdW50SGlzdG9yeVN0YWdlIHsKICAgICAgICAgICAgICAgIHBydW5lX21vZGU6IHBydW5lX21vZGVzLmFjY291bnRfaGlzdG9yeSwKICAgICAgICAgICAgICAgIC4uRGVmYXVsdDo6ZGVmYXVsdCgpCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiBwcnVuZV9tb2Rlcy5hY2NvdW50X2hpc3RvcnkgPT0gU29tZShQcnVuZU1vZGU6OkZ1bGwpIHsKICAgICAgICAgICAgICAgIC8vIEZ1bGwgaXMgbm90IHN1cHBvcnRlZAogICAgICAgICAgICAgICAgYXNzZXJ0IShhY2NfaW5kZXhpbmdfc3RhZ2UuZXhlY3V0ZSgmcHJvdmlkZXIsIGlucHV0KS5pc19lcnIoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhY2NfaW5kZXhpbmdfc3RhZ2UuZXhlY3V0ZSgmcHJvdmlkZXIsIGlucHV0KS51bndyYXAoKTsKICAgICAgICAgICAgICAgIGxldCBtdXQgYWNjb3VudF9oaXN0b3J5OiBDdXJzb3I8UlcsIEFjY291bnRzSGlzdG9yeT4gPQogICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmN1cnNvcl9yZWFkOjo8dGFibGVzOjpBY2NvdW50c0hpc3Rvcnk+KCkudW53cmFwKCk7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKGFjY291bnRfaGlzdG9yeS53YWxrKE5vbmUpLnVud3JhcCgpLmNvdW50KCksIGV4cGVjdF9udW1fYWNjX2NoYW5nZXNldHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBTdG9yYWdlSGlzdG9yeQogICAgICAgICAgICBsZXQgbXV0IHN0b3JhZ2VfaW5kZXhpbmdfc3RhZ2UgPSBJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2UgewogICAgICAgICAgICAgICAgcHJ1bmVfbW9kZTogcHJ1bmVfbW9kZXMuc3RvcmFnZV9oaXN0b3J5LAogICAgICAgICAgICAgICAgLi5EZWZhdWx0OjpkZWZhdWx0KCkKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIHBydW5lX21vZGVzLnN0b3JhZ2VfaGlzdG9yeSA9PSBTb21lKFBydW5lTW9kZTo6RnVsbCkgewogICAgICAgICAgICAgICAgLy8gRnVsbCBpcyBub3Qgc3VwcG9ydGVkCiAgICAgICAgICAgICAgICBhc3NlcnQhKHN0b3JhZ2VfaW5kZXhpbmdfc3RhZ2UuZXhlY3V0ZSgmcHJvdmlkZXIsIGlucHV0KS5pc19lcnIoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdG9yYWdlX2luZGV4aW5nX3N0YWdlLmV4ZWN1dGUoJnByb3ZpZGVyLCBpbnB1dCkudW53cmFwKCk7CgogICAgICAgICAgICAgICAgbGV0IG11dCBzdG9yYWdlX2hpc3RvcnkgPQogICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmN1cnNvcl9yZWFkOjo8dGFibGVzOjpTdG9yYWdlc0hpc3Rvcnk+KCkudW53cmFwKCk7CiAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICAgICAgICAgIHN0b3JhZ2VfaGlzdG9yeS53YWxrKE5vbmUpLnVud3JhcCgpLmNvdW50KCksCiAgICAgICAgICAgICAgICAgICAgZXhwZWN0X251bV9zdG9yYWdlX2NoYW5nZXNldHMKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBJbiBhbiB1bnBydW5lZCBjb25maWd1cmF0aW9uIHRoZXJlIGlzIDEgcmVjZWlwdCwgMyBjaGFuZ2VkIGFjY291bnRzIGFuZCAxIGNoYW5nZWQKICAgICAgICAvLyBzdG9yYWdlLgogICAgICAgIGxldCBtdXQgcHJ1bmUgPSBQcnVuZU1vZGVzOjpkZWZhdWx0KCk7CiAgICAgICAgY2hlY2tfcHJ1bmluZyh0ZXN0X2RiLmZhY3RvcnkuY2xvbmUoKSwgcHJ1bmUuY2xvbmUoKSwgMSwgMywgMSkuYXdhaXQ7CgogICAgICAgIHBydW5lLnJlY2VpcHRzID0gU29tZShQcnVuZU1vZGU6OkZ1bGwpOwogICAgICAgIHBydW5lLmFjY291bnRfaGlzdG9yeSA9IFNvbWUoUHJ1bmVNb2RlOjpGdWxsKTsKICAgICAgICBwcnVuZS5zdG9yYWdlX2hpc3RvcnkgPSBTb21lKFBydW5lTW9kZTo6RnVsbCk7CiAgICAgICAgLy8gVGhpcyB3aWxsIHJlc3VsdCBpbiBlcnJvciBmb3IgYWNjb3VudF9oaXN0b3J5IGFuZCBzdG9yYWdlX2hpc3RvcnksIHdoaWNoIGlzIGNhdWdodC4KICAgICAgICBjaGVja19wcnVuaW5nKHRlc3RfZGIuZmFjdG9yeS5jbG9uZSgpLCBwcnVuZS5jbG9uZSgpLCAwLCAwLCAwKS5hd2FpdDsKCiAgICAgICAgcHJ1bmUucmVjZWlwdHMgPSBTb21lKFBydW5lTW9kZTo6QmVmb3JlKDEpKTsKICAgICAgICBwcnVuZS5hY2NvdW50X2hpc3RvcnkgPSBTb21lKFBydW5lTW9kZTo6QmVmb3JlKDEpKTsKICAgICAgICBwcnVuZS5zdG9yYWdlX2hpc3RvcnkgPSBTb21lKFBydW5lTW9kZTo6QmVmb3JlKDEpKTsKICAgICAgICBjaGVja19wcnVuaW5nKHRlc3RfZGIuZmFjdG9yeS5jbG9uZSgpLCBwcnVuZS5jbG9uZSgpLCAxLCAzLCAxKS5hd2FpdDsKCiAgICAgICAgcHJ1bmUucmVjZWlwdHMgPSBTb21lKFBydW5lTW9kZTo6QmVmb3JlKDIpKTsKICAgICAgICBwcnVuZS5hY2NvdW50X2hpc3RvcnkgPSBTb21lKFBydW5lTW9kZTo6QmVmb3JlKDIpKTsKICAgICAgICBwcnVuZS5zdG9yYWdlX2hpc3RvcnkgPSBTb21lKFBydW5lTW9kZTo6QmVmb3JlKDIpKTsKICAgICAgICAvLyBUaGUgb25lIGFjY291bnQgaXMgdGhlIG1pbmVyCiAgICAgICAgY2hlY2tfcHJ1bmluZyh0ZXN0X2RiLmZhY3RvcnkuY2xvbmUoKSwgcHJ1bmUuY2xvbmUoKSwgMCwgMSwgMCkuYXdhaXQ7CgogICAgICAgIHBydW5lLnJlY2VpcHRzID0gU29tZShQcnVuZU1vZGU6OkRpc3RhbmNlKDY2KSk7CiAgICAgICAgcHJ1bmUuYWNjb3VudF9oaXN0b3J5ID0gU29tZShQcnVuZU1vZGU6OkRpc3RhbmNlKDY2KSk7CiAgICAgICAgcHJ1bmUuc3RvcmFnZV9oaXN0b3J5ID0gU29tZShQcnVuZU1vZGU6OkRpc3RhbmNlKDY2KSk7CiAgICAgICAgY2hlY2tfcHJ1bmluZyh0ZXN0X2RiLmZhY3RvcnkuY2xvbmUoKSwgcHJ1bmUuY2xvbmUoKSwgMSwgMywgMSkuYXdhaXQ7CgogICAgICAgIHBydW5lLnJlY2VpcHRzID0gU29tZShQcnVuZU1vZGU6OkRpc3RhbmNlKDY0KSk7CiAgICAgICAgcHJ1bmUuYWNjb3VudF9oaXN0b3J5ID0gU29tZShQcnVuZU1vZGU6OkRpc3RhbmNlKDY0KSk7CiAgICAgICAgcHJ1bmUuc3RvcmFnZV9oaXN0b3J5ID0gU29tZShQcnVuZU1vZGU6OkRpc3RhbmNlKDY0KSk7CiAgICAgICAgLy8gVGhlIG9uZSBhY2NvdW50IGlzIHRoZSBtaW5lcgogICAgICAgIGNoZWNrX3BydW5pbmcodGVzdF9kYi5mYWN0b3J5LmNsb25lKCksIHBydW5lLmNsb25lKCksIDAsIDEsIDApLmF3YWl0OwogICAgfQoKICAgIC8vLyBJdCB3aWxsIGdlbmVyYXRlIGBudW1fYmxvY2tzYCwgcHVzaCB0aGVtIHRvIHN0YXRpYyBmaWxlcyBhbmQgc2V0IGFsbCBzdGFnZSBjaGVja3BvaW50cyB0bwogICAgLy8vIGBudW1fYmxvY2tzIC0gMWAuCiAgICBmbiBzZWVkX2RhdGEobnVtX2Jsb2NrczogdXNpemUpIC0+IFByb3ZpZGVyUmVzdWx0PFRlc3RTdGFnZURCPiB7CiAgICAgICAgbGV0IGRiID0gVGVzdFN0YWdlREI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwogICAgICAgIGxldCBnZW5lc2lzX2hhc2ggPSBCMjU2OjpaRVJPOwogICAgICAgIGxldCB0aXAgPSAobnVtX2Jsb2NrcyAtIDEpIGFzIHU2NDsKCiAgICAgICAgbGV0IGJsb2NrcyA9IHJhbmRvbV9ibG9ja19yYW5nZSgKICAgICAgICAgICAgJm11dCBybmcsCiAgICAgICAgICAgIDAuLj10aXAsCiAgICAgICAgICAgIEJsb2NrUmFuZ2VQYXJhbXMgeyBwYXJlbnQ6IFNvbWUoZ2VuZXNpc19oYXNoKSwgdHhfY291bnQ6IDIuLjMsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgKTsKICAgICAgICBkYi5pbnNlcnRfYmxvY2tzKGJsb2Nrcy5pdGVyKCksIFN0b3JhZ2VLaW5kOjpTdGF0aWMpPzsKCiAgICAgICAgbGV0IG11dCByZWNlaXB0cyA9IFZlYzo6d2l0aF9jYXBhY2l0eShibG9ja3MubGVuKCkpOwogICAgICAgIGxldCBtdXQgdHhfbnVtID0gMHU2NDsKICAgICAgICBmb3IgYmxvY2sgaW4gJmJsb2NrcyB7CiAgICAgICAgICAgIGxldCBtdXQgYmxvY2tfcmVjZWlwdHMgPSBWZWM6OndpdGhfY2FwYWNpdHkoYmxvY2sudHJhbnNhY3Rpb25fY291bnQoKSk7CiAgICAgICAgICAgIGZvciB0cmFuc2FjdGlvbiBpbiAmYmxvY2suYm9keSgpLnRyYW5zYWN0aW9ucyB7CiAgICAgICAgICAgICAgICBibG9ja19yZWNlaXB0cy5wdXNoKCh0eF9udW0sIHJhbmRvbV9yZWNlaXB0KCZtdXQgcm5nLCB0cmFuc2FjdGlvbiwgU29tZSgwKSwgTm9uZSkpKTsKICAgICAgICAgICAgICAgIHR4X251bSArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlY2VpcHRzLnB1c2goKGJsb2NrLm51bWJlciwgYmxvY2tfcmVjZWlwdHMpKTsKICAgICAgICB9CiAgICAgICAgZGIuaW5zZXJ0X3JlY2VpcHRzX2J5X2Jsb2NrKHJlY2VpcHRzLCBTdG9yYWdlS2luZDo6U3RhdGljKT87CgogICAgICAgIC8vIHNpbXVsYXRlIHBpcGVsaW5lIGJ5IHNldHRpbmcgYWxsIGNoZWNrcG9pbnRzIHRvIGluc2VydGVkIGhlaWdodC4KICAgICAgICBsZXQgcHJvdmlkZXJfcncgPSBkYi5mYWN0b3J5LnByb3ZpZGVyX3J3KCk/OwogICAgICAgIGZvciBzdGFnZSBpbiBTdGFnZUlkOjpBTEwgewogICAgICAgICAgICBwcm92aWRlcl9ydy5zYXZlX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2UsIFN0YWdlQ2hlY2twb2ludDo6bmV3KHRpcCkpPzsKICAgICAgICB9CiAgICAgICAgcHJvdmlkZXJfcncuY29tbWl0KCk/OwoKICAgICAgICBPayhkYikKICAgIH0KCiAgICAvLy8gU2ltdWxhdGVzIGxvc2luZyBkYXRhIHRvIGNvcnJ1cHRpb24gYW5kIGNvbXBhcmUgdGhlIGNoZWNrIGNvbnNpc3RlbmN5IHJlc3VsdAogICAgLy8vIGFnYWluc3QgdGhlIGV4cGVjdGVkIG9uZS4KICAgIGZuIHNpbXVsYXRlX2JlaGluZF9jaGVja3BvaW50X2NvcnJ1cHRpb24oCiAgICAgICAgZGI6ICZUZXN0U3RhZ2VEQiwKICAgICAgICBwcnVuZV9jb3VudDogdXNpemUsCiAgICAgICAgc2VnbWVudDogU3RhdGljRmlsZVNlZ21lbnQsCiAgICAgICAgZXhwZWN0ZWQ6IE9wdGlvbjxQaXBlbGluZVRhcmdldD4sCiAgICApIHsKICAgICAgICAvLyBXZSByZWNyZWF0ZSB0aGUgc3RhdGljIGZpbGUgcHJvdmlkZXIsIHNpbmNlIGNvbnNpc3RlbmN5IGhlYWxzIGFyZSBkb25lIG9uIGZldGNoaW5nIHRoZQogICAgICAgIC8vIHdyaXRlciBmb3IgdGhlIGZpcnN0IHRpbWUuCiAgICAgICAgbGV0IG11dCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IGRiLmZhY3Rvcnkuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKTsKICAgICAgICBzdGF0aWNfZmlsZV9wcm92aWRlciA9IFN0YXRpY0ZpbGVQcm92aWRlcjo6cmVhZF93cml0ZShzdGF0aWNfZmlsZV9wcm92aWRlci5wYXRoKCkpLnVud3JhcCgpOwoKICAgICAgICAvLyBTaW11bGF0ZSBjb3JydXB0aW9uIGJ5IHJlbW92aW5nIGBwcnVuZV9jb3VudGAgcm93cyBmcm9tIHRoZSBkYXRhIGZpbGUgd2l0aG91dCB1cGRhdGluZwogICAgICAgIC8vIGl0cyBvZmZzZXQgbGlzdCBhbmQgY29uZmlndXJhdGlvbi4KICAgICAgICB7CiAgICAgICAgICAgIGxldCBtdXQgaGVhZGVyc193cml0ZXIgPSBzdGF0aWNfZmlsZV9wcm92aWRlci5sYXRlc3Rfd3JpdGVyKHNlZ21lbnQpLnVud3JhcCgpOwogICAgICAgICAgICBsZXQgcmVhZGVyID0gaGVhZGVyc193cml0ZXIuaW5uZXIoKS5qYXIoKS5vcGVuX2RhdGFfcmVhZGVyKCkudW53cmFwKCk7CiAgICAgICAgICAgIGxldCBjb2x1bW5zID0gaGVhZGVyc193cml0ZXIuaW5uZXIoKS5qYXIoKS5jb2x1bW5zKCk7CiAgICAgICAgICAgIGxldCBkYXRhX2ZpbGUgPSBoZWFkZXJzX3dyaXRlci5pbm5lcigpLmRhdGFfZmlsZSgpOwogICAgICAgICAgICBsZXQgbGFzdF9vZmZzZXQgPSByZWFkZXIucmV2ZXJzZV9vZmZzZXQocHJ1bmVfY291bnQgKiBjb2x1bW5zKS51bndyYXAoKTsKICAgICAgICAgICAgZGF0YV9maWxlLmdldF9tdXQoKS5zZXRfbGVuKGxhc3Rfb2Zmc2V0KS51bndyYXAoKTsKICAgICAgICAgICAgZGF0YV9maWxlLmZsdXNoKCkudW53cmFwKCk7CiAgICAgICAgICAgIGRhdGFfZmlsZS5nZXRfcmVmKCkuc3luY19hbGwoKS51bndyYXAoKTsKICAgICAgICB9CgogICAgICAgIC8vIFdlIHJlY3JlYXRlIHRoZSBzdGF0aWMgZmlsZSBwcm92aWRlciwgc2luY2UgY29uc2lzdGVuY3kgaGVhbHMgYXJlIGRvbmUgb24gZmV0Y2hpbmcgdGhlCiAgICAgICAgLy8gd3JpdGVyIGZvciB0aGUgZmlyc3QgdGltZS4KICAgICAgICBsZXQgbXV0IHN0YXRpY19maWxlX3Byb3ZpZGVyID0gZGIuZmFjdG9yeS5zdGF0aWNfZmlsZV9wcm92aWRlcigpOwogICAgICAgIHN0YXRpY19maWxlX3Byb3ZpZGVyID0gU3RhdGljRmlsZVByb3ZpZGVyOjpyZWFkX3dyaXRlKHN0YXRpY19maWxlX3Byb3ZpZGVyLnBhdGgoKSkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0IShtYXRjaGVzISgKICAgICAgICAgICAgc3RhdGljX2ZpbGVfcHJvdmlkZXIKICAgICAgICAgICAgICAgIC5jaGVja19jb25zaXN0ZW5jeSgmZGIuZmFjdG9yeS5kYXRhYmFzZV9wcm92aWRlcl9ybygpLnVud3JhcCgpKSwKICAgICAgICAgICAgT2soZSkgaWYgZSA9PSBleHBlY3RlZAogICAgICAgICkpOwogICAgfQoKICAgIC8vLyBTYXZlcyBhIGNoZWNrcG9pbnQgd2l0aCBgY2hlY2twb2ludF9ibG9ja19udW1iZXJgIGFuZCBjb21wYXJlIHRoZSBjaGVjayBjb25zaXN0ZW5jeSByZXN1bHQKICAgIC8vLyBhZ2FpbnN0IHRoZSBleHBlY3RlZCBvbmUuCiAgICBmbiBzYXZlX2NoZWNrcG9pbnRfYW5kX2NoZWNrKAogICAgICAgIGRiOiAmVGVzdFN0YWdlREIsCiAgICAgICAgc3RhZ2VfaWQ6IFN0YWdlSWQsCiAgICAgICAgY2hlY2twb2ludF9ibG9ja19udW1iZXI6IEJsb2NrTnVtYmVyLAogICAgICAgIGV4cGVjdGVkOiBPcHRpb248UGlwZWxpbmVUYXJnZXQ+LAogICAgKSB7CiAgICAgICAgbGV0IHByb3ZpZGVyX3J3ID0gZGIuZmFjdG9yeS5wcm92aWRlcl9ydygpLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyX3J3CiAgICAgICAgICAgIC5zYXZlX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfaWQsIFN0YWdlQ2hlY2twb2ludDo6bmV3KGNoZWNrcG9pbnRfYmxvY2tfbnVtYmVyKSkKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyX3J3LmNvbW1pdCgpLnVud3JhcCgpOwoKICAgICAgICBhc3NlcnQhKG1hdGNoZXMhKAogICAgICAgICAgICBkYi5mYWN0b3J5CiAgICAgICAgICAgICAgICAuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKQogICAgICAgICAgICAgICAgLmNoZWNrX2NvbnNpc3RlbmN5KCZkYi5mYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3JvKCkudW53cmFwKCksKSwKICAgICAgICAgICAgT2soZSkgaWYgZSA9PSBleHBlY3RlZAogICAgICAgICkpOwogICAgfQoKICAgIC8vLyBJbnNlcnRzIGEgZHVtbXkgdmFsdWUgYXQga2V5IGFuZCBjb21wYXJlIHRoZSBjaGVjayBjb25zaXN0ZW5jeSByZXN1bHQgYWdhaW5zdCB0aGUgZXhwZWN0ZWQKICAgIC8vLyBvbmUuCiAgICBmbiB1cGRhdGVfZGJfYW5kX2NoZWNrPFQ6IFRhYmxlPEtleSA9IHU2ND4+KAogICAgICAgIGRiOiAmVGVzdFN0YWdlREIsCiAgICAgICAga2V5OiB1NjQsCiAgICAgICAgZXhwZWN0ZWQ6IE9wdGlvbjxQaXBlbGluZVRhcmdldD4sCiAgICApIHdoZXJlCiAgICAgICAgPFQgYXMgVGFibGU+OjpWYWx1ZTogRGVmYXVsdCwKICAgIHsKICAgICAgICB1cGRhdGVfZGJfd2l0aF9hbmRfY2hlY2s6OjxUPihkYiwga2V5LCBleHBlY3RlZCwgJkRlZmF1bHQ6OmRlZmF1bHQoKSk7CiAgICB9CgogICAgLy8vIEluc2VydHMgdGhlIGdpdmVuIHZhbHVlIGF0IGtleSBhbmQgY29tcGFyZSB0aGUgY2hlY2sgY29uc2lzdGVuY3kgcmVzdWx0IGFnYWluc3QgdGhlIGV4cGVjdGVkCiAgICAvLy8gb25lLgogICAgZm4gdXBkYXRlX2RiX3dpdGhfYW5kX2NoZWNrPFQ6IFRhYmxlPEtleSA9IHU2ND4+KAogICAgICAgIGRiOiAmVGVzdFN0YWdlREIsCiAgICAgICAga2V5OiB1NjQsCiAgICAgICAgZXhwZWN0ZWQ6IE9wdGlvbjxQaXBlbGluZVRhcmdldD4sCiAgICAgICAgdmFsdWU6ICZUOjpWYWx1ZSwKICAgICkgewogICAgICAgIGxldCBwcm92aWRlcl9ydyA9IGRiLmZhY3RvcnkucHJvdmlkZXJfcncoKS51bndyYXAoKTsKICAgICAgICBsZXQgbXV0IGN1cnNvciA9IHByb3ZpZGVyX3J3LnR4X3JlZigpLmN1cnNvcl93cml0ZTo6PFQ+KCkudW53cmFwKCk7CiAgICAgICAgY3Vyc29yLmluc2VydChrZXksIHZhbHVlKS51bndyYXAoKTsKICAgICAgICBwcm92aWRlcl9ydy5jb21taXQoKS51bndyYXAoKTsKCiAgICAgICAgYXNzZXJ0IShtYXRjaGVzISgKICAgICAgICAgICAgZGIuZmFjdG9yeQogICAgICAgICAgICAgICAgLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkKICAgICAgICAgICAgICAgIC5jaGVja19jb25zaXN0ZW5jeSgmZGIuZmFjdG9yeS5kYXRhYmFzZV9wcm92aWRlcl9ybygpLnVud3JhcCgpKSwKICAgICAgICAgICAgT2soZSkgaWYgZSA9PSBleHBlY3RlZAogICAgICAgICkpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfY29uc2lzdGVuY3koKSB7CiAgICAgICAgbGV0IGRiID0gc2VlZF9kYXRhKDkwKS51bndyYXAoKTsKICAgICAgICBsZXQgZGJfcHJvdmlkZXIgPSBkYi5mYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3JvKCkudW53cmFwKCk7CgogICAgICAgIGFzc2VydCEobWF0Y2hlcyEoCiAgICAgICAgICAgIGRiLmZhY3Rvcnkuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKS5jaGVja19jb25zaXN0ZW5jeSgmZGJfcHJvdmlkZXIpLAogICAgICAgICAgICBPayhOb25lKQogICAgICAgICkpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfY29uc2lzdGVuY3lfbm9fY29tbWl0X3BydW5lKCkgewogICAgICAgIC8vIFRlc3QgZnVsbCBub2RlIHdpdGggcmVjZWlwdCBwcnVuaW5nCiAgICAgICAgbGV0IG11dCBkYl9mdWxsID0gc2VlZF9kYXRhKDkwKS51bndyYXAoKTsKICAgICAgICBkYl9mdWxsLmZhY3RvcnkgPSBkYl9mdWxsLmZhY3Rvcnkud2l0aF9wcnVuZV9tb2RlcyhQcnVuZU1vZGVzIHsKICAgICAgICAgICAgcmVjZWlwdHM6IFNvbWUoUHJ1bmVNb2RlOjpCZWZvcmUoMSkpLAogICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgIH0pOwoKICAgICAgICAvLyBGdWxsIG5vZGUgZG9lcyBub3QgdXNlIHJlY2VpcHRzLCB0aGVyZWZvcmUgZG9lc24ndCBjaGVjayBmb3IgY29uc2lzdGVuY3kgb24gcmVjZWlwdHMKICAgICAgICAvLyBzZWdtZW50CiAgICAgICAgc2ltdWxhdGVfYmVoaW5kX2NoZWNrcG9pbnRfY29ycnVwdGlvbigmZGJfZnVsbCwgMSwgU3RhdGljRmlsZVNlZ21lbnQ6OlJlY2VpcHRzLCBOb25lKTsKCiAgICAgICAgLy8gVGVzdCBhcmNoaXZlIG5vZGUgd2l0aG91dCByZWNlaXB0IHBydW5pbmcKICAgICAgICBsZXQgZGJfYXJjaGl2ZSA9IHNlZWRfZGF0YSg5MCkudW53cmFwKCk7CgogICAgICAgIC8vIHRoZXJlIGFyZSAyIHRvIDMgdHJhbnNhY3Rpb25zIHBlciBibG9jay4gaG93ZXZlciwgaWYgd2UgbG9zZSBvbmUgdHgsIHdlIG5lZWQgdG8gdW53aW5kIHRvCiAgICAgICAgLy8gdGhlIHByZXZpb3VzIGJsb2NrLgogICAgICAgIHNpbXVsYXRlX2JlaGluZF9jaGVja3BvaW50X2NvcnJ1cHRpb24oCiAgICAgICAgICAgICZkYl9hcmNoaXZlLAogICAgICAgICAgICAxLAogICAgICAgICAgICBTdGF0aWNGaWxlU2VnbWVudDo6UmVjZWlwdHMsCiAgICAgICAgICAgIFNvbWUoUGlwZWxpbmVUYXJnZXQ6OlVud2luZCg4OCkpLAogICAgICAgICk7CgogICAgICAgIHNpbXVsYXRlX2JlaGluZF9jaGVja3BvaW50X2NvcnJ1cHRpb24oCiAgICAgICAgICAgICZkYl9hcmNoaXZlLAogICAgICAgICAgICAzLAogICAgICAgICAgICBTdGF0aWNGaWxlU2VnbWVudDo6SGVhZGVycywKICAgICAgICAgICAgU29tZShQaXBlbGluZVRhcmdldDo6VW53aW5kKDg2KSksCiAgICAgICAgKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2NvbnNpc3RlbmN5X2NoZWNrcG9pbnRzKCkgewogICAgICAgIGxldCBkYiA9IHNlZWRfZGF0YSg5MCkudW53cmFwKCk7CgogICAgICAgIC8vIFdoZW4gYSBjaGVja3BvaW50IGlzIGJlaGluZCwgd2UgZGVsZXRlIGRhdGEgZnJvbSBzdGF0aWMgZmlsZXMuCiAgICAgICAgbGV0IGJsb2NrID0gODc7CiAgICAgICAgc2F2ZV9jaGVja3BvaW50X2FuZF9jaGVjaygmZGIsIFN0YWdlSWQ6OkJvZGllcywgYmxvY2ssIE5vbmUpOwogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGRiLmZhY3RvcnkKICAgICAgICAgICAgICAgIC5zdGF0aWNfZmlsZV9wcm92aWRlcigpCiAgICAgICAgICAgICAgICAuZ2V0X2hpZ2hlc3Rfc3RhdGljX2ZpbGVfYmxvY2soU3RhdGljRmlsZVNlZ21lbnQ6OlRyYW5zYWN0aW9ucyksCiAgICAgICAgICAgIFNvbWUoYmxvY2spCiAgICAgICAgKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBkYi5mYWN0b3J5CiAgICAgICAgICAgICAgICAuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKQogICAgICAgICAgICAgICAgLmdldF9oaWdoZXN0X3N0YXRpY19maWxlX3R4KFN0YXRpY0ZpbGVTZWdtZW50OjpUcmFuc2FjdGlvbnMpLAogICAgICAgICAgICBkYi5mYWN0b3J5LmJsb2NrX2JvZHlfaW5kaWNlcyhibG9jaykudW53cmFwKCkubWFwKHxifCBiLmxhc3RfdHhfbnVtKCkpCiAgICAgICAgKTsKCiAgICAgICAgbGV0IGJsb2NrID0gODY7CiAgICAgICAgc2F2ZV9jaGVja3BvaW50X2FuZF9jaGVjaygmZGIsIFN0YWdlSWQ6OkV4ZWN1dGlvbiwgYmxvY2ssIE5vbmUpOwogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGRiLmZhY3RvcnkKICAgICAgICAgICAgICAgIC5zdGF0aWNfZmlsZV9wcm92aWRlcigpCiAgICAgICAgICAgICAgICAuZ2V0X2hpZ2hlc3Rfc3RhdGljX2ZpbGVfYmxvY2soU3RhdGljRmlsZVNlZ21lbnQ6OlJlY2VpcHRzKSwKICAgICAgICAgICAgU29tZShibG9jaykKICAgICAgICApOwogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGRiLmZhY3RvcnkKICAgICAgICAgICAgICAgIC5zdGF0aWNfZmlsZV9wcm92aWRlcigpCiAgICAgICAgICAgICAgICAuZ2V0X2hpZ2hlc3Rfc3RhdGljX2ZpbGVfdHgoU3RhdGljRmlsZVNlZ21lbnQ6OlJlY2VpcHRzKSwKICAgICAgICAgICAgZGIuZmFjdG9yeS5ibG9ja19ib2R5X2luZGljZXMoYmxvY2spLnVud3JhcCgpLm1hcCh8YnwgYi5sYXN0X3R4X251bSgpKQogICAgICAgICk7CgogICAgICAgIGxldCBibG9jayA9IDgwOwogICAgICAgIHNhdmVfY2hlY2twb2ludF9hbmRfY2hlY2soJmRiLCBTdGFnZUlkOjpIZWFkZXJzLCBibG9jaywgTm9uZSk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgZGIuZmFjdG9yeQogICAgICAgICAgICAgICAgLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkKICAgICAgICAgICAgICAgIC5nZXRfaGlnaGVzdF9zdGF0aWNfZmlsZV9ibG9jayhTdGF0aWNGaWxlU2VnbWVudDo6SGVhZGVycyksCiAgICAgICAgICAgIFNvbWUoYmxvY2spCiAgICAgICAgKTsKCiAgICAgICAgLy8gV2hlbiBhIGNoZWNrcG9pbnQgaXMgYWhlYWQsIHdlIHJlcXVlc3QgYSBwaXBlbGluZSB1bndpbmQuCiAgICAgICAgc2F2ZV9jaGVja3BvaW50X2FuZF9jaGVjaygmZGIsIFN0YWdlSWQ6OkhlYWRlcnMsIDkxLCBTb21lKFBpcGVsaW5lVGFyZ2V0OjpVbndpbmQoYmxvY2spKSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9jb25zaXN0ZW5jeV9oZWFkZXJzX2dhcCgpIHsKICAgICAgICBsZXQgZGIgPSBzZWVkX2RhdGEoOTApLnVud3JhcCgpOwogICAgICAgIGxldCBjdXJyZW50ID0gZGIKICAgICAgICAgICAgLmZhY3RvcnkKICAgICAgICAgICAgLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkKICAgICAgICAgICAgLmdldF9oaWdoZXN0X3N0YXRpY19maWxlX2Jsb2NrKFN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKQogICAgICAgICAgICAudW53cmFwKCk7CgogICAgICAgIC8vIENyZWF0ZXMgYSBnYXAgb2Ygb25lIGhlYWRlcjogc3RhdGljX2ZpbGUgPG1pc3Npbmc+IGRiCiAgICAgICAgdXBkYXRlX2RiX2FuZF9jaGVjazo6PHRhYmxlczo6SGVhZGVycz4oJmRiLCBjdXJyZW50ICsgMiwgU29tZShQaXBlbGluZVRhcmdldDo6VW53aW5kKDg5KSkpOwoKICAgICAgICAvLyBGaWxsIHRoZSBnYXAsIGFuZCBlbnN1cmUgbm8gdW53aW5kIGlzIG5lY2Vzc2FyeS4KICAgICAgICB1cGRhdGVfZGJfYW5kX2NoZWNrOjo8dGFibGVzOjpIZWFkZXJzPigmZGIsIGN1cnJlbnQgKyAxLCBOb25lKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2NvbnNpc3RlbmN5X3R4X2dhcCgpIHsKICAgICAgICBsZXQgZGIgPSBzZWVkX2RhdGEoOTApLnVud3JhcCgpOwogICAgICAgIGxldCBjdXJyZW50ID0gZGIKICAgICAgICAgICAgLmZhY3RvcnkKICAgICAgICAgICAgLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkKICAgICAgICAgICAgLmdldF9oaWdoZXN0X3N0YXRpY19maWxlX3R4KFN0YXRpY0ZpbGVTZWdtZW50OjpUcmFuc2FjdGlvbnMpCiAgICAgICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgLy8gQ3JlYXRlcyBhIGdhcCBvZiBvbmUgdHJhbnNhY3Rpb246IHN0YXRpY19maWxlIDxtaXNzaW5nPiBkYgogICAgICAgIHVwZGF0ZV9kYl93aXRoX2FuZF9jaGVjazo6PHRhYmxlczo6VHJhbnNhY3Rpb25zPigKICAgICAgICAgICAgJmRiLAogICAgICAgICAgICBjdXJyZW50ICsgMiwKICAgICAgICAgICAgU29tZShQaXBlbGluZVRhcmdldDo6VW53aW5kKDg5KSksCiAgICAgICAgICAgICZUeExlZ2FjeTo6ZGVmYXVsdCgpLmludG9fc2lnbmVkKFNpZ25hdHVyZTo6dGVzdF9zaWduYXR1cmUoKSkuaW50bygpLAogICAgICAgICk7CgogICAgICAgIC8vIEZpbGwgdGhlIGdhcCwgYW5kIGVuc3VyZSBubyB1bndpbmQgaXMgbmVjZXNzYXJ5LgogICAgICAgIHVwZGF0ZV9kYl93aXRoX2FuZF9jaGVjazo6PHRhYmxlczo6VHJhbnNhY3Rpb25zPigKICAgICAgICAgICAgJmRiLAogICAgICAgICAgICBjdXJyZW50ICsgMSwKICAgICAgICAgICAgTm9uZSwKICAgICAgICAgICAgJlR4TGVnYWN5OjpkZWZhdWx0KCkuaW50b19zaWduZWQoU2lnbmF0dXJlOjp0ZXN0X3NpZ25hdHVyZSgpKS5pbnRvKCksCiAgICAgICAgKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2NvbnNpc3RlbmN5X3JlY2VpcHRfZ2FwKCkgewogICAgICAgIGxldCBkYiA9IHNlZWRfZGF0YSg5MCkudW53cmFwKCk7CiAgICAgICAgbGV0IGN1cnJlbnQgPSBkYgogICAgICAgICAgICAuZmFjdG9yeQogICAgICAgICAgICAuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKQogICAgICAgICAgICAuZ2V0X2hpZ2hlc3Rfc3RhdGljX2ZpbGVfdHgoU3RhdGljRmlsZVNlZ21lbnQ6OlJlY2VpcHRzKQogICAgICAgICAgICAudW53cmFwKCk7CgogICAgICAgIC8vIENyZWF0ZXMgYSBnYXAgb2Ygb25lIHJlY2VpcHQ6IHN0YXRpY19maWxlIDxtaXNzaW5nPiBkYgogICAgICAgIHVwZGF0ZV9kYl9hbmRfY2hlY2s6Ojx0YWJsZXM6OlJlY2VpcHRzPigmZGIsIGN1cnJlbnQgKyAyLCBTb21lKFBpcGVsaW5lVGFyZ2V0OjpVbndpbmQoODkpKSk7CgogICAgICAgIC8vIEZpbGwgdGhlIGdhcCwgYW5kIGVuc3VyZSBubyB1bndpbmQgaXMgbmVjZXNzYXJ5LgogICAgICAgIHVwZGF0ZV9kYl9hbmRfY2hlY2s6Ojx0YWJsZXM6OlJlY2VpcHRzPigmZGIsIGN1cnJlbnQgKyAxLCBOb25lKTsKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvc3RhZ2VzL3N0YWdlcy9zcmMvc2V0cy5ycyI+Ci8vISBCdWlsdC1pbiBbYFN0YWdlU2V0YF1zLgovLyEKLy8hIFRoZSBlYXNpZXN0IHNldCB0byB1c2UgaXMgW2BEZWZhdWx0U3RhZ2VzYF0sIHdoaWNoIHByb3ZpZGVzIGFsbCBzdGFnZXMgcmVxdWlyZWQgdG8gcnVuIGFuCi8vISBpbnN0YW5jZSBvZiByZXRoLgovLyEKLy8hIEl0IGlzIGFsc28gcG9zc2libGUgdG8gcnVuIHBhcnRzIG9mIHJldGggc3RhbmRhbG9uZSBnaXZlbiB0aGUgcmVxdWlyZWQgZGF0YSBpcyBwcmVzZW50IGluCi8vISB0aGUgZW52aXJvbm1lbnQsIHN1Y2ggYXMgW2BFeGVjdXRpb25TdGFnZXNgXSBvciBbYEhhc2hpbmdTdGFnZXNgXS4KLy8hCi8vIQovLyEgIyBFeGFtcGxlcwovLyEKLy8hIGBgYG5vX3J1bgovLyEgIyB1c2UgcmV0aF9zdGFnZXM6OlBpcGVsaW5lOwovLyEgIyB1c2UgcmV0aF9zdGFnZXM6OnNldHM6OntPZmZsaW5lU3RhZ2VzfTsKLy8hICMgdXNlIHJldGhfY2hhaW5zcGVjOjpNQUlOTkVUOwovLyEgIyB1c2UgcmV0aF9wcnVuZV90eXBlczo6UHJ1bmVNb2RlczsKLy8hICMgdXNlIHJldGhfZXZtX2V0aGVyZXVtOjpFdGhFdm1Db25maWc7Ci8vISAjIHVzZSByZXRoX2V2bTo6Q29uZmlndXJlRXZtOwovLyEgIyB1c2UgcmV0aF9wcm92aWRlcjo6U3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeTsKLy8hICMgdXNlIHJldGhfcHJvdmlkZXI6OnRlc3RfdXRpbHM6OntjcmVhdGVfdGVzdF9wcm92aWRlcl9mYWN0b3J5LCBNb2NrTm9kZVR5cGVzV2l0aERCfTsKLy8hICMgdXNlIHJldGhfc3RhdGljX2ZpbGU6OlN0YXRpY0ZpbGVQcm9kdWNlcjsKLy8hICMgdXNlIHJldGhfY29uZmlnOjpjb25maWc6OlN0YWdlQ29uZmlnOwovLyEgIyB1c2UgcmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpFdGhQcmltaXRpdmVzOwovLyEgIyB1c2Ugc3RkOjpzeW5jOjpBcmM7Ci8vISAjIHVzZSByZXRoX2NvbnNlbnN1czo6RnVsbENvbnNlbnN1czsKLy8hCi8vISAjIGZuIGNyZWF0ZShleGVjOiBpbXBsIENvbmZpZ3VyZUV2bTxQcmltaXRpdmVzID0gRXRoUHJpbWl0aXZlcz4gKyAnc3RhdGljLCBjb25zZW5zdXM6IGltcGwgRnVsbENvbnNlbnN1czxFdGhQcmltaXRpdmVzPiArICdzdGF0aWMpIHsKLy8hCi8vISBsZXQgcHJvdmlkZXJfZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKLy8hIGxldCBzdGF0aWNfZmlsZV9wcm9kdWNlciA9Ci8vISAgICAgU3RhdGljRmlsZVByb2R1Y2VyOjpuZXcocHJvdmlkZXJfZmFjdG9yeS5jbG9uZSgpLCBQcnVuZU1vZGVzOjpkZWZhdWx0KCkpOwovLyEgLy8gQnVpbGQgYSBwaXBlbGluZSB3aXRoIGFsbCBvZmZsaW5lIHN0YWdlcy4KLy8hIGxldCBwaXBlbGluZSA9IFBpcGVsaW5lOjo8TW9ja05vZGVUeXBlc1dpdGhEQj46OmJ1aWxkZXIoKQovLyEgICAgIC5hZGRfc3RhZ2VzKE9mZmxpbmVTdGFnZXM6Om5ldyhleGVjLCBBcmM6Om5ldyhjb25zZW5zdXMpLCBTdGFnZUNvbmZpZzo6ZGVmYXVsdCgpLCBQcnVuZU1vZGVzOjpkZWZhdWx0KCkpKQovLyEgICAgIC5idWlsZChwcm92aWRlcl9mYWN0b3J5LCBzdGF0aWNfZmlsZV9wcm9kdWNlcik7Ci8vIQovLyEgIyB9Ci8vISBgYGAKdXNlIGNyYXRlOjp7CiAgICBzdGFnZXM6OnsKICAgICAgICBBY2NvdW50SGFzaGluZ1N0YWdlLCBCb2R5U3RhZ2UsIEVyYUltcG9ydFNvdXJjZSwgRXJhU3RhZ2UsIEV4ZWN1dGlvblN0YWdlLCBGaW5pc2hTdGFnZSwKICAgICAgICBIZWFkZXJTdGFnZSwgSW5kZXhBY2NvdW50SGlzdG9yeVN0YWdlLCBJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2UsIE1lcmtsZVN0YWdlLAogICAgICAgIFBydW5lU2VuZGVyUmVjb3ZlcnlTdGFnZSwgUHJ1bmVTdGFnZSwgU2VuZGVyUmVjb3ZlcnlTdGFnZSwgU3RvcmFnZUhhc2hpbmdTdGFnZSwKICAgICAgICBUcmFuc2FjdGlvbkxvb2t1cFN0YWdlLAogICAgfSwKICAgIFN0YWdlU2V0LCBTdGFnZVNldEJ1aWxkZXIsCn07CnVzZSBhbGxveV9wcmltaXRpdmVzOjpCMjU2Owp1c2UgcmV0aF9jb25maWc6OmNvbmZpZzo6U3RhZ2VDb25maWc7CnVzZSByZXRoX2NvbnNlbnN1czo6RnVsbENvbnNlbnN1czsKdXNlIHJldGhfZXZtOjpDb25maWd1cmVFdm07CnVzZSByZXRoX25ldHdvcmtfcDJwOjp7Ym9kaWVzOjpkb3dubG9hZGVyOjpCb2R5RG93bmxvYWRlciwgaGVhZGVyczo6ZG93bmxvYWRlcjo6SGVhZGVyRG93bmxvYWRlcn07CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjp7QmxvY2ssIE5vZGVQcmltaXRpdmVzfTsKdXNlIHJldGhfcHJvdmlkZXI6OkhlYWRlclN5bmNHYXBQcm92aWRlcjsKdXNlIHJldGhfcHJ1bmVfdHlwZXM6OlBydW5lTW9kZXM7CnVzZSByZXRoX3N0YWdlc19hcGk6OlN0YWdlOwp1c2Ugc3RkOjpzeW5jOjpBcmM7CnVzZSB0b2tpbzo6c3luYzo6d2F0Y2g7CgovLy8gQSBzZXQgY29udGFpbmluZyBhbGwgc3RhZ2VzIHRvIHJ1biBhIGZ1bGx5IHN5bmNpbmcgaW5zdGFuY2Ugb2YgcmV0aC4KLy8vCi8vLyBBIGNvbWJpbmF0aW9uIG9mIChpbiBvcmRlcikKLy8vCi8vLyAtIFtgT25saW5lU3RhZ2VzYF0KLy8vIC0gW2BPZmZsaW5lU3RhZ2VzYF0KLy8vIC0gW2BGaW5pc2hTdGFnZWBdCi8vLwovLy8gVGhpcyBleHBhbmRzIHRvIHRoZSBmb2xsb3dpbmcgc2VyaWVzIG9mIHN0YWdlczoKLy8vIC0gW2BFcmFTdGFnZWBdIChvcHRpb25hbCwgZm9yIEVSQTEgaW1wb3J0KQovLy8gLSBbYEhlYWRlclN0YWdlYF0KLy8vIC0gW2BCb2R5U3RhZ2VgXQovLy8gLSBbYFNlbmRlclJlY292ZXJ5U3RhZ2VgXQovLy8gLSBbYEV4ZWN1dGlvblN0YWdlYF0KLy8vIC0gW2BQcnVuZVNlbmRlclJlY292ZXJ5U3RhZ2VgXSAoZXhlY3V0ZSkKLy8vIC0gW2BNZXJrbGVTdGFnZWBdICh1bndpbmQpCi8vLyAtIFtgQWNjb3VudEhhc2hpbmdTdGFnZWBdCi8vLyAtIFtgU3RvcmFnZUhhc2hpbmdTdGFnZWBdCi8vLyAtIFtgTWVya2xlU3RhZ2VgXSAoZXhlY3V0ZSkKLy8vIC0gW2BUcmFuc2FjdGlvbkxvb2t1cFN0YWdlYF0KLy8vIC0gW2BJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2VgXQovLy8gLSBbYEluZGV4QWNjb3VudEhpc3RvcnlTdGFnZWBdCi8vLyAtIFtgUHJ1bmVTdGFnZWBdIChleGVjdXRlKQovLy8gLSBbYEZpbmlzaFN0YWdlYF0KI1tkZXJpdmUoRGVidWcpXQpwdWIgc3RydWN0IERlZmF1bHRTdGFnZXM8UHJvdmlkZXIsIEgsIEIsIEU+CndoZXJlCiAgICBIOiBIZWFkZXJEb3dubG9hZGVyLAogICAgQjogQm9keURvd25sb2FkZXIsCiAgICBFOiBDb25maWd1cmVFdm0sCnsKICAgIC8vLyBDb25maWd1cmF0aW9uIGZvciB0aGUgb25saW5lIHN0YWdlcwogICAgb25saW5lOiBPbmxpbmVTdGFnZXM8UHJvdmlkZXIsIEgsIEI+LAogICAgLy8vIEV4ZWN1dG9yIGZhY3RvcnkgbmVlZHMgZm9yIGV4ZWN1dGlvbiBzdGFnZQogICAgZXZtX2NvbmZpZzogRSwKICAgIC8vLyBDb25zZW5zdXMgaW5zdGFuY2UKICAgIGNvbnNlbnN1czogQXJjPGR5biBGdWxsQ29uc2Vuc3VzPEU6OlByaW1pdGl2ZXM+PiwKICAgIC8vLyBDb25maWd1cmF0aW9uIGZvciBlYWNoIHN0YWdlIGluIHRoZSBwaXBlbGluZQogICAgc3RhZ2VzX2NvbmZpZzogU3RhZ2VDb25maWcsCiAgICAvLy8gUHJ1bmUgY29uZmlndXJhdGlvbiBmb3IgZXZlcnkgc2VnbWVudCB0aGF0IGNhbiBiZSBwcnVuZWQKICAgIHBydW5lX21vZGVzOiBQcnVuZU1vZGVzLAp9CgppbXBsPFByb3ZpZGVyLCBILCBCLCBFPiBEZWZhdWx0U3RhZ2VzPFByb3ZpZGVyLCBILCBCLCBFPgp3aGVyZQogICAgSDogSGVhZGVyRG93bmxvYWRlciwKICAgIEI6IEJvZHlEb3dubG9hZGVyLAogICAgRTogQ29uZmlndXJlRXZtPFByaW1pdGl2ZXM6IE5vZGVQcmltaXRpdmVzPEJsb2NrSGVhZGVyID0gSDo6SGVhZGVyLCBCbG9jayA9IEI6OkJsb2NrPj4sCnsKICAgIC8vLyBDcmVhdGUgYSBuZXcgc2V0IG9mIGRlZmF1bHQgc3RhZ2VzIHdpdGggZGVmYXVsdCB2YWx1ZXMuCiAgICAjW2V4cGVjdChjbGlwcHk6OnRvb19tYW55X2FyZ3VtZW50cyldCiAgICBwdWIgZm4gbmV3KAogICAgICAgIHByb3ZpZGVyOiBQcm92aWRlciwKICAgICAgICB0aXA6IHdhdGNoOjpSZWNlaXZlcjxCMjU2PiwKICAgICAgICBjb25zZW5zdXM6IEFyYzxkeW4gRnVsbENvbnNlbnN1czxFOjpQcmltaXRpdmVzPj4sCiAgICAgICAgaGVhZGVyX2Rvd25sb2FkZXI6IEgsCiAgICAgICAgYm9keV9kb3dubG9hZGVyOiBCLAogICAgICAgIGV2bV9jb25maWc6IEUsCiAgICAgICAgc3RhZ2VzX2NvbmZpZzogU3RhZ2VDb25maWcsCiAgICAgICAgcHJ1bmVfbW9kZXM6IFBydW5lTW9kZXMsCiAgICAgICAgZXJhX2ltcG9ydF9zb3VyY2U6IE9wdGlvbjxFcmFJbXBvcnRTb3VyY2U+LAogICAgKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgb25saW5lOiBPbmxpbmVTdGFnZXM6Om5ldygKICAgICAgICAgICAgICAgIHByb3ZpZGVyLAogICAgICAgICAgICAgICAgdGlwLAogICAgICAgICAgICAgICAgaGVhZGVyX2Rvd25sb2FkZXIsCiAgICAgICAgICAgICAgICBib2R5X2Rvd25sb2FkZXIsCiAgICAgICAgICAgICAgICBzdGFnZXNfY29uZmlnLmNsb25lKCksCiAgICAgICAgICAgICAgICBlcmFfaW1wb3J0X3NvdXJjZSwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgZXZtX2NvbmZpZywKICAgICAgICAgICAgY29uc2Vuc3VzLAogICAgICAgICAgICBzdGFnZXNfY29uZmlnLAogICAgICAgICAgICBwcnVuZV9tb2RlcywKICAgICAgICB9CiAgICB9Cn0KCmltcGw8UCwgSCwgQiwgRT4gRGVmYXVsdFN0YWdlczxQLCBILCBCLCBFPgp3aGVyZQogICAgRTogQ29uZmlndXJlRXZtLAogICAgSDogSGVhZGVyRG93bmxvYWRlciwKICAgIEI6IEJvZHlEb3dubG9hZGVyLAp7CiAgICAvLy8gQXBwZW5kcyB0aGUgZGVmYXVsdCBvZmZsaW5lIHN0YWdlcyBhbmQgZGVmYXVsdCBmaW5pc2ggc3RhZ2UgdG8gdGhlIGdpdmVuIGJ1aWxkZXIuCiAgICBwdWIgZm4gYWRkX29mZmxpbmVfc3RhZ2VzPFByb3ZpZGVyPigKICAgICAgICBkZWZhdWx0X29mZmxpbmU6IFN0YWdlU2V0QnVpbGRlcjxQcm92aWRlcj4sCiAgICAgICAgZXZtX2NvbmZpZzogRSwKICAgICAgICBjb25zZW5zdXM6IEFyYzxkeW4gRnVsbENvbnNlbnN1czxFOjpQcmltaXRpdmVzPj4sCiAgICAgICAgc3RhZ2VzX2NvbmZpZzogU3RhZ2VDb25maWcsCiAgICAgICAgcHJ1bmVfbW9kZXM6IFBydW5lTW9kZXMsCiAgICApIC0+IFN0YWdlU2V0QnVpbGRlcjxQcm92aWRlcj4KICAgIHdoZXJlCiAgICAgICAgT2ZmbGluZVN0YWdlczxFPjogU3RhZ2VTZXQ8UHJvdmlkZXI+LAogICAgewogICAgICAgIFN0YWdlU2V0QnVpbGRlcjo6ZGVmYXVsdCgpCiAgICAgICAgICAgIC5hZGRfc2V0KGRlZmF1bHRfb2ZmbGluZSkKICAgICAgICAgICAgLmFkZF9zZXQoT2ZmbGluZVN0YWdlczo6bmV3KGV2bV9jb25maWcsIGNvbnNlbnN1cywgc3RhZ2VzX2NvbmZpZywgcHJ1bmVfbW9kZXMpKQogICAgICAgICAgICAuYWRkX3N0YWdlKEZpbmlzaFN0YWdlKQogICAgfQp9CgppbXBsPFAsIEgsIEIsIEUsIFByb3ZpZGVyPiBTdGFnZVNldDxQcm92aWRlcj4gZm9yIERlZmF1bHRTdGFnZXM8UCwgSCwgQiwgRT4Kd2hlcmUKICAgIFA6IEhlYWRlclN5bmNHYXBQcm92aWRlciArICdzdGF0aWMsCiAgICBIOiBIZWFkZXJEb3dubG9hZGVyICsgJ3N0YXRpYywKICAgIEI6IEJvZHlEb3dubG9hZGVyICsgJ3N0YXRpYywKICAgIEU6IENvbmZpZ3VyZUV2bSwKICAgIE9ubGluZVN0YWdlczxQLCBILCBCPjogU3RhZ2VTZXQ8UHJvdmlkZXI+LAogICAgT2ZmbGluZVN0YWdlczxFPjogU3RhZ2VTZXQ8UHJvdmlkZXI+LAp7CiAgICBmbiBidWlsZGVyKHNlbGYpIC0+IFN0YWdlU2V0QnVpbGRlcjxQcm92aWRlcj4gewogICAgICAgIFNlbGY6OmFkZF9vZmZsaW5lX3N0YWdlcygKICAgICAgICAgICAgc2VsZi5vbmxpbmUuYnVpbGRlcigpLAogICAgICAgICAgICBzZWxmLmV2bV9jb25maWcsCiAgICAgICAgICAgIHNlbGYuY29uc2Vuc3VzLAogICAgICAgICAgICBzZWxmLnN0YWdlc19jb25maWcuY2xvbmUoKSwKICAgICAgICAgICAgc2VsZi5wcnVuZV9tb2RlcywKICAgICAgICApCiAgICB9Cn0KCi8vLyBBIHNldCBjb250YWluaW5nIGFsbCBzdGFnZXMgdGhhdCByZXF1aXJlIG5ldHdvcmsgYWNjZXNzIGJ5IGRlZmF1bHQuCi8vLwovLy8gVGhlc2Ugc3RhZ2VzICpjYW4qIGJlIHJ1biB3aXRob3V0IG5ldHdvcmsgYWNjZXNzIGlmIHRoZSBzcGVjaWZpZWQgZG93bmxvYWRlcnMgYXJlCi8vLyB0aGVtc2VsdmVzIG9mZmxpbmUuCiNbZGVyaXZlKERlYnVnKV0KcHViIHN0cnVjdCBPbmxpbmVTdGFnZXM8UHJvdmlkZXIsIEgsIEI+CndoZXJlCiAgICBIOiBIZWFkZXJEb3dubG9hZGVyLAogICAgQjogQm9keURvd25sb2FkZXIsCnsKICAgIC8vLyBTeW5jIGdhcCBwcm92aWRlciBmb3IgdGhlIGhlYWRlcnMgc3RhZ2UuCiAgICBwcm92aWRlcjogUHJvdmlkZXIsCiAgICAvLy8gVGhlIHRpcCBmb3IgdGhlIGhlYWRlcnMgc3RhZ2UuCiAgICB0aXA6IHdhdGNoOjpSZWNlaXZlcjxCMjU2PiwKCiAgICAvLy8gVGhlIGJsb2NrIGhlYWRlciBkb3dubG9hZGVyCiAgICBoZWFkZXJfZG93bmxvYWRlcjogSCwKICAgIC8vLyBUaGUgYmxvY2sgYm9keSBkb3dubG9hZGVyCiAgICBib2R5X2Rvd25sb2FkZXI6IEIsCiAgICAvLy8gQ29uZmlndXJhdGlvbiBmb3IgZWFjaCBzdGFnZSBpbiB0aGUgcGlwZWxpbmUKICAgIHN0YWdlc19jb25maWc6IFN0YWdlQ29uZmlnLAogICAgLy8vIE9wdGlvbmFsIHNvdXJjZSBvZiBFUkExIGZpbGVzLiBUaGUgYEVyYVN0YWdlYCBkb2VzIG5vdGhpbmcgdW5sZXNzIHRoaXMgaXMgc3BlY2lmaWVkLgogICAgZXJhX2ltcG9ydF9zb3VyY2U6IE9wdGlvbjxFcmFJbXBvcnRTb3VyY2U+LAp9CgppbXBsPFByb3ZpZGVyLCBILCBCPiBPbmxpbmVTdGFnZXM8UHJvdmlkZXIsIEgsIEI+CndoZXJlCiAgICBIOiBIZWFkZXJEb3dubG9hZGVyLAogICAgQjogQm9keURvd25sb2FkZXIsCnsKICAgIC8vLyBDcmVhdGUgYSBuZXcgc2V0IG9mIG9ubGluZSBzdGFnZXMgd2l0aCBkZWZhdWx0IHZhbHVlcy4KICAgIHB1YiBjb25zdCBmbiBuZXcoCiAgICAgICAgcHJvdmlkZXI6IFByb3ZpZGVyLAogICAgICAgIHRpcDogd2F0Y2g6OlJlY2VpdmVyPEIyNTY+LAogICAgICAgIGhlYWRlcl9kb3dubG9hZGVyOiBILAogICAgICAgIGJvZHlfZG93bmxvYWRlcjogQiwKICAgICAgICBzdGFnZXNfY29uZmlnOiBTdGFnZUNvbmZpZywKICAgICAgICBlcmFfaW1wb3J0X3NvdXJjZTogT3B0aW9uPEVyYUltcG9ydFNvdXJjZT4sCiAgICApIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBwcm92aWRlciwgdGlwLCBoZWFkZXJfZG93bmxvYWRlciwgYm9keV9kb3dubG9hZGVyLCBzdGFnZXNfY29uZmlnLCBlcmFfaW1wb3J0X3NvdXJjZSB9CiAgICB9Cn0KCmltcGw8UCwgSCwgQj4gT25saW5lU3RhZ2VzPFAsIEgsIEI+CndoZXJlCiAgICBQOiBIZWFkZXJTeW5jR2FwUHJvdmlkZXIgKyAnc3RhdGljLAogICAgSDogSGVhZGVyRG93bmxvYWRlcjxIZWFkZXIgPSA8Qjo6QmxvY2sgYXMgQmxvY2s+OjpIZWFkZXI+ICsgJ3N0YXRpYywKICAgIEI6IEJvZHlEb3dubG9hZGVyICsgJ3N0YXRpYywKewogICAgLy8vIENyZWF0ZSBhIG5ldyBidWlsZGVyIHVzaW5nIHRoZSBnaXZlbiBoZWFkZXJzIHN0YWdlLgogICAgcHViIGZuIGJ1aWxkZXJfd2l0aF9oZWFkZXJzPFByb3ZpZGVyPigKICAgICAgICBoZWFkZXJzOiBIZWFkZXJTdGFnZTxQLCBIPiwKICAgICAgICBib2R5X2Rvd25sb2FkZXI6IEIsCiAgICApIC0+IFN0YWdlU2V0QnVpbGRlcjxQcm92aWRlcj4KICAgIHdoZXJlCiAgICAgICAgSGVhZGVyU3RhZ2U8UCwgSD46IFN0YWdlPFByb3ZpZGVyPiwKICAgICAgICBCb2R5U3RhZ2U8Qj46IFN0YWdlPFByb3ZpZGVyPiwKICAgIHsKICAgICAgICBTdGFnZVNldEJ1aWxkZXI6OmRlZmF1bHQoKS5hZGRfc3RhZ2UoaGVhZGVycykuYWRkX3N0YWdlKEJvZHlTdGFnZTo6bmV3KGJvZHlfZG93bmxvYWRlcikpCiAgICB9CgogICAgLy8vIENyZWF0ZSBhIG5ldyBidWlsZGVyIHVzaW5nIHRoZSBnaXZlbiBib2RpZXMgc3RhZ2UuCiAgICBwdWIgZm4gYnVpbGRlcl93aXRoX2JvZGllczxQcm92aWRlcj4oCiAgICAgICAgYm9kaWVzOiBCb2R5U3RhZ2U8Qj4sCiAgICAgICAgcHJvdmlkZXI6IFAsCiAgICAgICAgdGlwOiB3YXRjaDo6UmVjZWl2ZXI8QjI1Nj4sCiAgICAgICAgaGVhZGVyX2Rvd25sb2FkZXI6IEgsCiAgICAgICAgc3RhZ2VzX2NvbmZpZzogU3RhZ2VDb25maWcsCiAgICApIC0+IFN0YWdlU2V0QnVpbGRlcjxQcm92aWRlcj4KICAgIHdoZXJlCiAgICAgICAgQm9keVN0YWdlPEI+OiBTdGFnZTxQcm92aWRlcj4sCiAgICAgICAgSGVhZGVyU3RhZ2U8UCwgSD46IFN0YWdlPFByb3ZpZGVyPiwKICAgIHsKICAgICAgICBTdGFnZVNldEJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAuYWRkX3N0YWdlKEhlYWRlclN0YWdlOjpuZXcocHJvdmlkZXIsIGhlYWRlcl9kb3dubG9hZGVyLCB0aXAsIHN0YWdlc19jb25maWcuZXRsKSkKICAgICAgICAgICAgLmFkZF9zdGFnZShib2RpZXMpCiAgICB9Cn0KCmltcGw8UHJvdmlkZXIsIFAsIEgsIEI+IFN0YWdlU2V0PFByb3ZpZGVyPiBmb3IgT25saW5lU3RhZ2VzPFAsIEgsIEI+CndoZXJlCiAgICBQOiBIZWFkZXJTeW5jR2FwUHJvdmlkZXIgKyAnc3RhdGljLAogICAgSDogSGVhZGVyRG93bmxvYWRlcjxIZWFkZXIgPSA8Qjo6QmxvY2sgYXMgQmxvY2s+OjpIZWFkZXI+ICsgJ3N0YXRpYywKICAgIEI6IEJvZHlEb3dubG9hZGVyICsgJ3N0YXRpYywKICAgIEhlYWRlclN0YWdlPFAsIEg+OiBTdGFnZTxQcm92aWRlcj4sCiAgICBCb2R5U3RhZ2U8Qj46IFN0YWdlPFByb3ZpZGVyPiwKICAgIEVyYVN0YWdlPDxCOjpCbG9jayBhcyBCbG9jaz46OkhlYWRlciwgPEI6OkJsb2NrIGFzIEJsb2NrPjo6Qm9keSwgRXJhSW1wb3J0U291cmNlPjoKICAgICAgICBTdGFnZTxQcm92aWRlcj4sCnsKICAgIGZuIGJ1aWxkZXIoc2VsZikgLT4gU3RhZ2VTZXRCdWlsZGVyPFByb3ZpZGVyPiB7CiAgICAgICAgbGV0IG11dCBidWlsZGVyID0gU3RhZ2VTZXRCdWlsZGVyOjpkZWZhdWx0KCk7CgogICAgICAgIGlmIHNlbGYuZXJhX2ltcG9ydF9zb3VyY2UuaXNfc29tZSgpIHsKICAgICAgICAgICAgYnVpbGRlciA9IGJ1aWxkZXIKICAgICAgICAgICAgICAgIC5hZGRfc3RhZ2UoRXJhU3RhZ2U6Om5ldyhzZWxmLmVyYV9pbXBvcnRfc291cmNlLCBzZWxmLnN0YWdlc19jb25maWcuZXRsLmNsb25lKCkpKTsKICAgICAgICB9CgogICAgICAgIGJ1aWxkZXIKICAgICAgICAgICAgLmFkZF9zdGFnZShIZWFkZXJTdGFnZTo6bmV3KAogICAgICAgICAgICAgICAgc2VsZi5wcm92aWRlciwKICAgICAgICAgICAgICAgIHNlbGYuaGVhZGVyX2Rvd25sb2FkZXIsCiAgICAgICAgICAgICAgICBzZWxmLnRpcCwKICAgICAgICAgICAgICAgIHNlbGYuc3RhZ2VzX2NvbmZpZy5ldGwuY2xvbmUoKSwKICAgICAgICAgICAgKSkKICAgICAgICAgICAgLmFkZF9zdGFnZShCb2R5U3RhZ2U6Om5ldyhzZWxmLmJvZHlfZG93bmxvYWRlcikpCiAgICB9Cn0KCi8vLyBBIHNldCBjb250YWluaW5nIGFsbCBzdGFnZXMgdGhhdCBkbyBub3QgcmVxdWlyZSBuZXR3b3JrIGFjY2Vzcy4KLy8vCi8vLyBBIGNvbWJpbmF0aW9uIG9mIChpbiBvcmRlcikKLy8vCi8vLyAtIFtgRXhlY3V0aW9uU3RhZ2VzYF0KLy8vIC0gW2BQcnVuZVNlbmRlclJlY292ZXJ5U3RhZ2VgXQovLy8gLSBbYEhhc2hpbmdTdGFnZXNgXQovLy8gLSBbYEhpc3RvcnlJbmRleGluZ1N0YWdlc2BdCi8vLyAtIFtgUHJ1bmVTdGFnZWBdCiNbZGVyaXZlKERlYnVnKV0KI1tub25fZXhoYXVzdGl2ZV0KcHViIHN0cnVjdCBPZmZsaW5lU3RhZ2VzPEU6IENvbmZpZ3VyZUV2bT4gewogICAgLy8vIEV4ZWN1dG9yIGZhY3RvcnkgbmVlZHMgZm9yIGV4ZWN1dGlvbiBzdGFnZQogICAgZXZtX2NvbmZpZzogRSwKICAgIC8vLyBDb25zZW5zdXMgaW5zdGFuY2UgZm9yIHZhbGlkYXRpbmcgYmxvY2tzLgogICAgY29uc2Vuc3VzOiBBcmM8ZHluIEZ1bGxDb25zZW5zdXM8RTo6UHJpbWl0aXZlcz4+LAogICAgLy8vIENvbmZpZ3VyYXRpb24gZm9yIGVhY2ggc3RhZ2UgaW4gdGhlIHBpcGVsaW5lCiAgICBzdGFnZXNfY29uZmlnOiBTdGFnZUNvbmZpZywKICAgIC8vLyBQcnVuZSBjb25maWd1cmF0aW9uIGZvciBldmVyeSBzZWdtZW50IHRoYXQgY2FuIGJlIHBydW5lZAogICAgcHJ1bmVfbW9kZXM6IFBydW5lTW9kZXMsCn0KCmltcGw8RTogQ29uZmlndXJlRXZtPiBPZmZsaW5lU3RhZ2VzPEU+IHsKICAgIC8vLyBDcmVhdGUgYSBuZXcgc2V0IG9mIG9mZmxpbmUgc3RhZ2VzIHdpdGggZGVmYXVsdCB2YWx1ZXMuCiAgICBwdWIgY29uc3QgZm4gbmV3KAogICAgICAgIGV2bV9jb25maWc6IEUsCiAgICAgICAgY29uc2Vuc3VzOiBBcmM8ZHluIEZ1bGxDb25zZW5zdXM8RTo6UHJpbWl0aXZlcz4+LAogICAgICAgIHN0YWdlc19jb25maWc6IFN0YWdlQ29uZmlnLAogICAgICAgIHBydW5lX21vZGVzOiBQcnVuZU1vZGVzLAogICAgKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgZXZtX2NvbmZpZywgY29uc2Vuc3VzLCBzdGFnZXNfY29uZmlnLCBwcnVuZV9tb2RlcyB9CiAgICB9Cn0KCmltcGw8RSwgUHJvdmlkZXI+IFN0YWdlU2V0PFByb3ZpZGVyPiBmb3IgT2ZmbGluZVN0YWdlczxFPgp3aGVyZQogICAgRTogQ29uZmlndXJlRXZtLAogICAgRXhlY3V0aW9uU3RhZ2VzPEU+OiBTdGFnZVNldDxQcm92aWRlcj4sCiAgICBQcnVuZVNlbmRlclJlY292ZXJ5U3RhZ2U6IFN0YWdlPFByb3ZpZGVyPiwKICAgIEhhc2hpbmdTdGFnZXM6IFN0YWdlU2V0PFByb3ZpZGVyPiwKICAgIEhpc3RvcnlJbmRleGluZ1N0YWdlczogU3RhZ2VTZXQ8UHJvdmlkZXI+LAogICAgUHJ1bmVTdGFnZTogU3RhZ2U8UHJvdmlkZXI+LAp7CiAgICBmbiBidWlsZGVyKHNlbGYpIC0+IFN0YWdlU2V0QnVpbGRlcjxQcm92aWRlcj4gewogICAgICAgIEV4ZWN1dGlvblN0YWdlczo6bmV3KHNlbGYuZXZtX2NvbmZpZywgc2VsZi5jb25zZW5zdXMsIHNlbGYuc3RhZ2VzX2NvbmZpZy5jbG9uZSgpKQogICAgICAgICAgICAuYnVpbGRlcigpCiAgICAgICAgICAgIC8vIElmIHNlbmRlciByZWNvdmVyeSBwcnVuZSBtb2RlIGlzIHNldCwgYWRkIHRoZSBwcnVuZSBzZW5kZXIgcmVjb3Zlcnkgc3RhZ2UuCiAgICAgICAgICAgIC5hZGRfc3RhZ2Vfb3B0KHNlbGYucHJ1bmVfbW9kZXMuc2VuZGVyX3JlY292ZXJ5Lm1hcCh8cHJ1bmVfbW9kZXwgewogICAgICAgICAgICAgICAgUHJ1bmVTZW5kZXJSZWNvdmVyeVN0YWdlOjpuZXcocHJ1bmVfbW9kZSwgc2VsZi5zdGFnZXNfY29uZmlnLnBydW5lLmNvbW1pdF90aHJlc2hvbGQpCiAgICAgICAgICAgIH0pKQogICAgICAgICAgICAuYWRkX3NldChIYXNoaW5nU3RhZ2VzIHsgc3RhZ2VzX2NvbmZpZzogc2VsZi5zdGFnZXNfY29uZmlnLmNsb25lKCkgfSkKICAgICAgICAgICAgLmFkZF9zZXQoSGlzdG9yeUluZGV4aW5nU3RhZ2VzIHsKICAgICAgICAgICAgICAgIHN0YWdlc19jb25maWc6IHNlbGYuc3RhZ2VzX2NvbmZpZy5jbG9uZSgpLAogICAgICAgICAgICAgICAgcHJ1bmVfbW9kZXM6IHNlbGYucHJ1bmVfbW9kZXMuY2xvbmUoKSwKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLy8gUHJ1bmUgc3RhZ2Ugc2hvdWxkIGJlIGFkZGVkIGFmdGVyIGFsbCBoYXNoaW5nIHN0YWdlcywgYmVjYXVzZSBvdGhlcndpc2UgaXQgd2lsbAogICAgICAgICAgICAvLyBkZWxldGUKICAgICAgICAgICAgLmFkZF9zdGFnZShQcnVuZVN0YWdlOjpuZXcoCiAgICAgICAgICAgICAgICBzZWxmLnBydW5lX21vZGVzLmNsb25lKCksCiAgICAgICAgICAgICAgICBzZWxmLnN0YWdlc19jb25maWcucHJ1bmUuY29tbWl0X3RocmVzaG9sZCwKICAgICAgICAgICAgKSkKICAgIH0KfQoKLy8vIEEgc2V0IGNvbnRhaW5pbmcgYWxsIHN0YWdlcyB0aGF0IGFyZSByZXF1aXJlZCB0byBleGVjdXRlIHByZS1leGlzdGluZyBibG9jayBkYXRhLgojW2Rlcml2ZShEZWJ1ZyldCiNbbm9uX2V4aGF1c3RpdmVdCnB1YiBzdHJ1Y3QgRXhlY3V0aW9uU3RhZ2VzPEU6IENvbmZpZ3VyZUV2bT4gewogICAgLy8vIEV4ZWN1dG9yIGZhY3RvcnkgdGhhdCB3aWxsIGNyZWF0ZSBleGVjdXRvcnMuCiAgICBldm1fY29uZmlnOiBFLAogICAgLy8vIENvbnNlbnN1cyBpbnN0YW5jZSBmb3IgdmFsaWRhdGluZyBibG9ja3MuCiAgICBjb25zZW5zdXM6IEFyYzxkeW4gRnVsbENvbnNlbnN1czxFOjpQcmltaXRpdmVzPj4sCiAgICAvLy8gQ29uZmlndXJhdGlvbiBmb3IgZWFjaCBzdGFnZSBpbiB0aGUgcGlwZWxpbmUKICAgIHN0YWdlc19jb25maWc6IFN0YWdlQ29uZmlnLAp9CgppbXBsPEU6IENvbmZpZ3VyZUV2bT4gRXhlY3V0aW9uU3RhZ2VzPEU+IHsKICAgIC8vLyBDcmVhdGUgYSBuZXcgc2V0IG9mIGV4ZWN1dGlvbiBzdGFnZXMgd2l0aCBkZWZhdWx0IHZhbHVlcy4KICAgIHB1YiBjb25zdCBmbiBuZXcoCiAgICAgICAgZXhlY3V0b3JfcHJvdmlkZXI6IEUsCiAgICAgICAgY29uc2Vuc3VzOiBBcmM8ZHluIEZ1bGxDb25zZW5zdXM8RTo6UHJpbWl0aXZlcz4+LAogICAgICAgIHN0YWdlc19jb25maWc6IFN0YWdlQ29uZmlnLAogICAgKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgZXZtX2NvbmZpZzogZXhlY3V0b3JfcHJvdmlkZXIsIGNvbnNlbnN1cywgc3RhZ2VzX2NvbmZpZyB9CiAgICB9Cn0KCmltcGw8RSwgUHJvdmlkZXI+IFN0YWdlU2V0PFByb3ZpZGVyPiBmb3IgRXhlY3V0aW9uU3RhZ2VzPEU+CndoZXJlCiAgICBFOiBDb25maWd1cmVFdm0gKyAnc3RhdGljLAogICAgU2VuZGVyUmVjb3ZlcnlTdGFnZTogU3RhZ2U8UHJvdmlkZXI+LAogICAgRXhlY3V0aW9uU3RhZ2U8RT46IFN0YWdlPFByb3ZpZGVyPiwKewogICAgZm4gYnVpbGRlcihzZWxmKSAtPiBTdGFnZVNldEJ1aWxkZXI8UHJvdmlkZXI+IHsKICAgICAgICBTdGFnZVNldEJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAuYWRkX3N0YWdlKFNlbmRlclJlY292ZXJ5U3RhZ2U6Om5ldyhzZWxmLnN0YWdlc19jb25maWcuc2VuZGVyX3JlY292ZXJ5KSkKICAgICAgICAgICAgLmFkZF9zdGFnZShFeGVjdXRpb25TdGFnZTo6ZnJvbV9jb25maWcoCiAgICAgICAgICAgICAgICBzZWxmLmV2bV9jb25maWcsCiAgICAgICAgICAgICAgICBzZWxmLmNvbnNlbnN1cywKICAgICAgICAgICAgICAgIHNlbGYuc3RhZ2VzX2NvbmZpZy5leGVjdXRpb24sCiAgICAgICAgICAgICAgICBzZWxmLnN0YWdlc19jb25maWcuZXhlY3V0aW9uX2V4dGVybmFsX2NsZWFuX3RocmVzaG9sZCgpLAogICAgICAgICAgICApKQogICAgfQp9CgovLy8gQSBzZXQgY29udGFpbmluZyBhbGwgc3RhZ2VzIHRoYXQgaGFzaCBhY2NvdW50IHN0YXRlLgovLy8KLy8vIFRoaXMgaW5jbHVkZXM6Ci8vLyAtIFtgTWVya2xlU3RhZ2VgXSAodW53aW5kKQovLy8gLSBbYEFjY291bnRIYXNoaW5nU3RhZ2VgXQovLy8gLSBbYFN0b3JhZ2VIYXNoaW5nU3RhZ2VgXQovLy8gLSBbYE1lcmtsZVN0YWdlYF0gKGV4ZWN1dGUpCiNbZGVyaXZlKERlYnVnLCBEZWZhdWx0KV0KI1tub25fZXhoYXVzdGl2ZV0KcHViIHN0cnVjdCBIYXNoaW5nU3RhZ2VzIHsKICAgIC8vLyBDb25maWd1cmF0aW9uIGZvciBlYWNoIHN0YWdlIGluIHRoZSBwaXBlbGluZQogICAgc3RhZ2VzX2NvbmZpZzogU3RhZ2VDb25maWcsCn0KCmltcGw8UHJvdmlkZXI+IFN0YWdlU2V0PFByb3ZpZGVyPiBmb3IgSGFzaGluZ1N0YWdlcwp3aGVyZQogICAgTWVya2xlU3RhZ2U6IFN0YWdlPFByb3ZpZGVyPiwKICAgIEFjY291bnRIYXNoaW5nU3RhZ2U6IFN0YWdlPFByb3ZpZGVyPiwKICAgIFN0b3JhZ2VIYXNoaW5nU3RhZ2U6IFN0YWdlPFByb3ZpZGVyPiwKewogICAgZm4gYnVpbGRlcihzZWxmKSAtPiBTdGFnZVNldEJ1aWxkZXI8UHJvdmlkZXI+IHsKICAgICAgICBTdGFnZVNldEJ1aWxkZXI6OmRlZmF1bHQoKQogICAgICAgICAgICAuYWRkX3N0YWdlKE1lcmtsZVN0YWdlOjpkZWZhdWx0X3Vud2luZCgpKQogICAgICAgICAgICAuYWRkX3N0YWdlKEFjY291bnRIYXNoaW5nU3RhZ2U6Om5ldygKICAgICAgICAgICAgICAgIHNlbGYuc3RhZ2VzX2NvbmZpZy5hY2NvdW50X2hhc2hpbmcsCiAgICAgICAgICAgICAgICBzZWxmLnN0YWdlc19jb25maWcuZXRsLmNsb25lKCksCiAgICAgICAgICAgICkpCiAgICAgICAgICAgIC5hZGRfc3RhZ2UoU3RvcmFnZUhhc2hpbmdTdGFnZTo6bmV3KAogICAgICAgICAgICAgICAgc2VsZi5zdGFnZXNfY29uZmlnLnN0b3JhZ2VfaGFzaGluZywKICAgICAgICAgICAgICAgIHNlbGYuc3RhZ2VzX2NvbmZpZy5ldGwuY2xvbmUoKSwKICAgICAgICAgICAgKSkKICAgICAgICAgICAgLmFkZF9zdGFnZShNZXJrbGVTdGFnZTo6bmV3X2V4ZWN1dGlvbigKICAgICAgICAgICAgICAgIHNlbGYuc3RhZ2VzX2NvbmZpZy5tZXJrbGUucmVidWlsZF90aHJlc2hvbGQsCiAgICAgICAgICAgICAgICBzZWxmLnN0YWdlc19jb25maWcubWVya2xlLmluY3JlbWVudGFsX3RocmVzaG9sZCwKICAgICAgICAgICAgKSkKICAgIH0KfQoKLy8vIEEgc2V0IGNvbnRhaW5pbmcgYWxsIHN0YWdlcyB0aGF0IGRvIGFkZGl0aW9uYWwgaW5kZXhpbmcgZm9yIGhpc3RvcmljYWwgc3RhdGUuCiNbZGVyaXZlKERlYnVnLCBEZWZhdWx0KV0KI1tub25fZXhoYXVzdGl2ZV0KcHViIHN0cnVjdCBIaXN0b3J5SW5kZXhpbmdTdGFnZXMgewogICAgLy8vIENvbmZpZ3VyYXRpb24gZm9yIGVhY2ggc3RhZ2UgaW4gdGhlIHBpcGVsaW5lCiAgICBzdGFnZXNfY29uZmlnOiBTdGFnZUNvbmZpZywKICAgIC8vLyBQcnVuZSBjb25maWd1cmF0aW9uIGZvciBldmVyeSBzZWdtZW50IHRoYXQgY2FuIGJlIHBydW5lZAogICAgcHJ1bmVfbW9kZXM6IFBydW5lTW9kZXMsCn0KCmltcGw8UHJvdmlkZXI+IFN0YWdlU2V0PFByb3ZpZGVyPiBmb3IgSGlzdG9yeUluZGV4aW5nU3RhZ2VzCndoZXJlCiAgICBUcmFuc2FjdGlvbkxvb2t1cFN0YWdlOiBTdGFnZTxQcm92aWRlcj4sCiAgICBJbmRleFN0b3JhZ2VIaXN0b3J5U3RhZ2U6IFN0YWdlPFByb3ZpZGVyPiwKICAgIEluZGV4QWNjb3VudEhpc3RvcnlTdGFnZTogU3RhZ2U8UHJvdmlkZXI+LAp7CiAgICBmbiBidWlsZGVyKHNlbGYpIC0+IFN0YWdlU2V0QnVpbGRlcjxQcm92aWRlcj4gewogICAgICAgIFN0YWdlU2V0QnVpbGRlcjo6ZGVmYXVsdCgpCiAgICAgICAgICAgIC5hZGRfc3RhZ2UoVHJhbnNhY3Rpb25Mb29rdXBTdGFnZTo6bmV3KAogICAgICAgICAgICAgICAgc2VsZi5zdGFnZXNfY29uZmlnLnRyYW5zYWN0aW9uX2xvb2t1cCwKICAgICAgICAgICAgICAgIHNlbGYuc3RhZ2VzX2NvbmZpZy5ldGwuY2xvbmUoKSwKICAgICAgICAgICAgICAgIHNlbGYucHJ1bmVfbW9kZXMudHJhbnNhY3Rpb25fbG9va3VwLAogICAgICAgICAgICApKQogICAgICAgICAgICAuYWRkX3N0YWdlKEluZGV4U3RvcmFnZUhpc3RvcnlTdGFnZTo6bmV3KAogICAgICAgICAgICAgICAgc2VsZi5zdGFnZXNfY29uZmlnLmluZGV4X3N0b3JhZ2VfaGlzdG9yeSwKICAgICAgICAgICAgICAgIHNlbGYuc3RhZ2VzX2NvbmZpZy5ldGwuY2xvbmUoKSwKICAgICAgICAgICAgICAgIHNlbGYucHJ1bmVfbW9kZXMuc3RvcmFnZV9oaXN0b3J5LAogICAgICAgICAgICApKQogICAgICAgICAgICAuYWRkX3N0YWdlKEluZGV4QWNjb3VudEhpc3RvcnlTdGFnZTo6bmV3KAogICAgICAgICAgICAgICAgc2VsZi5zdGFnZXNfY29uZmlnLmluZGV4X2FjY291bnRfaGlzdG9yeSwKICAgICAgICAgICAgICAgIHNlbGYuc3RhZ2VzX2NvbmZpZy5ldGwuY2xvbmUoKSwKICAgICAgICAgICAgICAgIHNlbGYucHJ1bmVfbW9kZXMuYWNjb3VudF9oaXN0b3J5LAogICAgICAgICAgICApKQogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvdHlwZXMvc3JjL2NoZWNrcG9pbnRzLnJzIj4KdXNlIHN1cGVyOjpTdGFnZUlkOwojW2NmZyh0ZXN0KV0KdXNlIGFsbG9jOjp2ZWM7CnVzZSBhbGxvYzo6e2Zvcm1hdCwgc3RyaW5nOjpTdHJpbmcsIHZlYzo6VmVjfTsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OntBZGRyZXNzLCBCbG9ja051bWJlciwgQjI1NiwgVTI1Nn07CnVzZSBjb3JlOjpvcHM6OlJhbmdlSW5jbHVzaXZlOwp1c2UgcmV0aF90cmllX2NvbW1vbjo6e2hhc2hfYnVpbGRlcjo6SGFzaEJ1aWxkZXJTdGF0ZSwgU3RvcmVkU3ViTm9kZX07CgovLy8gU2F2ZXMgdGhlIHByb2dyZXNzIG9mIE1lcmtsZSBzdGFnZS4KI1tkZXJpdmUoRGVmYXVsdCwgRGVidWcsIENsb25lLCBQYXJ0aWFsRXEsIEVxKV0KcHViIHN0cnVjdCBNZXJrbGVDaGVja3BvaW50IHsKICAgIC8vLyBUaGUgdGFyZ2V0IGJsb2NrIG51bWJlci4KICAgIHB1YiB0YXJnZXRfYmxvY2s6IEJsb2NrTnVtYmVyLAogICAgLy8vIFRoZSBsYXN0IGhhc2hlZCBhY2NvdW50IGtleSBwcm9jZXNzZWQuCiAgICBwdWIgbGFzdF9hY2NvdW50X2tleTogQjI1NiwKICAgIC8vLyBQcmV2aW91c2x5IHJlY29yZGVkIHdhbGtlciBzdGFjay4KICAgIHB1YiB3YWxrZXJfc3RhY2s6IFZlYzxTdG9yZWRTdWJOb2RlPiwKICAgIC8vLyBUaGUgaGFzaCBidWlsZGVyIHN0YXRlLgogICAgcHViIHN0YXRlOiBIYXNoQnVpbGRlclN0YXRlLAogICAgLy8vIE9wdGlvbmFsIHN0b3JhZ2Ugcm9vdCBjaGVja3BvaW50IGZvciB0aGUgbGFzdCBwcm9jZXNzZWQgYWNjb3VudC4KICAgIHB1YiBzdG9yYWdlX3Jvb3RfY2hlY2twb2ludDogT3B0aW9uPFN0b3JhZ2VSb290TWVya2xlQ2hlY2twb2ludD4sCn0KCmltcGwgTWVya2xlQ2hlY2twb2ludCB7CiAgICAvLy8gQ3JlYXRlcyBhIG5ldyBNZXJrbGUgY2hlY2twb2ludC4KICAgIHB1YiBjb25zdCBmbiBuZXcoCiAgICAgICAgdGFyZ2V0X2Jsb2NrOiBCbG9ja051bWJlciwKICAgICAgICBsYXN0X2FjY291bnRfa2V5OiBCMjU2LAogICAgICAgIHdhbGtlcl9zdGFjazogVmVjPFN0b3JlZFN1Yk5vZGU+LAogICAgICAgIHN0YXRlOiBIYXNoQnVpbGRlclN0YXRlLAogICAgKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgdGFyZ2V0X2Jsb2NrLCBsYXN0X2FjY291bnRfa2V5LCB3YWxrZXJfc3RhY2ssIHN0YXRlLCBzdG9yYWdlX3Jvb3RfY2hlY2twb2ludDogTm9uZSB9CiAgICB9Cn0KCiNbY2ZnKGFueSh0ZXN0LCBmZWF0dXJlID0gInJldGgtY29kZWMiKSldCmltcGwgcmV0aF9jb2RlY3M6OkNvbXBhY3QgZm9yIE1lcmtsZUNoZWNrcG9pbnQgewogICAgZm4gdG9fY29tcGFjdDxCPigmc2VsZiwgYnVmOiAmbXV0IEIpIC0+IHVzaXplCiAgICB3aGVyZQogICAgICAgIEI6IGJ5dGVzOjpCdWZNdXQgKyBBc011dDxbdThdPiwKICAgIHsKICAgICAgICBsZXQgbXV0IGxlbiA9IDA7CgogICAgICAgIGJ1Zi5wdXRfdTY0KHNlbGYudGFyZ2V0X2Jsb2NrKTsKICAgICAgICBsZW4gKz0gODsKCiAgICAgICAgYnVmLnB1dF9zbGljZShzZWxmLmxhc3RfYWNjb3VudF9rZXkuYXNfc2xpY2UoKSk7CiAgICAgICAgbGVuICs9IHNlbGYubGFzdF9hY2NvdW50X2tleS5sZW4oKTsKCiAgICAgICAgYnVmLnB1dF91MTYoc2VsZi53YWxrZXJfc3RhY2subGVuKCkgYXMgdTE2KTsKICAgICAgICBsZW4gKz0gMjsKICAgICAgICBmb3IgaXRlbSBpbiAmc2VsZi53YWxrZXJfc3RhY2sgewogICAgICAgICAgICBsZW4gKz0gaXRlbS50b19jb21wYWN0KGJ1Zik7CiAgICAgICAgfQoKICAgICAgICBsZW4gKz0gc2VsZi5zdGF0ZS50b19jb21wYWN0KGJ1Zik7CgogICAgICAgIC8vIEVuY29kZSB0aGUgb3B0aW9uYWwgc3RvcmFnZSByb290IGNoZWNrcG9pbnQKICAgICAgICBtYXRjaCAmc2VsZi5zdG9yYWdlX3Jvb3RfY2hlY2twb2ludCB7CiAgICAgICAgICAgIFNvbWUoY2hlY2twb2ludCkgPT4gewogICAgICAgICAgICAgICAgLy8gb25lIG1lYW5zIFNvbWUKICAgICAgICAgICAgICAgIGJ1Zi5wdXRfdTgoMSk7CiAgICAgICAgICAgICAgICBsZW4gKz0gMTsKICAgICAgICAgICAgICAgIGxlbiArPSBjaGVja3BvaW50LnRvX2NvbXBhY3QoYnVmKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBOb25lID0+IHsKICAgICAgICAgICAgICAgIC8vIHplcm8gbWVhbnMgTm9uZQogICAgICAgICAgICAgICAgYnVmLnB1dF91OCgwKTsKICAgICAgICAgICAgICAgIGxlbiArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZW4KICAgIH0KCiAgICBmbiBmcm9tX2NvbXBhY3QobXV0IGJ1ZjogJlt1OF0sIF9sZW46IHVzaXplKSAtPiAoU2VsZiwgJlt1OF0pIHsKICAgICAgICB1c2UgYnl0ZXM6OkJ1ZjsKICAgICAgICBsZXQgdGFyZ2V0X2Jsb2NrID0gYnVmLmdldF91NjQoKTsKCiAgICAgICAgbGV0IGxhc3RfYWNjb3VudF9rZXkgPSBCMjU2Ojpmcm9tX3NsaWNlKCZidWZbLi4zMl0pOwogICAgICAgIGJ1Zi5hZHZhbmNlKDMyKTsKCiAgICAgICAgbGV0IHdhbGtlcl9zdGFja19sZW4gPSBidWYuZ2V0X3UxNigpIGFzIHVzaXplOwogICAgICAgIGxldCBtdXQgd2Fsa2VyX3N0YWNrID0gVmVjOjp3aXRoX2NhcGFjaXR5KHdhbGtlcl9zdGFja19sZW4pOwogICAgICAgIGZvciBfIGluIDAuLndhbGtlcl9zdGFja19sZW4gewogICAgICAgICAgICBsZXQgKGl0ZW0sIHJlc3QpID0gU3RvcmVkU3ViTm9kZTo6ZnJvbV9jb21wYWN0KGJ1ZiwgMCk7CiAgICAgICAgICAgIHdhbGtlcl9zdGFjay5wdXNoKGl0ZW0pOwogICAgICAgICAgICBidWYgPSByZXN0OwogICAgICAgIH0KCiAgICAgICAgbGV0IChzdGF0ZSwgbXV0IGJ1ZikgPSBIYXNoQnVpbGRlclN0YXRlOjpmcm9tX2NvbXBhY3QoYnVmLCAwKTsKCiAgICAgICAgLy8gRGVjb2RlIHRoZSBzdG9yYWdlIHJvb3QgY2hlY2twb2ludCBpZiBpdCBleGlzdHMKICAgICAgICBsZXQgKHN0b3JhZ2Vfcm9vdF9jaGVja3BvaW50LCBidWYpID0gaWYgYnVmLmlzX2VtcHR5KCkgewogICAgICAgICAgICAoTm9uZSwgYnVmKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1hdGNoIGJ1Zi5nZXRfdTgoKSB7CiAgICAgICAgICAgICAgICAxID0+IHsKICAgICAgICAgICAgICAgICAgICBsZXQgKGNoZWNrcG9pbnQsIHJlc3QpID0gU3RvcmFnZVJvb3RNZXJrbGVDaGVja3BvaW50Ojpmcm9tX2NvbXBhY3QoYnVmLCAwKTsKICAgICAgICAgICAgICAgICAgICAoU29tZShjaGVja3BvaW50KSwgcmVzdCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF8gPT4gKE5vbmUsIGJ1ZiksCiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAoU2VsZiB7IHRhcmdldF9ibG9jaywgbGFzdF9hY2NvdW50X2tleSwgd2Fsa2VyX3N0YWNrLCBzdGF0ZSwgc3RvcmFnZV9yb290X2NoZWNrcG9pbnQgfSwgYnVmKQogICAgfQp9CgovLy8gU2F2ZXMgdGhlIHByb2dyZXNzIG9mIGEgc3RvcmFnZSByb290IGNvbXB1dGF0aW9uLgovLy8KLy8vIFRoaXMgY29udGFpbnMgdGhlIHdhbGtlciBzdGFjaywgaGFzaCBidWlsZGVyIHN0YXRlLCBhbmQgdGhlIGxhc3Qgc3RvcmFnZSBrZXkgcHJvY2Vzc2VkLgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIFBhcnRpYWxFcSwgRXEpXQpwdWIgc3RydWN0IFN0b3JhZ2VSb290TWVya2xlQ2hlY2twb2ludCB7CiAgICAvLy8gVGhlIGxhc3Qgc3RvcmFnZSBrZXkgcHJvY2Vzc2VkLgogICAgcHViIGxhc3Rfc3RvcmFnZV9rZXk6IEIyNTYsCiAgICAvLy8gUHJldmlvdXNseSByZWNvcmRlZCB3YWxrZXIgc3RhY2suCiAgICBwdWIgd2Fsa2VyX3N0YWNrOiBWZWM8U3RvcmVkU3ViTm9kZT4sCiAgICAvLy8gVGhlIGhhc2ggYnVpbGRlciBzdGF0ZS4KICAgIHB1YiBzdGF0ZTogSGFzaEJ1aWxkZXJTdGF0ZSwKICAgIC8vLyBUaGUgYWNjb3VudCBub25jZS4KICAgIHB1YiBhY2NvdW50X25vbmNlOiB1NjQsCiAgICAvLy8gVGhlIGFjY291bnQgYmFsYW5jZS4KICAgIHB1YiBhY2NvdW50X2JhbGFuY2U6IFUyNTYsCiAgICAvLy8gVGhlIGFjY291bnQgYnl0ZWNvZGUgaGFzaC4KICAgIHB1YiBhY2NvdW50X2J5dGVjb2RlX2hhc2g6IEIyNTYsCn0KCmltcGwgU3RvcmFnZVJvb3RNZXJrbGVDaGVja3BvaW50IHsKICAgIC8vLyBDcmVhdGVzIGEgbmV3IHN0b3JhZ2Ugcm9vdCBtZXJrbGUgY2hlY2twb2ludC4KICAgIHB1YiBjb25zdCBmbiBuZXcoCiAgICAgICAgbGFzdF9zdG9yYWdlX2tleTogQjI1NiwKICAgICAgICB3YWxrZXJfc3RhY2s6IFZlYzxTdG9yZWRTdWJOb2RlPiwKICAgICAgICBzdGF0ZTogSGFzaEJ1aWxkZXJTdGF0ZSwKICAgICAgICBhY2NvdW50X25vbmNlOiB1NjQsCiAgICAgICAgYWNjb3VudF9iYWxhbmNlOiBVMjU2LAogICAgICAgIGFjY291bnRfYnl0ZWNvZGVfaGFzaDogQjI1NiwKICAgICkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIGxhc3Rfc3RvcmFnZV9rZXksCiAgICAgICAgICAgIHdhbGtlcl9zdGFjaywKICAgICAgICAgICAgc3RhdGUsCiAgICAgICAgICAgIGFjY291bnRfbm9uY2UsCiAgICAgICAgICAgIGFjY291bnRfYmFsYW5jZSwKICAgICAgICAgICAgYWNjb3VudF9ieXRlY29kZV9oYXNoLAogICAgICAgIH0KICAgIH0KfQoKI1tjZmcoYW55KHRlc3QsIGZlYXR1cmUgPSAicmV0aC1jb2RlYyIpKV0KaW1wbCByZXRoX2NvZGVjczo6Q29tcGFjdCBmb3IgU3RvcmFnZVJvb3RNZXJrbGVDaGVja3BvaW50IHsKICAgIGZuIHRvX2NvbXBhY3Q8Qj4oJnNlbGYsIGJ1ZjogJm11dCBCKSAtPiB1c2l6ZQogICAgd2hlcmUKICAgICAgICBCOiBieXRlczo6QnVmTXV0ICsgQXNNdXQ8W3U4XT4sCiAgICB7CiAgICAgICAgbGV0IG11dCBsZW4gPSAwOwoKICAgICAgICBidWYucHV0X3NsaWNlKHNlbGYubGFzdF9zdG9yYWdlX2tleS5hc19zbGljZSgpKTsKICAgICAgICBsZW4gKz0gc2VsZi5sYXN0X3N0b3JhZ2Vfa2V5LmxlbigpOwoKICAgICAgICBidWYucHV0X3UxNihzZWxmLndhbGtlcl9zdGFjay5sZW4oKSBhcyB1MTYpOwogICAgICAgIGxlbiArPSAyOwogICAgICAgIGZvciBpdGVtIGluICZzZWxmLndhbGtlcl9zdGFjayB7CiAgICAgICAgICAgIGxlbiArPSBpdGVtLnRvX2NvbXBhY3QoYnVmKTsKICAgICAgICB9CgogICAgICAgIGxlbiArPSBzZWxmLnN0YXRlLnRvX2NvbXBhY3QoYnVmKTsKCiAgICAgICAgLy8gRW5jb2RlIGFjY291bnQgZmllbGRzCiAgICAgICAgYnVmLnB1dF91NjQoc2VsZi5hY2NvdW50X25vbmNlKTsKICAgICAgICBsZW4gKz0gODsKCiAgICAgICAgbGV0IGJhbGFuY2VfbGVuID0gc2VsZi5hY2NvdW50X2JhbGFuY2UuYnl0ZV9sZW4oKSBhcyB1ODsKICAgICAgICBidWYucHV0X3U4KGJhbGFuY2VfbGVuKTsKICAgICAgICBsZW4gKz0gMTsKICAgICAgICBsZW4gKz0gc2VsZi5hY2NvdW50X2JhbGFuY2UudG9fY29tcGFjdChidWYpOwoKICAgICAgICBidWYucHV0X3NsaWNlKHNlbGYuYWNjb3VudF9ieXRlY29kZV9oYXNoLmFzX3NsaWNlKCkpOwogICAgICAgIGxlbiArPSAzMjsKCiAgICAgICAgbGVuCiAgICB9CgogICAgZm4gZnJvbV9jb21wYWN0KG11dCBidWY6ICZbdThdLCBfbGVuOiB1c2l6ZSkgLT4gKFNlbGYsICZbdThdKSB7CiAgICAgICAgdXNlIGJ5dGVzOjpCdWY7CgogICAgICAgIGxldCBsYXN0X3N0b3JhZ2Vfa2V5ID0gQjI1Njo6ZnJvbV9zbGljZSgmYnVmWy4uMzJdKTsKICAgICAgICBidWYuYWR2YW5jZSgzMik7CgogICAgICAgIGxldCB3YWxrZXJfc3RhY2tfbGVuID0gYnVmLmdldF91MTYoKSBhcyB1c2l6ZTsKICAgICAgICBsZXQgbXV0IHdhbGtlcl9zdGFjayA9IFZlYzo6d2l0aF9jYXBhY2l0eSh3YWxrZXJfc3RhY2tfbGVuKTsKICAgICAgICBmb3IgXyBpbiAwLi53YWxrZXJfc3RhY2tfbGVuIHsKICAgICAgICAgICAgbGV0IChpdGVtLCByZXN0KSA9IFN0b3JlZFN1Yk5vZGU6OmZyb21fY29tcGFjdChidWYsIDApOwogICAgICAgICAgICB3YWxrZXJfc3RhY2sucHVzaChpdGVtKTsKICAgICAgICAgICAgYnVmID0gcmVzdDsKICAgICAgICB9CgogICAgICAgIGxldCAoc3RhdGUsIG11dCBidWYpID0gSGFzaEJ1aWxkZXJTdGF0ZTo6ZnJvbV9jb21wYWN0KGJ1ZiwgMCk7CgogICAgICAgIC8vIERlY29kZSBhY2NvdW50IGZpZWxkcwogICAgICAgIGxldCBhY2NvdW50X25vbmNlID0gYnVmLmdldF91NjQoKTsKICAgICAgICBsZXQgYmFsYW5jZV9sZW4gPSBidWYuZ2V0X3U4KCkgYXMgdXNpemU7CiAgICAgICAgbGV0IChhY2NvdW50X2JhbGFuY2UsIG11dCBidWYpID0gVTI1Njo6ZnJvbV9jb21wYWN0KGJ1ZiwgYmFsYW5jZV9sZW4pOwogICAgICAgIGxldCBhY2NvdW50X2J5dGVjb2RlX2hhc2ggPSBCMjU2Ojpmcm9tX3NsaWNlKCZidWZbLi4zMl0pOwogICAgICAgIGJ1Zi5hZHZhbmNlKDMyKTsKCiAgICAgICAgKAogICAgICAgICAgICBTZWxmIHsKICAgICAgICAgICAgICAgIGxhc3Rfc3RvcmFnZV9rZXksCiAgICAgICAgICAgICAgICB3YWxrZXJfc3RhY2ssCiAgICAgICAgICAgICAgICBzdGF0ZSwKICAgICAgICAgICAgICAgIGFjY291bnRfbm9uY2UsCiAgICAgICAgICAgICAgICBhY2NvdW50X2JhbGFuY2UsCiAgICAgICAgICAgICAgICBhY2NvdW50X2J5dGVjb2RlX2hhc2gsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJ1ZiwKICAgICAgICApCiAgICB9Cn0KCi8vLyBTYXZlcyB0aGUgcHJvZ3Jlc3Mgb2YgYEFjY291bnRIYXNoaW5nYCBzdGFnZS4KI1tkZXJpdmUoRGVmYXVsdCwgRGVidWcsIENvcHksIENsb25lLCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihhbnkodGVzdCwgZmVhdHVyZSA9ICJ0ZXN0LXV0aWxzIiksIGRlcml2ZShhcmJpdHJhcnk6OkFyYml0cmFyeSkpXQojW2NmZ19hdHRyKGFueSh0ZXN0LCBmZWF0dXJlID0gInJldGgtY29kZWMiKSwgZGVyaXZlKHJldGhfY29kZWNzOjpDb21wYWN0KSldCiNbY2ZnX2F0dHIoYW55KHRlc3QsIGZlYXR1cmUgPSAicmV0aC1jb2RlYyIpLCByZXRoX2NvZGVjczo6YWRkX2FyYml0cmFyeV90ZXN0cyhjb21wYWN0KSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpKV0KcHViIHN0cnVjdCBBY2NvdW50SGFzaGluZ0NoZWNrcG9pbnQgewogICAgLy8vIFRoZSBuZXh0IGFjY291bnQgdG8gc3RhcnQgaGFzaGluZyBmcm9tLgogICAgcHViIGFkZHJlc3M6IE9wdGlvbjxBZGRyZXNzPiwKICAgIC8vLyBCbG9jayByYW5nZSB3aGljaCB0aGlzIGNoZWNrcG9pbnQgaXMgdmFsaWQgZm9yLgogICAgcHViIGJsb2NrX3JhbmdlOiBDaGVja3BvaW50QmxvY2tSYW5nZSwKICAgIC8vLyBQcm9ncmVzcyBtZWFzdXJlZCBpbiBhY2NvdW50cy4KICAgIHB1YiBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50LAp9CgovLy8gU2F2ZXMgdGhlIHByb2dyZXNzIG9mIGBTdG9yYWdlSGFzaGluZ2Agc3RhZ2UuCiNbZGVyaXZlKERlZmF1bHQsIERlYnVnLCBDb3B5LCBDbG9uZSwgUGFydGlhbEVxLCBFcSldCiNbY2ZnX2F0dHIoYW55KHRlc3QsIGZlYXR1cmUgPSAidGVzdC11dGlscyIpLCBkZXJpdmUoYXJiaXRyYXJ5OjpBcmJpdHJhcnkpKV0KI1tjZmdfYXR0cihhbnkodGVzdCwgZmVhdHVyZSA9ICJyZXRoLWNvZGVjIiksIGRlcml2ZShyZXRoX2NvZGVjczo6Q29tcGFjdCkpXQojW2NmZ19hdHRyKGFueSh0ZXN0LCBmZWF0dXJlID0gInJldGgtY29kZWMiKSwgcmV0aF9jb2RlY3M6OmFkZF9hcmJpdHJhcnlfdGVzdHMoY29tcGFjdCkpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCnB1YiBzdHJ1Y3QgU3RvcmFnZUhhc2hpbmdDaGVja3BvaW50IHsKICAgIC8vLyBUaGUgbmV4dCBhY2NvdW50IHRvIHN0YXJ0IGhhc2hpbmcgZnJvbS4KICAgIHB1YiBhZGRyZXNzOiBPcHRpb248QWRkcmVzcz4sCiAgICAvLy8gVGhlIG5leHQgc3RvcmFnZSBzbG90IHRvIHN0YXJ0IGhhc2hpbmcgZnJvbS4KICAgIHB1YiBzdG9yYWdlOiBPcHRpb248QjI1Nj4sCiAgICAvLy8gQmxvY2sgcmFuZ2Ugd2hpY2ggdGhpcyBjaGVja3BvaW50IGlzIHZhbGlkIGZvci4KICAgIHB1YiBibG9ja19yYW5nZTogQ2hlY2twb2ludEJsb2NrUmFuZ2UsCiAgICAvLy8gUHJvZ3Jlc3MgbWVhc3VyZWQgaW4gc3RvcmFnZSBzbG90cy4KICAgIHB1YiBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50LAp9CgovLy8gU2F2ZXMgdGhlIHByb2dyZXNzIG9mIEV4ZWN1dGlvbiBzdGFnZS4KI1tkZXJpdmUoRGVmYXVsdCwgRGVidWcsIENvcHksIENsb25lLCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihhbnkodGVzdCwgZmVhdHVyZSA9ICJ0ZXN0LXV0aWxzIiksIGRlcml2ZShhcmJpdHJhcnk6OkFyYml0cmFyeSkpXQojW2NmZ19hdHRyKGFueSh0ZXN0LCBmZWF0dXJlID0gInJldGgtY29kZWMiKSwgZGVyaXZlKHJldGhfY29kZWNzOjpDb21wYWN0KSldCiNbY2ZnX2F0dHIoYW55KHRlc3QsIGZlYXR1cmUgPSAicmV0aC1jb2RlYyIpLCByZXRoX2NvZGVjczo6YWRkX2FyYml0cmFyeV90ZXN0cyhjb21wYWN0KSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpKV0KcHViIHN0cnVjdCBFeGVjdXRpb25DaGVja3BvaW50IHsKICAgIC8vLyBCbG9jayByYW5nZSB3aGljaCB0aGlzIGNoZWNrcG9pbnQgaXMgdmFsaWQgZm9yLgogICAgcHViIGJsb2NrX3JhbmdlOiBDaGVja3BvaW50QmxvY2tSYW5nZSwKICAgIC8vLyBQcm9ncmVzcyBtZWFzdXJlZCBpbiBnYXMuCiAgICBwdWIgcHJvZ3Jlc3M6IEVudGl0aWVzQ2hlY2twb2ludCwKfQoKLy8vIFNhdmVzIHRoZSBwcm9ncmVzcyBvZiBIZWFkZXJzIHN0YWdlLgojW2Rlcml2ZShEZWZhdWx0LCBEZWJ1ZywgQ29weSwgQ2xvbmUsIFBhcnRpYWxFcSwgRXEpXQojW2NmZ19hdHRyKGFueSh0ZXN0LCBmZWF0dXJlID0gInRlc3QtdXRpbHMiKSwgZGVyaXZlKGFyYml0cmFyeTo6QXJiaXRyYXJ5KSldCiNbY2ZnX2F0dHIoYW55KHRlc3QsIGZlYXR1cmUgPSAicmV0aC1jb2RlYyIpLCBkZXJpdmUocmV0aF9jb2RlY3M6OkNvbXBhY3QpKV0KI1tjZmdfYXR0cihhbnkodGVzdCwgZmVhdHVyZSA9ICJyZXRoLWNvZGVjIiksIHJldGhfY29kZWNzOjphZGRfYXJiaXRyYXJ5X3Rlc3RzKGNvbXBhY3QpKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgZGVyaXZlKHNlcmRlOjpTZXJpYWxpemUsIHNlcmRlOjpEZXNlcmlhbGl6ZSkpXQpwdWIgc3RydWN0IEhlYWRlcnNDaGVja3BvaW50IHsKICAgIC8vLyBCbG9jayByYW5nZSB3aGljaCB0aGlzIGNoZWNrcG9pbnQgaXMgdmFsaWQgZm9yLgogICAgcHViIGJsb2NrX3JhbmdlOiBDaGVja3BvaW50QmxvY2tSYW5nZSwKICAgIC8vLyBQcm9ncmVzcyBtZWFzdXJlZCBpbiBnYXMuCiAgICBwdWIgcHJvZ3Jlc3M6IEVudGl0aWVzQ2hlY2twb2ludCwKfQoKLy8vIFNhdmVzIHRoZSBwcm9ncmVzcyBvZiBJbmRleCBIaXN0b3J5IHN0YWdlcy4KI1tkZXJpdmUoRGVmYXVsdCwgRGVidWcsIENvcHksIENsb25lLCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihhbnkodGVzdCwgZmVhdHVyZSA9ICJ0ZXN0LXV0aWxzIiksIGRlcml2ZShhcmJpdHJhcnk6OkFyYml0cmFyeSkpXQojW2NmZ19hdHRyKGFueSh0ZXN0LCBmZWF0dXJlID0gInJldGgtY29kZWMiKSwgZGVyaXZlKHJldGhfY29kZWNzOjpDb21wYWN0KSldCiNbY2ZnX2F0dHIoYW55KHRlc3QsIGZlYXR1cmUgPSAicmV0aC1jb2RlYyIpLCByZXRoX2NvZGVjczo6YWRkX2FyYml0cmFyeV90ZXN0cyhjb21wYWN0KSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpKV0KcHViIHN0cnVjdCBJbmRleEhpc3RvcnlDaGVja3BvaW50IHsKICAgIC8vLyBCbG9jayByYW5nZSB3aGljaCB0aGlzIGNoZWNrcG9pbnQgaXMgdmFsaWQgZm9yLgogICAgcHViIGJsb2NrX3JhbmdlOiBDaGVja3BvaW50QmxvY2tSYW5nZSwKICAgIC8vLyBQcm9ncmVzcyBtZWFzdXJlZCBpbiBjaGFuZ2VzZXRzLgogICAgcHViIHByb2dyZXNzOiBFbnRpdGllc0NoZWNrcG9pbnQsCn0KCi8vLyBTYXZlcyB0aGUgcHJvZ3Jlc3Mgb2YgYE1lcmtsZUNoYW5nZVNldHNgIHN0YWdlLgovLy8KLy8vIE5vdGU6IFRoaXMgdHlwZSBpcyBvbmx5IGtlcHQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgd2l0aCB0aGUgQ29tcGFjdCBjb2RlYy4KLy8vIFRoZSBgTWVya2xlQ2hhbmdlU2V0c2Agc3RhZ2UgaGFzIGJlZW4gcmVtb3ZlZC4KI1tkZXJpdmUoRGVmYXVsdCwgRGVidWcsIENvcHksIENsb25lLCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihhbnkodGVzdCwgZmVhdHVyZSA9ICJ0ZXN0LXV0aWxzIiksIGRlcml2ZShhcmJpdHJhcnk6OkFyYml0cmFyeSkpXQojW2NmZ19hdHRyKGFueSh0ZXN0LCBmZWF0dXJlID0gInJldGgtY29kZWMiKSwgZGVyaXZlKHJldGhfY29kZWNzOjpDb21wYWN0KSldCiNbY2ZnX2F0dHIoYW55KHRlc3QsIGZlYXR1cmUgPSAicmV0aC1jb2RlYyIpLCByZXRoX2NvZGVjczo6YWRkX2FyYml0cmFyeV90ZXN0cyhjb21wYWN0KSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpKV0KcHViIHN0cnVjdCBNZXJrbGVDaGFuZ2VTZXRzQ2hlY2twb2ludCB7CiAgICAvLy8gQmxvY2sgcmFuZ2Ugd2hpY2ggdGhpcyBjaGVja3BvaW50IGlzIHZhbGlkIGZvci4KICAgIHB1YiBibG9ja19yYW5nZTogQ2hlY2twb2ludEJsb2NrUmFuZ2UsCn0KCi8vLyBTYXZlcyB0aGUgcHJvZ3Jlc3Mgb2YgYWJzdHJhY3Qgc3RhZ2UgaXRlcmF0aW5nIG92ZXIgb3IgZG93bmxvYWRpbmcgZW50aXRpZXMuCiNbZGVyaXZlKERlYnVnLCBEZWZhdWx0LCBQYXJ0aWFsRXEsIEVxLCBDbG9uZSwgQ29weSldCiNbY2ZnX2F0dHIoYW55KHRlc3QsIGZlYXR1cmUgPSAidGVzdC11dGlscyIpLCBkZXJpdmUoYXJiaXRyYXJ5OjpBcmJpdHJhcnkpKV0KI1tjZmdfYXR0cihhbnkodGVzdCwgZmVhdHVyZSA9ICJyZXRoLWNvZGVjIiksIGRlcml2ZShyZXRoX2NvZGVjczo6Q29tcGFjdCkpXQojW2NmZ19hdHRyKGFueSh0ZXN0LCBmZWF0dXJlID0gInJldGgtY29kZWMiKSwgcmV0aF9jb2RlY3M6OmFkZF9hcmJpdHJhcnlfdGVzdHMoY29tcGFjdCkpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCnB1YiBzdHJ1Y3QgRW50aXRpZXNDaGVja3BvaW50IHsKICAgIC8vLyBOdW1iZXIgb2YgZW50aXRpZXMgYWxyZWFkeSBwcm9jZXNzZWQuCiAgICBwdWIgcHJvY2Vzc2VkOiB1NjQsCiAgICAvLy8gVG90YWwgZW50aXRpZXMgdG8gYmUgcHJvY2Vzc2VkLgogICAgcHViIHRvdGFsOiB1NjQsCn0KCmltcGwgRW50aXRpZXNDaGVja3BvaW50IHsKICAgIC8vLyBGb3JtYXRzIGVudGl0aWVzIGNoZWNrcG9pbnQgYXMgcGVyY2VudGFnZSwgaS5lLiBgcHJvY2Vzc2VkIC8gdG90YWxgLgogICAgLy8vCiAgICAvLy8gUmV0dXJuIFtOb25lXSBpZiBgdG90YWwgPT0gMGAuCiAgICBwdWIgZm4gZm10X3BlcmNlbnRhZ2UoJnNlbGYpIC0+IE9wdGlvbjxTdHJpbmc+IHsKICAgICAgICBpZiBzZWxmLnRvdGFsID09IDAgewogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIH0KCiAgICAgICAgLy8gQ2FsY3VsYXRlIHBlcmNlbnRhZ2Ugd2l0aCAyIGRlY2ltYWwgcGxhY2VzLgogICAgICAgIGxldCBwZXJjZW50YWdlID0gMTAwLjAgKiBzZWxmLnByb2Nlc3NlZCBhcyBmNjQgLyBzZWxmLnRvdGFsIGFzIGY2NDsKCiAgICAgICAgLy8gVHJ1bmNhdGUgdG8gMiBkZWNpbWFsIHBsYWNlcywgcm91bmRpbmcgZG93biBzbyB0aGF0IDk5Ljk5OSUgYmVjb21lcyA5OS45OSUgYW5kIG5vdCAxMDAlLgogICAgICAgICNbY2ZnKG5vdChmZWF0dXJlID0gInN0ZCIpKV0KICAgICAgICB7CiAgICAgICAgICAgIC8vIE1hbnVhbCBmbG9vciBpbXBsZW1lbnRhdGlvbiB1c2luZyBpbnRlZ2VyIGFyaXRobWV0aWMgZm9yIG5vX3N0ZAogICAgICAgICAgICBsZXQgc2NhbGVkID0gKHBlcmNlbnRhZ2UgKiAxMDAuMCkgYXMgdTY0OwogICAgICAgICAgICBTb21lKGZvcm1hdCEoIns6LjJ9JSIsIHNjYWxlZCBhcyBmNjQgLyAxMDAuMCkpCiAgICAgICAgfQogICAgICAgICNbY2ZnKGZlYXR1cmUgPSAic3RkIildCiAgICAgICAgU29tZShmb3JtYXQhKCJ7Oi4yfSUiLCAocGVyY2VudGFnZSAqIDEwMC4wKS5mbG9vcigpIC8gMTAwLjApKQogICAgfQp9CgovLy8gU2F2ZXMgdGhlIGJsb2NrIHJhbmdlLiBVc3VhbGx5LCBpdCdzIHVzZWQgdG8gY2hlY2sgdGhlIHZhbGlkaXR5IG9mIHNvbWUgc3RhZ2UgY2hlY2twb2ludCBhY3Jvc3MKLy8vIG11bHRpcGxlIGV4ZWN1dGlvbnMuCiNbZGVyaXZlKERlZmF1bHQsIERlYnVnLCBDb3B5LCBDbG9uZSwgUGFydGlhbEVxLCBFcSldCiNbY2ZnX2F0dHIoYW55KHRlc3QsIGZlYXR1cmUgPSAidGVzdC11dGlscyIpLCBkZXJpdmUoYXJiaXRyYXJ5OjpBcmJpdHJhcnkpKV0KI1tjZmdfYXR0cihhbnkodGVzdCwgZmVhdHVyZSA9ICJyZXRoLWNvZGVjIiksIGRlcml2ZShyZXRoX2NvZGVjczo6Q29tcGFjdCkpXQojW2NmZ19hdHRyKGFueSh0ZXN0LCBmZWF0dXJlID0gInJldGgtY29kZWMiKSwgcmV0aF9jb2RlY3M6OmFkZF9hcmJpdHJhcnlfdGVzdHMoY29tcGFjdCkpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCnB1YiBzdHJ1Y3QgQ2hlY2twb2ludEJsb2NrUmFuZ2UgewogICAgLy8vIFRoZSBmaXJzdCBibG9jayBvZiB0aGUgcmFuZ2UsIGluY2x1c2l2ZS4KICAgIHB1YiBmcm9tOiBCbG9ja051bWJlciwKICAgIC8vLyBUaGUgbGFzdCBibG9jayBvZiB0aGUgcmFuZ2UsIGluY2x1c2l2ZS4KICAgIHB1YiB0bzogQmxvY2tOdW1iZXIsCn0KCmltcGwgRnJvbTxSYW5nZUluY2x1c2l2ZTxCbG9ja051bWJlcj4+IGZvciBDaGVja3BvaW50QmxvY2tSYW5nZSB7CiAgICBmbiBmcm9tKHJhbmdlOiBSYW5nZUluY2x1c2l2ZTxCbG9ja051bWJlcj4pIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBmcm9tOiAqcmFuZ2Uuc3RhcnQoKSwgdG86ICpyYW5nZS5lbmQoKSB9CiAgICB9Cn0KCmltcGwgRnJvbTwmUmFuZ2VJbmNsdXNpdmU8QmxvY2tOdW1iZXI+PiBmb3IgQ2hlY2twb2ludEJsb2NrUmFuZ2UgewogICAgZm4gZnJvbShyYW5nZTogJlJhbmdlSW5jbHVzaXZlPEJsb2NrTnVtYmVyPikgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGZyb206ICpyYW5nZS5zdGFydCgpLCB0bzogKnJhbmdlLmVuZCgpIH0KICAgIH0KfQoKLy8vIFNhdmVzIHRoZSBwcm9ncmVzcyBvZiBhIHN0YWdlLgojW2Rlcml2ZShEZWJ1ZywgRGVmYXVsdCwgUGFydGlhbEVxLCBFcSwgQ2xvbmUsIENvcHkpXQojW2NmZ19hdHRyKGFueSh0ZXN0LCBmZWF0dXJlID0gInRlc3QtdXRpbHMiKSwgZGVyaXZlKGFyYml0cmFyeTo6QXJiaXRyYXJ5KSldCiNbY2ZnX2F0dHIoYW55KHRlc3QsIGZlYXR1cmUgPSAicmV0aC1jb2RlYyIpLCBkZXJpdmUocmV0aF9jb2RlY3M6OkNvbXBhY3QpKV0KI1tjZmdfYXR0cihhbnkodGVzdCwgZmVhdHVyZSA9ICJyZXRoLWNvZGVjIiksIHJldGhfY29kZWNzOjphZGRfYXJiaXRyYXJ5X3Rlc3RzKGNvbXBhY3QpKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgZGVyaXZlKHNlcmRlOjpTZXJpYWxpemUsIHNlcmRlOjpEZXNlcmlhbGl6ZSkpXQpwdWIgc3RydWN0IFN0YWdlQ2hlY2twb2ludCB7CiAgICAvLy8gVGhlIG1heGltdW0gYmxvY2sgcHJvY2Vzc2VkIGJ5IHRoZSBzdGFnZS4KICAgIHB1YiBibG9ja19udW1iZXI6IEJsb2NrTnVtYmVyLAogICAgLy8vIFN0YWdlLXNwZWNpZmljIGNoZWNrcG9pbnQuIE5vbmUgaWYgc3RhZ2UgdXNlcyBvbmx5IGJsb2NrLWJhc2VkIGNoZWNrcG9pbnRzLgogICAgcHViIHN0YWdlX2NoZWNrcG9pbnQ6IE9wdGlvbjxTdGFnZVVuaXRDaGVja3BvaW50PiwKfQoKaW1wbCBTdGFnZUNoZWNrcG9pbnQgewogICAgLy8vIENyZWF0ZXMgYSBuZXcgW2BTdGFnZUNoZWNrcG9pbnRgXSB3aXRoIG9ubHkgYGJsb2NrX251bWJlcmAgc2V0LgogICAgcHViIGZuIG5ldyhibG9ja19udW1iZXI6IEJsb2NrTnVtYmVyKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgYmxvY2tfbnVtYmVyLCAuLkRlZmF1bHQ6OmRlZmF1bHQoKSB9CiAgICB9CgogICAgLy8vIFNldHMgdGhlIGJsb2NrIG51bWJlci4KICAgIHB1YiBjb25zdCBmbiB3aXRoX2Jsb2NrX251bWJlcihtdXQgc2VsZiwgYmxvY2tfbnVtYmVyOiBCbG9ja051bWJlcikgLT4gU2VsZiB7CiAgICAgICAgc2VsZi5ibG9ja19udW1iZXIgPSBibG9ja19udW1iZXI7CiAgICAgICAgc2VsZgogICAgfQoKICAgIC8vLyBTZXRzIHRoZSBibG9jayByYW5nZSwgaWYgY2hlY2twb2ludCB1c2VzIGJsb2NrIHJhbmdlLgogICAgcHViIGZuIHdpdGhfYmxvY2tfcmFuZ2UobXV0IHNlbGYsIHN0YWdlX2lkOiAmU3RhZ2VJZCwgZnJvbTogdTY0LCB0bzogdTY0KSAtPiBTZWxmIHsKICAgICAgICBzZWxmLnN0YWdlX2NoZWNrcG9pbnQgPSBTb21lKG1hdGNoIHN0YWdlX2lkIHsKICAgICAgICAgICAgU3RhZ2VJZDo6RXhlY3V0aW9uID0+IFN0YWdlVW5pdENoZWNrcG9pbnQ6OkV4ZWN1dGlvbihFeGVjdXRpb25DaGVja3BvaW50OjpkZWZhdWx0KCkpLAogICAgICAgICAgICBTdGFnZUlkOjpBY2NvdW50SGFzaGluZyA9PiB7CiAgICAgICAgICAgICAgICBTdGFnZVVuaXRDaGVja3BvaW50OjpBY2NvdW50KEFjY291bnRIYXNoaW5nQ2hlY2twb2ludDo6ZGVmYXVsdCgpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIFN0YWdlSWQ6OlN0b3JhZ2VIYXNoaW5nID0+IHsKICAgICAgICAgICAgICAgIFN0YWdlVW5pdENoZWNrcG9pbnQ6OlN0b3JhZ2UoU3RvcmFnZUhhc2hpbmdDaGVja3BvaW50OjpkZWZhdWx0KCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgU3RhZ2VJZDo6SW5kZXhTdG9yYWdlSGlzdG9yeSB8IFN0YWdlSWQ6OkluZGV4QWNjb3VudEhpc3RvcnkgPT4gewogICAgICAgICAgICAgICAgU3RhZ2VVbml0Q2hlY2twb2ludDo6SW5kZXhIaXN0b3J5KEluZGV4SGlzdG9yeUNoZWNrcG9pbnQ6OmRlZmF1bHQoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IHJldHVybiBzZWxmLAogICAgICAgIH0pOwogICAgICAgIF8gPSBzZWxmLnN0YWdlX2NoZWNrcG9pbnQubWFwKHxtdXQgY2hlY2twb2ludHwgY2hlY2twb2ludC5zZXRfYmxvY2tfcmFuZ2UoZnJvbSwgdG8pKTsKICAgICAgICBzZWxmCiAgICB9CgogICAgLy8vIEdldCB0aGUgdW5kZXJseWluZyBbYEVudGl0aWVzQ2hlY2twb2ludGBdLCBpZiBhbnksIHRvIGRldGVybWluZSB0aGUgbnVtYmVyIG9mIGVudGl0aWVzCiAgICAvLy8gcHJvY2Vzc2VkLCBhbmQgdGhlIG51bWJlciBvZiB0b3RhbCBlbnRpdGllcyB0byBwcm9jZXNzLgogICAgcHViIGZuIGVudGl0aWVzKCZzZWxmKSAtPiBPcHRpb248RW50aXRpZXNDaGVja3BvaW50PiB7CiAgICAgICAgbGV0IHN0YWdlX2NoZWNrcG9pbnQgPSBzZWxmLnN0YWdlX2NoZWNrcG9pbnQ/OwoKICAgICAgICBtYXRjaCBzdGFnZV9jaGVja3BvaW50IHsKICAgICAgICAgICAgU3RhZ2VVbml0Q2hlY2twb2ludDo6QWNjb3VudChBY2NvdW50SGFzaGluZ0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgcHJvZ3Jlc3M6IGVudGl0aWVzLCAuLgogICAgICAgICAgICB9KSB8CiAgICAgICAgICAgIFN0YWdlVW5pdENoZWNrcG9pbnQ6OlN0b3JhZ2UoU3RvcmFnZUhhc2hpbmdDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgIHByb2dyZXNzOiBlbnRpdGllcywgLi4KICAgICAgICAgICAgfSkgfAogICAgICAgICAgICBTdGFnZVVuaXRDaGVja3BvaW50OjpFbnRpdGllcyhlbnRpdGllcykgfAogICAgICAgICAgICBTdGFnZVVuaXRDaGVja3BvaW50OjpFeGVjdXRpb24oRXhlY3V0aW9uQ2hlY2twb2ludCB7IHByb2dyZXNzOiBlbnRpdGllcywgLi4gfSkgfAogICAgICAgICAgICBTdGFnZVVuaXRDaGVja3BvaW50OjpIZWFkZXJzKEhlYWRlcnNDaGVja3BvaW50IHsgcHJvZ3Jlc3M6IGVudGl0aWVzLCAuLiB9KSB8CiAgICAgICAgICAgIFN0YWdlVW5pdENoZWNrcG9pbnQ6OkluZGV4SGlzdG9yeShJbmRleEhpc3RvcnlDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgIHByb2dyZXNzOiBlbnRpdGllcywKICAgICAgICAgICAgICAgIC4uCiAgICAgICAgICAgIH0pID0+IFNvbWUoZW50aXRpZXMpLAogICAgICAgICAgICBTdGFnZVVuaXRDaGVja3BvaW50OjpNZXJrbGVDaGFuZ2VTZXRzKF8pID0+IE5vbmUsCiAgICAgICAgfQogICAgfQp9CgovLyBUT0RPKGFsZXhleSk6IGFkZCBhIG1lcmtsZSBjaGVja3BvaW50LiBDdXJyZW50bHkgaXQncyBoYXJkIGJlY2F1c2UgW2BNZXJrbGVDaGVja3BvaW50YF0KLy8gIGlzIG5vdCBhIENvcHkgdHlwZS4KLy8vIFN0YWdlLXNwZWNpZmljIGNoZWNrcG9pbnQgbWV0cmljcy4KI1tkZXJpdmUoRGVidWcsIFBhcnRpYWxFcSwgRXEsIENsb25lLCBDb3B5KV0KI1tjZmdfYXR0cihhbnkodGVzdCwgZmVhdHVyZSA9ICJ0ZXN0LXV0aWxzIiksIGRlcml2ZShhcmJpdHJhcnk6OkFyYml0cmFyeSkpXQojW2NmZ19hdHRyKGFueSh0ZXN0LCBmZWF0dXJlID0gInJldGgtY29kZWMiKSwgZGVyaXZlKHJldGhfY29kZWNzOjpDb21wYWN0KSldCiNbY2ZnX2F0dHIoYW55KHRlc3QsIGZlYXR1cmUgPSAicmV0aC1jb2RlYyIpLCByZXRoX2NvZGVjczo6YWRkX2FyYml0cmFyeV90ZXN0cyhjb21wYWN0KSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpKV0KcHViIGVudW0gU3RhZ2VVbml0Q2hlY2twb2ludCB7CiAgICAvLy8gU2F2ZXMgdGhlIHByb2dyZXNzIG9mIGBBY2NvdW50SGFzaGluZ2Agc3RhZ2UuCiAgICBBY2NvdW50KEFjY291bnRIYXNoaW5nQ2hlY2twb2ludCksCiAgICAvLy8gU2F2ZXMgdGhlIHByb2dyZXNzIG9mIGBTdG9yYWdlSGFzaGluZ2Agc3RhZ2UuCiAgICBTdG9yYWdlKFN0b3JhZ2VIYXNoaW5nQ2hlY2twb2ludCksCiAgICAvLy8gU2F2ZXMgdGhlIHByb2dyZXNzIG9mIGFic3RyYWN0IHN0YWdlIGl0ZXJhdGluZyBvdmVyIG9yIGRvd25sb2FkaW5nIGVudGl0aWVzLgogICAgRW50aXRpZXMoRW50aXRpZXNDaGVja3BvaW50KSwKICAgIC8vLyBTYXZlcyB0aGUgcHJvZ3Jlc3Mgb2YgRXhlY3V0aW9uIHN0YWdlLgogICAgRXhlY3V0aW9uKEV4ZWN1dGlvbkNoZWNrcG9pbnQpLAogICAgLy8vIFNhdmVzIHRoZSBwcm9ncmVzcyBvZiBIZWFkZXJzIHN0YWdlLgogICAgSGVhZGVycyhIZWFkZXJzQ2hlY2twb2ludCksCiAgICAvLy8gU2F2ZXMgdGhlIHByb2dyZXNzIG9mIEluZGV4IEhpc3Rvcnkgc3RhZ2UuCiAgICBJbmRleEhpc3RvcnkoSW5kZXhIaXN0b3J5Q2hlY2twb2ludCksCiAgICAvLy8gU2F2ZXMgdGhlIHByb2dyZXNzIG9mIGBNZXJrbGVDaGFuZ2VTZXRzYCBzdGFnZS4KICAgIC8vLwogICAgLy8vIE5vdGU6IFRoaXMgdmFyaWFudCBpcyBvbmx5IGtlcHQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgd2l0aCB0aGUgQ29tcGFjdCBjb2RlYy4KICAgIC8vLyBUaGUgYE1lcmtsZUNoYW5nZVNldHNgIHN0YWdlIGhhcyBiZWVuIHJlbW92ZWQuCiAgICBNZXJrbGVDaGFuZ2VTZXRzKE1lcmtsZUNoYW5nZVNldHNDaGVja3BvaW50KSwKfQoKaW1wbCBTdGFnZVVuaXRDaGVja3BvaW50IHsKICAgIC8vLyBTZXRzIHRoZSBibG9jayByYW5nZS4gUmV0dXJucyBvbGQgYmxvY2sgcmFuZ2UsIG9yIGBOb25lYCBpZiBjaGVja3BvaW50IGRvZXNuJ3QgdXNlIGJsb2NrCiAgICAvLy8gcmFuZ2UuCiAgICBwdWIgY29uc3QgZm4gc2V0X2Jsb2NrX3JhbmdlKCZtdXQgc2VsZiwgZnJvbTogdTY0LCB0bzogdTY0KSAtPiBPcHRpb248Q2hlY2twb2ludEJsb2NrUmFuZ2U+IHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6QWNjb3VudChBY2NvdW50SGFzaGluZ0NoZWNrcG9pbnQgeyBibG9ja19yYW5nZSwgLi4gfSkgfAogICAgICAgICAgICBTZWxmOjpTdG9yYWdlKFN0b3JhZ2VIYXNoaW5nQ2hlY2twb2ludCB7IGJsb2NrX3JhbmdlLCAuLiB9KSB8CiAgICAgICAgICAgIFNlbGY6OkV4ZWN1dGlvbihFeGVjdXRpb25DaGVja3BvaW50IHsgYmxvY2tfcmFuZ2UsIC4uIH0pIHwKICAgICAgICAgICAgU2VsZjo6SW5kZXhIaXN0b3J5KEluZGV4SGlzdG9yeUNoZWNrcG9pbnQgeyBibG9ja19yYW5nZSwgLi4gfSkgPT4gewogICAgICAgICAgICAgICAgbGV0IG9sZF9yYW5nZSA9ICpibG9ja19yYW5nZTsKICAgICAgICAgICAgICAgICpibG9ja19yYW5nZSA9IENoZWNrcG9pbnRCbG9ja1JhbmdlIHsgZnJvbSwgdG8gfTsKCiAgICAgICAgICAgICAgICBTb21lKG9sZF9yYW5nZSkKICAgICAgICAgICAgfQogICAgICAgICAgICBfID0+IE5vbmUsCiAgICAgICAgfQogICAgfQp9CgojW2NmZyh0ZXN0KV0KaW1wbCBEZWZhdWx0IGZvciBTdGFnZVVuaXRDaGVja3BvaW50IHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmOjpBY2NvdW50KEFjY291bnRIYXNoaW5nQ2hlY2twb2ludDo6ZGVmYXVsdCgpKQogICAgfQp9CgovLy8gR2VuZXJhdGVzIFtgU3RhZ2VDaGVja3BvaW50YF0gZ2V0dGVyIGFuZCBidWlsZGVyIG1ldGhvZHMuCm1hY3JvX3J1bGVzISBzdGFnZV91bml0X2NoZWNrcG9pbnRzIHsKICAgICgkKCgkaW5kZXg6ZXhwciwkZW51bV92YXJpYW50OnR0LCRjaGVja3BvaW50X3R5OnR5LCNbZG9jID0gJGZuX2dldF9kb2M6ZXhwcl0kZm5fZ2V0X25hbWU6aWRlbnQsI1tkb2MgPSAkZm5fYnVpbGRfZG9jOmV4cHJdJGZuX2J1aWxkX25hbWU6aWRlbnQpKSwrKSA9PiB7CiAgICAgICAgaW1wbCBTdGFnZUNoZWNrcG9pbnQgewogICAgICAgICAgICAkKAogICAgICAgICAgICAgICAgI1tkb2MgPSAkZm5fZ2V0X2RvY10KICAgICAgICAgICAgICAgIHB1YiBjb25zdCBmbiAkZm5fZ2V0X25hbWUoJnNlbGYpIC0+IE9wdGlvbjwkY2hlY2twb2ludF90eT4gewogICAgICAgICAgICAgICAgICAgIG1hdGNoIHNlbGYuc3RhZ2VfY2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgICAgIFNvbWUoU3RhZ2VVbml0Q2hlY2twb2ludDo6JGVudW1fdmFyaWFudChjaGVja3BvaW50KSkgPT4gU29tZShjaGVja3BvaW50KSwKICAgICAgICAgICAgICAgICAgICAgICAgXyA9PiBOb25lLAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAjW2RvYyA9ICRmbl9idWlsZF9kb2NdCiAgICAgICAgICAgICAgICBwdWIgY29uc3QgZm4gJGZuX2J1aWxkX25hbWUoCiAgICAgICAgICAgICAgICAgICAgbXV0IHNlbGYsCiAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludDogJGNoZWNrcG9pbnRfdHksCiAgICAgICAgICAgICAgICApIC0+IFNlbGYgewogICAgICAgICAgICAgICAgICAgIHNlbGYuc3RhZ2VfY2hlY2twb2ludCA9IFNvbWUoU3RhZ2VVbml0Q2hlY2twb2ludDo6JGVudW1fdmFyaWFudChjaGVja3BvaW50KSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICApKwogICAgICAgIH0KICAgIH07Cn0KCnN0YWdlX3VuaXRfY2hlY2twb2ludHMhKAogICAgKAogICAgICAgIDAsCiAgICAgICAgQWNjb3VudCwKICAgICAgICBBY2NvdW50SGFzaGluZ0NoZWNrcG9pbnQsCiAgICAgICAgLy8vIFJldHVybnMgdGhlIGFjY291bnQgaGFzaGluZyBzdGFnZSBjaGVja3BvaW50LCBpZiBhbnkuCiAgICAgICAgYWNjb3VudF9oYXNoaW5nX3N0YWdlX2NoZWNrcG9pbnQsCiAgICAgICAgLy8vIFNldHMgdGhlIHN0YWdlIGNoZWNrcG9pbnQgdG8gYWNjb3VudCBoYXNoaW5nLgogICAgICAgIHdpdGhfYWNjb3VudF9oYXNoaW5nX3N0YWdlX2NoZWNrcG9pbnQKICAgICksCiAgICAoCiAgICAgICAgMSwKICAgICAgICBTdG9yYWdlLAogICAgICAgIFN0b3JhZ2VIYXNoaW5nQ2hlY2twb2ludCwKICAgICAgICAvLy8gUmV0dXJucyB0aGUgc3RvcmFnZSBoYXNoaW5nIHN0YWdlIGNoZWNrcG9pbnQsIGlmIGFueS4KICAgICAgICBzdG9yYWdlX2hhc2hpbmdfc3RhZ2VfY2hlY2twb2ludCwKICAgICAgICAvLy8gU2V0cyB0aGUgc3RhZ2UgY2hlY2twb2ludCB0byBzdG9yYWdlIGhhc2hpbmcuCiAgICAgICAgd2l0aF9zdG9yYWdlX2hhc2hpbmdfc3RhZ2VfY2hlY2twb2ludAogICAgKSwKICAgICgKICAgICAgICAyLAogICAgICAgIEVudGl0aWVzLAogICAgICAgIEVudGl0aWVzQ2hlY2twb2ludCwKICAgICAgICAvLy8gUmV0dXJucyB0aGUgZW50aXRpZXMgc3RhZ2UgY2hlY2twb2ludCwgaWYgYW55LgogICAgICAgIGVudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQsCiAgICAgICAgLy8vIFNldHMgdGhlIHN0YWdlIGNoZWNrcG9pbnQgdG8gZW50aXRpZXMuCiAgICAgICAgd2l0aF9lbnRpdGllc19zdGFnZV9jaGVja3BvaW50CiAgICApLAogICAgKAogICAgICAgIDMsCiAgICAgICAgRXhlY3V0aW9uLAogICAgICAgIEV4ZWN1dGlvbkNoZWNrcG9pbnQsCiAgICAgICAgLy8vIFJldHVybnMgdGhlIGV4ZWN1dGlvbiBzdGFnZSBjaGVja3BvaW50LCBpZiBhbnkuCiAgICAgICAgZXhlY3V0aW9uX3N0YWdlX2NoZWNrcG9pbnQsCiAgICAgICAgLy8vIFNldHMgdGhlIHN0YWdlIGNoZWNrcG9pbnQgdG8gZXhlY3V0aW9uLgogICAgICAgIHdpdGhfZXhlY3V0aW9uX3N0YWdlX2NoZWNrcG9pbnQKICAgICksCiAgICAoCiAgICAgICAgNCwKICAgICAgICBIZWFkZXJzLAogICAgICAgIEhlYWRlcnNDaGVja3BvaW50LAogICAgICAgIC8vLyBSZXR1cm5zIHRoZSBoZWFkZXJzIHN0YWdlIGNoZWNrcG9pbnQsIGlmIGFueS4KICAgICAgICBoZWFkZXJzX3N0YWdlX2NoZWNrcG9pbnQsCiAgICAgICAgLy8vIFNldHMgdGhlIHN0YWdlIGNoZWNrcG9pbnQgdG8gaGVhZGVycy4KICAgICAgICB3aXRoX2hlYWRlcnNfc3RhZ2VfY2hlY2twb2ludAogICAgKSwKICAgICgKICAgICAgICA1LAogICAgICAgIEluZGV4SGlzdG9yeSwKICAgICAgICBJbmRleEhpc3RvcnlDaGVja3BvaW50LAogICAgICAgIC8vLyBSZXR1cm5zIHRoZSBpbmRleCBoaXN0b3J5IHN0YWdlIGNoZWNrcG9pbnQsIGlmIGFueS4KICAgICAgICBpbmRleF9oaXN0b3J5X3N0YWdlX2NoZWNrcG9pbnQsCiAgICAgICAgLy8vIFNldHMgdGhlIHN0YWdlIGNoZWNrcG9pbnQgdG8gaW5kZXggaGlzdG9yeS4KICAgICAgICB3aXRoX2luZGV4X2hpc3Rvcnlfc3RhZ2VfY2hlY2twb2ludAogICAgKQopOwoKI1tjZmcodGVzdCldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6Oio7CiAgICB1c2UgYWxsb3lfcHJpbWl0aXZlczo6YjI1NjsKICAgIHVzZSByYW5kOjpSbmc7CiAgICB1c2UgcmV0aF9jb2RlY3M6OkNvbXBhY3Q7CgogICAgI1t0ZXN0XQogICAgZm4gbWVya2xlX2NoZWNrcG9pbnRfcm91bmR0cmlwKCkgewogICAgICAgIGxldCBtdXQgcm5nID0gcmFuZDo6cm5nKCk7CiAgICAgICAgbGV0IGNoZWNrcG9pbnQgPSBNZXJrbGVDaGVja3BvaW50IHsKICAgICAgICAgICAgdGFyZ2V0X2Jsb2NrOiBybmcucmFuZG9tKCksCiAgICAgICAgICAgIGxhc3RfYWNjb3VudF9rZXk6IHJuZy5yYW5kb20oKSwKICAgICAgICAgICAgd2Fsa2VyX3N0YWNrOiB2ZWMhW1N0b3JlZFN1Yk5vZGUgewogICAgICAgICAgICAgICAga2V5OiBCMjU2OjpyYW5kb21fd2l0aCgmbXV0IHJuZykudG9fdmVjKCksCiAgICAgICAgICAgICAgICBuaWJibGU6IFNvbWUocm5nLnJhbmRvbSgpKSwKICAgICAgICAgICAgICAgIG5vZGU6IE5vbmUsCiAgICAgICAgICAgIH1dLAogICAgICAgICAgICBzdGF0ZTogSGFzaEJ1aWxkZXJTdGF0ZTo6ZGVmYXVsdCgpLAogICAgICAgICAgICBzdG9yYWdlX3Jvb3RfY2hlY2twb2ludDogTm9uZSwKICAgICAgICB9OwoKICAgICAgICBsZXQgbXV0IGJ1ZiA9IFZlYzo6bmV3KCk7CiAgICAgICAgbGV0IGVuY29kZWQgPSBjaGVja3BvaW50LnRvX2NvbXBhY3QoJm11dCBidWYpOwogICAgICAgIGxldCAoZGVjb2RlZCwgXykgPSBNZXJrbGVDaGVja3BvaW50Ojpmcm9tX2NvbXBhY3QoJmJ1ZiwgZW5jb2RlZCk7CiAgICAgICAgYXNzZXJ0X2VxIShkZWNvZGVkLCBjaGVja3BvaW50KTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiBzdG9yYWdlX3Jvb3RfbWVya2xlX2NoZWNrcG9pbnRfcm91bmR0cmlwKCkgewogICAgICAgIGxldCBtdXQgcm5nID0gcmFuZDo6cm5nKCk7CiAgICAgICAgbGV0IGNoZWNrcG9pbnQgPSBTdG9yYWdlUm9vdE1lcmtsZUNoZWNrcG9pbnQgewogICAgICAgICAgICBsYXN0X3N0b3JhZ2Vfa2V5OiBybmcucmFuZG9tKCksCiAgICAgICAgICAgIHdhbGtlcl9zdGFjazogdmVjIVtTdG9yZWRTdWJOb2RlIHsKICAgICAgICAgICAgICAgIGtleTogQjI1Njo6cmFuZG9tX3dpdGgoJm11dCBybmcpLnRvX3ZlYygpLAogICAgICAgICAgICAgICAgbmliYmxlOiBTb21lKHJuZy5yYW5kb20oKSksCiAgICAgICAgICAgICAgICBub2RlOiBOb25lLAogICAgICAgICAgICB9XSwKICAgICAgICAgICAgc3RhdGU6IEhhc2hCdWlsZGVyU3RhdGU6OmRlZmF1bHQoKSwKICAgICAgICAgICAgYWNjb3VudF9ub25jZTogMCwKICAgICAgICAgICAgYWNjb3VudF9iYWxhbmNlOiBVMjU2OjpaRVJPLAogICAgICAgICAgICBhY2NvdW50X2J5dGVjb2RlX2hhc2g6IEIyNTY6OlpFUk8sCiAgICAgICAgfTsKCiAgICAgICAgbGV0IG11dCBidWYgPSBWZWM6Om5ldygpOwogICAgICAgIGxldCBlbmNvZGVkID0gY2hlY2twb2ludC50b19jb21wYWN0KCZtdXQgYnVmKTsKICAgICAgICBsZXQgKGRlY29kZWQsIF8pID0gU3RvcmFnZVJvb3RNZXJrbGVDaGVja3BvaW50Ojpmcm9tX2NvbXBhY3QoJmJ1ZiwgZW5jb2RlZCk7CiAgICAgICAgYXNzZXJ0X2VxIShkZWNvZGVkLCBjaGVja3BvaW50KTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiBtZXJrbGVfY2hlY2twb2ludF93aXRoX3N0b3JhZ2Vfcm9vdF9yb3VuZHRyaXAoKSB7CiAgICAgICAgbGV0IG11dCBybmcgPSByYW5kOjpybmcoKTsKCiAgICAgICAgLy8gQ3JlYXRlIGEgc3RvcmFnZSByb290IGNoZWNrcG9pbnQKICAgICAgICBsZXQgc3RvcmFnZV9jaGVja3BvaW50ID0gU3RvcmFnZVJvb3RNZXJrbGVDaGVja3BvaW50IHsKICAgICAgICAgICAgbGFzdF9zdG9yYWdlX2tleTogcm5nLnJhbmRvbSgpLAogICAgICAgICAgICB3YWxrZXJfc3RhY2s6IHZlYyFbU3RvcmVkU3ViTm9kZSB7CiAgICAgICAgICAgICAgICBrZXk6IEIyNTY6OnJhbmRvbV93aXRoKCZtdXQgcm5nKS50b192ZWMoKSwKICAgICAgICAgICAgICAgIG5pYmJsZTogU29tZShybmcucmFuZG9tKCkpLAogICAgICAgICAgICAgICAgbm9kZTogTm9uZSwKICAgICAgICAgICAgfV0sCiAgICAgICAgICAgIHN0YXRlOiBIYXNoQnVpbGRlclN0YXRlOjpkZWZhdWx0KCksCiAgICAgICAgICAgIGFjY291bnRfbm9uY2U6IDEsCiAgICAgICAgICAgIGFjY291bnRfYmFsYW5jZTogVTI1Njo6ZnJvbSgxKSwKICAgICAgICAgICAgYWNjb3VudF9ieXRlY29kZV9oYXNoOiBiMjU2ISgKICAgICAgICAgICAgICAgICIweDBmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmMGZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmYiCiAgICAgICAgICAgICksCiAgICAgICAgfTsKCiAgICAgICAgLy8gQ3JlYXRlIGEgbWVya2xlIGNoZWNrcG9pbnQgd2l0aCB0aGUgc3RvcmFnZSByb290IGNoZWNrcG9pbnQKICAgICAgICBsZXQgY2hlY2twb2ludCA9IE1lcmtsZUNoZWNrcG9pbnQgewogICAgICAgICAgICB0YXJnZXRfYmxvY2s6IHJuZy5yYW5kb20oKSwKICAgICAgICAgICAgbGFzdF9hY2NvdW50X2tleTogcm5nLnJhbmRvbSgpLAogICAgICAgICAgICB3YWxrZXJfc3RhY2s6IHZlYyFbU3RvcmVkU3ViTm9kZSB7CiAgICAgICAgICAgICAgICBrZXk6IEIyNTY6OnJhbmRvbV93aXRoKCZtdXQgcm5nKS50b192ZWMoKSwKICAgICAgICAgICAgICAgIG5pYmJsZTogU29tZShybmcucmFuZG9tKCkpLAogICAgICAgICAgICAgICAgbm9kZTogTm9uZSwKICAgICAgICAgICAgfV0sCiAgICAgICAgICAgIHN0YXRlOiBIYXNoQnVpbGRlclN0YXRlOjpkZWZhdWx0KCksCiAgICAgICAgICAgIHN0b3JhZ2Vfcm9vdF9jaGVja3BvaW50OiBTb21lKHN0b3JhZ2VfY2hlY2twb2ludCksCiAgICAgICAgfTsKCiAgICAgICAgbGV0IG11dCBidWYgPSBWZWM6Om5ldygpOwogICAgICAgIGxldCBlbmNvZGVkID0gY2hlY2twb2ludC50b19jb21wYWN0KCZtdXQgYnVmKTsKICAgICAgICBsZXQgKGRlY29kZWQsIF8pID0gTWVya2xlQ2hlY2twb2ludDo6ZnJvbV9jb21wYWN0KCZidWYsIGVuY29kZWQpOwogICAgICAgIGFzc2VydF9lcSEoZGVjb2RlZCwgY2hlY2twb2ludCk7CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy90eXBlcy9zcmMvaWQucnMiPgp1c2UgYWxsb2M6OnZlYzo6VmVjOwojW2NmZyhmZWF0dXJlID0gInN0ZCIpXQp1c2Ugc3RkOjp7Y29sbGVjdGlvbnM6Okhhc2hNYXAsIHN5bmM6Ok9uY2VMb2NrfTsKCi8vLyBTdGFnZSBJRHMgZm9yIGFsbCBrbm93biBzdGFnZXMuCi8vLwovLy8gRm9yIGN1c3RvbSBzdGFnZXMsIHVzZSBbYFN0YWdlSWQ6Ok90aGVyYF0KI1tleHBlY3QobWlzc2luZ19kb2NzKV0KI1tkZXJpdmUoQ2xvbmUsIENvcHksIERlYnVnLCBQYXJ0aWFsRXEsIEVxLCBIYXNoKV0KcHViIGVudW0gU3RhZ2VJZCB7CiAgICAjW2RlcHJlY2F0ZWQoCiAgICAgICAgbm90ZSA9ICJTdGF0aWMgRmlsZXMgYXJlIGdlbmVyYXRlZCBvdXRzaWRlIG9mIHRoZSBwaXBlbGluZSBhbmQgZG8gbm90IHJlcXVpcmUgYSBzZXBhcmF0ZSBzdGFnZSIKICAgICldCiAgICBTdGF0aWNGaWxlLAogICAgRXJhLAogICAgSGVhZGVycywKICAgIEJvZGllcywKICAgIFNlbmRlclJlY292ZXJ5LAogICAgRXhlY3V0aW9uLAogICAgUHJ1bmVTZW5kZXJSZWNvdmVyeSwKICAgIE1lcmtsZVVud2luZCwKICAgIEFjY291bnRIYXNoaW5nLAogICAgU3RvcmFnZUhhc2hpbmcsCiAgICBNZXJrbGVFeGVjdXRlLAogICAgVHJhbnNhY3Rpb25Mb29rdXAsCiAgICBJbmRleFN0b3JhZ2VIaXN0b3J5LAogICAgSW5kZXhBY2NvdW50SGlzdG9yeSwKICAgIFBydW5lLAogICAgRmluaXNoLAogICAgLy8vIE90aGVyIGN1c3RvbSBzdGFnZSB3aXRoIGEgcHJvdmlkZWQgc3RyaW5nIGlkZW50aWZpZXIuCiAgICBPdGhlcigmJ3N0YXRpYyBzdHIpLAp9CgovLy8gT25lLXRpbWUtYWxsb2NhdGVkIHN0YWdlIGlkcyBlbmNvZGVkIGFzIHJhdyBWZWNzLCB1c2VmdWwgZm9yIGRhdGFiYXNlCi8vLyBjbGllbnRzIHRvIHJlZmVyZW5jZSB0aGVtIGZvciBxdWVyaWVzIGluc3RlYWQgb2YgZW5jb2RpbmcgYW5ldyBwZXIgcXVlcnkKLy8vIChzYWQgaGVhcCBhbGxvY2F0aW9uIHJlcXVpcmVkKS4KI1tjZmcoZmVhdHVyZSA9ICJzdGQiKV0Kc3RhdGljIEVOQ09ERURfU1RBR0VfSURTOiBPbmNlTG9jazxIYXNoTWFwPFN0YWdlSWQsIFZlYzx1OD4+PiA9IE9uY2VMb2NrOjpuZXcoKTsKCmltcGwgU3RhZ2VJZCB7CiAgICAvLy8gQWxsIHN1cHBvcnRlZCBTdGFnZXMKICAgIHB1YiBjb25zdCBBTEw6IFtTZWxmOyAxNV0gPSBbCiAgICAgICAgU2VsZjo6RXJhLAogICAgICAgIFNlbGY6OkhlYWRlcnMsCiAgICAgICAgU2VsZjo6Qm9kaWVzLAogICAgICAgIFNlbGY6OlNlbmRlclJlY292ZXJ5LAogICAgICAgIFNlbGY6OkV4ZWN1dGlvbiwKICAgICAgICBTZWxmOjpQcnVuZVNlbmRlclJlY292ZXJ5LAogICAgICAgIFNlbGY6Ok1lcmtsZVVud2luZCwKICAgICAgICBTZWxmOjpBY2NvdW50SGFzaGluZywKICAgICAgICBTZWxmOjpTdG9yYWdlSGFzaGluZywKICAgICAgICBTZWxmOjpNZXJrbGVFeGVjdXRlLAogICAgICAgIFNlbGY6OlRyYW5zYWN0aW9uTG9va3VwLAogICAgICAgIFNlbGY6OkluZGV4U3RvcmFnZUhpc3RvcnksCiAgICAgICAgU2VsZjo6SW5kZXhBY2NvdW50SGlzdG9yeSwKICAgICAgICBTZWxmOjpQcnVuZSwKICAgICAgICBTZWxmOjpGaW5pc2gsCiAgICBdOwoKICAgIC8vLyBTdGFnZXMgdGhhdCByZXF1aXJlIHN0YXRlLgogICAgcHViIGNvbnN0IFNUQVRFX1JFUVVJUkVEOiBbU2VsZjsgOV0gPSBbCiAgICAgICAgU2VsZjo6RXhlY3V0aW9uLAogICAgICAgIFNlbGY6OlBydW5lU2VuZGVyUmVjb3ZlcnksCiAgICAgICAgU2VsZjo6TWVya2xlVW53aW5kLAogICAgICAgIFNlbGY6OkFjY291bnRIYXNoaW5nLAogICAgICAgIFNlbGY6OlN0b3JhZ2VIYXNoaW5nLAogICAgICAgIFNlbGY6Ok1lcmtsZUV4ZWN1dGUsCiAgICAgICAgU2VsZjo6SW5kZXhTdG9yYWdlSGlzdG9yeSwKICAgICAgICBTZWxmOjpJbmRleEFjY291bnRIaXN0b3J5LAogICAgICAgIFNlbGY6OlBydW5lLAogICAgXTsKCiAgICAvLy8gUmV0dXJuIHN0YWdlIGlkIGZvcm1hdHRlZCBhcyBzdHJpbmcuCiAgICBwdWIgY29uc3QgZm4gYXNfc3RyKCZzZWxmKSAtPiAmc3RyIHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgI1tleHBlY3QoZGVwcmVjYXRlZCldCiAgICAgICAgICAgIFNlbGY6OlN0YXRpY0ZpbGUgPT4gIlN0YXRpY0ZpbGUiLAogICAgICAgICAgICBTZWxmOjpFcmEgPT4gIkVyYSIsCiAgICAgICAgICAgIFNlbGY6OkhlYWRlcnMgPT4gIkhlYWRlcnMiLAogICAgICAgICAgICBTZWxmOjpCb2RpZXMgPT4gIkJvZGllcyIsCiAgICAgICAgICAgIFNlbGY6OlNlbmRlclJlY292ZXJ5ID0+ICJTZW5kZXJSZWNvdmVyeSIsCiAgICAgICAgICAgIFNlbGY6OkV4ZWN1dGlvbiA9PiAiRXhlY3V0aW9uIiwKICAgICAgICAgICAgU2VsZjo6UHJ1bmVTZW5kZXJSZWNvdmVyeSA9PiAiUHJ1bmVTZW5kZXJSZWNvdmVyeSIsCiAgICAgICAgICAgIFNlbGY6Ok1lcmtsZVVud2luZCA9PiAiTWVya2xlVW53aW5kIiwKICAgICAgICAgICAgU2VsZjo6QWNjb3VudEhhc2hpbmcgPT4gIkFjY291bnRIYXNoaW5nIiwKICAgICAgICAgICAgU2VsZjo6U3RvcmFnZUhhc2hpbmcgPT4gIlN0b3JhZ2VIYXNoaW5nIiwKICAgICAgICAgICAgU2VsZjo6TWVya2xlRXhlY3V0ZSA9PiAiTWVya2xlRXhlY3V0ZSIsCiAgICAgICAgICAgIFNlbGY6OlRyYW5zYWN0aW9uTG9va3VwID0+ICJUcmFuc2FjdGlvbkxvb2t1cCIsCiAgICAgICAgICAgIFNlbGY6OkluZGV4QWNjb3VudEhpc3RvcnkgPT4gIkluZGV4QWNjb3VudEhpc3RvcnkiLAogICAgICAgICAgICBTZWxmOjpJbmRleFN0b3JhZ2VIaXN0b3J5ID0+ICJJbmRleFN0b3JhZ2VIaXN0b3J5IiwKICAgICAgICAgICAgU2VsZjo6UHJ1bmUgPT4gIlBydW5lIiwKICAgICAgICAgICAgU2VsZjo6RmluaXNoID0+ICJGaW5pc2giLAogICAgICAgICAgICBTZWxmOjpPdGhlcihzKSA9PiBzLAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0cnVlIGlmIGl0J3MgYSBkb3dubG9hZGluZyBzdGFnZSBbYFN0YWdlSWQ6OkhlYWRlcnNgXSBvciBbYFN0YWdlSWQ6OkJvZGllc2BdCiAgICBwdWIgY29uc3QgZm4gaXNfZG93bmxvYWRpbmdfc3RhZ2UoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIG1hdGNoZXMhKHNlbGYsIFNlbGY6OkVyYSB8IFNlbGY6OkhlYWRlcnMgfCBTZWxmOjpCb2RpZXMpCiAgICB9CgogICAgLy8vIFJldHVybnMgYHRydWVgIGlmIGl0J3MgW2BUcmFuc2FjdGlvbkxvb2t1cGBdKFN0YWdlSWQ6OlRyYW5zYWN0aW9uTG9va3VwKSBzdGFnZS4KICAgIHB1YiBjb25zdCBmbiBpc190eF9sb29rdXAoJnNlbGYpIC0+IGJvb2wgewogICAgICAgIG1hdGNoZXMhKHNlbGYsIFNlbGY6OlRyYW5zYWN0aW9uTG9va3VwKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRydWUgaW5kaWNhdGluZyBpZiBpdCdzIHRoZSBmaW5pc2ggc3RhZ2UgW2BTdGFnZUlkOjpGaW5pc2hgXQogICAgcHViIGNvbnN0IGZuIGlzX2ZpbmlzaCgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgbWF0Y2hlcyEoc2VsZiwgU2VsZjo6RmluaXNoKQogICAgfQoKICAgIC8vLyBHZXQgYSBwcmUtZW5jb2RlZCByYXcgVmVjLCBmb3IgZXhhbXBsZSwgdG8gYmUgdXNlZCBhcyB0aGUgREIga2V5IGZvcgogICAgLy8vIGB0YWJsZXM6OlN0YWdlQ2hlY2twb2ludHNgIGFuZCBgdGFibGVzOjpTdGFnZUNoZWNrcG9pbnRQcm9ncmVzc2VzYAogICAgcHViIGZuIGdldF9wcmVfZW5jb2RlZCgmc2VsZikgLT4gT3B0aW9uPCZWZWM8dTg+PiB7CiAgICAgICAgI1tjZmcobm90KGZlYXR1cmUgPSAic3RkIikpXQogICAgICAgIHsKICAgICAgICAgICAgTm9uZQogICAgICAgIH0KICAgICAgICAjW2NmZyhmZWF0dXJlID0gInN0ZCIpXQogICAgICAgIEVOQ09ERURfU1RBR0VfSURTCiAgICAgICAgICAgIC5nZXRfb3JfaW5pdCh8fCB7CiAgICAgICAgICAgICAgICBsZXQgbXV0IG1hcCA9IEhhc2hNYXA6OndpdGhfY2FwYWNpdHkoU2VsZjo6QUxMLmxlbigpKTsKICAgICAgICAgICAgICAgIGZvciBzdGFnZV9pZCBpbiBTZWxmOjpBTEwgewogICAgICAgICAgICAgICAgICAgIG1hcC5pbnNlcnQoc3RhZ2VfaWQsIHN0YWdlX2lkLnRvX3N0cmluZygpLmludG9fYnl0ZXMoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtYXAKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLmdldChzZWxmKQogICAgfQp9CgppbXBsIGNvcmU6OmZtdDo6RGlzcGxheSBmb3IgU3RhZ2VJZCB7CiAgICBmbiBmbXQoJnNlbGYsIGY6ICZtdXQgY29yZTo6Zm10OjpGb3JtYXR0ZXI8J18+KSAtPiBjb3JlOjpmbXQ6OlJlc3VsdCB7CiAgICAgICAgd3JpdGUhKGYsICJ7fSIsIHNlbGYuYXNfc3RyKCkpCiAgICB9Cn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdHMgewogICAgdXNlIHN1cGVyOjoqOwoKICAgICNbdGVzdF0KICAgIGZuIHN0YWdlX2lkX2FzX3N0cmluZygpIHsKICAgICAgICBhc3NlcnRfZXEhKFN0YWdlSWQ6OkVyYS50b19zdHJpbmcoKSwgIkVyYSIpOwogICAgICAgIGFzc2VydF9lcSEoU3RhZ2VJZDo6SGVhZGVycy50b19zdHJpbmcoKSwgIkhlYWRlcnMiKTsKICAgICAgICBhc3NlcnRfZXEhKFN0YWdlSWQ6OkJvZGllcy50b19zdHJpbmcoKSwgIkJvZGllcyIpOwogICAgICAgIGFzc2VydF9lcSEoU3RhZ2VJZDo6U2VuZGVyUmVjb3ZlcnkudG9fc3RyaW5nKCksICJTZW5kZXJSZWNvdmVyeSIpOwogICAgICAgIGFzc2VydF9lcSEoU3RhZ2VJZDo6RXhlY3V0aW9uLnRvX3N0cmluZygpLCAiRXhlY3V0aW9uIik7CiAgICAgICAgYXNzZXJ0X2VxIShTdGFnZUlkOjpNZXJrbGVVbndpbmQudG9fc3RyaW5nKCksICJNZXJrbGVVbndpbmQiKTsKICAgICAgICBhc3NlcnRfZXEhKFN0YWdlSWQ6OkFjY291bnRIYXNoaW5nLnRvX3N0cmluZygpLCAiQWNjb3VudEhhc2hpbmciKTsKICAgICAgICBhc3NlcnRfZXEhKFN0YWdlSWQ6OlN0b3JhZ2VIYXNoaW5nLnRvX3N0cmluZygpLCAiU3RvcmFnZUhhc2hpbmciKTsKICAgICAgICBhc3NlcnRfZXEhKFN0YWdlSWQ6Ok1lcmtsZUV4ZWN1dGUudG9fc3RyaW5nKCksICJNZXJrbGVFeGVjdXRlIik7CiAgICAgICAgYXNzZXJ0X2VxIShTdGFnZUlkOjpJbmRleEFjY291bnRIaXN0b3J5LnRvX3N0cmluZygpLCAiSW5kZXhBY2NvdW50SGlzdG9yeSIpOwogICAgICAgIGFzc2VydF9lcSEoU3RhZ2VJZDo6SW5kZXhTdG9yYWdlSGlzdG9yeS50b19zdHJpbmcoKSwgIkluZGV4U3RvcmFnZUhpc3RvcnkiKTsKICAgICAgICBhc3NlcnRfZXEhKFN0YWdlSWQ6OlRyYW5zYWN0aW9uTG9va3VwLnRvX3N0cmluZygpLCAiVHJhbnNhY3Rpb25Mb29rdXAiKTsKICAgICAgICBhc3NlcnRfZXEhKFN0YWdlSWQ6OkZpbmlzaC50b19zdHJpbmcoKSwgIkZpbmlzaCIpOwoKICAgICAgICBhc3NlcnRfZXEhKFN0YWdlSWQ6Ok90aGVyKCJGb28iKS50b19zdHJpbmcoKSwgIkZvbyIpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIGlzX2Rvd25sb2FkaW5nX3N0YWdlKCkgewogICAgICAgIGFzc2VydCEoU3RhZ2VJZDo6SGVhZGVycy5pc19kb3dubG9hZGluZ19zdGFnZSgpKTsKICAgICAgICBhc3NlcnQhKFN0YWdlSWQ6OkJvZGllcy5pc19kb3dubG9hZGluZ19zdGFnZSgpKTsKICAgICAgICBhc3NlcnQhKFN0YWdlSWQ6OkVyYS5pc19kb3dubG9hZGluZ19zdGFnZSgpKTsKCiAgICAgICAgYXNzZXJ0ISghU3RhZ2VJZDo6RXhlY3V0aW9uLmlzX2Rvd25sb2FkaW5nX3N0YWdlKCkpOwogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9zdGFnZXMvdHlwZXMvc3JjL2xpYi5ycyI+Ci8vISBDb21tb25seSB1c2VkIHR5cGVzIGZvciBzdGFnZWQgc3luYyB1c2FnZS4KCiMhW2RvYygKICAgIGh0bWxfbG9nb191cmwgPSAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3BhcmFkaWdteHl6L3JldGgvbWFpbi9hc3NldHMvcmV0aC1kb2NzLnBuZyIsCiAgICBodG1sX2Zhdmljb25fdXJsID0gImh0dHBzOi8vYXZhdGFyczAuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3UvOTczNjk0NjY/cz0yNTYiLAogICAgaXNzdWVfdHJhY2tlcl9iYXNlX3VybCA9ICJodHRwczovL2dpdGh1Yi5jb20vcGFyYWRpZ214eXovcmV0aC9pc3N1ZXMvIgopXQojIVtjZmdfYXR0cihub3QodGVzdCksIHdhcm4odW51c2VkX2NyYXRlX2RlcGVuZGVuY2llcykpXQojIVtjZmdfYXR0cihkb2NzcnMsIGZlYXR1cmUoZG9jX2NmZykpXQojIVtjZmdfYXR0cihub3QoZmVhdHVyZSA9ICJzdGQiKSwgbm9fc3RkKV0KCmV4dGVybiBjcmF0ZSBhbGxvYzsKCm1vZCBpZDsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OntCbG9ja0hhc2gsIEJsb2NrTnVtYmVyfTsKcHViIHVzZSBpZDo6U3RhZ2VJZDsKCm1vZCBjaGVja3BvaW50czsKcHViIHVzZSBjaGVja3BvaW50czo6ewogICAgQWNjb3VudEhhc2hpbmdDaGVja3BvaW50LCBDaGVja3BvaW50QmxvY2tSYW5nZSwgRW50aXRpZXNDaGVja3BvaW50LCBFeGVjdXRpb25DaGVja3BvaW50LAogICAgSGVhZGVyc0NoZWNrcG9pbnQsIEluZGV4SGlzdG9yeUNoZWNrcG9pbnQsIE1lcmtsZUNoZWNrcG9pbnQsIFN0YWdlQ2hlY2twb2ludCwKICAgIFN0YWdlVW5pdENoZWNrcG9pbnQsIFN0b3JhZ2VIYXNoaW5nQ2hlY2twb2ludCwgU3RvcmFnZVJvb3RNZXJrbGVDaGVja3BvaW50LAp9OwoKbW9kIGV4ZWN1dGlvbjsKcHViIHVzZSBleGVjdXRpb246Oio7CgovLy8gRGlyZWN0aW9uIGFuZCB0YXJnZXQgYmxvY2sgZm9yIHBpcGVsaW5lIG9wZXJhdGlvbnMuCiNbZGVyaXZlKERlYnVnLCBDbG9uZSwgQ29weSwgUGFydGlhbEVxLCBFcSldCnB1YiBlbnVtIFBpcGVsaW5lVGFyZ2V0IHsKICAgIC8vLyBUYXJnZXQgZm9yIGZvcndhcmQgc3luY2hyb25pemF0aW9uLCBpbmRpY2F0aW5nIGEgYmxvY2sgaGFzaCB0byBzeW5jIHRvLgogICAgU3luYyhCbG9ja0hhc2gpLAogICAgLy8vIFRhcmdldCBmb3IgYmFja3dhcmQgdW53aW5kaW5nLCBpbmRpY2F0aW5nIGEgYmxvY2sgbnVtYmVyIHRvIHVud2luZCB0by4KICAgIFVud2luZChCbG9ja051bWJlciksCn0KCmltcGwgUGlwZWxpbmVUYXJnZXQgewogICAgLy8vIFJldHVybnMgdGhlIHRhcmdldCBibG9jayBoYXNoIGZvciBmb3J3YXJkIHN5bmNocm9uaXphdGlvbiwgaWYgYXBwbGljYWJsZS4KICAgIC8vLwogICAgLy8vICMgUmV0dXJucwogICAgLy8vCiAgICAvLy8gLSBgU29tZShCbG9ja0hhc2gpYDogVGhlIHRhcmdldCBibG9jayBoYXNoIGZvciBmb3J3YXJkIHN5bmNocm9uaXphdGlvbi4KICAgIC8vLyAtIGBOb25lYDogSWYgdGhlIHRhcmdldCBpcyBmb3IgYmFja3dhcmQgdW53aW5kaW5nLgogICAgcHViIGNvbnN0IGZuIHN5bmNfdGFyZ2V0KHNlbGYpIC0+IE9wdGlvbjxCbG9ja0hhc2g+IHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6U3luYyhoYXNoKSA9PiBTb21lKGhhc2gpLAogICAgICAgICAgICBTZWxmOjpVbndpbmQoXykgPT4gTm9uZSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIHRhcmdldCBibG9jayBudW1iZXIgZm9yIGJhY2t3YXJkIHVud2luZGluZywgaWYgYXBwbGljYWJsZS4KICAgIC8vLwogICAgLy8vICMgUmV0dXJucwogICAgLy8vCiAgICAvLy8gLSBgU29tZShCbG9ja051bWJlcilgOiBUaGUgdGFyZ2V0IGJsb2NrIG51bWJlciBmb3IgYmFja3dhcmQgdW53aW5kaW5nLgogICAgLy8vIC0gYE5vbmVgOiBJZiB0aGUgdGFyZ2V0IGlzIGZvciBmb3J3YXJkIHN5bmNocm9uaXphdGlvbi4KICAgIHB1YiBjb25zdCBmbiB1bndpbmRfdGFyZ2V0KHNlbGYpIC0+IE9wdGlvbjxCbG9ja051bWJlcj4gewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpTeW5jKF8pID0+IE5vbmUsCiAgICAgICAgICAgIFNlbGY6OlVud2luZChudW1iZXIpID0+IFNvbWUobnVtYmVyKSwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgRnJvbTxCbG9ja0hhc2g+IGZvciBQaXBlbGluZVRhcmdldCB7CiAgICBmbiBmcm9tKGhhc2g6IEJsb2NrSGFzaCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZjo6U3luYyhoYXNoKQogICAgfQp9CgppbXBsIGNvcmU6OmZtdDo6RGlzcGxheSBmb3IgUGlwZWxpbmVUYXJnZXQgewogICAgZm4gZm10KCZzZWxmLCBmOiAmbXV0IGNvcmU6OmZtdDo6Rm9ybWF0dGVyPCdfPikgLT4gY29yZTo6Zm10OjpSZXN1bHQgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpTeW5jKGJsb2NrKSA9PiB7CiAgICAgICAgICAgICAgICB3cml0ZSEoZiwgIlN5bmMoe2Jsb2NrfSkiKQogICAgICAgICAgICB9CiAgICAgICAgICAgIFNlbGY6OlVud2luZChibG9jaykgPT4gd3JpdGUhKGYsICJVbndpbmQoe2Jsb2NrfSkiKSwKICAgICAgICB9CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL2NoYWluLXN0YXRlL3NyYy9ub3RpZmljYXRpb25zLnJzIj4KLy8hIENhbm9uaWNhbCBjaGFpbiBzdGF0ZSBub3RpZmljYXRpb24gdHJhaXQgYW5kIHR5cGVzLgoKdXNlIGFsbG95X2VpcHM6OntlaXAyNzE4OjpFbmNvZGFibGUyNzE4LCBCbG9ja051bUhhc2h9Owp1c2UgZGVyaXZlX21vcmU6OntEZXJlZiwgRGVyZWZNdXR9Owp1c2UgcmV0aF9leGVjdXRpb25fdHlwZXM6OntCbG9ja1JlY2VpcHRzLCBDaGFpbn07CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjp7Tm9kZVByaW1pdGl2ZXMsIFJlY292ZXJlZEJsb2NrLCBTZWFsZWRIZWFkZXJ9Owp1c2UgcmV0aF9zdG9yYWdlX2FwaTo6Tm9kZVByaW1pdGl2ZXNQcm92aWRlcjsKdXNlIHN0ZDo6ewogICAgcGluOjpQaW4sCiAgICBzeW5jOjpBcmMsCiAgICB0YXNrOjp7cmVhZHksIENvbnRleHQsIFBvbGx9LAp9Owp1c2UgdG9raW86OnN5bmM6Onticm9hZGNhc3QsIHdhdGNofTsKdXNlIHRva2lvX3N0cmVhbTo6ewogICAgd3JhcHBlcnM6OntCcm9hZGNhc3RTdHJlYW0sIFdhdGNoU3RyZWFtfSwKICAgIFN0cmVhbSwKfTsKdXNlIHRyYWNpbmc6OmRlYnVnOwoKLy8vIFR5cGUgYWxpYXMgZm9yIGEgcmVjZWl2ZXIgdGhhdCByZWNlaXZlcyBbYENhbm9uU3RhdGVOb3RpZmljYXRpb25gXQpwdWIgdHlwZSBDYW5vblN0YXRlTm90aWZpY2F0aW9uczxOID0gcmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpFdGhQcmltaXRpdmVzPiA9CiAgICBicm9hZGNhc3Q6OlJlY2VpdmVyPENhbm9uU3RhdGVOb3RpZmljYXRpb248Tj4+OwoKLy8vIFR5cGUgYWxpYXMgZm9yIGEgc2VuZGVyIHRoYXQgc2VuZHMgW2BDYW5vblN0YXRlTm90aWZpY2F0aW9uYF0KcHViIHR5cGUgQ2Fub25TdGF0ZU5vdGlmaWNhdGlvblNlbmRlcjxOID0gcmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjpFdGhQcmltaXRpdmVzPiA9CiAgICBicm9hZGNhc3Q6OlNlbmRlcjxDYW5vblN0YXRlTm90aWZpY2F0aW9uPE4+PjsKCi8vLyBBIHR5cGUgdGhhdCBhbGxvd3MgdG8gcmVnaXN0ZXIgY2hhaW4gcmVsYXRlZCBldmVudCBzdWJzY3JpcHRpb25zLgpwdWIgdHJhaXQgQ2Fub25TdGF0ZVN1YnNjcmlwdGlvbnM6IE5vZGVQcmltaXRpdmVzUHJvdmlkZXIgKyBTZW5kICsgU3luYyB7CiAgICAvLy8gR2V0IG5vdGlmaWVkIHdoZW4gYSBuZXcgY2Fub25pY2FsIGNoYWluIHdhcyBpbXBvcnRlZC4KICAgIC8vLwogICAgLy8vIEEgY2Fub25pY2FsIGNoYWluIGJlIG9uZSBvciBtb3JlIGJsb2NrcywgYSByZW9yZyBvciBhIHJldmVydC4KICAgIGZuIHN1YnNjcmliZV90b19jYW5vbmljYWxfc3RhdGUoJnNlbGYpIC0+IENhbm9uU3RhdGVOb3RpZmljYXRpb25zPFNlbGY6OlByaW1pdGl2ZXM+OwoKICAgIC8vLyBDb252ZW5pZW5jZSBtZXRob2QgdG8gZ2V0IGEgc3RyZWFtIG9mIFtgQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbmBdLgogICAgZm4gY2Fub25pY2FsX3N0YXRlX3N0cmVhbSgmc2VsZikgLT4gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvblN0cmVhbTxTZWxmOjpQcmltaXRpdmVzPiB7CiAgICAgICAgQ2Fub25TdGF0ZU5vdGlmaWNhdGlvblN0cmVhbSB7CiAgICAgICAgICAgIHN0OiBCcm9hZGNhc3RTdHJlYW06Om5ldyhzZWxmLnN1YnNjcmliZV90b19jYW5vbmljYWxfc3RhdGUoKSksCiAgICAgICAgfQogICAgfQp9CgppbXBsPFQ6IENhbm9uU3RhdGVTdWJzY3JpcHRpb25zPiBDYW5vblN0YXRlU3Vic2NyaXB0aW9ucyBmb3IgJlQgewogICAgZm4gc3Vic2NyaWJlX3RvX2Nhbm9uaWNhbF9zdGF0ZSgmc2VsZikgLT4gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbnM8U2VsZjo6UHJpbWl0aXZlcz4gewogICAgICAgICgqc2VsZikuc3Vic2NyaWJlX3RvX2Nhbm9uaWNhbF9zdGF0ZSgpCiAgICB9CgogICAgZm4gY2Fub25pY2FsX3N0YXRlX3N0cmVhbSgmc2VsZikgLT4gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvblN0cmVhbTxTZWxmOjpQcmltaXRpdmVzPiB7CiAgICAgICAgKCpzZWxmKS5jYW5vbmljYWxfc3RhdGVfc3RyZWFtKCkKICAgIH0KfQoKLy8vIEEgU3RyZWFtIG9mIFtgQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbmBdLgojW2Rlcml2ZShEZWJ1ZyldCiNbcGluX3Byb2plY3Q6OnBpbl9wcm9qZWN0XQpwdWIgc3RydWN0IENhbm9uU3RhdGVOb3RpZmljYXRpb25TdHJlYW08TjogTm9kZVByaW1pdGl2ZXMgPSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkV0aFByaW1pdGl2ZXM+CnsKICAgICNbcGluXQogICAgc3Q6IEJyb2FkY2FzdFN0cmVhbTxDYW5vblN0YXRlTm90aWZpY2F0aW9uPE4+PiwKfQoKaW1wbDxOOiBOb2RlUHJpbWl0aXZlcz4gU3RyZWFtIGZvciBDYW5vblN0YXRlTm90aWZpY2F0aW9uU3RyZWFtPE4+IHsKICAgIHR5cGUgSXRlbSA9IENhbm9uU3RhdGVOb3RpZmljYXRpb248Tj47CgogICAgZm4gcG9sbF9uZXh0KG11dCBzZWxmOiBQaW48Jm11dCBTZWxmPiwgY3g6ICZtdXQgQ29udGV4dDwnXz4pIC0+IFBvbGw8T3B0aW9uPFNlbGY6Okl0ZW0+PiB7CiAgICAgICAgbG9vcCB7CiAgICAgICAgICAgIHJldHVybiBtYXRjaCByZWFkeSEoc2VsZi5hc19tdXQoKS5wcm9qZWN0KCkuc3QucG9sbF9uZXh0KGN4KSkgewogICAgICAgICAgICAgICAgU29tZShPayhub3RpZmljYXRpb24pKSA9PiBQb2xsOjpSZWFkeShTb21lKG5vdGlmaWNhdGlvbikpLAogICAgICAgICAgICAgICAgU29tZShFcnIoZXJyKSkgPT4gewogICAgICAgICAgICAgICAgICAgIGRlYnVnISglZXJyLCAiY2Fub25pY2FsIHN0YXRlIG5vdGlmaWNhdGlvbiBzdHJlYW0gbGFnZ2luZyBiZWhpbmQiKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgTm9uZSA9PiBQb2xsOjpSZWFkeShOb25lKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8vIEEgbm90aWZpY2F0aW9uIHRoYXQgaXMgc2VudCB3aGVuIGEgbmV3IGJsb2NrIGlzIGltcG9ydGVkLCBvciBhbiBvbGQgYmxvY2sgaXMgcmV2ZXJ0ZWQuCi8vLwovLy8gVGhlIG5vdGlmaWNhdGlvbiBjb250YWlucyBhdCBsZWFzdCBvbmUgW2BDaGFpbmBdIHdpdGggdGhlIGltcG9ydGVkIHNlZ21lbnQuIElmIHNvbWUgYmxvY2tzIHdlcmUKLy8vIHJldmVydGVkIChlLmcuIGR1cmluZyBhIHJlb3JnKSwgdGhlIG9sZCBjaGFpbiBpcyBhbHNvIHJldHVybmVkLgojW2Rlcml2ZShDbG9uZSwgRGVidWcsIFBhcnRpYWxFcSwgRXEpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKGJvdW5kID0gIiIpKV0KcHViIGVudW0gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbjxOOiBOb2RlUHJpbWl0aXZlcyA9IHJldGhfZXRoZXJldW1fcHJpbWl0aXZlczo6RXRoUHJpbWl0aXZlcz4gewogICAgLy8vIFRoZSBjYW5vbmljYWwgY2hhaW4gd2FzIGV4dGVuZGVkLgogICAgQ29tbWl0IHsKICAgICAgICAvLy8gVGhlIG5ld2x5IGFkZGVkIGNoYWluIHNlZ21lbnQuCiAgICAgICAgbmV3OiBBcmM8Q2hhaW48Tj4+LAogICAgfSwKICAgIC8vLyBBIGNoYWluIHNlZ21lbnQgd2FzIHJldmVydGVkIG9yIHJlb3JnZWQuCiAgICAvLy8KICAgIC8vLyAtIEluIHRoZSBjYXNlIG9mIGEgcmVvcmcsIHRoZSByZXZlcnRlZCBibG9ja3MgYXJlIHByZXNlbnQgaW4gYG9sZGAsIGFuZCB0aGUgbmV3IGJsb2NrcyBhcmUKICAgIC8vLyAgIHByZXNlbnQgaW4gYG5ld2AuCiAgICAvLy8gLSBJbiB0aGUgY2FzZSBvZiBhIHJldmVydCwgdGhlIHJldmVydGVkIGJsb2NrcyBhcmUgcHJlc2VudCBpbiBgb2xkYCwgYW5kIGBuZXdgIGlzIGFuIGVtcHR5CiAgICAvLy8gICBjaGFpbiBzZWdtZW50LgogICAgUmVvcmcgewogICAgICAgIC8vLyBUaGUgY2hhaW4gc2VnbWVudCB0aGF0IHdhcyByZXZlcnRlZC4KICAgICAgICBvbGQ6IEFyYzxDaGFpbjxOPj4sCiAgICAgICAgLy8vIFRoZSBjaGFpbiBzZWdtZW50IHRoYXQgd2FzIGFkZGVkIG9uIHRvcCBvZiB0aGUgY2Fub25pY2FsIGNoYWluLCBtaW51cyB0aGUgcmV2ZXJ0ZWQKICAgICAgICAvLy8gYmxvY2tzLgogICAgICAgIC8vLwogICAgICAgIC8vLyBJbiB0aGUgY2FzZSBvZiBhIHJldmVydCwgbm90IGEgcmVvcmcsIHRoaXMgY2hhaW4gc2VnbWVudCBpcyBlbXB0eS4KICAgICAgICBuZXc6IEFyYzxDaGFpbjxOPj4sCiAgICB9LAp9CgppbXBsPE46IE5vZGVQcmltaXRpdmVzPiBDYW5vblN0YXRlTm90aWZpY2F0aW9uPE4+IHsKICAgIC8vLyBHZXQgdGhlIGNoYWluIHNlZ21lbnQgdGhhdCB3YXMgcmV2ZXJ0ZWQsIGlmIGFueS4KICAgIHB1YiBmbiByZXZlcnRlZCgmc2VsZikgLT4gT3B0aW9uPEFyYzxDaGFpbjxOPj4+IHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6Q29tbWl0IHsgLi4gfSA9PiBOb25lLAogICAgICAgICAgICBTZWxmOjpSZW9yZyB7IG9sZCwgLi4gfSA9PiBTb21lKG9sZC5jbG9uZSgpKSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIEdldCB0aGUgbmV3bHkgaW1wb3J0ZWQgY2hhaW4gc2VnbWVudCwgaWYgYW55LgogICAgcHViIGZuIGNvbW1pdHRlZCgmc2VsZikgLT4gQXJjPENoYWluPE4+PiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkNvbW1pdCB7IG5ldyB9IHwgU2VsZjo6UmVvcmcgeyBuZXcsIC4uIH0gPT4gbmV3LmNsb25lKCksCiAgICAgICAgfQogICAgfQoKICAgIC8vLyBHZXRzIHRoZSBuZXcgdGlwIG9mIHRoZSBjaGFpbi4KICAgIC8vLwogICAgLy8vIFJldHVybnMgdGhlIG5ldyB0aXAgZm9yIFtgU2VsZjo6UmVvcmdgXSBhbmQgW2BTZWxmOjpDb21taXRgXSB2YXJpYW50cyB3aGljaCBjb21taXQgYXQgbGVhc3QKICAgIC8vLyAxIG5ldyBibG9jay4KICAgIC8vLwogICAgLy8vICMgUGFuaWNzCiAgICAvLy8KICAgIC8vLyBJZiBjaGFpbiBkb2Vzbid0IGhhdmUgYW55IGJsb2Nrcy4KICAgIHB1YiBmbiB0aXAoJnNlbGYpIC0+ICZSZWNvdmVyZWRCbG9jazxOOjpCbG9jaz4gewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpDb21taXQgeyBuZXcgfSB8IFNlbGY6OlJlb3JnIHsgbmV3LCAuLiB9ID0+IG5ldy50aXAoKSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIEdldHMgdGhlIG5ldyB0aXAgb2YgdGhlIGNoYWluLgogICAgLy8vCiAgICAvLy8gSWYgdGhlIGNoYWluIGhhcyBubyBibG9ja3MsIGl0IHJldHVybnMgYE5vbmVgLiBPdGhlcndpc2UsIGl0IHJldHVybnMgdGhlIG5ldyB0aXAgZm9yCiAgICAvLy8gW2BTZWxmOjpSZW9yZ2BdIGFuZCBbYFNlbGY6OkNvbW1pdGBdIHZhcmlhbnRzLgogICAgcHViIGZuIHRpcF9jaGVja2VkKCZzZWxmKSAtPiBPcHRpb248JlJlY292ZXJlZEJsb2NrPE46OkJsb2NrPj4gewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpDb21taXQgeyBuZXcgfSB8IFNlbGY6OlJlb3JnIHsgbmV3LCAuLiB9ID0+IHsKICAgICAgICAgICAgICAgIGlmIG5ldy5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgICAgICBOb25lCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIFNvbWUobmV3LnRpcCgpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBHZXQgcmVjZWlwdHMgaW4gdGhlIHJldmVydGVkIGFuZCBuZXdseSBpbXBvcnRlZCBjaGFpbiBzZWdtZW50cyB3aXRoIHRoZWlyIGNvcnJlc3BvbmRpbmcKICAgIC8vLyBibG9jayBudW1iZXJzIGFuZCB0cmFuc2FjdGlvbiBoYXNoZXMuCiAgICAvLy8KICAgIC8vLyBUaGUgYm9vbGVhbiBpbiB0aGUgdHVwbGUgKDJuZCBlbGVtZW50KSBkZW5vdGVzIHdoZXRoZXIgdGhlIHJlY2VpcHQgd2FzIGZyb20gdGhlIHJldmVydGVkCiAgICAvLy8gY2hhaW4gc2VnbWVudC4KICAgIHB1YiBmbiBibG9ja19yZWNlaXB0cygmc2VsZikgLT4gVmVjPChCbG9ja1JlY2VpcHRzPE46OlJlY2VpcHQ+LCBib29sKT4KICAgIHdoZXJlCiAgICAgICAgTjo6U2lnbmVkVHg6IEVuY29kYWJsZTI3MTgsCiAgICB7CiAgICAgICAgbGV0IG11dCByZWNlaXB0cyA9IFZlYzo6bmV3KCk7CgogICAgICAgIC8vIGdldCBvbGQgcmVjZWlwdHMKICAgICAgICBpZiBsZXQgU29tZShvbGQpID0gc2VsZi5yZXZlcnRlZCgpIHsKICAgICAgICAgICAgcmVjZWlwdHMKICAgICAgICAgICAgICAgIC5leHRlbmQob2xkLnJlY2VpcHRzX3dpdGhfYXR0YWNobWVudCgpLmludG9faXRlcigpLm1hcCh8cmVjZWlwdHwgKHJlY2VpcHQsIHRydWUpKSk7CiAgICAgICAgfQogICAgICAgIC8vIGdldCBuZXcgcmVjZWlwdHMKICAgICAgICByZWNlaXB0cy5leHRlbmQoCiAgICAgICAgICAgIHNlbGYuY29tbWl0dGVkKCkucmVjZWlwdHNfd2l0aF9hdHRhY2htZW50KCkuaW50b19pdGVyKCkubWFwKHxyZWNlaXB0fCAocmVjZWlwdCwgZmFsc2UpKSwKICAgICAgICApOwogICAgICAgIHJlY2VpcHRzCiAgICB9Cn0KCi8vLyBXcmFwcGVyIGFyb3VuZCBhIGJyb2FkY2FzdCByZWNlaXZlciB0aGF0IHJlY2VpdmVzIGZvcmsgY2hvaWNlIG5vdGlmaWNhdGlvbnMuCiNbZGVyaXZlKERlYnVnLCBEZXJlZiwgRGVyZWZNdXQpXQpwdWIgc3RydWN0IEZvcmtDaG9pY2VOb3RpZmljYXRpb25zPFQgPSBhbGxveV9jb25zZW5zdXM6OkhlYWRlcj4oCiAgICBwdWIgd2F0Y2g6OlJlY2VpdmVyPE9wdGlvbjxTZWFsZWRIZWFkZXI8VD4+PiwKKTsKCi8vLyBBIHRyYWl0IHRoYXQgYWxsb3dzIHRvIHJlZ2lzdGVyIHRvIGZvcmsgY2hvaWNlIHJlbGF0ZWQgZXZlbnRzCi8vLyBhbmQgZ2V0IG5vdGlmaWVkIHdoZW4gYSBuZXcgZm9yayBjaG9pY2UgaXMgYXZhaWxhYmxlLgpwdWIgdHJhaXQgRm9ya0Nob2ljZVN1YnNjcmlwdGlvbnM6IFNlbmQgKyBTeW5jIHsKICAgIC8vLyBCbG9jayBIZWFkZXIgdHlwZS4KICAgIHR5cGUgSGVhZGVyOiBDbG9uZSArIFNlbmQgKyBTeW5jICsgJ3N0YXRpYzsKCiAgICAvLy8gR2V0IG5vdGlmaWVkIHdoZW4gYSBuZXcgc2FmZSBibG9jayBvZiB0aGUgY2hhaW4gaXMgc2VsZWN0ZWQuCiAgICBmbiBzdWJzY3JpYmVfc2FmZV9ibG9jaygmc2VsZikgLT4gRm9ya0Nob2ljZU5vdGlmaWNhdGlvbnM8U2VsZjo6SGVhZGVyPjsKCiAgICAvLy8gR2V0IG5vdGlmaWVkIHdoZW4gYSBuZXcgZmluYWxpemVkIGJsb2NrIG9mIHRoZSBjaGFpbiBpcyBzZWxlY3RlZC4KICAgIGZuIHN1YnNjcmliZV9maW5hbGl6ZWRfYmxvY2soJnNlbGYpIC0+IEZvcmtDaG9pY2VOb3RpZmljYXRpb25zPFNlbGY6OkhlYWRlcj47CgogICAgLy8vIENvbnZlbmllbmNlIG1ldGhvZCB0byBnZXQgYSBzdHJlYW0gb2YgdGhlIG5ldyBzYWZlIGJsb2NrcyBvZiB0aGUgY2hhaW4uCiAgICBmbiBzYWZlX2Jsb2NrX3N0cmVhbSgmc2VsZikgLT4gRm9ya0Nob2ljZVN0cmVhbTxTZWFsZWRIZWFkZXI8U2VsZjo6SGVhZGVyPj4gewogICAgICAgIEZvcmtDaG9pY2VTdHJlYW06Om5ldyhzZWxmLnN1YnNjcmliZV9zYWZlX2Jsb2NrKCkuMCkKICAgIH0KCiAgICAvLy8gQ29udmVuaWVuY2UgbWV0aG9kIHRvIGdldCBhIHN0cmVhbSBvZiB0aGUgbmV3IGZpbmFsaXplZCBibG9ja3Mgb2YgdGhlIGNoYWluLgogICAgZm4gZmluYWxpemVkX2Jsb2NrX3N0cmVhbSgmc2VsZikgLT4gRm9ya0Nob2ljZVN0cmVhbTxTZWFsZWRIZWFkZXI8U2VsZjo6SGVhZGVyPj4gewogICAgICAgIEZvcmtDaG9pY2VTdHJlYW06Om5ldyhzZWxmLnN1YnNjcmliZV9maW5hbGl6ZWRfYmxvY2soKS4wKQogICAgfQp9CgovLy8gQSBzdHJlYW0gdGhhdCB5aWVsZHMgdmFsdWVzIGZyb20gYSBgd2F0Y2g6OlJlY2VpdmVyPE9wdGlvbjxUPj5gLCBmaWx0ZXJpbmcgb3V0IGBOb25lYCB2YWx1ZXMuCiNbZGVyaXZlKERlYnVnKV0KI1twaW5fcHJvamVjdDo6cGluX3Byb2plY3RdCnB1YiBzdHJ1Y3QgV2F0Y2hWYWx1ZVN0cmVhbTxUPiB7CiAgICAjW3Bpbl0KICAgIHN0OiBXYXRjaFN0cmVhbTxPcHRpb248VD4+LAp9CgppbXBsPFQ6IENsb25lICsgU3luYyArIFNlbmQgKyAnc3RhdGljPiBXYXRjaFZhbHVlU3RyZWFtPFQ+IHsKICAgIC8vLyBDcmVhdGVzIGEgbmV3IFtgV2F0Y2hWYWx1ZVN0cmVhbWBdCiAgICBwdWIgZm4gbmV3KHJ4OiB3YXRjaDo6UmVjZWl2ZXI8T3B0aW9uPFQ+PikgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IHN0OiBXYXRjaFN0cmVhbTo6ZnJvbV9jaGFuZ2VzKHJ4KSB9CiAgICB9Cn0KCmltcGw8VDogQ2xvbmUgKyBTeW5jICsgU2VuZCArICdzdGF0aWM+IFN0cmVhbSBmb3IgV2F0Y2hWYWx1ZVN0cmVhbTxUPiB7CiAgICB0eXBlIEl0ZW0gPSBUOwoKICAgIGZuIHBvbGxfbmV4dChtdXQgc2VsZjogUGluPCZtdXQgU2VsZj4sIGN4OiAmbXV0IENvbnRleHQ8J18+KSAtPiBQb2xsPE9wdGlvbjxTZWxmOjpJdGVtPj4gewogICAgICAgIGxvb3AgewogICAgICAgICAgICBtYXRjaCByZWFkeSEoc2VsZi5hc19tdXQoKS5wcm9qZWN0KCkuc3QucG9sbF9uZXh0KGN4KSkgewogICAgICAgICAgICAgICAgU29tZShTb21lKG5vdGlmaWNhdGlvbikpID0+IHJldHVybiBQb2xsOjpSZWFkeShTb21lKG5vdGlmaWNhdGlvbikpLAogICAgICAgICAgICAgICAgU29tZShOb25lKSA9PiB7fQogICAgICAgICAgICAgICAgTm9uZSA9PiByZXR1cm4gUG9sbDo6UmVhZHkoTm9uZSksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8vLyBBbGlhcyBmb3IgW2BXYXRjaFZhbHVlU3RyZWFtYF0gZm9yIGZvcmsgY2hvaWNlIHdhdGNoIGNoYW5uZWxzLgpwdWIgdHlwZSBGb3JrQ2hvaWNlU3RyZWFtPFQ+ID0gV2F0Y2hWYWx1ZVN0cmVhbTxUPjsKCi8vLyBXcmFwcGVyIGFyb3VuZCBhIHdhdGNoIHJlY2VpdmVyIHRoYXQgcmVjZWl2ZXMgcGVyc2lzdGVkIGJsb2NrIG5vdGlmaWNhdGlvbnMuCiNbZGVyaXZlKERlYnVnLCBEZXJlZiwgRGVyZWZNdXQpXQpwdWIgc3RydWN0IFBlcnNpc3RlZEJsb2NrTm90aWZpY2F0aW9ucyhwdWIgd2F0Y2g6OlJlY2VpdmVyPE9wdGlvbjxCbG9ja051bUhhc2g+Pik7CgovLy8gQSB0cmFpdCB0aGF0IGFsbG93cyBzdWJzY3JpYmluZyB0byBwZXJzaXN0ZWQgYmxvY2sgZXZlbnRzLgpwdWIgdHJhaXQgUGVyc2lzdGVkQmxvY2tTdWJzY3JpcHRpb25zOiBTZW5kICsgU3luYyB7CiAgICAvLy8gR2V0IG5vdGlmaWVkIHdoZW4gYSBuZXcgYmxvY2sgaXMgcGVyc2lzdGVkIHRvIGRpc2suCiAgICBmbiBzdWJzY3JpYmVfcGVyc2lzdGVkX2Jsb2NrKCZzZWxmKSAtPiBQZXJzaXN0ZWRCbG9ja05vdGlmaWNhdGlvbnM7CgogICAgLy8vIENvbnZlbmllbmNlIG1ldGhvZCB0byBnZXQgYSBzdHJlYW0gb2YgdGhlIHBlcnNpc3RlZCBibG9ja3MuCiAgICBmbiBwZXJzaXN0ZWRfYmxvY2tfc3RyZWFtKCZzZWxmKSAtPiBXYXRjaFZhbHVlU3RyZWFtPEJsb2NrTnVtSGFzaD4gewogICAgICAgIFdhdGNoVmFsdWVTdHJlYW06Om5ldyhzZWxmLnN1YnNjcmliZV9wZXJzaXN0ZWRfYmxvY2soKS4wKQogICAgfQp9CgojW2NmZyh0ZXN0KV0KbW9kIHRlc3RzIHsKICAgIHVzZSBzdXBlcjo6KjsKICAgIHVzZSBhbGxveV9jb25zZW5zdXM6OntCbG9ja0JvZHksIFNpZ25hYmxlVHJhbnNhY3Rpb24sIFR4TGVnYWN5fTsKICAgIHVzZSBhbGxveV9wcmltaXRpdmVzOjp7YjI1NiwgU2lnbmF0dXJlLCBCMjU2fTsKICAgIHVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OntSZWNlaXB0LCBUcmFuc2FjdGlvblNpZ25lZCwgVHhUeXBlfTsKICAgIHVzZSByZXRoX2V4ZWN1dGlvbl90eXBlczo6RXhlY3V0aW9uT3V0Y29tZTsKICAgIHVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjpTZWFsZWRCbG9jazsKICAgIHVzZSBzdGQ6OmNvbGxlY3Rpb25zOjpCVHJlZU1hcDsKCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2NvbW1pdF9ub3RpZmljYXRpb24oKSB7CiAgICAgICAgbGV0IGJsb2NrOiBSZWNvdmVyZWRCbG9jazxyZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrPiA9IERlZmF1bHQ6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgYmxvY2sxX2hhc2ggPSBCMjU2OjpuZXcoWzB4MDE7IDMyXSk7CiAgICAgICAgbGV0IGJsb2NrMl9oYXNoID0gQjI1Njo6bmV3KFsweDAyOyAzMl0pOwoKICAgICAgICBsZXQgbXV0IGJsb2NrMSA9IGJsb2NrLmNsb25lKCk7CiAgICAgICAgYmxvY2sxLnNldF9ibG9ja19udW1iZXIoMSk7CiAgICAgICAgYmxvY2sxLnNldF9oYXNoKGJsb2NrMV9oYXNoKTsKCiAgICAgICAgbGV0IG11dCBibG9jazIgPSBibG9jazsKICAgICAgICBibG9jazIuc2V0X2Jsb2NrX251bWJlcigyKTsKICAgICAgICBibG9jazIuc2V0X2hhc2goYmxvY2syX2hhc2gpOwoKICAgICAgICBsZXQgY2hhaW46IEFyYzxDaGFpbj4gPSBBcmM6Om5ldyhDaGFpbjo6bmV3KAogICAgICAgICAgICB2ZWMhW2Jsb2NrMS5jbG9uZSgpLCBibG9jazIuY2xvbmUoKV0sCiAgICAgICAgICAgIEV4ZWN1dGlvbk91dGNvbWU6OmRlZmF1bHQoKSwKICAgICAgICAgICAgQlRyZWVNYXA6Om5ldygpLAogICAgICAgICAgICBCVHJlZU1hcDo6bmV3KCksCiAgICAgICAgKSk7CgogICAgICAgIC8vIENyZWF0ZSBhIGNvbW1pdCBub3RpZmljYXRpb24KICAgICAgICBsZXQgbm90aWZpY2F0aW9uID0gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbjo6Q29tbWl0IHsgbmV3OiBjaGFpbi5jbG9uZSgpIH07CgogICAgICAgIC8vIFRlc3QgdGhhdCBgY29tbWl0dGVkYCByZXR1cm5zIHRoZSBjb3JyZWN0IGNoYWluCiAgICAgICAgYXNzZXJ0X2VxIShub3RpZmljYXRpb24uY29tbWl0dGVkKCksIGNoYWluKTsKCiAgICAgICAgLy8gVGVzdCB0aGF0IGByZXZlcnRlZGAgcmV0dXJucyBOb25lIGZvciBgQ29tbWl0YAogICAgICAgIGFzc2VydCEobm90aWZpY2F0aW9uLnJldmVydGVkKCkuaXNfbm9uZSgpKTsKCiAgICAgICAgLy8gVGVzdCB0aGF0IGB0aXBgIHJldHVybnMgdGhlIGNvcnJlY3QgYmxvY2sKICAgICAgICBhc3NlcnRfZXEhKCpub3RpZmljYXRpb24udGlwKCksIGJsb2NrMik7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9yZW9yZ19ub3RpZmljYXRpb24oKSB7CiAgICAgICAgbGV0IGJsb2NrOiBSZWNvdmVyZWRCbG9jazxyZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrPiA9IERlZmF1bHQ6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgYmxvY2sxX2hhc2ggPSBCMjU2OjpuZXcoWzB4MDE7IDMyXSk7CiAgICAgICAgbGV0IGJsb2NrMl9oYXNoID0gQjI1Njo6bmV3KFsweDAyOyAzMl0pOwogICAgICAgIGxldCBibG9jazNfaGFzaCA9IEIyNTY6Om5ldyhbMHgwMzsgMzJdKTsKCiAgICAgICAgbGV0IG11dCBibG9jazEgPSBibG9jay5jbG9uZSgpOwogICAgICAgIGJsb2NrMS5zZXRfYmxvY2tfbnVtYmVyKDEpOwogICAgICAgIGJsb2NrMS5zZXRfaGFzaChibG9jazFfaGFzaCk7CgogICAgICAgIGxldCBtdXQgYmxvY2syID0gYmxvY2suY2xvbmUoKTsKICAgICAgICBibG9jazIuc2V0X2Jsb2NrX251bWJlcigyKTsKICAgICAgICBibG9jazIuc2V0X2hhc2goYmxvY2syX2hhc2gpOwoKICAgICAgICBsZXQgbXV0IGJsb2NrMyA9IGJsb2NrOwogICAgICAgIGJsb2NrMy5zZXRfYmxvY2tfbnVtYmVyKDMpOwogICAgICAgIGJsb2NrMy5zZXRfaGFzaChibG9jazNfaGFzaCk7CgogICAgICAgIGxldCBvbGRfY2hhaW46IEFyYzxDaGFpbj4gPSBBcmM6Om5ldyhDaGFpbjo6bmV3KAogICAgICAgICAgICB2ZWMhW2Jsb2NrMS5jbG9uZSgpXSwKICAgICAgICAgICAgRXhlY3V0aW9uT3V0Y29tZTo6ZGVmYXVsdCgpLAogICAgICAgICAgICBCVHJlZU1hcDo6bmV3KCksCiAgICAgICAgICAgIEJUcmVlTWFwOjpuZXcoKSwKICAgICAgICApKTsKICAgICAgICBsZXQgbmV3X2NoYWluID0gQXJjOjpuZXcoQ2hhaW46Om5ldygKICAgICAgICAgICAgdmVjIVtibG9jazIuY2xvbmUoKSwgYmxvY2szLmNsb25lKCldLAogICAgICAgICAgICBFeGVjdXRpb25PdXRjb21lOjpkZWZhdWx0KCksCiAgICAgICAgICAgIEJUcmVlTWFwOjpuZXcoKSwKICAgICAgICAgICAgQlRyZWVNYXA6Om5ldygpLAogICAgICAgICkpOwoKICAgICAgICAvLyBDcmVhdGUgYSByZW9yZyBub3RpZmljYXRpb24KICAgICAgICBsZXQgbm90aWZpY2F0aW9uID0KICAgICAgICAgICAgQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbjo6UmVvcmcgeyBvbGQ6IG9sZF9jaGFpbi5jbG9uZSgpLCBuZXc6IG5ld19jaGFpbi5jbG9uZSgpIH07CgogICAgICAgIC8vIFRlc3QgdGhhdCBgcmV2ZXJ0ZWRgIHJldHVybnMgdGhlIG9sZCBjaGFpbgogICAgICAgIGFzc2VydF9lcSEobm90aWZpY2F0aW9uLnJldmVydGVkKCksIFNvbWUob2xkX2NoYWluKSk7CgogICAgICAgIC8vIFRlc3QgdGhhdCBgY29tbWl0dGVkYCByZXR1cm5zIHRoZSBuZXcgY2hhaW4KICAgICAgICBhc3NlcnRfZXEhKG5vdGlmaWNhdGlvbi5jb21taXR0ZWQoKSwgbmV3X2NoYWluKTsKCiAgICAgICAgLy8gVGVzdCB0aGF0IGB0aXBgIHJldHVybnMgdGhlIHRpcCBvZiB0aGUgbmV3IGNoYWluIChsYXN0IGJsb2NrIGluIHRoZSBuZXcgY2hhaW4pCiAgICAgICAgYXNzZXJ0X2VxISgqbm90aWZpY2F0aW9uLnRpcCgpLCBibG9jazMpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfYmxvY2tfcmVjZWlwdHNfY29tbWl0KCkgewogICAgICAgIC8vIENyZWF0ZSBhIGRlZmF1bHQgYmxvY2sgaW5zdGFuY2UgZm9yIHVzZSBpbiBibG9jayBkZWZpbml0aW9ucy4KICAgICAgICBsZXQgbXV0IGJvZHkgPSBCbG9ja0JvZHk6OjxUcmFuc2FjdGlvblNpZ25lZD46OmRlZmF1bHQoKTsKCiAgICAgICAgLy8gRGVmaW5lIHVuaXF1ZSBoYXNoZXMgZm9yIHR3byBibG9ja3MgdG8gZGlmZmVyZW50aWF0ZSB0aGVtIGluIHRoZSBjaGFpbi4KICAgICAgICBsZXQgYmxvY2sxX2hhc2ggPSBCMjU2OjpuZXcoWzB4MDE7IDMyXSk7CiAgICAgICAgbGV0IGJsb2NrMl9oYXNoID0gQjI1Njo6bmV3KFsweDAyOyAzMl0pOwoKICAgICAgICAvLyBDcmVhdGUgYSBkZWZhdWx0IHRyYW5zYWN0aW9uIHRvIGluY2x1ZGUgaW4gYmxvY2sxJ3MgdHJhbnNhY3Rpb25zLgogICAgICAgIGxldCB0eCA9IFR4TGVnYWN5OjpkZWZhdWx0KCkuaW50b19zaWduZWQoU2lnbmF0dXJlOjp0ZXN0X3NpZ25hdHVyZSgpKS5pbnRvKCk7CiAgICAgICAgYm9keS50cmFuc2FjdGlvbnMucHVzaCh0eCk7CgogICAgICAgIGxldCBibG9jayA9IFNlYWxlZEJsb2NrOjo8YWxsb3lfY29uc2Vuc3VzOjpCbG9jazxUcmFuc2FjdGlvblNpZ25lZD4+Ojpmcm9tX3NlYWxlZF9wYXJ0cygKICAgICAgICAgICAgU2VhbGVkSGVhZGVyOjpzZWFsX3Nsb3coYWxsb3lfY29uc2Vuc3VzOjpIZWFkZXI6OmRlZmF1bHQoKSksCiAgICAgICAgICAgIGJvZHksCiAgICAgICAgKQogICAgICAgIC50cnlfcmVjb3ZlcigpCiAgICAgICAgLnVud3JhcCgpOwoKICAgICAgICAvLyBDcmVhdGUgYSBjbG9uZSBvZiB0aGUgZGVmYXVsdCBibG9jayBhbmQgY3VzdG9taXplIGl0IHRvIGFjdCBhcyBibG9jazEuCiAgICAgICAgbGV0IG11dCBibG9jazEgPSBibG9jay5jbG9uZSgpOwogICAgICAgIGJsb2NrMS5zZXRfYmxvY2tfbnVtYmVyKDEpOwogICAgICAgIGJsb2NrMS5zZXRfaGFzaChibG9jazFfaGFzaCk7CgogICAgICAgIC8vIENsb25lIHRoZSBkZWZhdWx0IGJsb2NrIGFuZCBjdXN0b21pemUgaXQgdG8gYWN0IGFzIGJsb2NrMi4KICAgICAgICBsZXQgbXV0IGJsb2NrMiA9IGJsb2NrOwogICAgICAgIGJsb2NrMi5zZXRfYmxvY2tfbnVtYmVyKDIpOwogICAgICAgIGJsb2NrMi5zZXRfaGFzaChibG9jazJfaGFzaCk7CgogICAgICAgIC8vIENyZWF0ZSBhIHJlY2VpcHQgZm9yIHRoZSB0cmFuc2FjdGlvbiBpbiBibG9jazEuCiAgICAgICAgbGV0IHJlY2VpcHQxID0gUmVjZWlwdCB7CiAgICAgICAgICAgIHR4X3R5cGU6IFR4VHlwZTo6TGVnYWN5LAogICAgICAgICAgICBjdW11bGF0aXZlX2dhc191c2VkOiAxMjM0NSwKICAgICAgICAgICAgbG9nczogdmVjIVtdLAogICAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgIH07CgogICAgICAgIC8vIFdyYXAgdGhlIHJlY2VpcHQgaW4gYSBgUmVjZWlwdHNgIHN0cnVjdHVyZSwgYXMgZXhwZWN0ZWQgaW4gdGhlIGBFeGVjdXRpb25PdXRjb21lYC4KICAgICAgICBsZXQgcmVjZWlwdHMgPSB2ZWMhW3ZlYyFbcmVjZWlwdDEuY2xvbmUoKV1dOwoKICAgICAgICAvLyBEZWZpbmUgYW4gYEV4ZWN1dGlvbk91dGNvbWVgIHdpdGggdGhlIGNyZWF0ZWQgcmVjZWlwdHMuCiAgICAgICAgbGV0IGV4ZWN1dGlvbl9vdXRjb21lID0gRXhlY3V0aW9uT3V0Y29tZSB7IHJlY2VpcHRzLCAuLkRlZmF1bHQ6OmRlZmF1bHQoKSB9OwoKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgY2hhaW4gc2VnbWVudCB3aXRoIGBibG9jazFgIGFuZCBgYmxvY2syYCBhbmQgdGhlIGV4ZWN1dGlvbiBvdXRjb21lLgogICAgICAgIGxldCBuZXdfY2hhaW46IEFyYzxDaGFpbj4gPSBBcmM6Om5ldyhDaGFpbjo6bmV3KAogICAgICAgICAgICB2ZWMhW2Jsb2NrMS5jbG9uZSgpLCBibG9jazIuY2xvbmUoKV0sCiAgICAgICAgICAgIGV4ZWN1dGlvbl9vdXRjb21lLAogICAgICAgICAgICBCVHJlZU1hcDo6bmV3KCksCiAgICAgICAgICAgIEJUcmVlTWFwOjpuZXcoKSwKICAgICAgICApKTsKCiAgICAgICAgLy8gQ3JlYXRlIGEgY29tbWl0IG5vdGlmaWNhdGlvbiBjb250YWluaW5nIHRoZSBuZXcgY2hhaW4gc2VnbWVudC4KICAgICAgICBsZXQgbm90aWZpY2F0aW9uID0gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbjo6Q29tbWl0IHsgbmV3OiBuZXdfY2hhaW4gfTsKCiAgICAgICAgLy8gQ2FsbCBgYmxvY2tfcmVjZWlwdHNgIG9uIHRoZSBjb21taXQgbm90aWZpY2F0aW9uIHRvIHJldHJpZXZlIGJsb2NrIHJlY2VpcHRzLgogICAgICAgIGxldCBibG9ja19yZWNlaXB0cyA9IG5vdGlmaWNhdGlvbi5ibG9ja19yZWNlaXB0cygpOwoKICAgICAgICAvLyBBc3NlcnQgdGhhdCBvbmx5IG9uZSByZWNlaXB0IGVudHJ5IGV4aXN0cyBpbiB0aGUgYGJsb2NrX3JlY2VpcHRzYCBsaXN0LgogICAgICAgIGFzc2VydF9lcSEoYmxvY2tfcmVjZWlwdHMubGVuKCksIDEpOwoKICAgICAgICAvLyBWZXJpZnkgdGhhdCB0aGUgZmlyc3QgZW50cnkgbWF0Y2hlcyBibG9jazEncyBoYXNoIGFuZCB0cmFuc2FjdGlvbiByZWNlaXB0LgogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGJsb2NrX3JlY2VpcHRzWzBdLjAsCiAgICAgICAgICAgIEJsb2NrUmVjZWlwdHMgewogICAgICAgICAgICAgICAgYmxvY2s6IGJsb2NrMS5udW1faGFzaCgpLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBibG9jazEudGltZXN0YW1wLAogICAgICAgICAgICAgICAgdHhfcmVjZWlwdHM6IHZlYyFbKAogICAgICAgICAgICAgICAgICAgIC8vIFRyYW5zYWN0aW9uIGhhc2ggb2YgYSBUcmFuc2FjdGlvbjo6ZGVmYXVsdCgpCiAgICAgICAgICAgICAgICAgICAgYjI1NiEoIjB4MjBiNTM3OGM2ZmU5OTJjMTE4YjU1N2QyZjhlOGJiZTBiNzU2N2Y2ZmU1NDgzYThmMGYxYzUxZTkzYTlkOTFhYiIpLAogICAgICAgICAgICAgICAgICAgIHJlY2VpcHQxCiAgICAgICAgICAgICAgICApXQogICAgICAgICAgICB9CiAgICAgICAgKTsKCiAgICAgICAgLy8gQXNzZXJ0IHRoYXQgdGhlIHJlY2VpcHQgaXMgZnJvbSB0aGUgY29tbWl0dGVkIHNlZ21lbnQgKG5vdCByZXZlcnRlZCkuCiAgICAgICAgYXNzZXJ0ISghYmxvY2tfcmVjZWlwdHNbMF0uMSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9ibG9ja19yZWNlaXB0c19yZW9yZygpIHsKICAgICAgICAvLyBEZWZpbmUgYmxvY2sxIGZvciB0aGUgb2xkIGNoYWluIHNlZ21lbnQsIHdoaWNoIHdpbGwgYmUgcmV2ZXJ0ZWQuCiAgICAgICAgbGV0IG11dCBib2R5ID0gQmxvY2tCb2R5Ojo8VHJhbnNhY3Rpb25TaWduZWQ+OjpkZWZhdWx0KCk7CiAgICAgICAgYm9keS50cmFuc2FjdGlvbnMucHVzaChUeExlZ2FjeTo6ZGVmYXVsdCgpLmludG9fc2lnbmVkKFNpZ25hdHVyZTo6dGVzdF9zaWduYXR1cmUoKSkuaW50bygpKTsKICAgICAgICBsZXQgbXV0IG9sZF9ibG9jazEgPQogICAgICAgICAgICBTZWFsZWRCbG9jazo6PGFsbG95X2NvbnNlbnN1czo6QmxvY2s8VHJhbnNhY3Rpb25TaWduZWQ+Pjo6ZnJvbV9zZWFsZWRfcGFydHMoCiAgICAgICAgICAgICAgICBTZWFsZWRIZWFkZXI6OnNlYWxfc2xvdyhhbGxveV9jb25zZW5zdXM6OkhlYWRlcjo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgICAgIGJvZHksCiAgICAgICAgICAgICkKICAgICAgICAgICAgLnRyeV9yZWNvdmVyKCkKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIG9sZF9ibG9jazEuc2V0X2Jsb2NrX251bWJlcigxKTsKICAgICAgICBvbGRfYmxvY2sxLnNldF9oYXNoKEIyNTY6Om5ldyhbMHgwMTsgMzJdKSk7CgogICAgICAgIC8vIENyZWF0ZSBhIHJlY2VpcHQgZm9yIGEgdHJhbnNhY3Rpb24gaW4gdGhlIHJldmVydGVkIGJsb2NrLgogICAgICAgIGxldCBvbGRfcmVjZWlwdCA9IFJlY2VpcHQgewogICAgICAgICAgICB0eF90eXBlOiBUeFR5cGU6OkxlZ2FjeSwKICAgICAgICAgICAgY3VtdWxhdGl2ZV9nYXNfdXNlZDogNTQzMjEsCiAgICAgICAgICAgIGxvZ3M6IHZlYyFbXSwKICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgICAgfTsKICAgICAgICBsZXQgb2xkX3JlY2VpcHRzID0gdmVjIVt2ZWMhW29sZF9yZWNlaXB0LmNsb25lKCldXTsKCiAgICAgICAgbGV0IG9sZF9leGVjdXRpb25fb3V0Y29tZSA9CiAgICAgICAgICAgIEV4ZWN1dGlvbk91dGNvbWUgeyByZWNlaXB0czogb2xkX3JlY2VpcHRzLCAuLkRlZmF1bHQ6OmRlZmF1bHQoKSB9OwoKICAgICAgICAvLyBDcmVhdGUgYW4gb2xkIGNoYWluIHNlZ21lbnQgdG8gYmUgcmV2ZXJ0ZWQsIGNvbnRhaW5pbmcgYG9sZF9ibG9jazFgLgogICAgICAgIGxldCBvbGRfY2hhaW46IEFyYzxDaGFpbj4gPSBBcmM6Om5ldyhDaGFpbjo6bmV3KAogICAgICAgICAgICB2ZWMhW29sZF9ibG9jazEuY2xvbmUoKV0sCiAgICAgICAgICAgIG9sZF9leGVjdXRpb25fb3V0Y29tZSwKICAgICAgICAgICAgQlRyZWVNYXA6Om5ldygpLAogICAgICAgICAgICBCVHJlZU1hcDo6bmV3KCksCiAgICAgICAgKSk7CgogICAgICAgIC8vIERlZmluZSBibG9jazIgZm9yIHRoZSBuZXcgY2hhaW4gc2VnbWVudCwgd2hpY2ggd2lsbCBiZSBjb21taXR0ZWQuCiAgICAgICAgbGV0IG11dCBib2R5ID0gQmxvY2tCb2R5Ojo8VHJhbnNhY3Rpb25TaWduZWQ+OjpkZWZhdWx0KCk7CiAgICAgICAgYm9keS50cmFuc2FjdGlvbnMucHVzaChUeExlZ2FjeTo6ZGVmYXVsdCgpLmludG9fc2lnbmVkKFNpZ25hdHVyZTo6dGVzdF9zaWduYXR1cmUoKSkuaW50bygpKTsKICAgICAgICBsZXQgbXV0IG5ld19ibG9jazEgPQogICAgICAgICAgICBTZWFsZWRCbG9jazo6PGFsbG95X2NvbnNlbnN1czo6QmxvY2s8VHJhbnNhY3Rpb25TaWduZWQ+Pjo6ZnJvbV9zZWFsZWRfcGFydHMoCiAgICAgICAgICAgICAgICBTZWFsZWRIZWFkZXI6OnNlYWxfc2xvdyhhbGxveV9jb25zZW5zdXM6OkhlYWRlcjo6ZGVmYXVsdCgpKSwKICAgICAgICAgICAgICAgIGJvZHksCiAgICAgICAgICAgICkKICAgICAgICAgICAgLnRyeV9yZWNvdmVyKCkKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIG5ld19ibG9jazEuc2V0X2Jsb2NrX251bWJlcigyKTsKICAgICAgICBuZXdfYmxvY2sxLnNldF9oYXNoKEIyNTY6Om5ldyhbMHgwMjsgMzJdKSk7CgogICAgICAgIC8vIENyZWF0ZSBhIHJlY2VpcHQgZm9yIGEgdHJhbnNhY3Rpb24gaW4gdGhlIG5ldyBjb21taXR0ZWQgYmxvY2suCiAgICAgICAgbGV0IG5ld19yZWNlaXB0ID0gUmVjZWlwdCB7CiAgICAgICAgICAgIHR4X3R5cGU6IFR4VHlwZTo6TGVnYWN5LAogICAgICAgICAgICBjdW11bGF0aXZlX2dhc191c2VkOiAxMjM0NSwKICAgICAgICAgICAgbG9nczogdmVjIVtdLAogICAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgIH07CiAgICAgICAgbGV0IG5ld19yZWNlaXB0cyA9IHZlYyFbdmVjIVtuZXdfcmVjZWlwdC5jbG9uZSgpXV07CgogICAgICAgIGxldCBuZXdfZXhlY3V0aW9uX291dGNvbWUgPQogICAgICAgICAgICBFeGVjdXRpb25PdXRjb21lIHsgcmVjZWlwdHM6IG5ld19yZWNlaXB0cywgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfTsKCiAgICAgICAgLy8gQ3JlYXRlIGEgbmV3IGNoYWluIHNlZ21lbnQgdG8gYmUgY29tbWl0dGVkLCBjb250YWluaW5nIGBuZXdfYmxvY2sxYC4KICAgICAgICBsZXQgbmV3X2NoYWluID0gQXJjOjpuZXcoQ2hhaW46Om5ldygKICAgICAgICAgICAgdmVjIVtuZXdfYmxvY2sxLmNsb25lKCldLAogICAgICAgICAgICBuZXdfZXhlY3V0aW9uX291dGNvbWUsCiAgICAgICAgICAgIEJUcmVlTWFwOjpuZXcoKSwKICAgICAgICAgICAgQlRyZWVNYXA6Om5ldygpLAogICAgICAgICkpOwoKICAgICAgICAvLyBDcmVhdGUgYSByZW9yZyBub3RpZmljYXRpb24gd2l0aCBib3RoIHJldmVydGVkIChvbGQpIGFuZCBjb21taXR0ZWQgKG5ldykgY2hhaW4gc2VnbWVudHMuCiAgICAgICAgbGV0IG5vdGlmaWNhdGlvbiA9IENhbm9uU3RhdGVOb3RpZmljYXRpb246OlJlb3JnIHsgb2xkOiBvbGRfY2hhaW4sIG5ldzogbmV3X2NoYWluIH07CgogICAgICAgIC8vIFJldHJpZXZlIHJlY2VpcHRzIGZyb20gYm90aCBvbGQgKHJldmVydGVkKSBhbmQgbmV3IChjb21taXR0ZWQpIHNlZ21lbnRzLgogICAgICAgIGxldCBibG9ja19yZWNlaXB0cyA9IG5vdGlmaWNhdGlvbi5ibG9ja19yZWNlaXB0cygpOwoKICAgICAgICAvLyBBc3NlcnQgdGhlcmUgYXJlIHR3byByZWNlaXB0IGVudHJpZXMsIG9uZSBmcm9tIGVhY2ggY2hhaW4gc2VnbWVudC4KICAgICAgICBhc3NlcnRfZXEhKGJsb2NrX3JlY2VpcHRzLmxlbigpLCAyKTsKCiAgICAgICAgLy8gVmVyaWZ5IHRoYXQgdGhlIGZpcnN0IGVudHJ5IG1hdGNoZXMgb2xkX2Jsb2NrMSBhbmQgaXRzIHJlY2VpcHQgZnJvbSB0aGUgcmV2ZXJ0ZWQgc2VnbWVudC4KICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBibG9ja19yZWNlaXB0c1swXS4wLAogICAgICAgICAgICBCbG9ja1JlY2VpcHRzIHsKICAgICAgICAgICAgICAgIGJsb2NrOiBvbGRfYmxvY2sxLm51bV9oYXNoKCksCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG9sZF9ibG9jazEudGltZXN0YW1wLAogICAgICAgICAgICAgICAgdHhfcmVjZWlwdHM6IHZlYyFbKAogICAgICAgICAgICAgICAgICAgIC8vIFRyYW5zYWN0aW9uIGhhc2ggb2YgYSBUcmFuc2FjdGlvbjo6ZGVmYXVsdCgpCiAgICAgICAgICAgICAgICAgICAgYjI1NiEoIjB4MjBiNTM3OGM2ZmU5OTJjMTE4YjU1N2QyZjhlOGJiZTBiNzU2N2Y2ZmU1NDgzYThmMGYxYzUxZTkzYTlkOTFhYiIpLAogICAgICAgICAgICAgICAgICAgIG9sZF9yZWNlaXB0CiAgICAgICAgICAgICAgICApXQogICAgICAgICAgICB9CiAgICAgICAgKTsKICAgICAgICAvLyBDb25maXJtIHRoaXMgaXMgZnJvbSB0aGUgcmV2ZXJ0ZWQgc2VnbWVudC4KICAgICAgICBhc3NlcnQhKGJsb2NrX3JlY2VpcHRzWzBdLjEpOwoKICAgICAgICAvLyBWZXJpZnkgdGhhdCB0aGUgc2Vjb25kIGVudHJ5IG1hdGNoZXMgbmV3X2Jsb2NrMSBhbmQgaXRzIHJlY2VpcHQgZnJvbSB0aGUgY29tbWl0dGVkCiAgICAgICAgLy8gc2VnbWVudC4KICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBibG9ja19yZWNlaXB0c1sxXS4wLAogICAgICAgICAgICBCbG9ja1JlY2VpcHRzIHsKICAgICAgICAgICAgICAgIGJsb2NrOiBuZXdfYmxvY2sxLm51bV9oYXNoKCksCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ld19ibG9jazEudGltZXN0YW1wLAogICAgICAgICAgICAgICAgdHhfcmVjZWlwdHM6IHZlYyFbKAogICAgICAgICAgICAgICAgICAgIC8vIFRyYW5zYWN0aW9uIGhhc2ggb2YgYSBUcmFuc2FjdGlvbjo6ZGVmYXVsdCgpCiAgICAgICAgICAgICAgICAgICAgYjI1NiEoIjB4MjBiNTM3OGM2ZmU5OTJjMTE4YjU1N2QyZjhlOGJiZTBiNzU2N2Y2ZmU1NDgzYThmMGYxYzUxZTkzYTlkOTFhYiIpLAogICAgICAgICAgICAgICAgICAgIG5ld19yZWNlaXB0CiAgICAgICAgICAgICAgICApXQogICAgICAgICAgICB9CiAgICAgICAgKTsKICAgICAgICAvLyBDb25maXJtIHRoaXMgaXMgZnJvbSB0aGUgY29tbWl0dGVkIHNlZ21lbnQuCiAgICAgICAgYXNzZXJ0ISghYmxvY2tfcmVjZWlwdHNbMV0uMSk7CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL3N0YWdlcy9zdGFnZXMvc3JjL3N0YWdlcy9leGVjdXRpb24ucnMiPgp1c2UgY3JhdGU6OnN0YWdlczo6TUVSS0xFX1NUQUdFX0RFRkFVTFRfSU5DUkVNRU5UQUxfVEhSRVNIT0xEOwp1c2UgYWxsb3lfY29uc2Vuc3VzOjpCbG9ja0hlYWRlcjsKdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkJsb2NrTnVtYmVyOwp1c2UgbnVtX3RyYWl0czo6WmVybzsKdXNlIHJldGhfY29uZmlnOjpjb25maWc6OkV4ZWN1dGlvbkNvbmZpZzsKdXNlIHJldGhfY29uc2Vuc3VzOjpGdWxsQ29uc2Vuc3VzOwp1c2UgcmV0aF9kYjo6e3N0YXRpY19maWxlOjpIZWFkZXJNYXNrLCB0YWJsZXN9Owp1c2UgcmV0aF9ldm06OntleGVjdXRlOjpFeGVjdXRvciwgbWV0cmljczo6RXhlY3V0b3JNZXRyaWNzLCBDb25maWd1cmVFdm19Owp1c2UgcmV0aF9leGVjdXRpb25fdHlwZXM6OkNoYWluOwp1c2UgcmV0aF9leGV4Ojp7RXhFeE1hbmFnZXJIYW5kbGUsIEV4RXhOb3RpZmljYXRpb24sIEV4RXhOb3RpZmljYXRpb25Tb3VyY2V9Owp1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6e2Zvcm1hdF9nYXNfdGhyb3VnaHB1dCwgQmxvY2tCb2R5LCBOb2RlUHJpbWl0aXZlc307CnVzZSByZXRoX3Byb3ZpZGVyOjp7CiAgICBwcm92aWRlcnM6OntTdGF0aWNGaWxlUHJvdmlkZXIsIFN0YXRpY0ZpbGVXcml0ZXJ9LAogICAgQmxvY2tIYXNoUmVhZGVyLCBCbG9ja1JlYWRlciwgREJQcm92aWRlciwgRWl0aGVyV3JpdGVyLCBFeGVjdXRpb25PdXRjb21lLCBIZWFkZXJQcm92aWRlciwKICAgIExhdGVzdFN0YXRlUHJvdmlkZXJSZWYsIE9yaWdpbmFsVmFsdWVzS25vd24sIFByb3ZpZGVyRXJyb3IsIFN0YXRlV3JpdGVDb25maWcsIFN0YXRlV3JpdGVyLAogICAgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwgU3RhdHNSZWFkZXIsIFN0b3JhZ2VTZXR0aW5nc0NhY2hlLCBUcmFuc2FjdGlvblZhcmlhbnQsCn07CnVzZSByZXRoX3Jldm06OmRhdGFiYXNlOjpTdGF0ZVByb3ZpZGVyRGF0YWJhc2U7CnVzZSByZXRoX3N0YWdlc19hcGk6OnsKICAgIEJsb2NrRXJyb3JLaW5kLCBDaGVja3BvaW50QmxvY2tSYW5nZSwgRW50aXRpZXNDaGVja3BvaW50LCBFeGVjSW5wdXQsIEV4ZWNPdXRwdXQsCiAgICBFeGVjdXRpb25DaGVja3BvaW50LCBFeGVjdXRpb25TdGFnZVRocmVzaG9sZHMsIFN0YWdlLCBTdGFnZUNoZWNrcG9pbnQsIFN0YWdlRXJyb3IsIFN0YWdlSWQsCiAgICBVbndpbmRJbnB1dCwgVW53aW5kT3V0cHV0LAp9Owp1c2UgcmV0aF9zdGF0aWNfZmlsZV90eXBlczo6U3RhdGljRmlsZVNlZ21lbnQ7CnVzZSBzdGQ6OnsKICAgIGNtcDo6e21heCwgT3JkZXJpbmd9LAogICAgY29sbGVjdGlvbnM6OkJUcmVlTWFwLAogICAgb3BzOjpSYW5nZUluY2x1c2l2ZSwKICAgIHN5bmM6OkFyYywKICAgIHRhc2s6OntyZWFkeSwgQ29udGV4dCwgUG9sbH0sCiAgICB0aW1lOjp7RHVyYXRpb24sIEluc3RhbnR9LAp9Owp1c2UgdHJhY2luZzo6KjsKCnVzZSBzdXBlcjo6bWlzc2luZ19zdGF0aWNfZGF0YV9lcnJvcjsKCi8vLyBUaGUgZXhlY3V0aW9uIHN0YWdlIGV4ZWN1dGVzIGFsbCB0cmFuc2FjdGlvbnMgYW5kCi8vLyB1cGRhdGUgaGlzdG9yeSBpbmRleGVzLgovLy8KLy8vIElucHV0IHRhYmxlczoKLy8vIC0gW2B0YWJsZXM6OkNhbm9uaWNhbEhlYWRlcnNgXSBnZXQgbmV4dCBibG9jayB0byBleGVjdXRlLgovLy8gLSBbYHRhYmxlczo6SGVhZGVyc2BdIGdldCBmb3IgcmV2bSBlbnZpcm9ubWVudCB2YXJpYWJsZXMuCi8vLyAtIFtgdGFibGVzOjpCbG9ja0JvZHlJbmRpY2VzYF0gdG8gZ2V0IHR4IG51bWJlcgovLy8gLSBbYHRhYmxlczo6VHJhbnNhY3Rpb25zYF0gdG8gZXhlY3V0ZQovLy8KLy8vIEZvciBzdGF0ZSBhY2Nlc3MgW2BMYXRlc3RTdGF0ZVByb3ZpZGVyUmVmYF0gcHJvdmlkZXMgdXMgbGF0ZXN0IHN0YXRlIGFuZCBoaXN0b3J5IHN0YXRlCi8vLyBGb3IgbGF0ZXN0IG1vc3QgcmVjZW50IHN0YXRlIFtgTGF0ZXN0U3RhdGVQcm92aWRlclJlZmBdIHdvdWxkIG5lZWQgKFVzZWQgZm9yIGV4ZWN1dGlvbiBTdGFnZSk6Ci8vLyAtIFtgdGFibGVzOjpQbGFpbkFjY291bnRTdGF0ZWBdCi8vLyAtIFtgdGFibGVzOjpCeXRlY29kZXNgXQovLy8gLSBbYHRhYmxlczo6UGxhaW5TdG9yYWdlU3RhdGVgXQovLy8KLy8vIFRhYmxlcyB1cGRhdGVkIGFmdGVyIHN0YXRlIGZpbmlzaGVzIGV4ZWN1dGlvbjoKLy8vIC0gW2B0YWJsZXM6OlBsYWluQWNjb3VudFN0YXRlYF0KLy8vIC0gW2B0YWJsZXM6OlBsYWluU3RvcmFnZVN0YXRlYF0KLy8vIC0gW2B0YWJsZXM6OkJ5dGVjb2Rlc2BdCi8vLyAtIFtgdGFibGVzOjpBY2NvdW50Q2hhbmdlU2V0c2BdCi8vLyAtIFtgdGFibGVzOjpTdG9yYWdlQ2hhbmdlU2V0c2BdCi8vLwovLy8gRm9yIHVud2luZHMgd2UgYXJlIGFjY2Vzc2luZzoKLy8vIC0gW2B0YWJsZXM6OkJsb2NrQm9keUluZGljZXNgXSBnZXQgdHggaW5kZXggdG8ga25vdyB3aGF0IG5lZWRzIHRvIGJlIHVud2luZGVkCi8vLyAtIFtgdGFibGVzOjpBY2NvdW50c0hpc3RvcnlgXSB0byByZW1vdmUgY2hhbmdlIHNldCBhbmQgYXBwbHkgb2xkIHZhbHVlcyB0bwovLy8gLSBbYHRhYmxlczo6UGxhaW5BY2NvdW50U3RhdGVgXSBbYHRhYmxlczo6U3RvcmFnZXNIaXN0b3J5YF0gdG8gcmVtb3ZlIGNoYW5nZSBzZXQgYW5kIGFwcGx5IG9sZAovLy8gICB2YWx1ZXMgdG8gW2B0YWJsZXM6OlBsYWluU3RvcmFnZVN0YXRlYF0KLy8gZmFsc2UgcG9zaXRpdmUsIHdlIGNhbm5vdCBkZXJpdmUgaXQgaWYgIURCOiBEZWJ1Zy4KI1tkZXJpdmUoRGVidWcpXQpwdWIgc3RydWN0IEV4ZWN1dGlvblN0YWdlPEU+CndoZXJlCiAgICBFOiBDb25maWd1cmVFdm0sCnsKICAgIC8vLyBUaGUgc3RhZ2UncyBpbnRlcm5hbCBibG9jayBleGVjdXRvcgogICAgZXZtX2NvbmZpZzogRSwKICAgIC8vLyBUaGUgY29uc2Vuc3VzIGluc3RhbmNlIGZvciB2YWxpZGF0aW5nIGJsb2Nrcy4KICAgIGNvbnNlbnN1czogQXJjPGR5biBGdWxsQ29uc2Vuc3VzPEU6OlByaW1pdGl2ZXM+PiwKICAgIC8vLyBUaGUgY29tbWl0IHRocmVzaG9sZHMgb2YgdGhlIGV4ZWN1dGlvbiBzdGFnZS4KICAgIHRocmVzaG9sZHM6IEV4ZWN1dGlvblN0YWdlVGhyZXNob2xkcywKICAgIC8vLyBUaGUgaGlnaGVzdCB0aHJlc2hvbGQgKGluIG51bWJlciBvZiBibG9ja3MpIGZvciBzd2l0Y2hpbmcgYmV0d2VlbiBpbmNyZW1lbnRhbAogICAgLy8vIGFuZCBmdWxsIGNhbGN1bGF0aW9ucyBhY3Jvc3MgW2BzdXBlcjo6TWVya2xlU3RhZ2VgXSwgW2BzdXBlcjo6QWNjb3VudEhhc2hpbmdTdGFnZWBdIGFuZAogICAgLy8vIFtgc3VwZXI6OlN0b3JhZ2VIYXNoaW5nU3RhZ2VgXS4gVGhpcyBpcyByZXF1aXJlZCB0byBmaWd1cmUgb3V0IGlmIGNhbiBwcnVuZSBvciBub3QKICAgIC8vLyBjaGFuZ2VzZXRzIG9uIHN1YnNlcXVlbnQgcGlwZWxpbmUgcnVucy4KICAgIGV4dGVybmFsX2NsZWFuX3RocmVzaG9sZDogdTY0LAogICAgLy8vIElucHV0IGZvciB0aGUgcG9zdCBleGVjdXRlIGNvbW1pdCBob29rLgogICAgLy8vIFNldCBhZnRlciBldmVyeSBbYEV4ZWN1dGlvblN0YWdlOjpleGVjdXRlYF0gYW5kIGNsZWFyZWQgYWZ0ZXIKICAgIC8vLyBbYEV4ZWN1dGlvblN0YWdlOjpwb3N0X2V4ZWN1dGVfY29tbWl0YF0uCiAgICBwb3N0X2V4ZWN1dGVfY29tbWl0X2lucHV0OiBPcHRpb248Q2hhaW48RTo6UHJpbWl0aXZlcz4+LAogICAgLy8vIElucHV0IGZvciB0aGUgcG9zdCB1bndpbmQgY29tbWl0IGhvb2suCiAgICAvLy8gU2V0IGFmdGVyIGV2ZXJ5IFtgRXhlY3V0aW9uU3RhZ2U6OnVud2luZGBdIGFuZCBjbGVhcmVkIGFmdGVyCiAgICAvLy8gW2BFeGVjdXRpb25TdGFnZTo6cG9zdF91bndpbmRfY29tbWl0YF0uCiAgICBwb3N0X3Vud2luZF9jb21taXRfaW5wdXQ6IE9wdGlvbjxDaGFpbjxFOjpQcmltaXRpdmVzPj4sCiAgICAvLy8gSGFuZGxlIHRvIGNvbW11bmljYXRlIHdpdGggYEV4RXhgIG1hbmFnZXIuCiAgICBleGV4X21hbmFnZXJfaGFuZGxlOiBFeEV4TWFuYWdlckhhbmRsZTxFOjpQcmltaXRpdmVzPiwKICAgIC8vLyBFeGVjdXRvciBtZXRyaWNzLgogICAgbWV0cmljczogRXhlY3V0b3JNZXRyaWNzLAp9CgppbXBsPEU+IEV4ZWN1dGlvblN0YWdlPEU+CndoZXJlCiAgICBFOiBDb25maWd1cmVFdm0sCnsKICAgIC8vLyBDcmVhdGUgbmV3IGV4ZWN1dGlvbiBzdGFnZSB3aXRoIHNwZWNpZmllZCBjb25maWcuCiAgICBwdWIgZm4gbmV3KAogICAgICAgIGV2bV9jb25maWc6IEUsCiAgICAgICAgY29uc2Vuc3VzOiBBcmM8ZHluIEZ1bGxDb25zZW5zdXM8RTo6UHJpbWl0aXZlcz4+LAogICAgICAgIHRocmVzaG9sZHM6IEV4ZWN1dGlvblN0YWdlVGhyZXNob2xkcywKICAgICAgICBleHRlcm5hbF9jbGVhbl90aHJlc2hvbGQ6IHU2NCwKICAgICAgICBleGV4X21hbmFnZXJfaGFuZGxlOiBFeEV4TWFuYWdlckhhbmRsZTxFOjpQcmltaXRpdmVzPiwKICAgICkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIGV4dGVybmFsX2NsZWFuX3RocmVzaG9sZCwKICAgICAgICAgICAgZXZtX2NvbmZpZywKICAgICAgICAgICAgY29uc2Vuc3VzLAogICAgICAgICAgICB0aHJlc2hvbGRzLAogICAgICAgICAgICBwb3N0X2V4ZWN1dGVfY29tbWl0X2lucHV0OiBOb25lLAogICAgICAgICAgICBwb3N0X3Vud2luZF9jb21taXRfaW5wdXQ6IE5vbmUsCiAgICAgICAgICAgIGV4ZXhfbWFuYWdlcl9oYW5kbGUsCiAgICAgICAgICAgIG1ldHJpY3M6IEV4ZWN1dG9yTWV0cmljczo6ZGVmYXVsdCgpLAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQ3JlYXRlIGFuIGV4ZWN1dGlvbiBzdGFnZSB3aXRoIHRoZSBwcm92aWRlZCBleGVjdXRvci4KICAgIC8vLwogICAgLy8vIFRoZSBjb21taXQgdGhyZXNob2xkIHdpbGwgYmUgc2V0IHRvIFtgTUVSS0xFX1NUQUdFX0RFRkFVTFRfSU5DUkVNRU5UQUxfVEhSRVNIT0xEYF0uCiAgICBwdWIgZm4gbmV3X3dpdGhfZXhlY3V0b3IoCiAgICAgICAgZXZtX2NvbmZpZzogRSwKICAgICAgICBjb25zZW5zdXM6IEFyYzxkeW4gRnVsbENvbnNlbnN1czxFOjpQcmltaXRpdmVzPj4sCiAgICApIC0+IFNlbGYgewogICAgICAgIFNlbGY6Om5ldygKICAgICAgICAgICAgZXZtX2NvbmZpZywKICAgICAgICAgICAgY29uc2Vuc3VzLAogICAgICAgICAgICBFeGVjdXRpb25TdGFnZVRocmVzaG9sZHM6OmRlZmF1bHQoKSwKICAgICAgICAgICAgTUVSS0xFX1NUQUdFX0RFRkFVTFRfSU5DUkVNRU5UQUxfVEhSRVNIT0xELAogICAgICAgICAgICBFeEV4TWFuYWdlckhhbmRsZTo6ZW1wdHkoKSwKICAgICAgICApCiAgICB9CgogICAgLy8vIENyZWF0ZSBuZXcgaW5zdGFuY2Ugb2YgW2BFeGVjdXRpb25TdGFnZWBdIGZyb20gY29uZmlndXJhdGlvbi4KICAgIHB1YiBmbiBmcm9tX2NvbmZpZygKICAgICAgICBldm1fY29uZmlnOiBFLAogICAgICAgIGNvbnNlbnN1czogQXJjPGR5biBGdWxsQ29uc2Vuc3VzPEU6OlByaW1pdGl2ZXM+PiwKICAgICAgICBjb25maWc6IEV4ZWN1dGlvbkNvbmZpZywKICAgICAgICBleHRlcm5hbF9jbGVhbl90aHJlc2hvbGQ6IHU2NCwKICAgICkgLT4gU2VsZiB7CiAgICAgICAgU2VsZjo6bmV3KAogICAgICAgICAgICBldm1fY29uZmlnLAogICAgICAgICAgICBjb25zZW5zdXMsCiAgICAgICAgICAgIGNvbmZpZy5pbnRvKCksCiAgICAgICAgICAgIGV4dGVybmFsX2NsZWFuX3RocmVzaG9sZCwKICAgICAgICAgICAgRXhFeE1hbmFnZXJIYW5kbGU6OmVtcHR5KCksCiAgICAgICAgKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHdoZXRoZXIgd2UgY2FuIHBlcmZvcm0gcHJ1bmluZyBvZiBbYHRhYmxlczo6QWNjb3VudENoYW5nZVNldHNgXSBhbmQKICAgIC8vLyBbYHRhYmxlczo6U3RvcmFnZUNoYW5nZVNldHNgXS4KICAgIC8vLwogICAgLy8vIFRoaXMgZnVuY3Rpb24gdmVyaWZpZXMgd2hldGhlciB0aGUgW2BzdXBlcjo6TWVya2xlU3RhZ2VgXSBvciBIYXNoaW5nIHN0YWdlcyB3aWxsIHJ1biBmcm9tCiAgICAvLy8gc2NyYXRjaC4gSWYgYXQgbGVhc3Qgb25lIHN0YWdlIGlzbid0IHN0YXJ0aW5nIGFuZXcsIGl0IGltcGxpZXMgdGhhdCBwcnVuaW5nIG9mCiAgICAvLy8gY2hhbmdlc2V0cyBjYW5ub3Qgb2NjdXIuIFRoaXMgaXMgZGV0ZXJtaW5lZCBieSBjaGVja2luZyB0aGUgaGlnaGVzdCBjbGVhbiB0aHJlc2hvbGQKICAgIC8vLyAoYHNlbGYuZXh0ZXJuYWxfY2xlYW5fdGhyZXNob2xkYCkgYWNyb3NzIHRoZSBzdGFnZXMuCiAgICAvLy8KICAgIC8vLyBHaXZlbiB0aGF0IGBzdGFydF9ibG9ja2AgY2hhbmdlcyB3aXRoIGVhY2ggY2hlY2twb2ludCwgaXQncyBuZWNlc3NhcnkgdG8gaW5zcGVjdAogICAgLy8vIFtgdGFibGVzOjpBY2NvdW50c1RyaWVgXSB0byBlbnN1cmUgdGhhdCBbYHN1cGVyOjpNZXJrbGVTdGFnZWBdIGhhc24ndAogICAgLy8vIGJlZW4gcHJldmlvdXNseSBleGVjdXRlZC4KICAgIGZuIGNhbl9wcnVuZV9jaGFuZ2VzZXRzKAogICAgICAgICZzZWxmLAogICAgICAgIHByb3ZpZGVyOiBpbXBsIFN0YXRzUmVhZGVyLAogICAgICAgIHN0YXJ0X2Jsb2NrOiB1NjQsCiAgICAgICAgbWF4X2Jsb2NrOiB1NjQsCiAgICApIC0+IFJlc3VsdDxib29sLCBTdGFnZUVycm9yPiB7CiAgICAgICAgLy8gV2UgY2FuIG9ubHkgcHJ1bmUgY2hhbmdlc2V0cyBpZiB3ZSdyZSBub3QgZXhlY3V0aW5nIE1lcmtsZVN0YWdlIGZyb20gc2NyYXRjaCAoYnkKICAgICAgICAvLyB0aHJlc2hvbGQgb3IgZmlyc3Qtc3luYykKICAgICAgICBPayhtYXhfYmxvY2sgLSBzdGFydF9ibG9jayA+IHNlbGYuZXh0ZXJuYWxfY2xlYW5fdGhyZXNob2xkIHx8CiAgICAgICAgICAgIHByb3ZpZGVyLmNvdW50X2VudHJpZXM6Ojx0YWJsZXM6OkFjY291bnRzVHJpZT4oKT8uaXNfemVybygpKQogICAgfQoKICAgIC8vLyBQZXJmb3JtcyBjb25zaXN0ZW5jeSBjaGVjayBvbiBzdGF0aWMgZmlsZXMuCiAgICAvLy8KICAgIC8vLyBUaGlzIGZ1bmN0aW9uIGNvbXBhcmVzIHRoZSBoaWdoZXN0IHJlY2VpcHQgbnVtYmVyIHJlY29yZGVkIGluIHRoZSBkYXRhYmFzZSB3aXRoIHRoYXQgaW4gdGhlCiAgICAvLy8gc3RhdGljIGZpbGUgdG8gZGV0ZWN0IGFueSBkaXNjcmVwYW5jaWVzIGR1ZSB0byB1bmV4cGVjdGVkIHNodXRkb3ducyBvciBkYXRhYmFzZSByb2xsYmFja3MuCiAgICAvLy8gKipJZiB0aGUgaGVpZ2h0IGluIHRoZSBzdGF0aWMgZmlsZSBpcyBoaWdoZXIqKiwgaXQgcm9sbHMgYmFjayAodW53aW5kcykgdGhlIHN0YXRpYyBmaWxlLgogICAgLy8vICoqQ29udmVyc2VseSwgaWYgdGhlIGhlaWdodCBpbiB0aGUgZGF0YWJhc2UgaXMgbG93ZXIqKiwgaXQgdHJpZ2dlcnMgYSByb2xsYmFjayBpbiB0aGUKICAgIC8vLyBkYXRhYmFzZSAoYnkgcmV0dXJuaW5nIFtgU3RhZ2VFcnJvcmBdKSB1bnRpbCB0aGUgaGVpZ2h0cyBpbiBib3RoIHRoZSBkYXRhYmFzZSBhbmQgc3RhdGljCiAgICAvLy8gZmlsZSBtYXRjaC4KICAgIGZuIGVuc3VyZV9jb25zaXN0ZW5jeTxQcm92aWRlcj4oCiAgICAgICAgJnNlbGYsCiAgICAgICAgcHJvdmlkZXI6ICZQcm92aWRlciwKICAgICAgICBjaGVja3BvaW50OiB1NjQsCiAgICAgICAgdW53aW5kX3RvOiBPcHRpb248dTY0PiwKICAgICkgLT4gUmVzdWx0PCgpLCBTdGFnZUVycm9yPgogICAgd2hlcmUKICAgICAgICBQcm92aWRlcjogU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeQogICAgICAgICAgICArIERCUHJvdmlkZXIKICAgICAgICAgICAgKyBCbG9ja1JlYWRlcgogICAgICAgICAgICArIEhlYWRlclByb3ZpZGVyCiAgICAgICAgICAgICsgU3RvcmFnZVNldHRpbmdzQ2FjaGUsCiAgICB7CiAgICAgICAgLy8gT24gb2xkIG5vZGVzLCBpZiB0aGVyZSdzIGFueSByZWNlaXB0cyBwcnVuaW5nIGNvbmZpZ3VyZWQsIHJlY2VpcHRzIGFyZSB3cml0dGVuIGRpcmVjdGx5CiAgICAgICAgLy8gdG8gZGF0YWJhc2UgYW5kIGluY29uc2lzdGVuY2llcyBhcmUgZXhwZWN0ZWQuCiAgICAgICAgaWYgRWl0aGVyV3JpdGVyOjpyZWNlaXB0c19kZXN0aW5hdGlvbihwcm92aWRlcikuaXNfZGF0YWJhc2UoKSB7CiAgICAgICAgICAgIHJldHVybiBPaygoKSkKICAgICAgICB9CgogICAgICAgIC8vIEdldCBuZXh0IGV4cGVjdGVkIHJlY2VpcHQgbnVtYmVyCiAgICAgICAgbGV0IG5leHRfcmVjZWlwdF9udW0gPQogICAgICAgICAgICBwcm92aWRlci5ibG9ja19ib2R5X2luZGljZXMoY2hlY2twb2ludCk/Lm1hcCh8YnwgYi5uZXh0X3R4X251bSgpKS51bndyYXBfb3IoMCk7CgogICAgICAgIGxldCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IHByb3ZpZGVyLnN0YXRpY19maWxlX3Byb3ZpZGVyKCk7CgogICAgICAgIC8vIEdldCBuZXh0IGV4cGVjdGVkIHJlY2VpcHQgbnVtYmVyIGluIHN0YXRpYyBmaWxlcwogICAgICAgIGxldCBuZXh0X3N0YXRpY19maWxlX3JlY2VpcHRfbnVtID0gc3RhdGljX2ZpbGVfcHJvdmlkZXIKICAgICAgICAgICAgLmdldF9oaWdoZXN0X3N0YXRpY19maWxlX3R4KFN0YXRpY0ZpbGVTZWdtZW50OjpSZWNlaXB0cykKICAgICAgICAgICAgLm1hcCh8bnVtfCBudW0gKyAxKQogICAgICAgICAgICAudW53cmFwX29yKDApOwoKICAgICAgICAvLyBHZXQgaGlnaGVzdCBibG9jayBudW1iZXIgaW4gc3RhdGljIGZpbGVzIGZvciByZWNlaXB0cwogICAgICAgIGxldCBzdGF0aWNfZmlsZV9ibG9ja19udW0gPSBzdGF0aWNfZmlsZV9wcm92aWRlcgogICAgICAgICAgICAuZ2V0X2hpZ2hlc3Rfc3RhdGljX2ZpbGVfYmxvY2soU3RhdGljRmlsZVNlZ21lbnQ6OlJlY2VpcHRzKQogICAgICAgICAgICAudW53cmFwX29yKDApOwoKICAgICAgICAvLyBDaGVjayBpZiB3ZSBoYWQgYW55IHVuZXhwZWN0ZWQgc2h1dGRvd24gYWZ0ZXIgY29tbWl0dGluZyB0byBzdGF0aWMgZmlsZXMsIGJ1dAogICAgICAgIC8vIE5PVCBjb21taXR0aW5nIHRvIGRhdGFiYXNlLgogICAgICAgIG1hdGNoIHN0YXRpY19maWxlX2Jsb2NrX251bS5jbXAoJmNoZWNrcG9pbnQpIHsKICAgICAgICAgICAgLy8gSXQgY2FuIGJlIGVxdWFsIHdoZW4gaXQncyBhIGNoYWluIG9mIGVtcHR5IGJsb2NrcywgYnV0IHdlIHN0aWxsIG5lZWQgdG8gdXBkYXRlIHRoZQogICAgICAgICAgICAvLyBsYXN0IGJsb2NrIGluIHRoZSByYW5nZS4KICAgICAgICAgICAgT3JkZXJpbmc6OkdyZWF0ZXIgfCBPcmRlcmluZzo6RXF1YWwgPT4gewogICAgICAgICAgICAgICAgbGV0IG11dCBzdGF0aWNfZmlsZV9wcm9kdWNlciA9CiAgICAgICAgICAgICAgICAgICAgc3RhdGljX2ZpbGVfcHJvdmlkZXIubGF0ZXN0X3dyaXRlcihTdGF0aWNGaWxlU2VnbWVudDo6UmVjZWlwdHMpPzsKICAgICAgICAgICAgICAgIHN0YXRpY19maWxlX3Byb2R1Y2VyLnBydW5lX3JlY2VpcHRzKAogICAgICAgICAgICAgICAgICAgIG5leHRfc3RhdGljX2ZpbGVfcmVjZWlwdF9udW0uc2F0dXJhdGluZ19zdWIobmV4dF9yZWNlaXB0X251bSksCiAgICAgICAgICAgICAgICAgICAgY2hlY2twb2ludCwKICAgICAgICAgICAgICAgICk/OwogICAgICAgICAgICAgICAgLy8gU2luY2UgdGhpcyBpcyBhIGRhdGFiYXNlIDwtPiBzdGF0aWMgZmlsZSBpbmNvbnNpc3RlbmN5LCB3ZSBjb21taXQgdGhlIGNoYW5nZQogICAgICAgICAgICAgICAgLy8gc3RyYWlnaHQgYXdheS4KICAgICAgICAgICAgICAgIHN0YXRpY19maWxlX3Byb2R1Y2VyLmNvbW1pdCgpPzsKICAgICAgICAgICAgfQogICAgICAgICAgICBPcmRlcmluZzo6TGVzcyA9PiB7CiAgICAgICAgICAgICAgICAvLyBJZiB3ZSBhcmUgYWxyZWFkeSBpbiB0aGUgcHJvY2VzcyBvZiB1bndpbmQsIHRoaXMgbWlnaHQgYmUgZmluZSBiZWNhdXNlIHdlIHdpbGwKICAgICAgICAgICAgICAgIC8vIGZpeCB0aGUgaW5jb25zaXN0ZW5jeSByaWdodCBhd2F5LgogICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUodW53aW5kX3RvKSA9IHVud2luZF90byAmJgogICAgICAgICAgICAgICAgICAgIHVud2luZF90byA8PSBzdGF0aWNfZmlsZV9ibG9ja19udW0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2soKCkpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCB0aGlzIGlzIGEgcmVhbCBpbmNvbnNpc3RlbmN5IC0gZGF0YWJhc2UgaGFzIG1vcmUgYmxvY2tzIHRoYW4gc3RhdGljCiAgICAgICAgICAgICAgICAvLyBmaWxlcwogICAgICAgICAgICAgICAgcmV0dXJuIEVycihtaXNzaW5nX3N0YXRpY19kYXRhX2Vycm9yKAogICAgICAgICAgICAgICAgICAgIG5leHRfc3RhdGljX2ZpbGVfcmVjZWlwdF9udW0uc2F0dXJhdGluZ19zdWIoMSksCiAgICAgICAgICAgICAgICAgICAgJnN0YXRpY19maWxlX3Byb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgIFN0YXRpY0ZpbGVTZWdtZW50OjpSZWNlaXB0cywKICAgICAgICAgICAgICAgICk/KQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBPaygoKSkKICAgIH0KfQoKaW1wbDxFLCBQcm92aWRlcj4gU3RhZ2U8UHJvdmlkZXI+IGZvciBFeGVjdXRpb25TdGFnZTxFPgp3aGVyZQogICAgRTogQ29uZmlndXJlRXZtLAogICAgUHJvdmlkZXI6IERCUHJvdmlkZXIKICAgICAgICArIEJsb2NrUmVhZGVyPAogICAgICAgICAgICBCbG9jayA9IDxFOjpQcmltaXRpdmVzIGFzIE5vZGVQcmltaXRpdmVzPjo6QmxvY2ssCiAgICAgICAgICAgIEhlYWRlciA9IDxFOjpQcmltaXRpdmVzIGFzIE5vZGVQcmltaXRpdmVzPjo6QmxvY2tIZWFkZXIsCiAgICAgICAgPiArIFN0YXRpY0ZpbGVQcm92aWRlckZhY3Rvcnk8CiAgICAgICAgICAgIFByaW1pdGl2ZXM6IE5vZGVQcmltaXRpdmVzPEJsb2NrSGVhZGVyOiByZXRoX2RiX2FwaTo6dGFibGU6OlZhbHVlPiwKICAgICAgICA+ICsgU3RhdHNSZWFkZXIKICAgICAgICArIEJsb2NrSGFzaFJlYWRlcgogICAgICAgICsgU3RhdGVXcml0ZXI8UmVjZWlwdCA9IDxFOjpQcmltaXRpdmVzIGFzIE5vZGVQcmltaXRpdmVzPjo6UmVjZWlwdD4KICAgICAgICArIFN0b3JhZ2VTZXR0aW5nc0NhY2hlLAp7CiAgICAvLy8gUmV0dXJuIHRoZSBpZCBvZiB0aGUgc3RhZ2UKICAgIGZuIGlkKCZzZWxmKSAtPiBTdGFnZUlkIHsKICAgICAgICBTdGFnZUlkOjpFeGVjdXRpb24KICAgIH0KCiAgICBmbiBwb2xsX2V4ZWN1dGVfcmVhZHkoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIGN4OiAmbXV0IENvbnRleHQ8J18+LAogICAgICAgIF86IEV4ZWNJbnB1dCwKICAgICkgLT4gUG9sbDxSZXN1bHQ8KCksIFN0YWdlRXJyb3I+PiB7CiAgICAgICAgcmVhZHkhKHNlbGYuZXhleF9tYW5hZ2VyX2hhbmRsZS5wb2xsX3JlYWR5KGN4KSk7CgogICAgICAgIFBvbGw6OlJlYWR5KE9rKCgpKSkKICAgIH0KCiAgICAvLy8gRXhlY3V0ZSB0aGUgc3RhZ2UKICAgIGZuIGV4ZWN1dGUoJm11dCBzZWxmLCBwcm92aWRlcjogJlByb3ZpZGVyLCBpbnB1dDogRXhlY0lucHV0KSAtPiBSZXN1bHQ8RXhlY091dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIGlmIGlucHV0LnRhcmdldF9yZWFjaGVkKCkgewogICAgICAgICAgICByZXR1cm4gT2soRXhlY091dHB1dDo6ZG9uZShpbnB1dC5jaGVja3BvaW50KCkpKQogICAgICAgIH0KCiAgICAgICAgbGV0IHN0YXJ0X2Jsb2NrID0gaW5wdXQubmV4dF9ibG9jaygpOwogICAgICAgIGxldCBtYXhfYmxvY2sgPSBpbnB1dC50YXJnZXQoKTsKICAgICAgICBsZXQgc3RhdGljX2ZpbGVfcHJvdmlkZXIgPSBwcm92aWRlci5zdGF0aWNfZmlsZV9wcm92aWRlcigpOwoKICAgICAgICBzZWxmLmVuc3VyZV9jb25zaXN0ZW5jeShwcm92aWRlciwgaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlciwgTm9uZSk/OwoKICAgICAgICBsZXQgZGIgPSBTdGF0ZVByb3ZpZGVyRGF0YWJhc2UoTGF0ZXN0U3RhdGVQcm92aWRlclJlZjo6bmV3KHByb3ZpZGVyKSk7CiAgICAgICAgbGV0IG11dCBleGVjdXRvciA9IHNlbGYuZXZtX2NvbmZpZy5iYXRjaF9leGVjdXRvcihkYik7CgogICAgICAgIC8vIFByb2dyZXNzIHRyYWNraW5nCiAgICAgICAgbGV0IG11dCBzdGFnZV9wcm9ncmVzcyA9IHN0YXJ0X2Jsb2NrOwogICAgICAgIGxldCBtdXQgc3RhZ2VfY2hlY2twb2ludCA9IGV4ZWN1dGlvbl9jaGVja3BvaW50KAogICAgICAgICAgICAmc3RhdGljX2ZpbGVfcHJvdmlkZXIsCiAgICAgICAgICAgIHN0YXJ0X2Jsb2NrLAogICAgICAgICAgICBtYXhfYmxvY2ssCiAgICAgICAgICAgIGlucHV0LmNoZWNrcG9pbnQoKSwKICAgICAgICApPzsKCiAgICAgICAgbGV0IG11dCBmZXRjaF9ibG9ja19kdXJhdGlvbiA9IER1cmF0aW9uOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IG11dCBleGVjdXRpb25fZHVyYXRpb24gPSBEdXJhdGlvbjo6ZGVmYXVsdCgpOwoKICAgICAgICBsZXQgbXV0IGxhc3RfYmxvY2sgPSBzdGFydF9ibG9jazsKICAgICAgICBsZXQgbXV0IGxhc3RfZXhlY3V0aW9uX2R1cmF0aW9uID0gRHVyYXRpb246OmRlZmF1bHQoKTsKICAgICAgICBsZXQgbXV0IGxhc3RfY3VtdWxhdGl2ZV9nYXMgPSAwOwogICAgICAgIGxldCBtdXQgbGFzdF9sb2dfaW5zdGFudCA9IEluc3RhbnQ6Om5vdygpOwogICAgICAgIGxldCBsb2dfZHVyYXRpb24gPSBEdXJhdGlvbjo6ZnJvbV9zZWNzKDEwKTsKCiAgICAgICAgZGVidWchKHRhcmdldDogInN5bmM6OnN0YWdlczo6ZXhlY3V0aW9uIiwgc3RhcnQgPSBzdGFydF9ibG9jaywgZW5kID0gbWF4X2Jsb2NrLCAiRXhlY3V0aW5nIHJhbmdlIik7CgogICAgICAgIC8vIEV4ZWN1dGUgYmxvY2sgcmFuZ2UKICAgICAgICBsZXQgbXV0IGN1bXVsYXRpdmVfZ2FzID0gMDsKICAgICAgICBsZXQgYmF0Y2hfc3RhcnQgPSBJbnN0YW50Ojpub3coKTsKCiAgICAgICAgbGV0IG11dCBibG9ja3MgPSBWZWM6Om5ldygpOwogICAgICAgIGxldCBtdXQgcmVzdWx0cyA9IFZlYzo6bmV3KCk7CiAgICAgICAgZm9yIGJsb2NrX251bWJlciBpbiBzdGFydF9ibG9jay4uPW1heF9ibG9jayB7CiAgICAgICAgICAgIC8vIEZldGNoIHRoZSBibG9jawogICAgICAgICAgICBsZXQgZmV0Y2hfYmxvY2tfc3RhcnQgPSBJbnN0YW50Ojpub3coKTsKCiAgICAgICAgICAgIC8vIHdlIG5lZWQgdGhlIGJsb2NrJ3MgdHJhbnNhY3Rpb25zIGJ1dCB3ZSBkb24ndCBuZWVkIHRoZSB0cmFuc2FjdGlvbiBoYXNoZXMKICAgICAgICAgICAgbGV0IGJsb2NrID0gcHJvdmlkZXIKICAgICAgICAgICAgICAgIC5yZWNvdmVyZWRfYmxvY2soYmxvY2tfbnVtYmVyLmludG8oKSwgVHJhbnNhY3Rpb25WYXJpYW50OjpOb0hhc2gpPwogICAgICAgICAgICAgICAgLm9rX29yX2Vsc2UofHwgUHJvdmlkZXJFcnJvcjo6SGVhZGVyTm90Rm91bmQoYmxvY2tfbnVtYmVyLmludG8oKSkpPzsKCiAgICAgICAgICAgIGZldGNoX2Jsb2NrX2R1cmF0aW9uICs9IGZldGNoX2Jsb2NrX3N0YXJ0LmVsYXBzZWQoKTsKCiAgICAgICAgICAgIGN1bXVsYXRpdmVfZ2FzICs9IGJsb2NrLmhlYWRlcigpLmdhc191c2VkKCk7CgogICAgICAgICAgICAvLyBDb25maWd1cmUgdGhlIGV4ZWN1dG9yIHRvIHVzZSB0aGUgY3VycmVudCBzdGF0ZS4KICAgICAgICAgICAgdHJhY2UhKHRhcmdldDogInN5bmM6OnN0YWdlczo6ZXhlY3V0aW9uIiwgbnVtYmVyID0gYmxvY2tfbnVtYmVyLCB0eHMgPSBibG9jay5ib2R5KCkudHJhbnNhY3Rpb25zKCkubGVuKCksICJFeGVjdXRpbmcgYmxvY2siKTsKCiAgICAgICAgICAgIC8vIEV4ZWN1dGUgdGhlIGJsb2NrCiAgICAgICAgICAgIGxldCBleGVjdXRlX3N0YXJ0ID0gSW5zdGFudDo6bm93KCk7CgogICAgICAgICAgICBsZXQgcmVzdWx0ID0gc2VsZi5tZXRyaWNzLm1ldGVyZWRfb25lKCZibG9jaywgfGlucHV0fCB7CiAgICAgICAgICAgICAgICBleGVjdXRvci5leGVjdXRlX29uZShpbnB1dCkubWFwX2Vycih8ZXJyb3J8IFN0YWdlRXJyb3I6OkJsb2NrIHsKICAgICAgICAgICAgICAgICAgICBibG9jazogQm94OjpuZXcoYmxvY2suYmxvY2tfd2l0aF9wYXJlbnQoKSksCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IEJsb2NrRXJyb3JLaW5kOjpFeGVjdXRpb24oZXJyb3IpLAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSk/OwoKICAgICAgICAgICAgaWYgbGV0IEVycihlcnIpID0gc2VsZi5jb25zZW5zdXMudmFsaWRhdGVfYmxvY2tfcG9zdF9leGVjdXRpb24oJmJsb2NrLCAmcmVzdWx0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRXJyKFN0YWdlRXJyb3I6OkJsb2NrIHsKICAgICAgICAgICAgICAgICAgICBibG9jazogQm94OjpuZXcoYmxvY2suYmxvY2tfd2l0aF9wYXJlbnQoKSksCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IEJsb2NrRXJyb3JLaW5kOjpWYWxpZGF0aW9uKGVyciksCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdHMucHVzaChyZXN1bHQpOwoKICAgICAgICAgICAgZXhlY3V0aW9uX2R1cmF0aW9uICs9IGV4ZWN1dGVfc3RhcnQuZWxhcHNlZCgpOwoKICAgICAgICAgICAgLy8gTG9nIGV4ZWN1dGlvbiB0aHJvdWdocHV0CiAgICAgICAgICAgIGlmIGxhc3RfbG9nX2luc3RhbnQuZWxhcHNlZCgpID49IGxvZ19kdXJhdGlvbiB7CiAgICAgICAgICAgICAgICBpbmZvISgKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OmV4ZWN1dGlvbiIsCiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBsYXN0X2Jsb2NrLAogICAgICAgICAgICAgICAgICAgIGVuZCA9IGJsb2NrX251bWJlciwKICAgICAgICAgICAgICAgICAgICB0aHJvdWdocHV0ID0gZm9ybWF0X2dhc190aHJvdWdocHV0KGN1bXVsYXRpdmVfZ2FzIC0gbGFzdF9jdW11bGF0aXZlX2dhcywgZXhlY3V0aW9uX2R1cmF0aW9uIC0gbGFzdF9leGVjdXRpb25fZHVyYXRpb24pLAogICAgICAgICAgICAgICAgICAgICJFeGVjdXRlZCBibG9jayByYW5nZSIKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgbGFzdF9ibG9jayA9IGJsb2NrX251bWJlciArIDE7CiAgICAgICAgICAgICAgICBsYXN0X2V4ZWN1dGlvbl9kdXJhdGlvbiA9IGV4ZWN1dGlvbl9kdXJhdGlvbjsKICAgICAgICAgICAgICAgIGxhc3RfY3VtdWxhdGl2ZV9nYXMgPSBjdW11bGF0aXZlX2dhczsKICAgICAgICAgICAgICAgIGxhc3RfbG9nX2luc3RhbnQgPSBJbnN0YW50Ojpub3coKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RhZ2VfcHJvZ3Jlc3MgPSBibG9ja19udW1iZXI7CiAgICAgICAgICAgIHN0YWdlX2NoZWNrcG9pbnQucHJvZ3Jlc3MucHJvY2Vzc2VkICs9IGJsb2NrLmhlYWRlcigpLmdhc191c2VkKCk7CgogICAgICAgICAgICAvLyBJZiB3ZSBoYXZlIEV4RXhlcyB3ZSBuZWVkIHRvIHNhdmUgdGhlIGJsb2NrIGluIG1lbW9yeSBmb3IgbGF0ZXIKICAgICAgICAgICAgaWYgc2VsZi5leGV4X21hbmFnZXJfaGFuZGxlLmhhc19leGV4cygpIHsKICAgICAgICAgICAgICAgIGJsb2Nrcy5wdXNoKGJsb2NrKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2Ugc2hvdWxkIGNvbW1pdCBub3cKICAgICAgICAgICAgaWYgc2VsZi50aHJlc2hvbGRzLmlzX2VuZF9vZl9iYXRjaCgKICAgICAgICAgICAgICAgIGJsb2NrX251bWJlciAtIHN0YXJ0X2Jsb2NrLAogICAgICAgICAgICAgICAgZXhlY3V0b3Iuc2l6ZV9oaW50KCkgYXMgdTY0LAogICAgICAgICAgICAgICAgY3VtdWxhdGl2ZV9nYXMsCiAgICAgICAgICAgICAgICBiYXRjaF9zdGFydC5lbGFwc2VkKCksCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gcHJlcGFyZSBleGVjdXRpb24gb3V0cHV0IGZvciB3cml0aW5nCiAgICAgICAgbGV0IHRpbWUgPSBJbnN0YW50Ojpub3coKTsKICAgICAgICBsZXQgbXV0IHN0YXRlID0gRXhlY3V0aW9uT3V0Y29tZTo6ZnJvbV9ibG9ja3MoCiAgICAgICAgICAgIHN0YXJ0X2Jsb2NrLAogICAgICAgICAgICBleGVjdXRvci5pbnRvX3N0YXRlKCkudGFrZV9idW5kbGUoKSwKICAgICAgICAgICAgcmVzdWx0cywKICAgICAgICApOwogICAgICAgIGxldCB3cml0ZV9wcmVwYXJhdGlvbl9kdXJhdGlvbiA9IHRpbWUuZWxhcHNlZCgpOwoKICAgICAgICAvLyBsb2cgdGhlIGdhcyBwZXIgc2Vjb25kIGZvciB0aGUgcmFuZ2Ugd2UganVzdCBleGVjdXRlZAogICAgICAgIGRlYnVnISgKICAgICAgICAgICAgdGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpleGVjdXRpb24iLAogICAgICAgICAgICBzdGFydCA9IHN0YXJ0X2Jsb2NrLAogICAgICAgICAgICBlbmQgPSBzdGFnZV9wcm9ncmVzcywKICAgICAgICAgICAgdGhyb3VnaHB1dCA9IGZvcm1hdF9nYXNfdGhyb3VnaHB1dChjdW11bGF0aXZlX2dhcywgZXhlY3V0aW9uX2R1cmF0aW9uKSwKICAgICAgICAgICAgIkZpbmlzaGVkIGV4ZWN1dGluZyBibG9jayByYW5nZSIKICAgICAgICApOwoKICAgICAgICAvLyBQcmVwYXJlIHRoZSBpbnB1dCBmb3IgcG9zdCBleGVjdXRlIGNvbW1pdCBob29rLCB3aGVyZSBhbiBgRXhFeE5vdGlmaWNhdGlvbmAgd2lsbCBiZSBzZW50LgogICAgICAgIC8vCiAgICAgICAgLy8gTm90ZTogU2luY2Ugd2Ugb25seSB3cml0ZSB0byBgYmxvY2tzYCBpZiB0aGVyZSBhcmUgYW55IEV4RXhlcywgd2UgZG9uJ3QgbmVlZCB0byBwZXJmb3JtCiAgICAgICAgLy8gdGhlIGBoYXNfZXhleHNgIGNoZWNrIGhlcmUgYXMgd2VsbAogICAgICAgIGlmICFibG9ja3MuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgIGxldCBwcmV2aW91c19pbnB1dCA9IHNlbGYucG9zdF9leGVjdXRlX2NvbW1pdF9pbnB1dC5yZXBsYWNlKENoYWluOjpuZXcoCiAgICAgICAgICAgICAgICBibG9ja3MsCiAgICAgICAgICAgICAgICBzdGF0ZS5jbG9uZSgpLAogICAgICAgICAgICAgICAgQlRyZWVNYXA6Om5ldygpLAogICAgICAgICAgICAgICAgQlRyZWVNYXA6Om5ldygpLAogICAgICAgICAgICApKTsKCiAgICAgICAgICAgIGlmIHByZXZpb3VzX2lucHV0LmlzX3NvbWUoKSB7CiAgICAgICAgICAgICAgICAvLyBOb3QgcHJvY2Vzc2luZyB0aGUgcHJldmlvdXMgcG9zdCBleGVjdXRlIGNvbW1pdCBpbnB1dCBpcyBhIGNyaXRpY2FsIGVycm9yLCBhcyBpdAogICAgICAgICAgICAgICAgLy8gbWVhbnMgdGhhdCB3ZSBkaWRuJ3Qgc2VuZCB0aGUgbm90aWZpY2F0aW9uIHRvIEV4RXhlcwogICAgICAgICAgICAgICAgcmV0dXJuIEVycihTdGFnZUVycm9yOjpQb3N0RXhlY3V0ZUNvbW1pdCgKICAgICAgICAgICAgICAgICAgICAiUHJldmlvdXMgcG9zdCBleGVjdXRlIGNvbW1pdCBpbnB1dCB3YXNuJ3QgcHJvY2Vzc2VkIiwKICAgICAgICAgICAgICAgICkpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxldCB0aW1lID0gSW5zdGFudDo6bm93KCk7CgogICAgICAgIGlmIHNlbGYuY2FuX3BydW5lX2NoYW5nZXNldHMocHJvdmlkZXIsIHN0YXJ0X2Jsb2NrLCBtYXhfYmxvY2spPyB7CiAgICAgICAgICAgIGxldCBwcnVuZV9tb2RlcyA9IHByb3ZpZGVyLnBydW5lX21vZGVzX3JlZigpOwoKICAgICAgICAgICAgLy8gSXRlcmF0ZSBvdmVyIGFsbCByZXZlcnRzIGFuZCBjbGVhciB0aGVtIGlmIHBydW5pbmcgaXMgY29uZmlndXJlZC4KICAgICAgICAgICAgZm9yIGJsb2NrX251bWJlciBpbiBzdGFydF9ibG9jay4uPW1heF9ibG9jayB7CiAgICAgICAgICAgICAgICBsZXQgU29tZShyZXZlcnRzKSA9CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYnVuZGxlLnJldmVydHMuZ2V0X211dCgoYmxvY2tfbnVtYmVyIC0gc3RhcnRfYmxvY2spIGFzIHVzaXplKQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gSWYgYm90aCBhY2NvdW50IGhpc3RvcnkgYW5kIHN0b3JhZ2UgaGlzdG9yeSBwcnVuaW5nIGlzIGNvbmZpZ3VyZWQsIGNsZWFyIHJldmVydHMKICAgICAgICAgICAgICAgIC8vIGZvciB0aGlzIGJsb2NrLgogICAgICAgICAgICAgICAgaWYgcHJ1bmVfbW9kZXMKICAgICAgICAgICAgICAgICAgICAuYWNjb3VudF9oaXN0b3J5CiAgICAgICAgICAgICAgICAgICAgLmlzX3NvbWVfYW5kKHxtfCBtLnNob3VsZF9wcnVuZShibG9ja19udW1iZXIsIG1heF9ibG9jaykpICYmCiAgICAgICAgICAgICAgICAgICAgcHJ1bmVfbW9kZXMKICAgICAgICAgICAgICAgICAgICAgICAgLnN0b3JhZ2VfaGlzdG9yeQogICAgICAgICAgICAgICAgICAgICAgICAuaXNfc29tZV9hbmQofG18IG0uc2hvdWxkX3BydW5lKGJsb2NrX251bWJlciwgbWF4X2Jsb2NrKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXZlcnRzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIHdyaXRlIG91dHB1dAogICAgICAgIHByb3ZpZGVyLndyaXRlX3N0YXRlKCZzdGF0ZSwgT3JpZ2luYWxWYWx1ZXNLbm93bjo6WWVzLCBTdGF0ZVdyaXRlQ29uZmlnOjpkZWZhdWx0KCkpPzsKCiAgICAgICAgbGV0IGRiX3dyaXRlX2R1cmF0aW9uID0gdGltZS5lbGFwc2VkKCk7CiAgICAgICAgZGVidWchKAogICAgICAgICAgICB0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OmV4ZWN1dGlvbiIsCiAgICAgICAgICAgIGJsb2NrX2ZldGNoID0gP2ZldGNoX2Jsb2NrX2R1cmF0aW9uLAogICAgICAgICAgICBleGVjdXRpb24gPSA/ZXhlY3V0aW9uX2R1cmF0aW9uLAogICAgICAgICAgICB3cml0ZV9wcmVwYXJhdGlvbiA9ID93cml0ZV9wcmVwYXJhdGlvbl9kdXJhdGlvbiwKICAgICAgICAgICAgd3JpdGUgPSA/ZGJfd3JpdGVfZHVyYXRpb24sCiAgICAgICAgICAgICJFeGVjdXRpb24gdGltZSIKICAgICAgICApOwoKICAgICAgICBsZXQgZG9uZSA9IHN0YWdlX3Byb2dyZXNzID09IG1heF9ibG9jazsKICAgICAgICBPayhFeGVjT3V0cHV0IHsKICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoc3RhZ2VfcHJvZ3Jlc3MpCiAgICAgICAgICAgICAgICAud2l0aF9leGVjdXRpb25fc3RhZ2VfY2hlY2twb2ludChzdGFnZV9jaGVja3BvaW50KSwKICAgICAgICAgICAgZG9uZSwKICAgICAgICB9KQogICAgfQoKICAgIGZuIHBvc3RfZXhlY3V0ZV9jb21taXQoJm11dCBzZWxmKSAtPiBSZXN1bHQ8KCksIFN0YWdlRXJyb3I+IHsKICAgICAgICBsZXQgU29tZShjaGFpbikgPSBzZWxmLnBvc3RfZXhlY3V0ZV9jb21taXRfaW5wdXQudGFrZSgpIGVsc2UgeyByZXR1cm4gT2soKCkpIH07CgogICAgICAgIC8vIE5PVEU6IFdlIGNhbiBpZ25vcmUgdGhlIGVycm9yIGhlcmUsIHNpbmNlIGFuIGVycm9yIG1lYW5zIHRoYXQgdGhlIGNoYW5uZWwgaXMgY2xvc2VkLAogICAgICAgIC8vIHdoaWNoIG1lYW5zIHRoZSBtYW5hZ2VyIGhhcyBkaWVkLCB3aGljaCB0aGVuIGluIHR1cm4gbWVhbnMgdGhlIG5vZGUgaXMgc2h1dHRpbmcgZG93bi4KICAgICAgICBsZXQgXyA9IHNlbGYuZXhleF9tYW5hZ2VyX2hhbmRsZS5zZW5kKAogICAgICAgICAgICBFeEV4Tm90aWZpY2F0aW9uU291cmNlOjpQaXBlbGluZSwKICAgICAgICAgICAgRXhFeE5vdGlmaWNhdGlvbjo6Q2hhaW5Db21taXR0ZWQgeyBuZXc6IEFyYzo6bmV3KGNoYWluKSB9LAogICAgICAgICk7CgogICAgICAgIE9rKCgpKQogICAgfQoKICAgIC8vLyBVbndpbmQgdGhlIHN0YWdlLgogICAgZm4gdW53aW5kKAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICBwcm92aWRlcjogJlByb3ZpZGVyLAogICAgICAgIGlucHV0OiBVbndpbmRJbnB1dCwKICAgICkgLT4gUmVzdWx0PFVud2luZE91dHB1dCwgU3RhZ2VFcnJvcj4gewogICAgICAgIGxldCAocmFuZ2UsIHVud2luZF90bywgXykgPQogICAgICAgICAgICBpbnB1dC51bndpbmRfYmxvY2tfcmFuZ2Vfd2l0aF90aHJlc2hvbGQoc2VsZi50aHJlc2hvbGRzLm1heF9ibG9ja3MudW53cmFwX29yKHU2NDo6TUFYKSk7CiAgICAgICAgaWYgcmFuZ2UuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgIHJldHVybiBPayhVbndpbmRPdXRwdXQgewogICAgICAgICAgICAgICAgY2hlY2twb2ludDogaW5wdXQuY2hlY2twb2ludC53aXRoX2Jsb2NrX251bWJlcihpbnB1dC51bndpbmRfdG8pLAogICAgICAgICAgICB9KQogICAgICAgIH0KCiAgICAgICAgc2VsZi5lbnN1cmVfY29uc2lzdGVuY3kocHJvdmlkZXIsIGlucHV0LmNoZWNrcG9pbnQuYmxvY2tfbnVtYmVyLCBTb21lKHVud2luZF90bykpPzsKCiAgICAgICAgLy8gVW53aW5kIGFjY291bnQgYW5kIHN0b3JhZ2UgY2hhbmdlc2V0cywgYXMgd2VsbCBhcyByZWNlaXB0cy4KICAgICAgICAvLwogICAgICAgIC8vIFRoaXMgYWxzbyB1cGRhdGVzIGBQbGFpblN0b3JhZ2VTdGF0ZWAgYW5kIGBQbGFpbkFjY291bnRTdGF0ZWAuCiAgICAgICAgbGV0IGJ1bmRsZV9zdGF0ZV93aXRoX3JlY2VpcHRzID0gcHJvdmlkZXIudGFrZV9zdGF0ZV9hYm92ZSh1bndpbmRfdG8pPzsKCiAgICAgICAgLy8gUHJlcGFyZSB0aGUgaW5wdXQgZm9yIHBvc3QgdW53aW5kIGNvbW1pdCBob29rLCB3aGVyZSBhbiBgRXhFeE5vdGlmaWNhdGlvbmAgd2lsbCBiZSBzZW50LgogICAgICAgIGlmIHNlbGYuZXhleF9tYW5hZ2VyX2hhbmRsZS5oYXNfZXhleHMoKSB7CiAgICAgICAgICAgIC8vIEdldCB0aGUgYmxvY2tzIGZvciB0aGUgdW53b3VuZCByYW5nZS4KICAgICAgICAgICAgbGV0IGJsb2NrcyA9IHByb3ZpZGVyLnJlY292ZXJlZF9ibG9ja19yYW5nZShyYW5nZS5jbG9uZSgpKT87CiAgICAgICAgICAgIGxldCBwcmV2aW91c19pbnB1dCA9IHNlbGYucG9zdF91bndpbmRfY29tbWl0X2lucHV0LnJlcGxhY2UoQ2hhaW46Om5ldygKICAgICAgICAgICAgICAgIGJsb2NrcywKICAgICAgICAgICAgICAgIGJ1bmRsZV9zdGF0ZV93aXRoX3JlY2VpcHRzLAogICAgICAgICAgICAgICAgQlRyZWVNYXA6Om5ldygpLAogICAgICAgICAgICAgICAgQlRyZWVNYXA6Om5ldygpLAogICAgICAgICAgICApKTsKCiAgICAgICAgICAgIGRlYnVnX2Fzc2VydCEoCiAgICAgICAgICAgICAgICBwcmV2aW91c19pbnB1dC5pc19ub25lKCksCiAgICAgICAgICAgICAgICAiUHJldmlvdXMgcG9zdCB1bndpbmQgY29tbWl0IGlucHV0IHdhc24ndCBwcm9jZXNzZWQiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIGxldCBTb21lKHByZXZpb3VzX2lucHV0KSA9IHByZXZpb3VzX2lucHV0IHsKICAgICAgICAgICAgICAgIHRyYWNpbmc6OmRlYnVnISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OmV4ZWN1dGlvbiIsID9wcmV2aW91c19pbnB1dCwgIlByZXZpb3VzIHBvc3QgdW53aW5kIGNvbW1pdCBpbnB1dCB3YXNuJ3QgcHJvY2Vzc2VkIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSB0aGUgY2hlY2twb2ludC4KICAgICAgICBsZXQgbXV0IHN0YWdlX2NoZWNrcG9pbnQgPSBpbnB1dC5jaGVja3BvaW50LmV4ZWN1dGlvbl9zdGFnZV9jaGVja3BvaW50KCk7CiAgICAgICAgaWYgbGV0IFNvbWUoc3RhZ2VfY2hlY2twb2ludCkgPSBzdGFnZV9jaGVja3BvaW50LmFzX211dCgpIHsKICAgICAgICAgICAgZm9yIGJsb2NrX251bWJlciBpbiByYW5nZSB7CiAgICAgICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50LnByb2dyZXNzLnByb2Nlc3NlZCAtPSBwcm92aWRlcgogICAgICAgICAgICAgICAgICAgIC5oZWFkZXJfYnlfbnVtYmVyKGJsb2NrX251bWJlcik/CiAgICAgICAgICAgICAgICAgICAgLm9rX29yX2Vsc2UofHwgUHJvdmlkZXJFcnJvcjo6SGVhZGVyTm90Rm91bmQoYmxvY2tfbnVtYmVyLmludG8oKSkpPwogICAgICAgICAgICAgICAgICAgIC5nYXNfdXNlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBjaGVja3BvaW50ID0gaWYgbGV0IFNvbWUoc3RhZ2VfY2hlY2twb2ludCkgPSBzdGFnZV9jaGVja3BvaW50IHsKICAgICAgICAgICAgU3RhZ2VDaGVja3BvaW50OjpuZXcodW53aW5kX3RvKS53aXRoX2V4ZWN1dGlvbl9zdGFnZV9jaGVja3BvaW50KHN0YWdlX2NoZWNrcG9pbnQpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgU3RhZ2VDaGVja3BvaW50OjpuZXcodW53aW5kX3RvKQogICAgICAgIH07CgogICAgICAgIE9rKFVud2luZE91dHB1dCB7IGNoZWNrcG9pbnQgfSkKICAgIH0KCiAgICBmbiBwb3N0X3Vud2luZF9jb21taXQoJm11dCBzZWxmKSAtPiBSZXN1bHQ8KCksIFN0YWdlRXJyb3I+IHsKICAgICAgICBsZXQgU29tZShjaGFpbikgPSBzZWxmLnBvc3RfdW53aW5kX2NvbW1pdF9pbnB1dC50YWtlKCkgZWxzZSB7IHJldHVybiBPaygoKSkgfTsKCiAgICAgICAgLy8gTk9URTogV2UgY2FuIGlnbm9yZSB0aGUgZXJyb3IgaGVyZSwgc2luY2UgYW4gZXJyb3IgbWVhbnMgdGhhdCB0aGUgY2hhbm5lbCBpcyBjbG9zZWQsCiAgICAgICAgLy8gd2hpY2ggbWVhbnMgdGhlIG1hbmFnZXIgaGFzIGRpZWQsIHdoaWNoIHRoZW4gaW4gdHVybiBtZWFucyB0aGUgbm9kZSBpcyBzaHV0dGluZyBkb3duLgogICAgICAgIGxldCBfID0gc2VsZi5leGV4X21hbmFnZXJfaGFuZGxlLnNlbmQoCiAgICAgICAgICAgIEV4RXhOb3RpZmljYXRpb25Tb3VyY2U6OlBpcGVsaW5lLAogICAgICAgICAgICBFeEV4Tm90aWZpY2F0aW9uOjpDaGFpblJldmVydGVkIHsgb2xkOiBBcmM6Om5ldyhjaGFpbikgfSwKICAgICAgICApOwoKICAgICAgICBPaygoKSkKICAgIH0KfQoKZm4gZXhlY3V0aW9uX2NoZWNrcG9pbnQ8Tj4oCiAgICBwcm92aWRlcjogJlN0YXRpY0ZpbGVQcm92aWRlcjxOPiwKICAgIHN0YXJ0X2Jsb2NrOiBCbG9ja051bWJlciwKICAgIG1heF9ibG9jazogQmxvY2tOdW1iZXIsCiAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQsCikgLT4gUmVzdWx0PEV4ZWN1dGlvbkNoZWNrcG9pbnQsIFByb3ZpZGVyRXJyb3I+CndoZXJlCiAgICBOOiBOb2RlUHJpbWl0aXZlczxCbG9ja0hlYWRlcjogcmV0aF9kYl9hcGk6OnRhYmxlOjpWYWx1ZT4sCnsKICAgIE9rKG1hdGNoIGNoZWNrcG9pbnQuZXhlY3V0aW9uX3N0YWdlX2NoZWNrcG9pbnQoKSB7CiAgICAgICAgLy8gSWYgY2hlY2twb2ludCBibG9jayByYW5nZSBmdWxseSBtYXRjaGVzIG91ciByYW5nZSwKICAgICAgICAvLyB3ZSB0YWtlIHRoZSBwcmV2aW91c2x5IHVzZWQgc3RhZ2UgY2hlY2twb2ludCBhcy1pcy4KICAgICAgICBTb21lKHN0YWdlX2NoZWNrcG9pbnQgQCBFeGVjdXRpb25DaGVja3BvaW50IHsgYmxvY2tfcmFuZ2UsIC4uIH0pCiAgICAgICAgICAgIGlmIGJsb2NrX3JhbmdlID09IENoZWNrcG9pbnRCbG9ja1JhbmdlOjpmcm9tKHN0YXJ0X2Jsb2NrLi49bWF4X2Jsb2NrKSA9PgogICAgICAgIHsKICAgICAgICAgICAgc3RhZ2VfY2hlY2twb2ludAogICAgICAgIH0KICAgICAgICAvLyBJZiBjaGVja3BvaW50IGJsb2NrIHJhbmdlIHByZWNlZGVzIG91ciByYW5nZSBzZWFtbGVzc2x5LCB3ZSB0YWtlIHRoZSBwcmV2aW91c2x5IHVzZWQKICAgICAgICAvLyBzdGFnZSBjaGVja3BvaW50IGFuZCBhZGQgdGhlIGFtb3VudCBvZiBnYXMgZnJvbSBvdXIgcmFuZ2UgdG8gdGhlIGNoZWNrcG9pbnQgdG90YWwuCiAgICAgICAgU29tZShFeGVjdXRpb25DaGVja3BvaW50IHsKICAgICAgICAgICAgYmxvY2tfcmFuZ2U6IENoZWNrcG9pbnRCbG9ja1JhbmdlIHsgdG8sIC4uIH0sCiAgICAgICAgICAgIHByb2dyZXNzOiBFbnRpdGllc0NoZWNrcG9pbnQgeyBwcm9jZXNzZWQsIHRvdGFsIH0sCiAgICAgICAgfSkgaWYgdG8gPT0gc3RhcnRfYmxvY2sgLSAxID0+IEV4ZWN1dGlvbkNoZWNrcG9pbnQgewogICAgICAgICAgICBibG9ja19yYW5nZTogQ2hlY2twb2ludEJsb2NrUmFuZ2UgeyBmcm9tOiBzdGFydF9ibG9jaywgdG86IG1heF9ibG9jayB9LAogICAgICAgICAgICBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgIHByb2Nlc3NlZCwKICAgICAgICAgICAgICAgIHRvdGFsOiB0b3RhbCArIGNhbGN1bGF0ZV9nYXNfdXNlZF9mcm9tX2hlYWRlcnMocHJvdmlkZXIsIHN0YXJ0X2Jsb2NrLi49bWF4X2Jsb2NrKT8sCiAgICAgICAgICAgIH0sCiAgICAgICAgfSwKICAgICAgICAvLyBJZiBjaGVja3BvaW50IGJsb2NrIHJhbmdlIGVuZHMgb24gdGhlIHNhbWUgYmxvY2sgYXMgb3VyIHJhbmdlLCB3ZSB0YWtlIHRoZSBwcmV2aW91c2x5CiAgICAgICAgLy8gdXNlZCBzdGFnZSBjaGVja3BvaW50LgogICAgICAgIFNvbWUoRXhlY3V0aW9uQ2hlY2twb2ludCB7IGJsb2NrX3JhbmdlOiBDaGVja3BvaW50QmxvY2tSYW5nZSB7IHRvLCAuLiB9LCBwcm9ncmVzcyB9KQogICAgICAgICAgICBpZiB0byA9PSBtYXhfYmxvY2sgPT4KICAgICAgICB7CiAgICAgICAgICAgIEV4ZWN1dGlvbkNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgYmxvY2tfcmFuZ2U6IENoZWNrcG9pbnRCbG9ja1JhbmdlIHsgZnJvbTogc3RhcnRfYmxvY2ssIHRvOiBtYXhfYmxvY2sgfSwKICAgICAgICAgICAgICAgIHByb2dyZXNzLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIElmIHRoZXJlJ3MgYW55IG90aGVyIG5vbi1lbXB0eSBjaGVja3BvaW50LCB3ZSBjYWxjdWxhdGUgdGhlIHJlbWFpbmluZyBhbW91bnQgb2YgdG90YWwgZ2FzCiAgICAgICAgLy8gdG8gYmUgcHJvY2Vzc2VkIG5vdCBpbmNsdWRpbmcgdGhlIGNoZWNrcG9pbnQgcmFuZ2UuCiAgICAgICAgU29tZShFeGVjdXRpb25DaGVja3BvaW50IHsgcHJvZ3Jlc3M6IEVudGl0aWVzQ2hlY2twb2ludCB7IHByb2Nlc3NlZCwgLi4gfSwgLi4gfSkgPT4gewogICAgICAgICAgICBsZXQgYWZ0ZXJfY2hlY2twb2ludF9ibG9ja19udW1iZXIgPQogICAgICAgICAgICAgICAgY2FsY3VsYXRlX2dhc191c2VkX2Zyb21faGVhZGVycyhwcm92aWRlciwgY2hlY2twb2ludC5ibG9ja19udW1iZXIgKyAxLi49bWF4X2Jsb2NrKT87CgogICAgICAgICAgICBFeGVjdXRpb25DaGVja3BvaW50IHsKICAgICAgICAgICAgICAgIGJsb2NrX3JhbmdlOiBDaGVja3BvaW50QmxvY2tSYW5nZSB7IGZyb206IHN0YXJ0X2Jsb2NrLCB0bzogbWF4X2Jsb2NrIH0sCiAgICAgICAgICAgICAgICBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWQsCiAgICAgICAgICAgICAgICAgICAgdG90YWw6IHByb2Nlc3NlZCArIGFmdGVyX2NoZWNrcG9pbnRfYmxvY2tfbnVtYmVyLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBPdGhlcndpc2UsIHdlIHJlY2FsY3VsYXRlIHRoZSB3aG9sZSBzdGFnZSBjaGVja3BvaW50IGluY2x1ZGluZyB0aGUgYW1vdW50IG9mIGdhcwogICAgICAgIC8vIGFscmVhZHkgcHJvY2Vzc2VkLCBpZiB0aGVyZSdzIGFueS4KICAgICAgICBfID0+IHsKICAgICAgICAgICAgbGV0IGdlbmVzaXNfYmxvY2tfbnVtYmVyID0gcHJvdmlkZXIuZ2VuZXNpc19ibG9ja19udW1iZXIoKTsKICAgICAgICAgICAgbGV0IHByb2Nlc3NlZCA9IGNhbGN1bGF0ZV9nYXNfdXNlZF9mcm9tX2hlYWRlcnMoCiAgICAgICAgICAgICAgICBwcm92aWRlciwKICAgICAgICAgICAgICAgIGdlbmVzaXNfYmxvY2tfbnVtYmVyLi49bWF4KHN0YXJ0X2Jsb2NrIC0gMSwgZ2VuZXNpc19ibG9ja19udW1iZXIpLAogICAgICAgICAgICApPzsKCiAgICAgICAgICAgIEV4ZWN1dGlvbkNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgYmxvY2tfcmFuZ2U6IENoZWNrcG9pbnRCbG9ja1JhbmdlIHsgZnJvbTogc3RhcnRfYmxvY2ssIHRvOiBtYXhfYmxvY2sgfSwKICAgICAgICAgICAgICAgIHByb2dyZXNzOiBFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZCwKICAgICAgICAgICAgICAgICAgICB0b3RhbDogcHJvY2Vzc2VkICsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsY3VsYXRlX2dhc191c2VkX2Zyb21faGVhZGVycyhwcm92aWRlciwgc3RhcnRfYmxvY2suLj1tYXhfYmxvY2spPywKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KQp9CgovLy8gQ2FsY3VsYXRlcyB0aGUgdG90YWwgYW1vdW50IG9mIGdhcyB1c2VkIGZyb20gdGhlIGhlYWRlcnMgaW4gdGhlIGdpdmVuIHJhbmdlLgpwdWIgZm4gY2FsY3VsYXRlX2dhc191c2VkX2Zyb21faGVhZGVyczxOPigKICAgIHByb3ZpZGVyOiAmU3RhdGljRmlsZVByb3ZpZGVyPE4+LAogICAgcmFuZ2U6IFJhbmdlSW5jbHVzaXZlPEJsb2NrTnVtYmVyPiwKKSAtPiBSZXN1bHQ8dTY0LCBQcm92aWRlckVycm9yPgp3aGVyZQogICAgTjogTm9kZVByaW1pdGl2ZXM8QmxvY2tIZWFkZXI6IHJldGhfZGJfYXBpOjp0YWJsZTo6VmFsdWU+LAp7CiAgICBkZWJ1ZyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpleGVjdXRpb24iLCA/cmFuZ2UsICJDYWxjdWxhdGluZyBnYXMgdXNlZCBmcm9tIGhlYWRlcnMiKTsKCiAgICBsZXQgbXV0IGdhc190b3RhbCA9IDA7CgogICAgbGV0IHN0YXJ0ID0gSW5zdGFudDo6bm93KCk7CgogICAgZm9yIGVudHJ5IGluIHByb3ZpZGVyLmZldGNoX3JhbmdlX2l0ZXIoCiAgICAgICAgU3RhdGljRmlsZVNlZ21lbnQ6OkhlYWRlcnMsCiAgICAgICAgKnJhbmdlLnN0YXJ0KCkuLipyYW5nZS5lbmQoKSArIDEsCiAgICAgICAgfGN1cnNvciwgbnVtYmVyfCBjdXJzb3IuZ2V0X29uZTo6PEhlYWRlck1hc2s8Tjo6QmxvY2tIZWFkZXI+PihudW1iZXIuaW50bygpKSwKICAgICk/IHsKICAgICAgICBpZiBsZXQgU29tZShlbnRyeSkgPSBlbnRyeT8gewogICAgICAgICAgICBnYXNfdG90YWwgKz0gZW50cnkuZ2FzX3VzZWQoKTsKICAgICAgICB9CiAgICB9CgogICAgbGV0IGR1cmF0aW9uID0gc3RhcnQuZWxhcHNlZCgpOwogICAgZGVidWchKHRhcmdldDogInN5bmM6OnN0YWdlczo6ZXhlY3V0aW9uIiwgP3JhbmdlLCA/ZHVyYXRpb24sICJGaW5pc2hlZCBjYWxjdWxhdGluZyBnYXMgdXNlZCBmcm9tIGhlYWRlcnMiKTsKCiAgICBPayhnYXNfdG90YWwpCn0KCiNbY2ZnKHRlc3QpXQptb2QgdGVzdHMgewogICAgdXNlIHN1cGVyOjoqOwogICAgdXNlIGNyYXRlOjp7c3RhZ2VzOjpNRVJLTEVfU1RBR0VfREVGQVVMVF9SRUJVSUxEX1RIUkVTSE9MRCwgdGVzdF91dGlsczo6VGVzdFN0YWdlREJ9OwogICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OnthZGRyZXNzLCBoZXhfbGl0ZXJhbDo6aGV4LCBrZWNjYWsyNTYsIEFkZHJlc3MsIEIyNTYsIFUyNTZ9OwogICAgdXNlIGFsbG95X3JscDo6RGVjb2RhYmxlOwogICAgdXNlIGFzc2VydF9tYXRjaGVzOjphc3NlcnRfbWF0Y2hlczsKICAgIHVzZSByZXRoX2NoYWluc3BlYzo6Q2hhaW5TcGVjQnVpbGRlcjsKICAgIHVzZSByZXRoX2RiX2FwaTo6ewogICAgICAgIG1vZGVsczo6e21ldGFkYXRhOjpTdG9yYWdlU2V0dGluZ3MsIEFjY291bnRCZWZvcmVUeH0sCiAgICAgICAgdHJhbnNhY3Rpb246OntEYlR4LCBEYlR4TXV0fSwKICAgIH07CiAgICB1c2UgcmV0aF9ldGhlcmV1bV9jb25zZW5zdXM6OkV0aEJlYWNvbkNvbnNlbnN1czsKICAgIHVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OkJsb2NrOwogICAgdXNlIHJldGhfZXZtX2V0aGVyZXVtOjpFdGhFdm1Db25maWc7CiAgICB1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6e0FjY291bnQsIEJ5dGVjb2RlLCBTZWFsZWRCbG9jaywgU3RvcmFnZUVudHJ5fTsKICAgIHVzZSByZXRoX3Byb3ZpZGVyOjp7CiAgICAgICAgdGVzdF91dGlsczo6Y3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeSwgQWNjb3VudFJlYWRlciwgQmxvY2tXcml0ZXIsCiAgICAgICAgRGF0YWJhc2VQcm92aWRlckZhY3RvcnksIFJlY2VpcHRQcm92aWRlciwgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwKICAgIH07CiAgICB1c2UgcmV0aF9wcnVuZTo6UHJ1bmVNb2RlczsKICAgIHVzZSByZXRoX3BydW5lX3R5cGVzOjp7UHJ1bmVNb2RlLCBSZWNlaXB0c0xvZ1BydW5lQ29uZmlnfTsKICAgIHVzZSByZXRoX3N0YWdlc19hcGk6OlN0YWdlVW5pdENoZWNrcG9pbnQ7CiAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjpnZW5lcmF0b3JzOwogICAgdXNlIHN0ZDo6Y29sbGVjdGlvbnM6OkJUcmVlTWFwOwoKICAgIGZuIHN0YWdlKCkgLT4gRXhlY3V0aW9uU3RhZ2U8RXRoRXZtQ29uZmlnPiB7CiAgICAgICAgbGV0IGV2bV9jb25maWcgPQogICAgICAgICAgICBFdGhFdm1Db25maWc6Om5ldyhBcmM6Om5ldyhDaGFpblNwZWNCdWlsZGVyOjptYWlubmV0KCkuYmVybGluX2FjdGl2YXRlZCgpLmJ1aWxkKCkpKTsKICAgICAgICBsZXQgY29uc2Vuc3VzID0gQXJjOjpuZXcoRXRoQmVhY29uQ29uc2Vuc3VzOjpuZXcoQXJjOjpuZXcoCiAgICAgICAgICAgIENoYWluU3BlY0J1aWxkZXI6Om1haW5uZXQoKS5iZXJsaW5fYWN0aXZhdGVkKCkuYnVpbGQoKSwKICAgICAgICApKSk7CiAgICAgICAgRXhlY3V0aW9uU3RhZ2U6Om5ldygKICAgICAgICAgICAgZXZtX2NvbmZpZywKICAgICAgICAgICAgY29uc2Vuc3VzLAogICAgICAgICAgICBFeGVjdXRpb25TdGFnZVRocmVzaG9sZHMgewogICAgICAgICAgICAgICAgbWF4X2Jsb2NrczogU29tZSgxMDApLAogICAgICAgICAgICAgICAgbWF4X2NoYW5nZXM6IE5vbmUsCiAgICAgICAgICAgICAgICBtYXhfY3VtdWxhdGl2ZV9nYXM6IE5vbmUsCiAgICAgICAgICAgICAgICBtYXhfZHVyYXRpb246IE5vbmUsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIE1FUktMRV9TVEFHRV9ERUZBVUxUX1JFQlVJTERfVEhSRVNIT0xELAogICAgICAgICAgICBFeEV4TWFuYWdlckhhbmRsZTo6ZW1wdHkoKSwKICAgICAgICApCiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gZXhlY3V0aW9uX2NoZWNrcG9pbnRfbWF0Y2hlcygpIHsKICAgICAgICBsZXQgZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKCiAgICAgICAgbGV0IHByZXZpb3VzX3N0YWdlX2NoZWNrcG9pbnQgPSBFeGVjdXRpb25DaGVja3BvaW50IHsKICAgICAgICAgICAgYmxvY2tfcmFuZ2U6IENoZWNrcG9pbnRCbG9ja1JhbmdlIHsgZnJvbTogMCwgdG86IDAgfSwKICAgICAgICAgICAgcHJvZ3Jlc3M6IEVudGl0aWVzQ2hlY2twb2ludCB7IHByb2Nlc3NlZDogMSwgdG90YWw6IDIgfSwKICAgICAgICB9OwogICAgICAgIGxldCBwcmV2aW91c19jaGVja3BvaW50ID0gU3RhZ2VDaGVja3BvaW50IHsKICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiAwLAogICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50OiBTb21lKFN0YWdlVW5pdENoZWNrcG9pbnQ6OkV4ZWN1dGlvbihwcmV2aW91c19zdGFnZV9jaGVja3BvaW50KSksCiAgICAgICAgfTsKCiAgICAgICAgbGV0IHN0YWdlX2NoZWNrcG9pbnQgPSBleGVjdXRpb25fY2hlY2twb2ludCgKICAgICAgICAgICAgJmZhY3Rvcnkuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKSwKICAgICAgICAgICAgcHJldmlvdXNfc3RhZ2VfY2hlY2twb2ludC5ibG9ja19yYW5nZS5mcm9tLAogICAgICAgICAgICBwcmV2aW91c19zdGFnZV9jaGVja3BvaW50LmJsb2NrX3JhbmdlLnRvLAogICAgICAgICAgICBwcmV2aW91c19jaGVja3BvaW50LAogICAgICAgICk7CgogICAgICAgIGFzc2VydCEoCiAgICAgICAgICAgIG1hdGNoZXMhKHN0YWdlX2NoZWNrcG9pbnQsIE9rKGNoZWNrcG9pbnQpIGlmIGNoZWNrcG9pbnQgPT0gcHJldmlvdXNfc3RhZ2VfY2hlY2twb2ludCkKICAgICAgICApOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIGV4ZWN1dGlvbl9jaGVja3BvaW50X3ByZWNlZGVzKCkgewogICAgICAgIGxldCBmYWN0b3J5ID0gY3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeSgpOwogICAgICAgIGxldCBwcm92aWRlciA9IGZhY3RvcnkucHJvdmlkZXJfcncoKS51bndyYXAoKTsKCiAgICAgICAgbGV0IG11dCBnZW5lc2lzX3JscCA9IGhleCEoImY5MDFmYWY5MDFmNWEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMGEwMWRjYzRkZThkZWM3NWQ3YWFiODViNTY3YjZjY2Q0MWFkMzEyNDUxYjk0OGE3NDEzZjBhMTQyZmQ0MGQ0OTM0Nzk0MmFkYzI1NjY1MDE4YWExZmUwZTZiYzY2NmRhYzhmYzI2OTdmZjliYWEwNDU1NzFiNDBhZTY2Y2E3NDgwNzkxYmJiMjg4NzI4NmU0ZTRjNGIxYjI5OGIxOTFjODg5ZDY5NTkwMjNhMzJlZGEwNTZlODFmMTcxYmNjNTVhNmZmODM0NWU2OTJjMGY4NmU1YjQ4ZTAxYjk5NmNhZGMwMDE2MjJmYjVlMzYzYjQyMWEwNTZlODFmMTcxYmNjNTVhNmZmODM0NWU2OTJjMGY4NmU1YjQ4ZTAxYjk5NmNhZGMwMDE2MjJmYjVlMzYzYjQyMWI5MDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODMwMjAwMDA4MDg1MDI1NDBiZTQwMDgwODAwMGEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDg4MDAwMDAwMDAwMDAwMDAwMGMwYzAiKS5hc19zbGljZSgpOwogICAgICAgIGxldCBnZW5lc2lzID0gU2VhbGVkQmxvY2s6OjxCbG9jaz46OmRlY29kZSgmbXV0IGdlbmVzaXNfcmxwKS51bndyYXAoKTsKICAgICAgICBsZXQgbXV0IGJsb2NrX3JscCA9IGhleCEoImY5MDI2MmY5MDFmOWEwNzVjMzcxYmE0NTk5OWQ4N2Y0NTQyMzI2OTEwYTExYWY1MTU4OTdhZWJjZTUyNjVkM2Y2YWNkMWYxMTYxZjgyZmEwMWRjYzRkZThkZWM3NWQ3YWFiODViNTY3YjZjY2Q0MWFkMzEyNDUxYjk0OGE3NDEzZjBhMTQyZmQ0MGQ0OTM0Nzk0MmFkYzI1NjY1MDE4YWExZmUwZTZiYzY2NmRhYzhmYzI2OTdmZjliYWEwOThmMmRjZDg3YzhhZTQwODNlNzAxN2EwNTQ1NmMxNGVlYTRiMWRiMjAzMjEyNmUyN2IzYjE1NjNkNTdkN2NjMGEwODE1MWQ1NDgyNzNmNjY4MzE2OTUyNGI2NmNhOWZlMzM4YjljZTQyYmMzNTQwMDQ2YzgyOGZkOTM5YWUyM2JjYmEwM2Y0ZTVjMmVjNWIyMTcwYjcxMWQ5N2VlNzU1YzE2MDQ1N2JiNThkOGRhYTMzOGU4MzVlYzAyYWU2ODYwYmJhYmI5MDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODMwMjAwMDAwMTg1MDI1NDBiZTQwMDgyYTg3OTgyMDNlODAwYTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODgwMDAwMDAwMDAwMDAwMDAwZjg2M2Y4NjE4MDBhODQwNWY1ZTEwMDk0MTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDgwODAxYmEwN2UwOWUyNjY3OGVkNGZhYzA4YTI0OWViZThlZDY4MGJmOTA1MWE1ZTE0YWQyMjNlNGIyYjlkMjZlMDIwOGYzN2EwNWY2ZTNmMTg4ZTNlNmVhYjdkN2QzYjY1NjhmNWVhYzdkNjg3YjA4ZDMwN2QzMTU0Y2NkOGM4N2I0NjMwNTA5YmMwIikuYXNfc2xpY2UoKTsKICAgICAgICBsZXQgYmxvY2sgPSBTZWFsZWRCbG9jazo6PEJsb2NrPjo6ZGVjb2RlKCZtdXQgYmxvY2tfcmxwKS51bndyYXAoKTsKICAgICAgICBwcm92aWRlci5pbnNlcnRfYmxvY2soJmdlbmVzaXMudHJ5X3JlY292ZXIoKS51bndyYXAoKSkudW53cmFwKCk7CiAgICAgICAgcHJvdmlkZXIuaW5zZXJ0X2Jsb2NrKCZibG9jay5jbG9uZSgpLnRyeV9yZWNvdmVyKCkudW53cmFwKCkpLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyCiAgICAgICAgICAgIC5zdGF0aWNfZmlsZV9wcm92aWRlcigpCiAgICAgICAgICAgIC5sYXRlc3Rfd3JpdGVyKFN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKQogICAgICAgICAgICAudW53cmFwKCkKICAgICAgICAgICAgLmNvbW1pdCgpCiAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICBwcm92aWRlci5jb21taXQoKS51bndyYXAoKTsKCiAgICAgICAgbGV0IHByZXZpb3VzX3N0YWdlX2NoZWNrcG9pbnQgPSBFeGVjdXRpb25DaGVja3BvaW50IHsKICAgICAgICAgICAgYmxvY2tfcmFuZ2U6IENoZWNrcG9pbnRCbG9ja1JhbmdlIHsgZnJvbTogMCwgdG86IDAgfSwKICAgICAgICAgICAgcHJvZ3Jlc3M6IEVudGl0aWVzQ2hlY2twb2ludCB7IHByb2Nlc3NlZDogMSwgdG90YWw6IDEgfSwKICAgICAgICB9OwogICAgICAgIGxldCBwcmV2aW91c19jaGVja3BvaW50ID0gU3RhZ2VDaGVja3BvaW50IHsKICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiAxLAogICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50OiBTb21lKFN0YWdlVW5pdENoZWNrcG9pbnQ6OkV4ZWN1dGlvbihwcmV2aW91c19zdGFnZV9jaGVja3BvaW50KSksCiAgICAgICAgfTsKCiAgICAgICAgbGV0IHN0YWdlX2NoZWNrcG9pbnQgPQogICAgICAgICAgICBleGVjdXRpb25fY2hlY2twb2ludCgmZmFjdG9yeS5zdGF0aWNfZmlsZV9wcm92aWRlcigpLCAxLCAxLCBwcmV2aW91c19jaGVja3BvaW50KTsKCiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKHN0YWdlX2NoZWNrcG9pbnQsIE9rKEV4ZWN1dGlvbkNoZWNrcG9pbnQgewogICAgICAgICAgICBibG9ja19yYW5nZTogQ2hlY2twb2ludEJsb2NrUmFuZ2UgeyBmcm9tOiAxLCB0bzogMSB9LAogICAgICAgICAgICBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgIHByb2Nlc3NlZCwKICAgICAgICAgICAgICAgIHRvdGFsCiAgICAgICAgICAgIH0KICAgICAgICB9KSBpZiBwcm9jZXNzZWQgPT0gcHJldmlvdXNfc3RhZ2VfY2hlY2twb2ludC5wcm9ncmVzcy5wcm9jZXNzZWQgJiYKICAgICAgICAgICAgdG90YWwgPT0gcHJldmlvdXNfc3RhZ2VfY2hlY2twb2ludC5wcm9ncmVzcy50b3RhbCArIGJsb2NrLmdhc191c2VkKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiBleGVjdXRpb25fY2hlY2twb2ludF9yZWNhbGN1bGF0ZV9mdWxsX3ByZXZpb3VzX3NvbWUoKSB7CiAgICAgICAgbGV0IGZhY3RvcnkgPSBjcmVhdGVfdGVzdF9wcm92aWRlcl9mYWN0b3J5KCk7CiAgICAgICAgbGV0IHByb3ZpZGVyID0gZmFjdG9yeS5wcm92aWRlcl9ydygpLnVud3JhcCgpOwoKICAgICAgICBsZXQgbXV0IGdlbmVzaXNfcmxwID0gaGV4ISgiZjkwMWZhZjkwMWY1YTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwYTAxZGNjNGRlOGRlYzc1ZDdhYWI4NWI1NjdiNmNjZDQxYWQzMTI0NTFiOTQ4YTc0MTNmMGExNDJmZDQwZDQ5MzQ3OTQyYWRjMjU2NjUwMThhYTFmZTBlNmJjNjY2ZGFjOGZjMjY5N2ZmOWJhYTA0NTU3MWI0MGFlNjZjYTc0ODA3OTFiYmIyODg3Mjg2ZTRlNGM0YjFiMjk4YjE5MWM4ODlkNjk1OTAyM2EzMmVkYTA1NmU4MWYxNzFiY2M1NWE2ZmY4MzQ1ZTY5MmMwZjg2ZTViNDhlMDFiOTk2Y2FkYzAwMTYyMmZiNWUzNjNiNDIxYTA1NmU4MWYxNzFiY2M1NWE2ZmY4MzQ1ZTY5MmMwZjg2ZTViNDhlMDFiOTk2Y2FkYzAwMTYyMmZiNWUzNjNiNDIxYjkwMTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4MzAyMDAwMDgwODUwMjU0MGJlNDAwODA4MDAwYTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODgwMDAwMDAwMDAwMDAwMDAwYzBjMCIpLmFzX3NsaWNlKCk7CiAgICAgICAgbGV0IGdlbmVzaXMgPSBTZWFsZWRCbG9jazo6PEJsb2NrPjo6ZGVjb2RlKCZtdXQgZ2VuZXNpc19ybHApLnVud3JhcCgpOwogICAgICAgIGxldCBtdXQgYmxvY2tfcmxwID0gaGV4ISgiZjkwMjYyZjkwMWY5YTA3NWMzNzFiYTQ1OTk5ZDg3ZjQ1NDIzMjY5MTBhMTFhZjUxNTg5N2FlYmNlNTI2NWQzZjZhY2QxZjExNjFmODJmYTAxZGNjNGRlOGRlYzc1ZDdhYWI4NWI1NjdiNmNjZDQxYWQzMTI0NTFiOTQ4YTc0MTNmMGExNDJmZDQwZDQ5MzQ3OTQyYWRjMjU2NjUwMThhYTFmZTBlNmJjNjY2ZGFjOGZjMjY5N2ZmOWJhYTA5OGYyZGNkODdjOGFlNDA4M2U3MDE3YTA1NDU2YzE0ZWVhNGIxZGIyMDMyMTI2ZTI3YjNiMTU2M2Q1N2Q3Y2MwYTA4MTUxZDU0ODI3M2Y2NjgzMTY5NTI0YjY2Y2E5ZmUzMzhiOWNlNDJiYzM1NDAwNDZjODI4ZmQ5MzlhZTIzYmNiYTAzZjRlNWMyZWM1YjIxNzBiNzExZDk3ZWU3NTVjMTYwNDU3YmI1OGQ4ZGFhMzM4ZTgzNWVjMDJhZTY4NjBiYmFiYjkwMTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4MzAyMDAwMDAxODUwMjU0MGJlNDAwODJhODc5ODIwM2U4MDBhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4ODAwMDAwMDAwMDAwMDAwMDBmODYzZjg2MTgwMGE4NDA1ZjVlMTAwOTQxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODA4MDFiYTA3ZTA5ZTI2Njc4ZWQ0ZmFjMDhhMjQ5ZWJlOGVkNjgwYmY5MDUxYTVlMTRhZDIyM2U0YjJiOWQyNmUwMjA4ZjM3YTA1ZjZlM2YxODhlM2U2ZWFiN2Q3ZDNiNjU2OGY1ZWFjN2Q2ODdiMDhkMzA3ZDMxNTRjY2Q4Yzg3YjQ2MzA1MDliYzAiKS5hc19zbGljZSgpOwogICAgICAgIGxldCBibG9jayA9IFNlYWxlZEJsb2NrOjo8QmxvY2s+OjpkZWNvZGUoJm11dCBibG9ja19ybHApLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyLmluc2VydF9ibG9jaygmZ2VuZXNpcy50cnlfcmVjb3ZlcigpLnVud3JhcCgpKS51bndyYXAoKTsKICAgICAgICBwcm92aWRlci5pbnNlcnRfYmxvY2soJmJsb2NrLmNsb25lKCkudHJ5X3JlY292ZXIoKS51bndyYXAoKSkudW53cmFwKCk7CiAgICAgICAgcHJvdmlkZXIKICAgICAgICAgICAgLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkKICAgICAgICAgICAgLmxhdGVzdF93cml0ZXIoU3RhdGljRmlsZVNlZ21lbnQ6OkhlYWRlcnMpCiAgICAgICAgICAgIC51bndyYXAoKQogICAgICAgICAgICAuY29tbWl0KCkKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyLmNvbW1pdCgpLnVud3JhcCgpOwoKICAgICAgICBsZXQgcHJldmlvdXNfc3RhZ2VfY2hlY2twb2ludCA9IEV4ZWN1dGlvbkNoZWNrcG9pbnQgewogICAgICAgICAgICBibG9ja19yYW5nZTogQ2hlY2twb2ludEJsb2NrUmFuZ2UgeyBmcm9tOiAwLCB0bzogMCB9LAogICAgICAgICAgICBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50IHsgcHJvY2Vzc2VkOiAxLCB0b3RhbDogMSB9LAogICAgICAgIH07CiAgICAgICAgbGV0IHByZXZpb3VzX2NoZWNrcG9pbnQgPSBTdGFnZUNoZWNrcG9pbnQgewogICAgICAgICAgICBibG9ja19udW1iZXI6IDEsCiAgICAgICAgICAgIHN0YWdlX2NoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VVbml0Q2hlY2twb2ludDo6RXhlY3V0aW9uKHByZXZpb3VzX3N0YWdlX2NoZWNrcG9pbnQpKSwKICAgICAgICB9OwoKICAgICAgICBsZXQgc3RhZ2VfY2hlY2twb2ludCA9CiAgICAgICAgICAgIGV4ZWN1dGlvbl9jaGVja3BvaW50KCZmYWN0b3J5LnN0YXRpY19maWxlX3Byb3ZpZGVyKCksIDEsIDEsIHByZXZpb3VzX2NoZWNrcG9pbnQpOwoKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoc3RhZ2VfY2hlY2twb2ludCwgT2soRXhlY3V0aW9uQ2hlY2twb2ludCB7CiAgICAgICAgICAgIGJsb2NrX3JhbmdlOiBDaGVja3BvaW50QmxvY2tSYW5nZSB7IGZyb206IDEsIHRvOiAxIH0sCiAgICAgICAgICAgIHByb2dyZXNzOiBFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgcHJvY2Vzc2VkLAogICAgICAgICAgICAgICAgdG90YWwKICAgICAgICAgICAgfQogICAgICAgIH0pIGlmIHByb2Nlc3NlZCA9PSBwcmV2aW91c19zdGFnZV9jaGVja3BvaW50LnByb2dyZXNzLnByb2Nlc3NlZCAmJgogICAgICAgICAgICB0b3RhbCA9PSBwcmV2aW91c19zdGFnZV9jaGVja3BvaW50LnByb2dyZXNzLnRvdGFsICsgYmxvY2suZ2FzX3VzZWQoKSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gZXhlY3V0aW9uX2NoZWNrcG9pbnRfcmVjYWxjdWxhdGVfZnVsbF9wcmV2aW91c19ub25lKCkgewogICAgICAgIGxldCBmYWN0b3J5ID0gY3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeSgpOwogICAgICAgIGxldCBwcm92aWRlciA9IGZhY3RvcnkucHJvdmlkZXJfcncoKS51bndyYXAoKTsKCiAgICAgICAgbGV0IG11dCBnZW5lc2lzX3JscCA9IGhleCEoImY5MDFmYWY5MDFmNWEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMGEwMWRjYzRkZThkZWM3NWQ3YWFiODViNTY3YjZjY2Q0MWFkMzEyNDUxYjk0OGE3NDEzZjBhMTQyZmQ0MGQ0OTM0Nzk0MmFkYzI1NjY1MDE4YWExZmUwZTZiYzY2NmRhYzhmYzI2OTdmZjliYWEwNDU1NzFiNDBhZTY2Y2E3NDgwNzkxYmJiMjg4NzI4NmU0ZTRjNGIxYjI5OGIxOTFjODg5ZDY5NTkwMjNhMzJlZGEwNTZlODFmMTcxYmNjNTVhNmZmODM0NWU2OTJjMGY4NmU1YjQ4ZTAxYjk5NmNhZGMwMDE2MjJmYjVlMzYzYjQyMWEwNTZlODFmMTcxYmNjNTVhNmZmODM0NWU2OTJjMGY4NmU1YjQ4ZTAxYjk5NmNhZGMwMDE2MjJmYjVlMzYzYjQyMWI5MDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODMwMjAwMDA4MDg1MDI1NDBiZTQwMDgwODAwMGEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDg4MDAwMDAwMDAwMDAwMDAwMGMwYzAiKS5hc19zbGljZSgpOwogICAgICAgIGxldCBnZW5lc2lzID0gU2VhbGVkQmxvY2s6OjxCbG9jaz46OmRlY29kZSgmbXV0IGdlbmVzaXNfcmxwKS51bndyYXAoKTsKICAgICAgICBsZXQgbXV0IGJsb2NrX3JscCA9IGhleCEoImY5MDI2MmY5MDFmOWEwNzVjMzcxYmE0NTk5OWQ4N2Y0NTQyMzI2OTEwYTExYWY1MTU4OTdhZWJjZTUyNjVkM2Y2YWNkMWYxMTYxZjgyZmEwMWRjYzRkZThkZWM3NWQ3YWFiODViNTY3YjZjY2Q0MWFkMzEyNDUxYjk0OGE3NDEzZjBhMTQyZmQ0MGQ0OTM0Nzk0MmFkYzI1NjY1MDE4YWExZmUwZTZiYzY2NmRhYzhmYzI2OTdmZjliYWEwOThmMmRjZDg3YzhhZTQwODNlNzAxN2EwNTQ1NmMxNGVlYTRiMWRiMjAzMjEyNmUyN2IzYjE1NjNkNTdkN2NjMGEwODE1MWQ1NDgyNzNmNjY4MzE2OTUyNGI2NmNhOWZlMzM4YjljZTQyYmMzNTQwMDQ2YzgyOGZkOTM5YWUyM2JjYmEwM2Y0ZTVjMmVjNWIyMTcwYjcxMWQ5N2VlNzU1YzE2MDQ1N2JiNThkOGRhYTMzOGU4MzVlYzAyYWU2ODYwYmJhYmI5MDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODMwMjAwMDAwMTg1MDI1NDBiZTQwMDgyYTg3OTgyMDNlODAwYTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODgwMDAwMDAwMDAwMDAwMDAwZjg2M2Y4NjE4MDBhODQwNWY1ZTEwMDk0MTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDgwODAxYmEwN2UwOWUyNjY3OGVkNGZhYzA4YTI0OWViZThlZDY4MGJmOTA1MWE1ZTE0YWQyMjNlNGIyYjlkMjZlMDIwOGYzN2EwNWY2ZTNmMTg4ZTNlNmVhYjdkN2QzYjY1NjhmNWVhYzdkNjg3YjA4ZDMwN2QzMTU0Y2NkOGM4N2I0NjMwNTA5YmMwIikuYXNfc2xpY2UoKTsKICAgICAgICBsZXQgYmxvY2sgPSBTZWFsZWRCbG9jazo6PEJsb2NrPjo6ZGVjb2RlKCZtdXQgYmxvY2tfcmxwKS51bndyYXAoKTsKICAgICAgICBwcm92aWRlci5pbnNlcnRfYmxvY2soJmdlbmVzaXMudHJ5X3JlY292ZXIoKS51bndyYXAoKSkudW53cmFwKCk7CiAgICAgICAgcHJvdmlkZXIuaW5zZXJ0X2Jsb2NrKCZibG9jay5jbG9uZSgpLnRyeV9yZWNvdmVyKCkudW53cmFwKCkpLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyCiAgICAgICAgICAgIC5zdGF0aWNfZmlsZV9wcm92aWRlcigpCiAgICAgICAgICAgIC5sYXRlc3Rfd3JpdGVyKFN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKQogICAgICAgICAgICAudW53cmFwKCkKICAgICAgICAgICAgLmNvbW1pdCgpCiAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICBwcm92aWRlci5jb21taXQoKS51bndyYXAoKTsKCiAgICAgICAgbGV0IHByZXZpb3VzX2NoZWNrcG9pbnQgPSBTdGFnZUNoZWNrcG9pbnQgeyBibG9ja19udW1iZXI6IDEsIHN0YWdlX2NoZWNrcG9pbnQ6IE5vbmUgfTsKCiAgICAgICAgbGV0IHN0YWdlX2NoZWNrcG9pbnQgPQogICAgICAgICAgICBleGVjdXRpb25fY2hlY2twb2ludCgmZmFjdG9yeS5zdGF0aWNfZmlsZV9wcm92aWRlcigpLCAxLCAxLCBwcmV2aW91c19jaGVja3BvaW50KTsKCiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKHN0YWdlX2NoZWNrcG9pbnQsIE9rKEV4ZWN1dGlvbkNoZWNrcG9pbnQgewogICAgICAgICAgICBibG9ja19yYW5nZTogQ2hlY2twb2ludEJsb2NrUmFuZ2UgeyBmcm9tOiAxLCB0bzogMSB9LAogICAgICAgICAgICBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgIHByb2Nlc3NlZDogMCwKICAgICAgICAgICAgICAgIHRvdGFsCiAgICAgICAgICAgIH0KICAgICAgICB9KSBpZiB0b3RhbCA9PSBibG9jay5nYXNfdXNlZCk7CiAgICB9CgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIHNhbml0eV9leGVjdXRpb25fb2ZfYmxvY2soKSB7CiAgICAgICAgbGV0IGZhY3RvcnkgPSBjcmVhdGVfdGVzdF9wcm92aWRlcl9mYWN0b3J5KCk7CiAgICAgICAgbGV0IHByb3ZpZGVyID0gZmFjdG9yeS5wcm92aWRlcl9ydygpLnVud3JhcCgpOwogICAgICAgIGxldCBpbnB1dCA9IEV4ZWNJbnB1dCB7IHRhcmdldDogU29tZSgxKSwgY2hlY2twb2ludDogTm9uZSB9OwogICAgICAgIGxldCBtdXQgZ2VuZXNpc19ybHAgPSBoZXghKCJmOTAxZmFmOTAxZjVhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDBhMDFkY2M0ZGU4ZGVjNzVkN2FhYjg1YjU2N2I2Y2NkNDFhZDMxMjQ1MWI5NDhhNzQxM2YwYTE0MmZkNDBkNDkzNDc5NDJhZGMyNTY2NTAxOGFhMWZlMGU2YmM2NjZkYWM4ZmMyNjk3ZmY5YmFhMDQ1NTcxYjQwYWU2NmNhNzQ4MDc5MWJiYjI4ODcyODZlNGU0YzRiMWIyOThiMTkxYzg4OWQ2OTU5MDIzYTMyZWRhMDU2ZTgxZjE3MWJjYzU1YTZmZjgzNDVlNjkyYzBmODZlNWI0OGUwMWI5OTZjYWRjMDAxNjIyZmI1ZTM2M2I0MjFhMDU2ZTgxZjE3MWJjYzU1YTZmZjgzNDVlNjkyYzBmODZlNWI0OGUwMWI5OTZjYWRjMDAxNjIyZmI1ZTM2M2I0MjFiOTAxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDgzMDIwMDAwODA4NTAyNTQwYmU0MDA4MDgwMDBhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4ODAwMDAwMDAwMDAwMDAwMDBjMGMwIikuYXNfc2xpY2UoKTsKICAgICAgICBsZXQgZ2VuZXNpcyA9IFNlYWxlZEJsb2NrOjo8QmxvY2s+OjpkZWNvZGUoJm11dCBnZW5lc2lzX3JscCkudW53cmFwKCk7CiAgICAgICAgbGV0IG11dCBibG9ja19ybHAgPSBoZXghKCJmOTAyNjJmOTAxZjlhMDc1YzM3MWJhNDU5OTlkODdmNDU0MjMyNjkxMGExMWFmNTE1ODk3YWViY2U1MjY1ZDNmNmFjZDFmMTE2MWY4MmZhMDFkY2M0ZGU4ZGVjNzVkN2FhYjg1YjU2N2I2Y2NkNDFhZDMxMjQ1MWI5NDhhNzQxM2YwYTE0MmZkNDBkNDkzNDc5NDJhZGMyNTY2NTAxOGFhMWZlMGU2YmM2NjZkYWM4ZmMyNjk3ZmY5YmFhMDk4ZjJkY2Q4N2M4YWU0MDgzZTcwMTdhMDU0NTZjMTRlZWE0YjFkYjIwMzIxMjZlMjdiM2IxNTYzZDU3ZDdjYzBhMDgxNTFkNTQ4MjczZjY2ODMxNjk1MjRiNjZjYTlmZTMzOGI5Y2U0MmJjMzU0MDA0NmM4MjhmZDkzOWFlMjNiY2JhMDNmNGU1YzJlYzViMjE3MGI3MTFkOTdlZTc1NWMxNjA0NTdiYjU4ZDhkYWEzMzhlODM1ZWMwMmFlNjg2MGJiYWJiOTAxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDgzMDIwMDAwMDE4NTAyNTQwYmU0MDA4MmE4Nzk4MjAzZTgwMGEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDg4MDAwMDAwMDAwMDAwMDAwMGY4NjNmODYxODAwYTg0MDVmNWUxMDA5NDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4MDgwMWJhMDdlMDllMjY2NzhlZDRmYWMwOGEyNDllYmU4ZWQ2ODBiZjkwNTFhNWUxNGFkMjIzZTRiMmI5ZDI2ZTAyMDhmMzdhMDVmNmUzZjE4OGUzZTZlYWI3ZDdkM2I2NTY4ZjVlYWM3ZDY4N2IwOGQzMDdkMzE1NGNjZDhjODdiNDYzMDUwOWJjMCIpLmFzX3NsaWNlKCk7CiAgICAgICAgbGV0IGJsb2NrID0gU2VhbGVkQmxvY2s6OjxCbG9jaz46OmRlY29kZSgmbXV0IGJsb2NrX3JscCkudW53cmFwKCk7CiAgICAgICAgcHJvdmlkZXIuaW5zZXJ0X2Jsb2NrKCZnZW5lc2lzLnRyeV9yZWNvdmVyKCkudW53cmFwKCkpLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyLmluc2VydF9ibG9jaygmYmxvY2suY2xvbmUoKS50cnlfcmVjb3ZlcigpLnVud3JhcCgpKS51bndyYXAoKTsKICAgICAgICBwcm92aWRlcgogICAgICAgICAgICAuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKQogICAgICAgICAgICAubGF0ZXN0X3dyaXRlcihTdGF0aWNGaWxlU2VnbWVudDo6SGVhZGVycykKICAgICAgICAgICAgLnVud3JhcCgpCiAgICAgICAgICAgIC5jb21taXQoKQogICAgICAgICAgICAudW53cmFwKCk7CiAgICAgICAgewogICAgICAgICAgICBsZXQgc3RhdGljX2ZpbGVfcHJvdmlkZXIgPSBwcm92aWRlci5zdGF0aWNfZmlsZV9wcm92aWRlcigpOwogICAgICAgICAgICBsZXQgbXV0IHJlY2VpcHRzX3dyaXRlciA9CiAgICAgICAgICAgICAgICBzdGF0aWNfZmlsZV9wcm92aWRlci5sYXRlc3Rfd3JpdGVyKFN0YXRpY0ZpbGVTZWdtZW50OjpSZWNlaXB0cykudW53cmFwKCk7CiAgICAgICAgICAgIHJlY2VpcHRzX3dyaXRlci5pbmNyZW1lbnRfYmxvY2soMCkudW53cmFwKCk7CiAgICAgICAgICAgIHJlY2VpcHRzX3dyaXRlci5jb21taXQoKS51bndyYXAoKTsKICAgICAgICB9CiAgICAgICAgcHJvdmlkZXIuY29tbWl0KCkudW53cmFwKCk7CgogICAgICAgIC8vIGluc2VydCBwcmUgc3RhdGUKICAgICAgICBsZXQgcHJvdmlkZXIgPSBmYWN0b3J5LnByb3ZpZGVyX3J3KCkudW53cmFwKCk7CgogICAgICAgIGxldCBkYl90eCA9IHByb3ZpZGVyLnR4X3JlZigpOwogICAgICAgIGxldCBhY2MxID0gYWRkcmVzcyEoIjB4MTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCIpOwogICAgICAgIGxldCBhY2MyID0gYWRkcmVzcyEoIjB4YTk0ZjUzNzRmY2U1ZWRiYzhlMmE4Njk3YzE1MzMxNjc3ZTZlYmYwYiIpOwogICAgICAgIGxldCBjb2RlID0gaGV4ISgiNWE0NjVhOTA1MDkwMDM2MDAyOTAwMzYwMDE1NTAwIik7CiAgICAgICAgbGV0IGJhbGFuY2UgPSBVMjU2Ojpmcm9tKDB4MzYzNWM5YWRjNWRlYTAwMDAwdTEyOCk7CiAgICAgICAgbGV0IGNvZGVfaGFzaCA9IGtlY2NhazI1Nihjb2RlKTsKICAgICAgICBkYl90eAogICAgICAgICAgICAucHV0Ojo8dGFibGVzOjpQbGFpbkFjY291bnRTdGF0ZT4oCiAgICAgICAgICAgICAgICBhY2MxLAogICAgICAgICAgICAgICAgQWNjb3VudCB7IG5vbmNlOiAwLCBiYWxhbmNlOiBVMjU2OjpaRVJPLCBieXRlY29kZV9oYXNoOiBTb21lKGNvZGVfaGFzaCkgfSwKICAgICAgICAgICAgKQogICAgICAgICAgICAudW53cmFwKCk7CiAgICAgICAgZGJfdHgKICAgICAgICAgICAgLnB1dDo6PHRhYmxlczo6UGxhaW5BY2NvdW50U3RhdGU+KAogICAgICAgICAgICAgICAgYWNjMiwKICAgICAgICAgICAgICAgIEFjY291bnQgeyBub25jZTogMCwgYmFsYW5jZSwgYnl0ZWNvZGVfaGFzaDogTm9uZSB9LAogICAgICAgICAgICApCiAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICBkYl90eC5wdXQ6Ojx0YWJsZXM6OkJ5dGVjb2Rlcz4oY29kZV9oYXNoLCBCeXRlY29kZTo6bmV3X3Jhdyhjb2RlLnRvX3ZlYygpLmludG8oKSkpLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyLmNvbW1pdCgpLnVud3JhcCgpOwoKICAgICAgICAvLyBleGVjdXRlCgogICAgICAgIC8vIElmIHRoZXJlIGlzIGEgcHJ1bmluZyBjb25maWd1cmF0aW9uLCB0aGVuIGl0J3MgZm9yY2VkIHRvIHVzZSB0aGUgZGF0YWJhc2UuCiAgICAgICAgLy8gVGhpcyB3YXkgd2UgdGVzdCBib3RoIGNhc2VzLgogICAgICAgIGxldCBtb2RlcyA9IFtOb25lLCBTb21lKFBydW5lTW9kZXM6OmRlZmF1bHQoKSldOwogICAgICAgIGxldCByYW5kb21fZmlsdGVyID0gUmVjZWlwdHNMb2dQcnVuZUNvbmZpZyhCVHJlZU1hcDo6ZnJvbShbKAogICAgICAgICAgICBBZGRyZXNzOjpyYW5kb20oKSwKICAgICAgICAgICAgUHJ1bmVNb2RlOjpEaXN0YW5jZSgxMDAwMDApLAogICAgICAgICldKSk7CgogICAgICAgIC8vIFRlc3RzIG5vZGUgd2l0aCBkYXRhYmFzZSBhbmQgbm9kZSB3aXRoIHN0YXRpYyBmaWxlcwogICAgICAgIGZvciBtdXQgbW9kZSBpbiBtb2RlcyB7CiAgICAgICAgICAgIGxldCBtdXQgcHJvdmlkZXIgPSBmYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3J3KCkudW53cmFwKCk7CgogICAgICAgICAgICBpZiBsZXQgU29tZShtb2RlKSA9ICZtdXQgbW9kZSB7CiAgICAgICAgICAgICAgICAvLyBTaW11bGF0aW5nIGEgZnVsbCBub2RlIHdoZXJlIHdlIHdyaXRlIHJlY2VpcHRzIHRvIGRhdGFiYXNlCiAgICAgICAgICAgICAgICBtb2RlLnJlY2VpcHRzX2xvZ19maWx0ZXIgPSByYW5kb21fZmlsdGVyLmNsb25lKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBtdXQgZXhlY3V0aW9uX3N0YWdlID0gc3RhZ2UoKTsKICAgICAgICAgICAgcHJvdmlkZXIuc2V0X3BydW5lX21vZGVzKG1vZGUuY2xvbmUoKS51bndyYXBfb3JfZGVmYXVsdCgpKTsKCiAgICAgICAgICAgIGxldCBvdXRwdXQgPSBleGVjdXRpb25fc3RhZ2UuZXhlY3V0ZSgmcHJvdmlkZXIsIGlucHV0KS51bndyYXAoKTsKICAgICAgICAgICAgcHJvdmlkZXIuY29tbWl0KCkudW53cmFwKCk7CgogICAgICAgICAgICBhc3NlcnRfbWF0Y2hlcyEob3V0cHV0LCBFeGVjT3V0cHV0IHsKICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgYmxvY2tfbnVtYmVyOiAxLAogICAgICAgICAgICAgICAgICAgIHN0YWdlX2NoZWNrcG9pbnQ6IFNvbWUoU3RhZ2VVbml0Q2hlY2twb2ludDo6RXhlY3V0aW9uKEV4ZWN1dGlvbkNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgICAgICBibG9ja19yYW5nZTogQ2hlY2twb2ludEJsb2NrUmFuZ2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiAxLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzczogRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkb25lOiB0cnVlCiAgICAgICAgICAgIH0gaWYgcHJvY2Vzc2VkID09IHRvdGFsICYmIHRvdGFsID09IGJsb2NrLmdhc191c2VkKTsKCiAgICAgICAgICAgIGxldCBwcm92aWRlciA9IGZhY3RvcnkucHJvdmlkZXIoKS51bndyYXAoKTsKCiAgICAgICAgICAgIC8vIGNoZWNrIHBvc3Qgc3RhdGUKICAgICAgICAgICAgbGV0IGFjY291bnQxID0gYWRkcmVzcyEoIjB4MTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCIpOwogICAgICAgICAgICBsZXQgYWNjb3VudDFfaW5mbyA9CiAgICAgICAgICAgICAgICBBY2NvdW50IHsgYmFsYW5jZTogVTI1Njo6WkVSTywgbm9uY2U6IDB4MDAsIGJ5dGVjb2RlX2hhc2g6IFNvbWUoY29kZV9oYXNoKSB9OwogICAgICAgICAgICBsZXQgYWNjb3VudDIgPSBhZGRyZXNzISgiMHgyYWRjMjU2NjUwMThhYTFmZTBlNmJjNjY2ZGFjOGZjMjY5N2ZmOWJhIik7CiAgICAgICAgICAgIGxldCBhY2NvdW50Ml9pbmZvID0gQWNjb3VudCB7CiAgICAgICAgICAgICAgICBiYWxhbmNlOiBVMjU2Ojpmcm9tKDB4MWJjMTZkNjc0ZWNlOTRiYXUxMjgpLAogICAgICAgICAgICAgICAgbm9uY2U6IDB4MDAsCiAgICAgICAgICAgICAgICBieXRlY29kZV9oYXNoOiBOb25lLAogICAgICAgICAgICB9OwogICAgICAgICAgICBsZXQgYWNjb3VudDMgPSBhZGRyZXNzISgiMHhhOTRmNTM3NGZjZTVlZGJjOGUyYTg2OTdjMTUzMzE2NzdlNmViZjBiIik7CiAgICAgICAgICAgIGxldCBhY2NvdW50M19pbmZvID0gQWNjb3VudCB7CiAgICAgICAgICAgICAgICBiYWxhbmNlOiBVMjU2Ojpmcm9tKDB4MzYzNWM5YWRjNWRlOTk2YjQ2dTEyOCksCiAgICAgICAgICAgICAgICBub25jZTogMHgwMSwKICAgICAgICAgICAgICAgIGJ5dGVjb2RlX2hhc2g6IE5vbmUsCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBhc3NlcnQgYWNjb3VudHMKICAgICAgICAgICAgYXNzZXJ0ISgKICAgICAgICAgICAgICAgIG1hdGNoZXMhKHByb3ZpZGVyLmJhc2ljX2FjY291bnQoJmFjY291bnQxKSwgT2soU29tZShhY2MpKSBpZiBhY2MgPT0gYWNjb3VudDFfaW5mbykKICAgICAgICAgICAgKTsKICAgICAgICAgICAgYXNzZXJ0ISgKICAgICAgICAgICAgICAgIG1hdGNoZXMhKHByb3ZpZGVyLmJhc2ljX2FjY291bnQoJmFjY291bnQyKSwgT2soU29tZShhY2MpKSBpZiBhY2MgPT0gYWNjb3VudDJfaW5mbykKICAgICAgICAgICAgKTsKICAgICAgICAgICAgYXNzZXJ0ISgKICAgICAgICAgICAgICAgIG1hdGNoZXMhKHByb3ZpZGVyLmJhc2ljX2FjY291bnQoJmFjY291bnQzKSwgT2soU29tZShhY2MpKSBpZiBhY2MgPT0gYWNjb3VudDNfaW5mbykKICAgICAgICAgICAgKTsKICAgICAgICAgICAgLy8gYXNzZXJ0IHN0b3JhZ2UKICAgICAgICAgICAgLy8gR2V0IG9uIGR1cHNvcnQgd291bGQgcmV0dXJuIG9ubHkgZmlyc3QgdmFsdWUuIFRoaXMgaXMgZ29vZCBlbm91Z2ggZm9yIHRoaXMgdGVzdC4KICAgICAgICAgICAgYXNzZXJ0IShtYXRjaGVzISgKICAgICAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmdldDo6PHRhYmxlczo6UGxhaW5TdG9yYWdlU3RhdGU+KGFjY291bnQxKSwKICAgICAgICAgICAgICAgIE9rKFNvbWUoZW50cnkpKSBpZiBlbnRyeS5rZXkgPT0gQjI1Njo6d2l0aF9sYXN0X2J5dGUoMSkgJiYgZW50cnkudmFsdWUgPT0gVTI1Njo6ZnJvbSgyKQogICAgICAgICAgICApKTsKCiAgICAgICAgICAgIGxldCBtdXQgcHJvdmlkZXIgPSBmYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgICAgIGxldCBtdXQgc3RhZ2UgPSBzdGFnZSgpOwogICAgICAgICAgICBwcm92aWRlci5zZXRfcHJ1bmVfbW9kZXMobW9kZS51bndyYXBfb3JfZGVmYXVsdCgpKTsKCiAgICAgICAgICAgIGxldCBfcmVzdWx0ID0gc3RhZ2UKICAgICAgICAgICAgICAgIC51bndpbmQoCiAgICAgICAgICAgICAgICAgICAgJnByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgIFVud2luZElucHV0IHsgY2hlY2twb2ludDogb3V0cHV0LmNoZWNrcG9pbnQsIHVud2luZF90bzogMCwgYmFkX2Jsb2NrOiBOb25lIH0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAudW53cmFwKCk7CiAgICAgICAgICAgIHByb3ZpZGVyLmNvbW1pdCgpLnVud3JhcCgpOwogICAgICAgIH0KICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gc2FuaXR5X2V4ZWN1dGVfdW53aW5kKCkgewogICAgICAgIGxldCBmYWN0b3J5ID0gY3JlYXRlX3Rlc3RfcHJvdmlkZXJfZmFjdG9yeSgpOwogICAgICAgIGxldCBwcm92aWRlciA9IGZhY3RvcnkucHJvdmlkZXJfcncoKS51bndyYXAoKTsKICAgICAgICBsZXQgaW5wdXQgPSBFeGVjSW5wdXQgeyB0YXJnZXQ6IFNvbWUoMSksIGNoZWNrcG9pbnQ6IE5vbmUgfTsKICAgICAgICBsZXQgbXV0IGdlbmVzaXNfcmxwID0gaGV4ISgiZjkwMWZhZjkwMWY1YTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwYTAxZGNjNGRlOGRlYzc1ZDdhYWI4NWI1NjdiNmNjZDQxYWQzMTI0NTFiOTQ4YTc0MTNmMGExNDJmZDQwZDQ5MzQ3OTQyYWRjMjU2NjUwMThhYTFmZTBlNmJjNjY2ZGFjOGZjMjY5N2ZmOWJhYTA0NTU3MWI0MGFlNjZjYTc0ODA3OTFiYmIyODg3Mjg2ZTRlNGM0YjFiMjk4YjE5MWM4ODlkNjk1OTAyM2EzMmVkYTA1NmU4MWYxNzFiY2M1NWE2ZmY4MzQ1ZTY5MmMwZjg2ZTViNDhlMDFiOTk2Y2FkYzAwMTYyMmZiNWUzNjNiNDIxYTA1NmU4MWYxNzFiY2M1NWE2ZmY4MzQ1ZTY5MmMwZjg2ZTViNDhlMDFiOTk2Y2FkYzAwMTYyMmZiNWUzNjNiNDIxYjkwMTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4MzAyMDAwMDgwODUwMjU0MGJlNDAwODA4MDAwYTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODgwMDAwMDAwMDAwMDAwMDAwYzBjMCIpLmFzX3NsaWNlKCk7CiAgICAgICAgbGV0IGdlbmVzaXMgPSBTZWFsZWRCbG9jazo6PEJsb2NrPjo6ZGVjb2RlKCZtdXQgZ2VuZXNpc19ybHApLnVud3JhcCgpOwogICAgICAgIGxldCBtdXQgYmxvY2tfcmxwID0gaGV4ISgiZjkwMjYyZjkwMWY5YTA3NWMzNzFiYTQ1OTk5ZDg3ZjQ1NDIzMjY5MTBhMTFhZjUxNTg5N2FlYmNlNTI2NWQzZjZhY2QxZjExNjFmODJmYTAxZGNjNGRlOGRlYzc1ZDdhYWI4NWI1NjdiNmNjZDQxYWQzMTI0NTFiOTQ4YTc0MTNmMGExNDJmZDQwZDQ5MzQ3OTQyYWRjMjU2NjUwMThhYTFmZTBlNmJjNjY2ZGFjOGZjMjY5N2ZmOWJhYTA5OGYyZGNkODdjOGFlNDA4M2U3MDE3YTA1NDU2YzE0ZWVhNGIxZGIyMDMyMTI2ZTI3YjNiMTU2M2Q1N2Q3Y2MwYTA4MTUxZDU0ODI3M2Y2NjgzMTY5NTI0YjY2Y2E5ZmUzMzhiOWNlNDJiYzM1NDAwNDZjODI4ZmQ5MzlhZTIzYmNiYTAzZjRlNWMyZWM1YjIxNzBiNzExZDk3ZWU3NTVjMTYwNDU3YmI1OGQ4ZGFhMzM4ZTgzNWVjMDJhZTY4NjBiYmFiYjkwMTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4MzAyMDAwMDAxODUwMjU0MGJlNDAwODJhODc5ODIwM2U4MDBhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4ODAwMDAwMDAwMDAwMDAwMDBmODYzZjg2MTgwMGE4NDA1ZjVlMTAwOTQxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODA4MDFiYTA3ZTA5ZTI2Njc4ZWQ0ZmFjMDhhMjQ5ZWJlOGVkNjgwYmY5MDUxYTVlMTRhZDIyM2U0YjJiOWQyNmUwMjA4ZjM3YTA1ZjZlM2YxODhlM2U2ZWFiN2Q3ZDNiNjU2OGY1ZWFjN2Q2ODdiMDhkMzA3ZDMxNTRjY2Q4Yzg3YjQ2MzA1MDliYzAiKS5hc19zbGljZSgpOwogICAgICAgIGxldCBibG9jayA9IFNlYWxlZEJsb2NrOjo8QmxvY2s+OjpkZWNvZGUoJm11dCBibG9ja19ybHApLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyLmluc2VydF9ibG9jaygmZ2VuZXNpcy50cnlfcmVjb3ZlcigpLnVud3JhcCgpKS51bndyYXAoKTsKICAgICAgICBwcm92aWRlci5pbnNlcnRfYmxvY2soJmJsb2NrLmNsb25lKCkudHJ5X3JlY292ZXIoKS51bndyYXAoKSkudW53cmFwKCk7CiAgICAgICAgcHJvdmlkZXIKICAgICAgICAgICAgLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkKICAgICAgICAgICAgLmxhdGVzdF93cml0ZXIoU3RhdGljRmlsZVNlZ21lbnQ6OkhlYWRlcnMpCiAgICAgICAgICAgIC51bndyYXAoKQogICAgICAgICAgICAuY29tbWl0KCkKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIHsKICAgICAgICAgICAgbGV0IHN0YXRpY19maWxlX3Byb3ZpZGVyID0gcHJvdmlkZXIuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKTsKICAgICAgICAgICAgbGV0IG11dCByZWNlaXB0c193cml0ZXIgPQogICAgICAgICAgICAgICAgc3RhdGljX2ZpbGVfcHJvdmlkZXIubGF0ZXN0X3dyaXRlcihTdGF0aWNGaWxlU2VnbWVudDo6UmVjZWlwdHMpLnVud3JhcCgpOwogICAgICAgICAgICByZWNlaXB0c193cml0ZXIuaW5jcmVtZW50X2Jsb2NrKDApLnVud3JhcCgpOwogICAgICAgICAgICByZWNlaXB0c193cml0ZXIuY29tbWl0KCkudW53cmFwKCk7CiAgICAgICAgfQogICAgICAgIHByb3ZpZGVyLmNvbW1pdCgpLnVud3JhcCgpOwoKICAgICAgICAvLyB2YXJpYWJsZXMKICAgICAgICBsZXQgY29kZSA9IGhleCEoIjVhNDY1YTkwNTA5MDAzNjAwMjkwMDM2MDAxNTUwMCIpOwogICAgICAgIGxldCBiYWxhbmNlID0gVTI1Njo6ZnJvbSgweDM2MzVjOWFkYzVkZWEwMDAwMHUxMjgpOwogICAgICAgIGxldCBjb2RlX2hhc2ggPSBrZWNjYWsyNTYoY29kZSk7CiAgICAgICAgLy8gcHJlIHN0YXRlCiAgICAgICAgbGV0IHByb3ZpZGVyID0gZmFjdG9yeS5wcm92aWRlcl9ydygpLnVud3JhcCgpOwoKICAgICAgICBsZXQgZGJfdHggPSBwcm92aWRlci50eF9yZWYoKTsKICAgICAgICBsZXQgYWNjMSA9IGFkZHJlc3MhKCIweDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAiKTsKICAgICAgICBsZXQgYWNjMV9pbmZvID0gQWNjb3VudCB7IG5vbmNlOiAwLCBiYWxhbmNlOiBVMjU2OjpaRVJPLCBieXRlY29kZV9oYXNoOiBTb21lKGNvZGVfaGFzaCkgfTsKICAgICAgICBsZXQgYWNjMiA9IGFkZHJlc3MhKCIweGE5NGY1Mzc0ZmNlNWVkYmM4ZTJhODY5N2MxNTMzMTY3N2U2ZWJmMGIiKTsKICAgICAgICBsZXQgYWNjMl9pbmZvID0gQWNjb3VudCB7IG5vbmNlOiAwLCBiYWxhbmNlLCBieXRlY29kZV9oYXNoOiBOb25lIH07CgogICAgICAgIGRiX3R4LnB1dDo6PHRhYmxlczo6UGxhaW5BY2NvdW50U3RhdGU+KGFjYzEsIGFjYzFfaW5mbykudW53cmFwKCk7CiAgICAgICAgZGJfdHgucHV0Ojo8dGFibGVzOjpQbGFpbkFjY291bnRTdGF0ZT4oYWNjMiwgYWNjMl9pbmZvKS51bndyYXAoKTsKICAgICAgICBkYl90eC5wdXQ6Ojx0YWJsZXM6OkJ5dGVjb2Rlcz4oY29kZV9oYXNoLCBCeXRlY29kZTo6bmV3X3Jhdyhjb2RlLnRvX3ZlYygpLmludG8oKSkpLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyLmNvbW1pdCgpLnVud3JhcCgpOwoKICAgICAgICAvLyBleGVjdXRlCiAgICAgICAgbGV0IG11dCBwcm92aWRlciA9IGZhY3RvcnkuZGF0YWJhc2VfcHJvdmlkZXJfcncoKS51bndyYXAoKTsKCiAgICAgICAgLy8gSWYgdGhlcmUgaXMgYSBwcnVuaW5nIGNvbmZpZ3VyYXRpb24sIHRoZW4gaXQncyBmb3JjZWQgdG8gdXNlIHRoZSBkYXRhYmFzZS4KICAgICAgICAvLyBUaGlzIHdheSB3ZSB0ZXN0IGJvdGggY2FzZXMuCiAgICAgICAgbGV0IG1vZGVzID0gW05vbmUsIFNvbWUoUHJ1bmVNb2Rlczo6ZGVmYXVsdCgpKV07CiAgICAgICAgbGV0IHJhbmRvbV9maWx0ZXIgPSBSZWNlaXB0c0xvZ1BydW5lQ29uZmlnKEJUcmVlTWFwOjpmcm9tKFsoCiAgICAgICAgICAgIEFkZHJlc3M6OnJhbmRvbSgpLAogICAgICAgICAgICBQcnVuZU1vZGU6OkJlZm9yZSgxMDAwMDApLAogICAgICAgICldKSk7CgogICAgICAgIC8vIFRlc3RzIG5vZGUgd2l0aCBkYXRhYmFzZSBhbmQgbm9kZSB3aXRoIHN0YXRpYyBmaWxlcwogICAgICAgIGZvciBtdXQgbW9kZSBpbiBtb2RlcyB7CiAgICAgICAgICAgIGlmIGxldCBTb21lKG1vZGUpID0gJm11dCBtb2RlIHsKICAgICAgICAgICAgICAgIC8vIFNpbXVsYXRpbmcgYSBmdWxsIG5vZGUgd2hlcmUgd2Ugd3JpdGUgcmVjZWlwdHMgdG8gZGF0YWJhc2UKICAgICAgICAgICAgICAgIG1vZGUucmVjZWlwdHNfbG9nX2ZpbHRlciA9IHJhbmRvbV9maWx0ZXIuY2xvbmUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVGVzdCBFeGVjdXRpb24KICAgICAgICAgICAgbGV0IG11dCBleGVjdXRpb25fc3RhZ2UgPSBzdGFnZSgpOwogICAgICAgICAgICBwcm92aWRlci5zZXRfcHJ1bmVfbW9kZXMobW9kZS5jbG9uZSgpLnVud3JhcF9vcl9kZWZhdWx0KCkpOwoKICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGV4ZWN1dGlvbl9zdGFnZS5leGVjdXRlKCZwcm92aWRlciwgaW5wdXQpLnVud3JhcCgpOwogICAgICAgICAgICBwcm92aWRlci5jb21taXQoKS51bndyYXAoKTsKCiAgICAgICAgICAgIC8vIFRlc3QgVW53aW5kCiAgICAgICAgICAgIHByb3ZpZGVyID0gZmFjdG9yeS5kYXRhYmFzZV9wcm92aWRlcl9ydygpLnVud3JhcCgpOwogICAgICAgICAgICBsZXQgbXV0IHN0YWdlID0gc3RhZ2UoKTsKICAgICAgICAgICAgcHJvdmlkZXIuc2V0X3BydW5lX21vZGVzKG1vZGUuY2xvbmUoKS51bndyYXBfb3JfZGVmYXVsdCgpKTsKCiAgICAgICAgICAgIGxldCByZXN1bHQgPSBzdGFnZQogICAgICAgICAgICAgICAgLnVud2luZCgKICAgICAgICAgICAgICAgICAgICAmcHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgVW53aW5kSW5wdXQgeyBjaGVja3BvaW50OiByZXN1bHQuY2hlY2twb2ludCwgdW53aW5kX3RvOiAwLCBiYWRfYmxvY2s6IE5vbmUgfSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIC51bndyYXAoKTsKCiAgICAgICAgICAgIHByb3ZpZGVyLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkuY29tbWl0KCkudW53cmFwKCk7CgogICAgICAgICAgICBhc3NlcnRfbWF0Y2hlcyEocmVzdWx0LCBVbndpbmRPdXRwdXQgewogICAgICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50IHsKICAgICAgICAgICAgICAgICAgICBibG9ja19udW1iZXI6IDAsCiAgICAgICAgICAgICAgICAgICAgc3RhZ2VfY2hlY2twb2ludDogU29tZShTdGFnZVVuaXRDaGVja3BvaW50OjpFeGVjdXRpb24oRXhlY3V0aW9uQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrX3JhbmdlOiBDaGVja3BvaW50QmxvY2tSYW5nZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IDEsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiBFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWwKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGlmIHRvdGFsID09IGJsb2NrLmdhc191c2VkKTsKCiAgICAgICAgICAgIC8vIGFzc2VydCB1bndpbmQgc3RhZ2UKICAgICAgICAgICAgYXNzZXJ0IShtYXRjaGVzIShwcm92aWRlci5iYXNpY19hY2NvdW50KCZhY2MxKSwgT2soU29tZShhY2MpKSBpZiBhY2MgPT0gYWNjMV9pbmZvKSk7CiAgICAgICAgICAgIGFzc2VydCEobWF0Y2hlcyEocHJvdmlkZXIuYmFzaWNfYWNjb3VudCgmYWNjMiksIE9rKFNvbWUoYWNjKSkgaWYgYWNjID09IGFjYzJfaW5mbykpOwoKICAgICAgICAgICAgbGV0IG1pbmVyX2FjYyA9IGFkZHJlc3MhKCIweDJhZGMyNTY2NTAxOGFhMWZlMGU2YmM2NjZkYWM4ZmMyNjk3ZmY5YmEiKTsKICAgICAgICAgICAgYXNzZXJ0IShtYXRjaGVzIShwcm92aWRlci5iYXNpY19hY2NvdW50KCZtaW5lcl9hY2MpLCBPayhOb25lKSkpOwoKICAgICAgICAgICAgYXNzZXJ0IShtYXRjaGVzIShwcm92aWRlci5yZWNlaXB0KDApLCBPayhOb25lKSkpOwogICAgICAgIH0KICAgIH0KCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gdGVzdF9zZWxmZGVzdHJ1Y3QoKSB7CiAgICAgICAgbGV0IHRlc3RfZGIgPSBUZXN0U3RhZ2VEQjo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBwcm92aWRlciA9IHRlc3RfZGIuZmFjdG9yeS5kYXRhYmFzZV9wcm92aWRlcl9ydygpLnVud3JhcCgpOwogICAgICAgIGxldCBpbnB1dCA9IEV4ZWNJbnB1dCB7IHRhcmdldDogU29tZSgxKSwgY2hlY2twb2ludDogTm9uZSB9OwogICAgICAgIGxldCBtdXQgZ2VuZXNpc19ybHAgPSBoZXghKCJmOTAxZjhmOTAxZjNhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDBhMDFkY2M0ZGU4ZGVjNzVkN2FhYjg1YjU2N2I2Y2NkNDFhZDMxMjQ1MWI5NDhhNzQxM2YwYTE0MmZkNDBkNDkzNDc5NDJhZGMyNTY2NTAxOGFhMWZlMGU2YmM2NjZkYWM4ZmMyNjk3ZmY5YmFhMGM5Y2ViODM3MmM4OGNiNDYxNzI0ZDhkM2Q4N2U4YjkzM2Y2ZmM1ZjY3OWQ0ODQxODAwZTY2MmY0NDI4ZmZkMGRhMDU2ZTgxZjE3MWJjYzU1YTZmZjgzNDVlNjkyYzBmODZlNWI0OGUwMWI5OTZjYWRjMDAxNjIyZmI1ZTM2M2I0MjFhMDU2ZTgxZjE3MWJjYzU1YTZmZjgzNDVlNjkyYzBmODZlNWI0OGUwMWI5OTZjYWRjMDAxNjIyZmI1ZTM2M2I0MjFiOTAxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDgzMDIwMDAwODA4MzBmNDI0MDgwODAwMGEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDg4MDAwMDAwMDAwMDAwMDAwMGMwYzAiKS5hc19zbGljZSgpOwogICAgICAgIGxldCBnZW5lc2lzID0gU2VhbGVkQmxvY2s6OjxCbG9jaz46OmRlY29kZSgmbXV0IGdlbmVzaXNfcmxwKS51bndyYXAoKTsKICAgICAgICBsZXQgbXV0IGJsb2NrX3JscCA9IGhleCEoImY5MDI1ZmY5MDFmN2EwYzg2ZThjYzAzMTBhZTdjNTMxYzc1ODY3OGRkYmZkMTZmYzUxYzhjZWY4Y2VjNjUwYjAzMmRlOTg2OWU4Yjk0ZmEwMWRjYzRkZThkZWM3NWQ3YWFiODViNTY3YjZjY2Q0MWFkMzEyNDUxYjk0OGE3NDEzZjBhMTQyZmQ0MGQ0OTM0Nzk0MmFkYzI1NjY1MDE4YWExZmUwZTZiYzY2NmRhYzhmYzI2OTdmZjliYWEwNTA1NTQ4ODJmYmJkYTJjMmZkOTNmZGM0NjZkYjk5NDZlYTI2MmE2N2Y3YTc2Y2MxNjllNzE0ZjEwNWFiNTgzZGEwMDk2N2YwOWVmMWRmZWQyMGMwZWFjZmFhOTRkNWNkNDAwMmVkYTMyNDJhYzQ3ZWFlNjg5NzJkMDdiMTA2ZDE5MmEwZTNjOGI0N2ZiZmM5NDY2N2VmNGNjZWIxN2U1Y2MyMWUzYjFlZWJkNDQyY2ViYjI3ZjA3NTYyYjMzODM2MjkwZGI5MDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwODMwMjAwMDAwMTgzMGY0MjQwODIzODEwODIwM2U4MDBhMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA4ODAwMDAwMDAwMDAwMDAwMDBmODYyZjg2MDgwMGE4MzA2MWE4MDk0MDk1ZTdiYWVhNmE2YzdjNGMyZGZlYjk3N2VmYWMzMjZhZjU1MmQ4NzgwODAxYmEwNzJlZDgxNzQ4N2I4NGJhMzY3ZDE1ZDJmMDM5YjVmYzVmMDg3ZDBhODg4MmZiZGY3M2U4Y2I0OTM1N2UxY2UzMGEwNDAzZDgwMDU0NWI4ZmM1NDRmOTJjZTgxMjRlMjI1NWY4YzNjNmFmOTNmMjgyNDNhMTIwNTg1ZDRjNGM2YTJhM2MwIikuYXNfc2xpY2UoKTsKICAgICAgICBsZXQgYmxvY2sgPSBTZWFsZWRCbG9jazo6PEJsb2NrPjo6ZGVjb2RlKCZtdXQgYmxvY2tfcmxwKS51bndyYXAoKTsKICAgICAgICBwcm92aWRlci5pbnNlcnRfYmxvY2soJmdlbmVzaXMudHJ5X3JlY292ZXIoKS51bndyYXAoKSkudW53cmFwKCk7CiAgICAgICAgcHJvdmlkZXIuaW5zZXJ0X2Jsb2NrKCZibG9jay5jbG9uZSgpLnRyeV9yZWNvdmVyKCkudW53cmFwKCkpLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyCiAgICAgICAgICAgIC5zdGF0aWNfZmlsZV9wcm92aWRlcigpCiAgICAgICAgICAgIC5sYXRlc3Rfd3JpdGVyKFN0YXRpY0ZpbGVTZWdtZW50OjpIZWFkZXJzKQogICAgICAgICAgICAudW53cmFwKCkKICAgICAgICAgICAgLmNvbW1pdCgpCiAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICB7CiAgICAgICAgICAgIGxldCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IHByb3ZpZGVyLnN0YXRpY19maWxlX3Byb3ZpZGVyKCk7CiAgICAgICAgICAgIGxldCBtdXQgcmVjZWlwdHNfd3JpdGVyID0KICAgICAgICAgICAgICAgIHN0YXRpY19maWxlX3Byb3ZpZGVyLmxhdGVzdF93cml0ZXIoU3RhdGljRmlsZVNlZ21lbnQ6OlJlY2VpcHRzKS51bndyYXAoKTsKICAgICAgICAgICAgcmVjZWlwdHNfd3JpdGVyLmluY3JlbWVudF9ibG9jaygwKS51bndyYXAoKTsKICAgICAgICAgICAgcmVjZWlwdHNfd3JpdGVyLmNvbW1pdCgpLnVud3JhcCgpOwogICAgICAgIH0KICAgICAgICBwcm92aWRlci5jb21taXQoKS51bndyYXAoKTsKCiAgICAgICAgLy8gdmFyaWFibGVzCiAgICAgICAgbGV0IGNhbGxlcl9hZGRyZXNzID0gYWRkcmVzcyEoIjB4YTk0ZjUzNzRmY2U1ZWRiYzhlMmE4Njk3YzE1MzMxNjc3ZTZlYmYwYiIpOwogICAgICAgIGxldCBkZXN0cm95ZWRfYWRkcmVzcyA9IGFkZHJlc3MhKCIweDA5NWU3YmFlYTZhNmM3YzRjMmRmZWI5NzdlZmFjMzI2YWY1NTJkODciKTsKICAgICAgICBsZXQgYmVuZWZpY2lhcnlfYWRkcmVzcyA9IGFkZHJlc3MhKCIweDJhZGMyNTY2NTAxOGFhMWZlMGU2YmM2NjZkYWM4ZmMyNjk3ZmY5YmEiKTsKCiAgICAgICAgbGV0IGNvZGUgPSBoZXghKCI3MzA5NWU3YmFlYTZhNmM3YzRjMmRmZWI5NzdlZmFjMzI2YWY1NTJkODczMWZmMDAiKTsKICAgICAgICBsZXQgYmFsYW5jZSA9IFUyNTY6OmZyb20oMHgwZGUwYjZiM2E3NjQwMDAwdTY0KTsKICAgICAgICBsZXQgY29kZV9oYXNoID0ga2VjY2FrMjU2KGNvZGUpOwoKICAgICAgICAvLyBwcmUgc3RhdGUKICAgICAgICBsZXQgY2FsbGVyX2luZm8gPSBBY2NvdW50IHsgbm9uY2U6IDAsIGJhbGFuY2UsIGJ5dGVjb2RlX2hhc2g6IE5vbmUgfTsKICAgICAgICBsZXQgZGVzdHJveWVkX2luZm8gPQogICAgICAgICAgICBBY2NvdW50IHsgbm9uY2U6IDAsIGJhbGFuY2U6IFUyNTY6OlpFUk8sIGJ5dGVjb2RlX2hhc2g6IFNvbWUoY29kZV9oYXNoKSB9OwoKICAgICAgICAvLyBzZXQgYWNjb3VudAogICAgICAgIGxldCBwcm92aWRlciA9IHRlc3RfZGIuZmFjdG9yeS5wcm92aWRlcl9ydygpLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLnB1dDo6PHRhYmxlczo6UGxhaW5BY2NvdW50U3RhdGU+KGNhbGxlcl9hZGRyZXNzLCBjYWxsZXJfaW5mbykudW53cmFwKCk7CiAgICAgICAgcHJvdmlkZXIKICAgICAgICAgICAgLnR4X3JlZigpCiAgICAgICAgICAgIC5wdXQ6Ojx0YWJsZXM6OlBsYWluQWNjb3VudFN0YXRlPihkZXN0cm95ZWRfYWRkcmVzcywgZGVzdHJveWVkX2luZm8pCiAgICAgICAgICAgIC51bndyYXAoKTsKICAgICAgICBwcm92aWRlcgogICAgICAgICAgICAudHhfcmVmKCkKICAgICAgICAgICAgLnB1dDo6PHRhYmxlczo6Qnl0ZWNvZGVzPihjb2RlX2hhc2gsIEJ5dGVjb2RlOjpuZXdfcmF3KGNvZGUudG9fdmVjKCkuaW50bygpKSkKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIC8vIHNldCBzdG9yYWdlIHRvIGNoZWNrIHdoZW4gYWNjb3VudCBnZXRzIGRlc3Ryb3llZC4KICAgICAgICBwcm92aWRlcgogICAgICAgICAgICAudHhfcmVmKCkKICAgICAgICAgICAgLnB1dDo6PHRhYmxlczo6UGxhaW5TdG9yYWdlU3RhdGU+KAogICAgICAgICAgICAgICAgZGVzdHJveWVkX2FkZHJlc3MsCiAgICAgICAgICAgICAgICBTdG9yYWdlRW50cnkgeyBrZXk6IEIyNTY6OlpFUk8sIHZhbHVlOiBVMjU2OjpaRVJPIH0sCiAgICAgICAgICAgICkKICAgICAgICAgICAgLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyCiAgICAgICAgICAgIC50eF9yZWYoKQogICAgICAgICAgICAucHV0Ojo8dGFibGVzOjpQbGFpblN0b3JhZ2VTdGF0ZT4oCiAgICAgICAgICAgICAgICBkZXN0cm95ZWRfYWRkcmVzcywKICAgICAgICAgICAgICAgIFN0b3JhZ2VFbnRyeSB7IGtleTogQjI1Njo6d2l0aF9sYXN0X2J5dGUoMSksIHZhbHVlOiBVMjU2Ojpmcm9tKDF1NjQpIH0sCiAgICAgICAgICAgICkKICAgICAgICAgICAgLnVud3JhcCgpOwoKICAgICAgICBwcm92aWRlci5jb21taXQoKS51bndyYXAoKTsKCiAgICAgICAgLy8gZXhlY3V0ZQogICAgICAgIGxldCBwcm92aWRlciA9IHRlc3RfZGIuZmFjdG9yeS5kYXRhYmFzZV9wcm92aWRlcl9ydygpLnVud3JhcCgpOwogICAgICAgIGxldCBtdXQgZXhlY3V0aW9uX3N0YWdlID0gc3RhZ2UoKTsKICAgICAgICBsZXQgXyA9IGV4ZWN1dGlvbl9zdGFnZS5leGVjdXRlKCZwcm92aWRlciwgaW5wdXQpLnVud3JhcCgpOwogICAgICAgIHByb3ZpZGVyLmNvbW1pdCgpLnVud3JhcCgpOwoKICAgICAgICAvLyBhc3NlcnQgdW53aW5kIHN0YWdlCiAgICAgICAgbGV0IHByb3ZpZGVyID0gdGVzdF9kYi5mYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0IShtYXRjaGVzIShwcm92aWRlci5iYXNpY19hY2NvdW50KCZkZXN0cm95ZWRfYWRkcmVzcyksIE9rKE5vbmUpKSk7CgogICAgICAgIGFzc2VydCEobWF0Y2hlcyEoCiAgICAgICAgICAgIHByb3ZpZGVyLnR4X3JlZigpLmdldDo6PHRhYmxlczo6UGxhaW5TdG9yYWdlU3RhdGU+KGRlc3Ryb3llZF9hZGRyZXNzKSwKICAgICAgICAgICAgT2soTm9uZSkKICAgICAgICApKTsKICAgICAgICAvLyBkcm9wcyB0eCBzbyB0aGF0IGl0IHJldHVybnMgd3JpdGUgcHJpdmlsZWdlIHRvIHRlc3RfdHgKICAgICAgICBkcm9wKHByb3ZpZGVyKTsKICAgICAgICBsZXQgcGxhaW5fYWNjb3VudHMgPSB0ZXN0X2RiLnRhYmxlOjo8dGFibGVzOjpQbGFpbkFjY291bnRTdGF0ZT4oKS51bndyYXAoKTsKICAgICAgICBsZXQgcGxhaW5fc3RvcmFnZSA9IHRlc3RfZGIudGFibGU6Ojx0YWJsZXM6OlBsYWluU3RvcmFnZVN0YXRlPigpLnVud3JhcCgpOwoKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBwbGFpbl9hY2NvdW50cywKICAgICAgICAgICAgdmVjIVsKICAgICAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICAgICBiZW5lZmljaWFyeV9hZGRyZXNzLAogICAgICAgICAgICAgICAgICAgIEFjY291bnQgewogICAgICAgICAgICAgICAgICAgICAgICBub25jZTogMCwKICAgICAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogVTI1Njo6ZnJvbSgweDFiYzE2ZDY3NGVjYTMwYTB1NjQpLAogICAgICAgICAgICAgICAgICAgICAgICBieXRlY29kZV9oYXNoOiBOb25lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICAgICBjYWxsZXJfYWRkcmVzcywKICAgICAgICAgICAgICAgICAgICBBY2NvdW50IHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9uY2U6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhbGFuY2U6IFUyNTY6OmZyb20oMHhkZTBiNmIzYTc2MWNmNjB1NjQpLAogICAgICAgICAgICAgICAgICAgICAgICBieXRlY29kZV9oYXNoOiBOb25lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBdCiAgICAgICAgKTsKICAgICAgICBhc3NlcnQhKHBsYWluX3N0b3JhZ2UuaXNfZW1wdHkoKSk7CgogICAgICAgIGxldCBhY2NvdW50X2NoYW5nZXNldHMgPSB0ZXN0X2RiLnRhYmxlOjo8dGFibGVzOjpBY2NvdW50Q2hhbmdlU2V0cz4oKS51bndyYXAoKTsKICAgICAgICBsZXQgc3RvcmFnZV9jaGFuZ2VzZXRzID0gdGVzdF9kYi50YWJsZTo6PHRhYmxlczo6U3RvcmFnZUNoYW5nZVNldHM+KCkudW53cmFwKCk7CgogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGFjY291bnRfY2hhbmdlc2V0cywKICAgICAgICAgICAgdmVjIVsKICAgICAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICAgICBibG9jay5udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgQWNjb3VudEJlZm9yZVR4IHsgYWRkcmVzczogZGVzdHJveWVkX2FkZHJlc3MsIGluZm86IFNvbWUoZGVzdHJveWVkX2luZm8pIH0sCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgKGJsb2NrLm51bWJlciwgQWNjb3VudEJlZm9yZVR4IHsgYWRkcmVzczogYmVuZWZpY2lhcnlfYWRkcmVzcywgaW5mbzogTm9uZSB9KSwKICAgICAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICAgICBibG9jay5udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgQWNjb3VudEJlZm9yZVR4IHsgYWRkcmVzczogY2FsbGVyX2FkZHJlc3MsIGluZm86IFNvbWUoY2FsbGVyX2luZm8pIH0KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgIF0KICAgICAgICApOwoKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBzdG9yYWdlX2NoYW5nZXNldHMsCiAgICAgICAgICAgIHZlYyFbCiAgICAgICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAgICAgKGJsb2NrLm51bWJlciwgZGVzdHJveWVkX2FkZHJlc3MpLmludG8oKSwKICAgICAgICAgICAgICAgICAgICBTdG9yYWdlRW50cnkgeyBrZXk6IEIyNTY6OlpFUk8sIHZhbHVlOiBVMjU2OjpaRVJPIH0KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAgICAgKGJsb2NrLm51bWJlciwgZGVzdHJveWVkX2FkZHJlc3MpLmludG8oKSwKICAgICAgICAgICAgICAgICAgICBTdG9yYWdlRW50cnkgeyBrZXk6IEIyNTY6OndpdGhfbGFzdF9ieXRlKDEpLCB2YWx1ZTogVTI1Njo6ZnJvbSgxdTY0KSB9CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIF0KICAgICAgICApOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfZW5zdXJlX2NvbnNpc3RlbmN5X3dpdGhfc2tpcHBlZF9yZWNlaXB0cygpIHsKICAgICAgICAvLyBUZXN0IHRoYXQgZW5zdXJlX2NvbnNpc3RlbmN5IGFsbG93cyB0aGUgY2FzZSB3aGVyZSByZWNlaXB0cyBhcmUgaW50ZW50aW9uYWxseQogICAgICAgIC8vIHNraXBwZWQuIFdoZW4gcmVjZWlwdHMgYXJlIHNraXBwZWQsIGJsb2NrcyBhcmUgc3RpbGwgaW5jcmVtZW50ZWQgaW4gc3RhdGljIGZpbGVzCiAgICAgICAgLy8gYnV0IG5vIHJlY2VpcHQgZGF0YSBpcyB3cml0dGVuLgoKICAgICAgICBsZXQgZmFjdG9yeSA9IGNyZWF0ZV90ZXN0X3Byb3ZpZGVyX2ZhY3RvcnkoKTsKICAgICAgICBmYWN0b3J5LnNldF9zdG9yYWdlX3NldHRpbmdzX2NhY2hlKAogICAgICAgICAgICBTdG9yYWdlU2V0dGluZ3M6OmxlZ2FjeSgpLndpdGhfcmVjZWlwdHNfaW5fc3RhdGljX2ZpbGVzKHRydWUpLAogICAgICAgICk7CgogICAgICAgIC8vIFNldHVwIHdpdGggYmxvY2sgMQogICAgICAgIGxldCBwcm92aWRlcl9ydyA9IGZhY3RvcnkuZGF0YWJhc2VfcHJvdmlkZXJfcncoKS51bndyYXAoKTsKICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwogICAgICAgIGxldCBnZW5lc2lzID0gZ2VuZXJhdG9yczo6cmFuZG9tX2Jsb2NrKCZtdXQgcm5nLCAwLCBEZWZhdWx0OjpkZWZhdWx0KCkpOwogICAgICAgIHByb3ZpZGVyX3J3CiAgICAgICAgICAgIC5pbnNlcnRfYmxvY2soJmdlbmVzaXMudHJ5X3JlY292ZXIoKS51bndyYXAoKSkKICAgICAgICAgICAgLmV4cGVjdCgiZmFpbGVkIHRvIGluc2VydCBnZW5lc2lzIik7CiAgICAgICAgbGV0IGJsb2NrID0gZ2VuZXJhdG9yczo6cmFuZG9tX2Jsb2NrKAogICAgICAgICAgICAmbXV0IHJuZywKICAgICAgICAgICAgMSwKICAgICAgICAgICAgZ2VuZXJhdG9yczo6QmxvY2tQYXJhbXMgeyB0eF9jb3VudDogU29tZSgyKSwgLi5EZWZhdWx0OjpkZWZhdWx0KCkgfSwKICAgICAgICApOwogICAgICAgIHByb3ZpZGVyX3J3Lmluc2VydF9ibG9jaygmYmxvY2sudHJ5X3JlY292ZXIoKS51bndyYXAoKSkuZXhwZWN0KCJmYWlsZWQgdG8gaW5zZXJ0IGJsb2NrIik7CgogICAgICAgIGxldCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IHByb3ZpZGVyX3J3LnN0YXRpY19maWxlX3Byb3ZpZGVyKCk7CiAgICAgICAgc3RhdGljX2ZpbGVfcHJvdmlkZXIubGF0ZXN0X3dyaXRlcihTdGF0aWNGaWxlU2VnbWVudDo6SGVhZGVycykudW53cmFwKCkuY29tbWl0KCkudW53cmFwKCk7CgogICAgICAgIC8vIFNpbXVsYXRlIHNraXBwZWQgcmVjZWlwdHM6IGluY3JlbWVudCBibG9jayBpbiByZWNlaXB0cyBzdGF0aWMgZmlsZSBidXQgZG9uJ3Qgd3JpdGUKICAgICAgICAvLyByZWNlaXB0cwogICAgICAgIHsKICAgICAgICAgICAgbGV0IG11dCByZWNlaXB0c193cml0ZXIgPQogICAgICAgICAgICAgICAgc3RhdGljX2ZpbGVfcHJvdmlkZXIubGF0ZXN0X3dyaXRlcihTdGF0aWNGaWxlU2VnbWVudDo6UmVjZWlwdHMpLnVud3JhcCgpOwogICAgICAgICAgICByZWNlaXB0c193cml0ZXIuaW5jcmVtZW50X2Jsb2NrKDApLnVud3JhcCgpOwogICAgICAgICAgICByZWNlaXB0c193cml0ZXIuaW5jcmVtZW50X2Jsb2NrKDEpLnVud3JhcCgpOwogICAgICAgICAgICByZWNlaXB0c193cml0ZXIuY29tbWl0KCkudW53cmFwKCk7CiAgICAgICAgfSAvLyBFeHBsaWNpdGx5IGRyb3AgcmVjZWlwdHNfd3JpdGVyIGhlcmUKCiAgICAgICAgcHJvdmlkZXJfcncuY29tbWl0KCkuZXhwZWN0KCJmYWlsZWQgdG8gY29tbWl0Iik7CgogICAgICAgIC8vIFZlcmlmeSBibG9ja3MgYXJlIGluY3JlbWVudGVkIGJ1dCBubyByZWNlaXB0cyB3cml0dGVuCiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgZmFjdG9yeQogICAgICAgICAgICAgICAgLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkKICAgICAgICAgICAgICAgIC5nZXRfaGlnaGVzdF9zdGF0aWNfZmlsZV9ibG9jayhTdGF0aWNGaWxlU2VnbWVudDo6UmVjZWlwdHMpLAogICAgICAgICAgICBTb21lKDEpCiAgICAgICAgKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBmYWN0b3J5LnN0YXRpY19maWxlX3Byb3ZpZGVyKCkuZ2V0X2hpZ2hlc3Rfc3RhdGljX2ZpbGVfdHgoU3RhdGljRmlsZVNlZ21lbnQ6OlJlY2VpcHRzKSwKICAgICAgICAgICAgTm9uZQogICAgICAgICk7CgogICAgICAgIC8vIENyZWF0ZSBleGVjdXRpb24gc3RhZ2UKICAgICAgICBsZXQgc3RhZ2UgPSBzdGFnZSgpOwoKICAgICAgICAvLyBSdW4gZW5zdXJlX2NvbnNpc3RlbmN5IC0gc2hvdWxkIE5PVCBlcnJvcgogICAgICAgIC8vIEJsb2NrIG51bWJlcnMgbWF0Y2ggKGJvdGggYXQgMSksIGJ1dCB0eCBudW1iZXJzIGRvbid0IChkYXRhYmFzZSBoYXMgdHhzLCBzdGF0aWMgZmlsZXMKICAgICAgICAvLyBkb24ndCkgVGhpcyBpcyBmaW5lIC0gcmVjZWlwdHMgYXJlIGJlaW5nIHNraXBwZWQKICAgICAgICBsZXQgcHJvdmlkZXIgPSBmYWN0b3J5LnByb3ZpZGVyKCkudW53cmFwKCk7CiAgICAgICAgc3RhZ2UKICAgICAgICAgICAgLmVuc3VyZV9jb25zaXN0ZW5jeSgmcHJvdmlkZXIsIDEsIE5vbmUpCiAgICAgICAgICAgIC5leHBlY3QoImVuc3VyZV9jb25zaXN0ZW5jeSBzaG91bGQgc3VjY2VlZCB3aGVuIHJlY2VpcHRzIGFyZSBpbnRlbnRpb25hbGx5IHNraXBwZWQiKTsKICAgIH0KfQo8L2ZpbGU+Cgo8ZmlsZSBwYXRoPSJjcmF0ZXMvc3RhZ2VzL3N0YWdlcy9zcmMvc3RhZ2VzL3NlbmRlcl9yZWNvdmVyeS5ycyI+CnVzZSBhbGxveV9wcmltaXRpdmVzOjp7QWRkcmVzcywgQmxvY2tOdW1iZXIsIFR4TnVtYmVyfTsKdXNlIHJldGhfY29uZmlnOjpjb25maWc6OlNlbmRlclJlY292ZXJ5Q29uZmlnOwp1c2UgcmV0aF9jb25zZW5zdXM6OkNvbnNlbnN1c0Vycm9yOwp1c2UgcmV0aF9kYjo6c3RhdGljX2ZpbGU6OlRyYW5zYWN0aW9uTWFzazsKdXNlIHJldGhfZGJfYXBpOjp7CiAgICBjdXJzb3I6OkRiQ3Vyc29yUlcsCiAgICB0YWJsZTo6VmFsdWUsCiAgICB0YWJsZXMsCiAgICB0cmFuc2FjdGlvbjo6e0RiVHgsIERiVHhNdXR9LAogICAgUmF3VmFsdWUsCn07CnVzZSByZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjp7R290RXhwZWN0ZWQsIE5vZGVQcmltaXRpdmVzLCBTaWduZWRUcmFuc2FjdGlvbn07CnVzZSByZXRoX3Byb3ZpZGVyOjp7CiAgICBCbG9ja1JlYWRlciwgREJQcm92aWRlciwgRWl0aGVyV3JpdGVyLCBIZWFkZXJQcm92aWRlciwgUHJvdmlkZXJFcnJvciwgUHJ1bmVDaGVja3BvaW50UmVhZGVyLAogICAgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwgU3RhdHNSZWFkZXIsIFN0b3JhZ2VTZXR0aW5nc0NhY2hlLCBUcmFuc2FjdGlvbnNQcm92aWRlciwKfTsKdXNlIHJldGhfcHJ1bmVfdHlwZXM6OlBydW5lU2VnbWVudDsKdXNlIHJldGhfc3RhZ2VzX2FwaTo6ewogICAgQmxvY2tFcnJvcktpbmQsIEVudGl0aWVzQ2hlY2twb2ludCwgRXhlY0lucHV0LCBFeGVjT3V0cHV0LCBTdGFnZSwgU3RhZ2VDaGVja3BvaW50LCBTdGFnZUVycm9yLAogICAgU3RhZ2VJZCwgVW53aW5kSW5wdXQsIFVud2luZE91dHB1dCwKfTsKdXNlIHJldGhfc3RhdGljX2ZpbGVfdHlwZXM6OlN0YXRpY0ZpbGVTZWdtZW50Owp1c2Ugc3RkOjp7Zm10OjpEZWJ1Zywgb3BzOjpSYW5nZSwgc3luYzo6bXBzYywgdGltZTo6SW5zdGFudH07CnVzZSB0aGlzZXJyb3I6OkVycm9yOwp1c2UgdHJhY2luZzo6KjsKCi8vLyBNYXhpbXVtIGFtb3VudCBvZiB0cmFuc2FjdGlvbnMgdG8gcmVhZCBmcm9tIGRpc2sgYXQgb25lIHRpbWUgYmVmb3JlIHdlIGZsdXNoIHRoZWlyIHNlbmRlcnMgdG8KLy8vIGRpc2suIFNpbmNlIGVhY2ggcmF5b24gd29ya2VyIHdpbGwgaG9sZCBhdCBtb3N0IDEwMCB0cmFuc2FjdGlvbnMgKGBXT1JLRVJfQ0hVTktfU0laRWApLCB3ZQovLy8gZWZmZWN0aXZlbHkgbWF4IGxpbWl0IGVhY2ggYmF0Y2ggdG8gMTAwMCBjaGFubmVscyBpbiBtZW1vcnkuCmNvbnN0IEJBVENIX1NJWkU6IHVzaXplID0gMTAwXzAwMDsKCi8vLyBNYXhpbXVtIG51bWJlciBvZiBzZW5kZXJzIHRvIHJlY292ZXIgcGVyIHJheW9uIHdvcmtlciBqb2IuCmNvbnN0IFdPUktFUl9DSFVOS19TSVpFOiB1c2l6ZSA9IDEwMDsKCi8vLyBUeXBlIGFsaWFzIGZvciBhIHNlbmRlciB0aGF0IHRyYW5zbWl0cyB0aGUgcmVzdWx0IG9mIHNlbmRlciByZWNvdmVyeS4KdHlwZSBSZWNvdmVyeVJlc3VsdFNlbmRlciA9IG1wc2M6OlNlbmRlcjxSZXN1bHQ8KHU2NCwgQWRkcmVzcyksIEJveDxTZW5kZXJSZWNvdmVyeVN0YWdlRXJyb3I+Pj47CgovLy8gVGhlIHNlbmRlciByZWNvdmVyeSBzdGFnZSBpdGVyYXRlcyBvdmVyIGV4aXN0aW5nIHRyYW5zYWN0aW9ucywKLy8vIHJlY292ZXJzIHRoZSB0cmFuc2FjdGlvbiBzaWduZXIgYW5kIHN0b3JlcyB0aGVtCi8vLyBpbiBbYFRyYW5zYWN0aW9uU2VuZGVyc2BdW3JldGhfZGJfYXBpOjp0YWJsZXM6OlRyYW5zYWN0aW9uU2VuZGVyc10gdGFibGUuCiNbZGVyaXZlKENsb25lLCBEZWJ1ZyldCnB1YiBzdHJ1Y3QgU2VuZGVyUmVjb3ZlcnlTdGFnZSB7CiAgICAvLy8gVGhlIHNpemUgb2YgaW5zZXJ0ZWQgaXRlbXMgYWZ0ZXIgd2hpY2ggdGhlIGNvbnRyb2wKICAgIC8vLyBmbG93IHdpbGwgYmUgcmV0dXJuZWQgdG8gdGhlIHBpcGVsaW5lIGZvciBjb21taXQKICAgIHB1YiBjb21taXRfdGhyZXNob2xkOiB1NjQsCn0KCmltcGwgU2VuZGVyUmVjb3ZlcnlTdGFnZSB7CiAgICAvLy8gQ3JlYXRlIG5ldyBpbnN0YW5jZSBvZiBbYFNlbmRlclJlY292ZXJ5U3RhZ2VgXS4KICAgIHB1YiBjb25zdCBmbiBuZXcoY29uZmlnOiBTZW5kZXJSZWNvdmVyeUNvbmZpZykgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGNvbW1pdF90aHJlc2hvbGQ6IGNvbmZpZy5jb21taXRfdGhyZXNob2xkIH0KICAgIH0KfQoKaW1wbCBEZWZhdWx0IGZvciBTZW5kZXJSZWNvdmVyeVN0YWdlIHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgY29tbWl0X3RocmVzaG9sZDogNV8wMDBfMDAwIH0KICAgIH0KfQoKaW1wbDxQcm92aWRlcj4gU3RhZ2U8UHJvdmlkZXI+IGZvciBTZW5kZXJSZWNvdmVyeVN0YWdlCndoZXJlCiAgICBQcm92aWRlcjogREJQcm92aWRlcjxUeDogRGJUeE11dD4KICAgICAgICArIEJsb2NrUmVhZGVyCiAgICAgICAgKyBTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5PFByaW1pdGl2ZXM6IE5vZGVQcmltaXRpdmVzPFNpZ25lZFR4OiBWYWx1ZSArIFNpZ25lZFRyYW5zYWN0aW9uPj4KICAgICAgICArIFN0YXRzUmVhZGVyCiAgICAgICAgKyBQcnVuZUNoZWNrcG9pbnRSZWFkZXIKICAgICAgICArIFN0b3JhZ2VTZXR0aW5nc0NhY2hlLAp7CiAgICAvLy8gUmV0dXJuIHRoZSBpZCBvZiB0aGUgc3RhZ2UKICAgIGZuIGlkKCZzZWxmKSAtPiBTdGFnZUlkIHsKICAgICAgICBTdGFnZUlkOjpTZW5kZXJSZWNvdmVyeQogICAgfQoKICAgIC8vLyBSZXRyaWV2ZSB0aGUgcmFuZ2Ugb2YgdHJhbnNhY3Rpb25zIHRvIGl0ZXJhdGUgb3ZlciBieSBxdWVyeWluZwogICAgLy8vIFtgQmxvY2tCb2R5SW5kaWNlc2BdW3JldGhfZGJfYXBpOjp0YWJsZXM6OkJsb2NrQm9keUluZGljZXNdLAogICAgLy8vIGNvbGxlY3QgdHJhbnNhY3Rpb25zIHdpdGhpbiB0aGF0IHJhbmdlLCByZWNvdmVyIHNpZ25lciBmb3IgZWFjaCB0cmFuc2FjdGlvbiBhbmQgc3RvcmUKICAgIC8vLyBlbnRyaWVzIGluIHRoZSBbYFRyYW5zYWN0aW9uU2VuZGVyc2BdW3JldGhfZGJfYXBpOjp0YWJsZXM6OlRyYW5zYWN0aW9uU2VuZGVyc10gdGFibGUgb3IKICAgIC8vLyBzdGF0aWMgZmlsZXMgZGVwZW5kaW5nIG9uIGNvbmZpZ3VyYXRpb24uCiAgICBmbiBleGVjdXRlKCZtdXQgc2VsZiwgcHJvdmlkZXI6ICZQcm92aWRlciwgaW5wdXQ6IEV4ZWNJbnB1dCkgLT4gUmVzdWx0PEV4ZWNPdXRwdXQsIFN0YWdlRXJyb3I+IHsKICAgICAgICBpZiBpbnB1dC50YXJnZXRfcmVhY2hlZCgpIHsKICAgICAgICAgICAgcmV0dXJuIE9rKEV4ZWNPdXRwdXQ6OmRvbmUoaW5wdXQuY2hlY2twb2ludCgpKSkKICAgICAgICB9CgogICAgICAgIGxldCBTb21lKHJhbmdlX291dHB1dCkgPQogICAgICAgICAgICBpbnB1dC5uZXh0X2Jsb2NrX3JhbmdlX3dpdGhfdHJhbnNhY3Rpb25fdGhyZXNob2xkKHByb3ZpZGVyLCBzZWxmLmNvbW1pdF90aHJlc2hvbGQpPwogICAgICAgIGVsc2UgewogICAgICAgICAgICBpbmZvISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OnNlbmRlcl9yZWNvdmVyeSIsICJObyB0cmFuc2FjdGlvbiBzZW5kZXJzIHRvIHJlY292ZXIiKTsKICAgICAgICAgICAgRWl0aGVyV3JpdGVyOjpuZXdfc2VuZGVycygKICAgICAgICAgICAgICAgIHByb3ZpZGVyLAogICAgICAgICAgICAgICAgcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAuc3RhdGljX2ZpbGVfcHJvdmlkZXIoKQogICAgICAgICAgICAgICAgICAgIC5nZXRfaGlnaGVzdF9zdGF0aWNfZmlsZV9ibG9jayhTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25TZW5kZXJzKQogICAgICAgICAgICAgICAgICAgIC51bndyYXBfb3JfZGVmYXVsdCgpLAogICAgICAgICAgICApPwogICAgICAgICAgICAuZW5zdXJlX2F0X2Jsb2NrKGlucHV0LnRhcmdldCgpKT87CiAgICAgICAgICAgIHJldHVybiBPayhFeGVjT3V0cHV0IHsKICAgICAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KGlucHV0LnRhcmdldCgpKQogICAgICAgICAgICAgICAgICAgIC53aXRoX2VudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfY2hlY2twb2ludChwcm92aWRlcik/KSwKICAgICAgICAgICAgICAgIGRvbmU6IHRydWUsCiAgICAgICAgICAgIH0pCiAgICAgICAgfTsKICAgICAgICBsZXQgZW5kX2Jsb2NrID0gKnJhbmdlX291dHB1dC5ibG9ja19yYW5nZS5lbmQoKTsKCiAgICAgICAgbGV0IG11dCB3cml0ZXIgPSBFaXRoZXJXcml0ZXI6Om5ld19zZW5kZXJzKHByb3ZpZGVyLCAqcmFuZ2Vfb3V0cHV0LmJsb2NrX3JhbmdlLnN0YXJ0KCkpPzsKCiAgICAgICAgaW5mbyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpzZW5kZXJfcmVjb3ZlcnkiLCB0eF9yYW5nZSA9ID9yYW5nZV9vdXRwdXQudHhfcmFuZ2UsICJSZWNvdmVyaW5nIHNlbmRlcnMiKTsKCiAgICAgICAgLy8gSXRlcmF0ZSBvdmVyIHRyYW5zYWN0aW9ucyBpbiBiYXRjaGVzLCByZWNvdmVyIHRoZSBzZW5kZXJzIGFuZCBhcHBlbmQgdGhlbQogICAgICAgIGxldCBiYXRjaCA9IHJhbmdlX291dHB1dAogICAgICAgICAgICAudHhfcmFuZ2UKICAgICAgICAgICAgLmNsb25lKCkKICAgICAgICAgICAgLnN0ZXBfYnkoQkFUQ0hfU0laRSkKICAgICAgICAgICAgLm1hcCh8c3RhcnR8IHN0YXJ0Li5zdGQ6OmNtcDo6bWluKHN0YXJ0ICsgQkFUQ0hfU0laRSBhcyB1NjQsIHJhbmdlX291dHB1dC50eF9yYW5nZS5lbmQpKQogICAgICAgICAgICAuY29sbGVjdDo6PFZlYzxSYW5nZTx1NjQ+Pj4oKTsKCiAgICAgICAgbGV0IHR4X2JhdGNoX3NlbmRlciA9IHNldHVwX3JhbmdlX3JlY292ZXJ5KHByb3ZpZGVyKTsKCiAgICAgICAgbGV0IHN0YXJ0ID0gSW5zdGFudDo6bm93KCk7CiAgICAgICAgbGV0IGJsb2NrX2JvZHlfaW5kaWNlcyA9CiAgICAgICAgICAgIHByb3ZpZGVyLmJsb2NrX2JvZHlfaW5kaWNlc19yYW5nZShyYW5nZV9vdXRwdXQuYmxvY2tfcmFuZ2UuY2xvbmUoKSk/OwogICAgICAgIGxldCBibG9ja19ib2R5X2luZGljZXNfZWxhcHNlZCA9IHN0YXJ0LmVsYXBzZWQoKTsKICAgICAgICBsZXQgbXV0IGJsb2Nrc193aXRoX2luZGljZXMgPSByYW5nZV9vdXRwdXQuYmxvY2tfcmFuZ2UuemlwKGJsb2NrX2JvZHlfaW5kaWNlcykucGVla2FibGUoKTsKCiAgICAgICAgZm9yIHJhbmdlIGluIGJhdGNoIHsKICAgICAgICAgICAgLy8gUGFpciBlYWNoIHRyYW5zYWN0aW9uIG51bWJlciB3aXRoIGl0cyBibG9jayBudW1iZXIKICAgICAgICAgICAgbGV0IHN0YXJ0ID0gSW5zdGFudDo6bm93KCk7CiAgICAgICAgICAgIGxldCBibG9ja19udW1iZXJzID0gcmFuZ2UuY2xvbmUoKS5mb2xkKFZlYzo6bmV3KCksIHxtdXQgYmxvY2tfbnVtYmVycywgdHh8IHsKICAgICAgICAgICAgICAgIHdoaWxlIGxldCBTb21lKChibG9jaywgaW5kZXgpKSA9IGJsb2Nrc193aXRoX2luZGljZXMucGVlaygpIHsKICAgICAgICAgICAgICAgICAgICBpZiBpbmRleC5jb250YWluc190eCh0eCkgewogICAgICAgICAgICAgICAgICAgICAgICBibG9ja19udW1iZXJzLnB1c2goKmJsb2NrKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGJsb2NrX251bWJlcnMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYmxvY2tzX3dpdGhfaW5kaWNlcy5uZXh0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBibG9ja19udW1iZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsZXQgZm9sZF9lbGFwc2VkID0gc3RhcnQuZWxhcHNlZCgpOwogICAgICAgICAgICBkZWJ1ZyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpzZW5kZXJfcmVjb3ZlcnkiLCA/YmxvY2tfYm9keV9pbmRpY2VzX2VsYXBzZWQsID9mb2xkX2VsYXBzZWQsIGxlbiA9IGJsb2NrX251bWJlcnMubGVuKCksICJDYWxjdWxhdGVkIGJsb2NrIG51bWJlcnMiKTsKICAgICAgICAgICAgcmVjb3Zlcl9yYW5nZShyYW5nZSwgYmxvY2tfbnVtYmVycywgcHJvdmlkZXIsIHR4X2JhdGNoX3NlbmRlci5jbG9uZSgpLCAmbXV0IHdyaXRlcik/OwogICAgICAgIH0KCiAgICAgICAgLy8gQWR2YW5jZSB0aGUgc3RhdGljIGZpbGUgaGVhZGVyIHRvIHRoZSBlbmQgb2YgdGhpcyByYW5nZSB0byBhY2NvdW50IGZvciBlbXB0eSBibG9ja3MuCiAgICAgICAgd3JpdGVyLmVuc3VyZV9hdF9ibG9jayhlbmRfYmxvY2spPzsKCiAgICAgICAgT2soRXhlY091dHB1dCB7CiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludDo6bmV3KGVuZF9ibG9jaykKICAgICAgICAgICAgICAgIC53aXRoX2VudGl0aWVzX3N0YWdlX2NoZWNrcG9pbnQoc3RhZ2VfY2hlY2twb2ludChwcm92aWRlcik/KSwKICAgICAgICAgICAgZG9uZTogcmFuZ2Vfb3V0cHV0LmlzX2ZpbmFsX3JhbmdlLAogICAgICAgIH0pCiAgICB9CgogICAgLy8vIFVud2luZCB0aGUgc3RhZ2UuCiAgICBmbiB1bndpbmQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICAgICAgaW5wdXQ6IFVud2luZElucHV0LAogICAgKSAtPiBSZXN1bHQ8VW53aW5kT3V0cHV0LCBTdGFnZUVycm9yPiB7CiAgICAgICAgbGV0IChfLCB1bndpbmRfdG8sIF8pID0gaW5wdXQudW53aW5kX2Jsb2NrX3JhbmdlX3dpdGhfdGhyZXNob2xkKHNlbGYuY29tbWl0X3RocmVzaG9sZCk7CgogICAgICAgIC8vIExvb2t1cCB0aGUgbmV4dCB0eCBpZCBhZnRlciB1bndpbmRfdG8gYmxvY2sgKGZpcnN0IHR4IHRvIHJlbW92ZSkKICAgICAgICBsZXQgdW53aW5kX3R4X2Zyb20gPSBwcm92aWRlcgogICAgICAgICAgICAuYmxvY2tfYm9keV9pbmRpY2VzKHVud2luZF90byk/CiAgICAgICAgICAgIC5va19vcihQcm92aWRlckVycm9yOjpCbG9ja0JvZHlJbmRpY2VzTm90Rm91bmQodW53aW5kX3RvKSk/CiAgICAgICAgICAgIC5uZXh0X3R4X251bSgpOwoKICAgICAgICBFaXRoZXJXcml0ZXI6Om5ld19zZW5kZXJzKHByb3ZpZGVyLCB1bndpbmRfdG8pPy5wcnVuZV9zZW5kZXJzKHVud2luZF90eF9mcm9tLCB1bndpbmRfdG8pPzsKCiAgICAgICAgT2soVW53aW5kT3V0cHV0IHsKICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcodW53aW5kX3RvKQogICAgICAgICAgICAgICAgLndpdGhfZW50aXRpZXNfc3RhZ2VfY2hlY2twb2ludChzdGFnZV9jaGVja3BvaW50KHByb3ZpZGVyKT8pLAogICAgICAgIH0pCiAgICB9Cn0KCmZuIHJlY292ZXJfcmFuZ2U8UHJvdmlkZXIsIENVUlNPUj4oCiAgICB0eF9yYW5nZTogUmFuZ2U8VHhOdW1iZXI+LAogICAgYmxvY2tfbnVtYmVyczogVmVjPEJsb2NrTnVtYmVyPiwKICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCiAgICB0eF9iYXRjaF9zZW5kZXI6IG1wc2M6OlNlbmRlcjxWZWM8KFJhbmdlPHU2ND4sIFJlY292ZXJ5UmVzdWx0U2VuZGVyKT4+LAogICAgd3JpdGVyOiAmbXV0IEVpdGhlcldyaXRlcjwnXywgQ1VSU09SLCBQcm92aWRlcjo6UHJpbWl0aXZlcz4sCikgLT4gUmVzdWx0PCgpLCBTdGFnZUVycm9yPgp3aGVyZQogICAgUHJvdmlkZXI6IERCUHJvdmlkZXIgKyBIZWFkZXJQcm92aWRlciArIFRyYW5zYWN0aW9uc1Byb3ZpZGVyICsgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeSwKICAgIENVUlNPUjogRGJDdXJzb3JSVzx0YWJsZXM6OlRyYW5zYWN0aW9uU2VuZGVycz4sCnsKICAgIGRlYnVnX2Fzc2VydF9lcSEoCiAgICAgICAgdHhfcmFuZ2UuY2xvbmUoKS5jb3VudCgpLAogICAgICAgIGJsb2NrX251bWJlcnMubGVuKCksCiAgICAgICAgIlRyYW5zYWN0aW9uIHJhbmdlIGFuZCBibG9jayBudW1iZXJzIGNvdW50IG1pc21hdGNoIgogICAgKTsKCiAgICBkZWJ1ZyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpzZW5kZXJfcmVjb3ZlcnkiLCA/dHhfcmFuZ2UsICJTZW5kaW5nIGJhdGNoIGZvciBwcm9jZXNzaW5nIik7CgogICAgLy8gUHJlYWxsb2NhdGUgY2hhbm5lbHMgZm9yIGVhY2ggY2h1bmtzIGluIHRoZSBiYXRjaAogICAgbGV0IChjaHVua3MsIHJlY2VpdmVycyk6IChWZWM8Xz4sIFZlYzxfPikgPSB0eF9yYW5nZQogICAgICAgIC5jbG9uZSgpCiAgICAgICAgLnN0ZXBfYnkoV09SS0VSX0NIVU5LX1NJWkUpCiAgICAgICAgLm1hcCh8c3RhcnR8IHsKICAgICAgICAgICAgbGV0IHJhbmdlID0gc3RhcnQuLnN0ZDo6Y21wOjptaW4oc3RhcnQgKyBXT1JLRVJfQ0hVTktfU0laRSBhcyB1NjQsIHR4X3JhbmdlLmVuZCk7CiAgICAgICAgICAgIGxldCAodHgsIHJ4KSA9IG1wc2M6OmNoYW5uZWwoKTsKICAgICAgICAgICAgLy8gUmFuZ2UgYW5kIGNoYW5uZWwgc2VuZGVyIHdpbGwgYmUgc2VudCB0byByYXlvbiB3b3JrZXIKICAgICAgICAgICAgKChyYW5nZSwgdHgpLCByeCkKICAgICAgICB9KQogICAgICAgIC51bnppcCgpOwoKICAgIGlmIGxldCBTb21lKGVycikgPSB0eF9iYXRjaF9zZW5kZXIuc2VuZChjaHVua3MpLmVycigpIHsKICAgICAgICByZXR1cm4gRXJyKFN0YWdlRXJyb3I6OkZhdGFsKGVyci5pbnRvKCkpKTsKICAgIH0KCiAgICBkZWJ1ZyEodGFyZ2V0OiAic3luYzo6c3RhZ2VzOjpzZW5kZXJfcmVjb3ZlcnkiLCA/dHhfcmFuZ2UsICJBcHBlbmRpbmcgcmVjb3ZlcmVkIHNlbmRlcnMgdG8gdGhlIGRhdGFiYXNlIik7CgogICAgbGV0IG11dCBwcm9jZXNzZWRfdHJhbnNhY3Rpb25zID0gMDsKICAgIGxldCBtdXQgYmxvY2tfbnVtYmVycyA9IGJsb2NrX251bWJlcnMuaW50b19pdGVyKCk7CiAgICBmb3IgY2hhbm5lbCBpbiByZWNlaXZlcnMgewogICAgICAgIHdoaWxlIGxldCBPayhyZWNvdmVyZWQpID0gY2hhbm5lbC5yZWN2KCkgewogICAgICAgICAgICBsZXQgKHR4X2lkLCBzZW5kZXIpID0gbWF0Y2ggcmVjb3ZlcmVkIHsKICAgICAgICAgICAgICAgIE9rKHJlc3VsdCkgPT4gcmVzdWx0LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoICplcnJvciB7CiAgICAgICAgICAgICAgICAgICAgICAgIFNlbmRlclJlY292ZXJ5U3RhZ2VFcnJvcjo6RmFpbGVkUmVjb3ZlcnkoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBnZXQgdGhlIGJsb2NrIG51bWJlciBmb3IgdGhlIGJhZCB0cmFuc2FjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGJsb2NrX251bWJlciA9IHByb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnR4X3JlZigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldDo6PHRhYmxlczo6VHJhbnNhY3Rpb25CbG9ja3M+KGVyci50eCk/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm9rX29yKFByb3ZpZGVyRXJyb3I6OkJsb2NrTnVtYmVyRm9yVHJhbnNhY3Rpb25JbmRleE5vdEZvdW5kKT87CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmV0Y2ggdGhlIHNlYWxlZCBoZWFkZXIgc28gd2UgY2FuIHVzZSBpdCBpbiB0aGUgc2VuZGVyIHJlY292ZXJ5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1bndpbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzZWFsZWRfaGVhZGVyID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlci5zZWFsZWRfaGVhZGVyKGJsb2NrX251bWJlcik/Lm9rX29yX2Vsc2UofHwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQcm92aWRlckVycm9yOjpIZWFkZXJOb3RGb3VuZChibG9ja19udW1iZXIuaW50bygpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pPzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBFcnIoU3RhZ2VFcnJvcjo6QmxvY2sgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrOiBCb3g6Om5ldyhzZWFsZWRfaGVhZGVyLmJsb2NrX3dpdGhfcGFyZW50KCkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBCbG9ja0Vycm9yS2luZDo6VmFsaWRhdGlvbigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29uc2Vuc3VzRXJyb3I6OlRyYW5zYWN0aW9uU2lnbmVyUmVjb3ZlcnlFcnJvciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBTZW5kZXJSZWNvdmVyeVN0YWdlRXJyb3I6OlN0YWdlRXJyb3IoZXJyKSA9PiBFcnIoZXJyKSwKICAgICAgICAgICAgICAgICAgICAgICAgU2VuZGVyUmVjb3ZlcnlTdGFnZUVycm9yOjpSZWNvdmVyZWRTZW5kZXJzTWlzbWF0Y2goZXhwZWN0YXRpb24pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEVycihTdGFnZUVycm9yOjpGYXRhbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTZW5kZXJSZWNvdmVyeVN0YWdlRXJyb3I6OlJlY292ZXJlZFNlbmRlcnNNaXNtYXRjaChleHBlY3RhdGlvbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmludG8oKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBsZXQgbmV3X2Jsb2NrX251bWJlciA9IGJsb2NrX251bWJlcnMKICAgICAgICAgICAgICAgIC5uZXh0KCkKICAgICAgICAgICAgICAgIC5leHBlY3QoImJsb2NrIG51bWJlcnMgaXRlcmF0b3IgaGFzIHRoZSBzYW1lIGxlbmd0aCBhcyB0aGUgbnVtYmVyIG9mIHRyYW5zYWN0aW9ucyIpOwogICAgICAgICAgICB3cml0ZXIuZW5zdXJlX2F0X2Jsb2NrKG5ld19ibG9ja19udW1iZXIpPzsKICAgICAgICAgICAgd3JpdGVyLmFwcGVuZF9zZW5kZXIodHhfaWQsICZzZW5kZXIpPzsKICAgICAgICAgICAgcHJvY2Vzc2VkX3RyYW5zYWN0aW9ucyArPSAxOwogICAgICAgIH0KICAgIH0KICAgIGRlYnVnISh0YXJnZXQ6ICJzeW5jOjpzdGFnZXM6OnNlbmRlcl9yZWNvdmVyeSIsID90eF9yYW5nZSwgIkZpbmlzaGVkIHJlY292ZXJpbmcgc2VuZGVycyBiYXRjaCIpOwoKICAgIC8vIEZhaWwgc2FmZSB0byBlbnN1cmUgdGhhdCB3ZSBkbyBub3QgcHJvY2VlZCB3aXRob3V0IGhhdmluZyByZWNvdmVyZWQgYWxsIHNlbmRlcnMuCiAgICBsZXQgZXhwZWN0ZWQgPSB0eF9yYW5nZS5lbmQgLSB0eF9yYW5nZS5zdGFydDsKICAgIGlmIHByb2Nlc3NlZF90cmFuc2FjdGlvbnMgIT0gZXhwZWN0ZWQgewogICAgICAgIHJldHVybiBFcnIoU3RhZ2VFcnJvcjo6RmF0YWwoCiAgICAgICAgICAgIFNlbmRlclJlY292ZXJ5U3RhZ2VFcnJvcjo6UmVjb3ZlcmVkU2VuZGVyc01pc21hdGNoKEdvdEV4cGVjdGVkIHsKICAgICAgICAgICAgICAgIGdvdDogcHJvY2Vzc2VkX3RyYW5zYWN0aW9ucywKICAgICAgICAgICAgICAgIGV4cGVjdGVkLAogICAgICAgICAgICB9KQogICAgICAgICAgICAuaW50bygpLAogICAgICAgICkpOwogICAgfQogICAgT2soKCkpCn0KCi8vLyBTcGF3bnMgYSB0aHJlYWQgdG8gaGFuZGxlIHRoZSByZWNvdmVyeSBvZiB0cmFuc2FjdGlvbiBzZW5kZXJzIGZvcgovLy8gc3BlY2lmaWVkIGNodW5rcyBvZiBhIGdpdmVuIGJhdGNoLiBJdCBwcm9jZXNzZXMgaW5jb21pbmcgcmFuZ2VzLCBmZXRjaGluZyBhbmQgcmVjb3ZlcmluZwovLy8gdHJhbnNhY3Rpb25zIGluIHBhcmFsbGVsIHVzaW5nIGdsb2JhbCByYXlvbiBwb29sCmZuIHNldHVwX3JhbmdlX3JlY292ZXJ5PFByb3ZpZGVyPigKICAgIHByb3ZpZGVyOiAmUHJvdmlkZXIsCikgLT4gbXBzYzo6U2VuZGVyPFZlYzwoUmFuZ2U8dTY0PiwgUmVjb3ZlcnlSZXN1bHRTZW5kZXIpPj4Kd2hlcmUKICAgIFByb3ZpZGVyOiBEQlByb3ZpZGVyCiAgICAgICAgKyBIZWFkZXJQcm92aWRlcgogICAgICAgICsgU3RhdGljRmlsZVByb3ZpZGVyRmFjdG9yeTxQcmltaXRpdmVzOiBOb2RlUHJpbWl0aXZlczxTaWduZWRUeDogVmFsdWUgKyBTaWduZWRUcmFuc2FjdGlvbj4+LAp7CiAgICBsZXQgKHR4X3NlbmRlciwgdHhfcmVjZWl2ZXIpID0gbXBzYzo6Y2hhbm5lbDo6PFZlYzwoUmFuZ2U8dTY0PiwgUmVjb3ZlcnlSZXN1bHRTZW5kZXIpPj4oKTsKICAgIGxldCBzdGF0aWNfZmlsZV9wcm92aWRlciA9IHByb3ZpZGVyLnN0YXRpY19maWxlX3Byb3ZpZGVyKCk7CgogICAgLy8gV2UgZG8gbm90IHVzZSBgdG9raW86OnRhc2s6OnNwYXduX2Jsb2NraW5nYCBiZWNhdXNlLCBkdXJpbmcgYSBzaHV0ZG93biwKICAgIC8vIHRoZXJlIHdpbGwgYmUgYSB0aW1lb3V0IGdyYWNlIHBlcmlvZCBpbiB3aGljaCBUb2tpbyBkb2VzIG5vdCBhbGxvdyBzcGF3bmluZwogICAgLy8gYWRkaXRpb25hbCBibG9ja2luZyB0YXNrcy4gVGhpcyB3b3VsZCBjYXVzZSB0aGlzIGZ1bmN0aW9uIHRvIHJldHVybgogICAgLy8gYFNlbmRlclJlY292ZXJ5U3RhZ2VFcnJvcjo6UmVjb3ZlcmVkU2VuZGVyc01pc21hdGNoYCBhdCB0aGUgZW5kLgogICAgLy8KICAgIC8vIEhvd2V2ZXIsIHVzaW5nIGBzdGQ6OnRocmVhZDo6c3Bhd25gIGFsbG93cyB1cyB0byB1dGlsaXplIHRoZSB0aW1lb3V0IGdyYWNlCiAgICAvLyBwZXJpb2QgdG8gY29tcGxldGUgc29tZSB3b3JrIHdpdGhvdXQgdGhyb3dpbmcgZXJyb3JzIGR1cmluZyB0aGUgc2h1dGRvd24uCiAgICBzdGQ6OnRocmVhZDo6c3Bhd24obW92ZSB8fCB7CiAgICAgICAgd2hpbGUgbGV0IE9rKGNodW5rcykgPSB0eF9yZWNlaXZlci5yZWN2KCkgewogICAgICAgICAgICBmb3IgKGNodW5rX3JhbmdlLCByZWNvdmVyZWRfc2VuZGVyc190eCkgaW4gY2h1bmtzIHsKICAgICAgICAgICAgICAgIC8vIFJlYWQgdGhlIHJhdyB2YWx1ZSwgYW5kIGxldCB0aGUgcmF5b24gd29ya2VyIHRvIGRlY29tcHJlc3MgJiBkZWNvZGUuCiAgICAgICAgICAgICAgICBsZXQgY2h1bmsgPSBtYXRjaCBzdGF0aWNfZmlsZV9wcm92aWRlci5mZXRjaF9yYW5nZV93aXRoX3ByZWRpY2F0ZSgKICAgICAgICAgICAgICAgICAgICBTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25zLAogICAgICAgICAgICAgICAgICAgIGNodW5rX3JhbmdlLmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgfGN1cnNvciwgbnVtYmVyfCB7CiAgICAgICAgICAgICAgICAgICAgICAgIE9rKGN1cnNvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldF9vbmU6OjxUcmFuc2FjdGlvbk1hc2s8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUmF3VmFsdWU8PFByb3ZpZGVyOjpQcmltaXRpdmVzIGFzIE5vZGVQcmltaXRpdmVzPjo6U2lnbmVkVHg+LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgPj4obnVtYmVyLmludG8oKSk/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKHx0eHwgKG51bWJlciwgdHgpKSkKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHxffCB0cnVlLAogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgT2soY2h1bmspID0+IGNodW5rLAogICAgICAgICAgICAgICAgICAgIEVycihlcnIpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgZXhpdCBlYXJseSBzaW5jZSB3ZSBjb3VsZCBub3QgcHJvY2VzcyB0aGlzIGNodW5rLgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgXyA9IHJlY292ZXJlZF9zZW5kZXJzX3R4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2VuZChFcnIoQm94OjpuZXcoU2VuZGVyUmVjb3ZlcnlTdGFnZUVycm9yOjpTdGFnZUVycm9yKGVyci5pbnRvKCkpKSkpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gU3Bhd24gdGhlIHRhc2sgb250byB0aGUgZ2xvYmFsIHJheW9uIHBvb2wKICAgICAgICAgICAgICAgIC8vIFRoaXMgdGFzayB3aWxsIHNlbmQgdGhlIHJlc3VsdHMgdGhyb3VnaCB0aGUgY2hhbm5lbCBhZnRlciBpdCBoYXMgcmVhZCB0aGUKICAgICAgICAgICAgICAgIC8vIHRyYW5zYWN0aW9uIGFuZCBjYWxjdWxhdGVkIHRoZSBzZW5kZXIuCiAgICAgICAgICAgICAgICByYXlvbjo6c3Bhd24obW92ZSB8fCB7CiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBybHBfYnVmID0gVmVjOjp3aXRoX2NhcGFjaXR5KDEyOCk7CiAgICAgICAgICAgICAgICAgICAgZm9yIChudW1iZXIsIHR4KSBpbiBjaHVuayB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXMgPSB0eAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnZhbHVlKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKHxlcnJ8IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBCb3g6Om5ldyhTZW5kZXJSZWNvdmVyeVN0YWdlRXJyb3I6OlN0YWdlRXJyb3IoZXJyLmludG8oKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFuZF90aGVuKHx0eHwgcmVjb3Zlcl9zZW5kZXIoKG51bWJlciwgdHgpLCAmbXV0IHJscF9idWYpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpc19lcnIgPSByZXMuaXNfZXJyKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgXyA9IHJlY292ZXJlZF9zZW5kZXJzX3R4LnNlbmQocmVzKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpbmlzaCBlYXJseQogICAgICAgICAgICAgICAgICAgICAgICBpZiBpc19lcnIgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CiAgICB0eF9zZW5kZXIKfQoKI1tpbmxpbmVdCmZuIHJlY292ZXJfc2VuZGVyPFQ6IFNpZ25lZFRyYW5zYWN0aW9uPigKICAgICh0eF9pZCwgdHgpOiAoVHhOdW1iZXIsIFQpLAogICAgcmxwX2J1ZjogJm11dCBWZWM8dTg+LAopIC0+IFJlc3VsdDwodTY0LCBBZGRyZXNzKSwgQm94PFNlbmRlclJlY292ZXJ5U3RhZ2VFcnJvcj4+IHsKICAgIHJscF9idWYuY2xlYXIoKTsKICAgIC8vIFdlIGNhbGwgW1NpZ25hdHVyZTo6ZW5jb2RlX2FuZF9yZWNvdmVyX3VuY2hlY2tlZF0gYmVjYXVzZSB0cmFuc2FjdGlvbnMgcnVuIGluIHRoZSBwaXBlbGluZQogICAgLy8gYXJlIGtub3duIHRvIGJlIHZhbGlkIC0gdGhpcyBtZWFucyB0aGF0IHdlIGRvIG5vdCBuZWVkIHRvIGNoZWNrIHdoZXRoZXIgb3Igbm90IHRoZSBgc2AKICAgIC8vIHZhbHVlIGlzIGdyZWF0ZXIgdGhhbiBgc2VjcDI1NmsxbiAvIDJgIGlmIHBhc3QgRUlQLTIuIFRoZXJlIGFyZSB0cmFuc2FjdGlvbnMKICAgIC8vIHByZS1ob21lc3RlYWQgd2hpY2ggaGF2ZSBsYXJnZSBgc2AgdmFsdWVzLCBzbyB1c2luZyBbU2lnbmF0dXJlOjpyZWNvdmVyX3NpZ25lcl0gaGVyZQogICAgLy8gd291bGQgbm90IGJlIGJhY2t3YXJkcy1jb21wYXRpYmxlLgogICAgbGV0IHNlbmRlciA9IHR4LnJlY292ZXJfdW5jaGVja2VkX3dpdGhfYnVmKHJscF9idWYpLm1hcF9lcnIofF98IHsKICAgICAgICBTZW5kZXJSZWNvdmVyeVN0YWdlRXJyb3I6OkZhaWxlZFJlY292ZXJ5KEZhaWxlZFNlbmRlclJlY292ZXJ5RXJyb3IgeyB0eDogdHhfaWQgfSkKICAgIH0pPzsKCiAgICBPaygodHhfaWQsIHNlbmRlcikpCn0KCmZuIHN0YWdlX2NoZWNrcG9pbnQ8UHJvdmlkZXI+KHByb3ZpZGVyOiAmUHJvdmlkZXIpIC0+IFJlc3VsdDxFbnRpdGllc0NoZWNrcG9pbnQsIFN0YWdlRXJyb3I+CndoZXJlCiAgICBQcm92aWRlcjogU3RhdHNSZWFkZXIgKyBTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5ICsgUHJ1bmVDaGVja3BvaW50UmVhZGVyLAp7CiAgICBsZXQgcHJ1bmVkX2VudHJpZXMgPSBwcm92aWRlcgogICAgICAgIC5nZXRfcHJ1bmVfY2hlY2twb2ludChQcnVuZVNlZ21lbnQ6OlNlbmRlclJlY292ZXJ5KT8KICAgICAgICAuYW5kX3RoZW4ofGNoZWNrcG9pbnR8IGNoZWNrcG9pbnQudHhfbnVtYmVyKQogICAgICAgIC51bndyYXBfb3JfZGVmYXVsdCgpOwogICAgT2soRW50aXRpZXNDaGVja3BvaW50IHsKICAgICAgICAvLyBJZiBgVHJhbnNhY3Rpb25TZW5kZXJzYCB0YWJsZSB3YXMgcHJ1bmVkLCB3ZSB3aWxsIGhhdmUgYSBudW1iZXIgb2YgZW50cmllcyBpbiBpdCBub3QKICAgICAgICAvLyBtYXRjaGluZyB0aGUgYWN0dWFsIG51bWJlciBvZiBwcm9jZXNzZWQgdHJhbnNhY3Rpb25zLiBUbyBmaXggdGhhdCwgd2UgYWRkIHRoZQogICAgICAgIC8vIG51bWJlciBvZiBwcnVuZWQgYFRyYW5zYWN0aW9uU2VuZGVyc2AgZW50cmllcy4KICAgICAgICBwcm9jZXNzZWQ6IHByb3ZpZGVyLmNvdW50X2VudHJpZXM6Ojx0YWJsZXM6OlRyYW5zYWN0aW9uU2VuZGVycz4oKT8gYXMgdTY0ICsgcHJ1bmVkX2VudHJpZXMsCiAgICAgICAgLy8gQ291bnQgb25seSBzdGF0aWMgZmlsZXMgZW50cmllcy4gSWYgd2UgY291bnQgdGhlIGRhdGFiYXNlIGVudHJpZXMgdG9vLCB3ZSBtYXkgaGF2ZQogICAgICAgIC8vIGR1cGxpY2F0ZXMuIFdlJ3JlIHN1cmUgdGhhdCB0aGUgc3RhdGljIGZpbGVzIGhhdmUgYWxsIGVudHJpZXMgdGhhdCBkYXRhYmFzZSBoYXMsCiAgICAgICAgLy8gYmVjYXVzZSB3ZSBydW4gdGhlIGBTdGF0aWNGaWxlUHJvZHVjZXJgIGJlZm9yZSBzdGFydGluZyB0aGUgcGlwZWxpbmUuCiAgICAgICAgdG90YWw6IHByb3ZpZGVyLnN0YXRpY19maWxlX3Byb3ZpZGVyKCkuY291bnRfZW50cmllczo6PHRhYmxlczo6VHJhbnNhY3Rpb25zPigpPyBhcyB1NjQsCiAgICB9KQp9CgojW2Rlcml2ZShFcnJvciwgRGVidWcpXQojW2Vycm9yKHRyYW5zcGFyZW50KV0KZW51bSBTZW5kZXJSZWNvdmVyeVN0YWdlRXJyb3IgewogICAgLy8vIEEgdHJhbnNhY3Rpb24gZmFpbGVkIHNlbmRlciByZWNvdmVyeQogICAgI1tlcnJvcih0cmFuc3BhcmVudCldCiAgICBGYWlsZWRSZWNvdmVyeSgjW2Zyb21dIEZhaWxlZFNlbmRlclJlY292ZXJ5RXJyb3IpLAoKICAgIC8vLyBOdW1iZXIgb2YgcmVjb3ZlcmVkIHNlbmRlcnMgZG9lcyBub3QgbWF0Y2gKICAgICNbZXJyb3IoIm1pc21hdGNoZWQgc2VuZGVyIGNvdW50IGR1cmluZyByZWNvdmVyeToge18wfSIpXQogICAgUmVjb3ZlcmVkU2VuZGVyc01pc21hdGNoKEdvdEV4cGVjdGVkPHU2ND4pLAoKICAgIC8vLyBBIGRpZmZlcmVudCB0eXBlIG9mIHN0YWdlIGVycm9yIG9jY3VycmVkCiAgICAjW2Vycm9yKHRyYW5zcGFyZW50KV0KICAgIFN0YWdlRXJyb3IoI1tmcm9tXSBTdGFnZUVycm9yKSwKfQoKI1tkZXJpdmUoRXJyb3IsIERlYnVnKV0KI1tlcnJvcigic2VuZGVyIHJlY292ZXJ5IGZhaWxlZCBmb3IgdHJhbnNhY3Rpb24ge3R4fSIpXQpzdHJ1Y3QgRmFpbGVkU2VuZGVyUmVjb3ZlcnlFcnJvciB7CiAgICAvLy8gVGhlIHRyYW5zYWN0aW9uIHRoYXQgZmFpbGVkIHNlbmRlciByZWNvdmVyeQogICAgdHg6IFR4TnVtYmVyLAp9CgojW2NmZyh0ZXN0KV0KbW9kIHRlc3RzIHsKICAgIHVzZSBzdXBlcjo6KjsKICAgIHVzZSBjcmF0ZTo6dGVzdF91dGlsczo6ewogICAgICAgIHN0YWdlX3Rlc3Rfc3VpdGVfZXh0LCBFeGVjdXRlU3RhZ2VUZXN0UnVubmVyLCBTdGFnZVRlc3RSdW5uZXIsIFN0b3JhZ2VLaW5kLAogICAgICAgIFRlc3RSdW5uZXJFcnJvciwgVGVzdFN0YWdlREIsIFVud2luZFN0YWdlVGVzdFJ1bm5lciwKICAgIH07CiAgICB1c2UgYWxsb3lfcHJpbWl0aXZlczo6e0Jsb2NrTnVtYmVyLCBCMjU2fTsKICAgIHVzZSBhc3NlcnRfbWF0Y2hlczo6YXNzZXJ0X21hdGNoZXM7CiAgICB1c2UgcmV0aF9kYl9hcGk6OntjdXJzb3I6OkRiQ3Vyc29yUk8sIG1vZGVsczo6U3RvcmFnZVNldHRpbmdzfTsKICAgIHVzZSByZXRoX2V0aGVyZXVtX3ByaW1pdGl2ZXM6OntCbG9jaywgVHJhbnNhY3Rpb25TaWduZWR9OwogICAgdXNlIHJldGhfcHJpbWl0aXZlc190cmFpdHM6OntTZWFsZWRCbG9jaywgU2lnbmVyUmVjb3ZlcmFibGV9OwogICAgdXNlIHJldGhfcHJvdmlkZXI6OnsKICAgICAgICBwcm92aWRlcnM6OlN0YXRpY0ZpbGVXcml0ZXIsIEJsb2NrQm9keUluZGljZXNQcm92aWRlciwgRGF0YWJhc2VQcm92aWRlckZhY3RvcnksCiAgICAgICAgUHJ1bmVDaGVja3BvaW50V3JpdGVyLCBTdGF0aWNGaWxlUHJvdmlkZXJGYWN0b3J5LCBUcmFuc2FjdGlvbnNQcm92aWRlciwKICAgIH07CiAgICB1c2UgcmV0aF9wcnVuZV90eXBlczo6e1BydW5lQ2hlY2twb2ludCwgUHJ1bmVNb2RlfTsKICAgIHVzZSByZXRoX3N0YWdlc19hcGk6OlN0YWdlVW5pdENoZWNrcG9pbnQ7CiAgICB1c2UgcmV0aF9zdGF0aWNfZmlsZV90eXBlczo6U3RhdGljRmlsZVNlZ21lbnQ7CiAgICB1c2UgcmV0aF90ZXN0aW5nX3V0aWxzOjpnZW5lcmF0b3JzOjp7CiAgICAgICAgc2VsZiwgcmFuZG9tX2Jsb2NrLCByYW5kb21fYmxvY2tfcmFuZ2UsIEJsb2NrUGFyYW1zLCBCbG9ja1JhbmdlUGFyYW1zLAogICAgfTsKCiAgICBzdGFnZV90ZXN0X3N1aXRlX2V4dCEoU2VuZGVyUmVjb3ZlcnlUZXN0UnVubmVyLCBzZW5kZXJfcmVjb3ZlcnkpOwoKICAgIC8vLyBFeGVjdXRlIGEgYmxvY2sgcmFuZ2Ugd2l0aCBhIHNpbmdsZSB0cmFuc2FjdGlvbgogICAgI1t0b2tpbzo6dGVzdF0KICAgIGFzeW5jIGZuIGV4ZWN1dGVfc2luZ2xlX3RyYW5zYWN0aW9uKCkgewogICAgICAgIGxldCAocHJldmlvdXNfc3RhZ2UsIHN0YWdlX3Byb2dyZXNzKSA9ICg1MDAsIDEwMCk7CiAgICAgICAgbGV0IG11dCBybmcgPSBnZW5lcmF0b3JzOjpybmcoKTsKCiAgICAgICAgLy8gU2V0IHVwIHRoZSBydW5uZXIKICAgICAgICBsZXQgcnVubmVyID0gU2VuZGVyUmVjb3ZlcnlUZXN0UnVubmVyOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IGlucHV0ID0gRXhlY0lucHV0IHsKICAgICAgICAgICAgdGFyZ2V0OiBTb21lKHByZXZpb3VzX3N0YWdlKSwKICAgICAgICAgICAgY2hlY2twb2ludDogU29tZShTdGFnZUNoZWNrcG9pbnQ6Om5ldyhzdGFnZV9wcm9ncmVzcykpLAogICAgICAgIH07CgogICAgICAgIC8vIEluc2VydCBibG9ja3Mgd2l0aCBhIHNpbmdsZSB0cmFuc2FjdGlvbiBhdCBibG9jayBgc3RhZ2VfcHJvZ3Jlc3MgKyAxMGAKICAgICAgICBsZXQgbm9uX2VtcHR5X2Jsb2NrX251bWJlciA9IHN0YWdlX3Byb2dyZXNzICsgMTA7CiAgICAgICAgbGV0IGJsb2NrcyA9IChzdGFnZV9wcm9ncmVzcy4uPWlucHV0LnRhcmdldCgpKQogICAgICAgICAgICAubWFwKHxudW1iZXJ8IHsKICAgICAgICAgICAgICAgIHJhbmRvbV9ibG9jaygKICAgICAgICAgICAgICAgICAgICAmbXV0IHJuZywKICAgICAgICAgICAgICAgICAgICBudW1iZXIsCiAgICAgICAgICAgICAgICAgICAgQmxvY2tQYXJhbXMgewogICAgICAgICAgICAgICAgICAgICAgICB0eF9jb3VudDogU29tZSgobnVtYmVyID09IG5vbl9lbXB0eV9ibG9ja19udW1iZXIpIGFzIHU4KSwKICAgICAgICAgICAgICAgICAgICAgICAgLi5EZWZhdWx0OjpkZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KQogICAgICAgICAgICAuY29sbGVjdDo6PFZlYzxfPj4oKTsKICAgICAgICBydW5uZXIKICAgICAgICAgICAgLmRiCiAgICAgICAgICAgIC5pbnNlcnRfYmxvY2tzKGJsb2Nrcy5pdGVyKCksIFN0b3JhZ2VLaW5kOjpTdGF0aWMpCiAgICAgICAgICAgIC5leHBlY3QoImZhaWxlZCB0byBpbnNlcnQgYmxvY2tzIik7CgogICAgICAgIGxldCByeCA9IHJ1bm5lci5leGVjdXRlKGlucHV0KTsKCiAgICAgICAgLy8gQXNzZXJ0IHRoZSBzdWNjZXNzZnVsIHJlc3VsdAogICAgICAgIGxldCByZXN1bHQgPSByeC5hd2FpdC51bndyYXAoKTsKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEoCiAgICAgICAgICAgIHJlc3VsdCwKICAgICAgICAgICAgT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQ6IFN0YWdlQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICBibG9ja19udW1iZXIsCiAgICAgICAgICAgICAgICBzdGFnZV9jaGVja3BvaW50OiBTb21lKFN0YWdlVW5pdENoZWNrcG9pbnQ6OkVudGl0aWVzKEVudGl0aWVzQ2hlY2twb2ludCB7CiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkOiAxLAogICAgICAgICAgICAgICAgICAgIHRvdGFsOiAxCiAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgfSwgZG9uZTogdHJ1ZSB9KSBpZiBibG9ja19udW1iZXIgPT0gcHJldmlvdXNfc3RhZ2UKICAgICAgICApOwoKICAgICAgICAvLyBWYWxpZGF0ZSB0aGUgc3RhZ2UgZXhlY3V0aW9uCiAgICAgICAgYXNzZXJ0IShydW5uZXIudmFsaWRhdGVfZXhlY3V0aW9uKGlucHV0LCByZXN1bHQub2soKSkuaXNfb2soKSwgImV4ZWN1dGlvbiB2YWxpZGF0aW9uIik7CiAgICB9CgogICAgLy8vIEVuc3VyZSB0aGUgc3RhdGljIGZpbGUgaGVhZGVyIGFkdmFuY2VzIHRvIHRyYWlsaW5nIGVtcHR5IGJsb2Nrcy4KICAgICNbdG9raW86OnRlc3RdCiAgICBhc3luYyBmbiBleGVjdXRlX2FkdmFuY2VzX3N0YXRpY19maWxlX2Zvcl90cmFpbGluZ19lbXB0eV9ibG9ja3MoKSB7CiAgICAgICAgbGV0IChzdGFnZV9wcm9ncmVzcywgdGFyZ2V0KSA9ICgwLCAzKTsKICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwoKICAgICAgICBsZXQgcnVubmVyID0gU2VuZGVyUmVjb3ZlcnlUZXN0UnVubmVyOjpkZWZhdWx0KCk7CiAgICAgICAgcnVubmVyLmRiLmZhY3Rvcnkuc2V0X3N0b3JhZ2Vfc2V0dGluZ3NfY2FjaGUoCiAgICAgICAgICAgIFN0b3JhZ2VTZXR0aW5nczo6bGVnYWN5KCkud2l0aF90cmFuc2FjdGlvbl9zZW5kZXJzX2luX3N0YXRpY19maWxlcyh0cnVlKSwKICAgICAgICApOwogICAgICAgIGxldCBpbnB1dCA9IEV4ZWNJbnB1dCB7CiAgICAgICAgICAgIHRhcmdldDogU29tZSh0YXJnZXQpLAogICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KHN0YWdlX3Byb2dyZXNzKSksCiAgICAgICAgfTsKCiAgICAgICAgbGV0IG5vbl9lbXB0eV9ibG9ja19udW1iZXIgPSBzdGFnZV9wcm9ncmVzcyArIDE7CiAgICAgICAgbGV0IGJsb2NrcyA9IChzdGFnZV9wcm9ncmVzcy4uPWlucHV0LnRhcmdldCgpKQogICAgICAgICAgICAubWFwKHxudW1iZXJ8IHsKICAgICAgICAgICAgICAgIHJhbmRvbV9ibG9jaygKICAgICAgICAgICAgICAgICAgICAmbXV0IHJuZywKICAgICAgICAgICAgICAgICAgICBudW1iZXIsCiAgICAgICAgICAgICAgICAgICAgQmxvY2tQYXJhbXMgewogICAgICAgICAgICAgICAgICAgICAgICB0eF9jb3VudDogU29tZSgobnVtYmVyID09IG5vbl9lbXB0eV9ibG9ja19udW1iZXIpIGFzIHU4KSwKICAgICAgICAgICAgICAgICAgICAgICAgLi5EZWZhdWx0OjpkZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KQogICAgICAgICAgICAuY29sbGVjdDo6PFZlYzxfPj4oKTsKICAgICAgICBydW5uZXIKICAgICAgICAgICAgLmRiCiAgICAgICAgICAgIC5pbnNlcnRfYmxvY2tzKGJsb2Nrcy5pdGVyKCksIFN0b3JhZ2VLaW5kOjpTdGF0aWMpCiAgICAgICAgICAgIC5leHBlY3QoImZhaWxlZCB0byBpbnNlcnQgYmxvY2tzIik7CgogICAgICAgIGxldCByZXN1bHQgPSBydW5uZXIuZXhlY3V0ZShpbnB1dCkuYXdhaXQudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X21hdGNoZXMhKHJlc3VsdCwgT2soRXhlY091dHB1dCB7IGNoZWNrcG9pbnQsIGRvbmU6IHRydWUgfSkgaWYgY2hlY2twb2ludC5ibG9ja19udW1iZXIgPT0gdGFyZ2V0KTsKCiAgICAgICAgbGV0IGhpZ2hlc3RfYmxvY2sgPSBydW5uZXIKICAgICAgICAgICAgLmRiCiAgICAgICAgICAgIC5mYWN0b3J5CiAgICAgICAgICAgIC5zdGF0aWNfZmlsZV9wcm92aWRlcigpCiAgICAgICAgICAgIC5nZXRfaGlnaGVzdF9zdGF0aWNfZmlsZV9ibG9jayhTdGF0aWNGaWxlU2VnbWVudDo6VHJhbnNhY3Rpb25TZW5kZXJzKTsKICAgICAgICBhc3NlcnRfZXEhKFNvbWUodGFyZ2V0KSwgaGlnaGVzdF9ibG9jayk7CiAgICB9CgogICAgLy8vIEV4ZWN1dGUgdGhlIHN0YWdlIHR3aWNlIHdpdGggaW5wdXQgcmFuZ2UgdGhhdCBleGNlZWRzIHRoZSBjb21taXQgdGhyZXNob2xkCiAgICAjW3Rva2lvOjp0ZXN0XQogICAgYXN5bmMgZm4gZXhlY3V0ZV9pbnRlcm1lZGlhdGVfY29tbWl0KCkgewogICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CgogICAgICAgIGxldCB0aHJlc2hvbGQgPSAxMDsKICAgICAgICBsZXQgbXV0IHJ1bm5lciA9IFNlbmRlclJlY292ZXJ5VGVzdFJ1bm5lcjo6ZGVmYXVsdCgpOwogICAgICAgIHJ1bm5lci5zZXRfdGhyZXNob2xkKHRocmVzaG9sZCk7CiAgICAgICAgbGV0IChzdGFnZV9wcm9ncmVzcywgcHJldmlvdXNfc3RhZ2UpID0gKDEwMDAsIDExMDApOyAvLyBpbnB1dCBleGNlZWRzIHRocmVzaG9sZAoKICAgICAgICAvLyBNYW51YWxseSBzZWVkIG9uY2Ugd2l0aCBmdWxsIGlucHV0IHJhbmdlCiAgICAgICAgbGV0IHNlZWQgPSByYW5kb21fYmxvY2tfcmFuZ2UoCiAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICBzdGFnZV9wcm9ncmVzcyArIDEuLj1wcmV2aW91c19zdGFnZSwKICAgICAgICAgICAgQmxvY2tSYW5nZVBhcmFtcyB7IHBhcmVudDogU29tZShCMjU2OjpaRVJPKSwgdHhfY291bnQ6IDAuLjQsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgKTsgLy8gc2V0IHR4IGNvdW50IHJhbmdlIGhpZ2ggZW5vdWdoIHRvIGhpdCB0aGUgdGhyZXNob2xkCiAgICAgICAgcnVubmVyCiAgICAgICAgICAgIC5kYgogICAgICAgICAgICAuaW5zZXJ0X2Jsb2NrcyhzZWVkLml0ZXIoKSwgU3RvcmFnZUtpbmQ6OlN0YXRpYykKICAgICAgICAgICAgLmV4cGVjdCgiZmFpbGVkIHRvIHNlZWQgZXhlY3V0aW9uIik7CgogICAgICAgIGxldCB0b3RhbF90cmFuc2FjdGlvbnMgPSBydW5uZXIKICAgICAgICAgICAgLmRiCiAgICAgICAgICAgIC5mYWN0b3J5CiAgICAgICAgICAgIC5zdGF0aWNfZmlsZV9wcm92aWRlcigpCiAgICAgICAgICAgIC5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpUcmFuc2FjdGlvbnM+KCkKICAgICAgICAgICAgLnVud3JhcCgpIGFzIHU2NDsKCiAgICAgICAgbGV0IGZpcnN0X2lucHV0ID0gRXhlY0lucHV0IHsKICAgICAgICAgICAgdGFyZ2V0OiBTb21lKHByZXZpb3VzX3N0YWdlKSwKICAgICAgICAgICAgY2hlY2twb2ludDogU29tZShTdGFnZUNoZWNrcG9pbnQ6Om5ldyhzdGFnZV9wcm9ncmVzcykpLAogICAgICAgIH07CgogICAgICAgIC8vIEV4ZWN1dGUgZmlyc3QgdGltZQogICAgICAgIGxldCByZXN1bHQgPSBydW5uZXIuZXhlY3V0ZShmaXJzdF9pbnB1dCkuYXdhaXQudW53cmFwKCk7CiAgICAgICAgbGV0IG11dCB0eF9jb3VudCA9IDA7CiAgICAgICAgbGV0IGV4cGVjdGVkX3Byb2dyZXNzID0gc2VlZAogICAgICAgICAgICAuaXRlcigpCiAgICAgICAgICAgIC5maW5kKHx4fCB7CiAgICAgICAgICAgICAgICB0eF9jb3VudCArPSB4LnRyYW5zYWN0aW9uX2NvdW50KCk7CiAgICAgICAgICAgICAgICB0eF9jb3VudCBhcyB1NjQgPiB0aHJlc2hvbGQKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLm1hcCh8eHwgeC5udW1iZXIpCiAgICAgICAgICAgIC51bndyYXBfb3IocHJldmlvdXNfc3RhZ2UpOwogICAgICAgIGFzc2VydF9tYXRjaGVzIShyZXN1bHQsIE9rKF8pKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICByZXN1bHQudW53cmFwKCksCiAgICAgICAgICAgIEV4ZWNPdXRwdXQgewogICAgICAgICAgICAgICAgY2hlY2twb2ludDogU3RhZ2VDaGVja3BvaW50OjpuZXcoZXhwZWN0ZWRfcHJvZ3Jlc3MpLndpdGhfZW50aXRpZXNfc3RhZ2VfY2hlY2twb2ludCgKICAgICAgICAgICAgICAgICAgICBFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWQ6IHJ1bm5lci5kYi5jb3VudF9lbnRyaWVzOjo8dGFibGVzOjpUcmFuc2FjdGlvblNlbmRlcnM+KCkudW53cmFwKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzIHU2NCwKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IHRvdGFsX3RyYW5zYWN0aW9ucwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBkb25lOiBmYWxzZQogICAgICAgICAgICB9CiAgICAgICAgKTsKCiAgICAgICAgLy8gRXhlY3V0ZSBzZWNvbmQgdGltZSB0byBjb21wbGV0aW9uCiAgICAgICAgcnVubmVyLnNldF90aHJlc2hvbGQodTY0OjpNQVgpOwogICAgICAgIGxldCBzZWNvbmRfaW5wdXQgPSBFeGVjSW5wdXQgewogICAgICAgICAgICB0YXJnZXQ6IFNvbWUocHJldmlvdXNfc3RhZ2UpLAogICAgICAgICAgICBjaGVja3BvaW50OiBTb21lKFN0YWdlQ2hlY2twb2ludDo6bmV3KGV4cGVjdGVkX3Byb2dyZXNzKSksCiAgICAgICAgfTsKICAgICAgICBsZXQgcmVzdWx0ID0gcnVubmVyLmV4ZWN1dGUoc2Vjb25kX2lucHV0KS5hd2FpdC51bndyYXAoKTsKICAgICAgICBhc3NlcnRfbWF0Y2hlcyEocmVzdWx0LCBPayhfKSk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgcmVzdWx0LmFzX3JlZigpLnVud3JhcCgpLAogICAgICAgICAgICAmRXhlY091dHB1dCB7CiAgICAgICAgICAgICAgICBjaGVja3BvaW50OiBTdGFnZUNoZWNrcG9pbnQ6Om5ldyhwcmV2aW91c19zdGFnZSkud2l0aF9lbnRpdGllc19zdGFnZV9jaGVja3BvaW50KAogICAgICAgICAgICAgICAgICAgIEVudGl0aWVzQ2hlY2twb2ludCB7IHByb2Nlc3NlZDogdG90YWxfdHJhbnNhY3Rpb25zLCB0b3RhbDogdG90YWxfdHJhbnNhY3Rpb25zIH0KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBkb25lOiB0cnVlCiAgICAgICAgICAgIH0KICAgICAgICApOwoKICAgICAgICBhc3NlcnQhKHJ1bm5lci52YWxpZGF0ZV9leGVjdXRpb24oZmlyc3RfaW5wdXQsIHJlc3VsdC5vaygpKS5pc19vaygpLCAidmFsaWRhdGlvbiBmYWlsZWQiKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiBzdGFnZV9jaGVja3BvaW50X3BydW5lZCgpIHsKICAgICAgICBsZXQgZGIgPSBUZXN0U3RhZ2VEQjo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBtdXQgcm5nID0gZ2VuZXJhdG9yczo6cm5nKCk7CgogICAgICAgIGxldCBibG9ja3MgPSByYW5kb21fYmxvY2tfcmFuZ2UoCiAgICAgICAgICAgICZtdXQgcm5nLAogICAgICAgICAgICAwLi49MTAwLAogICAgICAgICAgICBCbG9ja1JhbmdlUGFyYW1zIHsgcGFyZW50OiBTb21lKEIyNTY6OlpFUk8pLCB0eF9jb3VudDogMC4uMTAsIC4uRGVmYXVsdDo6ZGVmYXVsdCgpIH0sCiAgICAgICAgKTsKICAgICAgICBkYi5pbnNlcnRfYmxvY2tzKGJsb2Nrcy5pdGVyKCksIFN0b3JhZ2VLaW5kOjpTdGF0aWMpLmV4cGVjdCgiaW5zZXJ0IGJsb2NrcyIpOwoKICAgICAgICBsZXQgbWF4X3BydW5lZF9ibG9jayA9IDMwOwogICAgICAgIGxldCBtYXhfcHJvY2Vzc2VkX2Jsb2NrID0gNzA7CgogICAgICAgIGxldCBtdXQgdHhfc2VuZGVycyA9IFZlYzo6bmV3KCk7CiAgICAgICAgbGV0IG11dCB0eF9udW1iZXIgPSAwOwogICAgICAgIGZvciBibG9jayBpbiAmYmxvY2tzWy4uPW1heF9wcm9jZXNzZWRfYmxvY2tdIHsKICAgICAgICAgICAgZm9yIHRyYW5zYWN0aW9uIGluICZibG9jay5ib2R5KCkudHJhbnNhY3Rpb25zIHsKICAgICAgICAgICAgICAgIGlmIGJsb2NrLm51bWJlciA+IG1heF9wcnVuZWRfYmxvY2sgewogICAgICAgICAgICAgICAgICAgIHR4X3NlbmRlcnMKICAgICAgICAgICAgICAgICAgICAgICAgLnB1c2goKHR4X251bWJlciwgdHJhbnNhY3Rpb24ucmVjb3Zlcl9zaWduZXIoKS5leHBlY3QoInJlY292ZXIgc2lnbmVyIikpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHR4X251bWJlciArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRiLmluc2VydF90cmFuc2FjdGlvbl9zZW5kZXJzKHR4X3NlbmRlcnMpLmV4cGVjdCgiaW5zZXJ0IHR4IGhhc2ggbnVtYmVycyIpOwoKICAgICAgICBsZXQgcHJvdmlkZXIgPSBkYi5mYWN0b3J5LnByb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgcHJvdmlkZXIKICAgICAgICAgICAgLnNhdmVfcHJ1bmVfY2hlY2twb2ludCgKICAgICAgICAgICAgICAgIFBydW5lU2VnbWVudDo6U2VuZGVyUmVjb3ZlcnksCiAgICAgICAgICAgICAgICBQcnVuZUNoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgICAgIGJsb2NrX251bWJlcjogU29tZShtYXhfcHJ1bmVkX2Jsb2NrKSwKICAgICAgICAgICAgICAgICAgICB0eF9udW1iZXI6IFNvbWUoCiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2Nrc1suLj1tYXhfcHJ1bmVkX2Jsb2NrIGFzIHVzaXplXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLml0ZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCh8YmxvY2t8IGJsb2NrLnRyYW5zYWN0aW9uX2NvdW50KCkgYXMgdTY0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnN1bSgpLAogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgcHJ1bmVfbW9kZTogUHJ1bmVNb2RlOjpGdWxsLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgKQogICAgICAgICAgICAuZXhwZWN0KCJzYXZlIHN0YWdlIGNoZWNrcG9pbnQiKTsKICAgICAgICBwcm92aWRlci5jb21taXQoKS5leHBlY3QoImNvbW1pdCIpOwoKICAgICAgICBsZXQgcHJvdmlkZXIgPSBkYi5mYWN0b3J5LmRhdGFiYXNlX3Byb3ZpZGVyX3J3KCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgc3RhZ2VfY2hlY2twb2ludCgmcHJvdmlkZXIpLmV4cGVjdCgic3RhZ2UgY2hlY2twb2ludCIpLAogICAgICAgICAgICBFbnRpdGllc0NoZWNrcG9pbnQgewogICAgICAgICAgICAgICAgcHJvY2Vzc2VkOiBibG9ja3NbLi49bWF4X3Byb2Nlc3NlZF9ibG9ja10KICAgICAgICAgICAgICAgICAgICAuaXRlcigpCiAgICAgICAgICAgICAgICAgICAgLm1hcCh8YmxvY2t8IGJsb2NrLnRyYW5zYWN0aW9uX2NvdW50KCkgYXMgdTY0KQogICAgICAgICAgICAgICAgICAgIC5zdW0oKSwKICAgICAgICAgICAgICAgIHRvdGFsOiBibG9ja3MuaXRlcigpLm1hcCh8YmxvY2t8IGJsb2NrLnRyYW5zYWN0aW9uX2NvdW50KCkgYXMgdTY0KS5zdW0oKQogICAgICAgICAgICB9CiAgICAgICAgKTsKICAgIH0KCiAgICBzdHJ1Y3QgU2VuZGVyUmVjb3ZlcnlUZXN0UnVubmVyIHsKICAgICAgICBkYjogVGVzdFN0YWdlREIsCiAgICAgICAgdGhyZXNob2xkOiB1NjQsCiAgICB9CgogICAgaW1wbCBEZWZhdWx0IGZvciBTZW5kZXJSZWNvdmVyeVRlc3RSdW5uZXIgewogICAgICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICAgICAgU2VsZiB7IHRocmVzaG9sZDogMTAwMCwgZGI6IFRlc3RTdGFnZURCOjpkZWZhdWx0KCkgfQogICAgICAgIH0KICAgIH0KCiAgICBpbXBsIFNlbmRlclJlY292ZXJ5VGVzdFJ1bm5lciB7CiAgICAgICAgZm4gc2V0X3RocmVzaG9sZCgmbXV0IHNlbGYsIHRocmVzaG9sZDogdTY0KSB7CiAgICAgICAgICAgIHNlbGYudGhyZXNob2xkID0gdGhyZXNob2xkOwogICAgICAgIH0KCiAgICAgICAgLy8vICMgUGFuaWNzCiAgICAgICAgLy8vCiAgICAgICAgLy8vIDEuIElmIHRoZXJlIGFyZSBhbnkgZW50cmllcyBpbiB0aGUgW2B0YWJsZXM6OlRyYW5zYWN0aW9uU2VuZGVyc2BdIHRhYmxlIGFib3ZlIGEgZ2l2ZW4KICAgICAgICAvLy8gICAgYmxvY2sgbnVtYmVyLgogICAgICAgIC8vLyAyLiBJZiB0aGVyZSBpcyBubyByZXF1ZXN0ZWQgYmxvY2sgZW50cnkgaW4gdGhlIGJvZGllcyB0YWJsZSwgYnV0CiAgICAgICAgLy8vICAgIFtgdGFibGVzOjpUcmFuc2FjdGlvblNlbmRlcnNgXSBpcyBub3QgZW1wdHkuCiAgICAgICAgZm4gZW5zdXJlX25vX3NlbmRlcnNfYnlfYmxvY2soJnNlbGYsIGJsb2NrOiBCbG9ja051bWJlcikgLT4gUmVzdWx0PCgpLCBUZXN0UnVubmVyRXJyb3I+IHsKICAgICAgICAgICAgbGV0IGJvZHlfcmVzdWx0ID0gc2VsZgogICAgICAgICAgICAgICAgLmRiCiAgICAgICAgICAgICAgICAuZmFjdG9yeQogICAgICAgICAgICAgICAgLnByb3ZpZGVyX3J3KCk/CiAgICAgICAgICAgICAgICAuYmxvY2tfYm9keV9pbmRpY2VzKGJsb2NrKT8KICAgICAgICAgICAgICAgIC5va19vcihQcm92aWRlckVycm9yOjpCbG9ja0JvZHlJbmRpY2VzTm90Rm91bmQoYmxvY2spKTsKICAgICAgICAgICAgbWF0Y2ggYm9keV9yZXN1bHQgewogICAgICAgICAgICAgICAgT2soYm9keSkgPT4gc2VsZi5kYi5lbnN1cmVfbm9fZW50cnlfYWJvdmU6Ojx0YWJsZXM6OlRyYW5zYWN0aW9uU2VuZGVycywgXz4oCiAgICAgICAgICAgICAgICAgICAgYm9keS5sYXN0X3R4X251bSgpLAogICAgICAgICAgICAgICAgICAgIHxrZXl8IGtleSwKICAgICAgICAgICAgICAgICk/LAogICAgICAgICAgICAgICAgRXJyKF8pID0+IHsKICAgICAgICAgICAgICAgICAgICBhc3NlcnQhKHNlbGYuZGIudGFibGVfaXNfZW1wdHk6Ojx0YWJsZXM6OlRyYW5zYWN0aW9uU2VuZGVycz4oKT8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgT2soKCkpCiAgICAgICAgfQogICAgfQoKICAgIGltcGwgU3RhZ2VUZXN0UnVubmVyIGZvciBTZW5kZXJSZWNvdmVyeVRlc3RSdW5uZXIgewogICAgICAgIHR5cGUgUyA9IFNlbmRlclJlY292ZXJ5U3RhZ2U7CgogICAgICAgIGZuIGRiKCZzZWxmKSAtPiAmVGVzdFN0YWdlREIgewogICAgICAgICAgICAmc2VsZi5kYgogICAgICAgIH0KCiAgICAgICAgZm4gc3RhZ2UoJnNlbGYpIC0+IFNlbGY6OlMgewogICAgICAgICAgICBTZW5kZXJSZWNvdmVyeVN0YWdlIHsgY29tbWl0X3RocmVzaG9sZDogc2VsZi50aHJlc2hvbGQgfQogICAgICAgIH0KICAgIH0KCiAgICBpbXBsIEV4ZWN1dGVTdGFnZVRlc3RSdW5uZXIgZm9yIFNlbmRlclJlY292ZXJ5VGVzdFJ1bm5lciB7CiAgICAgICAgdHlwZSBTZWVkID0gVmVjPFNlYWxlZEJsb2NrPEJsb2NrPj47CgogICAgICAgIGZuIHNlZWRfZXhlY3V0aW9uKCZtdXQgc2VsZiwgaW5wdXQ6IEV4ZWNJbnB1dCkgLT4gUmVzdWx0PFNlbGY6OlNlZWQsIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICBsZXQgbXV0IHJuZyA9IGdlbmVyYXRvcnM6OnJuZygpOwogICAgICAgICAgICBsZXQgc3RhZ2VfcHJvZ3Jlc3MgPSBpbnB1dC5jaGVja3BvaW50KCkuYmxvY2tfbnVtYmVyOwogICAgICAgICAgICBsZXQgZW5kID0gaW5wdXQudGFyZ2V0KCk7CgogICAgICAgICAgICBsZXQgYmxvY2tzID0gcmFuZG9tX2Jsb2NrX3JhbmdlKAogICAgICAgICAgICAgICAgJm11dCBybmcsCiAgICAgICAgICAgICAgICBzdGFnZV9wcm9ncmVzcy4uPWVuZCwKICAgICAgICAgICAgICAgIEJsb2NrUmFuZ2VQYXJhbXMgeyBwYXJlbnQ6IFNvbWUoQjI1Njo6WkVSTyksIHR4X2NvdW50OiAwLi4yLCAuLkRlZmF1bHQ6OmRlZmF1bHQoKSB9LAogICAgICAgICAgICApOwogICAgICAgICAgICBzZWxmLmRiLmluc2VydF9ibG9ja3MoYmxvY2tzLml0ZXIoKSwgU3RvcmFnZUtpbmQ6OlN0YXRpYyk/OwogICAgICAgICAgICBPayhibG9ja3MpCiAgICAgICAgfQoKICAgICAgICBmbiB2YWxpZGF0ZV9leGVjdXRpb24oCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBpbnB1dDogRXhlY0lucHV0LAogICAgICAgICAgICBvdXRwdXQ6IE9wdGlvbjxFeGVjT3V0cHV0PiwKICAgICAgICApIC0+IFJlc3VsdDwoKSwgVGVzdFJ1bm5lckVycm9yPiB7CiAgICAgICAgICAgIG1hdGNoIG91dHB1dCB7CiAgICAgICAgICAgICAgICBTb21lKG91dHB1dCkgPT4gewogICAgICAgICAgICAgICAgICAgIGxldCBwcm92aWRlciA9IHNlbGYuZGIuZmFjdG9yeS5wcm92aWRlcigpPzsKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnRfYmxvY2sgPSBpbnB1dC5uZXh0X2Jsb2NrKCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IGVuZF9ibG9jayA9IG91dHB1dC5jaGVja3BvaW50LmJsb2NrX251bWJlcjsKCiAgICAgICAgICAgICAgICAgICAgaWYgc3RhcnRfYmxvY2sgPiBlbmRfYmxvY2sgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2soKCkpCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgbXV0IGJvZHlfY3Vyc29yID0KICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXIudHhfcmVmKCkuY3Vyc29yX3JlYWQ6Ojx0YWJsZXM6OkJsb2NrQm9keUluZGljZXM+KCk/OwogICAgICAgICAgICAgICAgICAgIGJvZHlfY3Vyc29yLnNlZWtfZXhhY3Qoc3RhcnRfYmxvY2spPzsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgbGV0IFNvbWUoKF8sIGJvZHkpKSA9IGJvZHlfY3Vyc29yLm5leHQoKT8gewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgdHhfaWQgaW4gYm9keS50eF9udW1fcmFuZ2UoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgdHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uU2lnbmVkID0gcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJhbnNhY3Rpb25fYnlfaWRfdW5oYXNoZWQodHhfaWQpPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5leHBlY3QoIm5vIHRyYW5zYWN0aW9uIGVudHJ5Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2lnbmVyID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbi5yZWNvdmVyX3NpZ25lcigpLmV4cGVjdCgiZmFpbGVkIHRvIHJlY292ZXIgc2lnbmVyIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnRfZXEhKFNvbWUoc2lnbmVyKSwgcHJvdmlkZXIudHJhbnNhY3Rpb25fc2VuZGVyKHR4X2lkKT8pCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBOb25lID0+IHNlbGYuZW5zdXJlX25vX3NlbmRlcnNfYnlfYmxvY2soaW5wdXQuY2hlY2twb2ludCgpLmJsb2NrX251bWJlcik/LAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgT2soKCkpCiAgICAgICAgfQogICAgfQoKICAgIGltcGwgVW53aW5kU3RhZ2VUZXN0UnVubmVyIGZvciBTZW5kZXJSZWNvdmVyeVRlc3RSdW5uZXIgewogICAgICAgIGZuIHZhbGlkYXRlX3Vud2luZCgmc2VsZiwgaW5wdXQ6IFVud2luZElucHV0KSAtPiBSZXN1bHQ8KCksIFRlc3RSdW5uZXJFcnJvcj4gewogICAgICAgICAgICBzZWxmLmVuc3VyZV9ub19zZW5kZXJzX2J5X2Jsb2NrKGlucHV0LnVud2luZF90bykKICAgICAgICB9CiAgICB9Cn0KPC9maWxlPgoKPGZpbGUgcGF0aD0iY3JhdGVzL2NoYWluLXN0YXRlL3NyYy9pbl9tZW1vcnkucnMiPgovLyEgVHlwZXMgZm9yIHRyYWNraW5nIHRoZSBjYW5vbmljYWwgY2hhaW4gc3RhdGUgaW4gbWVtb3J5LgoKdXNlIGNyYXRlOjp7CiAgICBDYW5vblN0YXRlTm90aWZpY2F0aW9uLCBDYW5vblN0YXRlTm90aWZpY2F0aW9uU2VuZGVyLCBDYW5vblN0YXRlTm90aWZpY2F0aW9ucywKICAgIENoYWluSW5mb1RyYWNrZXIsIENvbXB1dGVkVHJpZURhdGEsIERlZmVycmVkVHJpZURhdGEsIE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyLAp9Owp1c2UgYWxsb3lfY29uc2Vuc3VzOjp7dHJhbnNhY3Rpb246OlRyYW5zYWN0aW9uTWV0YSwgQmxvY2tIZWFkZXJ9Owp1c2UgYWxsb3lfZWlwczo6e0Jsb2NrSGFzaE9yTnVtYmVyLCBCbG9ja051bUhhc2h9Owp1c2UgYWxsb3lfcHJpbWl0aXZlczo6e21hcDo6SGFzaE1hcCwgQmxvY2tOdW1iZXIsIFR4SGFzaCwgQjI1Nn07CnVzZSBwYXJraW5nX2xvdDo6UndMb2NrOwp1c2UgcmV0aF9jaGFpbnNwZWM6OkNoYWluSW5mbzsKdXNlIHJldGhfZXRoZXJldW1fcHJpbWl0aXZlczo6RXRoUHJpbWl0aXZlczsKdXNlIHJldGhfZXhlY3V0aW9uX3R5cGVzOjp7Q2hhaW4sIEV4ZWN1dGlvbk91dGNvbWV9Owp1c2UgcmV0aF9tZXRyaWNzOjp7bWV0cmljczo6R2F1Z2UsIE1ldHJpY3N9Owp1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6ewogICAgQmxvY2tCb2R5IGFzIF8sIEluZGV4ZWRUeCwgTm9kZVByaW1pdGl2ZXMsIFJlY292ZXJlZEJsb2NrLCBTZWFsZWRCbG9jaywgU2VhbGVkSGVhZGVyLAogICAgU2lnbmVkVHJhbnNhY3Rpb24sCn07CnVzZSByZXRoX3N0b3JhZ2VfYXBpOjpTdGF0ZVByb3ZpZGVyQm94Owp1c2UgcmV0aF90cmllOjp7dXBkYXRlczo6VHJpZVVwZGF0ZXNTb3J0ZWQsIEhhc2hlZFBvc3RTdGF0ZVNvcnRlZCwgVHJpZUlucHV0U29ydGVkfTsKdXNlIHN0ZDo6e2NvbGxlY3Rpb25zOjpCVHJlZU1hcCwgb3BzOjpEZXJlZiwgc3luYzo6QXJjLCB0aW1lOjpJbnN0YW50fTsKdXNlIHRva2lvOjpzeW5jOjp7YnJvYWRjYXN0LCB3YXRjaH07CgovLy8gU2l6ZSBvZiB0aGUgYnJvYWRjYXN0IGNoYW5uZWwgdXNlZCB0byBub3RpZnkgY2Fub25pY2FsIHN0YXRlIGV2ZW50cy4KY29uc3QgQ0FOT05fU1RBVEVfTk9USUZJQ0FUSU9OX0NIQU5ORUxfU0laRTogdXNpemUgPSAyNTY7CgovLy8gTWV0cmljcyBmb3IgdGhlIGluLW1lbW9yeSBzdGF0ZS4KI1tkZXJpdmUoTWV0cmljcyldCiNbbWV0cmljcyhzY29wZSA9ICJibG9ja2NoYWluX3RyZWUuaW5fbWVtX3N0YXRlIildCnB1YihjcmF0ZSkgc3RydWN0IEluTWVtb3J5U3RhdGVNZXRyaWNzIHsKICAgIC8vLyBUaGUgYmxvY2sgbnVtYmVyIG9mIHRoZSBlYXJsaWVzdCBibG9jayBpbiB0aGUgaW4tbWVtb3J5IHN0YXRlLgogICAgcHViKGNyYXRlKSBlYXJsaWVzdF9ibG9jazogR2F1Z2UsCiAgICAvLy8gVGhlIGJsb2NrIG51bWJlciBvZiB0aGUgbGF0ZXN0IGJsb2NrIGluIHRoZSBpbi1tZW1vcnkgc3RhdGUuCiAgICBwdWIoY3JhdGUpIGxhdGVzdF9ibG9jazogR2F1Z2UsCiAgICAvLy8gVGhlIG51bWJlciBvZiBibG9ja3MgaW4gdGhlIGluLW1lbW9yeSBzdGF0ZS4KICAgIHB1YihjcmF0ZSkgbnVtX2Jsb2NrczogR2F1Z2UsCn0KCi8vLyBDb250YWluZXIgdHlwZSBmb3IgaW4gbWVtb3J5IHN0YXRlIGRhdGEgb2YgdGhlIGNhbm9uaWNhbCBjaGFpbi4KLy8vCi8vLyBUaGlzIHRyYWNrcyBibG9ja3MgYW5kIHRoZWlyIHN0YXRlIHRoYXQgaGF2ZW4ndCBiZWVuIHBlcnNpc3RlZCB0byBkaXNrIHlldCBidXQgYXJlIHBhcnQgb2YgdGhlCi8vLyBjYW5vbmljYWwgY2hhaW4gdGhhdCBjYW4gYmUgdHJhY2VkIGJhY2sgdG8gYSBjYW5vbmljYWwgYmxvY2sgb24gZGlzay4KLy8vCi8vLyAjIExvY2tpbmcgYmVoYXZpb3Igb24gc3RhdGUgdXBkYXRlcwovLy8KLy8vIEFsbCB1cGRhdGUgY2FsbHMgbXVzdCBhY3F1aXJlIGFsbCBsb2NrcyBhdCBvbmNlIGJlZm9yZSBtb2RpZnlpbmcgc3RhdGUgdG8gZW5zdXJlIHRoZSBpbnRlcm5hbAovLy8gc3RhdGUgcmVtYWlucyBjb25zaXN0ZW50LiBUaGlzIHByZXZlbnRzIHJlYWRlcnMgZnJvbSBvYnNlcnZpbmcgcGFydGlhbGx5IHVwZGF0ZWQgc3RhdGUgd2hlcmUKLy8vIHRoZSBudW1iZXJzIGFuZCBibG9ja3MgbWFwcyBhcmUgb3V0IG9mIHN5bmMuCi8vLyBVcGRhdGUgZnVuY3Rpb25zIGVuc3VyZSB0aGF0IHRoZSBudW1iZXJzIHdyaXRlIGxvY2sgaXMgYWx3YXlzIGFjcXVpcmVkIGZpcnN0LCBiZWNhdXNlIGxvb2t1cCBieQovLy8gbnVtYmVycyBmaXJzdCByZWFkIHRoZSBudW1iZXJzIG1hcCBhbmQgdGhlbiB0aGUgYmxvY2tzIG1hcC4KLy8vIEJ5IGFjcXVpcmluZyB0aGUgbnVtYmVycyBsb2NrIGZpcnN0LCB3ZSBlbnN1cmUgdGhhdCByZWFkLW9ubHkgbG9va3VwcyBkb24ndCBkZWFkbG9jayB1cGRhdGVzLgovLy8gVGhpcyBob2xkcywgYmVjYXVzZSBvbmx5IGxvb2t1cCBieSBudW1iZXIgZnVuY3Rpb25zIG5lZWQgdG8gYWNxdWlyZSB0aGUgbnVtYmVycyBsb2NrIGZpcnN0IHRvCi8vLyBnZXQgdGhlIGJsb2NrIGhhc2guCiNbZGVyaXZlKERlYnVnLCBEZWZhdWx0KV0KcHViKGNyYXRlKSBzdHJ1Y3QgSW5NZW1vcnlTdGF0ZTxOOiBOb2RlUHJpbWl0aXZlcyA9IEV0aFByaW1pdGl2ZXM+IHsKICAgIC8vLyBBbGwgY2Fub25pY2FsIGJsb2NrcyB0aGF0IGFyZSBub3Qgb24gZGlzayB5ZXQuCiAgICBibG9ja3M6IFJ3TG9jazxIYXNoTWFwPEIyNTYsIEFyYzxCbG9ja1N0YXRlPE4+Pj4+LAogICAgLy8vIE1hcHBpbmcgb2YgYmxvY2sgbnVtYmVycyB0byBibG9jayBoYXNoZXMuCiAgICBudW1iZXJzOiBSd0xvY2s8QlRyZWVNYXA8dTY0LCBCMjU2Pj4sCiAgICAvLy8gVGhlIHBlbmRpbmcgYmxvY2sgdGhhdCBoYXMgbm90IHlldCBiZWVuIG1hZGUgY2Fub25pY2FsLgogICAgcGVuZGluZzogd2F0Y2g6OlNlbmRlcjxPcHRpb248QmxvY2tTdGF0ZTxOPj4+LAogICAgLy8vIE1ldHJpY3MgZm9yIHRoZSBpbi1tZW1vcnkgc3RhdGUuCiAgICBtZXRyaWNzOiBJbk1lbW9yeVN0YXRlTWV0cmljcywKfQoKaW1wbDxOOiBOb2RlUHJpbWl0aXZlcz4gSW5NZW1vcnlTdGF0ZTxOPiB7CiAgICBwdWIoY3JhdGUpIGZuIG5ldygKICAgICAgICBibG9ja3M6IEhhc2hNYXA8QjI1NiwgQXJjPEJsb2NrU3RhdGU8Tj4+PiwKICAgICAgICBudW1iZXJzOiBCVHJlZU1hcDx1NjQsIEIyNTY+LAogICAgICAgIHBlbmRpbmc6IE9wdGlvbjxCbG9ja1N0YXRlPE4+PiwKICAgICkgLT4gU2VsZiB7CiAgICAgICAgbGV0IChwZW5kaW5nLCBfKSA9IHdhdGNoOjpjaGFubmVsKHBlbmRpbmcpOwogICAgICAgIGxldCB0aGlzID0gU2VsZiB7CiAgICAgICAgICAgIGJsb2NrczogUndMb2NrOjpuZXcoYmxvY2tzKSwKICAgICAgICAgICAgbnVtYmVyczogUndMb2NrOjpuZXcobnVtYmVycyksCiAgICAgICAgICAgIHBlbmRpbmcsCiAgICAgICAgICAgIG1ldHJpY3M6IERlZmF1bHQ6OmRlZmF1bHQoKSwKICAgICAgICB9OwogICAgICAgIHRoaXMudXBkYXRlX21ldHJpY3MoKTsKICAgICAgICB0aGlzCiAgICB9CgogICAgLy8vIFVwZGF0ZSB0aGUgbWV0cmljcyBmb3IgdGhlIGluLW1lbW9yeSBzdGF0ZS4KICAgIC8vLwogICAgLy8vICMgTG9ja2luZyBiZWhhdmlvcgogICAgLy8vCiAgICAvLy8gVGhpcyB0cmllcyB0byBhY3F1aXJlIGEgcmVhZCBsb2NrLiBEcm9wIGFueSB3cml0ZSBsb2NrcyBiZWZvcmUgY2FsbGluZyB0aGlzLgogICAgcHViKGNyYXRlKSBmbiB1cGRhdGVfbWV0cmljcygmc2VsZikgewogICAgICAgIGxldCAoY291bnQsIGVhcmxpZXN0LCBsYXRlc3QpID0gewogICAgICAgICAgICBsZXQgbnVtYmVycyA9IHNlbGYubnVtYmVycy5yZWFkKCk7CiAgICAgICAgICAgIGxldCBjb3VudCA9IG51bWJlcnMubGVuKCk7CiAgICAgICAgICAgIGxldCBlYXJsaWVzdCA9IG51bWJlcnMuZmlyc3Rfa2V5X3ZhbHVlKCkubWFwKHwobnVtYmVyLCBfKXwgKm51bWJlcik7CiAgICAgICAgICAgIGxldCBsYXRlc3QgPSBudW1iZXJzLmxhc3Rfa2V5X3ZhbHVlKCkubWFwKHwobnVtYmVyLCBfKXwgKm51bWJlcik7CiAgICAgICAgICAgIChjb3VudCwgZWFybGllc3QsIGxhdGVzdCkKICAgICAgICB9OwogICAgICAgIGlmIGxldCBTb21lKGVhcmxpZXN0X2Jsb2NrX251bWJlcikgPSBlYXJsaWVzdCB7CiAgICAgICAgICAgIHNlbGYubWV0cmljcy5lYXJsaWVzdF9ibG9jay5zZXQoZWFybGllc3RfYmxvY2tfbnVtYmVyIGFzIGY2NCk7CiAgICAgICAgfQogICAgICAgIGlmIGxldCBTb21lKGxhdGVzdF9ibG9ja19udW1iZXIpID0gbGF0ZXN0IHsKICAgICAgICAgICAgc2VsZi5tZXRyaWNzLmxhdGVzdF9ibG9jay5zZXQobGF0ZXN0X2Jsb2NrX251bWJlciBhcyBmNjQpOwogICAgICAgIH0KICAgICAgICBzZWxmLm1ldHJpY3MubnVtX2Jsb2Nrcy5zZXQoY291bnQgYXMgZjY0KTsKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgc3RhdGUgZm9yIGEgZ2l2ZW4gYmxvY2sgaGFzaC4KICAgIHB1YihjcmF0ZSkgZm4gc3RhdGVfYnlfaGFzaCgmc2VsZiwgaGFzaDogQjI1NikgLT4gT3B0aW9uPEFyYzxCbG9ja1N0YXRlPE4+Pj4gewogICAgICAgIHNlbGYuYmxvY2tzLnJlYWQoKS5nZXQoJmhhc2gpLmNsb25lZCgpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIHN0YXRlIGZvciBhIGdpdmVuIGJsb2NrIG51bWJlci4KICAgIHB1YihjcmF0ZSkgZm4gc3RhdGVfYnlfbnVtYmVyKCZzZWxmLCBudW1iZXI6IHU2NCkgLT4gT3B0aW9uPEFyYzxCbG9ja1N0YXRlPE4+Pj4gewogICAgICAgIGxldCBoYXNoID0gc2VsZi5oYXNoX2J5X251bWJlcihudW1iZXIpPzsKICAgICAgICBzZWxmLnN0YXRlX2J5X2hhc2goaGFzaCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgaGFzaCBmb3IgYSBzcGVjaWZpYyBibG9jayBudW1iZXIKICAgIHB1YihjcmF0ZSkgZm4gaGFzaF9ieV9udW1iZXIoJnNlbGYsIG51bWJlcjogdTY0KSAtPiBPcHRpb248QjI1Nj4gewogICAgICAgIHNlbGYubnVtYmVycy5yZWFkKCkuZ2V0KCZudW1iZXIpLmNvcGllZCgpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGN1cnJlbnQgY2hhaW4gaGVhZCBzdGF0ZS4KICAgIHB1YihjcmF0ZSkgZm4gaGVhZF9zdGF0ZSgmc2VsZikgLT4gT3B0aW9uPEFyYzxCbG9ja1N0YXRlPE4+Pj4gewogICAgICAgIGxldCBoYXNoID0gKnNlbGYubnVtYmVycy5yZWFkKCkubGFzdF9rZXlfdmFsdWUoKT8uMTsKICAgICAgICBzZWxmLnN0YXRlX2J5X2hhc2goaGFzaCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgcGVuZGluZyBzdGF0ZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBjdXJyZW50IGhlYWQgcGx1cyBvbmUsCiAgICAvLy8gZnJvbSB0aGUgcGF5bG9hZCByZWNlaXZlZCBpbiBuZXdQYXlsb2FkIHRoYXQgZG9lcyBub3QgaGF2ZSBhIEZDVSB5ZXQuCiAgICBwdWIoY3JhdGUpIGZuIHBlbmRpbmdfc3RhdGUoJnNlbGYpIC0+IE9wdGlvbjxCbG9ja1N0YXRlPE4+PiB7CiAgICAgICAgc2VsZi5wZW5kaW5nLmJvcnJvdygpLmNsb25lKCkKICAgIH0KCiAgICAjW2NmZyh0ZXN0KV0KICAgIGZuIGJsb2NrX2NvdW50KCZzZWxmKSAtPiB1c2l6ZSB7CiAgICAgICAgc2VsZi5ibG9ja3MucmVhZCgpLmxlbigpCiAgICB9Cn0KCi8vLyBJbm5lciB0eXBlIHRvIHByb3ZpZGUgaW4gbWVtb3J5IHN0YXRlLiBJdCBpbmNsdWRlcyBhIGNoYWluIHRyYWNrZXIgdG8gYmUKLy8vIGFkdmFuY2VkIGludGVybmFsbHkgYnkgdGhlIHRyZWUuCiNbZGVyaXZlKERlYnVnKV0KcHViKGNyYXRlKSBzdHJ1Y3QgQ2Fub25pY2FsSW5NZW1vcnlTdGF0ZUlubmVyPE46IE5vZGVQcmltaXRpdmVzPiB7CiAgICAvLy8gVHJhY2tzIGNlcnRhaW4gY2hhaW4gaW5mb3JtYXRpb24sIHN1Y2ggYXMgdGhlIGNhbm9uaWNhbCBoZWFkLCBzYWZlIGhlYWQsIGFuZCBmaW5hbGl6ZWQKICAgIC8vLyBoZWFkLgogICAgcHViKGNyYXRlKSBjaGFpbl9pbmZvX3RyYWNrZXI6IENoYWluSW5mb1RyYWNrZXI8Tj4sCiAgICAvLy8gVHJhY2tzIGJsb2NrcyBhdCB0aGUgdGlwIG9mIHRoZSBjaGFpbiB0aGF0IGhhdmUgbm90IGJlZW4gcGVyc2lzdGVkIHRvIGRpc2sgeWV0LgogICAgcHViKGNyYXRlKSBpbl9tZW1vcnlfc3RhdGU6IEluTWVtb3J5U3RhdGU8Tj4sCiAgICAvLy8gQSBicm9hZGNhc3Qgc3RyZWFtIHRoYXQgZW1pdHMgZXZlbnRzIHdoZW4gdGhlIGNhbm9uaWNhbCBjaGFpbiBpcyB1cGRhdGVkLgogICAgcHViKGNyYXRlKSBjYW5vbl9zdGF0ZV9ub3RpZmljYXRpb25fc2VuZGVyOiBDYW5vblN0YXRlTm90aWZpY2F0aW9uU2VuZGVyPE4+LAp9CgppbXBsPE46IE5vZGVQcmltaXRpdmVzPiBDYW5vbmljYWxJbk1lbW9yeVN0YXRlSW5uZXI8Tj4gewogICAgLy8vIENsZWFycyBhbGwgZW50cmllcyBpbiB0aGUgaW4gbWVtb3J5IHN0YXRlLgogICAgZm4gY2xlYXIoJnNlbGYpIHsKICAgICAgICB7CiAgICAgICAgICAgIC8vIGFjcXVpcmUgbG9ja3MsIHN0YXJ0aW5nIHdpdGggdGhlIG51bWJlcnMgbG9jawogICAgICAgICAgICBsZXQgbXV0IG51bWJlcnMgPSBzZWxmLmluX21lbW9yeV9zdGF0ZS5udW1iZXJzLndyaXRlKCk7CiAgICAgICAgICAgIGxldCBtdXQgYmxvY2tzID0gc2VsZi5pbl9tZW1vcnlfc3RhdGUuYmxvY2tzLndyaXRlKCk7CiAgICAgICAgICAgIG51bWJlcnMuY2xlYXIoKTsKICAgICAgICAgICAgYmxvY2tzLmNsZWFyKCk7CiAgICAgICAgICAgIHNlbGYuaW5fbWVtb3J5X3N0YXRlLnBlbmRpbmcuc2VuZF9tb2RpZnkofHB8IHsKICAgICAgICAgICAgICAgIHAudGFrZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgc2VsZi5pbl9tZW1vcnlfc3RhdGUudXBkYXRlX21ldHJpY3MoKTsKICAgIH0KfQoKdHlwZSBQZW5kaW5nQmxvY2tBbmRSZWNlaXB0czxOPiA9CiAgICAoUmVjb3ZlcmVkQmxvY2s8PE4gYXMgTm9kZVByaW1pdGl2ZXM+OjpCbG9jaz4sIFZlYzxyZXRoX3ByaW1pdGl2ZXNfdHJhaXRzOjpSZWNlaXB0VHk8Tj4+KTsKCi8vLyBUaGlzIHR5cGUgaXMgcmVzcG9uc2libGUgZm9yIHByb3ZpZGluZyB0aGUgYmxvY2tzLCByZWNlaXB0cywgYW5kIHN0YXRlIGZvcgovLy8gYWxsIGNhbm9uaWNhbCBibG9ja3Mgbm90IG9uIGRpc2sgeWV0IGFuZCBrZWVwcyB0cmFjayBvZiB0aGUgYmxvY2sgcmFuZ2UgdGhhdAovLy8gaXMgaW4gbWVtb3J5LgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUpXQpwdWIgc3RydWN0IENhbm9uaWNhbEluTWVtb3J5U3RhdGU8TjogTm9kZVByaW1pdGl2ZXMgPSBFdGhQcmltaXRpdmVzPiB7CiAgICBwdWIoY3JhdGUpIGlubmVyOiBBcmM8Q2Fub25pY2FsSW5NZW1vcnlTdGF0ZUlubmVyPE4+PiwKfQoKaW1wbDxOOiBOb2RlUHJpbWl0aXZlcz4gQ2Fub25pY2FsSW5NZW1vcnlTdGF0ZTxOPiB7CiAgICAvLy8gQ3JlYXRlIGEgbmV3IGluLW1lbW9yeSBzdGF0ZSB3aXRoIHRoZSBnaXZlbiBibG9ja3MsIG51bWJlcnMsIHBlbmRpbmcgc3RhdGUsIGFuZCBvcHRpb25hbAogICAgLy8vIGZpbmFsaXplZCBoZWFkZXIuCiAgICBwdWIgZm4gbmV3KAogICAgICAgIGJsb2NrczogSGFzaE1hcDxCMjU2LCBBcmM8QmxvY2tTdGF0ZTxOPj4+LAogICAgICAgIG51bWJlcnM6IEJUcmVlTWFwPHU2NCwgQjI1Nj4sCiAgICAgICAgcGVuZGluZzogT3B0aW9uPEJsb2NrU3RhdGU8Tj4+LAogICAgICAgIGZpbmFsaXplZDogT3B0aW9uPFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4+LAogICAgICAgIHNhZmU6IE9wdGlvbjxTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+PiwKICAgICkgLT4gU2VsZiB7CiAgICAgICAgbGV0IGluX21lbW9yeV9zdGF0ZSA9IEluTWVtb3J5U3RhdGU6Om5ldyhibG9ja3MsIG51bWJlcnMsIHBlbmRpbmcpOwogICAgICAgIGxldCBoZWFkZXIgPSBpbl9tZW1vcnlfc3RhdGUuaGVhZF9zdGF0ZSgpLm1hcF9vcl9lbHNlKFNlYWxlZEhlYWRlcjo6ZGVmYXVsdCwgfHN0YXRlfCB7CiAgICAgICAgICAgIHN0YXRlLmJsb2NrX3JlZigpLnJlY292ZXJlZF9ibG9jaygpLmNsb25lX3NlYWxlZF9oZWFkZXIoKQogICAgICAgIH0pOwogICAgICAgIGxldCBjaGFpbl9pbmZvX3RyYWNrZXIgPSBDaGFpbkluZm9UcmFja2VyOjpuZXcoaGVhZGVyLCBmaW5hbGl6ZWQsIHNhZmUpOwogICAgICAgIGxldCAoY2Fub25fc3RhdGVfbm90aWZpY2F0aW9uX3NlbmRlciwgXykgPQogICAgICAgICAgICBicm9hZGNhc3Q6OmNoYW5uZWwoQ0FOT05fU1RBVEVfTk9USUZJQ0FUSU9OX0NIQU5ORUxfU0laRSk7CgogICAgICAgIFNlbGYgewogICAgICAgICAgICBpbm5lcjogQXJjOjpuZXcoQ2Fub25pY2FsSW5NZW1vcnlTdGF0ZUlubmVyIHsKICAgICAgICAgICAgICAgIGNoYWluX2luZm9fdHJhY2tlciwKICAgICAgICAgICAgICAgIGluX21lbW9yeV9zdGF0ZSwKICAgICAgICAgICAgICAgIGNhbm9uX3N0YXRlX25vdGlmaWNhdGlvbl9zZW5kZXIsCiAgICAgICAgICAgIH0pLAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQ3JlYXRlIGFuIGVtcHR5IHN0YXRlLgogICAgcHViIGZuIGVtcHR5KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZjo6bmV3KEhhc2hNYXA6OmRlZmF1bHQoKSwgQlRyZWVNYXA6Om5ldygpLCBOb25lLCBOb25lLCBOb25lKQogICAgfQoKICAgIC8vLyBDcmVhdGUgYSBuZXcgaW4gbWVtb3J5IHN0YXRlIHdpdGggdGhlIGdpdmVuIGxvY2FsIGhlYWQgYW5kIGZpbmFsaXplZCBoZWFkZXIKICAgIC8vLyBpZiBpdCBleGlzdHMuCiAgICBwdWIgZm4gd2l0aF9oZWFkKAogICAgICAgIGhlYWQ6IFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4sCiAgICAgICAgZmluYWxpemVkOiBPcHRpb248U2VhbGVkSGVhZGVyPE46OkJsb2NrSGVhZGVyPj4sCiAgICAgICAgc2FmZTogT3B0aW9uPFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4+LAogICAgKSAtPiBTZWxmIHsKICAgICAgICBsZXQgY2hhaW5faW5mb190cmFja2VyID0gQ2hhaW5JbmZvVHJhY2tlcjo6bmV3KGhlYWQsIGZpbmFsaXplZCwgc2FmZSk7CiAgICAgICAgbGV0IGluX21lbW9yeV9zdGF0ZSA9IEluTWVtb3J5U3RhdGU6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgKGNhbm9uX3N0YXRlX25vdGlmaWNhdGlvbl9zZW5kZXIsIF8pID0KICAgICAgICAgICAgYnJvYWRjYXN0OjpjaGFubmVsKENBTk9OX1NUQVRFX05PVElGSUNBVElPTl9DSEFOTkVMX1NJWkUpOwogICAgICAgIGxldCBpbm5lciA9IENhbm9uaWNhbEluTWVtb3J5U3RhdGVJbm5lciB7CiAgICAgICAgICAgIGNoYWluX2luZm9fdHJhY2tlciwKICAgICAgICAgICAgaW5fbWVtb3J5X3N0YXRlLAogICAgICAgICAgICBjYW5vbl9zdGF0ZV9ub3RpZmljYXRpb25fc2VuZGVyLAogICAgICAgIH07CgogICAgICAgIFNlbGYgeyBpbm5lcjogQXJjOjpuZXcoaW5uZXIpIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgYmxvY2sgaGFzaCBjb3JyZXNwb25kaW5nIHRvIHRoZSBnaXZlbiBudW1iZXIuCiAgICBwdWIgZm4gaGFzaF9ieV9udW1iZXIoJnNlbGYsIG51bWJlcjogdTY0KSAtPiBPcHRpb248QjI1Nj4gewogICAgICAgIHNlbGYuaW5uZXIuaW5fbWVtb3J5X3N0YXRlLmhhc2hfYnlfbnVtYmVyKG51bWJlcikKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgaGVhZGVyIGNvcnJlc3BvbmRpbmcgdG8gdGhlIGdpdmVuIGhhc2guCiAgICBwdWIgZm4gaGVhZGVyX2J5X2hhc2goJnNlbGYsIGhhc2g6IEIyNTYpIC0+IE9wdGlvbjxTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+PiB7CiAgICAgICAgc2VsZi5zdGF0ZV9ieV9oYXNoKGhhc2gpCiAgICAgICAgICAgIC5tYXAofGJsb2NrfCBibG9jay5ibG9ja19yZWYoKS5yZWNvdmVyZWRfYmxvY2soKS5jbG9uZV9zZWFsZWRfaGVhZGVyKCkpCiAgICB9CgogICAgLy8vIENsZWFycyBhbGwgZW50cmllcyBpbiB0aGUgaW4gbWVtb3J5IHN0YXRlLgogICAgcHViIGZuIGNsZWFyX3N0YXRlKCZzZWxmKSB7CiAgICAgICAgc2VsZi5pbm5lci5jbGVhcigpCiAgICB9CgogICAgLy8vIFVwZGF0ZXMgdGhlIHBlbmRpbmcgYmxvY2sgd2l0aCB0aGUgZ2l2ZW4gYmxvY2suCiAgICAvLy8KICAgIC8vLyBOb3RlOiBUaGlzIGFzc3VtZXMgdGhhdCB0aGUgcGFyZW50IGJsb2NrIG9mIHRoZSBwZW5kaW5nIGJsb2NrIGlzIGNhbm9uaWNhbC4KICAgIHB1YiBmbiBzZXRfcGVuZGluZ19ibG9jaygmc2VsZiwgcGVuZGluZzogRXhlY3V0ZWRCbG9jazxOPikgewogICAgICAgIC8vIGZldGNoIHRoZSBzdGF0ZSBvZiB0aGUgcGVuZGluZyBibG9jaydzIHBhcmVudCBibG9jawogICAgICAgIGxldCBwYXJlbnQgPSBzZWxmLnN0YXRlX2J5X2hhc2gocGVuZGluZy5yZWNvdmVyZWRfYmxvY2soKS5wYXJlbnRfaGFzaCgpKTsKICAgICAgICBsZXQgcGVuZGluZyA9IEJsb2NrU3RhdGU6OndpdGhfcGFyZW50KHBlbmRpbmcsIHBhcmVudCk7CiAgICAgICAgc2VsZi5pbm5lci5pbl9tZW1vcnlfc3RhdGUucGVuZGluZy5zZW5kX21vZGlmeSh8cHwgewogICAgICAgICAgICBwLnJlcGxhY2UocGVuZGluZyk7CiAgICAgICAgfSk7CiAgICAgICAgc2VsZi5pbm5lci5pbl9tZW1vcnlfc3RhdGUudXBkYXRlX21ldHJpY3MoKTsKICAgIH0KCiAgICAvLy8gQXBwZW5kIG5ldyBibG9ja3MgdG8gdGhlIGluIG1lbW9yeSBzdGF0ZS4KICAgIC8vLwogICAgLy8vIFRoaXMgcmVtb3ZlcyBhbGwgcmVvcmdlZCBibG9ja3MgYW5kIGFwcGVuZHMgdGhlIG5ldyBibG9ja3MgdG8gdGhlIHRyYWNrZWQgY2hhaW4gYW5kIGNvbm5lY3RzCiAgICAvLy8gdGhlbSB0byB0aGVpciBwYXJlbnQgYmxvY2tzLgogICAgZm4gdXBkYXRlX2Jsb2NrczxJLCBSPigmc2VsZiwgbmV3X2Jsb2NrczogSSwgcmVvcmdlZDogUikKICAgIHdoZXJlCiAgICAgICAgSTogSW50b0l0ZXJhdG9yPEl0ZW0gPSBFeGVjdXRlZEJsb2NrPE4+PiwKICAgICAgICBSOiBJbnRvSXRlcmF0b3I8SXRlbSA9IEV4ZWN1dGVkQmxvY2s8Tj4+LAogICAgewogICAgICAgIHsKICAgICAgICAgICAgLy8gYWNxdWlyZSBsb2Nrcywgc3RhcnRpbmcgd2l0aCB0aGUgbnVtYmVycyBsb2NrCiAgICAgICAgICAgIGxldCBtdXQgbnVtYmVycyA9IHNlbGYuaW5uZXIuaW5fbWVtb3J5X3N0YXRlLm51bWJlcnMud3JpdGUoKTsKICAgICAgICAgICAgbGV0IG11dCBibG9ja3MgPSBzZWxmLmlubmVyLmluX21lbW9yeV9zdGF0ZS5ibG9ja3Mud3JpdGUoKTsKCiAgICAgICAgICAgIC8vIHdlIGZpcnN0IHJlbW92ZSB0aGUgYmxvY2tzIGZyb20gdGhlIHJlb3JnZWQgY2hhaW4KICAgICAgICAgICAgZm9yIGJsb2NrIGluIHJlb3JnZWQgewogICAgICAgICAgICAgICAgbGV0IGhhc2ggPSBibG9jay5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCk7CiAgICAgICAgICAgICAgICBsZXQgbnVtYmVyID0gYmxvY2sucmVjb3ZlcmVkX2Jsb2NrKCkubnVtYmVyKCk7CiAgICAgICAgICAgICAgICBibG9ja3MucmVtb3ZlKCZoYXNoKTsKICAgICAgICAgICAgICAgIG51bWJlcnMucmVtb3ZlKCZudW1iZXIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpbnNlcnQgdGhlIG5ldyBibG9ja3MKICAgICAgICAgICAgZm9yIGJsb2NrIGluIG5ld19ibG9ja3MgewogICAgICAgICAgICAgICAgbGV0IHBhcmVudCA9IGJsb2Nrcy5nZXQoJmJsb2NrLnJlY292ZXJlZF9ibG9jaygpLnBhcmVudF9oYXNoKCkpLmNsb25lZCgpOwogICAgICAgICAgICAgICAgbGV0IGJsb2NrX3N0YXRlID0gQmxvY2tTdGF0ZTo6d2l0aF9wYXJlbnQoYmxvY2ssIHBhcmVudCk7CiAgICAgICAgICAgICAgICBsZXQgaGFzaCA9IGJsb2NrX3N0YXRlLmhhc2goKTsKICAgICAgICAgICAgICAgIGxldCBudW1iZXIgPSBibG9ja19zdGF0ZS5udW1iZXIoKTsKCiAgICAgICAgICAgICAgICAvLyBhcHBlbmQgbmV3IGJsb2NrcwogICAgICAgICAgICAgICAgYmxvY2tzLmluc2VydChoYXNoLCBBcmM6Om5ldyhibG9ja19zdGF0ZSkpOwogICAgICAgICAgICAgICAgbnVtYmVycy5pbnNlcnQobnVtYmVyLCBoYXNoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBwZW5kaW5nIHN0YXRlCiAgICAgICAgICAgIHNlbGYuaW5uZXIuaW5fbWVtb3J5X3N0YXRlLnBlbmRpbmcuc2VuZF9tb2RpZnkofHB8IHsKICAgICAgICAgICAgICAgIHAudGFrZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgc2VsZi5pbm5lci5pbl9tZW1vcnlfc3RhdGUudXBkYXRlX21ldHJpY3MoKTsKICAgIH0KCiAgICAvLy8gVXBkYXRlIHRoZSBpbiBtZW1vcnkgc3RhdGUgd2l0aCB0aGUgZ2l2ZW4gY2hhaW4gdXBkYXRlLgogICAgcHViIGZuIHVwZGF0ZV9jaGFpbigmc2VsZiwgbmV3X2NoYWluOiBOZXdDYW5vbmljYWxDaGFpbjxOPikgewogICAgICAgIG1hdGNoIG5ld19jaGFpbiB7CiAgICAgICAgICAgIE5ld0Nhbm9uaWNhbENoYWluOjpDb21taXQgeyBuZXcgfSA9PiB7CiAgICAgICAgICAgICAgICBzZWxmLnVwZGF0ZV9ibG9ja3MobmV3LCB2ZWMhW10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIE5ld0Nhbm9uaWNhbENoYWluOjpSZW9yZyB7IG5ldywgb2xkIH0gPT4gewogICAgICAgICAgICAgICAgc2VsZi51cGRhdGVfYmxvY2tzKG5ldywgb2xkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLy8gUmVtb3ZlcyBibG9ja3MgZnJvbSB0aGUgaW4gbWVtb3J5IHN0YXRlIHRoYXQgYXJlIHBlcnNpc3RlZCB0byB0aGUgZ2l2ZW4gaGVpZ2h0LgogICAgLy8vCiAgICAvLy8gVGhpcyB3aWxsIHVwZGF0ZSB0aGUgbGlua3MgYmV0d2VlbiBibG9ja3MgYW5kIHJlbW92ZSBhbGwgYmxvY2tzIHRoYXQgYXJlIFsuLgogICAgLy8vIGBwZXJzaXN0ZWRfaGVpZ2h0YF0uCiAgICBwdWIgZm4gcmVtb3ZlX3BlcnNpc3RlZF9ibG9ja3MoJnNlbGYsIHBlcnNpc3RlZF9udW1faGFzaDogQmxvY2tOdW1IYXNoKSB7CiAgICAgICAgc2VsZi5zZXRfcGVyc2lzdGVkKHBlcnNpc3RlZF9udW1faGFzaCk7CiAgICAgICAgLy8gaWYgdGhlIHBlcnNpc3RlZCBoYXNoIGlzIG5vdCBpbiB0aGUgY2Fub25pY2FsIGluIG1lbW9yeSBzdGF0ZSwgZG8gbm90aGluZywgYmVjYXVzZSBpdAogICAgICAgIC8vIG1lYW5zIGNhbm9uaWNhbCBibG9ja3Mgd2VyZSBub3QgYWN0dWFsbHkgcGVyc2lzdGVkLgogICAgICAgIC8vCiAgICAgICAgLy8gVGhpcyBjYW4gaGFwcGVuIGlmIHRoZSBwZXJzaXN0ZW5jZSB0YXNrIHRha2VzIGEgbG9uZyB0aW1lLCB3aGlsZSBhIHJlb3JnIGlzIGhhcHBlbmluZy4KICAgICAgICB7CiAgICAgICAgICAgIGlmIHNlbGYuaW5uZXIuaW5fbWVtb3J5X3N0YXRlLmJsb2Nrcy5yZWFkKCkuZ2V0KCZwZXJzaXN0ZWRfbnVtX2hhc2guaGFzaCkuaXNfbm9uZSgpIHsKICAgICAgICAgICAgICAgIC8vIGRvIG5vdGhpbmcKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB7CiAgICAgICAgICAgIC8vIGFjcXVpcmUgbG9ja3MsIHN0YXJ0aW5nIHdpdGggdGhlIG51bWJlcnMgbG9jawogICAgICAgICAgICBsZXQgbXV0IG51bWJlcnMgPSBzZWxmLmlubmVyLmluX21lbW9yeV9zdGF0ZS5udW1iZXJzLndyaXRlKCk7CiAgICAgICAgICAgIGxldCBtdXQgYmxvY2tzID0gc2VsZi5pbm5lci5pbl9tZW1vcnlfc3RhdGUuYmxvY2tzLndyaXRlKCk7CgogICAgICAgICAgICBsZXQgQmxvY2tOdW1IYXNoIHsgbnVtYmVyOiBwZXJzaXN0ZWRfaGVpZ2h0LCBoYXNoOiBfIH0gPSBwZXJzaXN0ZWRfbnVtX2hhc2g7CgogICAgICAgICAgICAvLyBjbGVhciBhbGwgbnVtYmVycwogICAgICAgICAgICBudW1iZXJzLmNsZWFyKCk7CgogICAgICAgICAgICAvLyBkcmFpbiBhbGwgYmxvY2tzIGFuZCBvbmx5IGtlZXAgdGhlIG9uZXMgdGhhdCBhcmUgbm90IHBlcnNpc3RlZCAoYmVsb3cgdGhlIHBlcnNpc3RlZAogICAgICAgICAgICAvLyBoZWlnaHQpCiAgICAgICAgICAgIGxldCBtdXQgb2xkX2Jsb2NrcyA9IGJsb2NrcwogICAgICAgICAgICAgICAgLmRyYWluKCkKICAgICAgICAgICAgICAgIC5maWx0ZXIofChfLCBiKXwgYi5ibG9ja19yZWYoKS5yZWNvdmVyZWRfYmxvY2soKS5udW1iZXIoKSA+IHBlcnNpc3RlZF9oZWlnaHQpCiAgICAgICAgICAgICAgICAubWFwKHwoXywgYil8IGIuYmxvY2suY2xvbmUoKSkKICAgICAgICAgICAgICAgIC5jb2xsZWN0Ojo8VmVjPF8+PigpOwoKICAgICAgICAgICAgLy8gc29ydCB0aGUgYmxvY2tzIGJ5IG51bWJlciBzbyB3ZSBjYW4gaW5zZXJ0IHRoZW0gYmFjayBpbiBuYXR1cmFsIG9yZGVyIChsb3cgLT4gaGlnaCkKICAgICAgICAgICAgb2xkX2Jsb2Nrcy5zb3J0X3Vuc3RhYmxlX2J5X2tleSh8YmxvY2t8IGJsb2NrLnJlY292ZXJlZF9ibG9jaygpLm51bWJlcigpKTsKCiAgICAgICAgICAgIC8vIHJlLWluc2VydCB0aGUgYmxvY2tzIGluIG5hdHVyYWwgb3JkZXIgYW5kIGNvbm5lY3QgdGhlbSB0byB0aGVpciBwYXJlbnQgYmxvY2tzCiAgICAgICAgICAgIGZvciBibG9jayBpbiBvbGRfYmxvY2tzIHsKICAgICAgICAgICAgICAgIGxldCBwYXJlbnQgPSBibG9ja3MuZ2V0KCZibG9jay5yZWNvdmVyZWRfYmxvY2soKS5wYXJlbnRfaGFzaCgpKS5jbG9uZWQoKTsKICAgICAgICAgICAgICAgIGxldCBibG9ja19zdGF0ZSA9IEJsb2NrU3RhdGU6OndpdGhfcGFyZW50KGJsb2NrLCBwYXJlbnQpOwogICAgICAgICAgICAgICAgbGV0IGhhc2ggPSBibG9ja19zdGF0ZS5oYXNoKCk7CiAgICAgICAgICAgICAgICBsZXQgbnVtYmVyID0gYmxvY2tfc3RhdGUubnVtYmVyKCk7CgogICAgICAgICAgICAgICAgLy8gYXBwZW5kIG5ldyBibG9ja3MKICAgICAgICAgICAgICAgIGJsb2Nrcy5pbnNlcnQoaGFzaCwgQXJjOjpuZXcoYmxvY2tfc3RhdGUpKTsKICAgICAgICAgICAgICAgIG51bWJlcnMuaW5zZXJ0KG51bWJlciwgaGFzaCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGFsc28gc2hpZnQgdGhlIHBlbmRpbmcgc3RhdGUgaWYgaXQgZXhpc3RzCiAgICAgICAgICAgIHNlbGYuaW5uZXIuaW5fbWVtb3J5X3N0YXRlLnBlbmRpbmcuc2VuZF9tb2RpZnkofHB8IHsKICAgICAgICAgICAgICAgIGlmIGxldCBTb21lKHApID0gcC5hc19tdXQoKSB7CiAgICAgICAgICAgICAgICAgICAgcC5wYXJlbnQgPSBibG9ja3MuZ2V0KCZwLmJsb2NrX3JlZigpLnJlY292ZXJlZF9ibG9jaygpLnBhcmVudF9oYXNoKCkpLmNsb25lZCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgc2VsZi5pbm5lci5pbl9tZW1vcnlfc3RhdGUudXBkYXRlX21ldHJpY3MoKTsKICAgIH0KCiAgICAvLy8gUmV0dXJucyBpbiBtZW1vcnkgc3RhdGUgY29ycmVzcG9uZGluZyB0aGUgZ2l2ZW4gaGFzaC4KICAgIHB1YiBmbiBzdGF0ZV9ieV9oYXNoKCZzZWxmLCBoYXNoOiBCMjU2KSAtPiBPcHRpb248QXJjPEJsb2NrU3RhdGU8Tj4+PiB7CiAgICAgICAgc2VsZi5pbm5lci5pbl9tZW1vcnlfc3RhdGUuc3RhdGVfYnlfaGFzaChoYXNoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGluIG1lbW9yeSBzdGF0ZSBjb3JyZXNwb25kaW5nIHRoZSBibG9jayBudW1iZXIuCiAgICBwdWIgZm4gc3RhdGVfYnlfbnVtYmVyKCZzZWxmLCBudW1iZXI6IHU2NCkgLT4gT3B0aW9uPEFyYzxCbG9ja1N0YXRlPE4+Pj4gewogICAgICAgIHNlbGYuaW5uZXIuaW5fbWVtb3J5X3N0YXRlLnN0YXRlX2J5X251bWJlcihudW1iZXIpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGluIG1lbW9yeSBoZWFkIHN0YXRlLgogICAgcHViIGZuIGhlYWRfc3RhdGUoJnNlbGYpIC0+IE9wdGlvbjxBcmM8QmxvY2tTdGF0ZTxOPj4+IHsKICAgICAgICBzZWxmLmlubmVyLmluX21lbW9yeV9zdGF0ZS5oZWFkX3N0YXRlKCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgaW4gbWVtb3J5IHBlbmRpbmcgc3RhdGUuCiAgICBwdWIgZm4gcGVuZGluZ19zdGF0ZSgmc2VsZikgLT4gT3B0aW9uPEJsb2NrU3RhdGU8Tj4+IHsKICAgICAgICBzZWxmLmlubmVyLmluX21lbW9yeV9zdGF0ZS5wZW5kaW5nX3N0YXRlKCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgaW4gbWVtb3J5IHBlbmRpbmcgYEJsb2NrTnVtSGFzaGAuCiAgICBwdWIgZm4gcGVuZGluZ19ibG9ja19udW1faGFzaCgmc2VsZikgLT4gT3B0aW9uPEJsb2NrTnVtSGFzaD4gewogICAgICAgIHNlbGYuaW5uZXIKICAgICAgICAgICAgLmluX21lbW9yeV9zdGF0ZQogICAgICAgICAgICAucGVuZGluZ19zdGF0ZSgpCiAgICAgICAgICAgIC5tYXAofHN0YXRlfCBCbG9ja051bUhhc2ggeyBudW1iZXI6IHN0YXRlLm51bWJlcigpLCBoYXNoOiBzdGF0ZS5oYXNoKCkgfSkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgY3VycmVudCBgQ2hhaW5JbmZvYC4KICAgIHB1YiBmbiBjaGFpbl9pbmZvKCZzZWxmKSAtPiBDaGFpbkluZm8gewogICAgICAgIHNlbGYuaW5uZXIuY2hhaW5faW5mb190cmFja2VyLmNoYWluX2luZm8oKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBsYXRlc3QgY2Fub25pY2FsIGJsb2NrIG51bWJlci4KICAgIHB1YiBmbiBnZXRfY2Fub25pY2FsX2Jsb2NrX251bWJlcigmc2VsZikgLT4gdTY0IHsKICAgICAgICBzZWxmLmlubmVyLmNoYWluX2luZm9fdHJhY2tlci5nZXRfY2Fub25pY2FsX2Jsb2NrX251bWJlcigpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGBCbG9ja051bUhhc2hgIG9mIHRoZSBzYWZlIGhlYWQuCiAgICBwdWIgZm4gZ2V0X3NhZmVfbnVtX2hhc2goJnNlbGYpIC0+IE9wdGlvbjxCbG9ja051bUhhc2g+IHsKICAgICAgICBzZWxmLmlubmVyLmNoYWluX2luZm9fdHJhY2tlci5nZXRfc2FmZV9udW1faGFzaCgpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGBCbG9ja051bUhhc2hgIG9mIHRoZSBmaW5hbGl6ZWQgaGVhZC4KICAgIHB1YiBmbiBnZXRfZmluYWxpemVkX251bV9oYXNoKCZzZWxmKSAtPiBPcHRpb248QmxvY2tOdW1IYXNoPiB7CiAgICAgICAgc2VsZi5pbm5lci5jaGFpbl9pbmZvX3RyYWNrZXIuZ2V0X2ZpbmFsaXplZF9udW1faGFzaCgpCiAgICB9CgogICAgLy8vIEhvb2sgZm9yIG5ldyBmb3JrIGNob2ljZSB1cGRhdGUuCiAgICBwdWIgZm4gb25fZm9ya2Nob2ljZV91cGRhdGVfcmVjZWl2ZWQoJnNlbGYpIHsKICAgICAgICBzZWxmLmlubmVyLmNoYWluX2luZm9fdHJhY2tlci5vbl9mb3JrY2hvaWNlX3VwZGF0ZV9yZWNlaXZlZCgpOwogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSB0aW1lc3RhbXAgb2YgdGhlIGxhc3QgcmVjZWl2ZWQgdXBkYXRlLgogICAgcHViIGZuIGxhc3RfcmVjZWl2ZWRfdXBkYXRlX3RpbWVzdGFtcCgmc2VsZikgLT4gT3B0aW9uPEluc3RhbnQ+IHsKICAgICAgICBzZWxmLmlubmVyLmNoYWluX2luZm9fdHJhY2tlci5sYXN0X2ZvcmtjaG9pY2VfdXBkYXRlX3JlY2VpdmVkX2F0KCkKICAgIH0KCiAgICAvLy8gQ2Fub25pY2FsIGhlYWQgc2V0dGVyLgogICAgcHViIGZuIHNldF9jYW5vbmljYWxfaGVhZCgmc2VsZiwgaGVhZGVyOiBTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+KSB7CiAgICAgICAgc2VsZi5pbm5lci5jaGFpbl9pbmZvX3RyYWNrZXIuc2V0X2Nhbm9uaWNhbF9oZWFkKGhlYWRlcik7CiAgICB9CgogICAgLy8vIFNhZmUgaGVhZCBzZXR0ZXIuCiAgICBwdWIgZm4gc2V0X3NhZmUoJnNlbGYsIGhlYWRlcjogU2VhbGVkSGVhZGVyPE46OkJsb2NrSGVhZGVyPikgewogICAgICAgIHNlbGYuaW5uZXIuY2hhaW5faW5mb190cmFja2VyLnNldF9zYWZlKGhlYWRlcik7CiAgICB9CgogICAgLy8vIEZpbmFsaXplZCBoZWFkIHNldHRlci4KICAgIHB1YiBmbiBzZXRfZmluYWxpemVkKCZzZWxmLCBoZWFkZXI6IFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4pIHsKICAgICAgICBzZWxmLmlubmVyLmNoYWluX2luZm9fdHJhY2tlci5zZXRfZmluYWxpemVkKGhlYWRlcik7CiAgICB9CgogICAgLy8vIFBlcnNpc3RlZCBibG9jayBzZXR0ZXIuCiAgICBwdWIgZm4gc2V0X3BlcnNpc3RlZCgmc2VsZiwgbnVtX2hhc2g6IEJsb2NrTnVtSGFzaCkgewogICAgICAgIHNlbGYuaW5uZXIuY2hhaW5faW5mb190cmFja2VyLnNldF9wZXJzaXN0ZWQobnVtX2hhc2gpOwogICAgfQoKICAgIC8vLyBDYW5vbmljYWwgaGVhZCBnZXR0ZXIuCiAgICBwdWIgZm4gZ2V0X2Nhbm9uaWNhbF9oZWFkKCZzZWxmKSAtPiBTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+IHsKICAgICAgICBzZWxmLmlubmVyLmNoYWluX2luZm9fdHJhY2tlci5nZXRfY2Fub25pY2FsX2hlYWQoKQogICAgfQoKICAgIC8vLyBGaW5hbGl6ZWQgaGVhZGVyIGdldHRlci4KICAgIHB1YiBmbiBnZXRfZmluYWxpemVkX2hlYWRlcigmc2VsZikgLT4gT3B0aW9uPFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4+IHsKICAgICAgICBzZWxmLmlubmVyLmNoYWluX2luZm9fdHJhY2tlci5nZXRfZmluYWxpemVkX2hlYWRlcigpCiAgICB9CgogICAgLy8vIFNhZmUgaGVhZGVyIGdldHRlci4KICAgIHB1YiBmbiBnZXRfc2FmZV9oZWFkZXIoJnNlbGYpIC0+IE9wdGlvbjxTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+PiB7CiAgICAgICAgc2VsZi5pbm5lci5jaGFpbl9pbmZvX3RyYWNrZXIuZ2V0X3NhZmVfaGVhZGVyKCkKICAgIH0KCiAgICAvLy8gUGVyc2lzdGVkIGJsb2NrIGBCbG9ja051bUhhc2hgIGdldHRlci4KICAgIHB1YiBmbiBnZXRfcGVyc2lzdGVkX251bV9oYXNoKCZzZWxmKSAtPiBPcHRpb248QmxvY2tOdW1IYXNoPiB7CiAgICAgICAgc2VsZi5pbm5lci5jaGFpbl9pbmZvX3RyYWNrZXIuZ2V0X3BlcnNpc3RlZF9udW1faGFzaCgpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGBTZWFsZWRIZWFkZXJgIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHBlbmRpbmcgc3RhdGUuCiAgICBwdWIgZm4gcGVuZGluZ19zZWFsZWRfaGVhZGVyKCZzZWxmKSAtPiBPcHRpb248U2VhbGVkSGVhZGVyPE46OkJsb2NrSGVhZGVyPj4gewogICAgICAgIHNlbGYucGVuZGluZ19zdGF0ZSgpLm1hcCh8aHwgaC5ibG9ja19yZWYoKS5yZWNvdmVyZWRfYmxvY2soKS5jbG9uZV9zZWFsZWRfaGVhZGVyKCkpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGBIZWFkZXJgIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHBlbmRpbmcgc3RhdGUuCiAgICBwdWIgZm4gcGVuZGluZ19oZWFkZXIoJnNlbGYpIC0+IE9wdGlvbjxOOjpCbG9ja0hlYWRlcj4gewogICAgICAgIHNlbGYucGVuZGluZ19zZWFsZWRfaGVhZGVyKCkubWFwKHxzZWFsZWRfaGVhZGVyfCBzZWFsZWRfaGVhZGVyLnVuc2VhbCgpKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBgU2VhbGVkQmxvY2tgIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHBlbmRpbmcgc3RhdGUuCiAgICBwdWIgZm4gcGVuZGluZ19ibG9jaygmc2VsZikgLT4gT3B0aW9uPFNlYWxlZEJsb2NrPE46OkJsb2NrPj4gewogICAgICAgIHNlbGYucGVuZGluZ19zdGF0ZSgpCiAgICAgICAgICAgIC5tYXAofGJsb2NrX3N0YXRlfCBibG9ja19zdGF0ZS5ibG9ja19yZWYoKS5yZWNvdmVyZWRfYmxvY2soKS5zZWFsZWRfYmxvY2soKS5jbG9uZSgpKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBgUmVjb3ZlcmVkQmxvY2tgIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHBlbmRpbmcgc3RhdGUuCiAgICBwdWIgZm4gcGVuZGluZ19yZWNvdmVyZWRfYmxvY2soJnNlbGYpIC0+IE9wdGlvbjxSZWNvdmVyZWRCbG9jazxOOjpCbG9jaz4+CiAgICB3aGVyZQogICAgICAgIE46OlNpZ25lZFR4OiBTaWduZWRUcmFuc2FjdGlvbiwKICAgIHsKICAgICAgICBzZWxmLnBlbmRpbmdfc3RhdGUoKS5tYXAofGJsb2NrX3N0YXRlfCBibG9ja19zdGF0ZS5ibG9ja19yZWYoKS5yZWNvdmVyZWRfYmxvY2soKS5jbG9uZSgpKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgdHVwbGUgd2l0aCB0aGUgYFNlYWxlZEJsb2NrYCBjb3JyZXNwb25kaW5nIHRvIHRoZSBwZW5kaW5nCiAgICAvLy8gc3RhdGUgYW5kIGEgdmVjdG9yIG9mIGl0cyBgUmVjZWlwdGBzLgogICAgcHViIGZuIHBlbmRpbmdfYmxvY2tfYW5kX3JlY2VpcHRzKCZzZWxmKSAtPiBPcHRpb248UGVuZGluZ0Jsb2NrQW5kUmVjZWlwdHM8Tj4+IHsKICAgICAgICBzZWxmLnBlbmRpbmdfc3RhdGUoKS5tYXAofGJsb2NrX3N0YXRlfCB7CiAgICAgICAgICAgICgKICAgICAgICAgICAgICAgIGJsb2NrX3N0YXRlLmJsb2NrX3JlZigpLnJlY292ZXJlZF9ibG9jaygpLmNsb25lKCksCiAgICAgICAgICAgICAgICBibG9ja19zdGF0ZS5leGVjdXRlZF9ibG9ja19yZWNlaXB0cygpLAogICAgICAgICAgICApCiAgICAgICAgfSkKICAgIH0KCiAgICAvLy8gU3Vic2NyaWJlIHRvIG5ldyBibG9ja3MgZXZlbnRzLgogICAgcHViIGZuIHN1YnNjcmliZV9jYW5vbl9zdGF0ZSgmc2VsZikgLT4gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbnM8Tj4gewogICAgICAgIHNlbGYuaW5uZXIuY2Fub25fc3RhdGVfbm90aWZpY2F0aW9uX3NlbmRlci5zdWJzY3JpYmUoKQogICAgfQoKICAgIC8vLyBTdWJzY3JpYmUgdG8gbmV3IHNhZmUgYmxvY2sgZXZlbnRzLgogICAgcHViIGZuIHN1YnNjcmliZV9zYWZlX2Jsb2NrKCZzZWxmKSAtPiB3YXRjaDo6UmVjZWl2ZXI8T3B0aW9uPFNlYWxlZEhlYWRlcjxOOjpCbG9ja0hlYWRlcj4+PiB7CiAgICAgICAgc2VsZi5pbm5lci5jaGFpbl9pbmZvX3RyYWNrZXIuc3Vic2NyaWJlX3NhZmVfYmxvY2soKQogICAgfQoKICAgIC8vLyBTdWJzY3JpYmUgdG8gbmV3IGZpbmFsaXplZCBibG9jayBldmVudHMuCiAgICBwdWIgZm4gc3Vic2NyaWJlX2ZpbmFsaXplZF9ibG9jaygKICAgICAgICAmc2VsZiwKICAgICkgLT4gd2F0Y2g6OlJlY2VpdmVyPE9wdGlvbjxTZWFsZWRIZWFkZXI8Tjo6QmxvY2tIZWFkZXI+Pj4gewogICAgICAgIHNlbGYuaW5uZXIuY2hhaW5faW5mb190cmFja2VyLnN1YnNjcmliZV9maW5hbGl6ZWRfYmxvY2soKQogICAgfQoKICAgIC8vLyBTdWJzY3JpYmUgdG8gbmV3IHBlcnNpc3RlZCBibG9jayBldmVudHMuCiAgICBwdWIgZm4gc3Vic2NyaWJlX3BlcnNpc3RlZF9ibG9jaygmc2VsZikgLT4gd2F0Y2g6OlJlY2VpdmVyPE9wdGlvbjxCbG9ja051bUhhc2g+PiB7CiAgICAgICAgc2VsZi5pbm5lci5jaGFpbl9pbmZvX3RyYWNrZXIuc3Vic2NyaWJlX3BlcnNpc3RlZF9ibG9jaygpCiAgICB9CgogICAgLy8vIEF0dGVtcHRzIHRvIHNlbmQgYSBuZXcgW2BDYW5vblN0YXRlTm90aWZpY2F0aW9uYF0gdG8gYWxsIGFjdGl2ZSBSZWNlaXZlciBoYW5kbGVzLgogICAgcHViIGZuIG5vdGlmeV9jYW5vbl9zdGF0ZSgmc2VsZiwgZXZlbnQ6IENhbm9uU3RhdGVOb3RpZmljYXRpb248Tj4pIHsKICAgICAgICBzZWxmLmlubmVyLmNhbm9uX3N0YXRlX25vdGlmaWNhdGlvbl9zZW5kZXIuc2VuZChldmVudCkub2soKTsKICAgIH0KCiAgICAvLy8gUmV0dXJuIHN0YXRlIHByb3ZpZGVyIHdpdGggcmVmZXJlbmNlIHRvIGluLW1lbW9yeSBibG9ja3MgdGhhdCBvdmVybGF5IGRhdGFiYXNlIHN0YXRlLgogICAgLy8vCiAgICAvLy8gVGhpcyBtZXJnZXMgdGhlIHN0YXRlIG9mIGFsbCBibG9ja3MgdGhhdCBhcmUgcGFydCBvZiB0aGUgY2hhaW4gdGhhdCB0aGUgcmVxdWVzdGVkIGJsb2NrIGlzCiAgICAvLy8gdGhlIGhlYWQgb2YuIFRoaXMgaW5jbHVkZXMgYWxsIGJsb2NrcyB0aGF0IGNvbm5lY3QgYmFjayB0byB0aGUgY2Fub25pY2FsIGJsb2NrIG9uIGRpc2suCiAgICBwdWIgZm4gc3RhdGVfcHJvdmlkZXIoCiAgICAgICAgJnNlbGYsCiAgICAgICAgaGFzaDogQjI1NiwKICAgICAgICBoaXN0b3JpY2FsOiBTdGF0ZVByb3ZpZGVyQm94LAogICAgKSAtPiBNZW1vcnlPdmVybGF5U3RhdGVQcm92aWRlcjxOPiB7CiAgICAgICAgbGV0IGluX21lbW9yeSA9IGlmIGxldCBTb21lKHN0YXRlKSA9IHNlbGYuc3RhdGVfYnlfaGFzaChoYXNoKSB7CiAgICAgICAgICAgIHN0YXRlLmNoYWluKCkubWFwKHxibG9ja19zdGF0ZXwgYmxvY2tfc3RhdGUuYmxvY2soKSkuY29sbGVjdCgpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgVmVjOjpuZXcoKQogICAgICAgIH07CgogICAgICAgIE1lbW9yeU92ZXJsYXlTdGF0ZVByb3ZpZGVyOjpuZXcoaGlzdG9yaWNhbCwgaW5fbWVtb3J5KQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGFuIGl0ZXJhdG9yIG92ZXIgYWxsIF9fY2Fub25pY2FsIGJsb2Nrc19fIGluIHRoZSBpbi1tZW1vcnkgc3RhdGUsIGZyb20gbmV3ZXN0IHRvCiAgICAvLy8gb2xkZXN0IChoaWdoZXN0IHRvIGxvd2VzdCkuCiAgICAvLy8KICAgIC8vLyBUaGlzIGl0ZXJhdG9yIGNvbnRhaW5zIGEgc25hcHNob3Qgb2YgdGhlIGluLW1lbW9yeSBzdGF0ZSBhdCB0aGUgdGltZSBvZiB0aGUgY2FsbC4KICAgIHB1YiBmbiBjYW5vbmljYWxfY2hhaW4oJnNlbGYpIC0+IGltcGwgSXRlcmF0b3I8SXRlbSA9IEFyYzxCbG9ja1N0YXRlPE4+Pj4gewogICAgICAgIHNlbGYuaW5uZXIuaW5fbWVtb3J5X3N0YXRlLmhlYWRfc3RhdGUoKS5pbnRvX2l0ZXIoKS5mbGF0X21hcCh8aGVhZHwgaGVhZC5pdGVyKCkpCiAgICB9CgogICAgLy8vIFJldHVybnMgW2BTaWduZWRUcmFuc2FjdGlvbmBdIHR5cGUgZm9yIHRoZSBnaXZlbiBgVHhIYXNoYCBpZiBmb3VuZC4KICAgIHB1YiBmbiB0cmFuc2FjdGlvbl9ieV9oYXNoKCZzZWxmLCBoYXNoOiBUeEhhc2gpIC0+IE9wdGlvbjxOOjpTaWduZWRUeD4gewogICAgICAgIGZvciBibG9ja19zdGF0ZSBpbiBzZWxmLmNhbm9uaWNhbF9jaGFpbigpIHsKICAgICAgICAgICAgaWYgbGV0IFNvbWUodHgpID0KICAgICAgICAgICAgICAgIGJsb2NrX3N0YXRlLmJsb2NrX3JlZigpLnJlY292ZXJlZF9ibG9jaygpLmJvZHkoKS50cmFuc2FjdGlvbl9ieV9oYXNoKCZoYXNoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gU29tZSh0eC5jbG9uZSgpKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIE5vbmUKICAgIH0KCiAgICAvLy8gUmV0dXJucyBhIHR1cGxlIHdpdGggW2BTaWduZWRUcmFuc2FjdGlvbmBdIHR5cGUgYW5kIFtgVHJhbnNhY3Rpb25NZXRhYF0gZm9yIHRoZQogICAgLy8vIGdpdmVuIFtgVHhIYXNoYF0gaWYgZm91bmQuCiAgICBwdWIgZm4gdHJhbnNhY3Rpb25fYnlfaGFzaF93aXRoX21ldGEoCiAgICAgICAgJnNlbGYsCiAgICAgICAgdHhfaGFzaDogVHhIYXNoLAogICAgKSAtPiBPcHRpb248KE46OlNpZ25lZFR4LCBUcmFuc2FjdGlvbk1ldGEpPiB7CiAgICAgICAgZm9yIGJsb2NrX3N0YXRlIGluIHNlbGYuY2Fub25pY2FsX2NoYWluKCkgewogICAgICAgICAgICBpZiBsZXQgU29tZShpbmRleGVkKSA9IGJsb2NrX3N0YXRlLmZpbmRfaW5kZXhlZCh0eF9oYXNoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU29tZSgoaW5kZXhlZC50eCgpLmNsb25lKCksIGluZGV4ZWQubWV0YSgpKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgTm9uZQogICAgfQp9CgovLy8gU3RhdGUgYWZ0ZXIgYXBwbHlpbmcgdGhlIGdpdmVuIGJsb2NrLCB0aGlzIGJsb2NrIGlzIHBhcnQgb2YgdGhlIGNhbm9uaWNhbCBjaGFpbiB0aGF0IHBhcnRpYWxseQovLy8gc3RvcmVkIGluIG1lbW9yeSBhbmQgY2FuIGJlIHRyYWNlZCBiYWNrIHRvIGEgY2Fub25pY2FsIGJsb2NrIG9uIGRpc2suCiNbZGVyaXZlKERlYnVnLCBDbG9uZSldCnB1YiBzdHJ1Y3QgQmxvY2tTdGF0ZTxOOiBOb2RlUHJpbWl0aXZlcyA9IEV0aFByaW1pdGl2ZXM+IHsKICAgIC8vLyBUaGUgZXhlY3V0ZWQgYmxvY2sgdGhhdCBkZXRlcm1pbmVzIHRoZSBzdGF0ZSBhZnRlciB0aGlzIGJsb2NrIGhhcyBiZWVuIGV4ZWN1dGVkLgogICAgYmxvY2s6IEV4ZWN1dGVkQmxvY2s8Tj4sCiAgICAvLy8gVGhlIGJsb2NrJ3MgcGFyZW50IGJsb2NrIGlmIGl0IGV4aXN0cy4KICAgIHBhcmVudDogT3B0aW9uPEFyYzxTZWxmPj4sCn0KCmltcGw8TjogTm9kZVByaW1pdGl2ZXM+IFBhcnRpYWxFcSBmb3IgQmxvY2tTdGF0ZTxOPiB7CiAgICBmbiBlcSgmc2VsZiwgb3RoZXI6ICZTZWxmKSAtPiBib29sIHsKICAgICAgICBzZWxmLmJsb2NrID09IG90aGVyLmJsb2NrICYmIHNlbGYucGFyZW50ID09IG90aGVyLnBhcmVudAogICAgfQp9CgppbXBsPE46IE5vZGVQcmltaXRpdmVzPiBCbG9ja1N0YXRlPE4+IHsKICAgIC8vLyBbYEJsb2NrU3RhdGVgXSBjb25zdHJ1Y3Rvci4KICAgIHB1YiBjb25zdCBmbiBuZXcoYmxvY2s6IEV4ZWN1dGVkQmxvY2s8Tj4pIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBibG9jaywgcGFyZW50OiBOb25lIH0KICAgIH0KCiAgICAvLy8gW2BCbG9ja1N0YXRlYF0gY29uc3RydWN0b3Igd2l0aCBwYXJlbnQuCiAgICBwdWIgY29uc3QgZm4gd2l0aF9wYXJlbnQoYmxvY2s6IEV4ZWN1dGVkQmxvY2s8Tj4sIHBhcmVudDogT3B0aW9uPEFyYzxTZWxmPj4pIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBibG9jaywgcGFyZW50IH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgaGFzaCBhbmQgYmxvY2sgb2YgdGhlIG9uIGRpc2sgYmxvY2sgdGhpcyBzdGF0ZSBjYW4gYmUgdHJhY2VkIGJhY2sgdG8uCiAgICBwdWIgZm4gYW5jaG9yKCZzZWxmKSAtPiBCbG9ja051bUhhc2ggewogICAgICAgIGxldCBtdXQgY3VycmVudCA9IHNlbGY7CiAgICAgICAgd2hpbGUgbGV0IFNvbWUocGFyZW50KSA9ICZjdXJyZW50LnBhcmVudCB7CiAgICAgICAgICAgIGN1cnJlbnQgPSBwYXJlbnQ7CiAgICAgICAgfQogICAgICAgIGN1cnJlbnQuYmxvY2sucmVjb3ZlcmVkX2Jsb2NrKCkucGFyZW50X251bV9oYXNoKCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgZXhlY3V0ZWQgYmxvY2sgdGhhdCBkZXRlcm1pbmVzIHRoZSBzdGF0ZS4KICAgIHB1YiBmbiBibG9jaygmc2VsZikgLT4gRXhlY3V0ZWRCbG9jazxOPiB7CiAgICAgICAgc2VsZi5ibG9jay5jbG9uZSgpCiAgICB9CgogICAgLy8vIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGV4ZWN1dGVkIGJsb2NrIHRoYXQgZGV0ZXJtaW5lcyB0aGUgc3RhdGUuCiAgICBwdWIgY29uc3QgZm4gYmxvY2tfcmVmKCZzZWxmKSAtPiAmRXhlY3V0ZWRCbG9jazxOPiB7CiAgICAgICAgJnNlbGYuYmxvY2sKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgaGFzaCBvZiBleGVjdXRlZCBibG9jayB0aGF0IGRldGVybWluZXMgdGhlIHN0YXRlLgogICAgcHViIGZuIGhhc2goJnNlbGYpIC0+IEIyNTYgewogICAgICAgIHNlbGYuYmxvY2sucmVjb3ZlcmVkX2Jsb2NrKCkuaGFzaCgpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGJsb2NrIG51bWJlciBvZiBleGVjdXRlZCBibG9jayB0aGF0IGRldGVybWluZXMgdGhlIHN0YXRlLgogICAgcHViIGZuIG51bWJlcigmc2VsZikgLT4gdTY0IHsKICAgICAgICBzZWxmLmJsb2NrLnJlY292ZXJlZF9ibG9jaygpLm51bWJlcigpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIHN0YXRlIHJvb3QgYWZ0ZXIgYXBwbHlpbmcgdGhlIGV4ZWN1dGVkIGJsb2NrIHRoYXQgZGV0ZXJtaW5lcwogICAgLy8vIHRoZSBzdGF0ZS4KICAgIHB1YiBmbiBzdGF0ZV9yb290KCZzZWxmKSAtPiBCMjU2IHsKICAgICAgICBzZWxmLmJsb2NrLnJlY292ZXJlZF9ibG9jaygpLnN0YXRlX3Jvb3QoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSBgUmVjZWlwdHNgIG9mIGV4ZWN1dGVkIGJsb2NrIHRoYXQgZGV0ZXJtaW5lcyB0aGUgc3RhdGUuCiAgICBwdWIgZm4gcmVjZWlwdHMoJnNlbGYpIC0+ICZWZWM8VmVjPE46OlJlY2VpcHQ+PiB7CiAgICAgICAgJnNlbGYuYmxvY2suZXhlY3V0aW9uX291dGNvbWUoKS5yZWNlaXB0cwogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgdmVjdG9yIG9mIGBSZWNlaXB0YCBvZiBleGVjdXRlZCBibG9jayB0aGF0IGRldGVybWluZXMgdGhlIHN0YXRlLgogICAgLy8vIFdlIGFzc3VtZSB0aGF0IHRoZSBgUmVjZWlwdHNgIGluIHRoZSBleGVjdXRlZCBibG9jayBgRXhlY3V0aW9uT3V0Y29tZWAKICAgIC8vLyBoYXMgb25seSBvbmUgZWxlbWVudCBjb3JyZXNwb25kaW5nIHRvIHRoZSBleGVjdXRlZCBibG9jayBhc3NvY2lhdGVkIHRvCiAgICAvLy8gdGhlIHN0YXRlLgogICAgLy8vCiAgICAvLy8gVGhpcyBjbG9uZXMgdGhlIHZlY3RvciBvZiByZWNlaXB0cy4gVG8gYXZvaWQgaXQsIHVzZSBbYFNlbGY6OmV4ZWN1dGVkX2Jsb2NrX3JlY2VpcHRzX3JlZmBdLgogICAgcHViIGZuIGV4ZWN1dGVkX2Jsb2NrX3JlY2VpcHRzKCZzZWxmKSAtPiBWZWM8Tjo6UmVjZWlwdD4gewogICAgICAgIGxldCByZWNlaXB0cyA9IHNlbGYucmVjZWlwdHMoKTsKCiAgICAgICAgZGVidWdfYXNzZXJ0ISgKICAgICAgICAgICAgcmVjZWlwdHMubGVuKCkgPD0gMSwKICAgICAgICAgICAgIkV4cGVjdGVkIGF0IG1vc3Qgb25lIGJsb2NrJ3Mgd29ydGggb2YgcmVjZWlwdHMsIGZvdW5kIHt9IiwKICAgICAgICAgICAgcmVjZWlwdHMubGVuKCkKICAgICAgICApOwoKICAgICAgICByZWNlaXB0cy5maXJzdCgpLmNsb25lZCgpLnVud3JhcF9vcl9kZWZhdWx0KCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyBhIHNsaWNlIG9mIGBSZWNlaXB0YCBvZiBleGVjdXRlZCBibG9jayB0aGF0IGRldGVybWluZXMgdGhlIHN0YXRlLgogICAgLy8vIFdlIGFzc3VtZSB0aGF0IHRoZSBgUmVjZWlwdHNgIGluIHRoZSBleGVjdXRlZCBibG9jayBgRXhlY3V0aW9uT3V0Y29tZWAKICAgIC8vLyBoYXMgb25seSBvbmUgZWxlbWVudCBjb3JyZXNwb25kaW5nIHRvIHRoZSBleGVjdXRlZCBibG9jayBhc3NvY2lhdGVkIHRvCiAgICAvLy8gdGhlIHN0YXRlLgogICAgcHViIGZuIGV4ZWN1dGVkX2Jsb2NrX3JlY2VpcHRzX3JlZigmc2VsZikgLT4gJltOOjpSZWNlaXB0XSB7CiAgICAgICAgbGV0IHJlY2VpcHRzID0gc2VsZi5yZWNlaXB0cygpOwoKICAgICAgICBkZWJ1Z19hc3NlcnQhKAogICAgICAgICAgICByZWNlaXB0cy5sZW4oKSA8PSAxLAogICAgICAgICAgICAiRXhwZWN0ZWQgYXQgbW9zdCBvbmUgYmxvY2sncyB3b3J0aCBvZiByZWNlaXB0cywgZm91bmQge30iLAogICAgICAgICAgICByZWNlaXB0cy5sZW4oKQogICAgICAgICk7CgogICAgICAgIHJlY2VpcHRzLmZpcnN0KCkubWFwKHxyZWNlaXB0c3wgcmVjZWlwdHMuZGVyZWYoKSkudW53cmFwX29yX2RlZmF1bHQoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGFuIGl0ZXJhdG9yIG92ZXIgX19wYXJlbnRfXyBgQmxvY2tTdGF0ZXNgLgogICAgLy8vCiAgICAvLy8gVGhlIGJsb2NrIHN0YXRlIG9yZGVyIGlzIG5ld2VzdCB0byBvbGRlc3QgKGhpZ2hlc3QgdG8gbG93ZXN0KToKICAgIC8vLyBgWzUsNCwzLDIsMV1gCiAgICAvLy8KICAgIC8vLyBOb3RlOiBUaGlzIGRvZXMgbm90IGluY2x1ZGUgc2VsZi4KICAgIHB1YiBmbiBwYXJlbnRfc3RhdGVfY2hhaW4oJnNlbGYpIC0+IGltcGwgSXRlcmF0b3I8SXRlbSA9ICZTZWxmPiArICdfIHsKICAgICAgICBzdGQ6Oml0ZXI6OnN1Y2Nlc3NvcnMoc2VsZi5wYXJlbnQuYXNfZGVyZWYoKSwgfHN0YXRlfCBzdGF0ZS5wYXJlbnQuYXNfZGVyZWYoKSkKICAgIH0KCiAgICAvLy8gUmV0dXJucyBhIHZlY3RvciBvZiBgQmxvY2tTdGF0ZXNgIHJlcHJlc2VudGluZyB0aGUgZW50aXJlIGluIG1lbW9yeSBjaGFpbi4KICAgIC8vLyBUaGUgYmxvY2sgc3RhdGUgb3JkZXIgaW4gdGhlIG91dHB1dCB2ZWN0b3IgaXMgbmV3ZXN0IHRvIG9sZGVzdCAoaGlnaGVzdCB0byBsb3dlc3QpLAogICAgLy8vIGluY2x1ZGluZyBzZWxmIGFzIHRoZSBmaXJzdCBlbGVtZW50LgogICAgcHViIGZuIGNoYWluKCZzZWxmKSAtPiBpbXBsIEl0ZXJhdG9yPEl0ZW0gPSAmU2VsZj4gewogICAgICAgIHN0ZDo6aXRlcjo6c3VjY2Vzc29ycyhTb21lKHNlbGYpLCB8c3RhdGV8IHN0YXRlLnBhcmVudC5hc19kZXJlZigpKQogICAgfQoKICAgIC8vLyBBcHBlbmRzIHRoZSBwYXJlbnQgY2hhaW4gb2YgdGhpcyBbYEJsb2NrU3RhdGVgXSB0byB0aGUgZ2l2ZW4gdmVjdG9yLgogICAgLy8vCiAgICAvLy8gUGFyZW50cyBhcmUgYXBwZW5kZWQgaW4gb3JkZXIgZnJvbSBuZXdlc3QgdG8gb2xkZXN0IChoaWdoZXN0IHRvIGxvd2VzdCkuCiAgICAvLy8gVGhpcyBkb2VzIG5vdCBpbmNsdWRlIHNlbGYsIG9ubHkgdGhlIHBhcmVudCBzdGF0ZXMuCiAgICAvLy8KICAgIC8vLyBUaGlzIGlzIGEgY29udmVuaWVuY2UgbWV0aG9kIGVxdWl2YWxlbnQgdG8gYGNoYWluLmV4dGVuZChzZWxmLnBhcmVudF9zdGF0ZV9jaGFpbigpKWAuCiAgICBwdWIgZm4gYXBwZW5kX3BhcmVudF9jaGFpbjwnYT4oJidhIHNlbGYsIGNoYWluOiAmbXV0IFZlYzwmJ2EgU2VsZj4pIHsKICAgICAgICBjaGFpbi5leHRlbmQoc2VsZi5wYXJlbnRfc3RhdGVfY2hhaW4oKSk7CiAgICB9CgogICAgLy8vIFJldHVybnMgYW4gaXRlcmF0b3Igb3ZlciB0aGUgYXRvbWljYWxseSBjYXB0dXJlZCBjaGFpbiBvZiBpbiBtZW1vcnkgYmxvY2tzLgogICAgLy8vCiAgICAvLy8gVGhpcyB5aWVsZHMgdGhlIGJsb2NrcyBmcm9tIG5ld2VzdCB0byBvbGRlc3QgKGhpZ2hlc3QgdG8gbG93ZXN0KS4KICAgIHB1YiBmbiBpdGVyKHNlbGY6IEFyYzxTZWxmPikgLT4gaW1wbCBJdGVyYXRvcjxJdGVtID0gQXJjPFNlbGY+PiB7CiAgICAgICAgc3RkOjppdGVyOjpzdWNjZXNzb3JzKFNvbWUoc2VsZiksIHxzdGF0ZXwgc3RhdGUucGFyZW50LmNsb25lKCkpCiAgICB9CgogICAgLy8vIFJldHVybiBzdGF0ZSBwcm92aWRlciB3aXRoIHJlZmVyZW5jZSB0byBpbi1tZW1vcnkgYmxvY2tzIHRoYXQgb3ZlcmxheSBkYXRhYmFzZSBzdGF0ZS4KICAgIC8vLwogICAgLy8vIFRoaXMgbWVyZ2VzIHRoZSBzdGF0ZSBvZiBhbGwgYmxvY2tzIHRoYXQgYXJlIHBhcnQgb2YgdGhlIGNoYWluIHRoYXQgdGhlIHRoaXMgYmxvY2sgaXMKICAgIC8vLyB0aGUgaGVhZCBvZi4gVGhpcyBpbmNsdWRlcyBhbGwgYmxvY2tzIHRoYXQgY29ubmVjdCBiYWNrIHRvIHRoZSBjYW5vbmljYWwgYmxvY2sgb24gZGlzay4KICAgIHB1YiBmbiBzdGF0ZV9wcm92aWRlcigmc2VsZiwgaGlzdG9yaWNhbDogU3RhdGVQcm92aWRlckJveCkgLT4gTWVtb3J5T3ZlcmxheVN0YXRlUHJvdmlkZXI8Tj4gewogICAgICAgIGxldCBpbl9tZW1vcnkgPSBzZWxmLmNoYWluKCkubWFwKHxibG9ja19zdGF0ZXwgYmxvY2tfc3RhdGUuYmxvY2soKSkuY29sbGVjdCgpOwoKICAgICAgICBNZW1vcnlPdmVybGF5U3RhdGVQcm92aWRlcjo6bmV3KGhpc3RvcmljYWwsIGluX21lbW9yeSkKICAgIH0KCiAgICAvLy8gVHJpZXMgdG8gZmluZCBhIGJsb2NrIGJ5IFtgQmxvY2tIYXNoT3JOdW1iZXJgXSBpbiB0aGUgY2hhaW4gZW5kaW5nIGF0IHRoaXMgYmxvY2suCiAgICBwdWIgZm4gYmxvY2tfb25fY2hhaW4oJnNlbGYsIGhhc2hfb3JfbnVtOiBCbG9ja0hhc2hPck51bWJlcikgLT4gT3B0aW9uPCZTZWxmPiB7CiAgICAgICAgc2VsZi5jaGFpbigpLmZpbmQofGJsb2NrfCBtYXRjaCBoYXNoX29yX251bSB7CiAgICAgICAgICAgIEJsb2NrSGFzaE9yTnVtYmVyOjpIYXNoKGhhc2gpID0+IGJsb2NrLmhhc2goKSA9PSBoYXNoLAogICAgICAgICAgICBCbG9ja0hhc2hPck51bWJlcjo6TnVtYmVyKG51bWJlcikgPT4gYmxvY2subnVtYmVyKCkgPT0gbnVtYmVyLAogICAgICAgIH0pCiAgICB9CgogICAgLy8vIFRyaWVzIHRvIGZpbmQgYSB0cmFuc2FjdGlvbiBieSBbYFR4SGFzaGBdIGluIHRoZSBjaGFpbiBlbmRpbmcgYXQgdGhpcyBibG9jay4KICAgIHB1YiBmbiB0cmFuc2FjdGlvbl9vbl9jaGFpbigmc2VsZiwgaGFzaDogVHhIYXNoKSAtPiBPcHRpb248Tjo6U2lnbmVkVHg+IHsKICAgICAgICBzZWxmLmNoYWluKCkuZmluZF9tYXAofGJsb2NrX3N0YXRlfCB7CiAgICAgICAgICAgIGJsb2NrX3N0YXRlLmJsb2NrX3JlZigpLnJlY292ZXJlZF9ibG9jaygpLmJvZHkoKS50cmFuc2FjdGlvbl9ieV9oYXNoKCZoYXNoKS5jbG9uZWQoKQogICAgICAgIH0pCiAgICB9CgogICAgLy8vIFRyaWVzIHRvIGZpbmQgYSB0cmFuc2FjdGlvbiB3aXRoIG1ldGEgYnkgW2BUeEhhc2hgXSBpbiB0aGUgY2hhaW4gZW5kaW5nIGF0IHRoaXMgYmxvY2suCiAgICBwdWIgZm4gdHJhbnNhY3Rpb25fbWV0YV9vbl9jaGFpbigKICAgICAgICAmc2VsZiwKICAgICAgICB0eF9oYXNoOiBUeEhhc2gsCiAgICApIC0+IE9wdGlvbjwoTjo6U2lnbmVkVHgsIFRyYW5zYWN0aW9uTWV0YSk+IHsKICAgICAgICBzZWxmLmNoYWluKCkuZmluZF9tYXAofGJsb2NrX3N0YXRlfCB7CiAgICAgICAgICAgIGJsb2NrX3N0YXRlLmZpbmRfaW5kZXhlZCh0eF9oYXNoKS5tYXAofGluZGV4ZWR8IChpbmRleGVkLnR4KCkuY2xvbmUoKSwgaW5kZXhlZC5tZXRhKCkpKQogICAgICAgIH0pCiAgICB9CgogICAgLy8vIEZpbmRzIGEgdHJhbnNhY3Rpb24gYnkgaGFzaCBhbmQgcmV0dXJucyBpdCB3aXRoIGl0cyBpbmRleCBhbmQgYmxvY2sgY29udGV4dC4KICAgIHB1YiBmbiBmaW5kX2luZGV4ZWQoJnNlbGYsIHR4X2hhc2g6IFR4SGFzaCkgLT4gT3B0aW9uPEluZGV4ZWRUeDwnXywgTjo6QmxvY2s+PiB7CiAgICAgICAgc2VsZi5ibG9ja19yZWYoKS5yZWNvdmVyZWRfYmxvY2soKS5maW5kX2luZGV4ZWQodHhfaGFzaCkKICAgIH0KfQoKLy8vIFJlcHJlc2VudHMgYW4gZXhlY3V0ZWQgYmxvY2sgc3RvcmVkIGluLW1lbW9yeS4KI1tkZXJpdmUoQ2xvbmUsIERlYnVnKV0KcHViIHN0cnVjdCBFeGVjdXRlZEJsb2NrPE46IE5vZGVQcmltaXRpdmVzID0gRXRoUHJpbWl0aXZlcz4gewogICAgLy8vIFJlY292ZXJlZCBCbG9jawogICAgcHViIHJlY292ZXJlZF9ibG9jazogQXJjPFJlY292ZXJlZEJsb2NrPE46OkJsb2NrPj4sCiAgICAvLy8gQmxvY2sncyBleGVjdXRpb24gb3V0Y29tZS4KICAgIHB1YiBleGVjdXRpb25fb3V0cHV0OiBBcmM8RXhlY3V0aW9uT3V0Y29tZTxOOjpSZWNlaXB0Pj4sCiAgICAvLy8gRGVmZXJyZWQgdHJpZSBkYXRhIHByb2R1Y2VkIGJ5IGV4ZWN1dGlvbi4KICAgIC8vLwogICAgLy8vIFRoaXMgYWxsb3dzIGRlZmVycmluZyB0aGUgY29tcHV0YXRpb24gb2YgdGhlIHRyaWUgZGF0YSB3aGljaCBjYW4gYmUgZXhwZW5zaXZlLgogICAgLy8vIFRoZSBkYXRhIGNhbiBiZSBwb3B1bGF0ZWQgYXN5bmNocm9ub3VzbHkgYWZ0ZXIgdGhlIGJsb2NrIHdhcyB2YWxpZGF0ZWQuCiAgICBwdWIgdHJpZV9kYXRhOiBEZWZlcnJlZFRyaWVEYXRhLAp9CgppbXBsPE46IE5vZGVQcmltaXRpdmVzPiBEZWZhdWx0IGZvciBFeGVjdXRlZEJsb2NrPE4+IHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgcmVjb3ZlcmVkX2Jsb2NrOiBEZWZhdWx0OjpkZWZhdWx0KCksCiAgICAgICAgICAgIGV4ZWN1dGlvbl9vdXRwdXQ6IERlZmF1bHQ6OmRlZmF1bHQoKSwKICAgICAgICAgICAgdHJpZV9kYXRhOiBEZWZlcnJlZFRyaWVEYXRhOjpyZWFkeShDb21wdXRlZFRyaWVEYXRhOjpkZWZhdWx0KCkpLAogICAgICAgIH0KICAgIH0KfQoKaW1wbDxOOiBOb2RlUHJpbWl0aXZlcz4gUGFydGlhbEVxIGZvciBFeGVjdXRlZEJsb2NrPE4+IHsKICAgIGZuIGVxKCZzZWxmLCBvdGhlcjogJlNlbGYpIC0+IGJvb2wgewogICAgICAgIC8vIFRyaWUgZGF0YSBpcyBjb21wdXRlZCBhc3luY2hyb25vdXNseSBhbmQgZG9lc24ndCBkZWZpbmUgYmxvY2sgaWRlbnRpdHkuCiAgICAgICAgc2VsZi5yZWNvdmVyZWRfYmxvY2sgPT0gb3RoZXIucmVjb3ZlcmVkX2Jsb2NrICYmCiAgICAgICAgICAgIHNlbGYuZXhlY3V0aW9uX291dHB1dCA9PSBvdGhlci5leGVjdXRpb25fb3V0cHV0CiAgICB9Cn0KCmltcGw8TjogTm9kZVByaW1pdGl2ZXM+IEV4ZWN1dGVkQmxvY2s8Tj4gewogICAgLy8vIENyZWF0ZSBhIG5ldyBbYEV4ZWN1dGVkQmxvY2tgXSB3aXRoIGFscmVhZHktY29tcHV0ZWQgdHJpZSBkYXRhLgogICAgLy8vCiAgICAvLy8gVXNlIHRoaXMgY29uc3RydWN0b3Igd2hlbiB0cmllIGRhdGEgaXMgYXZhaWxhYmxlIGltbWVkaWF0ZWx5IChlLmcuLCBzZXF1ZW5jZXJzLAogICAgLy8vIHBheWxvYWQgYnVpbGRlcnMpLiBUaGlzIGlzIHRoZSBzYWZlIGRlZmF1bHQgcGF0aC4KICAgIHB1YiBmbiBuZXcoCiAgICAgICAgcmVjb3ZlcmVkX2Jsb2NrOiBBcmM8UmVjb3ZlcmVkQmxvY2s8Tjo6QmxvY2s+PiwKICAgICAgICBleGVjdXRpb25fb3V0cHV0OiBBcmM8RXhlY3V0aW9uT3V0Y29tZTxOOjpSZWNlaXB0Pj4sCiAgICAgICAgdHJpZV9kYXRhOiBDb21wdXRlZFRyaWVEYXRhLAogICAgKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgcmVjb3ZlcmVkX2Jsb2NrLCBleGVjdXRpb25fb3V0cHV0LCB0cmllX2RhdGE6IERlZmVycmVkVHJpZURhdGE6OnJlYWR5KHRyaWVfZGF0YSkgfQogICAgfQoKICAgIC8vLyBDcmVhdGUgYSBuZXcgW2BFeGVjdXRlZEJsb2NrYF0gd2l0aCBkZWZlcnJlZCB0cmllIGRhdGEuCiAgICAvLy8KICAgIC8vLyBUaGlzIGlzIHVzZWZ1bCBpZiB0aGUgdHJpZSBkYXRhIGlzIHBvcHVsYXRlZCBzb21ld2hlcmUgZWxzZSwgZS5nLiBhc3luY2hyb25vdXNseQogICAgLy8vIGFmdGVyIHRoZSBibG9jayB3YXMgdmFsaWRhdGVkLgogICAgLy8vCiAgICAvLy8gVGhlIFtgRGVmZXJyZWRUcmllRGF0YWBdIGhhbmRsZSBhbGxvd3MgZXhwZW5zaXZlIHRyaWUgb3BlcmF0aW9ucyAoc29ydGluZyBoYXNoZWQgc3RhdGUsCiAgICAvLy8gc29ydGluZyB0cmllIHVwZGF0ZXMsIGFuZCBidWlsZGluZyB0aGUgYWNjdW11bGF0ZWQgdHJpZSBpbnB1dCBvdmVybGF5KSB0byBiZSBwZXJmb3JtZWQKICAgIC8vLyBvdXRzaWRlIHRoZSBjcml0aWNhbCB2YWxpZGF0aW9uIHBhdGguIFRoaXMgY2FuIGltcHJvdmUgbGF0ZW5jeSBmb3IgdGltZS1zZW5zaXRpdmUKICAgIC8vLyBvcGVyYXRpb25zIGxpa2UgYmxvY2sgdmFsaWRhdGlvbi4KICAgIC8vLwogICAgLy8vIElmIHRoZSBkYXRhIGhhc24ndCBiZWVuIHBvcHVsYXRlZCB3aGVuIFtgU2VsZjo6dHJpZV9kYXRhKClgXSBpcyBjYWxsZWQsIGNvbXB1dGF0aW9uCiAgICAvLy8gb2NjdXJzIHN5bmNocm9ub3VzbHkgZnJvbSBzdG9yZWQgaW5wdXRzLCBzbyB0aGVyZSBpcyBubyBibG9ja2luZyBvciBkZWFkbG9jayByaXNrLgogICAgLy8vCiAgICAvLy8gVXNlIFtgU2VsZjo6bmV3KClgXSBpbnN0ZWFkIHdoZW4gdHJpZSBkYXRhIGlzIGFscmVhZHkgY29tcHV0ZWQgYW5kIGF2YWlsYWJsZSBpbW1lZGlhdGVseS4KICAgIHB1YiBjb25zdCBmbiB3aXRoX2RlZmVycmVkX3RyaWVfZGF0YSgKICAgICAgICByZWNvdmVyZWRfYmxvY2s6IEFyYzxSZWNvdmVyZWRCbG9jazxOOjpCbG9jaz4+LAogICAgICAgIGV4ZWN1dGlvbl9vdXRwdXQ6IEFyYzxFeGVjdXRpb25PdXRjb21lPE46OlJlY2VpcHQ+PiwKICAgICAgICB0cmllX2RhdGE6IERlZmVycmVkVHJpZURhdGEsCiAgICApIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyByZWNvdmVyZWRfYmxvY2ssIGV4ZWN1dGlvbl9vdXRwdXQsIHRyaWVfZGF0YSB9CiAgICB9CgogICAgLy8vIFJldHVybnMgYSByZWZlcmVuY2UgdG8gYW4gaW5uZXIgW2BTZWFsZWRCbG9ja2BdCiAgICAjW2lubGluZV0KICAgIHB1YiBmbiBzZWFsZWRfYmxvY2soJnNlbGYpIC0+ICZTZWFsZWRCbG9jazxOOjpCbG9jaz4gewogICAgICAgIHNlbGYucmVjb3ZlcmVkX2Jsb2NrLnNlYWxlZF9ibG9jaygpCiAgICB9CgogICAgLy8vIFJldHVybnMgYSByZWZlcmVuY2UgdG8gW2BSZWNvdmVyZWRCbG9ja2BdCiAgICAjW2lubGluZV0KICAgIHB1YiBmbiByZWNvdmVyZWRfYmxvY2soJnNlbGYpIC0+ICZSZWNvdmVyZWRCbG9jazxOOjpCbG9jaz4gewogICAgICAgICZzZWxmLnJlY292ZXJlZF9ibG9jawogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBibG9jaydzIGV4ZWN1dGlvbiBvdXRjb21lCiAgICAjW2lubGluZV0KICAgIHB1YiBmbiBleGVjdXRpb25fb3V0Y29tZSgmc2VsZikgLT4gJkV4ZWN1dGlvbk91dGNvbWU8Tjo6UmVjZWlwdD4gewogICAgICAgICZzZWxmLmV4ZWN1dGlvbl9vdXRwdXQKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgdHJpZSBkYXRhLCBjb21wdXRpbmcgaXQgc3luY2hyb25vdXNseSBpZiBub3QgYWxyZWFkeSBjYWNoZWQuCiAgICAvLy8KICAgIC8vLyBVc2VzIGBPbmNlTG9jazo6Z2V0X29yX2luaXRgIGludGVybmFsbHk6CiAgICAvLy8gLSBJZiBhbHJlYWR5IGNvbXB1dGVkOiByZXR1cm5zIGNhY2hlZCByZXN1bHQgaW1tZWRpYXRlbHkKICAgIC8vLyAtIElmIG5vdCBjb21wdXRlZDogZmlyc3QgY2FsbGVyIGNvbXB1dGVzLCBvdGhlcnMgd2FpdCBmb3IgdGhhdCByZXN1bHQKICAgICNbaW5saW5lXQogICAgI1t0cmFjaW5nOjppbnN0cnVtZW50KGxldmVsID0gImRlYnVnIiwgdGFyZ2V0ID0gImVuZ2luZTo6dHJlZSIsIG5hbWUgPSAidHJpZV9kYXRhIiwgc2tpcF9hbGwpXQogICAgcHViIGZuIHRyaWVfZGF0YSgmc2VsZikgLT4gQ29tcHV0ZWRUcmllRGF0YSB7CiAgICAgICAgc2VsZi50cmllX2RhdGEud2FpdF9jbG9uZWQoKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGEgY2xvbmUgb2YgdGhlIGRlZmVycmVkIHRyaWUgZGF0YSBoYW5kbGUuCiAgICAvLy8KICAgIC8vLyBBIGhhbmRsZSBpcyBhIGxpZ2h0d2VpZ2h0IHJlZmVyZW5jZSB0aGF0IGNhbiBiZSBwYXNzZWQgdG8gZGVzY2VuZGFudHMgd2l0aG91dAogICAgLy8vIGZvcmNpbmcgdHJpZSBkYXRhIHRvIGJlIGNvbXB1dGVkIGltbWVkaWF0ZWx5LiBUaGUgYWN0dWFsIHdvcmsgcnVucyB3aGVuCiAgICAvLy8gYHdhaXRfY2xvbmVkKClgIGlzIGNhbGxlZCBieSBhIGNvbnN1bWVyIChlLmcuIHdoZW4gbWVyZ2luZyBvdmVybGF5cykuCiAgICAjW2lubGluZV0KICAgIHB1YiBmbiB0cmllX2RhdGFfaGFuZGxlKCZzZWxmKSAtPiBEZWZlcnJlZFRyaWVEYXRhIHsKICAgICAgICBzZWxmLnRyaWVfZGF0YS5jbG9uZSgpCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGhhc2hlZCBzdGF0ZSByZXN1bHQgb2YgdGhlIGV4ZWN1dGlvbiBvdXRjb21lLgogICAgLy8vCiAgICAvLy8gTWF5IGNvbXB1dGUgdHJpZSBkYXRhIHN5bmNocm9ub3VzbHkgaWYgdGhlIGRlZmVycmVkIHRhc2sgaGFzbid0IGNvbXBsZXRlZC4KICAgICNbaW5saW5lXQogICAgcHViIGZuIGhhc2hlZF9zdGF0ZSgmc2VsZikgLT4gQXJjPEhhc2hlZFBvc3RTdGF0ZVNvcnRlZD4gewogICAgICAgIHNlbGYudHJpZV9kYXRhKCkuaGFzaGVkX3N0YXRlCiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIHRyaWUgdXBkYXRlcyByZXN1bHRpbmcgZnJvbSB0aGUgZXhlY3V0aW9uIG91dGNvbWUuCiAgICAvLy8KICAgIC8vLyBNYXkgY29tcHV0ZSB0cmllIGRhdGEgc3luY2hyb25vdXNseSBpZiB0aGUgZGVmZXJyZWQgdGFzayBoYXNuJ3QgY29tcGxldGVkLgogICAgI1tpbmxpbmVdCiAgICBwdWIgZm4gdHJpZV91cGRhdGVzKCZzZWxmKSAtPiBBcmM8VHJpZVVwZGF0ZXNTb3J0ZWQ+IHsKICAgICAgICBzZWxmLnRyaWVfZGF0YSgpLnRyaWVfdXBkYXRlcwogICAgfQoKICAgIC8vLyBSZXR1cm5zIHRoZSB0cmllIGlucHV0IGFuY2hvcmVkIHRvIHRoZSBwZXJzaXN0ZWQgYW5jZXN0b3IuCiAgICAvLy8KICAgIC8vLyBNYXkgY29tcHV0ZSB0cmllIGRhdGEgc3luY2hyb25vdXNseSBpZiB0aGUgZGVmZXJyZWQgdGFzayBoYXNuJ3QgY29tcGxldGVkLgogICAgI1tpbmxpbmVdCiAgICBwdWIgZm4gdHJpZV9pbnB1dCgmc2VsZikgLT4gT3B0aW9uPEFyYzxUcmllSW5wdXRTb3J0ZWQ+PiB7CiAgICAgICAgc2VsZi50cmllX2RhdGEoKS50cmllX2lucHV0KCkuY2xvbmVkKCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyB0aGUgYW5jaG9yIGhhc2ggb2YgdGhlIHRyaWUgaW5wdXQsIGlmIHByZXNlbnQuCiAgICAjW2lubGluZV0KICAgIHB1YiBmbiBhbmNob3JfaGFzaCgmc2VsZikgLT4gT3B0aW9uPEIyNTY+IHsKICAgICAgICBzZWxmLnRyaWVfZGF0YSgpLmFuY2hvcl9oYXNoKCkKICAgIH0KCiAgICAvLy8gUmV0dXJucyBhIFtgQmxvY2tOdW1iZXJgXSBvZiB0aGUgYmxvY2suCiAgICAjW2lubGluZV0KICAgIHB1YiBmbiBibG9ja19udW1iZXIoJnNlbGYpIC0+IEJsb2NrTnVtYmVyIHsKICAgICAgICBzZWxmLnJlY292ZXJlZF9ibG9jay5oZWFkZXIoKS5udW1iZXIoKQogICAgfQp9CgovLy8gTm9uLWVtcHR5IGNoYWluIG9mIGJsb2Nrcy4KI1tkZXJpdmUoRGVidWcpXQpwdWIgZW51bSBOZXdDYW5vbmljYWxDaGFpbjxOOiBOb2RlUHJpbWl0aXZlcyA9IEV0aFByaW1pdGl2ZXM+IHsKICAgIC8vLyBBIHNpbXBsZSBhcHBlbmQgdG8gdGhlIGN1cnJlbnQgY2Fub25pY2FsIGhlYWQKICAgIENvbW1pdCB7CiAgICAgICAgLy8vIGFsbCBibG9ja3MgdGhhdCBsZWFkIGJhY2sgdG8gdGhlIGNhbm9uaWNhbCBoZWFkCiAgICAgICAgbmV3OiBWZWM8RXhlY3V0ZWRCbG9jazxOPj4sCiAgICB9LAogICAgLy8vIEEgcmVvcmdlZCBjaGFpbiBjb25zaXN0cyBvZiB0d28gY2hhaW5zIHRoYXQgdHJhY2UgYmFjayB0byBhIHNoYXJlZCBhbmNlc3RvciBibG9jayBhdCB3aGljaAogICAgLy8vIHBvaW50IHRoZXkgZGl2ZXJnZS4KICAgIFJlb3JnIHsKICAgICAgICAvLy8gQWxsIGJsb2NrcyBvZiB0aGUgX25ld18gY2hhaW4KICAgICAgICBuZXc6IFZlYzxFeGVjdXRlZEJsb2NrPE4+PiwKICAgICAgICAvLy8gQWxsIGJsb2NrcyBvZiB0aGUgX29sZF8gY2hhaW4KICAgICAgICBvbGQ6IFZlYzxFeGVjdXRlZEJsb2NrPE4+PiwKICAgIH0sCn0KCmltcGw8TjogTm9kZVByaW1pdGl2ZXM8U2lnbmVkVHg6IFNpZ25lZFRyYW5zYWN0aW9uPj4gTmV3Q2Fub25pY2FsQ2hhaW48Tj4gewogICAgLy8vIFJldHVybnMgdGhlIGxlbmd0aCBvZiB0aGUgbmV3IGNoYWluLgogICAgcHViIGNvbnN0IGZuIG5ld19ibG9ja19jb3VudCgmc2VsZikgLT4gdXNpemUgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpDb21taXQgeyBuZXcgfSB8IFNlbGY6OlJlb3JnIHsgbmV3LCAuLiB9ID0+IG5ldy5sZW4oKSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIGxlbmd0aCBvZiB0aGUgcmVvcmdlZCBjaGFpbi4KICAgIHB1YiBjb25zdCBmbiByZW9yZ2VkX2Jsb2NrX2NvdW50KCZzZWxmKSAtPiB1c2l6ZSB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkNvbW1pdCB7IC4uIH0gPT4gMCwKICAgICAgICAgICAgU2VsZjo6UmVvcmcgeyBvbGQsIC4uIH0gPT4gb2xkLmxlbigpLAogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQ29udmVydHMgdGhlIG5ldyBjaGFpbiBpbnRvIGEgbm90aWZpY2F0aW9uIHRoYXQgd2lsbCBiZSBlbWl0dGVkIHRvIGxpc3RlbmVycwogICAgcHViIGZuIHRvX2NoYWluX25vdGlmaWNhdGlvbigmc2VsZikgLT4gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbjxOPiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkNvbW1pdCB7IG5ldyB9ID0+IHsKICAgICAgICAgICAgICAgIENhbm9uU3RhdGVOb3RpZmljYXRpb246OkNvbW1pdCB7IG5ldzogQXJjOjpuZXcoU2VsZjo6YmxvY2tzX3RvX2NoYWluKG5ldykpIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBTZWxmOjpSZW9yZyB7IG5ldywgb2xkIH0gPT4gQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbjo6UmVvcmcgewogICAgICAgICAgICAgICAgbmV3OiBBcmM6Om5ldyhTZWxmOjpibG9ja3NfdG9fY2hhaW4obmV3KSksCiAgICAgICAgICAgICAgICBvbGQ6IEFyYzo6bmV3KFNlbGY6OmJsb2Nrc190b19jaGFpbihvbGQpKSwKICAgICAgICAgICAgfSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIENvbnZlcnRzIGEgc2xpY2Ugb2YgZXhlY3V0ZWQgYmxvY2tzIGludG8gYSBbYENoYWluYF0uCiAgICBmbiBibG9ja3NfdG9fY2hhaW4oYmxvY2tzOiAmW0V4ZWN1dGVkQmxvY2s8Tj5dKSAtPiBDaGFpbjxOPiB7CiAgICAgICAgbWF0Y2ggYmxvY2tzIHsKICAgICAgICAgICAgW10gPT4gQ2hhaW46OmRlZmF1bHQoKSwKICAgICAgICAgICAgW2ZpcnN0LCByZXN0IEAgLi5dID0+IHsKICAgICAgICAgICAgICAgIGxldCBtdXQgY2hhaW4gPSBDaGFpbjo6ZnJvbV9ibG9jaygKICAgICAgICAgICAgICAgICAgICBmaXJzdC5yZWNvdmVyZWRfYmxvY2soKS5jbG9uZSgpLAogICAgICAgICAgICAgICAgICAgIGZpcnN0LmV4ZWN1dGlvbl9vdXRjb21lKCkuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBmaXJzdC50cmllX3VwZGF0ZXMoKSwKICAgICAgICAgICAgICAgICAgICBmaXJzdC5oYXNoZWRfc3RhdGUoKSwKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBmb3IgZXhlYyBpbiByZXN0IHsKICAgICAgICAgICAgICAgICAgICBjaGFpbi5hcHBlbmRfYmxvY2soCiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWMucmVjb3ZlcmVkX2Jsb2NrKCkuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZXhlYy5leGVjdXRpb25fb3V0Y29tZSgpLmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWMudHJpZV91cGRhdGVzKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWMuaGFzaGVkX3N0YXRlKCksCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoYWluCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIG5ldyB0aXAgb2YgdGhlIGNoYWluLgogICAgLy8vCiAgICAvLy8gUmV0dXJucyB0aGUgbmV3IHRpcCBmb3IgW2BTZWxmOjpSZW9yZ2BdIGFuZCBbYFNlbGY6OkNvbW1pdGBdIHZhcmlhbnRzIHdoaWNoIGNvbW1pdCBhdCBsZWFzdAogICAgLy8vIDEgbmV3IGJsb2NrLgogICAgcHViIGZuIHRpcCgmc2VsZikgLT4gJlNlYWxlZEJsb2NrPE46OkJsb2NrPiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkNvbW1pdCB7IG5ldyB9IHwgU2VsZjo6UmVvcmcgeyBuZXcsIC4uIH0gPT4gewogICAgICAgICAgICAgICAgbmV3Lmxhc3QoKS5leHBlY3QoIm5vbiBlbXB0eSBibG9ja3MiKS5yZWNvdmVyZWRfYmxvY2soKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgojW2NmZyh0ZXN0KV0KbW9kIHRlc3RzIHsKICAgIHVzZSBzdXBlcjo6KjsKICAgIHVzZSBjcmF0ZTo6dGVzdF91dGlsczo6VGVzdEJsb2NrQnVpbGRlcjsKICAgIHVzZSBhbGxveV9laXBzOjplaXA3Njg1OjpSZXF1ZXN0czsKICAgIHVzZSBhbGxveV9wcmltaXRpdmVzOjp7QWRkcmVzcywgQmxvY2tOdW1iZXIsIEJ5dGVzLCBTdG9yYWdlS2V5LCBTdG9yYWdlVmFsdWV9OwogICAgdXNlIHJhbmQ6OlJuZzsKICAgIHVzZSByZXRoX2Vycm9yczo6UHJvdmlkZXJSZXN1bHQ7CiAgICB1c2UgcmV0aF9ldGhlcmV1bV9wcmltaXRpdmVzOjp7RXRoUHJpbWl0aXZlcywgUmVjZWlwdH07CiAgICB1c2UgcmV0aF9wcmltaXRpdmVzX3RyYWl0czo6e0FjY291bnQsIEJ5dGVjb2RlfTsKICAgIHVzZSByZXRoX3N0b3JhZ2VfYXBpOjp7CiAgICAgICAgQWNjb3VudFJlYWRlciwgQmxvY2tIYXNoUmVhZGVyLCBCeXRlY29kZVJlYWRlciwgSGFzaGVkUG9zdFN0YXRlUHJvdmlkZXIsCiAgICAgICAgU3RhdGVQcm9vZlByb3ZpZGVyLCBTdGF0ZVByb3ZpZGVyLCBTdGF0ZVJvb3RQcm92aWRlciwgU3RvcmFnZVJvb3RQcm92aWRlciwKICAgIH07CiAgICB1c2UgcmV0aF90cmllOjp7CiAgICAgICAgdXBkYXRlczo6VHJpZVVwZGF0ZXMsIEFjY291bnRQcm9vZiwgSGFzaGVkUG9zdFN0YXRlLCBIYXNoZWRTdG9yYWdlLCBNdWx0aVByb29mLAogICAgICAgIE11bHRpUHJvb2ZUYXJnZXRzLCBTdG9yYWdlTXVsdGlQcm9vZiwgU3RvcmFnZVByb29mLCBUcmllSW5wdXQsCiAgICB9OwoKICAgIGZuIGNyZWF0ZV9tb2NrX3N0YXRlKAogICAgICAgIHRlc3RfYmxvY2tfYnVpbGRlcjogJm11dCBUZXN0QmxvY2tCdWlsZGVyPEV0aFByaW1pdGl2ZXM+LAogICAgICAgIGJsb2NrX251bWJlcjogdTY0LAogICAgICAgIHBhcmVudF9oYXNoOiBCMjU2LAogICAgKSAtPiBCbG9ja1N0YXRlIHsKICAgICAgICBCbG9ja1N0YXRlOjpuZXcoCiAgICAgICAgICAgIHRlc3RfYmxvY2tfYnVpbGRlci5nZXRfZXhlY3V0ZWRfYmxvY2tfd2l0aF9udW1iZXIoYmxvY2tfbnVtYmVyLCBwYXJlbnRfaGFzaCksCiAgICAgICAgKQogICAgfQoKICAgIGZuIGNyZWF0ZV9tb2NrX3N0YXRlX2NoYWluKAogICAgICAgIHRlc3RfYmxvY2tfYnVpbGRlcjogJm11dCBUZXN0QmxvY2tCdWlsZGVyPEV0aFByaW1pdGl2ZXM+LAogICAgICAgIG51bV9ibG9ja3M6IHU2NCwKICAgICkgLT4gVmVjPEJsb2NrU3RhdGU+IHsKICAgICAgICBsZXQgbXV0IGNoYWluID0gVmVjOjp3aXRoX2NhcGFjaXR5KG51bV9ibG9ja3MgYXMgdXNpemUpOwogICAgICAgIGxldCBtdXQgcGFyZW50X2hhc2ggPSBCMjU2OjpyYW5kb20oKTsKICAgICAgICBsZXQgbXV0IHBhcmVudF9zdGF0ZTogT3B0aW9uPEJsb2NrU3RhdGU+ID0gTm9uZTsKCiAgICAgICAgZm9yIGkgaW4gMS4uPW51bV9ibG9ja3MgewogICAgICAgICAgICBsZXQgbXV0IHN0YXRlID0gY3JlYXRlX21vY2tfc3RhdGUodGVzdF9ibG9ja19idWlsZGVyLCBpLCBwYXJlbnRfaGFzaCk7CiAgICAgICAgICAgIGlmIGxldCBTb21lKHBhcmVudCkgPSBwYXJlbnRfc3RhdGUgewogICAgICAgICAgICAgICAgc3RhdGUucGFyZW50ID0gU29tZShBcmM6Om5ldyhwYXJlbnQpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJlbnRfaGFzaCA9IHN0YXRlLmhhc2goKTsKICAgICAgICAgICAgcGFyZW50X3N0YXRlID0gU29tZShzdGF0ZS5jbG9uZSgpKTsKICAgICAgICAgICAgY2hhaW4ucHVzaChzdGF0ZSk7CiAgICAgICAgfQoKICAgICAgICBjaGFpbgogICAgfQoKICAgIHN0cnVjdCBNb2NrU3RhdGVQcm92aWRlcjsKCiAgICBpbXBsIFN0YXRlUHJvdmlkZXIgZm9yIE1vY2tTdGF0ZVByb3ZpZGVyIHsKICAgICAgICBmbiBzdG9yYWdlKAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgX2FkZHJlc3M6IEFkZHJlc3MsCiAgICAgICAgICAgIF9zdG9yYWdlX2tleTogU3RvcmFnZUtleSwKICAgICAgICApIC0+IFByb3ZpZGVyUmVzdWx0PE9wdGlvbjxTdG9yYWdlVmFsdWU+PiB7CiAgICAgICAgICAgIE9rKE5vbmUpCiAgICAgICAgfQogICAgfQoKICAgIGltcGwgQnl0ZWNvZGVSZWFkZXIgZm9yIE1vY2tTdGF0ZVByb3ZpZGVyIHsKICAgICAgICBmbiBieXRlY29kZV9ieV9oYXNoKCZzZWxmLCBfY29kZV9oYXNoOiAmQjI1NikgLT4gUHJvdmlkZXJSZXN1bHQ8T3B0aW9uPEJ5dGVjb2RlPj4gewogICAgICAgICAgICBPayhOb25lKQogICAgICAgIH0KICAgIH0KCiAgICBpbXBsIEJsb2NrSGFzaFJlYWRlciBmb3IgTW9ja1N0YXRlUHJvdmlkZXIgewogICAgICAgIGZuIGJsb2NrX2hhc2goJnNlbGYsIF9udW1iZXI6IEJsb2NrTnVtYmVyKSAtPiBQcm92aWRlclJlc3VsdDxPcHRpb248QjI1Nj4+IHsKICAgICAgICAgICAgT2soTm9uZSkKICAgICAgICB9CgogICAgICAgIGZuIGNhbm9uaWNhbF9oYXNoZXNfcmFuZ2UoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBfc3RhcnQ6IEJsb2NrTnVtYmVyLAogICAgICAgICAgICBfZW5kOiBCbG9ja051bWJlciwKICAgICAgICApIC0+IFByb3ZpZGVyUmVzdWx0PFZlYzxCMjU2Pj4gewogICAgICAgICAgICBPayh2ZWMhW10pCiAgICAgICAgfQogICAgfQoKICAgIGltcGwgQWNjb3VudFJlYWRlciBmb3IgTW9ja1N0YXRlUHJvdmlkZXIgewogICAgICAgIGZuIGJhc2ljX2FjY291bnQoJnNlbGYsIF9hZGRyZXNzOiAmQWRkcmVzcykgLT4gUHJvdmlkZXJSZXN1bHQ8T3B0aW9uPEFjY291bnQ+PiB7CiAgICAgICAgICAgIE9rKE5vbmUpCiAgICAgICAgfQogICAgfQoKICAgIGltcGwgU3RhdGVSb290UHJvdmlkZXIgZm9yIE1vY2tTdGF0ZVByb3ZpZGVyIHsKICAgICAgICBmbiBzdGF0ZV9yb290KCZzZWxmLCBfaGFzaGVkX3N0YXRlOiBIYXNoZWRQb3N0U3RhdGUpIC0+IFByb3ZpZGVyUmVzdWx0PEIyNTY+IHsKICAgICAgICAgICAgT2soQjI1Njo6cmFuZG9tKCkpCiAgICAgICAgfQoKICAgICAgICBmbiBzdGF0ZV9yb290X2Zyb21fbm9kZXMoJnNlbGYsIF9pbnB1dDogVHJpZUlucHV0KSAtPiBQcm92aWRlclJlc3VsdDxCMjU2PiB7CiAgICAgICAgICAgIE9rKEIyNTY6OnJhbmRvbSgpKQogICAgICAgIH0KCiAgICAgICAgZm4gc3RhdGVfcm9vdF93aXRoX3VwZGF0ZXMoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBfaGFzaGVkX3N0YXRlOiBIYXNoZWRQb3N0U3RhdGUsCiAgICAgICAgKSAtPiBQcm92aWRlclJlc3VsdDwoQjI1NiwgVHJpZVVwZGF0ZXMpPiB7CiAgICAgICAgICAgIE9rKChCMjU2OjpyYW5kb20oKSwgVHJpZVVwZGF0ZXM6OmRlZmF1bHQoKSkpCiAgICAgICAgfQoKICAgICAgICBmbiBzdGF0ZV9yb290X2Zyb21fbm9kZXNfd2l0aF91cGRhdGVzKAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgX2lucHV0OiBUcmllSW5wdXQsCiAgICAgICAgKSAtPiBQcm92aWRlclJlc3VsdDwoQjI1NiwgVHJpZVVwZGF0ZXMpPiB7CiAgICAgICAgICAgIE9rKChCMjU2OjpyYW5kb20oKSwgVHJpZVVwZGF0ZXM6OmRlZmF1bHQoKSkpCiAgICAgICAgfQogICAgfQoKICAgIGltcGwgSGFzaGVkUG9zdFN0YXRlUHJvdmlkZXIgZm9yIE1vY2tTdGF0ZVByb3ZpZGVyIHsKICAgICAgICBmbiBoYXNoZWRfcG9zdF9zdGF0ZSgmc2VsZiwgX2J1bmRsZV9zdGF0ZTogJnJldm1fZGF0YWJhc2U6OkJ1bmRsZVN0YXRlKSAtPiBIYXNoZWRQb3N0U3RhdGUgewogICAgICAgICAgICBIYXNoZWRQb3N0U3RhdGU6OmRlZmF1bHQoKQogICAgICAgIH0KICAgIH0KCiAgICBpbXBsIFN0b3JhZ2VSb290UHJvdmlkZXIgZm9yIE1vY2tTdGF0ZVByb3ZpZGVyIHsKICAgICAgICBmbiBzdG9yYWdlX3Jvb3QoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBfYWRkcmVzczogQWRkcmVzcywKICAgICAgICAgICAgX2hhc2hlZF9zdG9yYWdlOiBIYXNoZWRTdG9yYWdlLAogICAgICAgICkgLT4gUHJvdmlkZXJSZXN1bHQ8QjI1Nj4gewogICAgICAgICAgICBPayhCMjU2OjpyYW5kb20oKSkKICAgICAgICB9CgogICAgICAgIGZuIHN0b3JhZ2VfcHJvb2YoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBfYWRkcmVzczogQWRkcmVzcywKICAgICAgICAgICAgc2xvdDogQjI1NiwKICAgICAgICAgICAgX2hhc2hlZF9zdG9yYWdlOiBIYXNoZWRTdG9yYWdlLAogICAgICAgICkgLT4gUHJvdmlkZXJSZXN1bHQ8U3RvcmFnZVByb29mPiB7CiAgICAgICAgICAgIE9rKFN0b3JhZ2VQcm9vZjo6bmV3KHNsb3QpKQogICAgICAgIH0KCiAgICAgICAgZm4gc3RvcmFnZV9tdWx0aXByb29mKAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgX2FkZHJlc3M6IEFkZHJlc3MsCiAgICAgICAgICAgIF9zbG90czogJltCMjU2XSwKICAgICAgICAgICAgX2hhc2hlZF9zdG9yYWdlOiBIYXNoZWRTdG9yYWdlLAogICAgICAgICkgLT4gUHJvdmlkZXJSZXN1bHQ8U3RvcmFnZU11bHRpUHJvb2Y+IHsKICAgICAgICAgICAgT2soU3RvcmFnZU11bHRpUHJvb2Y6OmVtcHR5KCkpCiAgICAgICAgfQogICAgfQoKICAgIGltcGwgU3RhdGVQcm9vZlByb3ZpZGVyIGZvciBNb2NrU3RhdGVQcm92aWRlciB7CiAgICAgICAgZm4gcHJvb2YoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBfaW5wdXQ6IFRyaWVJbnB1dCwKICAgICAgICAgICAgX2FkZHJlc3M6IEFkZHJlc3MsCiAgICAgICAgICAgIF9zbG90czogJltCMjU2XSwKICAgICAgICApIC0+IFByb3ZpZGVyUmVzdWx0PEFjY291bnRQcm9vZj4gewogICAgICAgICAgICBPayhBY2NvdW50UHJvb2Y6Om5ldyhBZGRyZXNzOjpyYW5kb20oKSkpCiAgICAgICAgfQoKICAgICAgICBmbiBtdWx0aXByb29mKAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgX2lucHV0OiBUcmllSW5wdXQsCiAgICAgICAgICAgIF90YXJnZXRzOiBNdWx0aVByb29mVGFyZ2V0cywKICAgICAgICApIC0+IFByb3ZpZGVyUmVzdWx0PE11bHRpUHJvb2Y+IHsKICAgICAgICAgICAgT2soTXVsdGlQcm9vZjo6ZGVmYXVsdCgpKQogICAgICAgIH0KCiAgICAgICAgZm4gd2l0bmVzcygKICAgICAgICAgICAgJnNlbGYsCiAgICAgICAgICAgIF9pbnB1dDogVHJpZUlucHV0LAogICAgICAgICAgICBfdGFyZ2V0OiBIYXNoZWRQb3N0U3RhdGUsCiAgICAgICAgKSAtPiBQcm92aWRlclJlc3VsdDxWZWM8Qnl0ZXM+PiB7CiAgICAgICAgICAgIE9rKFZlYzo6ZGVmYXVsdCgpKQogICAgICAgIH0KICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2luX21lbW9yeV9zdGF0ZV9pbXBsX3N0YXRlX2J5X2hhc2goKSB7CiAgICAgICAgbGV0IG11dCBzdGF0ZV9ieV9oYXNoID0gSGFzaE1hcDo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBudW1iZXIgPSByYW5kOjpybmcoKS5yYW5kb206Ojx1NjQ+KCk7CiAgICAgICAgbGV0IG11dCB0ZXN0X2Jsb2NrX2J1aWxkZXI6IFRlc3RCbG9ja0J1aWxkZXIgPSBUZXN0QmxvY2tCdWlsZGVyOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IHN0YXRlID0gQXJjOjpuZXcoY3JlYXRlX21vY2tfc3RhdGUoJm11dCB0ZXN0X2Jsb2NrX2J1aWxkZXIsIG51bWJlciwgQjI1Njo6cmFuZG9tKCkpKTsKICAgICAgICBzdGF0ZV9ieV9oYXNoLmluc2VydChzdGF0ZS5oYXNoKCksIHN0YXRlLmNsb25lKCkpOwoKICAgICAgICBsZXQgaW5fbWVtb3J5X3N0YXRlID0gSW5NZW1vcnlTdGF0ZTo6bmV3KHN0YXRlX2J5X2hhc2gsIEJUcmVlTWFwOjpuZXcoKSwgTm9uZSk7CgogICAgICAgIGFzc2VydF9lcSEoaW5fbWVtb3J5X3N0YXRlLnN0YXRlX2J5X2hhc2goc3RhdGUuaGFzaCgpKSwgU29tZShzdGF0ZSkpOwogICAgICAgIGFzc2VydF9lcSEoaW5fbWVtb3J5X3N0YXRlLnN0YXRlX2J5X2hhc2goQjI1Njo6cmFuZG9tKCkpLCBOb25lKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2luX21lbW9yeV9zdGF0ZV9pbXBsX3N0YXRlX2J5X251bWJlcigpIHsKICAgICAgICBsZXQgbXV0IHN0YXRlX2J5X2hhc2ggPSBIYXNoTWFwOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IG11dCBoYXNoX2J5X251bWJlciA9IEJUcmVlTWFwOjpuZXcoKTsKCiAgICAgICAgbGV0IG51bWJlciA9IHJhbmQ6OnJuZygpLnJhbmRvbTo6PHU2ND4oKTsKICAgICAgICBsZXQgbXV0IHRlc3RfYmxvY2tfYnVpbGRlcjogVGVzdEJsb2NrQnVpbGRlciA9IFRlc3RCbG9ja0J1aWxkZXI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgc3RhdGUgPSBBcmM6Om5ldyhjcmVhdGVfbW9ja19zdGF0ZSgmbXV0IHRlc3RfYmxvY2tfYnVpbGRlciwgbnVtYmVyLCBCMjU2OjpyYW5kb20oKSkpOwogICAgICAgIGxldCBoYXNoID0gc3RhdGUuaGFzaCgpOwoKICAgICAgICBzdGF0ZV9ieV9oYXNoLmluc2VydChoYXNoLCBzdGF0ZS5jbG9uZSgpKTsKICAgICAgICBoYXNoX2J5X251bWJlci5pbnNlcnQobnVtYmVyLCBoYXNoKTsKCiAgICAgICAgbGV0IGluX21lbW9yeV9zdGF0ZSA9IEluTWVtb3J5U3RhdGU6Om5ldyhzdGF0ZV9ieV9oYXNoLCBoYXNoX2J5X251bWJlciwgTm9uZSk7CgogICAgICAgIGFzc2VydF9lcSEoaW5fbWVtb3J5X3N0YXRlLnN0YXRlX2J5X251bWJlcihudW1iZXIpLCBTb21lKHN0YXRlKSk7CiAgICAgICAgYXNzZXJ0X2VxIShpbl9tZW1vcnlfc3RhdGUuc3RhdGVfYnlfbnVtYmVyKG51bWJlciArIDEpLCBOb25lKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2luX21lbW9yeV9zdGF0ZV9pbXBsX2hlYWRfc3RhdGUoKSB7CiAgICAgICAgbGV0IG11dCBzdGF0ZV9ieV9oYXNoID0gSGFzaE1hcDo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBtdXQgaGFzaF9ieV9udW1iZXIgPSBCVHJlZU1hcDo6bmV3KCk7CiAgICAgICAgbGV0IG11dCB0ZXN0X2Jsb2NrX2J1aWxkZXI6IFRlc3RCbG9ja0J1aWxkZXIgPSBUZXN0QmxvY2tCdWlsZGVyOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IHN0YXRlMSA9IEFyYzo6bmV3KGNyZWF0ZV9tb2NrX3N0YXRlKCZtdXQgdGVzdF9ibG9ja19idWlsZGVyLCAxLCBCMjU2OjpyYW5kb20oKSkpOwogICAgICAgIGxldCBoYXNoMSA9IHN0YXRlMS5oYXNoKCk7CiAgICAgICAgbGV0IHN0YXRlMiA9IEFyYzo6bmV3KGNyZWF0ZV9tb2NrX3N0YXRlKCZtdXQgdGVzdF9ibG9ja19idWlsZGVyLCAyLCBoYXNoMSkpOwogICAgICAgIGxldCBoYXNoMiA9IHN0YXRlMi5oYXNoKCk7CiAgICAgICAgaGFzaF9ieV9udW1iZXIuaW5zZXJ0KDEsIGhhc2gxKTsKICAgICAgICBoYXNoX2J5X251bWJlci5pbnNlcnQoMiwgaGFzaDIpOwogICAgICAgIHN0YXRlX2J5X2hhc2guaW5zZXJ0KGhhc2gxLCBzdGF0ZTEpOwogICAgICAgIHN0YXRlX2J5X2hhc2guaW5zZXJ0KGhhc2gyLCBzdGF0ZTIpOwoKICAgICAgICBsZXQgaW5fbWVtb3J5X3N0YXRlID0gSW5NZW1vcnlTdGF0ZTo6bmV3KHN0YXRlX2J5X2hhc2gsIGhhc2hfYnlfbnVtYmVyLCBOb25lKTsKICAgICAgICBsZXQgaGVhZF9zdGF0ZSA9IGluX21lbW9yeV9zdGF0ZS5oZWFkX3N0YXRlKCkudW53cmFwKCk7CgogICAgICAgIGFzc2VydF9lcSEoaGVhZF9zdGF0ZS5oYXNoKCksIGhhc2gyKTsKICAgICAgICBhc3NlcnRfZXEhKGhlYWRfc3RhdGUubnVtYmVyKCksIDIpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfaW5fbWVtb3J5X3N0YXRlX2ltcGxfcGVuZGluZ19zdGF0ZSgpIHsKICAgICAgICBsZXQgcGVuZGluZ19udW1iZXIgPSByYW5kOjpybmcoKS5yYW5kb206Ojx1NjQ+KCk7CiAgICAgICAgbGV0IG11dCB0ZXN0X2Jsb2NrX2J1aWxkZXI6IFRlc3RCbG9ja0J1aWxkZXIgPSBUZXN0QmxvY2tCdWlsZGVyOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IHBlbmRpbmdfc3RhdGUgPQogICAgICAgICAgICBjcmVhdGVfbW9ja19zdGF0ZSgmbXV0IHRlc3RfYmxvY2tfYnVpbGRlciwgcGVuZGluZ19udW1iZXIsIEIyNTY6OnJhbmRvbSgpKTsKICAgICAgICBsZXQgcGVuZGluZ19oYXNoID0gcGVuZGluZ19zdGF0ZS5oYXNoKCk7CgogICAgICAgIGxldCBpbl9tZW1vcnlfc3RhdGUgPQogICAgICAgICAgICBJbk1lbW9yeVN0YXRlOjpuZXcoSGFzaE1hcDo6ZGVmYXVsdCgpLCBCVHJlZU1hcDo6bmV3KCksIFNvbWUocGVuZGluZ19zdGF0ZSkpOwoKICAgICAgICBsZXQgcmVzdWx0ID0gaW5fbWVtb3J5X3N0YXRlLnBlbmRpbmdfc3RhdGUoKTsKICAgICAgICBhc3NlcnQhKHJlc3VsdC5pc19zb21lKCkpOwogICAgICAgIGxldCBhY3R1YWxfcGVuZGluZ19zdGF0ZSA9IHJlc3VsdC51bndyYXAoKTsKICAgICAgICBhc3NlcnRfZXEhKGFjdHVhbF9wZW5kaW5nX3N0YXRlLmJsb2NrLnJlY292ZXJlZF9ibG9jaygpLmhhc2goKSwgcGVuZGluZ19oYXNoKTsKICAgICAgICBhc3NlcnRfZXEhKGFjdHVhbF9wZW5kaW5nX3N0YXRlLmJsb2NrLnJlY292ZXJlZF9ibG9jaygpLm51bWJlciwgcGVuZGluZ19udW1iZXIpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfaW5fbWVtb3J5X3N0YXRlX2ltcGxfbm9fcGVuZGluZ19zdGF0ZSgpIHsKICAgICAgICBsZXQgaW5fbWVtb3J5X3N0YXRlOiBJbk1lbW9yeVN0YXRlID0KICAgICAgICAgICAgSW5NZW1vcnlTdGF0ZTo6bmV3KEhhc2hNYXA6OmRlZmF1bHQoKSwgQlRyZWVNYXA6Om5ldygpLCBOb25lKTsKCiAgICAgICAgYXNzZXJ0X2VxIShpbl9tZW1vcnlfc3RhdGUucGVuZGluZ19zdGF0ZSgpLCBOb25lKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3N0YXRlKCkgewogICAgICAgIGxldCBudW1iZXIgPSByYW5kOjpybmcoKS5yYW5kb206Ojx1NjQ+KCk7CiAgICAgICAgbGV0IG11dCB0ZXN0X2Jsb2NrX2J1aWxkZXI6IFRlc3RCbG9ja0J1aWxkZXIgPSBUZXN0QmxvY2tCdWlsZGVyOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IGJsb2NrID0gdGVzdF9ibG9ja19idWlsZGVyLmdldF9leGVjdXRlZF9ibG9ja193aXRoX251bWJlcihudW1iZXIsIEIyNTY6OnJhbmRvbSgpKTsKCiAgICAgICAgbGV0IHN0YXRlID0gQmxvY2tTdGF0ZTo6bmV3KGJsb2NrLmNsb25lKCkpOwoKICAgICAgICBhc3NlcnRfZXEhKHN0YXRlLmJsb2NrKCksIGJsb2NrKTsKICAgICAgICBhc3NlcnRfZXEhKHN0YXRlLmhhc2goKSwgYmxvY2sucmVjb3ZlcmVkX2Jsb2NrKCkuaGFzaCgpKTsKICAgICAgICBhc3NlcnRfZXEhKHN0YXRlLm51bWJlcigpLCBudW1iZXIpOwogICAgICAgIGFzc2VydF9lcSEoc3RhdGUuc3RhdGVfcm9vdCgpLCBibG9jay5yZWNvdmVyZWRfYmxvY2soKS5zdGF0ZV9yb290KTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3N0YXRlX3JlY2VpcHRzKCkgewogICAgICAgIGxldCByZWNlaXB0cyA9IHZlYyFbdmVjIVtSZWNlaXB0OjpkZWZhdWx0KCldXTsKICAgICAgICBsZXQgbXV0IHRlc3RfYmxvY2tfYnVpbGRlcjogVGVzdEJsb2NrQnVpbGRlciA9IFRlc3RCbG9ja0J1aWxkZXI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgYmxvY2sgPQogICAgICAgICAgICB0ZXN0X2Jsb2NrX2J1aWxkZXIuZ2V0X2V4ZWN1dGVkX2Jsb2NrX3dpdGhfcmVjZWlwdHMocmVjZWlwdHMuY2xvbmUoKSwgQjI1Njo6cmFuZG9tKCkpOwoKICAgICAgICBsZXQgc3RhdGUgPSBCbG9ja1N0YXRlOjpuZXcoYmxvY2spOwoKICAgICAgICBhc3NlcnRfZXEhKHN0YXRlLnJlY2VpcHRzKCksICZyZWNlaXB0cyk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9pbl9tZW1vcnlfc3RhdGVfY2hhaW5fdXBkYXRlKCkgewogICAgICAgIGxldCBzdGF0ZTogQ2Fub25pY2FsSW5NZW1vcnlTdGF0ZSA9IENhbm9uaWNhbEluTWVtb3J5U3RhdGU6OmVtcHR5KCk7CiAgICAgICAgbGV0IG11dCB0ZXN0X2Jsb2NrX2J1aWxkZXI6IFRlc3RCbG9ja0J1aWxkZXIgPSBUZXN0QmxvY2tCdWlsZGVyOjpkZWZhdWx0KCk7CiAgICAgICAgbGV0IGJsb2NrMSA9IHRlc3RfYmxvY2tfYnVpbGRlci5nZXRfZXhlY3V0ZWRfYmxvY2tfd2l0aF9udW1iZXIoMCwgQjI1Njo6cmFuZG9tKCkpOwogICAgICAgIGxldCBibG9jazIgPSB0ZXN0X2Jsb2NrX2J1aWxkZXIuZ2V0X2V4ZWN1dGVkX2Jsb2NrX3dpdGhfbnVtYmVyKDAsIEIyNTY6OnJhbmRvbSgpKTsKICAgICAgICBsZXQgY2hhaW4gPSBOZXdDYW5vbmljYWxDaGFpbjo6Q29tbWl0IHsgbmV3OiB2ZWMhW2Jsb2NrMS5jbG9uZSgpXSB9OwogICAgICAgIHN0YXRlLnVwZGF0ZV9jaGFpbihjaGFpbik7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgc3RhdGUuaGVhZF9zdGF0ZSgpLnVud3JhcCgpLmJsb2NrX3JlZigpLnJlY292ZXJlZF9ibG9jaygpLmhhc2goKSwKICAgICAgICAgICAgYmxvY2sxLnJlY292ZXJlZF9ibG9jaygpLmhhc2goKQogICAgICAgICk7CiAgICAgICAgYXNzZXJ0X2VxISgKICAgICAgICAgICAgc3RhdGUuc3RhdGVfYnlfbnVtYmVyKDApLnVud3JhcCgpLmJsb2NrX3JlZigpLnJlY292ZXJlZF9ibG9jaygpLmhhc2goKSwKICAgICAgICAgICAgYmxvY2sxLnJlY292ZXJlZF9ibG9jaygpLmhhc2goKQogICAgICAgICk7CgogICAgICAgIGxldCBjaGFpbiA9IE5ld0Nhbm9uaWNhbENoYWluOjpSZW9yZyB7IG5ldzogdmVjIVtibG9jazIuY2xvbmUoKV0sIG9sZDogdmVjIVtibG9jazFdIH07CiAgICAgICAgc3RhdGUudXBkYXRlX2NoYWluKGNoYWluKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBzdGF0ZS5oZWFkX3N0YXRlKCkudW53cmFwKCkuYmxvY2tfcmVmKCkucmVjb3ZlcmVkX2Jsb2NrKCkuaGFzaCgpLAogICAgICAgICAgICBibG9jazIucmVjb3ZlcmVkX2Jsb2NrKCkuaGFzaCgpCiAgICAgICAgKTsKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBzdGF0ZS5zdGF0ZV9ieV9udW1iZXIoMCkudW53cmFwKCkuYmxvY2tfcmVmKCkucmVjb3ZlcmVkX2Jsb2NrKCkuaGFzaCgpLAogICAgICAgICAgICBibG9jazIucmVjb3ZlcmVkX2Jsb2NrKCkuaGFzaCgpCiAgICAgICAgKTsKCiAgICAgICAgYXNzZXJ0X2VxIShzdGF0ZS5pbm5lci5pbl9tZW1vcnlfc3RhdGUuYmxvY2tfY291bnQoKSwgMSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9pbl9tZW1vcnlfc3RhdGVfc2V0X3BlbmRpbmdfYmxvY2soKSB7CiAgICAgICAgbGV0IHN0YXRlOiBDYW5vbmljYWxJbk1lbW9yeVN0YXRlID0gQ2Fub25pY2FsSW5NZW1vcnlTdGF0ZTo6ZW1wdHkoKTsKICAgICAgICBsZXQgbXV0IHRlc3RfYmxvY2tfYnVpbGRlcjogVGVzdEJsb2NrQnVpbGRlciA9IFRlc3RCbG9ja0J1aWxkZXI6OmRlZmF1bHQoKTsKCiAgICAgICAgLy8gRmlyc3QgcmFuZG9tIGJsb2NrCiAgICAgICAgbGV0IGJsb2NrMSA9IHRlc3RfYmxvY2tfYnVpbGRlci5nZXRfZXhlY3V0ZWRfYmxvY2tfd2l0aF9udW1iZXIoMCwgQjI1Njo6cmFuZG9tKCkpOwoKICAgICAgICAvLyBTZWNvbmQgYmxvY2sgd2l0aCBwYXJlbnQgaGFzaCBvZiB0aGUgZmlyc3QgYmxvY2sKICAgICAgICBsZXQgYmxvY2syID0KICAgICAgICAgICAgdGVzdF9ibG9ja19idWlsZGVyLmdldF9leGVjdXRlZF9ibG9ja193aXRoX251bWJlcigxLCBibG9jazEucmVjb3ZlcmVkX2Jsb2NrKCkuaGFzaCgpKTsKCiAgICAgICAgLy8gQ29tbWl0IHRoZSB0d28gYmxvY2tzCiAgICAgICAgbGV0IGNoYWluID0gTmV3Q2Fub25pY2FsQ2hhaW46OkNvbW1pdCB7IG5ldzogdmVjIVtibG9jazEuY2xvbmUoKSwgYmxvY2syLmNsb25lKCldIH07CiAgICAgICAgc3RhdGUudXBkYXRlX2NoYWluKGNoYWluKTsKCiAgICAgICAgLy8gQXNzZXJ0IHRoYXQgdGhlIHBlbmRpbmcgc3RhdGUgaXMgTm9uZSBiZWZvcmUgc2V0dGluZyBpdAogICAgICAgIGFzc2VydCEoc3RhdGUucGVuZGluZ19zdGF0ZSgpLmlzX25vbmUoKSk7CgogICAgICAgIC8vIFNldCB0aGUgcGVuZGluZyBibG9jawogICAgICAgIHN0YXRlLnNldF9wZW5kaW5nX2Jsb2NrKGJsb2NrMi5jbG9uZSgpKTsKCiAgICAgICAgLy8gQ2hlY2sgdGhlIHBlbmRpbmcgc3RhdGUKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBzdGF0ZS5wZW5kaW5nX3N0YXRlKCkudW53cmFwKCksCiAgICAgICAgICAgIEJsb2NrU3RhdGU6OndpdGhfcGFyZW50KGJsb2NrMi5jbG9uZSgpLCBTb21lKEFyYzo6bmV3KEJsb2NrU3RhdGU6Om5ldyhibG9jazEpKSkpCiAgICAgICAgKTsKCiAgICAgICAgLy8gQ2hlY2sgdGhlIHBlbmRpbmcgYmxvY2sKICAgICAgICBhc3NlcnRfZXEhKHN0YXRlLnBlbmRpbmdfYmxvY2soKS51bndyYXAoKSwgYmxvY2syLnJlY292ZXJlZF9ibG9jaygpLnNlYWxlZF9ibG9jaygpLmNsb25lKCkpOwoKICAgICAgICAvLyBDaGVjayB0aGUgcGVuZGluZyBibG9jayBudW1iZXIgYW5kIGhhc2gKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBzdGF0ZS5wZW5kaW5nX2Jsb2NrX251bV9oYXNoKCkudW53cmFwKCksCiAgICAgICAgICAgIEJsb2NrTnVtSGFzaCB7IG51bWJlcjogMSwgaGFzaDogYmxvY2syLnJlY292ZXJlZF9ibG9jaygpLmhhc2goKSB9CiAgICAgICAgKTsKCiAgICAgICAgLy8gQ2hlY2sgdGhlIHBlbmRpbmcgaGVhZGVyCiAgICAgICAgYXNzZXJ0X2VxIShzdGF0ZS5wZW5kaW5nX2hlYWRlcigpLnVud3JhcCgpLCBibG9jazIucmVjb3ZlcmVkX2Jsb2NrKCkuaGVhZGVyKCkuY2xvbmUoKSk7CgogICAgICAgIC8vIENoZWNrIHRoZSBwZW5kaW5nIHNlYWxlZCBoZWFkZXIKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBzdGF0ZS5wZW5kaW5nX3NlYWxlZF9oZWFkZXIoKS51bndyYXAoKSwKICAgICAgICAgICAgYmxvY2syLnJlY292ZXJlZF9ibG9jaygpLmNsb25lX3NlYWxlZF9oZWFkZXIoKQogICAgICAgICk7CgogICAgICAgIC8vIENoZWNrIHRoZSBwZW5kaW5nIGJsb2NrIHdpdGggc2VuZGVycwogICAgICAgIGFzc2VydF9lcSEoc3RhdGUucGVuZGluZ19yZWNvdmVyZWRfYmxvY2soKS51bndyYXAoKSwgYmxvY2syLnJlY292ZXJlZF9ibG9jaygpLmNsb25lKCkpOwoKICAgICAgICAvLyBDaGVjayB0aGUgcGVuZGluZyBibG9jayBhbmQgcmVjZWlwdHMKICAgICAgICBhc3NlcnRfZXEhKAogICAgICAgICAgICBzdGF0ZS5wZW5kaW5nX2Jsb2NrX2FuZF9yZWNlaXB0cygpLnVud3JhcCgpLAogICAgICAgICAgICAoYmxvY2syLnJlY292ZXJlZF9ibG9jaygpLmNsb25lKCksIHZlYyFbXSkKICAgICAgICApOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfY2Fub25pY2FsX2luX21lbW9yeV9zdGF0ZV9zdGF0ZV9wcm92aWRlcigpIHsKICAgICAgICBsZXQgbXV0IHRlc3RfYmxvY2tfYnVpbGRlcjogVGVzdEJsb2NrQnVpbGRlciA9IFRlc3RCbG9ja0J1aWxkZXI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgYmxvY2sxID0gdGVzdF9ibG9ja19idWlsZGVyLmdldF9leGVjdXRlZF9ibG9ja193aXRoX251bWJlcigxLCBCMjU2OjpyYW5kb20oKSk7CiAgICAgICAgbGV0IGJsb2NrMiA9CiAgICAgICAgICAgIHRlc3RfYmxvY2tfYnVpbGRlci5nZXRfZXhlY3V0ZWRfYmxvY2tfd2l0aF9udW1iZXIoMiwgYmxvY2sxLnJlY292ZXJlZF9ibG9jaygpLmhhc2goKSk7CiAgICAgICAgbGV0IGJsb2NrMyA9CiAgICAgICAgICAgIHRlc3RfYmxvY2tfYnVpbGRlci5nZXRfZXhlY3V0ZWRfYmxvY2tfd2l0aF9udW1iZXIoMywgYmxvY2syLnJlY292ZXJlZF9ibG9jaygpLmhhc2goKSk7CgogICAgICAgIGxldCBzdGF0ZTEgPSBBcmM6Om5ldyhCbG9ja1N0YXRlOjpuZXcoYmxvY2sxLmNsb25lKCkpKTsKICAgICAgICBsZXQgc3RhdGUyID0gQXJjOjpuZXcoQmxvY2tTdGF0ZTo6d2l0aF9wYXJlbnQoYmxvY2syLmNsb25lKCksIFNvbWUoc3RhdGUxLmNsb25lKCkpKSk7CiAgICAgICAgbGV0IHN0YXRlMyA9IEFyYzo6bmV3KEJsb2NrU3RhdGU6OndpdGhfcGFyZW50KGJsb2NrMy5jbG9uZSgpLCBTb21lKHN0YXRlMi5jbG9uZSgpKSkpOwoKICAgICAgICBsZXQgbXV0IGJsb2NrcyA9IEhhc2hNYXA6OmRlZmF1bHQoKTsKICAgICAgICBibG9ja3MuaW5zZXJ0KGJsb2NrMS5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCksIHN0YXRlMSk7CiAgICAgICAgYmxvY2tzLmluc2VydChibG9jazIucmVjb3ZlcmVkX2Jsb2NrKCkuaGFzaCgpLCBzdGF0ZTIpOwogICAgICAgIGJsb2Nrcy5pbnNlcnQoYmxvY2szLnJlY292ZXJlZF9ibG9jaygpLmhhc2goKSwgc3RhdGUzKTsKCiAgICAgICAgbGV0IG11dCBudW1iZXJzID0gQlRyZWVNYXA6Om5ldygpOwogICAgICAgIG51bWJlcnMuaW5zZXJ0KDEsIGJsb2NrMS5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCkpOwogICAgICAgIG51bWJlcnMuaW5zZXJ0KDIsIGJsb2NrMi5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCkpOwogICAgICAgIG51bWJlcnMuaW5zZXJ0KDMsIGJsb2NrMy5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCkpOwoKICAgICAgICBsZXQgY2Fub25pY2FsX3N0YXRlID0gQ2Fub25pY2FsSW5NZW1vcnlTdGF0ZTo6bmV3KGJsb2NrcywgbnVtYmVycywgTm9uZSwgTm9uZSwgTm9uZSk7CgogICAgICAgIGxldCBoaXN0b3JpY2FsOiBTdGF0ZVByb3ZpZGVyQm94ID0gQm94OjpuZXcoTW9ja1N0YXRlUHJvdmlkZXIpOwoKICAgICAgICBsZXQgb3ZlcmxheV9wcm92aWRlciA9CiAgICAgICAgICAgIGNhbm9uaWNhbF9zdGF0ZS5zdGF0ZV9wcm92aWRlcihibG9jazMucmVjb3ZlcmVkX2Jsb2NrKCkuaGFzaCgpLCBoaXN0b3JpY2FsKTsKCiAgICAgICAgYXNzZXJ0X2VxIShvdmVybGF5X3Byb3ZpZGVyLmluX21lbW9yeS5sZW4oKSwgMyk7CiAgICAgICAgYXNzZXJ0X2VxIShvdmVybGF5X3Byb3ZpZGVyLmluX21lbW9yeVswXS5yZWNvdmVyZWRfYmxvY2soKS5udW1iZXIsIDMpOwogICAgICAgIGFzc2VydF9lcSEob3ZlcmxheV9wcm92aWRlci5pbl9tZW1vcnlbMV0ucmVjb3ZlcmVkX2Jsb2NrKCkubnVtYmVyLCAyKTsKICAgICAgICBhc3NlcnRfZXEhKG92ZXJsYXlfcHJvdmlkZXIuaW5fbWVtb3J5WzJdLnJlY292ZXJlZF9ibG9jaygpLm51bWJlciwgMSk7CgogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIG92ZXJsYXlfcHJvdmlkZXIuaW5fbWVtb3J5WzBdLnJlY292ZXJlZF9ibG9jaygpLnBhcmVudF9oYXNoLAogICAgICAgICAgICBvdmVybGF5X3Byb3ZpZGVyLmluX21lbW9yeVsxXS5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCkKICAgICAgICApOwogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIG92ZXJsYXlfcHJvdmlkZXIuaW5fbWVtb3J5WzFdLnJlY292ZXJlZF9ibG9jaygpLnBhcmVudF9oYXNoLAogICAgICAgICAgICBvdmVybGF5X3Byb3ZpZGVyLmluX21lbW9yeVsyXS5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCkKICAgICAgICApOwoKICAgICAgICBsZXQgdW5rbm93bl9oYXNoID0gQjI1Njo6cmFuZG9tKCk7CiAgICAgICAgbGV0IGVtcHR5X292ZXJsYXlfcHJvdmlkZXIgPQogICAgICAgICAgICBjYW5vbmljYWxfc3RhdGUuc3RhdGVfcHJvdmlkZXIodW5rbm93bl9oYXNoLCBCb3g6Om5ldyhNb2NrU3RhdGVQcm92aWRlcikpOwogICAgICAgIGFzc2VydF9lcSEoZW1wdHlfb3ZlcmxheV9wcm92aWRlci5pbl9tZW1vcnkubGVuKCksIDApOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfY2Fub25pY2FsX2luX21lbW9yeV9zdGF0ZV9jYW5vbmljYWxfY2hhaW5fZW1wdHkoKSB7CiAgICAgICAgbGV0IHN0YXRlOiBDYW5vbmljYWxJbk1lbW9yeVN0YXRlID0gQ2Fub25pY2FsSW5NZW1vcnlTdGF0ZTo6ZW1wdHkoKTsKICAgICAgICBhc3NlcnQhKHN0YXRlLmNhbm9uaWNhbF9jaGFpbigpLm5leHQoKS5pc19ub25lKCkpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfY2Fub25pY2FsX2luX21lbW9yeV9zdGF0ZV9jYW5vbmljYWxfY2hhaW5fc2luZ2xlX2Jsb2NrKCkgewogICAgICAgIGxldCBibG9jayA9IFRlc3RCbG9ja0J1aWxkZXI6OmV0aCgpLmdldF9leGVjdXRlZF9ibG9ja193aXRoX251bWJlcigxLCBCMjU2OjpyYW5kb20oKSk7CiAgICAgICAgbGV0IGhhc2ggPSBibG9jay5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCk7CiAgICAgICAgbGV0IG11dCBibG9ja3MgPSBIYXNoTWFwOjpkZWZhdWx0KCk7CiAgICAgICAgYmxvY2tzLmluc2VydChoYXNoLCBBcmM6Om5ldyhCbG9ja1N0YXRlOjpuZXcoYmxvY2spKSk7CiAgICAgICAgbGV0IG11dCBudW1iZXJzID0gQlRyZWVNYXA6Om5ldygpOwogICAgICAgIG51bWJlcnMuaW5zZXJ0KDEsIGhhc2gpOwoKICAgICAgICBsZXQgc3RhdGUgPSBDYW5vbmljYWxJbk1lbW9yeVN0YXRlOjpuZXcoYmxvY2tzLCBudW1iZXJzLCBOb25lLCBOb25lLCBOb25lKTsKICAgICAgICBsZXQgY2hhaW46IFZlYzxfPiA9IHN0YXRlLmNhbm9uaWNhbF9jaGFpbigpLmNvbGxlY3QoKTsKCiAgICAgICAgYXNzZXJ0X2VxIShjaGFpbi5sZW4oKSwgMSk7CiAgICAgICAgYXNzZXJ0X2VxIShjaGFpblswXS5udW1iZXIoKSwgMSk7CiAgICAgICAgYXNzZXJ0X2VxIShjaGFpblswXS5oYXNoKCksIGhhc2gpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfY2Fub25pY2FsX2luX21lbW9yeV9zdGF0ZV9jYW5vbmljYWxfY2hhaW5fbXVsdGlwbGVfYmxvY2tzKCkgewogICAgICAgIGxldCBtdXQgcGFyZW50X2hhc2ggPSBCMjU2OjpyYW5kb20oKTsKICAgICAgICBsZXQgbXV0IGJsb2NrX2J1aWxkZXIgPSBUZXN0QmxvY2tCdWlsZGVyOjpldGgoKTsKICAgICAgICBsZXQgc3RhdGU6IENhbm9uaWNhbEluTWVtb3J5U3RhdGUgPSBDYW5vbmljYWxJbk1lbW9yeVN0YXRlOjplbXB0eSgpOwoKICAgICAgICBmb3IgaSBpbiAxLi49MyB7CiAgICAgICAgICAgIGxldCBibG9jayA9IGJsb2NrX2J1aWxkZXIuZ2V0X2V4ZWN1dGVkX2Jsb2NrX3dpdGhfbnVtYmVyKGksIHBhcmVudF9oYXNoKTsKICAgICAgICAgICAgbGV0IGhhc2ggPSBibG9jay5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCk7CiAgICAgICAgICAgIHN0YXRlLnVwZGF0ZV9ibG9ja3MoU29tZShibG9jayksIE5vbmUpOwogICAgICAgICAgICBwYXJlbnRfaGFzaCA9IGhhc2g7CiAgICAgICAgfQoKICAgICAgICBsZXQgY2hhaW46IFZlYzxfPiA9IHN0YXRlLmNhbm9uaWNhbF9jaGFpbigpLmNvbGxlY3QoKTsKCiAgICAgICAgYXNzZXJ0X2VxIShjaGFpbi5sZW4oKSwgMyk7CiAgICAgICAgYXNzZXJ0X2VxIShjaGFpblswXS5udW1iZXIoKSwgMyk7CiAgICAgICAgYXNzZXJ0X2VxIShjaGFpblsxXS5udW1iZXIoKSwgMik7CiAgICAgICAgYXNzZXJ0X2VxIShjaGFpblsyXS5udW1iZXIoKSwgMSk7CiAgICB9CgogICAgLy8gZW5zdXJlcyB0aGUgcGVuZGluZyBibG9jayBpcyBub3QgcGFydCBvZiB0aGUgY2Fub25pY2FsIGNoYWluCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2Nhbm9uaWNhbF9pbl9tZW1vcnlfc3RhdGVfY2Fub25pY2FsX2NoYWluX3dpdGhfcGVuZGluZ19ibG9jaygpIHsKICAgICAgICBsZXQgbXV0IHBhcmVudF9oYXNoID0gQjI1Njo6cmFuZG9tKCk7CiAgICAgICAgbGV0IG11dCBibG9ja19idWlsZGVyID0gVGVzdEJsb2NrQnVpbGRlcjo6PEV0aFByaW1pdGl2ZXM+OjpldGgoKTsKICAgICAgICBsZXQgc3RhdGU6IENhbm9uaWNhbEluTWVtb3J5U3RhdGUgPSBDYW5vbmljYWxJbk1lbW9yeVN0YXRlOjplbXB0eSgpOwoKICAgICAgICBmb3IgaSBpbiAxLi49MiB7CiAgICAgICAgICAgIGxldCBibG9jayA9IGJsb2NrX2J1aWxkZXIuZ2V0X2V4ZWN1dGVkX2Jsb2NrX3dpdGhfbnVtYmVyKGksIHBhcmVudF9oYXNoKTsKICAgICAgICAgICAgbGV0IGhhc2ggPSBibG9jay5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCk7CiAgICAgICAgICAgIHN0YXRlLnVwZGF0ZV9ibG9ja3MoU29tZShibG9jayksIE5vbmUpOwogICAgICAgICAgICBwYXJlbnRfaGFzaCA9IGhhc2g7CiAgICAgICAgfQoKICAgICAgICBsZXQgcGVuZGluZ19ibG9jayA9IGJsb2NrX2J1aWxkZXIuZ2V0X2V4ZWN1dGVkX2Jsb2NrX3dpdGhfbnVtYmVyKDMsIHBhcmVudF9oYXNoKTsKICAgICAgICBzdGF0ZS5zZXRfcGVuZGluZ19ibG9jayhwZW5kaW5nX2Jsb2NrKTsKICAgICAgICBsZXQgY2hhaW46IFZlYzxfPiA9IHN0YXRlLmNhbm9uaWNhbF9jaGFpbigpLmNvbGxlY3QoKTsKCiAgICAgICAgYXNzZXJ0X2VxIShjaGFpbi5sZW4oKSwgMik7CiAgICAgICAgYXNzZXJ0X2VxIShjaGFpblswXS5udW1iZXIoKSwgMik7CiAgICAgICAgYXNzZXJ0X2VxIShjaGFpblsxXS5udW1iZXIoKSwgMSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9ibG9ja19zdGF0ZV9wYXJlbnRfYmxvY2tzKCkgewogICAgICAgIGxldCBtdXQgdGVzdF9ibG9ja19idWlsZGVyOiBUZXN0QmxvY2tCdWlsZGVyID0gVGVzdEJsb2NrQnVpbGRlcjo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBjaGFpbiA9IGNyZWF0ZV9tb2NrX3N0YXRlX2NoYWluKCZtdXQgdGVzdF9ibG9ja19idWlsZGVyLCA0KTsKCiAgICAgICAgbGV0IHBhcmVudHM6IFZlYzxfPiA9IGNoYWluWzNdLnBhcmVudF9zdGF0ZV9jaGFpbigpLmNvbGxlY3QoKTsKICAgICAgICBhc3NlcnRfZXEhKHBhcmVudHMubGVuKCksIDMpOwogICAgICAgIGFzc2VydF9lcSEocGFyZW50c1swXS5ibG9jaygpLnJlY292ZXJlZF9ibG9jaygpLm51bWJlciwgMyk7CiAgICAgICAgYXNzZXJ0X2VxIShwYXJlbnRzWzFdLmJsb2NrKCkucmVjb3ZlcmVkX2Jsb2NrKCkubnVtYmVyLCAyKTsKICAgICAgICBhc3NlcnRfZXEhKHBhcmVudHNbMl0uYmxvY2soKS5yZWNvdmVyZWRfYmxvY2soKS5udW1iZXIsIDEpOwoKICAgICAgICBsZXQgcGFyZW50czogVmVjPF8+ID0gY2hhaW5bMl0ucGFyZW50X3N0YXRlX2NoYWluKCkuY29sbGVjdCgpOwogICAgICAgIGFzc2VydF9lcSEocGFyZW50cy5sZW4oKSwgMik7CiAgICAgICAgYXNzZXJ0X2VxIShwYXJlbnRzWzBdLmJsb2NrKCkucmVjb3ZlcmVkX2Jsb2NrKCkubnVtYmVyLCAyKTsKICAgICAgICBhc3NlcnRfZXEhKHBhcmVudHNbMV0uYmxvY2soKS5yZWNvdmVyZWRfYmxvY2soKS5udW1iZXIsIDEpOwoKICAgICAgICBhc3NlcnRfZXEhKGNoYWluWzBdLnBhcmVudF9zdGF0ZV9jaGFpbigpLmNvdW50KCksIDApOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfYmxvY2tfc3RhdGVfc2luZ2xlX2Jsb2NrX3N0YXRlX2NoYWluKCkgewogICAgICAgIGxldCBzaW5nbGVfYmxvY2tfbnVtYmVyID0gMTsKICAgICAgICBsZXQgbXV0IHRlc3RfYmxvY2tfYnVpbGRlcjogVGVzdEJsb2NrQnVpbGRlciA9IFRlc3RCbG9ja0J1aWxkZXI6OmRlZmF1bHQoKTsKICAgICAgICBsZXQgc2luZ2xlX2Jsb2NrID0KICAgICAgICAgICAgY3JlYXRlX21vY2tfc3RhdGUoJm11dCB0ZXN0X2Jsb2NrX2J1aWxkZXIsIHNpbmdsZV9ibG9ja19udW1iZXIsIEIyNTY6OnJhbmRvbSgpKTsKICAgICAgICBsZXQgc2luZ2xlX2Jsb2NrX2hhc2ggPSBzaW5nbGVfYmxvY2suYmxvY2soKS5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCk7CgogICAgICAgIGFzc2VydF9lcSEoc2luZ2xlX2Jsb2NrLnBhcmVudF9zdGF0ZV9jaGFpbigpLmNvdW50KCksIDApOwoKICAgICAgICBsZXQgYmxvY2tfc3RhdGVfY2hhaW4gPSBzaW5nbGVfYmxvY2suY2hhaW4oKS5jb2xsZWN0Ojo8VmVjPF8+PigpOwogICAgICAgIGFzc2VydF9lcSEoYmxvY2tfc3RhdGVfY2hhaW4ubGVuKCksIDEpOwogICAgICAgIGFzc2VydF9lcSEoYmxvY2tfc3RhdGVfY2hhaW5bMF0uYmxvY2soKS5yZWNvdmVyZWRfYmxvY2soKS5udW1iZXIsIHNpbmdsZV9ibG9ja19udW1iZXIpOwogICAgICAgIGFzc2VydF9lcSEoYmxvY2tfc3RhdGVfY2hhaW5bMF0uYmxvY2soKS5yZWNvdmVyZWRfYmxvY2soKS5oYXNoKCksIHNpbmdsZV9ibG9ja19oYXNoKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2Jsb2NrX3N0YXRlX2NoYWluKCkgewogICAgICAgIGxldCBtdXQgdGVzdF9ibG9ja19idWlsZGVyOiBUZXN0QmxvY2tCdWlsZGVyID0gVGVzdEJsb2NrQnVpbGRlcjo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBjaGFpbiA9IGNyZWF0ZV9tb2NrX3N0YXRlX2NoYWluKCZtdXQgdGVzdF9ibG9ja19idWlsZGVyLCAzKTsKCiAgICAgICAgbGV0IGJsb2NrX3N0YXRlX2NoYWluID0gY2hhaW5bMl0uY2hhaW4oKS5jb2xsZWN0Ojo8VmVjPF8+PigpOwogICAgICAgIGFzc2VydF9lcSEoYmxvY2tfc3RhdGVfY2hhaW4ubGVuKCksIDMpOwogICAgICAgIGFzc2VydF9lcSEoYmxvY2tfc3RhdGVfY2hhaW5bMF0uYmxvY2soKS5yZWNvdmVyZWRfYmxvY2soKS5udW1iZXIsIDMpOwogICAgICAgIGFzc2VydF9lcSEoYmxvY2tfc3RhdGVfY2hhaW5bMV0uYmxvY2soKS5yZWNvdmVyZWRfYmxvY2soKS5udW1iZXIsIDIpOwogICAgICAgIGFzc2VydF9lcSEoYmxvY2tfc3RhdGVfY2hhaW5bMl0uYmxvY2soKS5yZWNvdmVyZWRfYmxvY2soKS5udW1iZXIsIDEpOwoKICAgICAgICBsZXQgYmxvY2tfc3RhdGVfY2hhaW4gPSBjaGFpblsxXS5jaGFpbigpLmNvbGxlY3Q6OjxWZWM8Xz4+KCk7CiAgICAgICAgYXNzZXJ0X2VxIShibG9ja19zdGF0ZV9jaGFpbi5sZW4oKSwgMik7CiAgICAgICAgYXNzZXJ0X2VxIShibG9ja19zdGF0ZV9jaGFpblswXS5ibG9jaygpLnJlY292ZXJlZF9ibG9jaygpLm51bWJlciwgMik7CiAgICAgICAgYXNzZXJ0X2VxIShibG9ja19zdGF0ZV9jaGFpblsxXS5ibG9jaygpLnJlY292ZXJlZF9ibG9jaygpLm51bWJlciwgMSk7CgogICAgICAgIGxldCBibG9ja19zdGF0ZV9jaGFpbiA9IGNoYWluWzBdLmNoYWluKCkuY29sbGVjdDo6PFZlYzxfPj4oKTsKICAgICAgICBhc3NlcnRfZXEhKGJsb2NrX3N0YXRlX2NoYWluLmxlbigpLCAxKTsKICAgICAgICBhc3NlcnRfZXEhKGJsb2NrX3N0YXRlX2NoYWluWzBdLmJsb2NrKCkucmVjb3ZlcmVkX2Jsb2NrKCkubnVtYmVyLCAxKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3RvX2NoYWluX25vdGlmaWNhdGlvbigpIHsKICAgICAgICAvLyBHZW5lcmF0ZSA0IGJsb2NrcwogICAgICAgIGxldCBtdXQgdGVzdF9ibG9ja19idWlsZGVyOiBUZXN0QmxvY2tCdWlsZGVyID0gVGVzdEJsb2NrQnVpbGRlcjo6ZGVmYXVsdCgpOwogICAgICAgIGxldCBibG9jazAgPSB0ZXN0X2Jsb2NrX2J1aWxkZXIuZ2V0X2V4ZWN1dGVkX2Jsb2NrX3dpdGhfbnVtYmVyKDAsIEIyNTY6OnJhbmRvbSgpKTsKICAgICAgICBsZXQgYmxvY2sxID0KICAgICAgICAgICAgdGVzdF9ibG9ja19idWlsZGVyLmdldF9leGVjdXRlZF9ibG9ja193aXRoX251bWJlcigxLCBibG9jazAucmVjb3ZlcmVkX2Jsb2NrLmhhc2goKSk7CiAgICAgICAgbGV0IGJsb2NrMWEgPQogICAgICAgICAgICB0ZXN0X2Jsb2NrX2J1aWxkZXIuZ2V0X2V4ZWN1dGVkX2Jsb2NrX3dpdGhfbnVtYmVyKDEsIGJsb2NrMC5yZWNvdmVyZWRfYmxvY2suaGFzaCgpKTsKICAgICAgICBsZXQgYmxvY2syID0KICAgICAgICAgICAgdGVzdF9ibG9ja19idWlsZGVyLmdldF9leGVjdXRlZF9ibG9ja193aXRoX251bWJlcigyLCBibG9jazEucmVjb3ZlcmVkX2Jsb2NrLmhhc2goKSk7CiAgICAgICAgbGV0IGJsb2NrMmEgPQogICAgICAgICAgICB0ZXN0X2Jsb2NrX2J1aWxkZXIuZ2V0X2V4ZWN1dGVkX2Jsb2NrX3dpdGhfbnVtYmVyKDIsIGJsb2NrMS5yZWNvdmVyZWRfYmxvY2suaGFzaCgpKTsKCiAgICAgICAgLy8gVGVzdCBjb21taXQgbm90aWZpY2F0aW9uCiAgICAgICAgbGV0IGNoYWluX2NvbW1pdCA9IE5ld0Nhbm9uaWNhbENoYWluOjpDb21taXQgeyBuZXc6IHZlYyFbYmxvY2swLmNsb25lKCksIGJsb2NrMS5jbG9uZSgpXSB9OwoKICAgICAgICAvLyBCdWlsZCBleHBlY3RlZCB0cmllIHVwZGF0ZXMgbWFwCiAgICAgICAgbGV0IG11dCBleHBlY3RlZF90cmllX3VwZGF0ZXMgPSBCVHJlZU1hcDo6bmV3KCk7CiAgICAgICAgZXhwZWN0ZWRfdHJpZV91cGRhdGVzLmluc2VydCgwLCBibG9jazAudHJpZV91cGRhdGVzKCkpOwogICAgICAgIGV4cGVjdGVkX3RyaWVfdXBkYXRlcy5pbnNlcnQoMSwgYmxvY2sxLnRyaWVfdXBkYXRlcygpKTsKCiAgICAgICAgLy8gQnVpbGQgZXhwZWN0ZWQgaGFzaGVkIHN0YXRlIG1hcAogICAgICAgIGxldCBtdXQgZXhwZWN0ZWRfaGFzaGVkX3N0YXRlID0gQlRyZWVNYXA6Om5ldygpOwogICAgICAgIGV4cGVjdGVkX2hhc2hlZF9zdGF0ZS5pbnNlcnQoMCwgYmxvY2swLmhhc2hlZF9zdGF0ZSgpKTsKICAgICAgICBleHBlY3RlZF9oYXNoZWRfc3RhdGUuaW5zZXJ0KDEsIGJsb2NrMS5oYXNoZWRfc3RhdGUoKSk7CgogICAgICAgIC8vIEJ1aWxkIGV4cGVjdGVkIGV4ZWN1dGlvbiBvdXRjb21lIChmaXJzdF9ibG9jayBtYXRjaGVzIGZpcnN0IGJsb2NrIG51bWJlcikKICAgICAgICBsZXQgY29tbWl0X2V4ZWN1dGlvbl9vdXRjb21lID0gRXhlY3V0aW9uT3V0Y29tZSB7CiAgICAgICAgICAgIHJlY2VpcHRzOiB2ZWMhW3ZlYyFbXSwgdmVjIVtdXSwKICAgICAgICAgICAgcmVxdWVzdHM6IHZlYyFbUmVxdWVzdHM6OmRlZmF1bHQoKSwgUmVxdWVzdHM6OmRlZmF1bHQoKV0sCiAgICAgICAgICAgIGZpcnN0X2Jsb2NrOiAwLAogICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgIH07CgogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGNoYWluX2NvbW1pdC50b19jaGFpbl9ub3RpZmljYXRpb24oKSwKICAgICAgICAgICAgQ2Fub25TdGF0ZU5vdGlmaWNhdGlvbjo6Q29tbWl0IHsKICAgICAgICAgICAgICAgIG5ldzogQXJjOjpuZXcoQ2hhaW46Om5ldygKICAgICAgICAgICAgICAgICAgICB2ZWMhW2Jsb2NrMC5yZWNvdmVyZWRfYmxvY2soKS5jbG9uZSgpLCBibG9jazEucmVjb3ZlcmVkX2Jsb2NrKCkuY2xvbmUoKV0sCiAgICAgICAgICAgICAgICAgICAgY29tbWl0X2V4ZWN1dGlvbl9vdXRjb21lLAogICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkX3RyaWVfdXBkYXRlcywKICAgICAgICAgICAgICAgICAgICBleHBlY3RlZF9oYXNoZWRfc3RhdGUKICAgICAgICAgICAgICAgICkpCiAgICAgICAgICAgIH0KICAgICAgICApOwoKICAgICAgICAvLyBUZXN0IHJlb3JnIG5vdGlmaWNhdGlvbgogICAgICAgIGxldCBjaGFpbl9yZW9yZyA9IE5ld0Nhbm9uaWNhbENoYWluOjpSZW9yZyB7CiAgICAgICAgICAgIG5ldzogdmVjIVtibG9jazFhLmNsb25lKCksIGJsb2NrMmEuY2xvbmUoKV0sCiAgICAgICAgICAgIG9sZDogdmVjIVtibG9jazEuY2xvbmUoKSwgYmxvY2syLmNsb25lKCldLAogICAgICAgIH07CgogICAgICAgIC8vIEJ1aWxkIGV4cGVjdGVkIHRyaWUgdXBkYXRlcyBmb3Igb2xkIGNoYWluCiAgICAgICAgbGV0IG11dCBvbGRfdHJpZV91cGRhdGVzID0gQlRyZWVNYXA6Om5ldygpOwogICAgICAgIG9sZF90cmllX3VwZGF0ZXMuaW5zZXJ0KDEsIGJsb2NrMS50cmllX3VwZGF0ZXMoKSk7CiAgICAgICAgb2xkX3RyaWVfdXBkYXRlcy5pbnNlcnQoMiwgYmxvY2syLnRyaWVfdXBkYXRlcygpKTsKCiAgICAgICAgLy8gQnVpbGQgZXhwZWN0ZWQgdHJpZSB1cGRhdGVzIGZvciBuZXcgY2hhaW4KICAgICAgICBsZXQgbXV0IG5ld190cmllX3VwZGF0ZXMgPSBCVHJlZU1hcDo6bmV3KCk7CiAgICAgICAgbmV3X3RyaWVfdXBkYXRlcy5pbnNlcnQoMSwgYmxvY2sxYS50cmllX3VwZGF0ZXMoKSk7CiAgICAgICAgbmV3X3RyaWVfdXBkYXRlcy5pbnNlcnQoMiwgYmxvY2syYS50cmllX3VwZGF0ZXMoKSk7CgogICAgICAgIC8vIEJ1aWxkIGV4cGVjdGVkIGhhc2hlZCBzdGF0ZSBmb3Igb2xkIGNoYWluCiAgICAgICAgbGV0IG11dCBvbGRfaGFzaGVkX3N0YXRlID0gQlRyZWVNYXA6Om5ldygpOwogICAgICAgIG9sZF9oYXNoZWRfc3RhdGUuaW5zZXJ0KDEsIGJsb2NrMS5oYXNoZWRfc3RhdGUoKSk7CiAgICAgICAgb2xkX2hhc2hlZF9zdGF0ZS5pbnNlcnQoMiwgYmxvY2syLmhhc2hlZF9zdGF0ZSgpKTsKCiAgICAgICAgLy8gQnVpbGQgZXhwZWN0ZWQgaGFzaGVkIHN0YXRlIGZvciBuZXcgY2hhaW4KICAgICAgICBsZXQgbXV0IG5ld19oYXNoZWRfc3RhdGUgPSBCVHJlZU1hcDo6bmV3KCk7CiAgICAgICAgbmV3X2hhc2hlZF9zdGF0ZS5pbnNlcnQoMSwgYmxvY2sxYS5oYXNoZWRfc3RhdGUoKSk7CiAgICAgICAgbmV3X2hhc2hlZF9zdGF0ZS5pbnNlcnQoMiwgYmxvY2syYS5oYXNoZWRfc3RhdGUoKSk7CgogICAgICAgIC8vIEJ1aWxkIGV4cGVjdGVkIGV4ZWN1dGlvbiBvdXRjb21lIGZvciByZW9yZyBjaGFpbnMgKGZpcnN0X2Jsb2NrIG1hdGNoZXMgZmlyc3QgYmxvY2sKICAgICAgICAvLyBudW1iZXIpCiAgICAgICAgbGV0IHJlb3JnX2V4ZWN1dGlvbl9vdXRjb21lID0gRXhlY3V0aW9uT3V0Y29tZSB7CiAgICAgICAgICAgIHJlY2VpcHRzOiB2ZWMhW3ZlYyFbXSwgdmVjIVtdXSwKICAgICAgICAgICAgcmVxdWVzdHM6IHZlYyFbUmVxdWVzdHM6OmRlZmF1bHQoKSwgUmVxdWVzdHM6OmRlZmF1bHQoKV0sCiAgICAgICAgICAgIGZpcnN0X2Jsb2NrOiAxLAogICAgICAgICAgICAuLkRlZmF1bHQ6OmRlZmF1bHQoKQogICAgICAgIH07CgogICAgICAgIGFzc2VydF9lcSEoCiAgICAgICAgICAgIGNoYWluX3Jlb3JnLnRvX2NoYWluX25vdGlmaWNhdGlvbigpLAogICAgICAgICAgICBDYW5vblN0YXRlTm90aWZpY2F0aW9uOjpSZW9yZyB7CiAgICAgICAgICAgICAgICBvbGQ6IEFyYzo6bmV3KENoYWluOjpuZXcoCiAgICAgICAgICAgICAgICAgICAgdmVjIVtibG9jazEucmVjb3ZlcmVkX2Jsb2NrKCkuY2xvbmUoKSwgYmxvY2syLnJlY292ZXJlZF9ibG9jaygpLmNsb25lKCldLAogICAgICAgICAgICAgICAgICAgIHJlb3JnX2V4ZWN1dGlvbl9vdXRjb21lLmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgb2xkX3RyaWVfdXBkYXRlcywKICAgICAgICAgICAgICAgICAgICBvbGRfaGFzaGVkX3N0YXRlCiAgICAgICAgICAgICAgICApKSwKICAgICAgICAgICAgICAgIG5ldzogQXJjOjpuZXcoQ2hhaW46Om5ldygKICAgICAgICAgICAgICAgICAgICB2ZWMhW2Jsb2NrMWEucmVjb3ZlcmVkX2Jsb2NrKCkuY2xvbmUoKSwgYmxvY2syYS5yZWNvdmVyZWRfYmxvY2soKS5jbG9uZSgpXSwKICAgICAgICAgICAgICAgICAgICByZW9yZ19leGVjdXRpb25fb3V0Y29tZSwKICAgICAgICAgICAgICAgICAgICBuZXdfdHJpZV91cGRhdGVzLAogICAgICAgICAgICAgICAgICAgIG5ld19oYXNoZWRfc3RhdGUKICAgICAgICAgICAgICAgICkpCiAgICAgICAgICAgIH0KICAgICAgICApOwogICAgfQp9CjwvZmlsZT4KCjxmaWxlIHBhdGg9ImNyYXRlcy9jb25maWcvc3JjL2NvbmZpZy5ycyI+Ci8vISBDb25maWd1cmF0aW9uIGZpbGVzLgp1c2UgcmV0aF9uZXR3b3JrX3R5cGVzOjp7UGVlcnNDb25maWcsIFNlc3Npb25zQ29uZmlnfTsKdXNlIHJldGhfcHJ1bmVfdHlwZXM6OlBydW5lTW9kZXM7CnVzZSByZXRoX3N0YWdlc190eXBlczo6RXhlY3V0aW9uU3RhZ2VUaHJlc2hvbGRzOwp1c2UgcmV0aF9zdGF0aWNfZmlsZV90eXBlczo6e1N0YXRpY0ZpbGVNYXAsIFN0YXRpY0ZpbGVTZWdtZW50fTsKdXNlIHN0ZDo6ewogICAgcGF0aDo6e1BhdGgsIFBhdGhCdWZ9LAogICAgdGltZTo6RHVyYXRpb24sCn07CnVzZSB1cmw6OlVybDsKCiNbY2ZnKGZlYXR1cmUgPSAic2VyZGUiKV0KY29uc3QgRVhURU5TSU9OOiAmc3RyID0gInRvbWwiOwoKLy8vIFRoZSBkZWZhdWx0IHBydW5lIGJsb2NrIGludGVydmFsCnB1YiBjb25zdCBERUZBVUxUX0JMT0NLX0lOVEVSVkFMOiB1c2l6ZSA9IDU7CgovLy8gQ29uZmlndXJhdGlvbiBmb3IgdGhlIHJldGggbm9kZS4KI1tkZXJpdmUoRGVidWcsIENsb25lLCBEZWZhdWx0LCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgZGVyaXZlKHNlcmRlOjpTZXJpYWxpemUsIHNlcmRlOjpEZXNlcmlhbGl6ZSkpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZShkZWZhdWx0KSldCnB1YiBzdHJ1Y3QgQ29uZmlnIHsKICAgIC8vLyBDb25maWd1cmF0aW9uIGZvciBlYWNoIHN0YWdlIGluIHRoZSBwaXBlbGluZS4KICAgIHB1YiBzdGFnZXM6IFN0YWdlQ29uZmlnLAogICAgLy8vIENvbmZpZ3VyYXRpb24gZm9yIHBydW5pbmcuCiAgICAjW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZShkZWZhdWx0KSldCiAgICBwdWIgcHJ1bmU6IFBydW5lQ29uZmlnLAogICAgLy8vIENvbmZpZ3VyYXRpb24gZm9yIHRoZSBkaXNjb3Zlcnkgc2VydmljZS4KICAgIHB1YiBwZWVyczogUGVlcnNDb25maWcsCiAgICAvLy8gQ29uZmlndXJhdGlvbiBmb3IgcGVlciBzZXNzaW9ucy4KICAgIHB1YiBzZXNzaW9uczogU2Vzc2lvbnNDb25maWcsCiAgICAvLy8gQ29uZmlndXJhdGlvbiBmb3Igc3RhdGljIGZpbGVzLgogICAgI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgc2VyZGUoZGVmYXVsdCkpXQogICAgcHViIHN0YXRpY19maWxlczogU3RhdGljRmlsZXNDb25maWcsCn0KCmltcGwgQ29uZmlnIHsKICAgIC8vLyBTZXRzIHRoZSBwcnVuaW5nIGNvbmZpZ3VyYXRpb24uCiAgICBwdWIgZm4gc2V0X3BydW5lX2NvbmZpZygmbXV0IHNlbGYsIHBydW5lX2NvbmZpZzogUHJ1bmVDb25maWcpIHsKICAgICAgICBzZWxmLnBydW5lID0gcHJ1bmVfY29uZmlnOwogICAgfQp9CgojW2NmZyhmZWF0dXJlID0gInNlcmRlIildCmltcGwgQ29uZmlnIHsKICAgIC8vLyBMb2FkIGEgW2BDb25maWdgXSBmcm9tIGEgc3BlY2lmaWVkIHBhdGguCiAgICAvLy8KICAgIC8vLyBBIG5ldyBjb25maWd1cmF0aW9uIGZpbGUgaXMgY3JlYXRlZCB3aXRoIGRlZmF1bHQgdmFsdWVzIGlmIG5vbmUKICAgIC8vLyBleGlzdHMuCiAgICBwdWIgZm4gZnJvbV9wYXRoKHBhdGg6IGltcGwgQXNSZWY8UGF0aD4pIC0+IGV5cmU6OlJlc3VsdDxTZWxmPiB7CiAgICAgICAgbGV0IHBhdGggPSBwYXRoLmFzX3JlZigpOwogICAgICAgIG1hdGNoIHN0ZDo6ZnM6OnJlYWRfdG9fc3RyaW5nKHBhdGgpIHsKICAgICAgICAgICAgT2soY2ZnX3N0cmluZykgPT4gewogICAgICAgICAgICAgICAgdG9tbDo6ZnJvbV9zdHIoJmNmZ19zdHJpbmcpLm1hcF9lcnIofGV8IGV5cmU6OmV5cmUhKCJGYWlsZWQgdG8gcGFyc2UgVE9NTDoge2V9IikpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyKGUpIGlmIGUua2luZCgpID09IHN0ZDo6aW86OkVycm9yS2luZDo6Tm90Rm91bmQgPT4gewogICAgICAgICAgICAgICAgaWYgbGV0IFNvbWUocGFyZW50KSA9IHBhdGgucGFyZW50KCkgewogICAgICAgICAgICAgICAgICAgIHN0ZDo6ZnM6OmNyZWF0ZV9kaXJfYWxsKHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIofGV8IGV5cmU6OmV5cmUhKCJGYWlsZWQgdG8gY3JlYXRlIGRpcmVjdG9yeToge2V9IikpPzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxldCBjZmcgPSBTZWxmOjpkZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBsZXQgcyA9IHRvbWw6OnRvX3N0cmluZ19wcmV0dHkoJmNmZykKICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXwgZXlyZTo6ZXlyZSEoIkZhaWxlZCB0byBzZXJpYWxpemUgdG8gVE9NTDoge2V9IikpPzsKICAgICAgICAgICAgICAgIHN0ZDo6ZnM6OndyaXRlKHBhdGgsIHMpCiAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIofGV8IGV5cmU6OmV5cmUhKCJGYWlsZWQgdG8gd3JpdGUgY29uZmlndXJhdGlvbiBmaWxlOiB7ZX0iKSk/OwogICAgICAgICAgICAgICAgT2soY2ZnKQogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycihlKSA9PiBFcnIoZXlyZTo6ZXlyZSEoIkZhaWxlZCB0byBsb2FkIGNvbmZpZ3VyYXRpb246IHtlfSIpKSwKICAgICAgICB9CiAgICB9CgogICAgLy8vIFJldHVybnMgdGhlIFtgUGVlcnNDb25maWdgXSBmb3IgdGhlIG5vZGUuCiAgICAvLy8KICAgIC8vLyBJZiBhIHBlZXJzIGZpbGUgaXMgcHJvdmlkZWQsIHRoZSBiYXNpYyBub2RlcyBmcm9tIHRoZSBmaWxlIGFyZSBhZGRlZCB0byB0aGUgY29uZmlndXJhdGlvbi4KICAgIHB1YiBmbiBwZWVyc19jb25maWdfd2l0aF9iYXNpY19ub2Rlc19mcm9tX2ZpbGUoCiAgICAgICAgJnNlbGYsCiAgICAgICAgcGVlcnNfZmlsZTogT3B0aW9uPCZQYXRoPiwKICAgICkgLT4gUGVlcnNDb25maWcgewogICAgICAgIHNlbGYucGVlcnMKICAgICAgICAgICAgLmNsb25lKCkKICAgICAgICAgICAgLndpdGhfYmFzaWNfbm9kZXNfZnJvbV9maWxlKHBlZXJzX2ZpbGUpCiAgICAgICAgICAgIC51bndyYXBfb3JfZWxzZSh8X3wgc2VsZi5wZWVycy5jbG9uZSgpKQogICAgfQoKICAgIC8vLyBTYXZlIHRoZSBjb25maWd1cmF0aW9uIHRvIHRvbWwgZmlsZS4KICAgIHB1YiBmbiBzYXZlKCZzZWxmLCBwYXRoOiAmUGF0aCkgLT4gUmVzdWx0PCgpLCBzdGQ6OmlvOjpFcnJvcj4gewogICAgICAgIGlmIHBhdGguZXh0ZW5zaW9uKCkgIT0gU29tZShzdGQ6OmZmaTo6T3NTdHI6Om5ldyhFWFRFTlNJT04pKSB7CiAgICAgICAgICAgIHJldHVybiBFcnIoc3RkOjppbzo6RXJyb3I6Om5ldygKICAgICAgICAgICAgICAgIHN0ZDo6aW86OkVycm9yS2luZDo6SW52YWxpZElucHV0LAogICAgICAgICAgICAgICAgZm9ybWF0ISgicmV0aCBjb25maWcgZmlsZSBleHRlbnNpb24gbXVzdCBiZSAne0VYVEVOU0lPTn0nIiksCiAgICAgICAgICAgICkpOwogICAgICAgIH0KCiAgICAgICAgc3RkOjpmczo6d3JpdGUoCiAgICAgICAgICAgIHBhdGgsCiAgICAgICAgICAgIHRvbWw6OnRvX3N0cmluZyhzZWxmKQogICAgICAgICAgICAgICAgLm1hcF9lcnIofGV8IHN0ZDo6aW86OkVycm9yOjpuZXcoc3RkOjppbzo6RXJyb3JLaW5kOjpJbnZhbGlkRGF0YSwgZS50b19zdHJpbmcoKSkpPywKICAgICAgICApCiAgICB9Cn0KCi8vLyBDb25maWd1cmF0aW9uIGZvciBlYWNoIHN0YWdlIGluIHRoZSBwaXBlbGluZS4KI1tkZXJpdmUoRGVidWcsIENsb25lLCBEZWZhdWx0LCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgZGVyaXZlKHNlcmRlOjpTZXJpYWxpemUsIHNlcmRlOjpEZXNlcmlhbGl6ZSkpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZShkZWZhdWx0KSldCnB1YiBzdHJ1Y3QgU3RhZ2VDb25maWcgewogICAgLy8vIEVSQSBzdGFnZSBjb25maWd1cmF0aW9uLgogICAgcHViIGVyYTogRXJhQ29uZmlnLAogICAgLy8vIEhlYWRlciBzdGFnZSBjb25maWd1cmF0aW9uLgogICAgcHViIGhlYWRlcnM6IEhlYWRlcnNDb25maWcsCiAgICAvLy8gQm9keSBzdGFnZSBjb25maWd1cmF0aW9uLgogICAgcHViIGJvZGllczogQm9kaWVzQ29uZmlnLAogICAgLy8vIFNlbmRlciBSZWNvdmVyeSBzdGFnZSBjb25maWd1cmF0aW9uLgogICAgcHViIHNlbmRlcl9yZWNvdmVyeTogU2VuZGVyUmVjb3ZlcnlDb25maWcsCiAgICAvLy8gRXhlY3V0aW9uIHN0YWdlIGNvbmZpZ3VyYXRpb24uCiAgICBwdWIgZXhlY3V0aW9uOiBFeGVjdXRpb25Db25maWcsCiAgICAvLy8gUHJ1bmUgc3RhZ2UgY29uZmlndXJhdGlvbi4KICAgIHB1YiBwcnVuZTogUHJ1bmVTdGFnZUNvbmZpZywKICAgIC8vLyBBY2NvdW50IEhhc2hpbmcgc3RhZ2UgY29uZmlndXJhdGlvbi4KICAgIHB1YiBhY2NvdW50X2hhc2hpbmc6IEhhc2hpbmdDb25maWcsCiAgICAvLy8gU3RvcmFnZSBIYXNoaW5nIHN0YWdlIGNvbmZpZ3VyYXRpb24uCiAgICBwdWIgc3RvcmFnZV9oYXNoaW5nOiBIYXNoaW5nQ29uZmlnLAogICAgLy8vIE1lcmtsZSBzdGFnZSBjb25maWd1cmF0aW9uLgogICAgcHViIG1lcmtsZTogTWVya2xlQ29uZmlnLAogICAgLy8vIFRyYW5zYWN0aW9uIExvb2t1cCBzdGFnZSBjb25maWd1cmF0aW9uLgogICAgcHViIHRyYW5zYWN0aW9uX2xvb2t1cDogVHJhbnNhY3Rpb25Mb29rdXBDb25maWcsCiAgICAvLy8gSW5kZXggQWNjb3VudCBIaXN0b3J5IHN0YWdlIGNvbmZpZ3VyYXRpb24uCiAgICBwdWIgaW5kZXhfYWNjb3VudF9oaXN0b3J5OiBJbmRleEhpc3RvcnlDb25maWcsCiAgICAvLy8gSW5kZXggU3RvcmFnZSBIaXN0b3J5IHN0YWdlIGNvbmZpZ3VyYXRpb24uCiAgICBwdWIgaW5kZXhfc3RvcmFnZV9oaXN0b3J5OiBJbmRleEhpc3RvcnlDb25maWcsCiAgICAvLy8gQ29tbW9uIEVUTCByZWxhdGVkIGNvbmZpZ3VyYXRpb24uCiAgICBwdWIgZXRsOiBFdGxDb25maWcsCn0KCmltcGwgU3RhZ2VDb25maWcgewogICAgLy8vIFRoZSBoaWdoZXN0IHRocmVzaG9sZCAoaW4gbnVtYmVyIG9mIGJsb2NrcykgZm9yIHN3aXRjaGluZyBiZXR3ZWVuIGluY3JlbWVudGFsIGFuZCBmdWxsCiAgICAvLy8gY2FsY3VsYXRpb25zIGFjcm9zcyBgTWVya2xlU3RhZ2VgLCBgQWNjb3VudEhhc2hpbmdTdGFnZWAgYW5kIGBTdG9yYWdlSGFzaGluZ1N0YWdlYC4gVGhpcyBpcwogICAgLy8vIHJlcXVpcmVkIHRvIGZpZ3VyZSBvdXQgaWYgY2FuIHBydW5lIG9yIG5vdCBjaGFuZ2VzZXRzIG9uIHN1YnNlcXVlbnQgcGlwZWxpbmUgcnVucyBkdXJpbmcKICAgIC8vLyBgRXhlY3V0aW9uU3RhZ2VgCiAgICBwdWIgZm4gZXhlY3V0aW9uX2V4dGVybmFsX2NsZWFuX3RocmVzaG9sZCgmc2VsZikgLT4gdTY0IHsKICAgICAgICBzZWxmLm1lcmtsZQogICAgICAgICAgICAuaW5jcmVtZW50YWxfdGhyZXNob2xkCiAgICAgICAgICAgIC5tYXgoc2VsZi5hY2NvdW50X2hhc2hpbmcuY2xlYW5fdGhyZXNob2xkKQogICAgICAgICAgICAubWF4KHNlbGYuc3RvcmFnZV9oYXNoaW5nLmNsZWFuX3RocmVzaG9sZCkKICAgIH0KfQoKLy8vIEVSQSBzdGFnZSBjb25maWd1cmF0aW9uLgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIERlZmF1bHQsIFBhcnRpYWxFcSwgRXEpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKGRlZmF1bHQpKV0KcHViIHN0cnVjdCBFcmFDb25maWcgewogICAgLy8vIFBhdGggdG8gYSBsb2NhbCBkaXJlY3Rvcnkgd2hlcmUgRVJBMSBmaWxlcyBhcmUgbG9jYXRlZC4KICAgIC8vLwogICAgLy8vIENvbmZsaWN0cyB3aXRoIGB1cmxgLgogICAgcHViIHBhdGg6IE9wdGlvbjxQYXRoQnVmPiwKICAgIC8vLyBUaGUgYmFzZSBVUkwgb2YgYW4gRVJBMSBmaWxlIGhvc3QgdG8gZG93bmxvYWQgZnJvbS4KICAgIC8vLwogICAgLy8vIENvbmZsaWN0cyB3aXRoIGBwYXRoYC4KICAgIHB1YiB1cmw6IE9wdGlvbjxVcmw+LAogICAgLy8vIFBhdGggdG8gYSBkaXJlY3Rvcnkgd2hlcmUgZmlsZXMgZG93bmxvYWRlZCBmcm9tIGB1cmxgIHdpbGwgYmUgc3RvcmVkIHVudGlsIHByb2Nlc3NlZC4KICAgIC8vLwogICAgLy8vIFJlcXVpcmVkIGZvciBgdXJsYC4KICAgIHB1YiBmb2xkZXI6IE9wdGlvbjxQYXRoQnVmPiwKfQoKaW1wbCBFcmFDb25maWcgewogICAgLy8vIFNldHMgYGZvbGRlcmAgZm9yIHRlbXBvcmFyeSBkb3dubG9hZHMgYXMgYSBkaXJlY3RvcnkgY2FsbGVkICJlcmEiIGluc2lkZSBgZGlyYC4KICAgIHB1YiBmbiB3aXRoX2RhdGFkaXIobXV0IHNlbGYsIGRpcjogaW1wbCBBc1JlZjxQYXRoPikgLT4gU2VsZiB7CiAgICAgICAgc2VsZi5mb2xkZXIgPSBTb21lKGRpci5hc19yZWYoKS5qb2luKCJlcmEiKSk7CiAgICAgICAgc2VsZgogICAgfQp9CgovLy8gSGVhZGVyIHN0YWdlIGNvbmZpZ3VyYXRpb24uCiNbZGVyaXZlKERlYnVnLCBDbG9uZSwgQ29weSwgUGFydGlhbEVxLCBFcSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgc2VyZGUoZGVmYXVsdCkpXQpwdWIgc3RydWN0IEhlYWRlcnNDb25maWcgewogICAgLy8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiByZXF1ZXN0cyB0byBzZW5kIGNvbmN1cnJlbnRseS4KICAgIC8vLwogICAgLy8vIERlZmF1bHQ6IDEwMAogICAgcHViIGRvd25sb2FkZXJfbWF4X2NvbmN1cnJlbnRfcmVxdWVzdHM6IHVzaXplLAogICAgLy8vIFRoZSBtaW5pbXVtIG51bWJlciBvZiByZXF1ZXN0cyB0byBzZW5kIGNvbmN1cnJlbnRseS4KICAgIC8vLwogICAgLy8vIERlZmF1bHQ6IDUKICAgIHB1YiBkb3dubG9hZGVyX21pbl9jb25jdXJyZW50X3JlcXVlc3RzOiB1c2l6ZSwKICAgIC8vLyBNYXhpbXVtIGFtb3VudCBvZiByZXNwb25zZXMgdG8gYnVmZmVyIGludGVybmFsbHkuCiAgICAvLy8gVGhlIHJlc3BvbnNlIGNvbnRhaW5zIG11bHRpcGxlIGhlYWRlcnMuCiAgICBwdWIgZG93bmxvYWRlcl9tYXhfYnVmZmVyZWRfcmVzcG9uc2VzOiB1c2l6ZSwKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2YgaGVhZGVycyB0byByZXF1ZXN0IGZyb20gYSBwZWVyIGF0IGEgdGltZS4KICAgIHB1YiBkb3dubG9hZGVyX3JlcXVlc3RfbGltaXQ6IHU2NCwKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2YgaGVhZGVycyB0byBkb3dubG9hZCBiZWZvcmUgY29tbWl0dGluZyBwcm9ncmVzcyB0byB0aGUgZGF0YWJhc2UuCiAgICBwdWIgY29tbWl0X3RocmVzaG9sZDogdTY0LAp9CgppbXBsIERlZmF1bHQgZm9yIEhlYWRlcnNDb25maWcgewogICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgIFNlbGYgewogICAgICAgICAgICBjb21taXRfdGhyZXNob2xkOiAxMF8wMDAsCiAgICAgICAgICAgIGRvd25sb2FkZXJfcmVxdWVzdF9saW1pdDogMV8wMDAsCiAgICAgICAgICAgIGRvd25sb2FkZXJfbWF4X2NvbmN1cnJlbnRfcmVxdWVzdHM6IDEwMCwKICAgICAgICAgICAgZG93bmxvYWRlcl9taW5fY29uY3VycmVudF9yZXF1ZXN0czogNSwKICAgICAgICAgICAgZG93bmxvYWRlcl9tYXhfYnVmZmVyZWRfcmVzcG9uc2VzOiAxMDAsCiAgICAgICAgfQogICAgfQp9CgovLy8gQm9keSBzdGFnZSBjb25maWd1cmF0aW9uLgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIENvcHksIFBhcnRpYWxFcSwgRXEpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKGRlZmF1bHQpKV0KcHViIHN0cnVjdCBCb2RpZXNDb25maWcgewogICAgLy8vIFRoZSBiYXRjaCBzaXplIG9mIG5vbi1lbXB0eSBibG9ja3MgcGVyIG9uZSByZXF1ZXN0CiAgICAvLy8KICAgIC8vLyBEZWZhdWx0OiAyMDAKICAgIHB1YiBkb3dubG9hZGVyX3JlcXVlc3RfbGltaXQ6IHU2NCwKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2YgYmxvY2sgYm9kaWVzIHJldHVybmVkIGF0IG9uY2UgZnJvbSB0aGUgc3RyZWFtCiAgICAvLy8KICAgIC8vLyBEZWZhdWx0OiBgMV8wMDBgCiAgICBwdWIgZG93bmxvYWRlcl9zdHJlYW1fYmF0Y2hfc2l6ZTogdXNpemUsCiAgICAvLy8gVGhlIHNpemUgb2YgdGhlIGludGVybmFsIGJsb2NrIGJ1ZmZlciBpbiBieXRlcy4KICAgIC8vLwogICAgLy8vIERlZmF1bHQ6IDJHQgogICAgcHViIGRvd25sb2FkZXJfbWF4X2J1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzOiB1c2l6ZSwKICAgIC8vLyBUaGUgbWluaW11bSBudW1iZXIgb2YgcmVxdWVzdHMgdG8gc2VuZCBjb25jdXJyZW50bHkuCiAgICAvLy8KICAgIC8vLyBEZWZhdWx0OiA1CiAgICBwdWIgZG93bmxvYWRlcl9taW5fY29uY3VycmVudF9yZXF1ZXN0czogdXNpemUsCiAgICAvLy8gVGhlIG1heGltdW0gbnVtYmVyIG9mIHJlcXVlc3RzIHRvIHNlbmQgY29uY3VycmVudGx5LgogICAgLy8vIFRoaXMgaXMgZXF1YWwgdG8gdGhlIG1heCBudW1iZXIgb2YgcGVlcnMuCiAgICAvLy8KICAgIC8vLyBEZWZhdWx0OiAxMDAKICAgIHB1YiBkb3dubG9hZGVyX21heF9jb25jdXJyZW50X3JlcXVlc3RzOiB1c2l6ZSwKfQoKaW1wbCBEZWZhdWx0IGZvciBCb2RpZXNDb25maWcgewogICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgIFNlbGYgewogICAgICAgICAgICBkb3dubG9hZGVyX3JlcXVlc3RfbGltaXQ6IDIwMCwKICAgICAgICAgICAgZG93bmxvYWRlcl9zdHJlYW1fYmF0Y2hfc2l6ZTogMV8wMDAsCiAgICAgICAgICAgIGRvd25sb2FkZXJfbWF4X2J1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzOiAyICogMTAyNCAqIDEwMjQgKiAxMDI0LCAvLyB+MkdCCiAgICAgICAgICAgIGRvd25sb2FkZXJfbWluX2NvbmN1cnJlbnRfcmVxdWVzdHM6IDUsCiAgICAgICAgICAgIGRvd25sb2FkZXJfbWF4X2NvbmN1cnJlbnRfcmVxdWVzdHM6IDEwMCwKICAgICAgICB9CiAgICB9Cn0KCi8vLyBTZW5kZXIgcmVjb3Zlcnkgc3RhZ2UgY29uZmlndXJhdGlvbi4KI1tkZXJpdmUoRGVidWcsIENsb25lLCBDb3B5LCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgZGVyaXZlKHNlcmRlOjpTZXJpYWxpemUsIHNlcmRlOjpEZXNlcmlhbGl6ZSkpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZShkZWZhdWx0KSldCnB1YiBzdHJ1Y3QgU2VuZGVyUmVjb3ZlcnlDb25maWcgewogICAgLy8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiB0cmFuc2FjdGlvbnMgdG8gcHJvY2VzcyBiZWZvcmUgY29tbWl0dGluZyBwcm9ncmVzcyB0byB0aGUgZGF0YWJhc2UuCiAgICBwdWIgY29tbWl0X3RocmVzaG9sZDogdTY0LAp9CgppbXBsIERlZmF1bHQgZm9yIFNlbmRlclJlY292ZXJ5Q29uZmlnIHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgY29tbWl0X3RocmVzaG9sZDogNV8wMDBfMDAwIH0KICAgIH0KfQoKLy8vIEV4ZWN1dGlvbiBzdGFnZSBjb25maWd1cmF0aW9uLgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIENvcHksIFBhcnRpYWxFcSwgRXEpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKGRlZmF1bHQpKV0KcHViIHN0cnVjdCBFeGVjdXRpb25Db25maWcgewogICAgLy8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiBibG9ja3MgdG8gcHJvY2VzcyBiZWZvcmUgdGhlIGV4ZWN1dGlvbiBzdGFnZSBjb21taXRzLgogICAgcHViIG1heF9ibG9ja3M6IE9wdGlvbjx1NjQ+LAogICAgLy8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiBzdGF0ZSBjaGFuZ2VzIHRvIGtlZXAgaW4gbWVtb3J5IGJlZm9yZSB0aGUgZXhlY3V0aW9uIHN0YWdlIGNvbW1pdHMuCiAgICBwdWIgbWF4X2NoYW5nZXM6IE9wdGlvbjx1NjQ+LAogICAgLy8vIFRoZSBtYXhpbXVtIGN1bXVsYXRpdmUgYW1vdW50IG9mIGdhcyB0byBwcm9jZXNzIGJlZm9yZSB0aGUgZXhlY3V0aW9uIHN0YWdlIGNvbW1pdHMuCiAgICBwdWIgbWF4X2N1bXVsYXRpdmVfZ2FzOiBPcHRpb248dTY0PiwKICAgIC8vLyBUaGUgbWF4aW11bSB0aW1lIHNwZW50IG9uIGJsb2NrcyBwcm9jZXNzaW5nIGJlZm9yZSB0aGUgZXhlY3V0aW9uIHN0YWdlIGNvbW1pdHMuCiAgICAjW2NmZ19hdHRyKAogICAgICAgIGZlYXR1cmUgPSAic2VyZGUiLAogICAgICAgIHNlcmRlKAogICAgICAgICAgICBzZXJpYWxpemVfd2l0aCA9ICJodW1hbnRpbWVfc2VyZGU6OnNlcmlhbGl6ZSIsCiAgICAgICAgICAgIGRlc2VyaWFsaXplX3dpdGggPSAiZGVzZXJpYWxpemVfZHVyYXRpb24iCiAgICAgICAgKQogICAgKV0KICAgIHB1YiBtYXhfZHVyYXRpb246IE9wdGlvbjxEdXJhdGlvbj4sCn0KCmltcGwgRGVmYXVsdCBmb3IgRXhlY3V0aW9uQ29uZmlnIHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgbWF4X2Jsb2NrczogU29tZSg1MDBfMDAwKSwKICAgICAgICAgICAgbWF4X2NoYW5nZXM6IFNvbWUoNV8wMDBfMDAwKSwKICAgICAgICAgICAgLy8gNTBrIGZ1bGwgYmxvY2tzIG9mIDMwTSBnYXMKICAgICAgICAgICAgbWF4X2N1bXVsYXRpdmVfZ2FzOiBTb21lKDMwXzAwMF8wMDAgKiA1MF8wMDApLAogICAgICAgICAgICAvLyAxMCBtaW51dGVzCiAgICAgICAgICAgIG1heF9kdXJhdGlvbjogU29tZShEdXJhdGlvbjo6ZnJvbV9zZWNzKDEwICogNjApKSwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgRnJvbTxFeGVjdXRpb25Db25maWc+IGZvciBFeGVjdXRpb25TdGFnZVRocmVzaG9sZHMgewogICAgZm4gZnJvbShjb25maWc6IEV4ZWN1dGlvbkNvbmZpZykgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIG1heF9ibG9ja3M6IGNvbmZpZy5tYXhfYmxvY2tzLAogICAgICAgICAgICBtYXhfY2hhbmdlczogY29uZmlnLm1heF9jaGFuZ2VzLAogICAgICAgICAgICBtYXhfY3VtdWxhdGl2ZV9nYXM6IGNvbmZpZy5tYXhfY3VtdWxhdGl2ZV9nYXMsCiAgICAgICAgICAgIG1heF9kdXJhdGlvbjogY29uZmlnLm1heF9kdXJhdGlvbiwKICAgICAgICB9CiAgICB9Cn0KCi8vLyBQcnVuZSBzdGFnZSBjb25maWd1cmF0aW9uLgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIENvcHksIFBhcnRpYWxFcSwgRXEpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKGRlZmF1bHQpKV0KcHViIHN0cnVjdCBQcnVuZVN0YWdlQ29uZmlnIHsKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2YgZW50cmllcyB0byBwcnVuZSBiZWZvcmUgY29tbWl0dGluZyBwcm9ncmVzcyB0byB0aGUgZGF0YWJhc2UuCiAgICBwdWIgY29tbWl0X3RocmVzaG9sZDogdXNpemUsCn0KCmltcGwgRGVmYXVsdCBmb3IgUHJ1bmVTdGFnZUNvbmZpZyB7CiAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGNvbW1pdF90aHJlc2hvbGQ6IDFfMDAwXzAwMCB9CiAgICB9Cn0KCi8vLyBIYXNoaW5nIHN0YWdlIGNvbmZpZ3VyYXRpb24uCiNbZGVyaXZlKERlYnVnLCBDbG9uZSwgQ29weSwgUGFydGlhbEVxLCBFcSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgc2VyZGUoZGVmYXVsdCkpXQpwdWIgc3RydWN0IEhhc2hpbmdDb25maWcgewogICAgLy8vIFRoZSB0aHJlc2hvbGQgKGluIG51bWJlciBvZiBibG9ja3MpIGZvciBzd2l0Y2hpbmcgYmV0d2VlbgogICAgLy8vIGluY3JlbWVudGFsIGhhc2hpbmcgYW5kIGZ1bGwgaGFzaGluZy4KICAgIHB1YiBjbGVhbl90aHJlc2hvbGQ6IHU2NCwKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2YgZW50aXRpZXMgdG8gcHJvY2VzcyBiZWZvcmUgY29tbWl0dGluZyBwcm9ncmVzcyB0byB0aGUgZGF0YWJhc2UuCiAgICBwdWIgY29tbWl0X3RocmVzaG9sZDogdTY0LAp9CgppbXBsIERlZmF1bHQgZm9yIEhhc2hpbmdDb25maWcgewogICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBjbGVhbl90aHJlc2hvbGQ6IDUwMF8wMDAsIGNvbW1pdF90aHJlc2hvbGQ6IDEwMF8wMDAgfQogICAgfQp9CgovLy8gTWVya2xlIHN0YWdlIGNvbmZpZ3VyYXRpb24uCiNbZGVyaXZlKERlYnVnLCBDbG9uZSwgQ29weSwgUGFydGlhbEVxLCBFcSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgc2VyZGUoZGVmYXVsdCkpXQpwdWIgc3RydWN0IE1lcmtsZUNvbmZpZyB7CiAgICAvLy8gVGhlIG51bWJlciBvZiBibG9ja3Mgd2Ugd2lsbCBydW4gdGhlIGluY3JlbWVudGFsIHJvb3QgbWV0aG9kIGZvciB3aGVuIHdlIGFyZSBjYXRjaGluZyB1cCBvbgogICAgLy8vIHRoZSBtZXJrbGUgc3RhZ2UgZm9yIGEgbGFyZ2UgbnVtYmVyIG9mIGJsb2Nrcy4KICAgIC8vLwogICAgLy8vIFdoZW4gd2UgYXJlIGNhdGNoaW5nIHVwIGZvciBhIGxhcmdlIG51bWJlciBvZiBibG9ja3MsIHdlIGNhbiBvbmx5IHJ1biB0aGUgaW5jcmVtZW50YWwgcm9vdAogICAgLy8vIGZvciBhIGxpbWl0ZWQgbnVtYmVyIG9mIGJsb2Nrcywgb3RoZXJ3aXNlIHRoZSBpbmNyZW1lbnRhbCByb290IG1ldGhvZCBtYXkgY2F1c2UgdGhlIG5vZGUgdG8KICAgIC8vLyBPT00uIFRoaXMgbnVtYmVyIGRldGVybWluZXMgaG93IG1hbnkgYmxvY2tzIGluIGEgcm93IHdlIHdpbGwgcnVuIHRoZSBpbmNyZW1lbnRhbCByb290CiAgICAvLy8gbWV0aG9kIGZvci4KICAgIHB1YiBpbmNyZW1lbnRhbF90aHJlc2hvbGQ6IHU2NCwKICAgIC8vLyBUaGUgdGhyZXNob2xkIChpbiBudW1iZXIgb2YgYmxvY2tzKSBmb3Igc3dpdGNoaW5nIGZyb20gaW5jcmVtZW50YWwgdHJpZSBidWlsZGluZyBvZiBjaGFuZ2VzCiAgICAvLy8gdG8gd2hvbGUgcmVidWlsZC4KICAgIHB1YiByZWJ1aWxkX3RocmVzaG9sZDogdTY0LAp9CgppbXBsIERlZmF1bHQgZm9yIE1lcmtsZUNvbmZpZyB7CiAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGluY3JlbWVudGFsX3RocmVzaG9sZDogN18wMDAsIHJlYnVpbGRfdGhyZXNob2xkOiAxMDBfMDAwIH0KICAgIH0KfQoKLy8vIFRyYW5zYWN0aW9uIExvb2t1cCBzdGFnZSBjb25maWd1cmF0aW9uLgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIENvcHksIFBhcnRpYWxFcSwgRXEpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKGRlZmF1bHQpKV0KcHViIHN0cnVjdCBUcmFuc2FjdGlvbkxvb2t1cENvbmZpZyB7CiAgICAvLy8gVGhlIG1heGltdW0gbnVtYmVyIG9mIHRyYW5zYWN0aW9ucyB0byBwcm9jZXNzIGJlZm9yZSB3cml0aW5nIHRvIGRpc2suCiAgICBwdWIgY2h1bmtfc2l6ZTogdTY0LAp9CgppbXBsIERlZmF1bHQgZm9yIFRyYW5zYWN0aW9uTG9va3VwQ29uZmlnIHsKICAgIGZuIGRlZmF1bHQoKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgY2h1bmtfc2l6ZTogNV8wMDBfMDAwIH0KICAgIH0KfQoKLy8vIENvbW1vbiBFVEwgcmVsYXRlZCBjb25maWd1cmF0aW9uLgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIFBhcnRpYWxFcSwgRXEpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBkZXJpdmUoc2VyZGU6OlNlcmlhbGl6ZSwgc2VyZGU6OkRlc2VyaWFsaXplKSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIHNlcmRlKGRlZmF1bHQpKV0KcHViIHN0cnVjdCBFdGxDb25maWcgewogICAgLy8vIERhdGEgZGlyZWN0b3J5IHdoZXJlIHRlbXBvcmFyeSBmaWxlcyBhcmUgY3JlYXRlZC4KICAgIHB1YiBkaXI6IE9wdGlvbjxQYXRoQnVmPiwKICAgIC8vLyBUaGUgbWF4aW11bSBzaXplIGluIGJ5dGVzIG9mIGRhdGEgaGVsZCBpbiBtZW1vcnkgYmVmb3JlIGJlaW5nIGZsdXNoZWQgdG8gZGlzayBhcyBhIGZpbGUuCiAgICBwdWIgZmlsZV9zaXplOiB1c2l6ZSwKfQoKaW1wbCBEZWZhdWx0IGZvciBFdGxDb25maWcgewogICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBkaXI6IE5vbmUsIGZpbGVfc2l6ZTogU2VsZjo6ZGVmYXVsdF9maWxlX3NpemUoKSB9CiAgICB9Cn0KCmltcGwgRXRsQ29uZmlnIHsKICAgIC8vLyBDcmVhdGVzIGFuIEVUTCBjb25maWd1cmF0aW9uCiAgICBwdWIgY29uc3QgZm4gbmV3KGRpcjogT3B0aW9uPFBhdGhCdWY+LCBmaWxlX3NpemU6IHVzaXplKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsgZGlyLCBmaWxlX3NpemUgfQogICAgfQoKICAgIC8vLyBSZXR1cm4gZGVmYXVsdCBFVEwgZGlyZWN0b3J5IGZyb20gZGF0YWRpciBwYXRoLgogICAgcHViIGZuIGZyb21fZGF0YWRpcihwYXRoOiAmUGF0aCkgLT4gUGF0aEJ1ZiB7CiAgICAgICAgcGF0aC5qb2luKCJldGwtdG1wIikKICAgIH0KCiAgICAvLy8gRGVmYXVsdCBzaXplIGluIGJ5dGVzIG9mIGRhdGEgaGVsZCBpbiBtZW1vcnkgYmVmb3JlIGJlaW5nIGZsdXNoZWQgdG8gZGlzayBhcyBhIGZpbGUuCiAgICBwdWIgY29uc3QgZm4gZGVmYXVsdF9maWxlX3NpemUoKSAtPiB1c2l6ZSB7CiAgICAgICAgLy8gNTAwIE1CCiAgICAgICAgNTAwICogKDEwMjQgKiAxMDI0KQogICAgfQp9CgovLy8gU3RhdGljIGZpbGVzIGNvbmZpZ3VyYXRpb24uCiNbZGVyaXZlKERlYnVnLCBEZWZhdWx0LCBDbG9uZSwgQ29weSwgUGFydGlhbEVxLCBFcSldCiNbY2ZnX2F0dHIoZmVhdHVyZSA9ICJzZXJkZSIsIGRlcml2ZShzZXJkZTo6U2VyaWFsaXplLCBzZXJkZTo6RGVzZXJpYWxpemUpKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgc2VyZGUoZGVmYXVsdCkpXQpwdWIgc3RydWN0IFN0YXRpY0ZpbGVzQ29uZmlnIHsKICAgIC8vLyBOdW1iZXIgb2YgYmxvY2tzIHBlciBmaWxlIGZvciBlYWNoIHNlZ21lbnQuCiAgICBwdWIgYmxvY2tzX3Blcl9maWxlOiBCbG9ja3NQZXJGaWxlQ29uZmlnLAp9CgovLy8gQ29uZmlndXJhdGlvbiBmb3IgdGhlIG51bWJlciBvZiBibG9ja3MgcGVyIGZpbGUgZm9yIGVhY2ggc2VnbWVudC4KI1tkZXJpdmUoRGVidWcsIERlZmF1bHQsIENsb25lLCBDb3B5LCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgZGVyaXZlKHNlcmRlOjpTZXJpYWxpemUsIHNlcmRlOjpEZXNlcmlhbGl6ZSkpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZShkZWZhdWx0KSldCnB1YiBzdHJ1Y3QgQmxvY2tzUGVyRmlsZUNvbmZpZyB7CiAgICAvLy8gTnVtYmVyIG9mIGJsb2NrcyBwZXIgZmlsZSBmb3IgdGhlIGhlYWRlcnMgc2VnbWVudC4KICAgIHB1YiBoZWFkZXJzOiBPcHRpb248dTY0PiwKICAgIC8vLyBOdW1iZXIgb2YgYmxvY2tzIHBlciBmaWxlIGZvciB0aGUgdHJhbnNhY3Rpb25zIHNlZ21lbnQuCiAgICBwdWIgdHJhbnNhY3Rpb25zOiBPcHRpb248dTY0PiwKICAgIC8vLyBOdW1iZXIgb2YgYmxvY2tzIHBlciBmaWxlIGZvciB0aGUgcmVjZWlwdHMgc2VnbWVudC4KICAgIHB1YiByZWNlaXB0czogT3B0aW9uPHU2ND4sCiAgICAvLy8gTnVtYmVyIG9mIGJsb2NrcyBwZXIgZmlsZSBmb3IgdGhlIHRyYW5zYWN0aW9uIHNlbmRlcnMgc2VnbWVudC4KICAgIHB1YiB0cmFuc2FjdGlvbl9zZW5kZXJzOiBPcHRpb248dTY0PiwKICAgIC8vLyBOdW1iZXIgb2YgYmxvY2tzIHBlciBmaWxlIGZvciB0aGUgYWNjb3VudCBjaGFuZ2VzZXRzIHNlZ21lbnQuCiAgICBwdWIgYWNjb3VudF9jaGFuZ2Vfc2V0czogT3B0aW9uPHU2ND4sCn0KCmltcGwgU3RhdGljRmlsZXNDb25maWcgewogICAgLy8vIFZhbGlkYXRlcyB0aGUgc3RhdGljIGZpbGVzIGNvbmZpZ3VyYXRpb24uCiAgICAvLy8KICAgIC8vLyBSZXR1cm5zIGFuIGVycm9yIGlmIGFueSBibG9ja3MgcGVyIGZpbGUgdmFsdWUgaXMgemVyby4KICAgIHB1YiBmbiB2YWxpZGF0ZSgmc2VsZikgLT4gZXlyZTo6UmVzdWx0PCgpPiB7CiAgICAgICAgbGV0IEJsb2Nrc1BlckZpbGVDb25maWcgewogICAgICAgICAgICBoZWFkZXJzLAogICAgICAgICAgICB0cmFuc2FjdGlvbnMsCiAgICAgICAgICAgIHJlY2VpcHRzLAogICAgICAgICAgICB0cmFuc2FjdGlvbl9zZW5kZXJzLAogICAgICAgICAgICBhY2NvdW50X2NoYW5nZV9zZXRzLAogICAgICAgIH0gPSBzZWxmLmJsb2Nrc19wZXJfZmlsZTsKICAgICAgICBleXJlOjplbnN1cmUhKGhlYWRlcnMgIT0gU29tZSgwKSwgIkhlYWRlcnMgc2VnbWVudCBibG9ja3MgcGVyIGZpbGUgbXVzdCBiZSBncmVhdGVyIHRoYW4gMCIpOwogICAgICAgIGV5cmU6OmVuc3VyZSEoCiAgICAgICAgICAgIHRyYW5zYWN0aW9ucyAhPSBTb21lKDApLAogICAgICAgICAgICAiVHJhbnNhY3Rpb25zIHNlZ21lbnQgYmxvY2tzIHBlciBmaWxlIG11c3QgYmUgZ3JlYXRlciB0aGFuIDAiCiAgICAgICAgKTsKICAgICAgICBleXJlOjplbnN1cmUhKAogICAgICAgICAgICByZWNlaXB0cyAhPSBTb21lKDApLAogICAgICAgICAgICAiUmVjZWlwdHMgc2VnbWVudCBibG9ja3MgcGVyIGZpbGUgbXVzdCBiZSBncmVhdGVyIHRoYW4gMCIKICAgICAgICApOwogICAgICAgIGV5cmU6OmVuc3VyZSEoCiAgICAgICAgICAgIHRyYW5zYWN0aW9uX3NlbmRlcnMgIT0gU29tZSgwKSwKICAgICAgICAgICAgIlRyYW5zYWN0aW9uIHNlbmRlcnMgc2VnbWVudCBibG9ja3MgcGVyIGZpbGUgbXVzdCBiZSBncmVhdGVyIHRoYW4gMCIKICAgICAgICApOwogICAgICAgIGV5cmU6OmVuc3VyZSEoCiAgICAgICAgICAgIGFjY291bnRfY2hhbmdlX3NldHMgIT0gU29tZSgwKSwKICAgICAgICAgICAgIkFjY291bnQgY2hhbmdlc2V0cyBzZWdtZW50IGJsb2NrcyBwZXIgZmlsZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwIgogICAgICAgICk7CiAgICAgICAgT2soKCkpCiAgICB9CgogICAgLy8vIENvbnZlcnRzIHRoZSBibG9ja3MgcGVyIGZpbGUgY29uZmlndXJhdGlvbiBpbnRvIGEgW2BTdGF0aWNGaWxlTWFwYF0uCiAgICBwdWIgZm4gYXNfYmxvY2tzX3Blcl9maWxlX21hcCgmc2VsZikgLT4gU3RhdGljRmlsZU1hcDx1NjQ+IHsKICAgICAgICBsZXQgQmxvY2tzUGVyRmlsZUNvbmZpZyB7CiAgICAgICAgICAgIGhlYWRlcnMsCiAgICAgICAgICAgIHRyYW5zYWN0aW9ucywKICAgICAgICAgICAgcmVjZWlwdHMsCiAgICAgICAgICAgIHRyYW5zYWN0aW9uX3NlbmRlcnMsCiAgICAgICAgICAgIGFjY291bnRfY2hhbmdlX3NldHMsCiAgICAgICAgfSA9IHNlbGYuYmxvY2tzX3Blcl9maWxlOwoKICAgICAgICBsZXQgbXV0IG1hcCA9IFN0YXRpY0ZpbGVNYXA6OmRlZmF1bHQoKTsKICAgICAgICAvLyBJdGVyYXRpbmcgb3ZlciBhbGwgcG9zc2libGUgc2VnbWVudHMgYWxsb3dzIHVzIHRvIGRvIGFuIGV4aGF1c3RpdmUgbWF0Y2ggaGVyZSwKICAgICAgICAvLyB0byBub3QgZm9yZ2V0IHRvIGNvbmZpZ3VyZSBuZXcgc2VnbWVudHMgaW4gdGhlIGZ1dHVyZS4KICAgICAgICBmb3Igc2VnbWVudCBpbiBTdGF0aWNGaWxlU2VnbWVudDo6aXRlcigpIHsKICAgICAgICAgICAgbGV0IGJsb2Nrc19wZXJfZmlsZSA9IG1hdGNoIHNlZ21lbnQgewogICAgICAgICAgICAgICAgU3RhdGljRmlsZVNlZ21lbnQ6OkhlYWRlcnMgPT4gaGVhZGVycywKICAgICAgICAgICAgICAgIFN0YXRpY0ZpbGVTZWdtZW50OjpUcmFuc2FjdGlvbnMgPT4gdHJhbnNhY3Rpb25zLAogICAgICAgICAgICAgICAgU3RhdGljRmlsZVNlZ21lbnQ6OlJlY2VpcHRzID0+IHJlY2VpcHRzLAogICAgICAgICAgICAgICAgU3RhdGljRmlsZVNlZ21lbnQ6OlRyYW5zYWN0aW9uU2VuZGVycyA9PiB0cmFuc2FjdGlvbl9zZW5kZXJzLAogICAgICAgICAgICAgICAgU3RhdGljRmlsZVNlZ21lbnQ6OkFjY291bnRDaGFuZ2VTZXRzID0+IGFjY291bnRfY2hhbmdlX3NldHMsCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiBsZXQgU29tZShibG9ja3NfcGVyX2ZpbGUpID0gYmxvY2tzX3Blcl9maWxlIHsKICAgICAgICAgICAgICAgIG1hcC5pbnNlcnQoc2VnbWVudCwgYmxvY2tzX3Blcl9maWxlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBtYXAKICAgIH0KfQoKLy8vIEhpc3Rvcnkgc3RhZ2UgY29uZmlndXJhdGlvbi4KI1tkZXJpdmUoRGVidWcsIENsb25lLCBDb3B5LCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgZGVyaXZlKHNlcmRlOjpTZXJpYWxpemUsIHNlcmRlOjpEZXNlcmlhbGl6ZSkpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZShkZWZhdWx0KSldCnB1YiBzdHJ1Y3QgSW5kZXhIaXN0b3J5Q29uZmlnIHsKICAgIC8vLyBUaGUgbWF4aW11bSBudW1iZXIgb2YgYmxvY2tzIHRvIHByb2Nlc3MgYmVmb3JlIGNvbW1pdHRpbmcgcHJvZ3Jlc3MgdG8gdGhlIGRhdGFiYXNlLgogICAgcHViIGNvbW1pdF90aHJlc2hvbGQ6IHU2NCwKfQoKaW1wbCBEZWZhdWx0IGZvciBJbmRleEhpc3RvcnlDb25maWcgewogICAgZm4gZGVmYXVsdCgpIC0+IFNlbGYgewogICAgICAgIFNlbGYgeyBjb21taXRfdGhyZXNob2xkOiAxMDBfMDAwIH0KICAgIH0KfQoKLy8vIFBydW5pbmcgY29uZmlndXJhdGlvbi4KI1tkZXJpdmUoRGVidWcsIENsb25lLCBQYXJ0aWFsRXEsIEVxKV0KI1tjZmdfYXR0cihmZWF0dXJlID0gInNlcmRlIiwgZGVyaXZlKHNlcmRlOjpTZXJpYWxpemUsIHNlcmRlOjpEZXNlcmlhbGl6ZSkpXQojW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZShkZWZhdWx0KSldCnB1YiBzdHJ1Y3QgUHJ1bmVDb25maWcgewogICAgLy8vIE1pbmltdW0gcHJ1bmluZyBpbnRlcnZhbCBtZWFzdXJlZCBpbiBibG9ja3MuCiAgICBwdWIgYmxvY2tfaW50ZXJ2YWw6IHVzaXplLAogICAgLy8vIFBydW5pbmcgY29uZmlndXJhdGlvbiBmb3IgZXZlcnkgcGFydCBvZiB0aGUgZGF0YSB0aGF0IGNhbiBiZSBwcnVuZWQuCiAgICAjW2NmZ19hdHRyKGZlYXR1cmUgPSAic2VyZGUiLCBzZXJkZShhbGlhcyA9ICJwYXJ0cyIpKV0KICAgIHB1YiBzZWdtZW50czogUHJ1bmVNb2RlcywKfQoKaW1wbCBEZWZhdWx0IGZvciBQcnVuZUNvbmZpZyB7CiAgICBmbiBkZWZhdWx0KCkgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7IGJsb2NrX2ludGVydmFsOiBERUZBVUxUX0JMT0NLX0lOVEVSVkFMLCBzZWdtZW50czogUHJ1bmVNb2Rlczo6ZGVmYXVsdCgpIH0KICAgIH0KfQoKaW1wbCBQcnVuZUNvbmZpZyB7CiAgICAvLy8gUmV0dXJucyB3aGV0aGVyIHRoaXMgY29uZmlndXJhdGlvbiBpcyB0aGUgZGVmYXVsdCBvbmUuCiAgICBwdWIgZm4gaXNfZGVmYXVsdCgmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgc2VsZiA9PSAmU2VsZjo6ZGVmYXVsdCgpCiAgICB9CgogICAgLy8vIFJldHVybnMgd2hldGhlciB0aGVyZSBpcyBhbnkga2luZCBvZiByZWNlaXB0IHBydW5pbmcgY29uZmlndXJhdGlvbi4KICAgIHB1YiBmbiBoYXNfcmVjZWlwdHNfcHJ1bmluZygmc2VsZikgLT4gYm9vbCB7CiAgICAgICAgc2VsZi5zZWdtZW50cy5oYXNfcmVjZWlwdHNfcHJ1bmluZygpCiAgICB9CgogICAgLy8vIE1lcmdlcyB2YWx1ZXMgZnJvbSBgb3RoZXJgIGludG8gYHNlbGZgLgogICAgLy8vIC0gYE9wdGlvbjxQcnVuZU1vZGU+YCBmaWVsZHM6IHNldCBmcm9tIGBvdGhlcmAgb25seSBpZiBgc2VsZmAgaXMgYE5vbmVgLgogICAgLy8vIC0gYGJsb2NrX2ludGVydmFsYDogc2V0IGZyb20gYG90aGVyYCBvbmx5IGlmIGBzZWxmLmJsb2NrX2ludGVydmFsID09CiAgICAvLy8gICBERUZBVUxUX0JMT0NLX0lOVEVSVkFMYC4KICAgIC8vLyAtIGByZWNlaXB0c19sb2dfZmlsdGVyYDogc2V0IGZyb20gYG90aGVyYCBvbmx5IGlmIGBzZWxmYCBpcyBlbXB0eSBhbmQgYG90aGVyYCBpcyBub24tZW1wdHkuCiAgICBwdWIgZm4gbWVyZ2UoJm11dCBzZWxmLCBvdGhlcjogU2VsZikgewogICAgICAgIGxldCBTZWxmIHsKICAgICAgICAgICAgYmxvY2tfaW50ZXJ2YWwsCiAgICAgICAgICAgIHNlZ21lbnRzOgogICAgICAgICAgICAgICAgUHJ1bmVNb2RlcyB7CiAgICAgICAgICAgICAgICAgICAgc2VuZGVyX3JlY292ZXJ5LAogICAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uX2xvb2t1cCwKICAgICAgICAgICAgICAgICAgICByZWNlaXB0cywKICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2hpc3RvcnksCiAgICAgICAgICAgICAgICAgICAgc3RvcmFnZV9oaXN0b3J5LAogICAgICAgICAgICAgICAgICAgIGJvZGllc19oaXN0b3J5LAogICAgICAgICAgICAgICAgICAgIHJlY2VpcHRzX2xvZ19maWx0ZXIsCiAgICAgICAgICAgICAgICB9LAogICAgICAgIH0gPSBvdGhlcjsKCiAgICAgICAgLy8gTWVyZ2UgYmxvY2tfaW50ZXJ2YWwsIG9ubHkgdXBkYXRlIGlmIGl0J3MgdGhlIGRlZmF1bHQgaW50ZXJ2YWwKICAgICAgICBpZiBzZWxmLmJsb2NrX2ludGVydmFsID09IERFRkFVTFRfQkxPQ0tfSU5URVJWQUwgewogICAgICAgICAgICBzZWxmLmJsb2NrX2ludGVydmFsID0gYmxvY2tfaW50ZXJ2YWw7CiAgICAgICAgfQoKICAgICAgICAvLyBNZXJnZSB0aGUgdmFyaW91cyBzZWdtZW50IHBydW5lIG1vZGVzCiAgICAgICAgc2VsZi5zZWdtZW50cy5zZW5kZXJfcmVjb3ZlcnkgPSBzZWxmLnNlZ21lbnRzLnNlbmRlcl9yZWNvdmVyeS5vcihzZW5kZXJfcmVjb3ZlcnkpOwogICAgICAgIHNlbGYuc2VnbWVudHMudHJhbnNhY3Rpb25fbG9va3VwID0gc2VsZi5zZWdtZW50cy50cmFuc2FjdGlvbl9sb29rdXAub3IodHJhbnNhY3Rpb25fbG9va3VwKTsKICAgICAgICBzZWxmLnNlZ21lbnRzLnJlY2VpcHRzID0gc2VsZi5zZWdtZW50cy5yZWNlaXB0cy5vcihyZWNlaXB0cyk7CiAgICAgICAgc2VsZi5zZWdtZW50cy5hY2NvdW50X2hpc3RvcnkgPSBzZWxmLnNlZ21lbnRzLmFjY291bnRfaGlzdG9yeS5vcihhY2NvdW50X2hpc3RvcnkpOwogICAgICAgIHNlbGYuc2VnbWVudHMuc3RvcmFnZV9oaXN0b3J5ID0gc2VsZi5zZWdtZW50cy5zdG9yYWdlX2hpc3Rvcnkub3Ioc3RvcmFnZV9oaXN0b3J5KTsKICAgICAgICBzZWxmLnNlZ21lbnRzLmJvZGllc19oaXN0b3J5ID0gc2VsZi5zZWdtZW50cy5ib2RpZXNfaGlzdG9yeS5vcihib2RpZXNfaGlzdG9yeSk7CgogICAgICAgIGlmIHNlbGYuc2VnbWVudHMucmVjZWlwdHNfbG9nX2ZpbHRlci4wLmlzX2VtcHR5KCkgJiYgIXJlY2VpcHRzX2xvZ19maWx0ZXIuMC5pc19lbXB0eSgpIHsKICAgICAgICAgICAgc2VsZi5zZWdtZW50cy5yZWNlaXB0c19sb2dfZmlsdGVyID0gcmVjZWlwdHNfbG9nX2ZpbHRlcjsKICAgICAgICB9CiAgICB9Cn0KCi8vLyBIZWxwZXIgdHlwZSB0byBzdXBwb3J0IG9sZGVyIHZlcnNpb25zIG9mIER1cmF0aW9uIGRlc2VyaWFsaXphdGlvbi4KI1tjZmcoZmVhdHVyZSA9ICJzZXJkZSIpXQpmbiBkZXNlcmlhbGl6ZV9kdXJhdGlvbjwnZGUsIEQ+KGRlc2VyaWFsaXplcjogRCkgLT4gUmVzdWx0PE9wdGlvbjxEdXJhdGlvbj4sIEQ6OkVycm9yPgp3aGVyZQogICAgRDogc2VyZGU6OmRlOjpEZXNlcmlhbGl6ZXI8J2RlPiwKewogICAgI1tkZXJpdmUoc2VyZGU6OkRlc2VyaWFsaXplKV0KICAgICNbc2VyZGUodW50YWdnZWQpXQogICAgZW51bSBBbnlEdXJhdGlvbiB7CiAgICAgICAgI1tzZXJkZShkZXNlcmlhbGl6ZV93aXRoID0gImh1bWFudGltZV9zZXJkZTo6ZGVzZXJpYWxpemUiKV0KICAgICAgICBIdW1hbihPcHRpb248RHVyYXRpb24+KSwKICAgICAgICBEdXJhdGlvbihPcHRpb248RHVyYXRpb24+KSwKICAgIH0KCiAgICA8QW55RHVyYXRpb24gYXMgc2VyZGU6OkRlc2VyaWFsaXplPjo6ZGVzZXJpYWxpemUoZGVzZXJpYWxpemVyKS5tYXAofGR8IG1hdGNoIGQgewogICAgICAgIEFueUR1cmF0aW9uOjpIdW1hbihkdXJhdGlvbikgfCBBbnlEdXJhdGlvbjo6RHVyYXRpb24oZHVyYXRpb24pID0+IGR1cmF0aW9uLAogICAgfSkKfQoKI1tjZmcoYWxsKHRlc3QsIGZlYXR1cmUgPSAic2VyZGUiKSldCm1vZCB0ZXN0cyB7CiAgICB1c2Ugc3VwZXI6OntDb25maWcsIEVYVEVOU0lPTn07CiAgICB1c2UgY3JhdGU6OlBydW5lQ29uZmlnOwogICAgdXNlIGFsbG95X3ByaW1pdGl2ZXM6OkFkZHJlc3M7CiAgICB1c2UgcmV0aF9uZXR3b3JrX3BlZXJzOjpUcnVzdGVkUGVlcjsKICAgIHVzZSByZXRoX3BydW5lX3R5cGVzOjp7UHJ1bmVNb2RlLCBQcnVuZU1vZGVzLCBSZWNlaXB0c0xvZ1BydW5lQ29uZmlnfTsKICAgIHVzZSBzdGQ6Ontjb2xsZWN0aW9uczo6QlRyZWVNYXAsIHBhdGg6OlBhdGgsIHN0cjo6RnJvbVN0ciwgdGltZTo6RHVyYXRpb259OwoKICAgIGZuIHdpdGhfdGVtcGRpcihmaWxlbmFtZTogJnN0ciwgcHJvYzogZm4oJnN0ZDo6cGF0aDo6UGF0aCkpIHsKICAgICAgICBsZXQgdGVtcF9kaXIgPSB0ZW1wZmlsZTo6dGVtcGRpcigpLnVud3JhcCgpOwogICAgICAgIGxldCBjb25maWdfcGF0aCA9IHRlbXBfZGlyLnBhdGgoKS5qb2luKGZpbGVuYW1lKS53aXRoX2V4dGVuc2lvbihFWFRFTlNJT04pOwoKICAgICAgICBwcm9jKCZjb25maWdfcGF0aCk7CgogICAgICAgIHRlbXBfZGlyLmNsb3NlKCkudW53cmFwKCkKICAgIH0KCiAgICAvLy8gUnVuIGEgdGVzdCBmdW5jdGlvbiB3aXRoIGEgdGVtcG9yYXJ5IGNvbmZpZyBwYXRoIGFzIGZpeHR1cmUuCiAgICBmbiB3aXRoX2NvbmZpZ19wYXRoKHRlc3RfZm46IGZuKCZQYXRoKSkgewogICAgICAgIC8vIENyZWF0ZSBhIHRlbXBvcmFyeSBkaXJlY3RvcnkgZm9yIHRoZSBjb25maWcgZmlsZQogICAgICAgIGxldCBjb25maWdfZGlyID0gdGVtcGZpbGU6OnRlbXBkaXIoKS5leHBlY3QoImNyZWF0aW5nIHRlc3QgZml4dHVyZSBmYWlsZWQiKTsKICAgICAgICAvLyBDcmVhdGUgdGhlIGNvbmZpZyBmaWxlIHBhdGgKICAgICAgICBsZXQgY29uZmlnX3BhdGggPQogICAgICAgICAgICBjb25maWdfZGlyLnBhdGgoKS5qb2luKCJleGFtcGxlLWFwcCIpLmpvaW4oImV4YW1wbGUtY29uZmlnIikud2l0aF9leHRlbnNpb24oInRvbWwiKTsKICAgICAgICAvLyBSdW4gdGhlIHRlc3QgZnVuY3Rpb24gd2l0aCB0aGUgY29uZmlnIHBhdGgKICAgICAgICB0ZXN0X2ZuKCZjb25maWdfcGF0aCk7CiAgICAgICAgY29uZmlnX2Rpci5jbG9zZSgpLmV4cGVjdCgicmVtb3ZpbmcgdGVzdCBmaXh0dXJlIGZhaWxlZCIpOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfbG9hZF9wYXRoX3dvcmtzKCkgewogICAgICAgIHdpdGhfY29uZmlnX3BhdGgofHBhdGh8IHsKICAgICAgICAgICAgbGV0IGNvbmZpZyA9IENvbmZpZzo6ZnJvbV9wYXRoKHBhdGgpLmV4cGVjdCgibG9hZF9wYXRoIGZhaWxlZCIpOwogICAgICAgICAgICBhc3NlcnRfZXEhKGNvbmZpZywgQ29uZmlnOjpkZWZhdWx0KCkpOwogICAgICAgIH0pCiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9sb2FkX3BhdGhfcmVhZHNfZXhpc3RpbmdfY29uZmlnKCkgewogICAgICAgIHdpdGhfY29uZmlnX3BhdGgofHBhdGh8IHsKICAgICAgICAgICAgbGV0IGNvbmZpZyA9IENvbmZpZzo6ZGVmYXVsdCgpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBwYXJlbnQgZGlyZWN0b3J5IGlmIGl0IGRvZXNuJ3QgZXhpc3QKICAgICAgICAgICAgaWYgbGV0IFNvbWUocGFyZW50KSA9IHBhdGgucGFyZW50KCkgewogICAgICAgICAgICAgICAgc3RkOjpmczo6Y3JlYXRlX2Rpcl9hbGwocGFyZW50KS5leHBlY3QoIkZhaWxlZCB0byBjcmVhdGUgZGlyZWN0b3JpZXMiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gV3JpdGUgdGhlIGNvbmZpZyB0byB0aGUgZmlsZQogICAgICAgICAgICBzdGQ6OmZzOjp3cml0ZShwYXRoLCB0b21sOjp0b19zdHJpbmcoJmNvbmZpZykudW53cmFwKCkpCiAgICAgICAgICAgICAgICAuZXhwZWN0KCJGYWlsZWQgdG8gd3JpdGUgY29uZmlnIik7CgogICAgICAgICAgICAvLyBMb2FkIHRoZSBjb25maWcgZnJvbSB0aGUgZmlsZSBhbmQgY29tcGFyZSBpdAogICAgICAgICAgICBsZXQgbG9hZGVkID0gQ29uZmlnOjpmcm9tX3BhdGgocGF0aCkuZXhwZWN0KCJsb2FkX3BhdGggZmFpbGVkIik7CiAgICAgICAgICAgIGFzc2VydF9lcSEoY29uZmlnLCBsb2FkZWQpOwogICAgICAgIH0pCiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9sb2FkX3BhdGhfZmFpbHNfb25faW52YWxpZF90b21sKCkgewogICAgICAgIHdpdGhfY29uZmlnX3BhdGgofHBhdGh8IHsKICAgICAgICAgICAgbGV0IGludmFsaWRfdG9tbCA9ICJpbnZhbGlkIHRvbWwgZGF0YSI7CgogICAgICAgICAgICAvLyBDcmVhdGUgdGhlIHBhcmVudCBkaXJlY3RvcnkgaWYgaXQgZG9lc24ndCBleGlzdAogICAgICAgICAgICBpZiBsZXQgU29tZShwYXJlbnQpID0gcGF0aC5wYXJlbnQoKSB7CiAgICAgICAgICAgICAgICBzdGQ6OmZzOjpjcmVhdGVfZGlyX2FsbChwYXJlbnQpLmV4cGVjdCgiRmFpbGVkIHRvIGNyZWF0ZSBkaXJlY3RvcmllcyIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBXcml0ZSBpbnZhbGlkIFRPTUwgZGF0YSB0byB0aGUgZmlsZQogICAgICAgICAgICBzdGQ6OmZzOjp3cml0ZShwYXRoLCBpbnZhbGlkX3RvbWwpLmV4cGVjdCgiRmFpbGVkIHRvIHdyaXRlIGludmFsaWQgVE9NTCIpOwoKICAgICAgICAgICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjb25maWcgc2hvdWxkIGZhaWwKICAgICAgICAgICAgbGV0IHJlc3VsdCA9IENvbmZpZzo6ZnJvbV9wYXRoKHBhdGgpOwogICAgICAgICAgICBhc3NlcnQhKHJlc3VsdC5pc19lcnIoKSk7CiAgICAgICAgfSkKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2xvYWRfcGF0aF9jcmVhdGVzX2RpcmVjdG9yeV9pZl9ub3RfZXhpc3RzKCkgewogICAgICAgIHdpdGhfY29uZmlnX3BhdGgofHBhdGh8IHsKICAgICAgICAgICAgLy8gRW5zdXJlIHRoZSBkaXJlY3RvcnkgZG9lcyBub3QgZXhpc3QKICAgICAgICAgICAgbGV0IHBhcmVudCA9IHBhdGgucGFyZW50KCkudW53cmFwKCk7CiAgICAgICAgICAgIGFzc2VydCEoIXBhcmVudC5leGlzdHMoKSk7CgogICAgICAgICAgICAvLyBMb2FkIHRoZSBjb25maWd1cmF0aW9uLCB3aGljaCBzaG91bGQgY3JlYXRlIHRoZSBkaXJlY3RvcnkgYW5kIGEgZGVmYXVsdCBjb25maWcgZmlsZQogICAgICAgICAgICBsZXQgY29uZmlnID0gQ29uZmlnOjpmcm9tX3BhdGgocGF0aCkuZXhwZWN0KCJsb2FkX3BhdGggZmFpbGVkIik7CiAgICAgICAgICAgIGFzc2VydF9lcSEoY29uZmlnLCBDb25maWc6OmRlZmF1bHQoKSk7CgogICAgICAgICAgICAvLyBUaGUgZGlyZWN0b3J5IGFuZCBmaWxlIHNob3VsZCBub3cgZXhpc3QKICAgICAgICAgICAgYXNzZXJ0IShwYXJlbnQuZXhpc3RzKCkpOwogICAgICAgICAgICBhc3NlcnQhKHBhdGguZXhpc3RzKCkpOwogICAgICAgIH0pOwogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3Rfc3RvcmVfY29uZmlnKCkgewogICAgICAgIHdpdGhfdGVtcGRpcigiY29uZmlnLXN0b3JlLXRlc3QiLCB8Y29uZmlnX3BhdGh8IHsKICAgICAgICAgICAgbGV0IGNvbmZpZyA9IENvbmZpZzo6ZGVmYXVsdCgpOwogICAgICAgICAgICBzdGQ6OmZzOjp3cml0ZSgKICAgICAgICAgICAgICAgIGNvbmZpZ19wYXRoLAogICAgICAgICAgICAgICAgdG9tbDo6dG9fc3RyaW5nKCZjb25maWcpLmV4cGVjdCgiRmFpbGVkIHRvIHNlcmlhbGl6ZSBjb25maWciKSwKICAgICAgICAgICAgKQogICAgICAgICAgICAuZXhwZWN0KCJGYWlsZWQgdG8gd3JpdGUgY29uZmlnIGZpbGUiKTsKICAgICAgICB9KQogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3Rfc3RvcmVfY29uZmlnX21ldGhvZCgpIHsKICAgICAgICB3aXRoX3RlbXBkaXIoImNvbmZpZy1zdG9yZS10ZXN0LW1ldGhvZCIsIHxjb25maWdfcGF0aHwgewogICAgICAgICAgICBsZXQgY29uZmlnID0gQ29uZmlnOjpkZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbmZpZy5zYXZlKGNvbmZpZ19wYXRoKS5leHBlY3QoIkZhaWxlZCB0byBzdG9yZSBjb25maWciKTsKICAgICAgICB9KQogICAgfQoKICAgICNbdGVzdF0KICAgIGZuIHRlc3RfbG9hZF9jb25maWcoKSB7CiAgICAgICAgd2l0aF90ZW1wZGlyKCJjb25maWctbG9hZC10ZXN0IiwgfGNvbmZpZ19wYXRofCB7CiAgICAgICAgICAgIGxldCBjb25maWcgPSBDb25maWc6OmRlZmF1bHQoKTsKCiAgICAgICAgICAgIC8vIFdyaXRlIHRoZSBjb25maWcgdG8gYSBmaWxlCiAgICAgICAgICAgIHN0ZDo6ZnM6OndyaXRlKAogICAgICAgICAgICAgICAgY29uZmlnX3BhdGgsCiAgICAgICAgICAgICAgICB0b21sOjp0b19zdHJpbmcoJmNvbmZpZykuZXhwZWN0KCJGYWlsZWQgdG8gc2VyaWFsaXplIGNvbmZpZyIpLAogICAgICAgICAgICApCiAgICAgICAgICAgIC5leHBlY3QoIkZhaWxlZCB0byB3cml0ZSBjb25maWcgZmlsZSIpOwoKICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29uZmlnIGZyb20gdGhlIGZpbGUKICAgICAgICAgICAgbGV0IGxvYWRlZF9jb25maWcgPSBDb25maWc6OmZyb21fcGF0aChjb25maWdfcGF0aCkudW53cmFwKCk7CgogICAgICAgICAgICAvLyBDb21wYXJlIHRoZSBsb2FkZWQgY29uZmlnIHdpdGggdGhlIG9yaWdpbmFsIGNvbmZpZwogICAgICAgICAgICBhc3NlcnRfZXEhKGNvbmZpZywgbG9hZGVkX2NvbmZpZyk7CiAgICAgICAgfSkKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2xvYWRfZXhlY3V0aW9uX3N0YWdlKCkgewogICAgICAgIHdpdGhfdGVtcGRpcigiY29uZmlnLWxvYWQtdGVzdCIsIHxjb25maWdfcGF0aHwgewogICAgICAgICAgICBsZXQgbXV0IGNvbmZpZyA9IENvbmZpZzo6ZGVmYXVsdCgpOwogICAgICAgICAgICBjb25maWcuc3RhZ2VzLmV4ZWN1dGlvbi5tYXhfZHVyYXRpb24gPSBTb21lKER1cmF0aW9uOjpmcm9tX3NlY3MoMTAgKiA2MCkpOwoKICAgICAgICAgICAgLy8gV3JpdGUgdGhlIGNvbmZpZyB0byBhIGZpbGUKICAgICAgICAgICAgc3RkOjpmczo6d3JpdGUoCiAgICAgICAgICAgICAgICBjb25maWdfcGF0aCwKICAgICAgICAgICAgICAgIHRvbWw6OnRvX3N0cmluZygmY29uZmlnKS5leHBlY3QoIkZhaWxlZCB0byBzZXJpYWxpemUgY29uZmlnIiksCiAgICAgICAgICAgICkKICAgICAgICAgICAgLmV4cGVjdCgiRmFpbGVkIHRvIHdyaXRlIGNvbmZpZyBmaWxlIik7CgogICAgICAgICAgICAvLyBMb2FkIHRoZSBjb25maWcgZnJvbSB0aGUgZmlsZQogICAgICAgICAgICBsZXQgbG9hZGVkX2NvbmZpZyA9IENvbmZpZzo6ZnJvbV9wYXRoKGNvbmZpZ19wYXRoKS51bndyYXAoKTsKCiAgICAgICAgICAgIC8vIENvbXBhcmUgdGhlIGxvYWRlZCBjb25maWcgd2l0aCB0aGUgb3JpZ2luYWwgY29uZmlnCiAgICAgICAgICAgIGFzc2VydF9lcSEoY29uZmlnLCBsb2FkZWRfY29uZmlnKTsKICAgICAgICB9KQogICAgfQoKICAgIC8vIGVuc3VyZXMgY29uZmlnIGRlc2VyaWFsaXphdGlvbiBpcyBiYWNrd2FyZHMgY29tcGF0aWJsZQogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9iYWNrd2FyZHNfY29tcGF0aWJpbGl0eSgpIHsKICAgICAgICBsZXQgYWxwaGFfMF8wXzggPSByIiMKW3N0YWdlcy5oZWFkZXJzXQpkb3dubG9hZGVyX21heF9jb25jdXJyZW50X3JlcXVlc3RzID0gMTAwCmRvd25sb2FkZXJfbWluX2NvbmN1cnJlbnRfcmVxdWVzdHMgPSA1CmRvd25sb2FkZXJfbWF4X2J1ZmZlcmVkX3Jlc3BvbnNlcyA9IDEwMApkb3dubG9hZGVyX3JlcXVlc3RfbGltaXQgPSAxMDAwCmNvbW1pdF90aHJlc2hvbGQgPSAxMDAwMAoKW3N0YWdlcy5ib2RpZXNdCmRvd25sb2FkZXJfcmVxdWVzdF9saW1pdCA9IDIwMApkb3dubG9hZGVyX3N0cmVhbV9iYXRjaF9zaXplID0gMTAwMApkb3dubG9hZGVyX21heF9idWZmZXJlZF9ibG9ja3Nfc2l6ZV9ieXRlcyA9IDIxNDc0ODM2NDgKZG93bmxvYWRlcl9taW5fY29uY3VycmVudF9yZXF1ZXN0cyA9IDUKZG93bmxvYWRlcl9tYXhfY29uY3VycmVudF9yZXF1ZXN0cyA9IDEwMAoKW3N0YWdlcy5zZW5kZXJfcmVjb3ZlcnldCmNvbW1pdF90aHJlc2hvbGQgPSA1MDAwMDAwCgpbc3RhZ2VzLmV4ZWN1dGlvbl0KbWF4X2Jsb2NrcyA9IDUwMDAwMAptYXhfY2hhbmdlcyA9IDUwMDAwMDAKCltzdGFnZXMuYWNjb3VudF9oYXNoaW5nXQpjbGVhbl90aHJlc2hvbGQgPSA1MDAwMDAKY29tbWl0X3RocmVzaG9sZCA9IDEwMDAwMAoKW3N0YWdlcy5zdG9yYWdlX2hhc2hpbmddCmNsZWFuX3RocmVzaG9sZCA9IDUwMDAwMApjb21taXRfdGhyZXNob2xkID0gMTAwMDAwCgpbc3RhZ2VzLm1lcmtsZV0KY2xlYW5fdGhyZXNob2xkID0gNTAwMDAKCltzdGFnZXMudHJhbnNhY3Rpb25fbG9va3VwXQpjaHVua19zaXplID0gNTAwMDAwMAoKW3N0YWdlcy5pbmRleF9hY2NvdW50X2hpc3RvcnldCmNvbW1pdF90aHJlc2hvbGQgPSAxMDAwMDAKCltzdGFnZXMuaW5kZXhfc3RvcmFnZV9oaXN0b3J5XQpjb21taXRfdGhyZXNob2xkID0gMTAwMDAwCgpbcGVlcnNdCnJlZmlsbF9zbG90c19pbnRlcnZhbCA9ICcxcycKdHJ1c3RlZF9ub2RlcyA9IFtdCmNvbm5lY3RfdHJ1c3RlZF9ub2Rlc19vbmx5ID0gZmFsc2UKbWF4X2JhY2tvZmZfY291bnQgPSA1CmJhbl9kdXJhdGlvbiA9ICcxMmgnCgpbcGVlcnMuY29ubmVjdGlvbl9pbmZvXQptYXhfb3V0Ym91bmQgPSAxMDAKbWF4X2luYm91bmQgPSAzMAoKW3BlZXJzLnJlcHV0YXRpb25fd2VpZ2h0c10KYmFkX21lc3NhZ2UgPSAtMTYzODQKYmFkX2Jsb2NrID0gLTE2Mzg0CmJhZF90cmFuc2FjdGlvbnMgPSAtMTYzODQKYWxyZWFkeV9zZWVuX3RyYW5zYWN0aW9ucyA9IDAKdGltZW91dCA9IC00MDk2CmJhZF9wcm90b2NvbCA9IC0yMTQ3NDgzNjQ4CmZhaWxlZF90b19jb25uZWN0ID0gLTI1NjAwCmRyb3BwZWQgPSAtNDA5NgoKW3BlZXJzLmJhY2tvZmZfZHVyYXRpb25zXQpsb3cgPSAnMzBzJwptZWRpdW0gPSAnM20nCmhpZ2ggPSAnMTVtJwptYXggPSAnMWgnCgpbc2Vzc2lvbnNdCnNlc3Npb25fY29tbWFuZF9idWZmZXIgPSAzMgpzZXNzaW9uX2V2ZW50X2J1ZmZlciA9IDI2MAoKW3Nlc3Npb25zLmxpbWl0c10KCltzZXNzaW9ucy5pbml0aWFsX2ludGVybmFsX3JlcXVlc3RfdGltZW91dF0Kc2VjcyA9IDIwCm5hbm9zID0gMAoKW3Nlc3Npb25zLnByb3RvY29sX2JyZWFjaF9yZXF1ZXN0X3RpbWVvdXRdCnNlY3MgPSAxMjAKbmFub3MgPSAwCgpbcHJ1bmVdCmJsb2NrX2ludGVydmFsID0gNQoKW3BydW5lLnBhcnRzXQpzZW5kZXJfcmVjb3ZlcnkgPSB7IGRpc3RhbmNlID0gMTYzODQgfQp0cmFuc2FjdGlvbl9sb29rdXAgPSAnZnVsbCcKcmVjZWlwdHMgPSB7IGJlZm9yZSA9IDE5MjAwMDAgfQphY2NvdW50X2hpc3RvcnkgPSB7IGRpc3RhbmNlID0gMTYzODQgfQpzdG9yYWdlX2hpc3RvcnkgPSB7IGRpc3RhbmNlID0gMTYzODQgfQpbcHJ1bmUucGFydHMucmVjZWlwdHNfbG9nX2ZpbHRlcl0KJzB4YTBiODY5OTFjNjIxOGIzNmMxZDE5ZDRhMmU5ZWIwY2UzNjA2ZWI0OCcgPSB7IGJlZm9yZSA9IDE3MDAwMDAwIH0KJzB4ZGFjMTdmOTU4ZDJlZTUyM2EyMjA2MjA2OTk0NTk3YzEzZDgzMWVjNycgPSB7IGRpc3RhbmNlID0gMTAwMCB9CiMiOwogICAgICAgIGxldCBfY29uZjogQ29uZmlnID0gdG9tbDo6ZnJvbV9zdHIoYWxwaGFfMF8wXzgpLnVud3JhcCgpOwoKICAgICAgICBsZXQgYWxwaGFfMF8wXzExID0gciIjCltwcnVuZS5zZWdtZW50c10Kc2VuZGVyX3JlY292ZXJ5ID0geyBkaXN0YW5jZSA9IDE2Mzg0IH0KdHJhbnNhY3Rpb25fbG9va3VwID0gJ2Z1bGwnCnJlY2VpcHRzID0geyBiZWZvcmUgPSAxOTIwMDAwIH0KYWNjb3VudF9oaXN0b3J5ID0geyBkaXN0YW5jZSA9IDE2Mzg0IH0Kc3RvcmFnZV9oaXN0b3J5ID0geyBkaXN0YW5jZSA9IDE2Mzg0IH0KW3BydW5lLnNlZ21lbnRzLnJlY2VpcHRzX2xvZ19maWx0ZXJdCicweGEwYjg2OTkxYzYyMThiMzZjMWQxOWQ0YTJlOWViMGNlMzYwNmViNDgnID0geyBiZWZvcmUgPSAxNzAwMDAwMCB9CicweGRhYzE3Zjk1OGQyZWU1MjNhMjIwNjIwNjk5NDU5N2MxM2Q4MzFlYzcnID0geyBkaXN0YW5jZSA9IDEwMDAgfQojIjsKICAgICAgICBsZXQgX2NvbmY6IENvbmZpZyA9IHRvbWw6OmZyb21fc3RyKGFscGhhXzBfMF8xMSkudW53cmFwKCk7CgogICAgICAgIGxldCBhbHBoYV8wXzBfMTggPSByIiMKW3N0YWdlcy5oZWFkZXJzXQpkb3dubG9hZGVyX21heF9jb25jdXJyZW50X3JlcXVlc3RzID0gMTAwCmRvd25sb2FkZXJfbWluX2NvbmN1cnJlbnRfcmVxdWVzdHMgPSA1CmRvd25sb2FkZXJfbWF4X2J1ZmZlcmVkX3Jlc3BvbnNlcyA9IDEwMApkb3dubG9hZGVyX3JlcXVlc3RfbGltaXQgPSAxMDAwCmNvbW1pdF90aHJlc2hvbGQgPSAxMDAwMAoKW3N0YWdlcy50b3RhbF9kaWZmaWN1bHR5XQpjb21taXRfdGhyZXNob2xkID0gMTAwMDAwCgpbc3RhZ2VzLmJvZGllc10KZG93bmxvYWRlcl9yZXF1ZXN0X2xpbWl0ID0gMjAwCmRvd25sb2FkZXJfc3RyZWFtX2JhdGNoX3NpemUgPSAxMDAwCmRvd25sb2FkZXJfbWF4X2J1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzID0gMjE0NzQ4MzY0OApkb3dubG9hZGVyX21pbl9jb25jdXJyZW50X3JlcXVlc3RzID0gNQpkb3dubG9hZGVyX21heF9jb25jdXJyZW50X3JlcXVlc3RzID0gMTAwCgpbc3RhZ2VzLnNlbmRlcl9yZWNvdmVyeV0KY29tbWl0X3RocmVzaG9sZCA9IDUwMDAwMDAKCltzdGFnZXMuZXhlY3V0aW9uXQptYXhfYmxvY2tzID0gNTAwMDAwCm1heF9jaGFuZ2VzID0gNTAwMDAwMAptYXhfY3VtdWxhdGl2ZV9nYXMgPSAxNTAwMDAwMDAwMDAwCltzdGFnZXMuZXhlY3V0aW9uLm1heF9kdXJhdGlvbl0Kc2VjcyA9IDYwMApuYW5vcyA9IDAKCltzdGFnZXMuYWNjb3VudF9oYXNoaW5nXQpjbGVhbl90aHJlc2hvbGQgPSA1MDAwMDAKY29tbWl0X3RocmVzaG9sZCA9IDEwMDAwMAoKW3N0YWdlcy5zdG9yYWdlX2hhc2hpbmddCmNsZWFuX3RocmVzaG9sZCA9IDUwMDAwMApjb21taXRfdGhyZXNob2xkID0gMTAwMDAwCgpbc3RhZ2VzLm1lcmtsZV0KY2xlYW5fdGhyZXNob2xkID0gNTAwMDAKCltzdGFnZXMudHJhbnNhY3Rpb25fbG9va3VwXQpjb21taXRfdGhyZXNob2xkID0gNTAwMDAwMAoKW3N0YWdlcy5pbmRleF9hY2NvdW50X2hpc3RvcnldCmNvbW1pdF90aHJlc2hvbGQgPSAxMDAwMDAKCltzdGFnZXMuaW5kZXhfc3RvcmFnZV9oaXN0b3J5XQpjb21taXRfdGhyZXNob2xkID0gMTAwMDAwCgpbcGVlcnNdCnJlZmlsbF9zbG90c19pbnRlcnZhbCA9ICc1cycKdHJ1c3RlZF9ub2RlcyA9IFtdCmNvbm5lY3RfdHJ1c3RlZF9ub2Rlc19vbmx5ID0gZmFsc2UKbWF4X2JhY2tvZmZfY291bnQgPSA1CmJhbl9kdXJhdGlvbiA9ICcxMmgnCgpbcGVlcnMuY29ubmVjdGlvbl9pbmZvXQptYXhfb3V0Ym91bmQgPSAxMDAKbWF4X2luYm91bmQgPSAzMAptYXhfY29uY3VycmVudF9vdXRib3VuZF9kaWFscyA9IDEwCgpbcGVlcnMucmVwdXRhdGlvbl93ZWlnaHRzXQpiYWRfbWVzc2FnZSA9IC0xNjM4NApiYWRfYmxvY2sgPSAtMTYzODQKYmFkX3RyYW5zYWN0aW9ucyA9IC0xNjM4NAphbHJlYWR5X3NlZW5fdHJhbnNhY3Rpb25zID0gMAp0aW1lb3V0ID0gLTQwOTYKYmFkX3Byb3RvY29sID0gLTIxNDc0ODM2NDgKZmFpbGVkX3RvX2Nvbm5lY3QgPSAtMjU2MDAKZHJvcHBlZCA9IC00MDk2CmJhZF9hbm5vdW5jZW1lbnQgPSAtMTAyNAoKW3BlZXJzLmJhY2tvZmZfZHVyYXRpb25zXQpsb3cgPSAnMzBzJwptZWRpdW0gPSAnM20nCmhpZ2ggPSAnMTVtJwptYXggPSAnMWgnCgpbc2Vzc2lvbnNdCnNlc3Npb25fY29tbWFuZF9idWZmZXIgPSAzMgpzZXNzaW9uX2V2ZW50X2J1ZmZlciA9IDI2MAoKW3Nlc3Npb25zLmxpbWl0c10KCltzZXNzaW9ucy5pbml0aWFsX2ludGVybmFsX3JlcXVlc3RfdGltZW91dF0Kc2VjcyA9IDIwCm5hbm9zID0gMAoKW3Nlc3Npb25zLnByb3RvY29sX2JyZWFjaF9yZXF1ZXN0X3RpbWVvdXRdCnNlY3MgPSAxMjAKbmFub3MgPSAwCiMiOwogICAgICAgIGxldCBjb25mOiBDb25maWcgPSB0b21sOjpmcm9tX3N0cihhbHBoYV8wXzBfMTgpLnVud3JhcCgpOwogICAgICAgIGFzc2VydF9lcSEoY29uZi5zdGFnZXMuZXhlY3V0aW9uLm1heF9kdXJhdGlvbiwgU29tZShEdXJhdGlvbjo6ZnJvbV9zZWNzKDEwICogNjApKSk7CgogICAgICAgIGxldCBhbHBoYV8wXzBfMTkgPSByIiMKW3N0YWdlcy5oZWFkZXJzXQpkb3dubG9hZGVyX21heF9jb25jdXJyZW50X3JlcXVlc3RzID0gMTAwCmRvd25sb2FkZXJfbWluX2NvbmN1cnJlbnRfcmVxdWVzdHMgPSA1CmRvd25sb2FkZXJfbWF4X2J1ZmZlcmVkX3Jlc3BvbnNlcyA9IDEwMApkb3dubG9hZGVyX3JlcXVlc3RfbGltaXQgPSAxMDAwCmNvbW1pdF90aHJlc2hvbGQgPSAxMDAwMAoKW3N0YWdlcy50b3RhbF9kaWZmaWN1bHR5XQpjb21taXRfdGhyZXNob2xkID0gMTAwMDAwCgpbc3RhZ2VzLmJvZGllc10KZG93bmxvYWRlcl9yZXF1ZXN0X2xpbWl0ID0gMjAwCmRvd25sb2FkZXJfc3RyZWFtX2JhdGNoX3NpemUgPSAxMDAwCmRvd25sb2FkZXJfbWF4X2J1ZmZlcmVkX2Jsb2Nrc19zaXplX2J5dGVzID0gMjE0NzQ4MzY0OApkb3dubG9hZGVyX21pbl9jb25jdXJyZW50X3JlcXVlc3RzID0gNQpkb3dubG9hZGVyX21heF9jb25jdXJyZW50X3JlcXVlc3RzID0gMTAwCgpbc3RhZ2VzLnNlbmRlcl9yZWNvdmVyeV0KY29tbWl0X3RocmVzaG9sZCA9IDUwMDAwMDAKCltzdGFnZXMuZXhlY3V0aW9uXQptYXhfYmxvY2tzID0gNTAwMDAwCm1heF9jaGFuZ2VzID0gNTAwMDAwMAptYXhfY3VtdWxhdGl2ZV9nYXMgPSAxNTAwMDAwMDAwMDAwCm1heF9kdXJhdGlvbiA9ICcxMG0nCgpbc3RhZ2VzLmFjY291bnRfaGFzaGluZ10KY2xlYW5fdGhyZXNob2xkID0gNTAwMDAwCmNvbW1pdF90aHJlc2hvbGQgPSAxMDAwMDAKCltzdGFnZXMuc3RvcmFnZV9oYXNoaW5nXQpjbGVhbl90aHJlc2hvbGQgPSA1MDAwMDAKY29tbWl0X3RocmVzaG9sZCA9IDEwMDAwMAoKW3N0YWdlcy5tZXJrbGVdCmNsZWFuX3RocmVzaG9sZCA9IDUwMDAwCgpbc3RhZ2VzLnRyYW5zYWN0aW9uX2xvb2t1cF0KY29tbWl0X3RocmVzaG9sZCA9IDUwMDAwMDAKCltzdGFnZXMuaW5kZXhfYWNjb3VudF9oaXN0b3J5XQpjb21taXRfdGhyZXNob2xkID0gMTAwMDAwCgpbc3RhZ2VzLmluZGV4X3N0b3JhZ2VfaGlzdG9yeV0KY29tbWl0X3RocmVzaG9sZCA9IDEwMDAwMAoKW3BlZXJzXQpyZWZpbGxfc2xvdHNfaW50ZXJ2YWwgPSAnNXMnCnRydXN0ZWRfbm9kZXMgPSBbXQpjb25uZWN0X3RydXN0ZWRfbm9kZXNfb25seSA9IGZhbHNlCm1heF9iYWNrb2ZmX2NvdW50ID0gNQpiYW5fZHVyYXRpb24gPSAnMTJoJwoKW3BlZXJzLmNvbm5lY3Rpb25faW5mb10KbWF4X291dGJvdW5kID0gMTAwCm1heF9pbmJvdW5kID0gMzAKbWF4X2NvbmN1cnJlbnRfb3V0Ym91bmRfZGlhbHMgPSAxMAoKW3BlZXJzLnJlcHV0YXRpb25fd2VpZ2h0c10KYmFkX21lc3NhZ2UgPSAtMTYzODQKYmFkX2Jsb2NrID0gLTE2Mzg0CmJhZF90cmFuc2FjdGlvbnMgPSAtMTYzODQKYWxyZWFkeV9zZWVuX3RyYW5zYWN0aW9ucyA9IDAKdGltZW91dCA9IC00MDk2CmJhZF9wcm90b2NvbCA9IC0yMTQ3NDgzNjQ4CmZhaWxlZF90b19jb25uZWN0ID0gLTI1NjAwCmRyb3BwZWQgPSAtNDA5NgpiYWRfYW5ub3VuY2VtZW50ID0gLTEwMjQKCltwZWVycy5iYWNrb2ZmX2R1cmF0aW9uc10KbG93ID0gJzMwcycKbWVkaXVtID0gJzNtJwpoaWdoID0gJzE1bScKbWF4ID0gJzFoJwoKW3Nlc3Npb25zXQpzZXNzaW9uX2NvbW1hbmRfYnVmZmVyID0gMzIKc2Vzc2lvbl9ldmVudF9idWZmZXIgPSAyNjAKCltzZXNzaW9ucy5saW1pdHNdCgpbc2Vzc2lvbnMuaW5pdGlhbF9pbnRlcm5hbF9yZXF1ZXN0X3RpbWVvdXRdCnNlY3MgPSAyMApuYW5vcyA9IDAKCltzZXNzaW9ucy5wcm90b2NvbF9icmVhY2hfcmVxdWVzdF90aW1lb3V0XQpzZWNzID0gMTIwCm5hbm9zID0gMAojIjsKICAgICAgICBsZXQgX2NvbmY6IENvbmZpZyA9IHRvbWw6OmZyb21fc3RyKGFscGhhXzBfMF8xOSkudW53cmFwKCk7CiAgICB9CgogICAgLy8gZW5zdXJlcyBwcnVuZSBjb25maWcgZGVzZXJpYWxpemF0aW9uIGlzIGJhY2t3YXJkcyBjb21wYXRpYmxlCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X2JhY2t3YXJkc19jb21wYXRpYmlsaXR5X3BydW5lX2Z1bGwoKSB7CiAgICAgICAgbGV0IHMgPSByIiMKW3BydW5lXQpibG9ja19pbnRlcnZhbCA9IDUKCltwcnVuZS5zZWdtZW50c10Kc2VuZGVyX3JlY292ZXJ5ID0geyBkaXN0YW5jZSA9IDE2Mzg0IH0KdHJhbnNhY3Rpb25fbG9va3VwID0gJ2Z1bGwnCnJlY2VpcHRzID0geyBkaXN0YW5jZSA9IDE2Mzg0IH0KIyI7CiAgICAgICAgbGV0IF9jb25mOiBDb25maWcgPSB0b21sOjpmcm9tX3N0cihzKS51bndyYXAoKTsKICAgIH0KCiAgICAjW3Rlc3RdCiAgICBmbiB0ZXN0X3BydW5lX2NvbmZpZ19tZXJnZSgpIHsKICAgICAgICBsZXQgbXV0IGNvbmZpZzEgPSBQcnVuZUNvbmZpZyB7CiAgICAgICAgICAgIGJsb2NrX2ludGVydmFsOiA1LAogICAgICAgICAgICBzZWdtZW50czogUHJ1bmVNb2RlcyB7CiAgICAgICAgICAgICAgICBzZW5kZXJfcmVjb3Zlcnk6IFNvbWUoUHJ1bmVNb2RlOjpGdWxsKSwKICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uX2xvb2t1cDogTm9uZSwKICAgICAgICAgICAgICAgIHJlY2VpcHRzOiBTb21lKFBydW5lTW9kZTo6RGlzdGFuY2UoMTAwMCkpLAogICAgICAgICAgICAgICAgYWNjb3VudF9oaXN0b3J5OiBOb25lLAogICAgICAgICAgICAgICAgc3RvcmFnZV9oaXN0b3J5OiBTb21lKFBydW5lTW9kZTo6QmVmb3JlKDUwMDApKSwKICAgICAgICAgICAgICAgIGJvZGllc19oaXN0b3J5OiBOb25lLAogICAgICAgICAgICAgICAgcmVjZWlwdHNfbG9nX2ZpbHRlcjogUmVjZWlwdHNMb2dQcnVuZUNvbmZpZyhCVHJlZU1hcDo6ZnJvbShbKAogICAgICAgICAgICAgICAgICAgIEFkZHJlc3M6OnJhbmRvbSgpLAogICAgICAgICAgICAgICAgICAgIFBydW5lTW9kZTo6RnVsbCwKICAgICAgICAgICAgICAgICldKSksCiAgICAgICAgICAgIH0sCiAgICAgICAgfTsKCiAgICAgICAgbGV0IGNvbmZpZzIgPSBQcnVuZUNvbmZpZyB7CiAgICAgICAgICAgIGJsb2NrX2ludGVydmFsOiAxMCwKICAgICAgICAgICAgc2VnbWVudHM6IFBydW5lTW9kZXMgewogICAgICAgICAgICAgICAgc2VuZGVyX3JlY292ZXJ5OiBTb21lKFBydW5lTW9kZTo6RGlzdGFuY2UoNTAwKSksCiAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbl9sb29rdXA6IFNvbWUoUHJ1bmVNb2RlOjpGdWxsKSwKICAgICAgICAgICAgICAgIHJlY2VpcHRzOiBTb21lKFBydW5lTW9kZTo6RnVsbCksCiAgICAgICAgICAgICAgICBhY2NvdW50X2hpc3Rvcnk6IFNvbWUoUHJ1bmVNb2RlOjpEaXN0YW5jZSgyMDAwKSksCiAgICAgICAgICAgICAgICBzdG9yYWdlX2hpc3Rvcnk6IFNvbWUoUHJ1bmVNb2RlOjpEaXN0YW5jZSgzMDAwKSksCiAgICAgICAgICAgICAgICBib2RpZXNfaGlzdG9yeTogTm9uZSwKICAgICAgICAgICAgICAgIHJlY2VpcHRzX2xvZ19maWx0ZXI6IFJlY2VpcHRzTG9nUHJ1bmVDb25maWcoQlRyZWVNYXA6OmZyb20oWwogICAgICAgICAgICAgICAgICAgIChBZGRyZXNzOjpyYW5kb20oKSwgUHJ1bmVNb2RlOjpEaXN0YW5jZSgxMDAwKSksCiAgICAgICAgICAgICAgICAgICAgKEFkZHJlc3M6OnJhbmRvbSgpLCBQcnVuZU1vZGU6OkJlZm9yZSgyMDAwKSksCiAgICAgICAgICAgICAgICBdKSksCiAgICAgICAgICAgIH0sCiAgICAgICAgfTsKCiAgICAgICAgbGV0IG9yaWdpbmFsX2ZpbHRlciA9IGNvbmZpZzEuc2VnbWVudHMucmVjZWlwdHNfbG9nX2ZpbHRlci5jbG9uZSgpOwogICAgICAgIGNvbmZpZzEubWVyZ2UoY29uZmlnMik7CgogICAgICAgIC8vIENoZWNrIHRoYXQgdGhlIGNvbmZpZ3VyYXRpb24gaGFzIGJlZW4gbWVyZ2VkLiBBbnkgY29uZmlndXJhdGlvbiBwcmVzZW50IGluIGNvbmZpZzEKICAgICAgICAvLyBzaG91bGQgbm90IGJlIG92ZXJ3cml0dGVuIGJ5IGNvbmZpZzIKICAgICAgICBhc3NlcnRfZXEhKGNvbmZpZzEuYmxvY2tfaW50ZXJ2YWwsIDEwKTsKICAgICAgICBhc3NlcnRfZXEhKGNvbmZpZzEuc2VnbWVudHMuc2VuZGVyX3JlY292ZXJ5LCBTb21lKFBydW5lTW9kZTo6RnVsbCkpOwogICAgICAgIGFzc2VydF9lcSEoY29uZmlnMS5zZWdtZW50cy50cmFuc2FjdGlvbl9sb29rdXAsIFNvbWUoUHJ1bmVNb2RlOjpGdWxsKSk7CiAgICAgICAgYXNzZXJ0X2VxIShjb25maWcxLnNlZ21lbnRzLnJlY2VpcHRzLCBTb21lKFBydW5lTW9kZTo6RGlzdGFuY2UoMTAwMCkpKTsKICAgICAgICBhc3NlcnRfZXEhKGNvbmZpZzEuc2VnbWVudHMuYWNjb3VudF9oaXN0b3J5LCBTb21lKFBydW5lTW9kZTo6RGlzdGFuY2UoMjAwMCkpKTsKICAgICAgICBhc3NlcnRfZXEhKGNvbmZpZzEuc2VnbWVudHMuc3RvcmFnZV9oaXN0b3J5LCBTb21lKFBydW5lTW9kZTo6QmVmb3JlKDUwMDApKSk7CiAgICAgICAgYXNzZXJ0X2VxIShjb25maWcxLnNlZ21lbnRzLnJlY2VpcHRzX2xvZ19maWx0ZXIsIG9yaWdpbmFsX2ZpbHRlcik7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9jb25mX3RydXN0X25vZGVzX29ubHkoKSB7CiAgICAgICAgbGV0IHRydXN0ZWRfbm9kZXNfb25seSA9IHIiIwpbcGVlcnNdCnRydXN0ZWRfbm9kZXNfb25seSA9IHRydWUKIyI7CiAgICAgICAgbGV0IGNvbmY6IENvbmZpZyA9IHRvbWw6OmZyb21fc3RyKHRydXN0ZWRfbm9kZXNfb25seSkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0IShjb25mLnBlZXJzLnRydXN0ZWRfbm9kZXNfb25seSk7CgogICAgICAgIGxldCB0cnVzdGVkX25vZGVzX29ubHkgPSByIiMKW3BlZXJzXQpjb25uZWN0X3RydXN0ZWRfbm9kZXNfb25seSA9IHRydWUKIyI7CiAgICAgICAgbGV0IGNvbmY6IENvbmZpZyA9IHRvbWw6OmZyb21fc3RyKHRydXN0ZWRfbm9kZXNfb25seSkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0IShjb25mLnBlZXJzLnRydXN0ZWRfbm9kZXNfb25seSk7CiAgICB9CgogICAgI1t0ZXN0XQogICAgZm4gdGVzdF9jYW5fc3VwcG9ydF9kbnNfaW5fdHJ1c3RlZF9ub2RlcygpIHsKICAgICAgICBsZXQgcmV0aF90b21sID0gciMiCiAgICBbcGVlcnNdCiAgICB0cnVzdGVkX25vZGVzID0gWwogICAgICAgICJlbm9kZTovLzA0MDFlNDk0ZGJkMGM4NGM1YzBmNzJhZGFjNTk4NWQyZjI1MjVlMDhiNjhkNDQ4OTU4YWFlMjE4ZjVhYzgxOThhODBkMTQ5OGUwZWJlYzJjZTM4YjFiMThkNjc1MGY2ZTYxYTU2YjQ2MTRjNWE2YzZjZjA5ODFjMzlhZWQ0N2RjQDM0LjE1OS4zMi4xMjc6MzAzMDMiLAogICAgICAgICJlbm9kZTovL2U5Njc1MTY0YjVlMTdiOWQ5ZWRmMGNjMmJkNzllNmI2ZjQ4NzIwMGM3NGQxMzMxYzIyMGFiYjViOGVlODBjMmVlZmJmMTgyMTM5ODk1ODVlOWQwOTYwNjgzZTgxOTU0MmUxMWQ0ZWVmYjVmMmI0MDE5ZTFlNDlmOWZkOGZmZjE4QGJlcmF2Mi1ib290bm9kZS5zdGFrZXRhYi5vcmc6MzAzMDMiCiAgICBdCiAgICAiIzsKCiAgICAgICAgbGV0IGNvbmY6IENvbmZpZyA9IHRvbWw6OmZyb21fc3RyKHJldGhfdG9tbCkudW53cmFwKCk7CiAgICAgICAgYXNzZXJ0X2VxIShjb25mLnBlZXJzLnRydXN0ZWRfbm9kZXMubGVuKCksIDIpOwoKICAgICAgICBsZXQgZXhwZWN0ZWRfZW5vZGVzID0gdmVjIVsKICAgICAgICAgICAgImVub2RlOi8vMDQwMWU0OTRkYmQwYzg0YzVjMGY3MmFkYWM1OTg1ZDJmMjUyNWUwOGI2OGQ0NDg5NThhYWUyMThmNWFjODE5OGE4MGQxNDk4ZTBlYmVjMmNlMzhiMWIxOGQ2NzUwZjZlNjFhNTZiNDYxNGM1YTZjNmNmMDk4MWMzOWFlZDQ3ZGNAMzQuMTU5LjMyLjEyNzozMDMwMyIsCiAgICAgICAgICAgICJlbm9kZTovL2U5Njc1MTY0YjVlMTdiOWQ5ZWRmMGNjMmJkNzllNmI2ZjQ4NzIwMGM3NGQxMzMxYzIyMGFiYjViOGVlODBjMmVlZmJmMTgyMTM5ODk1ODVlOWQwOTYwNjgzZTgxOTU0MmUxMWQ0ZWVmYjVmMmI0MDE5ZTFlNDlmOWZkOGZmZjE4QGJlcmF2Mi1ib290bm9kZS5zdGFrZXRhYi5vcmc6MzAzMDMiLAogICAgICAgIF07CgogICAgICAgIGZvciBlbm9kZSBpbiBleHBlY3RlZF9lbm9kZXMgewogICAgICAgICAgICBsZXQgbm9kZSA9IFRydXN0ZWRQZWVyOjpmcm9tX3N0cihlbm9kZSkudW53cmFwKCk7CiAgICAgICAgICAgIGFzc2VydCEoY29uZi5wZWVycy50cnVzdGVkX25vZGVzLmNvbnRhaW5zKCZub2RlKSk7CiAgICAgICAgfQogICAgfQp9CjwvZmlsZT4KCjwvZmlsZXM+Cg=="
      }
    }, {
      "text": "You are analyzing the Rust codebase for Reth. I attached the following Repomix XML pack:\n- spec/reth_repo_context/context-sync.xml\n\nQuestion:\nWhere are the sync pipeline entry points (stages, pipeline, downloaders), and how do they connect?\nI want a map of the stage pipeline, how checkpoints/progress are tracked, and how downloaders are used.\n\nRequirements:\n1. Cite file paths and function/type names for every major claim.\n2. Identify entry points (pipeline builder, stage sets, downloader interfaces).\n3. Provide the lifecycle: pipeline init -\u003e stage execution -\u003e checkpoint update -\u003e next stage.\n4. If a claim is outside the pack, say so explicitly.\n\nPlease structure the answer as:\n1. Summary (5-8 bullets)\n2. Entry points (files + types + purpose)\n3. Lifecycle flow (step-by-step)\n4. Key abstractions/types (with file paths)\n5. Where to look next (top files to read)\n6. Suggested follow-up questions",
      "role": "user",
      "tokenCount": 229
    }, {
      "text": "**Conceptualizing Pipeline Architecture**\n\nI\u0027m currently focused on the Rust implementation, Reth. I\u0027m deep-diving into the synchronization pipeline, specifically entry points like stages and downloaders, and how they connect. I\u0027m sketching out a map of the stage pipeline and clarifying how checkpoints and progress are tracked, as well as how download processes are coordinated.\n\n\n**Documenting the Synchronization Pipeline**\n\nI\u0027ve been making a thorough list of relevant files and types, and I\u0027m detailing the key aspects like entry points, lifecycle, and external dependencies. I\u0027m focusing on crates/stages/api/src/lib.rs, pipeline/mod.rs, and others. Sync is serial (`Pipeline`). Stages.\n\n\n**Analyzing Pipeline Lifecycle**\n\nI\u0027m now zeroing in on the lifecycle flow, specifically how the `Pipeline` comes to life. I see `PipelineBuilder` as the configuration entry, followed by the initialization through `run_loop` or `run`. I\u0027m tracing the data fetching via `poll_execute_ready` and finally, the actual execution in `Stage::execute`. I\u0027m starting to see that stages\u0027 progress is tracked in the DB as `StageCheckpoint`, and downloaders like `HeaderDownloader` act as network bridges.\n\n\n**Tracing Stage Commit Processes**\n\nI\u0027m presently tracing the commit process within the synchronization pipeline, specifically focusing on the stages. I\u0027m noting key steps: committing via `provider_rw.commit()` and `save_stage_checkpoint`, and post-commit actions through `Stage::post_execute_commit`. I am also analyzing the handling of `ControlFlow` for iteration and unwinding and how progress is tracked through `StageCheckpoint`. I see downloaders such as the `HeaderDownloader` and `BodyDownloader` being employed to bring data in for the stages.\n\n\n**Identifying External Dependencies**\n\nI\u0027m now identifying the external dependencies, and I\u0027m realizing that the database table definitions are in `reth-db`, while full P2P protocol logic is mostly in `reth-network-p2p`. I\u0027m going to outline this in 5-8 summary bullets to cover the entry points, lifecycle flow, and key abstractions, and formulate follow-up questions. I need to figure out where to look next!\n\n\n",
      "role": "model",
      "isThought": true,
      "parts": [{
        "text": "**Conceptualizing Pipeline Architecture**\n\nI\u0027m currently focused on the Rust implementation, Reth. I\u0027m deep-diving into the synchronization pipeline, specifically entry points like stages and downloaders, and how they connect. I\u0027m sketching out a map of the stage pipeline and clarifying how checkpoints and progress are tracked, as well as how download processes are coordinated.\n\n\n",
        "thought": true
      }, {
        "text": "**Documenting the Synchronization Pipeline**\n\nI\u0027ve been making a thorough list of relevant files and types, and I\u0027m detailing the key aspects like entry points, lifecycle, and external dependencies. I\u0027m focusing on crates/stages/api/src/lib.rs, pipeline/mod.rs, and others. Sync is serial (`Pipeline`). Stages.\n\n\n",
        "thought": true
      }, {
        "text": "**Analyzing Pipeline Lifecycle**\n\nI\u0027m now zeroing in on the lifecycle flow, specifically how the `Pipeline` comes to life. I see `PipelineBuilder` as the configuration entry, followed by the initialization through `run_loop` or `run`. I\u0027m tracing the data fetching via `poll_execute_ready` and finally, the actual execution in `Stage::execute`. I\u0027m starting to see that stages\u0027 progress is tracked in the DB as `StageCheckpoint`, and downloaders like `HeaderDownloader` act as network bridges.\n\n\n",
        "thought": true
      }, {
        "text": "**Tracing Stage Commit Processes**\n\nI\u0027m presently tracing the commit process within the synchronization pipeline, specifically focusing on the stages. I\u0027m noting key steps: committing via `provider_rw.commit()` and `save_stage_checkpoint`, and post-commit actions through `Stage::post_execute_commit`. I am also analyzing the handling of `ControlFlow` for iteration and unwinding and how progress is tracked through `StageCheckpoint`. I see downloaders such as the `HeaderDownloader` and `BodyDownloader` being employed to bring data in for the stages.\n\n\n",
        "thought": true
      }, {
        "text": "**Identifying External Dependencies**\n\nI\u0027m now identifying the external dependencies, and I\u0027m realizing that the database table definitions are in `reth-db`, while full P2P protocol logic is mostly in `reth-network-p2p`. I\u0027m going to outline this in 5-8 summary bullets to cover the entry points, lifecycle flow, and key abstractions, and formulate follow-up questions. I need to figure out where to look next!\n\n\n",
        "thought": true
      }]
    }, {
      "text": "The Reth sync pipeline is a modular architecture designed to move the node\u0027s local state from a starting point (e.g., genesis) to the current chain tip. It orchestrates several \"Stages\" that perform specific tasks like downloading headers, executing transactions, or calculating the state root.\n\n### 1. Summary\n*   **Serial Execution**: Syncing is performed by a `Pipeline` that runs a sequence of `Stage` implementations one by one (`crates/stages/api/src/pipeline/mod.rs`).\n*   **Trait-Based Architecture**: Every component of the sync process implements the `Stage` trait, allowing for flexible configuration and testing (`crates/stages/api/src/stage.rs`).\n*   **Checkpoints and Persistence**: Progress is tracked via `StageCheckpoint` objects stored in the database, allowing the pipeline to resume after restarts (`crates/stages/types/src/checkpoints.rs`).\n*   **Separation of Data and Logic**: Logic for *fetching* data is encapsulated in \"Downloaders,\" while *processing* data happens within \"Stages.\"\n*   **Unwind Mechanism**: If a stage encounters a validation error or a reorg occurs, the pipeline \"unwinds,\" reverting changes in reverse order (`crates/stages/api/src/pipeline/mod.rs`).\n*   **Async Readiness**: Stages use a `poll_execute_ready` pattern to pre-fetch data asynchronously before entering a synchronous execution block.\n\n---\n\n### 2. Entry Points\n\n| File Path | Type | Purpose |\n| :--- | :--- | :--- |\n| `crates/stages/api/src/pipeline/builder.rs` | `PipelineBuilder` | The main API for constructing a sync pipeline, adding stages, and configuring max blocks. |\n| `crates/stages/stages/src/sets.rs` | `DefaultStages` | A pre-configured set of stages (Headers, Bodies, Execution, etc.) used for a full Reth node. |\n| `crates/stages/api/src/stage.rs` | `Stage\u003cProvider\u003e` | The core trait that all sync steps must implement. |\n| `crates/net/downloaders/src/lib.rs` | `BodyDownloader`, `HeaderDownloader` | High-level downloader interfaces that stages call to stream data from the P2P network. |\n| `crates/net/network/src/fetch/client.rs` | `FetchClient` | The bridge between the sync pipeline and the P2P network manager. |\n\n---\n\n### 3. Lifecycle Flow\n\nThe sync process follows a strict state machine managed in `Pipeline::run_loop` (`crates/stages/api/src/pipeline/mod.rs`):\n\n1.  **Initialization**: The `Pipeline` is started. It first runs `move_to_static_files()` to ensure data consistency between the database and static files.\n2.  **Readiness (`poll_execute_ready`)**:\n    *   The pipeline calls `stage.poll_execute_ready`. \n    *   For downloading stages like `HeaderStage`, this triggers the `HeaderDownloader` to begin fetching headers from the network (`crates/stages/stages/src/stages/headers.rs`).\n    *   If the stage is not ready (e.g., waiting for P2P responses), it returns `Poll::Pending`.\n3.  **Execution (`execute`)**:\n    *   Once ready, the pipeline opens a write transaction (`provider_rw`).\n    *   `stage.execute` is called. For example, `ExecutionStage` pulls blocks and runs them through the EVM (`crates/stages/stages/src/stages/execution.rs`).\n4.  **Checkpoint Update**:\n    *   The stage returns an `ExecOutput` containing a `StageCheckpoint`.\n    *   The pipeline saves this checkpoint to the database using `provider_rw.save_stage_checkpoint`.\n5.  **Commit**:\n    *   The pipeline commits the database transaction.\n    *   `stage.post_execute_commit()` is called for side effects, such as notifying `ExEx` (Execution Extensions) that a range of blocks is committed.\n6.  **Next Stage**: The pipeline moves to the next `StageId` in the configured sequence. If all stages are done, it loops back to the first stage unless the `max_block` is reached.\n\n---\n\n### 4. Key Abstractions and Types\n\n#### The Pipeline and Control Flow\n*   **`Pipeline`** (`crates/stages/api/src/pipeline/mod.rs`): Manages the list of stages and handles the transition between execution and unwinding.\n*   **`ControlFlow`** (`crates/stages/api/src/pipeline/ctrl.rs`): Returned by stages to indicate if the pipeline should `Continue`, `NoProgress` (wait for new data), or `Unwind` (due to an error/reorg).\n\n#### Progress Tracking\n*   **`StageCheckpoint`** (`crates/stages/types/src/checkpoints.rs`): Wraps a `BlockNumber` and optional stage-specific metadata.\n*   **`EntitiesCheckpoint`** (`crates/stages/types/src/checkpoints.rs`): Used by stages to track progress granularly (e.g., \"10,000 of 50,000 transactions processed\").\n\n#### Downloaders\n*   **`TaskDownloader`** (`crates/net/downloaders/src/bodies/task.rs`): A wrapper that spawns a downloader implementation onto its own async task to prevent P2P fetching from blocking the pipeline\u0027s execution logic.\n*   **`ReverseHeadersDownloader`** (`crates/net/downloaders/src/headers/reverse_headers.rs`): Implements the logic to download headers from the tip *backwards* to the local head, which is safer against long-range attacks.\n\n---\n\n### 5. \"Where to look next\" (Top 5 Files)\n1.  **`crates/stages/api/src/pipeline/mod.rs`**: To understand the core loop and error handling (unwinding).\n2.  **`crates/stages/stages/src/sets.rs`**: To see the exact order of the 15+ default stages.\n3.  **`crates/stages/stages/src/stages/execution.rs`**: The most complex stage where transaction execution actually happens.\n4.  **`crates/net/downloaders/src/headers/reverse_headers.rs`**: To understand how Reth interacts with peers to fill gaps in the chain.\n5.  **`docs/crates/stages.md`**: For a conceptual narrative of each stage\u0027s responsibility.\n\n---\n\n### 6. Suggested Follow-up Questions\n*   \"How does the `ExecutionStage` use `revm` to process blocks and what data does it persist?\"\n*   \"How does the `Unwind` logic ensure database consistency when moving backward?\"\n*   \"What is the role of `ETL` (Extract, Transform, Load) collectors in stages like `HeaderStage` and `AccountHashingStage`?\"\n*   \"How do \u0027Static Files\u0027 (v2 storage) integrate with the pipeline stages?\" *(Note: Static files are referenced in `stages/bodies.rs` and `stages/headers.rs`)*.",
      "role": "model",
      "finishReason": "STOP",
      "tokenCount": 1595,
      "parts": [{
        "text": "The Reth sync pipeline is a"
      }, {
        "text": " modular architecture designed to move the node\u0027s local state from a starting point (e.g., genesis) to the current"
      }, {
        "text": " chain tip. It orchestrates several \"Stages\" that perform specific tasks like downloading headers, executing transactions, or calculating the"
      }, {
        "text": " state root.\n\n### 1. Summary\n*   **Serial Execution**: Syncing is performed by a `Pipeline` that"
      }, {
        "text": " runs a sequence of `Stage` implementations one by one (`crates/stages/api/src/pipeline/mod.rs`).\n*"
      }, {
        "text": "   **Trait-Based Architecture**: Every component of the sync process implements the `Stage` trait, allowing for flexible configuration"
      }, {
        "text": " and testing (`crates/stages/api/src/stage.rs`).\n*   **Checkpoints and Persistence**: Progress is tracked via `StageCheckpoint"
      }, {
        "text": "` objects stored in the database, allowing the pipeline to resume after restarts (`crates/stages/types/src/checkpoints.rs`).\n*"
      }, {
        "text": "   **Separation of Data and Logic**: Logic for *fetching* data is encapsulated in \"Downloaders,\" while *processing"
      }, {
        "text": "* data happens within \"Stages.\"\n*   **Unwind Mechanism**: If a stage encounters a validation error or a reorg occurs"
      }, {
        "text": ", the pipeline \"unwinds,\" reverting changes in reverse order (`crates/stages/api/src/pipeline/mod.rs`).\n*"
      }, {
        "text": "   **Async Readiness**: Stages use a `poll_execute_ready` pattern to pre-fetch data asynchronously before entering"
      }, {
        "text": " a synchronous execution block.\n\n---\n\n### 2. Entry Points\n\n| File Path | Type | Purpose |\n| :"
      }, {
        "text": "--- | :--- | :--- |\n| `crates/stages/api/src/pipeline/builder.rs"
      }, {
        "text": "` | `PipelineBuilder` | The main API for constructing a sync pipeline, adding stages, and configuring max blocks. |\n| `crates"
      }, {
        "text": "/stages/stages/src/sets.rs` | `DefaultStages` | A pre-configured set of stages (Headers"
      }, {
        "text": ", Bodies, Execution, etc.) used for a full Reth node. |\n| `crates/stages/api/src/stage.rs"
      }, {
        "text": "` | `Stage\u003cProvider\u003e` | The core trait that all sync steps must implement. |\n| `crates/net/downloaders/src/"
      }, {
        "text": "lib.rs` | `BodyDownloader`, `HeaderDownloader` | High-level downloader interfaces that stages call"
      }, {
        "text": " to stream data from the P2P network. |\n| `crates/net/network/src/fetch/client.rs"
      }, {
        "text": "` | `FetchClient` | The bridge between the sync pipeline and the P2P network manager. |\n\n---\n\n### 3"
      }, {
        "text": ". Lifecycle Flow\n\nThe sync process follows a strict state machine managed in `Pipeline::run_loop` (`crates/stages/api/src"
      }, {
        "text": "/pipeline/mod.rs`):\n\n1.  **Initialization**: The `Pipeline` is started. It first"
      }, {
        "text": " runs `move_to_static_files()` to ensure data consistency between the database and static files.\n2.  **"
      }, {
        "text": "Readiness (`poll_execute_ready`)**:\n    *   The pipeline calls `stage.poll_execute_ready`."
      }, {
        "text": " \n    *   For downloading stages like `HeaderStage`, this triggers the `HeaderDownloader` to begin fetching headers from"
      }, {
        "text": " the network (`crates/stages/stages/src/stages/headers.rs`).\n    *   If the stage"
      }, {
        "text": " is not ready (e.g., waiting for P2P responses), it returns `Poll::Pending`.\n3.  **Execution ("
      }, {
        "text": "`execute`)**:\n    *   Once ready, the pipeline opens a write transaction (`provider_rw`).\n    *   "
      }, {
        "text": "`stage.execute` is called. For example, `ExecutionStage` pulls blocks and runs them through the EVM ("
      }, {
        "text": "`crates/stages/stages/src/stages/execution.rs`).\n4.  **Checkpoint Update**:\n    *   The stage returns"
      }, {
        "text": " an `ExecOutput` containing a `StageCheckpoint`.\n    *   The pipeline saves this checkpoint to the database using `provider_rw.save_"
      }, {
        "text": "stage_checkpoint`.\n5.  **Commit**:\n    *   The pipeline commits the database transaction.\n    *"
      }, {
        "text": "   `stage.post_execute_commit()` is called for side effects, such as notifying `ExEx` (Execution"
      }, {
        "text": " Extensions) that a range of blocks is committed.\n6.  **Next Stage**: The pipeline moves to the next "
      }, {
        "text": "`StageId` in the configured sequence. If all stages are done, it loops back to the first stage unless the `max_block"
      }, {
        "text": "` is reached.\n\n---\n\n### 4. Key Abstractions and Types\n\n#### The Pipeline and Control Flow\n*   **`Pipeline"
      }, {
        "text": "`** (`crates/stages/api/src/pipeline/mod.rs`): Manages the list of stages and handles"
      }, {
        "text": " the transition between execution and unwinding.\n*   **`ControlFlow`** (`crates/stages/api/src/pipeline/"
      }, {
        "text": "ctrl.rs`): Returned by stages to indicate if the pipeline should `Continue`, `NoProgress` (wait for new"
      }, {
        "text": " data), or `Unwind` (due to an error/reorg).\n\n#### Progress Tracking\n*   **`StageCheckpoint"
      }, {
        "text": "`** (`crates/stages/types/src/checkpoints.rs`): Wraps a `BlockNumber` and optional stage"
      }, {
        "text": "-specific metadata.\n*   **`EntitiesCheckpoint`** (`crates/stages/types/src/checkpoints.rs`): Used"
      }, {
        "text": " by stages to track progress granularly (e.g., \"10,000 of 50,"
      }, {
        "text": "000 transactions processed\").\n\n#### Downloaders\n*   **`TaskDownloader`** (`crates/net"
      }, {
        "text": "/downloaders/src/bodies/task.rs`): A wrapper that spawns a downloader implementation onto its own async"
      }, {
        "text": " task to prevent P2P fetching from blocking the pipeline\u0027s execution logic.\n*   **`ReverseHeadersDownloader`** ("
      }, {
        "text": "`crates/net/downloaders/src/headers/reverse_headers.rs`): Implements the logic to download headers from"
      }, {
        "text": " the tip *backwards* to the local head, which is safer against long-range attacks.\n\n---\n\n### 5. \"Where to look"
      }, {
        "text": " next\" (Top 5 Files)\n1.  **`crates/stages/api/src/pipeline/mod"
      }, {
        "text": ".rs`**: To understand the core loop and error handling (unwinding).\n2.  **`crates/"
      }, {
        "text": "stages/stages/src/sets.rs`**: To see the exact order of the 15+ default stages.\n3.  **"
      }, {
        "text": "`crates/stages/stages/src/stages/execution.rs`**: The most complex stage where transaction execution actually happens.\n4."
      }, {
        "text": "  **`crates/net/downloaders/src/headers/reverse_headers.rs`**: To understand how Reth"
      }, {
        "text": " interacts with peers to fill gaps in the chain.\n5.  **`docs/crates/stages.md`**: For a conceptual"
      }, {
        "text": " narrative of each stage\u0027s responsibility.\n\n---\n\n### 6. Suggested Follow-up Questions\n*   \""
      }, {
        "text": "How does the `ExecutionStage` use `revm` to process blocks and what data does it persist?\"\n*   \"How"
      }, {
        "text": " does the `Unwind` logic ensure database consistency when moving backward?\"\n*   \"What is the role of `ET"
      }, {
        "text": "L` (Extract, Transform, Load) collectors in stages like `HeaderStage` and `AccountHashingStage`?\"\n*   \""
      }, {
        "text": "How do \u0027Static Files\u0027 (v2 storage) integrate with the pipeline stages?\" *(Note: Static files are referenced in `stages"
      }, {
        "text": "/bodies.rs` and `stages/headers.rs`)*."
      }, {
        "text": "",
        "thoughtSignature": "EuckCuQkAXLI2nw4ZHrFB234PqZBI5n6s1YEV+oO9XtNcKpGHeAKzq9K006l4jy7UzPbzY4uX7kR3XMD4ZZoZ7hewrhlMLyPiSv0rSLqDhg8Sv+wK6M+zkMeDmpQuPHZaeGglEou+25Qa+YeFbjDUidkOgmL1tKRctulhBtZui90ZJZiBvtypNYfm0JY6c+OR4RcrckPYijG+DFZHR8b6BLlkM0wjY1ffTPfSZfzxnWK5nG5NXSAvqA7o98DlMcIWZ4FPIhdUaOuZwfhTnR7L45gkSazGFnEMiD+bFlyDkB2VkC1Urif0oAqmC0eYgIiOy7He5TzKO41sqifH4BDCJFppNKaC649AGvZsLhMR8/kLO5K9KiZA/s8ZOEh3zFzSNE6In7OsHoJU/3HmkDuQKUo4oIkScvUgX+joWa1s7jPnXc+FfSPdIjM6lJhVXMeukoCsuH1cTHrNB9S8q/cCC+vQ7jk5TBE8HT4J8YJaRlHZFyX9Q91xUmjGXU3MdjVxylclWwyBvrC2NVkaiUOuFRZrdNuvjarkRj87G32wzgD3ZGwWsimzfdrsn+XdISBiYq6ts2tnQgzzjqIKtsf13xXj8MQU8Qh4z2enMiF5CYYDGSEydPRmHZIIXtPaX13ftrWuOUDTNJ/o7X7ohBURr74mnshebc+gBJbo49sK4mg8QDG+a08AESvsPDNpLhCF9/DOHUVPcUz4Nt7lKiHZRVFLMBuSzbg9Ro3iJ0DK8txYeC49+NnubvJx7e2l0qm3C56/xU3STaNZyCxF8H52XWzdgskKhw2x9t0U4bN+XEvBlKafVUWU5SMiifR17KK4Hu0HqnqNlfXcHSptkneCaQ0ZYOqzQJ8CLypLSHiUXCvf3O8av1/YLq0EX4yMRhsRwdLSjZ3wEoXv9Y/Q1fQ4DKvF/MUG14ySTohlBUTTNQd2Jjp0QGTDDJCZIp0uvSWNDPzN0DWxbqBBfcZtv9/ay8RiJ4D0M+TErdwGWmXr83XaxoztkTfEhjjSuf8BkVBlXNQm5k5ZMsEVJFs9Coe7oB4HHARbd7y9naK612s///3PS3fW1SrSfPx+KNA58TfAzC741+xsq/YHycTinJenCIsiWiRHdxEgqmyn7BMntinbbfCk/6S6vkWz1UrbKA7dKwDKkRKTMm6HNiuB7Qpkab4V1T+3P78mGIgCOxkffyjGew8eb50ID05XHjBcYlbEqYrCgZeN7xwMc24EQEdqkLthT4Y0V++ba7OFY5d8reGJnuLepXA6JogqBsQ0IqvEdHAtW1Oc9JoKqlTgMIajxi01ZMC9bgZPtlwyGC2c9DQufe8NBBCAjE0BzL3UN6ogw8pZ7/LTDzVm2p7Gh5B1nXiJe9tB4/qBRX2hH7Ch/IC+pqtCWavxH4V+oNusZ7lBUGjjU7IxFEZcGOas5YkeWLb1CzoAqT/2zqsieDgTpd4FJCW6ug6kuBBakYMqIXxxphILR+/xm+x0B4Idcv8eXOvk7Dv1ZV6+WdB7lKQBIyb1eyqm/lCWjUh6FsfUP2MA1N1QjHlEuyHaa4oqa+jR53ilFD29YsnsPu3ebyQVF4nxB7fNDBPshJu+L6Ag+RHwFElKmKgLrX0COWnnt+2uzudUQQC8AkowQdqERLfIKlFYFZIPLjCIHMW98sq5m7Z5Afiz6CNk9cb5paIXj/IFygFV/8UOqUn0YKUVmSf4Z1jH51D4fT2VH+HYLL5Bj1/3tgnqLIZurlLK270cJtYCcTGBJHyU6+3wQoOD36N2RWukBV76Tn+8LpOFCisaaG+8QN7y4n3bwVmsEECcNULrWveERxeL1WMcPZDJxohXmnF4DI7EdEy/P/0uC8L7uVrke1D+J6RS75ZTYbE1g8GY/Yi/vTSReQkcsT1c7UieItrciJKal/84g1qjt7YGkKd2hch0cxdmG7Yxy1dzQCm3i0CB1VbitQCaNKbBooqLLGKnUGzBGd1WtrPKKcrS4Kwr4FZmbvpl5Hk1XYP+PrSqR1f9uv8DEufaldsY5OmQFn4/qt1gKmkunbLISV7uVWgw18LAqYYNEqRy0it5QOtk10NzXFCmoLKpjaqHOefl/bkG6T3SqoEN0xJMk1Vw2jpsV/FPy+CiKQhtGzm9cAK8uCnEEC2ltdVnVGJWAdXyTlXHWDkv8eyNhfum2nr533WfpJVXhVuoF4bEloDgJLl1QMtBric2ayTF6+d5IIdofrb1I9dXUT2rFnNLVr5khHOGEVznrzKr4ioeEJ25bu2NXLQP0xMtcmk37PBTEfVrqPOPHK4n1fmSVNHaFaVwax/bGGoRFOPo243UvPEipanukhyBZdrVcSw0pRljw+KnW9Ay8QNnfxBFyqv480FuLG5c3YCjpQ8FMNFa7lB5lLJQNVAKC2CyjxHUgIE7Seh6dvEAL+tpGfnHMkCZqW7F6Ke5DeriNVnkp17vUCYD0Nv6WfpbCn8G/yjHwvA6BegwIFriXDQNLsijCb3SidkoHrP5R91C+pjKr4o7/3lkW7Z0Lr12PuzyeRV+e2rwdYB4aT29LTJ4j+7bxh8tvyivRH7GHqFmipfS+oWEF+qAI5/xpzfiVhAYUcBzjeE6STnuWv4paFo3fvoE/vJgiEVyWXjbvaF5JBK+C68j18CA90J6cky6miVvcdOCrKXOOZ45ZXKhje30sNC6JtO7lgbOyx47ySBSYBxmXx7yPYozdsfTsT/btKSFEZ7sS1BI96klJEdfno3K5ZCwPgMYH2VL8zbAd38Y1ojJxKFKql8+UHcD9SrKuuNks8a3WJd9bN1HzcDsIw4J2I4/tvOxXfsnuu8vT3E7VT6bP/l4Gr3S9QUpJg09LMILtT7i5jM54sfCinAk4adwzJ6v9rBoB04oXjMh/zX3zjT0mZ3XAzfY66ffwJD4jtDc8bebOTpMDJvOwcjxDpz5WFdaC3obt3kesxSbXpASCXjTkLHb8SZFhVxuXXsjj6y+osmcVSJdGTl4SEFp7AlMlXQnsMtSYl7lvskIVX9Og6MNcCPXwgV84aAtoElhVX9LWn+O1x341H+VXnsEe/BxxaaWshQHIeLvrumvIC66eHJuRQjwM1j3Ar1GuRa0fSdXI8oRjgE4XGpDPunRLNXtdmU+GQ9zLpawI1JwfTD8K7MP8VsleZHf2pcCOg4uTU4H8am+RUqJ5W5NQpUbRVdc84nOHDglGocBBpiIMIu/MtXyShFO681H3DoRKL/3j75Flee/KqwHlOS5zaWPq5SXMPCm2aaszFo9E1b4+gVsVxdY8V4NNU3dxiTgY54zqu33/I9zkPLPwhbAFJ7jDEdQZUhBAYwKIQBwvnGtLtTdlJ+WvCB/E/ylZNnOzN8Iqma8i0hDEyiI3dyoGtVH7P7ejy8qYY1bncFq33vnj3cLob/S2IFuPgTCrOjd0nY0pIGYIkKIGKl+42fKvnuPJkTxZVhuHq5jC7aIkUx5Y28pCqe0ZHTUMGaoekbFCTXY19Rfi1c35OrZo8ReZ+sTTg7WpehUyDCdP25sEzogAI7fWHTIOYWvT1OqAjRs0IfqBpiPO50WEhCPN6ezmO/tH5iEiUHSWlQhNwzuuWdZx1/Y0FxQGYULp9BQyZUur1qNv8VjiyfJMTF8vnABwpRTgI3eI073CA207HsQ1LnivNIkMhFSyyBMEZmErZp54PjNlK1Cct5ok9QeixQGUz9JEQ2zbFIYqdxfyNXs8MVpE72qSytCJMERT0PpjBNLilXRvfbq7lym9eiXuw9zuFSHbLNgAFu6caeB+KFVvV9AIsA2UCcGcwLLgosBlmvGoKtgTJP1UfYwrzcv2+vabnsjop0Rn3+36Z3eQpKiSgpIeTB78UEmpPOgTVt9Cuc2cM3CbHmvq71wCkc5z4xZBgZWY2Vod9GFyPXZtrn2Phhci7L6NLzPleiGkHRgOOgU80jjdfAOla9IL3D1TZvWRVDiwmN5vBrv+9uCnTjU259NUTzHN3u0bVGIULFCMsfp3RvCvFY72SI5Pgmi5GdWfwamnEuuKdvG7chChQGIb9RQaqMf4x3qRcmdvcbbtSDU6NZGrYynRbia4gJcqxcWChQocsmLB6Vmg6bnH60N9ajoPrdfdfyfFV0yXc8M/03f2Ee2q+A91ce6MAnYboxh3q1E8ikgMvx2LDNAflY7w3KFNqm5NpuYsDL51QR2Xjw5+qSd0+Z7AvdvETiEw4vnZie6NAn9hV52f3BHlS7sidVR+GEIqB/9hkxyOz0+SPWw/dB+moeeq/h+pin9/10E7eUVHxPbCVe8ctvG/3USz1hG0xGVLxJfzhH4waZifk6Kt2qAKwCAdQLKwmb65GDh1U3+E4tb8Ejmnf7NAlWDQHYt1/iL7z0r7Otrj+KU7VcrHIBN04AO153C61V2IcEzpMvIu1f7N3t4n/RMBGaJjksQHu42Trn5JXXytYFi90zbLAqUlIuvAZ/PsSYp4ov9Ao+U0HGUxFh5UOnC/HM47rXMBXjXq2IQM+Gp7J5ryH2jzgfGpmTfrpXWhTDatYzcWBu9MUV0bQJF9a6JbbP7apjrswY4fs7gXup0bdhnoC/DFETqkakbuHK9M8f4GtaemVAGA5UDV7YctcDJhmQZiaJW1u45qTZ0N+gqWsK0y++4OMoiim40QNpp8oZ5tKqS0uBqu09yvM7TDa/mDI0IXeDbymJxSzgtNJRZMoy9J0OrlgAZ9JKJ7S2rPpVcZMDvLsCfuGr3ykSDxIMAJMpmhE1I1SIItryCIyTf8IyW1NANKlyDYfNgLbs+gYwK/dfMngkXiadkhCnERgHKPNXhM6oD6KSDyKI4V3m2qTIEJcHFthLQFkN5PpPZ5gyOiV20u6cJ9Qb/J8iVKFbaHr776z1+CndQUWPWsgxWdW5e0OQqqJsVm1dZnUum12BzUw6Da9W4RJXfVN6354i5Dyo3fnLrsebAznHIyaYU/pniHPyCmr5FSqv2Suew7amkjqAAsS9Guh4ffaImexE4RYvlRPqz8sFPbuXW6WZpCEGr4AKcRGPJjwy7PKeum+lvd08fTaW3S1tU2cSSqESlItP33SgqvIJZvCvA2JeSk/GShw8ueyKipgOQpMMbdjpkpmGt/vQieRoDfAXRKGKpastpytX/fE2R34eCDqiZjXVlQH5JLJdaa+bLoRcnW+trobhLt/XVC/E9n7iERBFlR8iAJK/VhDEZCmYAN/hn1zLu93LPXe4/2n8hfzvD0Mh9h4kIWcXlMzghzpn+rOi27nNd3lznibbDR6YuNy4vJb5dQUQ3+clMP7pJESEtGApRQYez/6hHN1W4KJvezD7pvFpjIQSEQCN6NuD1aA/2Zdi+UpHSgMGL0GIrVmmsDvFmecWTOqPiaqObeBcDH/DTLYJTHAiio/ZEUfGgtf2b8YN3CgetrTF+XeWDy16OhkjYnEt+OpVBVO7jyL5tAaNdGeaE6XB2MKFvbVLCCGpfhPVql9Hgy2o62Edp2b62jJt6vNa7fYANw4a/J8kd6UCzimGVtPW5fTz3DT5HsYNaSJP8stSqR85tjbcOQYc7ThRJJktokpEBhTJ6D5w9T2mAlgyx2qUF97kDBD3uT8OfIfRH708v8jY7HzMWIWZLngGsWV7KhWFZkPHAatG+yTRxsiFeXpqcBjYsgVXK/HIuPyzS5frgaY49RlP8UPok+ghGFzAJG+FkU7noWqVp8SZv/JvFgKu78bq3hFagrurTwESH8JP9RJMIbgSch3/E2KdVbJr1bHBMWHkmtk9EIO1YqjVajZHUpSzjPvTRwyyyvyS3+PzzljfBrN2nS0n1vDxjVP/Q35iwTTdk6QcjsOPHG4xg3oFKjXNl3PrB8Ck+G7dZCHfaGLDP4XmNTr+IvD2QfVshzMlybcbT6qwVkHlnFjN8/4xV325nlnWWtt5S1zZ2wK+WE3RF5rFQT3lcyFKRs0TYOhzfg/YDUivhlOJ7nBV2G9XjDRAOR7TUQ9pBmwqazk1JuzVNQri5v4ZyndhsbY/whTbnzRBTWVgFKbilU7aZanFWnmXMui4fc2AGDikfydsaqh5FuhjxF4LifkP+owd3Qtd7IFq00K+AjVxi/ZANmJAE34l29U51IB9hy7tIfcUyHFsmTh50OOUw+nSzHydGQKQK6l1VzxugeDEVdLNSomLlnVvKLHuJ6+tYzdz93S0mkTbyzDiePRqnzqKAatHqpHusySv1hMZAmxsLk2Ct66ted2kh3OM+212b394vIuEhkUcyvssjxf/2VlQBl1DGAm/1cD0rykU0R0ODoH3NN6v9HG6I0qfS1zS7Q=="
      }]
    }],
    "pendingInputs": [{
      "text": "",
      "role": "user"
    }]
  }
}