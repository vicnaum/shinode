# node

## Purpose

Rust crate for the Stateless History Node -- a minimal Ethereum history indexer that backfills headers, receipts, and logs from the EL P2P network and serves an indexer-friendly RPC subset. Does not execute transactions or keep state (no EVM, no state trie).

## Contents (one hop)

### Subdirectories
- [x] `src/` - All application source code organized into subsystems: P2P networking, sync pipeline, sharded storage, JSON-RPC server, terminal UI, logging/observability, CLI configuration, and runtime orchestration. See `src/AGENTS.md`.
- [x] `target/` - (skip: build artifacts, generated by cargo)
- [x] `tests/` - Integration test scaffolding with placeholder stubs for RPC contract probe and reorg rollback tests. See `tests/AGENTS.md`.

### Files
- `Cargo.toml` - Crate manifest. Defines dependencies (Reth crates pinned to git revision, tokio, jsonrpsee, ratatui, clap, serde, bincode, zstd), features (jemalloc default), and binary target (`shinode`).
  - **Key items**: `name = "shinode"`, `[features] default = ["jemalloc"]`
- `Cargo.lock` - Pinned dependency versions.
- `clippy.toml` - Clippy linting configuration.
- `FILE_ID.DIZ` - ASCII art project identifier.

## Architecture overview

The node operates as a pipeline:

```
CLI Config --> P2P Network --> Sync Pipeline --> Sharded Storage --> JSON-RPC Server
                                    |
                              Terminal UI (TUI/progress bars)
                                    |
                              Logging/Observability
```

**Subsystems** (in `src/`):

1. **cli/** - Central `NodeConfig` with 40+ parameters driving all behavior; subcommands include `db stats` and `db compact`
2. **p2p/** - Reth devp2p networking; peer discovery, session management, multi-protocol fetch (eth/68-70)
3. **sync/** - State machine (`SyncStatus`) + progress tracking + historical pipeline:
   - **sync/historical/** - Fast-sync with AIMD batch scheduling, parallel fetch/process/write, escalation retries, follow-mode with reorg detection
4. **storage/** - Serializable types + sharded static-file backend:
   - **storage/sharded/** - WAL-based writes, three-phase atomic compaction, LRU-cached reads, crash recovery
5. **rpc/** - Minimal JSON-RPC (eth_chainId, eth_blockNumber, eth_getBlockByNumber, eth_getLogs)
6. **ui/** - Ratatui fullscreen TUI dashboard (default) or indicatif progress bars (--no-tui)
7. **logging/** - Async JSON logs with dedup, TUI log capture, run reports, resource monitoring, SIGUSR1 handler
8. **run/** - Top-level orchestration: startup, sync, follow mode, RPC launch, cleanup

**Data flow**:
1. `main.rs` parses CLI via `NodeConfig::from_args()`, dispatches to `run::run_sync()` or subcommand handlers (`db stats`, `db compact`), or `--repair` mode
2. Storage opened (with crash recovery), P2P connected, peers discovered
3. Fast-sync: scheduler assigns block ranges to peers -> parallel fetch -> Keccak processing -> WAL writes -> per-shard compaction (or deferred via `--defer-compaction`)
4. If `--end-block` is set: sync the fixed range, finalize, and exit (no follow)
5. If `--end-block` is not set (default ingest): fast-sync to a moving safe head (tail ranges appended), then switch to follow mode
6. Follow mode: head tracker polls peers -> tail scheduler feeds ranges -> ingest pipeline in follow mode -> reorg detector monitors chain with rollback within configured window
7. RPC server started once synced (first "synced" edge: `SyncStatus::UpToDate` or `SyncStatus::Following`), serves read-only views over stored headers/receipts/logs
8. TUI/progress bars display real-time metrics from atomic counters
9. Peer cache persisted; when logging/artifact flags are enabled, trace/event/log artifacts are written under `NodeConfig.log_output_dir` (default: `logs/`)

## Key dependencies

- **Reth crates**: `reth-network`, `reth-eth-wire`, `reth-nippy-jar`, `reth-ethereum-primitives` (pinned git revision)
- **Async**: `tokio` (runtime), `jsonrpsee` (RPC)
- **Storage**: `bincode`, `zstd`, `lru`, `crc32fast`
- **UI**: `ratatui`, `crossterm`, `indicatif`
- **Config**: `clap` (v4), `serde`, `serde_json`
- **Logging**: `tracing`, `tracing-subscriber`, `sysinfo` (non-Linux)

## Notes

- `target/` is generated and not intended for manual review.
- Log/artifact output directory is created at runtime when log flags are used (default: `logs/`, configurable via `--log-output-dir`).
